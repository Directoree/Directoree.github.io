<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="😄">
<meta property="og:type" content="article">
<meta property="og:title" content="x64 页表隔离（一）Meltdown 和 Spectre">
<meta property="og:url" content="https://directoree.github.io/post/memory-page-table-isolation/index.html">
<meta property="og:site_name" content="Catecat">
<meta property="og:description" content="😄">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/11/17/Mo8dZUQy4WPJrYH.png">
<meta property="og:image" content="https://s2.loli.net/2022/11/19/ALd1sX5f2YcOlpn.png">
<meta property="og:image" content="https://s2.loli.net/2022/11/19/KquAagNcpR4OSFd.png">
<meta property="og:image" content="https://s2.loli.net/2022/11/20/qtNGmLpdX5STsku.png">
<meta property="og:image" content="https://s2.loli.net/2022/11/20/d5oJHjywithYMaD.png">
<meta property="og:image" content="https://s2.loli.net/2022/11/20/7NOrZpJaeHv1dzw.png">
<meta property="article:published_time" content="2022-11-17T13:28:16.000Z">
<meta property="article:modified_time" content="2022-11-20T16:18:16.553Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="Windows内核">
<meta property="article:tag" content="x64内存页表隔离">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/11/17/Mo8dZUQy4WPJrYH.png">


<link rel="canonical" href="https://directoree.github.io/post/memory-page-table-isolation/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>x64 页表隔离（一）Meltdown 和 Spectre | Catecat</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Catecat</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-空调房">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>空调房</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Meltdown-%E5%92%8C-Spectre"><span class="nav-text">1 Meltdown 和 Spectre</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="nav-text">2 漏洞原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Spectre%EF%BC%88%E5%B9%BD%E7%81%B5%EF%BC%89"><span class="nav-text">2.1 Spectre（幽灵）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Meltdown%EF%BC%88%E7%86%94%E6%96%AD%EF%BC%89"><span class="nav-text">2.2 Meltdown（熔断）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="nav-text">2.3 缓解措施</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Windows-%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="nav-text">3 Windows 缓解措施</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-KVA-Shadow"><span class="nav-text">3.1 KVA Shadow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%88%9D%E5%A7%8B%E5%8C%96KVA-Shadow"><span class="nav-text">3.2 初始化KVA Shadow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-CR3-%E5%88%87%E6%8D%A2%E5%88%86%E6%9E%90"><span class="nav-text">3.3 CR3 切换分析</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">76</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/memory-page-table-isolation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Catecat">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          x64 页表隔离（一）Meltdown 和 Spectre
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-17 21:28:16" itemprop="dateCreated datePublished" datetime="2022-11-17T21:28:16+08:00">2022-11-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-11-21 00:18:16" itemprop="dateModified" datetime="2022-11-21T00:18:16+08:00">2022-11-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/x64%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">x64内核</span></a>
        </span>
    </span>

  
    <span id="/post/memory-page-table-isolation/" class="post-meta-item leancloud_visitors" data-flag-title="x64 页表隔离（一）Meltdown 和 Spectre" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/memory-page-table-isolation/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/memory-page-table-isolation/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>😄</p>
<span id="more"></span>

<h2 id="1-Meltdown-和-Spectre"><a href="#1-Meltdown-和-Spectre" class="headerlink" title="1 Meltdown 和 Spectre"></a>1 Meltdown 和 Spectre</h2><p>Meltdown 和 Spectre 是两个 CPU 漏洞，对应的 CVE 编号是 Meltdown（熔毁，CVE-2017-5754）、Spectre（幽灵，CVE-2017-5753&amp;CVE-2017-5715）。目前已经衍生出<a target="_blank" rel="noopener" href="https://blog.yzsun.me/spectre-meltdown-foreshadow/">多种变种利用方式</a>。</p>
<p>这两个 CPU 缺陷几乎影响了自 Pentium Pro（1995）以来开发的所有现代处理器。这些缺陷源于两个关键的CPU功能：乱序执行和推测执行。</p>
<ul>
<li>Spectre：基于<mark class="label warning">分支预测</mark>的推测执行（Speculative execution from branch prediction）。</li>
<li>Meltdown：基于<mark class="label success">乱序执行</mark>（Out-of-order execution）的推测执行。</li>
</ul>
<p><img data-src="https://s2.loli.net/2022/11/17/Mo8dZUQy4WPJrYH.png" alt="1.png"></p>
<p>两个漏洞非常相似，都是组合 CPU 设计缺陷、侧信道攻击、内存访问越界来实施攻击，以<mark class="label danger">破坏地址空间隔离</mark>，<strong>泄露内核数据</strong>。</p>
<p>这两个漏洞的研究报告：《<a target="_blank" rel="noopener" href="https://meltdownattack.com/">Meltdown and Spectre</a>》。</p>
<p>Spectre 影响的 CPU 范围较 Meltdown 广，用于缓解 Meltdown 的 KAISER 机制不能防止 Spectre。</p>
<p>CVE-2017-5753、CVE-2017-5715、CVE-2017-5754 都是 Spectre 的变体：</p>
<ul>
<li>变体1，<strong>有条件的分支误判</strong>：CVE-2017-5753（Spectre）。</li>
<li>变体2，<strong>间接分支误判</strong>：CVE-2017-5715（Spectre）。</li>
<li>变体3，乱序执行：CVE-2017-5753（Meltdown）。</li>
</ul>
<h2 id="2-漏洞原理"><a href="#2-漏洞原理" class="headerlink" title="2 漏洞原理"></a>2 漏洞原理</h2><h3 id="2-1-Spectre（幽灵）"><a href="#2-1-Spectre（幽灵）" class="headerlink" title="2.1 Spectre（幽灵）"></a>2.1 Spectre（幽灵）</h3><p><strong>漏洞原理</strong></p>
<p>几十年前，为了加快处理器的执行速度以提高性能，其中一项技术就是推测执行（Speculative Execution）：<strong>在遇到分支判断时，让处理器猜测可能执行的方向，并在这个路径上提前执行指令</strong>。</p>
<p>举个示例，在分支判断的地方访问了未缓存的内存，由于访问内存要比 CPU 执行慢得多，通常需要数百个时钟周期才能取到内存中的值，CPU 不会空闲下来而浪费这些周期时间，而是尝试去猜测该控制流的方向。CPU 先将当前点（Checkpoint）的寄存器状态保存起来，然后在猜测的路径上继续往下执行。当从内存传送过来的值到达处理器后，CPU 会检查初始猜测的正确性。如果猜测错误，CPU 会通过将寄存器状态恢复为存储的检查点来丢弃不正确的推测执行（称为回滚），这种情况下与空闲是相当的性能；如果猜测正确则继续往下执行，从而产生性能的提升。</p>
<p>而幽灵漏洞就是利用不正确的猜测执行，幽灵攻击<strong>诱使 CPU 推测执行正确控制流不应该执行的指令</strong>。漏洞发现者将这部分正确控制流不会执行，而 CPU 能推测执行的指令称为 <code>Transient instructions</code>（瞬态指令）。利用 <code>Transient instructions</code> 从受害者的内存地址空间中泄露内核信息。</p>
<blockquote>
<p>不幸的是，尽管架构状态被回滚了，仍然有些副作用，比如 TLB 或缓存状态并没有被回滚。这些副作用随后可以被黑客通过侧信道攻击（Side Channel Attack）的方式获取到缓存的内容。如果攻击者能触发推测执行去访问指定的敏感数据区域的话，就可能可以读取到原本是其它用户或更高特权级的敏感数据。</p>
</blockquote>
<p>基于这样的推测执行能够衍生出多种不同的变体利用方式，如利用条件分支的推测执行（CVE-2017-5753）、利用间接分支的推测执行（CVE-2017-5715）。</p>
<p><strong>漏洞还原</strong></p>
<p>本文以其中一种变体——利用条件分支的推测执行来泄露内核数据。</p>
<p>主要参考<a target="_blank" rel="noopener" href="https://labs.bluefrostsecurity.de/blog/2020/06/30/meltdown-reloaded-breaking-windows-kaslr/">Meltdown Reloaded: Breaking Windows KASLR by Leaking KVA Shadow Mappings</a>、<a target="_blank" rel="noopener" href="https://spectreattack.com/spectre.pdf">Spectre Attacks: Exploiting Speculative Execution</a>、<a target="_blank" rel="noopener" href="https://www.techrepublic.com/article/spectre-and-meltdown-explained-a-comprehensive-guide-for-professionals/">Spectre and Meltdown explained: A comprehensive guide for professionals</a>。</p>
<p><strong>一、触发漏洞</strong></p>
<p>如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 array_size = <span class="number">1</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> array1[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> array2[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">Leaker_function ( <span class="keyword">unsigned</span> __int64 pos )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( pos &lt; array_size )</span><br><span class="line">  &#123;</span><br><span class="line">    temp_value = array1[ array2[ pos ] ];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数 <code>pos</code> 完全由攻击者控制，如果此时 <code>pos &gt;255</code>，CPU 没有等待条件判断，同时还会猜测数组边界检查为真（实际上 CPU 直接访问了越界数组指向的内存），假设此时 <code>array2[pos] = 0x41</code>，则接下来 CPU 会访问 <code>array1[0x41]</code>，并将访问到的数据缓存 Cache。当最终确定条件分支及数组越界检查的结果后，CPU 会发现其错误并进行回滚。但是访问 <code>array1[0x41]</code> 的数据已缓存 Cache，CPU 没有刷新该缓存，攻击者就可以分析该缓存的内容，从而得到越界访问的数据。</p>
<p><strong>注意</strong>：<code>0 &lt;= array2[pos] &lt;= 255</code>，所以数组 <code>array1[X]</code> 不会越界，方便后面分析缓存的值（无符号字符为1字节8位，2^8&#x3D;256）。除此之外，还要要求 <code>array1</code> 数组之前没有被访问过也就没有相关缓存信息。</p>
<p>所以可以构造如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array1[ array2[<span class="number">0xffff8000</span>`<span class="number">12345678</span> - &amp;array2] ];</span><br></pre></td></tr></table></figure>

<p>这样就可以将 CPU 推测执行 <code>array2[0xffff8000&#39;12345678]</code> 的地址缓存起来，<strong>然后分析缓存</strong>，从而得到地址 <code>0xffff8000&#39;12345678</code> 泄露的值。</p>
<p><strong>关于缓存</strong>：</p>
<p>现代 CPU 一般都会在内部设置缓存结构，然后将高速缓存划分为固定大小的块（或叫做行Lines），典型的每行 64&#x2F;128 字节，<strong>内存是按行的粒度进行缓存的</strong>。档处理器需要内存中的数据时，首先就要去高速缓存中进行检索，检索不到才会去访问物理内存。</p>
<p>Intel 处理器通常具有三级缓存，每个核心都有自己的 L1、L2 缓存，还有一个所有核心共享的 L3 缓存（也称为LLC）。</p>
<p>处理器必须使用缓存一致性协议<strong>确保每个内核的 L1和L2缓存是一致的</strong>，通常基于 MESI 协议。特别是，使用 MESI 协议或其某些变体意味着对一个内核的内存写入操作将导致其他内核的 L1 和 L2缓存中的相同数据副本被标记为无效，这意味着将来访问其他内核上的这些数据将无法从L1或 L2 缓存中快速加载数据。</p>
<p><strong>二、分析缓存</strong>：</p>
<p>由于 CPU 使用缓存来存储最近访问的内存的内容，并且缓存比常规内存快得多，因此我们有机会通过观察不同缓存行的访问时间来推断访问了哪些元素。</p>
<p>推断访问了哪个缓存行的典型方法是（Flush+Reload技术）：</p>
<ol>
<li><p>首先刷新所有缓存行，即刷新数组每个元素的 CPU 缓存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span> ; i &lt; <span class="number">256</span> ; i ++ )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Invalidating cache</span></span><br><span class="line">  _mm_clflush ( &amp;array1 [ i ] );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>然后触发受害者内存访问，将访问的数据进行缓存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Leaker_function ( <span class="keyword">unsigned</span> __int64 pos )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( pos &lt; array_size )</span><br><span class="line">  &#123;</span><br><span class="line">    temp_value = array1[ array2[<span class="number">0xffff8000</span>`<span class="number">12345678</span> - &amp;array2] ];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设 <code>array2[0xffff8000&#39;12345678 - &amp;array2] = 0x41</code>，则在下面使用 <code>__rdtscp</code> 检索数组 <code>array1</code> 每个元素访问时间时，应该是 <code>array1[0x41]</code> 使用的时间最少。 </p>
</li>
<li><p>为访问每个缓存行计时（依次计时访问数组 <code>arry1</code> 每个元素），受害者访问的元素将产生最低的时间。</p>
</li>
</ol>
<p><strong>三、训练</strong></p>
<p>为诱导分支预测推测执行，在错误的推测执行前应该尽可能的训练 CPU 推测正确的分支判断，使得 CPU 在类似的分支判断前按照之前的经验进行推测执行。</p>
<p>完整利用代码（参考<a target="_blank" rel="noopener" href="https://labs.bluefrostsecurity.de/blog/2020/06/30/meltdown-reloaded-breaking-windows-kaslr/">Meltdown Reloaded: Breaking Windows KASLR by Leaking KVA Shadow Mappings</a>）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Kernel address to be read</span></span><br><span class="line">malicious_pos = kernel_address - &amp;array1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Looping 33 times</span></span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span> ; i &lt;= <span class="number">33</span> ; i ++ )</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Enabling speculator</span></span><br><span class="line">  pos = ( ( i % <span class="number">33</span> ) - <span class="number">1</span> ) &amp; ~<span class="number">0xFFFF</span>;</span><br><span class="line">  pos = ( pos | ( pos &gt;&gt; <span class="number">16</span> ) );</span><br><span class="line">  pos = pos &amp; malicious_pos;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Leaking data when branch predictor is working</span></span><br><span class="line">  leaker_function ( pos );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Github 利用项目<a target="_blank" rel="noopener" href="https://github.com/bluefrostsecurity/Meltdown-KVA-Shadow-Leak">Meltdown KVA Shadow Leak</a>。</p>
<p><strong>总结</strong></p>
<p>幽灵（Spectre）漏洞利用 CPU 的<strong>分支预测+推测执行</strong>。推测执行时不会对内存访问权限检查，以及数组越界等检查。似乎 CPU 推测执行时都会推测执行条件”满足“而继续往下推测执行，等最后判断条件不满足时再回滚寄存器内容或已访问内存的内容。但是此时已访问的内存内容已经缓存至高速缓存了，后面就可以利用侧信道攻击（根据访问内存时间从而判断缓存信息）。</p>
<h3 id="2-2-Meltdown（熔断）"><a href="#2-2-Meltdown（熔断）" class="headerlink" title="2.2 Meltdown（熔断）"></a>2.2 Meltdown（熔断）</h3><p>熔断也是利用 CPU 的推测执行，只不过不像幽灵漏洞那样是在分支预测时进行推断执行，而是在乱序执行中进行的推测执行。</p>
<p>在用户空间执行的代码可以利用熔断漏洞来泄露内核空间的数据。</p>
<p>如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = a + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> c = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>由于 <code>b</code> 的值依赖于 <code>a</code> 的值，所以 CPU 在执行时可能会进行乱序执行如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> c = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = a + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p> 下面推测执行的指令不依赖于前面的指令。</p>
<p><a target="_blank" rel="noopener" href="https://meltdownattack.com/meltdown.pdf">论文</a>指出可乱序执行的指令：当遇到分支条件时，位于该路径上且<mark class="label success">没有任何依赖关系的指令可以提前执行</mark>，如果预测正确，则立即使用它们的结果。如果预测不正确，重新初始化统一保留站来回滚到正常状态（Instructions that lie on that path and do not have any dependencies can be executed in advance and their results immediately used if the prediction was correct. If the prediction was incorrect, the reorder buffer allows to rollback to a sane state by clearing the reorder buffer and re-initializing the unified reservation station.）。</p>
<p>可以构造以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> array1[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> array2[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">Leaker_function ( <span class="keyword">unsigned</span> __int64 pos )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> ErrorValue = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> temp_value = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    ErrorValue = <span class="number">0xFFFF8000</span>`<span class="number">00000000</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  __except(<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(”Hit Exception!“);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  temp_value = array1[ array2[<span class="number">0xffff8000</span>`<span class="number">12345678</span> - &amp;array2] ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在用户空间的程序访问 <code>__try</code> 中的内核地址导致异常，在进行异常处理前，由于乱序执行，CPU 可能已经执行了下面的访问数组的指令（瞬态指令，<code>Transient instructions</code>）。因为访问数组指令不依赖于前面的指令，然后访问到的 <code>array1</code> 数据已经缓存至告诉缓存。</p>
<p>在正常程序流程中，瞬态指令部分不应该被执行到。</p>
<p>然后和上面的幽灵漏洞一样，使用侧信道攻击，借助 Flush+Reload 技术来分析缓存。假设地址 <code>0xffff8000&#39;12345678</code>  中的数据为 <code>84</code>，则高速缓存中缓存的应该是 <code>array1[84]</code>。Flush+Reload 技术分析访问数组 <code>array1</code> 每个元素访问时间如下：</p>
<p><img data-src="https://s2.loli.net/2022/11/19/ALd1sX5f2YcOlpn.png" alt="2.png"></p>
<h3 id="2-3-缓解措施"><a href="#2-3-缓解措施" class="headerlink" title="2.3 缓解措施"></a>2.3 缓解措施</h3><p>可参考：《<a target="_blank" rel="noopener" href="https://blog.yzsun.me/spectre-meltdown-foreshadow/">幽灵・熔毁・预兆</a>》。</p>
<ul>
<li>硬件：重新设计 CPU 以确保在发射读取指令之前进行权限检查，英特尔已于 Coffee Lake Refresh 及后续微架构中修补漏洞，但之前的 CPU 就只能软件修补了；</li>
<li>软件：各大操作系统都推出了内核页表隔离补丁来抵御漏洞：<ul>
<li>Linux 4.15 已部署 Kernel Page-Table Isolation（内核页表隔离，KPTI）；</li>
<li>Windows 10 build 17035 已部署 KVA Shadow；</li>
<li>macOS 10.13.2 &#x2F; iOS 11.2 已部署 Double Map；</li>
<li>……</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.4hou.com/posts/jL6y">https://www.4hou.com/posts/jL6y</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/93599">https://www.anquanke.com/post/id/93599</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.yzsun.me/spectre-meltdown-foreshadow/">https://blog.yzsun.me/spectre-meltdown-foreshadow/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.qfrost.com/WindowsKernel/KVAS/">http://www.qfrost.com/WindowsKernel/KVAS/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33427373">https://zhuanlan.zhihu.com/p/33427373</a></p>
<p><a target="_blank" rel="noopener" href="https://zerosum0x0.blogspot.com/2019/11/fixing-remote-windows-kernel-payloads-meltdown.html">https://zerosum0x0.blogspot.com/2019/11/fixing-remote-windows-kernel-payloads-meltdown.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xuandao_ahfengren/article/details/112135179">https://blog.csdn.net/xuandao_ahfengren/article/details/112135179</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3072">https://xz.aliyun.com/t/3072</a></p>
<p><a target="_blank" rel="noopener" href="https://key08.com/usr/uploads/2022/05/910489819.pdf">https://key08.com/usr/uploads/2022/05/910489819.pdf</a></p>
<h2 id="3-Windows-缓解措施"><a href="#3-Windows-缓解措施" class="headerlink" title="3 Windows 缓解措施"></a>3 Windows 缓解措施</h2><p>微软在 2018.1.3 <a target="_blank" rel="noopener" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/ADV180002">发布更新</a> 以缓解如下的漏洞，并给出了相关的说明<a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/03/15/mitigating-speculative-execution-side-channel-hardware-vulnerabilities/">Mitigating speculative execution side channel hardware vulnerabilities</a>。其中提到 Hypervisor address space segregation、Split user and kernel page tables 等诸多措施。</p>
<ul>
<li>Variant 1: bounds check bypass (<a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5753">CVE-2017-5753</a>), (<em>Spectre</em>)</li>
<li>Variant 2: branch target injection (<a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5715">CVE-2017-5715</a>), (<a target="_blank" rel="noopener" href="https://security-center.intel.com/advisory.aspx?intelid=INTEL-SA-00088&languageid=en-fr">INTEL-SA-00088</a>), (<em>Spectre</em>)</li>
<li>Variant 3: rogue data cache load (<a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5754">CVE-2017-5754</a>), (<em>Meltdown</em>)</li>
</ul>
<p>其中关于 Split user and kernel page tables：</p>
<p>这种缓解措施被称为 Windows 上的<strong>内核虚拟地址（KVA）阴影</strong>（Windows 下的内核页表隔离），它通过每个进程创建两个页面目录基来缓解被称为 Meltdown（CVE-2017-5754）的推测技术。第一个映射“用户”页面表，该表仅包含用户模式映射和少量内核过渡页面。第二个映射了“内核”页面表，其中包含该过程的用户和内核映射。也就是<strong>每个进程提供两个 CR3，一个用于用户空间，一个用于内核空间</strong>。专门用来缓解 Meltdown 漏洞。关于 KVA Shadow 的缓解措施，微软也给了说明文档<a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/">KVA Shadow: Mitigating Meltdown on Windows</a>。</p>
<p>本章节主要先研究 KVA Shadow 缓解措施，然后研究在 Windows 内核中的一些具体的缓解 Spectre 代码示例。</p>
<blockquote>
<p>KVA Shadow 用来缓解 Meltdown，并不能缓解 Spectre。</p>
</blockquote>
<h3 id="3-1-KVA-Shadow"><a href="#3-1-KVA-Shadow" class="headerlink" title="3.1 KVA Shadow"></a>3.1 KVA Shadow</h3><p>利用 Meltdown 漏洞可以在用户空间泄露内核空间的数据，这是因为每一个进程共享系统内核空间，且用户空间可以通过系统调用或中断处理等方式进入内核。这些实现的基础就是线性地址的连续性映射，如在一个进程中，用户空间地址范围 <code>0～0x00007FFF&#39;FFFFFFFF</code>，内核空间地址范围 <code>0xFFFF800&#39;00000000～0xFFFFFFFF&#39;FFFFFFFF</code>。</p>
<div class="note success"><p><a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/">KVA Shadow</a> 的核心原理就是：使用 2 个 CR3 来构建两套页表，一个 CR3 来映射用户空间使用的线性地址，另一个 CR3 来映射内核空间使用的线性地址。前者叫做 Shadow CR3 或 Shadow PLM4 或 <strong>User CR3</strong>，后者叫做 Kernel CR3，以实现页表隔离。</p>
<ul>
<li>Kernel CR3：映射用户空间及内核空间地址，仅在内核模式下使用。</li>
<li>User CR3：仅映射用户空间地址及一小部分内核空间地址。</li>
</ul>
<p>这一小部分内核空间地址实际上存放的是 GDT、IDT，及一些用来提供处理系统调用、中断处理函数的资源，在 <code>ntoskrnl.exe</code> 这部分代码存放在 <mark class="label danger">.KVASCODE</mark> 段中，而非 <code>.text</code> 段。</p>
</div>



<p><img data-src="https://s2.loli.net/2022/11/19/KquAagNcpR4OSFd.png" alt="3.png"></p>
<p>当选择启用 KVA Shadow 机制后，应用程序会有两个 CR3，一个为内核CR3，能够访问内核物理页，而三环的 CR3只映射了内核的<code>.KVASCODE</code> 区段的物理页（少数r3进入r0的入口），而没有映射其他区段的，因此通过 3 环的 Cr3 寻找内核 TEXT 段的物理页，最多只能找到 PPE，而从 PDE 开始就没有映射了。</p>
<p>如上图，当 CPL &#x3D; 3 时，用户 CR3 可访问的地址空间及访问权限只是整个线性地址空间的一部分。两个 CR3 的位置如下：</p>
<ul>
<li>User CR3：<code>KPROCESS.UserDirectoryTableBase</code>。</li>
<li>Kernel CR3：<code>KTHREAD.SavedApcState.Process.DirectoryTableBase</code>、<code>KPRCR.KernelDirectoryTableBase</code>。</li>
</ul>
<div class="note primary"><p>KVA Shadow 起作用的地方主要在：</p>
<ol>
<li>系统调用、用户空间触发的中断处理入口：用于将用户 <code>UserDirectoryTableBase</code> 切换到内核 <code>KernelDirectoryTableBase</code>。</li>
<li>从内核空间返回至用户空间出口：用于将内核 <code>KernelDirectoryTableBase</code> 切换至用户 <code>UserDirectoryTableBase</code>。</li>
</ol>
</div>

<p>下面以 <code>ntoskrnl.exe</code> 中 <code>.KVASCODE</code> 和 <code>.text</code> 两个区段中的地址来解释两个 CR3：</p>
<p><img data-src="https://s2.loli.net/2022/11/20/qtNGmLpdX5STsku.png" alt="4.png"></p>
<ol>
<li><p>获取 CR3。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span> notepad.exe</span><br><span class="line">PROCESS ffffdb04799bd080</span><br><span class="line">    SessionId: <span class="number">1</span>  Cid: <span class="number">0f</span>94    Peb: ac473ef000  ParentCid: <span class="number">0</span>d28</span><br><span class="line">    DirBase: <span class="number">2e269002</span>  ObjectTable: ffffa88876245140  HandleCount: <span class="number">238.</span></span><br><span class="line">    Image: notepad.exe</span><br><span class="line"></span><br><span class="line">kd&gt; dt nt!_EPROCESS ffffdb04799bd080 ImageFileName Pcb.DirectoryTableBase Pcb.UserDirectoryTableBase</span><br><span class="line">   +<span class="number">0x000</span> Pcb                        : </span><br><span class="line">      +<span class="number">0x028</span> DirectoryTableBase         : <span class="number">0x2e269002</span></span><br><span class="line">      +<span class="number">0x388</span> UserDirectoryTableBase     : <span class="number">0x66468001</span></span><br><span class="line">   +<span class="number">0x5a8</span> ImageFileName              : [<span class="number">15</span>]  <span class="string">&quot;notepad.exe&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，这两个 CR3 下 PCID 值不一样，后面会讲到，这将用于性能优化。</p>
<ul>
<li>DirectoryTableBase：<code>PCID = 2</code>。</li>
<li>UserDirectoryTableBase：<code>PCID = 1</code>。</li>
</ul>
</li>
<li><p>获取 <code>ntoskrnl.exe</code> 中 <code>.KVASCODE</code> 和 <code>.text</code> 两个区段不同函数的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; ? nt!KiBreakpointTrapShadow</span><br><span class="line">Evaluate expression: <span class="number">-8794360622400</span> = fffff800`<span class="number">674252</span>c0</span><br><span class="line">kd&gt; ? nt!KiBreakpointTrap</span><br><span class="line">Evaluate expression: <span class="number">-8794366969856</span> = fffff800`<span class="number">66e17800</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>用 <code>UserDirectoryTableBase</code> 解析这两个地址（注意：<code>!vtop</code> 指令不识别十六进制地址的 <code>&#39;</code> 符号）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KiBreakpointTrapShadow</span></span><br><span class="line">kd&gt; !vtop <span class="number">0x66468000</span> <span class="number">0xfffff800674252c0</span></span><br><span class="line">Amd64VtoP: Virt fffff800674252c0, pagedir <span class="number">0000000066468000</span></span><br><span class="line">Amd64VtoP: PML4E <span class="number">0000000066468f</span>80</span><br><span class="line">Amd64VtoP: PDPE <span class="number">0000000079768008</span></span><br><span class="line">Amd64VtoP: PDE <span class="number">00000000797679</span>d0</span><br><span class="line">Amd64VtoP: PTE <span class="number">000000007976e128</span></span><br><span class="line">Amd64VtoP: Mapped phys <span class="number">00000000036122</span>c0</span><br><span class="line">Virtual address fffff800674252c0 translates to physical address <span class="number">36122</span>c0.</span><br><span class="line"></span><br><span class="line"><span class="comment">// KiBreakpointTrap</span></span><br><span class="line">kd&gt; !vtop <span class="number">0x66468000</span> <span class="number">0xfffff80066e17800</span></span><br><span class="line">Amd64VtoP: Virt fffff80066e17800, pagedir <span class="number">0000000066468000</span></span><br><span class="line">Amd64VtoP: PML4E <span class="number">0000000066468f</span>80</span><br><span class="line">Amd64VtoP: PDPE <span class="number">0000000079768008</span></span><br><span class="line">Amd64VtoP: PDE <span class="number">00000000797679b</span>8</span><br><span class="line">Amd64VtoP: zero PDE</span><br><span class="line">Virtual address fffff80066e17800 translation fails, error <span class="number">0xD0000147</span>.</span><br></pre></td></tr></table></figure>

<p>可以看到使用 <code>UserDirectoryTableBase</code> 时，位于 <code>.text</code> 区段的函数 <code>KiBreakpointTrap</code> 地址没有对应的 PTE，没有进行映射。</p>
</li>
<li><p>用 <code>DirectoryTableBase</code> 解析这两个地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KiBreakpointTrapShadow</span></span><br><span class="line">kd&gt; !vtop <span class="number">0x2e269000</span> <span class="number">0xfffff800674252c0</span></span><br><span class="line">Amd64VtoP: Virt fffff800674252c0, pagedir <span class="number">000000002e269000</span></span><br><span class="line">Amd64VtoP: PML4E <span class="number">000000002e269</span>f80</span><br><span class="line">Amd64VtoP: PDPE <span class="number">0000000000</span>c89008</span><br><span class="line">Amd64VtoP: PDE <span class="number">0000000000</span>c8a9d0</span><br><span class="line">Amd64VtoP: PTE <span class="number">0000000000</span>c1c128</span><br><span class="line">Amd64VtoP: Mapped phys <span class="number">00000000036122</span>c0</span><br><span class="line">Virtual address fffff800674252c0 translates to physical address <span class="number">36122</span>c0.</span><br><span class="line">  </span><br><span class="line"><span class="comment">// KiBreakpointTrap</span></span><br><span class="line">kd&gt; !vtop <span class="number">0x2e269000</span> <span class="number">0xfffff80066e17800</span></span><br><span class="line">Amd64VtoP: Virt fffff80066e17800, pagedir <span class="number">000000002e269000</span></span><br><span class="line">Amd64VtoP: PML4E <span class="number">000000002e269</span>f80</span><br><span class="line">Amd64VtoP: PDPE <span class="number">0000000000</span>c89008</span><br><span class="line">Amd64VtoP: PDE <span class="number">0000000000</span>c8a9b8</span><br><span class="line">Amd64VtoP: PTE <span class="number">0000000000</span>c190b8</span><br><span class="line">Amd64VtoP: Mapped phys <span class="number">0000000003004800</span></span><br><span class="line">Virtual address fffff80066e17800 translates to physical address <span class="number">3004800.</span></span><br></pre></td></tr></table></figure>

<p>可以看到，使用 <code>DirectoryTableBase</code> 时，两个不同区段的函数都进行了映射。</p>
</li>
</ol>
<p>注意一个细节：<code>.KVASCODE</code> 区段中的虚拟地址、物理地址在两个 CR3 下面都是相同的，<strong>但是 PLM4E、PDPTE、PDE、PTE 不相同</strong>。</p>
<h3 id="3-2-初始化KVA-Shadow"><a href="#3-2-初始化KVA-Shadow" class="headerlink" title="3.2 初始化KVA Shadow"></a>3.2 初始化KVA Shadow</h3><p>KVAS 在启动（Boot）过程中就被初始化，会在操作系统初始化过程中被启用。NT 内核的入口点称为 <code>KiSystemStartup</code>，由操作系统加载器（OS Loader）调用。<code>KiSystemStartup</code> 依次执行一些基础的初始化步骤，其中的一个步骤就是调用 <code>KilnitializeBootStructures</code>。</p>
<p>在 <code>KiInitializeBootStructures</code> 将会调用 <code>KiEnableKvaShadowing</code>。<code>KiEnableKvaShadowing</code> 的功能是负责启用 KVAS，并设置 <code>KiKvaShadow = 1</code>。</p>
<p>在 <code>KiEnableKvaShadowing</code> 函数中（处理成功则返回 <code>TRUE</code>）：</p>
<ol>
<li><p>如果 <code>KiIsKvaShadowDisabled = 1</code>，表示禁用 KVA Shadow，则不会将 <code>KiKvaShadow = 1</code>，直接返回 <code>1</code>。如果 <code>KiIsKvaShadowDisabled = 0</code>，则会将 <code>KiKvaShadow = 1</code>。</p>
</li>
<li><p>如果 <code>KPRCB.Number = 0</code>，即当前 CPU 编号为 0 时进行下面的步骤 3。否则会调用 <code>KiShadowProcessorAllocation</code> 映射 IDT.base、KernelDirectoryTableBase 的共享内存区对象，并设置 <code>KPRCB.ShadowFlags = 2</code>，然后跳到步骤 6。</p>
</li>
<li><p>调用 <code>KiInitializeIdt</code> 函数，使用 <code>KiInterruptInitTable</code> 中的函数填充 <code>KiDebugTraps[KiDebugTrapIndex++] = v11</code>，然后将中断处理例程（ISR）全部替换成 Shadow 版本。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !idt</span><br><span class="line"></span><br><span class="line">Dumping IDT: fffff80069877000</span><br><span class="line"></span><br><span class="line"><span class="number">00</span>:	fffff80067425100 nt!KiDivideErrorFaultShadow</span><br><span class="line"><span class="number">01</span>:	fffff80067425180 nt!KiDebugTrapOrFaultShadow	Stack = <span class="number">0xFFFFF8006987B9D0</span></span><br><span class="line"><span class="number">02</span>:	fffff80067425240 nt!KiNmiInterruptShadow	Stack = <span class="number">0xFFFFF8006987B7D0</span></span><br><span class="line"><span class="number">03</span>:	fffff800674252c0 nt!KiBreakpointTrapShadow</span><br><span class="line"><span class="number">04</span>:	fffff80067425340 nt!KiOverflowTrapShadow</span><br><span class="line"><span class="number">05</span>:	fffff800674253c0 nt!KiBoundFaultShadow</span><br><span class="line"><span class="number">06</span>:	fffff80067425440 nt!KiInvalidOpcodeFaultShadow</span><br><span class="line"><span class="number">07</span>:	fffff800674254c0 nt!KiNpxNotAvailableFaultShadow</span><br><span class="line"><span class="number">08</span>:	fffff80067425540 nt!KiDoubleFaultAbortShadow	Stack = <span class="number">0xFFFFF8006987B3D0</span></span><br><span class="line"><span class="number">09</span>:	fffff800674255c0 nt!KiNpxSegmentOverrunAbortShadow</span><br><span class="line"><span class="number">0</span>a:	fffff80067425640 nt!KiInvalidTssFaultShadow</span><br><span class="line"><span class="number">0b</span>:	fffff800674256c0 nt!KiSegmentNotPresentFaultShadow</span><br><span class="line"><span class="number">0</span>c:	fffff80067425740 nt!KiStackFaultShadow</span><br><span class="line"><span class="number">0</span>d:	fffff800674257c0 nt!KiGeneralProtectionFaultShadow</span><br><span class="line"><span class="number">0</span>e:	fffff80067425840 nt!KiPageFaultShadow</span><br><span class="line"><span class="number">10</span>:	fffff800674258c0 nt!KiFloatingErrorFaultShadow</span><br><span class="line"><span class="number">11</span>:	fffff80067425940 nt!KiAlignmentFaultShadow</span><br><span class="line"><span class="number">12</span>:	fffff800674259c0 nt!KiMcheckAbortShadow	Stack = <span class="number">0xFFFFF8006987B5D0</span></span><br><span class="line"><span class="number">13</span>:	fffff80067425ac0 nt!KiXmmExceptionShadow</span><br><span class="line"><span class="number">14</span>:	fffff80067425b40 nt!KiVirtualizationExceptionShadow</span><br><span class="line"><span class="number">15</span>:	fffff80067425bc0 nt!KiControlProtectionFaultShadow</span><br><span class="line"><span class="number">1f</span>:	fffff80067425c40 nt!KiApcInterruptShadow</span><br><span class="line"><span class="number">20</span>:	fffff80067425cc0 nt!KiSwInterruptShadow</span><br><span class="line"><span class="number">29</span>:	fffff80067425d40 nt!KiRaiseSecurityCheckFailureShadow</span><br><span class="line"><span class="number">2</span>c:	fffff80067425dc0 nt!KiRaiseAssertionShadow</span><br><span class="line"><span class="number">2</span>d:	fffff80067425e40 nt!KiDebugServiceTrapShadow</span><br><span class="line"><span class="number">2f</span>:	fffff80067425f40 nt!KiDpcInterruptShadow</span><br><span class="line"><span class="number">30</span>:	fffff80067425fc0 nt!KiHvInterruptShadow</span><br><span class="line"><span class="number">31</span>:	fffff80067426040 nt!KiVmbusInterrupt0Shadow</span><br><span class="line"><span class="number">32</span>:	fffff800674260c0 nt!KiVmbusInterrupt1Shadow</span><br><span class="line"><span class="number">33</span>:	fffff80067426140 nt!KiVmbusInterrupt2Shadow</span><br><span class="line"><span class="number">34</span>:	fffff800674261c0 nt!KiVmbusInterrupt3Shadow</span><br><span class="line"><span class="number">35</span>:	fffff80067426468 nt!HalpInterruptCmciService (KINTERRUPT fffff80067705fc0)</span><br></pre></td></tr></table></figure>


</li>
<li><p>先将 <code>KiFlushPcid = 1</code>。如果 <code>KPRCB.FeatureBits &amp; 240000000000h = 240000000000h</code> 则将 <code>KiFlushPcid = 2</code>。</p>
</li>
<li><p>设置 <code>KiKvaShadowMode</code> 的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(KiFlushPcid != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  KiKvaShadowMode = <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  KiKvaShadowMode = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 <code>KPRCB.KernelDirectoryTableBase</code> 的 Bit63。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 则将 bit63 = 1，不刷新 TLB 和分页结构缓存</span></span><br><span class="line"><span class="keyword">if</span>(KiFlushPcid != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  KPRCB.KernelDirectoryTableBase &amp;= <span class="number">63</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>上述初始化好后，返回到函数 <code>KiInitializeBootStructures</code> 继续进行初始化系统调用的入口函数。</p>
<p>在已经开启 KVA Shadow 的情况下：</p>
<ul>
<li>先将 <code>KiSystemCall32Shadow/KiSystemCall64Shadow</code> 保存到全局指针 <code>KiDebugTraps </code> 指向索引为 <code>6/5</code>  的位置。</li>
<li>然后修改 MSR 的 <code>IA32_STAR/IA32_LSTAR/IA32_FMASK</code> 寄存器，将系统调用入口全部替换为 <code>Shadow</code> 版本（如果不开启KVAS则不替换为Shadow版本）。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">rbx = &amp;KiSystemCall32;</span><br><span class="line">rsi = &amp;KiSystemCall64;</span><br><span class="line">KiEnableKvaShadowing(&amp;_KPRCB, IDT.Base);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(KiKvaShadow != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  rbx = &amp;KiSystemCall32Shadow;</span><br><span class="line">  rsi = &amp;KiSystemCall64Shadow;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">KiDebugTraps[KiDebugTrapIndex++] = &amp;KiSystemCall64Shadow;</span><br><span class="line">KiDebugTraps[KiDebugTrapIndex++] = &amp;KiSystemCall32Shadow;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">kd&gt; dqs KiDebugTraps</span></span><br><span class="line"><span class="comment">	fffff800`67814900  fffff800`674252c0 nt!KiBreakpointTrapShadow</span></span><br><span class="line"><span class="comment">	fffff800`67814908  fffff800`67425340 nt!KiOverflowTrapShadow</span></span><br><span class="line"><span class="comment">	fffff800`67814910  fffff800`67425d40 nt!KiRaiseSecurityCheckFailureShadow</span></span><br><span class="line"><span class="comment">	fffff800`67814918  fffff800`67425dc0 nt!KiRaiseAssertionShadow</span></span><br><span class="line"><span class="comment">	fffff800`67814920  fffff800`67425e40 nt!KiDebugServiceTrapShadow</span></span><br><span class="line"><span class="comment">	fffff800`67814928  fffff800`67427180 nt!KiSystemCall64Shadow</span></span><br><span class="line"><span class="comment">	fffff800`67814930  fffff800`67426e40 nt!KiSystemCall32Shadow</span></span><br><span class="line"><span class="comment">	fffff800`67814938  00000000`00000000</span></span><br><span class="line"><span class="comment">	fffff800`67814940  00000400`00000007</span></span><br><span class="line"><span class="comment">	fffff800`67814948  fffff800`66c894f0 nt!KiDispatchException</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IA32_STAR, 提供CS、SS</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">xor</span>     eax, eax;</span><br><span class="line">  mov     edx, <span class="number">230010</span>h;		<span class="comment">// 1、低16位是内核空间的 CS = 0x10（SS = CS + 8 = 0x18）</span></span><br><span class="line">  				<span class="comment">// 2、高16位是用户空间的 CS = 0x23（SS = CS + 8 = 0x2B）</span></span><br><span class="line">  mov     ecx, <span class="number">0</span>C0000081h;	</span><br><span class="line">  wrmsr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IA32_LSTAR, 提供系统调用的 RIP</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">  mov     rdx, rsi;        <span class="comment">// 使用 KiSystemCall64Shadow 函数填充 </span></span><br><span class="line">  mov     rax, rsi;</span><br><span class="line">  shr     rdx, <span class="number">20</span>h;</span><br><span class="line">  mov     ecx, <span class="number">0</span>C0000082h; </span><br><span class="line">  wrmsr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IA32_FMASK, 屏蔽 RFLAGS 的某些位</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">  mov     eax, <span class="number">4700</span>h;      <span class="comment">// 注意在 syscall 中是将 IA32_FMASK 先取反再与上 RFLAGS</span></span><br><span class="line">  			<span class="comment">// 所以系统调用进入内核时会将 TF、IF、DF、NT 位都清零</span></span><br><span class="line">  <span class="keyword">xor</span>     edx, edx;</span><br><span class="line">  mov     ecx, <span class="number">0</span>C0000084h;</span><br><span class="line">  wrmsr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IA32_CSTAR, Intel64 的 syscall 指令不使用，给 ADM CPU 使用</span></span><br><span class="line"><span class="comment">// 用 KiSystemCall32Shadow 填充  IA32_CSTAR</span></span><br><span class="line"><span class="comment">// 在 Intel64 CPU 中的 syscall 指令不使用该寄存器，所以也就用不到 KiSystemCall32Shadow 函数</span></span><br><span class="line"><span class="comment">// 这是给 AMD CPU 使用的，因为 Intel 下面 32 位程序先切换至 64 位再进入内核</span></span><br><span class="line">__asm</span><br><span class="line">&#123;</span><br><span class="line">  mov     rdx, rbx;</span><br><span class="line">  mov     rax, rbx;</span><br><span class="line">  shr     rdx, <span class="number">20</span>h;</span><br><span class="line">  mov     ecx, <span class="number">0</span>C0000083h;</span><br><span class="line">  wrmsr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-CR3-切换分析"><a href="#3-3-CR3-切换分析" class="headerlink" title="3.3 CR3 切换分析"></a>3.3 CR3 切换分析</h3><p><a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/">KVA Shadow: Mitigating Meltdown on Windows</a>建议了解 KVAS最好是从中断处理、系统调用开始。与 KVA Shadow 最相关的事件是那些称为“<strong>内核进入</strong>”和“<strong>内核退出</strong>”事件的事件。这些事件分别涉及从用户模式过渡到内核模式，以及从内核模式过渡到用户模式。</p>
<p>如下图，<a target="_blank" rel="noopener" href="https://zerosum0x0.blogspot.com/2019/11/fixing-remote-windows-kernel-payloads-meltdown.html">系统调用</a>、<a target="_blank" rel="noopener" href="https://www.fortinet.com/blog/threat-research/melting-down-patchguard-leveraging-kpi-to-bypass-kernel-patch-protection">中断处理</a>从用户模式刚进入内核模式阶段的状态。需要在关中断的状态下立即从 <code>UserDirectoryTableBase</code> 切换到内核 <code>KernelDirectoryTableBase</code>。</p>
<p><img data-src="https://s2.loli.net/2022/11/20/d5oJHjywithYMaD.png" alt="5.png"></p>
<p><img data-src="https://s2.loli.net/2022/11/20/7NOrZpJaeHv1dzw.png" alt="5"></p>
<p>下面就以 3 号中断 <code>KiBreakpointTrapShadow</code> 处理函数为例进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dqs KiDebugTraps</span><br><span class="line">fffff800`<span class="number">67814900</span>  fffff800`<span class="number">674252</span>c0 nt!KiBreakpointTrapShadow</span><br><span class="line">fffff800`<span class="number">67814908</span>  fffff800`<span class="number">67425340</span> nt!KiOverflowTrapShadow</span><br><span class="line">fffff800`<span class="number">67814910</span>  fffff800`<span class="number">67425</span>d40 nt!KiRaiseSecurityCheckFailureShadow</span><br><span class="line">fffff800`<span class="number">67814918</span>  fffff800`<span class="number">67425</span>dc0 nt!KiRaiseAssertionShadow</span><br><span class="line">fffff800`<span class="number">67814920</span>  fffff800`<span class="number">67425e40</span> nt!KiDebugServiceTrapShadow</span><br><span class="line">fffff800`<span class="number">67814928</span>  fffff800`<span class="number">67427180</span> nt!KiSystemCall64Shadow</span><br><span class="line">fffff800`<span class="number">67814930</span>  fffff800`<span class="number">67426e40</span> nt!KiSystemCall32Shadow</span><br><span class="line">fffff800`<span class="number">67814938</span>  <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line">fffff800`<span class="number">67814940</span>  <span class="number">00000400</span>`<span class="number">00000007</span></span><br><span class="line">fffff800`<span class="number">67814948</span>  fffff800`<span class="number">66</span>c894f0 nt!KiDispatchException</span><br><span class="line">  </span><br><span class="line">kd&gt; !idt</span><br><span class="line"></span><br><span class="line">Dumping IDT: fffff80069877000</span><br><span class="line"></span><br><span class="line"><span class="number">00</span>:	fffff80067425100 nt!KiDivideErrorFaultShadow</span><br><span class="line"><span class="number">01</span>:	fffff80067425180 nt!KiDebugTrapOrFaultShadow	Stack = <span class="number">0xFFFFF8006987B9D0</span></span><br><span class="line"><span class="number">02</span>:	fffff80067425240 nt!KiNmiInterruptShadow	Stack = <span class="number">0xFFFFF8006987B7D0</span></span><br><span class="line"><span class="number">03</span>:	fffff800674252c0 nt!KiBreakpointTrapShadow</span><br><span class="line"><span class="number">04</span>:	fffff80067425340 nt!KiOverflowTrapShadow</span><br></pre></td></tr></table></figure>





<p><code>KiBreakpointTrapShadow</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0 <span class="comment">// 中断门硬件压栈：SS3、RSP3、RFLAGS、CS3、RIP3、ErrorCode</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0 <span class="comment">//</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0 KiBreakpointTrapShadow proc near        <span class="comment">// DATA XREF: .rdata:00000001400091F0↑o</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0                                         <span class="comment">// .pdata:000000014012C468↑o ...</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0 arg_0           = byte ptr  <span class="number">8</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C0                 test    [rsp+arg_0], <span class="number">1</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C5                 jz      <span class="keyword">short</span> loc_140A1232E <span class="comment">// CS3，判断先前模式</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C5                                         <span class="comment">// 这里不是 ErrorCode，3 号中断不会像堆栈压入 错误码</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C5                                         <span class="comment">// // ErrorCode.EXT = 1，代表外部硬件触发的异常；</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C5                                         <span class="comment">// // ErrorCode.EXT = 0 为软件触发异常（INT n）。</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122C7                 swapgs</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122CA                 lfence                  <span class="comment">// 缓解推测执行</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122CD                 bt      gs:_KPCR.Prcb.ShadowFlags, <span class="number">1</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122D7                 jb      <span class="keyword">short</span> loc_140A122E5 <span class="comment">// ShadowFlags &lt; 1，表示没有开启 KVAS，不用切换 CR3</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122D9                 mov     rsp, gs:_KPCR.Prcb.KernelDirectoryTableBase <span class="comment">// 当前的 CR3 = UserDirectoryTableBase</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E2                 mov     cr3, rsp        <span class="comment">// 将当前的 CR3 切换到 KernelDirectoryTableBase</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E5</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E5 loc_140A122E5:                          <span class="comment">// CODE XREF: KiBreakpointTrapShadow+17↑j</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E5                 mov     rsp, gs:_KPCR.Prcb.RspBaseShadow <span class="comment">// -----</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E5                                         <span class="comment">// kd&gt; dt nt!_KPRCB Rsp*</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E5                                         <span class="comment">//    +0x028 RspBase : Uint8B</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E5                                         <span class="comment">//    +0x8e88 RspBaseShadow : Uint8B</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122E5                                         <span class="comment">// -----------------------------------</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122EE                 mov     gs:<span class="number">10</span>h, rsi</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A122F7                 mov     rsi, gs:_KPCR.IdtBase</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                 add     rsi, <span class="number">4200</span>h      <span class="comment">// kd&gt; dqs 0xfffff800`69877000+0x4200-0x40</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1c0  00000000`00000000</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1c8  00000000`00000000</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1d0  00000000`00000014</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1d8  00007ff8`9f0e0510 KERNELBASE!CreateThreadpoolTimer</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1e0  00000000`00000033</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1e8  00000000`00010246</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1f0  0000008f`6d37f2d8</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b1f8  00000000`0000002b</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b200  00000000`00000000</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12300                                         <span class="comment">// fffff800`6987b208  00000000`00000000</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12307                 push    qword ptr [rsi<span class="number">-8</span>]</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A1230A                 push    qword ptr [rsi<span class="number">-10</span>h]</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A1230D                 push    qword ptr [rsi<span class="number">-18</span>h]</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12310                 push    qword ptr [rsi<span class="number">-20</span>h]</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12313                 push    qword ptr [rsi<span class="number">-28</span>h]</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12316                 mov     rsi, gs:<span class="number">10</span>h</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A1231F                 <span class="keyword">and</span>     qword ptr gs:<span class="number">10</span>h, <span class="number">0</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12329                 jmp     KiBreakpointTrap</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A1232E <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A1232E</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A1232E loc_140A1232E:                          <span class="comment">// CODE XREF: KiBreakpointTrapShadow+5↑j</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A1232E                 lfence</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12331                 jmp     KiBreakpointTrap</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12336 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12336                 retn</span><br><span class="line">KVASCODE:<span class="number">0000000140</span>A12336 KiBreakpointTrapShadow endp</span><br></pre></td></tr></table></figure>





<p><code>KiEnableKvaShadowing</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">PAGELK:<span class="number">000000014099</span>CFDC <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC</span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC</span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC KiEnableKvaShadowing proc near          <span class="comment">// CODE XREF: KxInitializeProcessorState+1EC↑p</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC                                         <span class="comment">// KiInitializeBootStructures+32D↑p</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC                                         <span class="comment">// DATA XREF: ...</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC</span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC <span class="comment">// FUNCTION CHUNK AT PAGELK:00000001409A46E0 SIZE 00000041 BYTES</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC</span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDC                 push    rbx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFDE                 sub     rsp, <span class="number">20</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFE2                 mov     r11, rdx        <span class="comment">// rdx = IDT.Base</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFE5                 mov     rbx, rcx        <span class="comment">// rbx = rcx  = KPRCB</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFE8                 call    KiIsKvaShadowDisabled <span class="comment">// nt!KiFeatureSettings = 0</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFED                 test    al, al          <span class="comment">// rax = 0</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFEF                 jnz     loc_1409A46E0   <span class="comment">// 已禁用 KVAS，并返回 1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFF5                 mov     rax, cs:KeFeatureBits2 <span class="comment">// 已启用 KVAS, nt!KeFeatureBits2 = 0</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>CFFC                 <span class="keyword">and</span>     eax, <span class="number">18000</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D001                 cmp     rax, <span class="number">8000</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D007                 jz      loc_1409A46EC</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D00D</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D00D loc_14099D00D:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+771B↓j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D00D                 call    KiIsKvaLeakSimulated <span class="comment">// 0</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D012                 test    al, al</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D014                 jnz     loc_1409A46FC</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D01A</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D01A loc_14099D01A:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+7727↓j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D01A                 cmp     cs:KiKvaLeakage, <span class="number">0</span> <span class="comment">// KiKvaLeakage = 00001000`00000001</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D021                 jz      loc_1409A4708</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D027</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D027 loc_14099D027:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+7739↓j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D027                 mov     rax, cr3</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D02A                 mov     [rcx+_KPRCB.KernelDirectoryTableBase], rax</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D031                 mov     rax, [rdx+<span class="number">1004</span>h]</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D038                 mov     [rdx+<span class="number">1078</span>h], rax</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D03F                 call    KiInitializeDescriptorIst</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D044                 lea     rcx, [r11+<span class="number">4200</span>h]</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D04B                 mov     [r11+<span class="number">1004</span>h], rcx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D052                 cmp     [rbx+_KPRCB.Number], <span class="number">0</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D056                 jz      <span class="keyword">short</span> loc_14099D0A6</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D058                 mov     rdx, r11</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D05B                 mov     rcx, rbx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D05E                 call    KiShadowProcessorAllocation <span class="comment">// 给IDT.base、KernelDirectoryTableBase创建内存区对象</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D063                 test    eax, eax</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D065                 jz      loc_1409A471A</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D06B                 <span class="keyword">xor</span>     ecx, ecx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D06D                 call    KeGetPrcb</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D072                 movzx   ecx, [rax+_KPRCB.VerwSelector]</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D079                 <span class="keyword">or</span>      [rbx+_KPRCB.ShadowFlags], <span class="number">2</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D080                 mov     [rbx+_KPRCB.VerwSelector], cx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D087</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D087 loc_14099D087:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+189↓j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D087                 cmp     cs:KiFlushPcid, <span class="number">0</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D08E                 jz      <span class="keyword">short</span> loc_14099D09A</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D090                 lock bts [rbx+_KPRCB.KernelDirectoryTableBase], <span class="number">3F</span>h <span class="comment">// -------</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D090                                         <span class="comment">// KiFlushPcid != 0</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D090                                         <span class="comment">// 则将 bit63 = 1，不刷新 TLB 和分页结构缓存</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D090                                         <span class="comment">// ------------------------------</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D09A</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D09A loc_14099D09A:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+B2↑j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D09A                                         <span class="comment">// KiEnableKvaShadowing+770B↓j ...</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D09A                 mov     eax, <span class="number">1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D09F</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D09F loc_14099D09F:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+7740↓j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D09F                 add     rsp, <span class="number">20</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A3                 pop     rbx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A4                 retn</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A4 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A5                 align <span class="number">2</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A6</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A6 loc_14099D0A6:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+7A↑j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A6                 mov     dl, <span class="number">1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0A8                 mov     rcx, r11        <span class="comment">// IDT.Base</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0AB                 call    KiInitializeIdt <span class="comment">// 使用 KiInterruptInitTable 中的函数填充 KiDebugTraps[KiDebugTrapIndex++] = v11//</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0AB                                         <span class="comment">// 全都替换为 Shadow 版本</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0B0                 mov     rax, gs:_KPCR.Prcb.CurrentThread</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0B9                 mov     rcx, [rax+_KTHREAD._union_90.ApcState.Process]</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0C0                 mov     [rcx+_KPROCESS.AddressPolicy], <span class="number">1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0C7                 mov     cs:byte_140D24D90, <span class="number">1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0CE                 lock <span class="keyword">or</span> cs:dword_140D2527C, <span class="number">4000</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0D9                 mov     ecx, <span class="number">1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0DE                 call    KiSetAddressPolicy</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0E3                 mov     eax, <span class="number">18</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0E8                 mov     rcx, <span class="number">40000000000</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0F2                 mov     [rbx+_KPRCB.VerwSelector], ax</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D0F9                 mov     rax, [rbx+_KPRCB.FeatureBits]</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D100                 test    rcx, rax</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D103                 jz      <span class="keyword">short</span> loc_14099D12D</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D105                 mov     rax, cr4</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D108                 btr     rax, <span class="number">7</span>          <span class="comment">// CR4.PGE = 1 ,启用分页模式</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D10D                 bts     rax, <span class="number">11</span>h        <span class="comment">// UMIP = 1，禁止在 CPL&gt;0 时使用 SGDT, SIDT, SLDT, SMSW, 和STR 指令。</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D112                 mov     cr4, rax</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D115                 mov     rax, cr3</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D118                 <span class="keyword">or</span>      rax, <span class="number">2</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D11C                 mov     cr3, rax</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D11F                 <span class="keyword">or</span>      cs:KiFlushPcid, <span class="number">1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D126                 mov     rax, [rbx+_KPRCB.FeatureBits]</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D12D</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D12D loc_14099D12D:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+127↑j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D12D                 mov     rcx, <span class="number">240000000000</span>h</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D137                 <span class="keyword">and</span>     rax, rcx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D13A                 cmp     rax, rcx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D13D                 jnz     <span class="keyword">short</span> loc_14099D146</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D13F                 <span class="keyword">or</span>      cs:KiFlushPcid, <span class="number">2</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D146</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D146 loc_14099D146:                          <span class="comment">// CODE XREF: KiEnableKvaShadowing+161↑j</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D146                 call    HvlRescindEnlightenments</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D14B                 mov     al, cs:KiFlushPcid</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D151                 neg     al              <span class="comment">// CF = 1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D153                 mov     cs:KiKvaShadow, <span class="number">1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D15A                 sbb     ecx, ecx        <span class="comment">// ecx = -1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D15C                 add     ecx, <span class="number">2</span>          <span class="comment">// ecx = 1</span></span><br><span class="line">PAGELK:<span class="number">000000014099</span>D15F                 mov     cs:KiKvaShadowMode, ecx</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D165                 jmp     loc_14099D087</span><br><span class="line">PAGELK:<span class="number">000000014099</span>D165 KiEnableKvaShadowing endp</span><br></pre></td></tr></table></figure>














    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/memory-page-table-isolation/" title="x64 页表隔离（一）Meltdown 和 Spectre">https://directoree.github.io/post/memory-page-table-isolation/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Windows%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> Windows内核</a>
              <a href="/tags/x64%E5%86%85%E5%AD%98%E9%A1%B5%E8%A1%A8%E9%9A%94%E7%A6%BB/" rel="tag"><i class="fa fa-tag"></i> x64内存页表隔离</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/x64-4-level-paging2/" rel="prev" title="x64 分页管理（二）页表自映射">
                  <i class="fa fa-chevron-left"></i> x64 分页管理（二）页表自映射
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/WinXP-Struct/" rel="next" title="WinXP 结构/指令查询">
                  WinXP 结构/指令查询 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">30:05</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/memory-page-table-isolation/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
