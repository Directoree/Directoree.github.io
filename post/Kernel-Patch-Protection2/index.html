<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ğŸ˜„">
<meta property="og:type" content="article">
<meta property="og:title" content="å†…æ ¸è¡¥ä¸ä¿æŠ¤ï¼ˆäºŒï¼‰åˆå§‹åŒ–">
<meta property="og:url" content="https://directoree.github.io/post/Kernel-Patch-Protection2/index.html">
<meta property="og:site_name" content="Ë—Ë‹Ëâ™¡ËËŠË—">
<meta property="og:description" content="ğŸ˜„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/12/14/BSgrqJxlz7IvVAk.png">
<meta property="og:image" content="https://s2.loli.net/2022/12/15/k8blPWOheHLQtvc.png">
<meta property="og:image" content="https://s2.loli.net/2022/12/15/Gz8xaV6tAOmP7NQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/12/17/LFY9WObiSXDepRB.png">
<meta property="og:image" content="https://s2.loli.net/2022/12/17/Fdrk21ePowVCyGZ.png">
<meta property="og:image" content="https://s2.loli.net/2022/12/18/IuSfcrkMeP3Qblt.png">
<meta property="article:published_time" content="2022-12-15T01:57:30.000Z">
<meta property="article:modified_time" content="2023-06-17T14:59:17.864Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="Windowså†…æ ¸">
<meta property="article:tag" content="x64 PG">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/12/14/BSgrqJxlz7IvVAk.png">


<link rel="canonical" href="https://directoree.github.io/post/Kernel-Patch-Protection2/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>å†…æ ¸è¡¥ä¸ä¿æŠ¤ï¼ˆäºŒï¼‰åˆå§‹åŒ– | Ë—Ë‹Ëâ™¡ËËŠË—</title><meta name="robots" content="noindex">
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#222;--content-bg-color:#222;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#2d2f31;--highlight-foreground:#ccc;--highlight-gutter-background:#333;--highlight-gutter-foreground:#888}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#fff;background:#555}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ë—Ë‹Ëâ™¡ËËŠË—</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">çˆ±ä½ æ‰€çˆ±ï¼Œè¡Œä½ æ‰€è¡Œï¼Œå¬ä»ä½ å¿ƒï¼Œæ— é—®è¥¿ä¸œã€‚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-æ›´æ–°æ—¥å¿—">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>æ›´æ–°æ—¥å¿—</a>

  </li>
        <li class="menu-item menu-item-ç©ºè°ƒæˆ¿">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>ç©ºè°ƒæˆ¿</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-PG-KiInitializePatchGuardContext-%E5%89%8D%E5%A5%8F"><span class="nav-text">1 PG_KiInitializePatchGuardContext å‰å¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95"><span class="nav-text">1.1 åˆå§‹åŒ–æ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-text">1.2 å‚æ•°è¯´æ˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E9%80%9A%E7%9F%A5%E5%9B%9E%E8%B0%83"><span class="nav-text">1.3 é€šçŸ¥å›è°ƒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-PG-KiInitializePatchGuardContext"><span class="nav-text">2 PG_KiInitializePatchGuardContext</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-FUNCTIONEXTENTLIST-%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86"><span class="nav-text">2.1 FUNCTIONEXTENTLIST èµ„æºå¤„ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-INITKDBG-%E8%8A%82%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-text">2.2 INITKDBG èŠ‚çš„å¤„ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0%E7%9A%84%E6%A3%80%E7%B4%A2"><span class="nav-text">2.3 å…³é”®å‡½æ•°çš„æ£€ç´¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E4%BF%9D%E5%AD%98%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0%E7%9A%84-PTE-%E9%A1%B5%E9%9D%A2"><span class="nav-text">2.4 ä¿å­˜å…³é”®å‡½æ•°çš„ PTE é¡µé¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-Allocate-PgContext"><span class="nav-text">2.5 Allocate PgContext</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-PGContext-%E6%95%B0%E6%8D%AE%E5%A1%AB%E5%85%85"><span class="nav-text">3 PGContext æ•°æ®å¡«å……</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-CmpAppendDllSection"><span class="nav-text">3.1 CmpAppendDllSection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E9%87%8D%E8%A6%81%E5%87%BD%E6%95%B0-API-%E5%9C%B0%E5%9D%80%E5%A4%87%E4%BB%BD"><span class="nav-text">3.2 é‡è¦å‡½æ•°(API)åœ°å€å¤‡ä»½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8F%8A%E6%8C%87%E9%92%88"><span class="nav-text">3.3 å…¨å±€å˜é‡åŠæŒ‡é’ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD"><span class="nav-text">3.4 å…¶ä»–æ•°æ®å¤‡ä»½</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">62</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">81</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail â†’ mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ â†’ http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.gitee.io/" title="Cutecat â†’ https:&#x2F;&#x2F;catecat.gitee.io" rel="noopener" target="_blank"><i class="fas fa-heartbeat fa-fw"></i>Cutecat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.top/" title="Directoree â†’ https:&#x2F;&#x2F;catecat.top" rel="noopener" target="_blank"><i class="fas fa-heart fa-fw"></i>Directoree</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/Kernel-Patch-Protection2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ë—Ë‹Ëâ™¡ËËŠË—">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          å†…æ ¸è¡¥ä¸ä¿æŠ¤ï¼ˆäºŒï¼‰åˆå§‹åŒ–
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-12-15 09:57:30" itemprop="dateCreated datePublished" datetime="2022-12-15T09:57:30+08:00">2022-12-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-06-17 22:59:17" itemprop="dateModified" datetime="2023-06-17T22:59:17+08:00">2023-06-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/x64%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">x64å†…æ ¸</span></a>
        </span>
    </span>

  
    <span id="/post/Kernel-Patch-Protection2/" class="post-meta-item leancloud_visitors" data-flag-title="å†…æ ¸è¡¥ä¸ä¿æŠ¤ï¼ˆäºŒï¼‰åˆå§‹åŒ–" title="é˜…è¯»æ¬¡æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/post/Kernel-Patch-Protection2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/Kernel-Patch-Protection2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>35k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>32 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ğŸ˜„</p>
<span id="more"></span>

<h2 id="1-PG-KiInitializePatchGuardContext-å‰å¥"><a href="#1-PG-KiInitializePatchGuardContext-å‰å¥" class="headerlink" title="1 PG_KiInitializePatchGuardContext å‰å¥"></a>1 PG_KiInitializePatchGuardContext å‰å¥</h2><p>åˆå§‹åŒ–çš„æ–¹æ³•å†³å®šäº† PG Check çš„æ–¹å¼ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>åˆå§‹åŒ–æ—¶åˆå§‹åŒ–äº† PGContext å’Œ DPC å‡½æ•°ï¼ŒPG Check æ—¶å°±æ˜¯é€šè¿‡ DPC è§¦å‘çš„ã€‚</li>
<li>åˆå§‹åŒ–æ—¶åˆå§‹åŒ–äº† PGContext å’Œ APC å‡½æ•°ï¼ŒPG Check æ—¶å°±æ˜¯é€šè¿‡ APC è§¦å‘çš„ã€‚</li>
<li>åˆå§‹åŒ–æ—¶åˆå§‹åŒ–äº† PGContext å’Œ ç³»ç»Ÿçº¿ç¨‹ï¼ŒPG Check æ—¶å°±æ˜¯é€šè¿‡è¯¥ç³»ç»Ÿçº¿ç¨‹çš„å›è°ƒå‡½æ•°è§¦å‘çš„ã€‚</li>
</ul>
<h3 id="1-1-åˆå§‹åŒ–æ–¹æ³•"><a href="#1-1-åˆå§‹åŒ–æ–¹æ³•" class="headerlink" title="1.1 åˆå§‹åŒ–æ–¹æ³•"></a>1.1 åˆå§‹åŒ–æ–¹æ³•</h3><p>å‡½æ•° <code>PG_KiInitializePatchGuard</code> å¹¶ä¸æ˜¯å¾®è½¯ç»™å‡ºçš„ç¬¦å·åç§°ï¼Œè€Œæ˜¯è®¸å¤šç›¸å…³ PatchGuard æ–‡çŒ®å¯¹å…¶è¿›è¡Œçš„å‘½åã€‚</p>
<p>è¯¥å‡½æ•°ä¸€å…±æœ‰ 5 ä¸ªå‚æ•°ï¼Œåœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼Œä»–ä»¬å†³å®šç€å¯¹ PGContext ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼ã€‚</p>
<ul>
<li>å‚æ•° 1ï¼šDPC æ–¹æ³•çš„ç´¢å¼•ã€‚</li>
<li>å‚æ•° 2ï¼šè°ƒåº¦æ–¹å¼ï¼Œå†³å®šç€åˆå§‹åŒ– PGContext å’Œåˆ›å»º DPC çš„æ–¹æ³•ã€‚</li>
<li>å‚æ•° 3ï¼šå†³å®šè¦æ£€æŸ¥çš„æœ€å¤§å°ºå¯¸å¤§å°ï¼Œæ˜¯ä¸€ä¸ªéšæœºå€¼ã€‚è¯¥éšæœºå€¼å¯ä»¥æ˜¯ 1 æˆ– 2ã€‚</li>
<li>å‚æ•° 4ï¼šæŒ‡å‘ <code>KI_FILTER_FIBER_PARAM</code> ç»“æ„çš„æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆä» <code>ExpLicenseWatchInitWorker</code> ä¸­æ¥è‡ª <code>KPRCB[0].HalReserved[6]</code>ã€‚</li>
<li>å‚æ•° 5ï¼šBOOL ç±»å‹ï¼Œå†³å®šç€æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®— NT å†…æ ¸å‡½æ•°çš„æ ¡éªŒå€¼ã€‚</li>
</ul>
<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ç¬¬ 2ã€4 ä¸ªå‚æ•°ã€‚å…ˆä»‹ç»æ–¹æ³• 0ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œ7 è¿™äº›æ–¹æ³•ç”±å‚æ•° 2 å†³å®šï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KeSetCoalescableTimer = <span class="number">0</span>,</span><br><span class="line">Prcb.AcpiReserved = <span class="number">1</span>,</span><br><span class="line">Prcb.HalReserved = <span class="number">2</span>,</span><br><span class="line">PsCreateSystemThread = <span class="number">3</span>,</span><br><span class="line">KeInsertQueueApc = <span class="number">4</span>,</span><br><span class="line">KiBalanceSetManagerPeriodicDpc = <span class="number">5</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>æ–¹æ³• 0</strong>ï¼š<strong>æ’å…¥ä¸ DPC é“¾æ¥çš„è®¡æ—¶å™¨</strong>ã€‚åˆå§‹åŒ– PGContextã€DPC å‡½æ•°ã€‚å°† DPC å‡½æ•°å‡ºå…¥åˆ°å®šæ—¶å™¨ä¸­ã€‚</p>
</li>
<li><p><strong>æ–¹æ³• 1ï¼Œ2</strong>ï¼š<strong>éšè— DPC</strong>ã€‚åˆå§‹åŒ– PGContextã€KDPC ç»“æ„ã€‚ä¸ä½¿ç”¨å®šæ—¶å™¨ï¼Œè€Œæ˜¯å°† DPC å‡½æ•°ä¿å­˜è‡³ <code>KPRCB</code>ã€‚</p>
<ul>
<li>æ–¹æ³• 1ï¼šå°† DPC å‡½æ•°ä¿å­˜è‡³ <code>KPRCB.AcpiReserved</code>ã€‚ä½¿ç”¨ <code>HalpTimerDpcRoutine</code> å‡½æ•°æ’å…¥é˜Ÿåˆ—ï¼ˆQueueï¼‰ï¼Œå½“æŸä¸ª ACPI äº‹ä»¶å‘ç”Ÿæ—¶è°ƒç”¨ HalpTimerDpcRoutineï¼Œä¾‹å¦‚è¿‡æ¸¡åˆ°ç©ºé—²çŠ¶æ€ã€‚</li>
<li>æ–¹æ³• 2ï¼šå°† DPC å‡½æ•°ä¿å­˜è‡³ <code>KPECB.HalReserved[7]</code>ã€‚ä½¿ç”¨ <code>HalpMcaQueueDpc</code> å‡½æ•°æ’å…¥é˜Ÿåˆ—ï¼Œåœ¨å‘ç”Ÿ HAL å®šæ—¶å™¨æ—¶é’Ÿä¸­æ–­æ—¶å®Œæˆæ£€æŸ¥ï¼ˆè¯·å‚é˜… HalpTimerClockInterrupt&#x2F;HalpTimerAlwaysOnClockInterruptï¼‰</li>
</ul>
</li>
<li><p><strong>æ–¹æ³• 3</strong>ï¼š<strong>ç³»ç»Ÿçº¿ç¨‹</strong>ã€‚åˆå§‹åŒ– PGContextã€å¹¶åˆ›å»ºä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ã€‚æ­¤æ—¶éœ€è¦ <code>ExpLicenseWatchInitWorker</code> å‡½æ•°ä¼ æ¥çš„ <code>KI_FILTER_FIBER_PARAM</code> å‚æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KI_FILTER_FIBER_PARAM</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  CHAR code_prefetch_rcx_retn[<span class="number">4</span>]; <span class="comment">// prefetchw byte ptr [rcx]; retn;</span></span><br><span class="line">  CHAR padding[<span class="number">4</span>];		<span class="comment">// ç”¨äºå¯¹é½çš„4å­—èŠ‚ï¼ˆAlignï¼‰</span></span><br><span class="line">  PVOID pPsCreatesystemThread;	<span class="comment">// PsCreatesystemThread å‡½æ•°çš„å­˜æ ¹</span></span><br><span class="line">  PVOID Pg_Method3stubTocheckRoutine_sub_1405B9FB0;	<span class="comment">// è¢«åˆ›å»ºçš„ç³»ç»Ÿçº¿ç¨‹çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  PVOID pKiBalanceSetManagerPeriodicDpc;		<span class="comment">// æŒ‡å‘ä¸€ä¸ªå…¨å±€çš„ KDPC ç»“æ„</span></span><br><span class="line">&#125;KI_FILTER_FIBER_PARAM, *PKI_FILTER_FIBER_PARAM;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šåœ¨ <code>PG_KiInitializePatchGuard</code> å‡½æ•°é‡Œè°ƒç”¨ <code>sub_xxx</code>ï¼ˆä¸ºäº†æ–¹ä¾¿ï¼Œå°†å…¶å‘½åä¸º <code>Pg_InitMethod3SystemThread</code>ï¼‰ æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç³»ç»Ÿçº¿ç¨‹ï¼Œè¯¥ç³»ç»Ÿçº¿ç¨‹çš„å›è°ƒå‡½æ•°å°±æ˜¯ <code>Pg_Method3stubTocheckRoutine_sub_1405B9FB0</code>ã€‚</p>
</li>
<li><p><strong>æ–¹æ³• 4</strong>ï¼š<strong>å¼‚æ­¥è¿‡ç¨‹è°ƒç”¨</strong>ã€‚åˆå§‹åŒ– PGContextã€KAPC ç»“æ„ã€‚å¹¶å°† APC å‡½æ•°æ’å…¥åˆ°å·²æœ‰çš„ç³»ç»Ÿçº¿ç¨‹ä¸­ã€‚åœ¨å‡½æ•°ä¸­ä¸º <code>KiInsertQueueApc</code> å‡½æ•°å‡†å¤‡å‚æ•°ï¼š </p>
<p>NormalRoutine &#x3D; xHalTimerWatchdogStop</p>
<p>KernelRoutine &#x3D; KiDispatchCallout</p>
<p>RundownRoutine &#x3D; NULL</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Line 8592</span></span><br><span class="line">*((_QWORD *)v212 + <span class="number">317</span>) = KiDispatchCallout;</span><br><span class="line">*((_QWORD *)v212 + <span class="number">318</span>) = xHalTimerWatchdogStop;</span><br><span class="line">*((_DWORD *)v212 + <span class="number">597</span>) = <span class="number">2122344719</span>;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>PsEnumProcessThreads</code> æ¥æšä¸¾ <code>System</code> ç³»ç»Ÿè¿›ç¨‹ä¸­çš„ç³»ç»Ÿçº¿ç¨‹ï¼Œå¦‚æœå“ªä¸€ä¸ªçº¿ç¨‹å›è°ƒå‡½æ•°ç­‰äº <code>PopIrpWorkerControl</code>ï¼Œåˆ™å°†è¯¥çº¿ç¨‹ <code>ETHREAD</code> ä¿å­˜è‡³ PGContextï¼ˆå°†APCæ’å…¥åˆ°è¯¥çº¿ç¨‹ï¼‰ï¼Œç„¶åå°† <code>ETHREAD</code> å­˜æ”¾åœ¨è¯¥ <code>KAPC</code> ç»“æ„ä¸­ã€‚</p>
</li>
<li><p><strong>æŒ‚é’©å¸¸è§„ DPC</strong>ã€‚æ­¤æ—¶éœ€è¦ <code>ExpLicenseWatchInitWorker</code> å‡½æ•°ä¼ æ¥çš„ <code>KI_FILTER_FIBER_PARAM</code> å‚æ•°æœ€åä¸€ä¸ªæˆå‘˜æä¾›çš„æŒ‡å‘å…¨å±€å˜é‡ <code>KiBalanceSetManagerPeriodicDpc</code> çš„æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆç±»å‹ä¸º <code>KDPC</code>ï¼Œå…¶ DPC ä¾‹ç¨‹åœ¨å‡½æ•° <code>KiInitSystem</code> ä¸­åˆå§‹åŒ–ã€‚</p>
</li>
</ol>
<h3 id="1-2-å‚æ•°è¯´æ˜"><a href="#1-2-å‚æ•°è¯´æ˜" class="headerlink" title="1.2 å‚æ•°è¯´æ˜"></a>1.2 å‚æ•°è¯´æ˜</h3><p><strong>å‚æ•°ä¸€ï¼šDPC ä¾‹ç¨‹çš„ç´¢å¼•</strong>ã€‚</p>
<p>æˆ‘ä»¬ä¸Šé¢æè¿°äº†åœ¨æ–¹æ³• 0ï¼Œ1ï¼Œ2ï¼Œ5 ä¸Šï¼Œæˆ‘ä»¬åˆ›å»ºäº† DPC å‡½æ•°ï¼ˆæˆ‘ç®€ç§°ä¸ºPG_DpcFuctionsï¼‰ï¼Œå‚æ•°ä¸€ç´¢å¼•æŒ‡å‘çš„å‡½æ•°ï¼Œå°±æ˜¯å³å°†è¦è¢« <code>PG_DpcFuctions</code> è°ƒç”¨çš„å‡½æ•°ã€‚è¿™äº›è¢«å‚æ•°ä¸€ç´¢å¼•æŒ‡å‘çš„å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯ç”¨äºæ£€æŸ¥ PGContextã€‚</p>
<p>ä¸‹é¢è¿™äº›å‡½æ•°æˆ‘ä»¬å¯ä»¥åœ¨ <code>PG_KiInitializePatchGuard</code> å‡½æ•°ä¸­çœ‹åˆ°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These ones don&#x27;t use exception handlers to fire checks</span></span><br><span class="line">KiTimerDispatch (copied to random pool allocation)</span><br><span class="line">KiDpcDispatch (copied into patchguard context)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// These use exception handlers to fire patchguard checks</span></span><br><span class="line">ExpTimerDpcRoutine</span><br><span class="line">IopTimerDispatch</span><br><span class="line">IopIrpStackProfilerTimer</span><br><span class="line">PopThermalZoneDpc</span><br><span class="line">CmpEnableLazyFlushDpcRoutine</span><br><span class="line">CmpLazyFlushDpcRoutine</span><br><span class="line">KiBalanceSetManagerDeferredRoutine</span><br><span class="line">ExpTimeRefreshDpcRoutine</span><br><span class="line">ExpTimeZoneDpcRoutine</span><br><span class="line">ExpCenturyDpcRoutine</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨å¼‚å¸¸å¤„ç†çš„è¿™ 10 ä¸ª DPC æ˜¯ç³»ç»Ÿ DPC å‡½æ•°ï¼Œå¦‚æœä¼ ç»™è¿™äº›å‡½æ•°çš„å‚æ•° <code>DeferredContext</code> åœ°å€æ˜¯ Non-Canonical Addressï¼ˆä¸åˆæ³•çš„åœ°å€ï¼‰æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨ç›¸åº”çš„ <code>KiCustomAccessRoutine</code> å‡½æ•°ã€‚</p>
<p>ä¸‹é¢æ˜¯å¯¹åº”çš„ 10 ä¸ª KiCustomAccessRoutineï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ExpTimerDpcRoutine</span><br><span class="line">- KiCustomAccessRoutine0 (+ FsRtlTruncateSmallMcb)</span><br><span class="line"></span><br><span class="line">IopTimerDispatch</span><br><span class="line">- KiCustomAccessRoutine1</span><br><span class="line"></span><br><span class="line">IopIrpStackProfilerTimer</span><br><span class="line">- KiCustomAccessRoutine2</span><br><span class="line"></span><br><span class="line">PopThermalZoneDpc</span><br><span class="line">- KiCustomAccessRoutine3</span><br><span class="line"></span><br><span class="line">CmpEnableLazyFlushDpcRoutine</span><br><span class="line">- KiCustomAccessRoutine4</span><br><span class="line"></span><br><span class="line">CmpLazyFlushDpcRoutine</span><br><span class="line">- KiCustomAccessRoutine5</span><br><span class="line"></span><br><span class="line">KiBalanceSetManagerDeferredRoutine</span><br><span class="line">- KiCustomAccessRoutine6</span><br><span class="line"></span><br><span class="line">ExpTimeRefreshDpcRoutine</span><br><span class="line">- KiCustomAccessRoutine7</span><br><span class="line"></span><br><span class="line">ExpTimeZoneDpcRoutine</span><br><span class="line">- KiCustomAccessRoutine8</span><br><span class="line"></span><br><span class="line">ExpCenturyDpcRoutine</span><br><span class="line">- KiCustomAccessRoutine9</span><br></pre></td></tr></table></figure>



<p><strong>å‚æ•°äºŒï¼šè°ƒåº¦æ–¹å¼ï¼Œå†³å®šç€åˆå§‹åŒ– PGContext å’Œåˆ›å»º DPC çš„æ–¹æ³•</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KeSetCoalescableTimer = <span class="number">0</span>,</span><br><span class="line">Prcb.AcpiReserved = <span class="number">1</span>,</span><br><span class="line">Prcb.HalReserved = <span class="number">2</span>,</span><br><span class="line">PsCreateSystemThread = <span class="number">3</span>,</span><br><span class="line">KeInsertQueueApc = <span class="number">4</span>,</span><br><span class="line">KiBalanceSetManagerPeriodicDpc = <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p><strong>å‚æ•°ä¸‰ï¼šå†³å®šè¦æ£€æŸ¥çš„æœ€å¤§å°ºå¯¸å¤§å°ï¼Œæ˜¯ä¸€ä¸ªéšæœºå€¼</strong>ã€‚è¯¥éšæœºå€¼å¯ä»¥æ˜¯ 1 æˆ– 2ã€‚</p>
<p>æ­¤å€¼ç”¨äºç¡®å®šæ¯æ¬¡ PatchGuard æ£€æŸ¥æ—¶æ ¡éªŒå’Œçš„æœ€å¤§æ•°æ®å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ä¸»è¦æ€æƒ³æ˜¯ PatchGuard ä½¿ç”¨ä¸€ä¸ªç»“æ„åˆ—è¡¨æ¥æ£€æŸ¥å®Œæ•´æ€§ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡æ ¡éªŒå’Œä¹‹åï¼Œè®¡æ•°å™¨ä¼šæ ¹æ®æ•°æ®çš„å¤§å°é€’å¢ã€‚è™½ç„¶æ£€æŸ¥çš„æ•°æ®æ€»é‡å°äºå…ˆå‰å®šä¹‰çš„æœ€å¤§å€¼ï¼ŒPatchGuard ç»§ç»­ä¸‹ä¸€ä¸ªç»“æ„ä»¥æ£€æŸ¥å…¶åˆ—è¡¨ã€‚</p>
<p><strong>å‚æ•°å››ï¼šæŒ‡ <code>KI_FILTER_FIBER_PARAM</code> ç»“æ„ä½“</strong>ã€‚</p>
<p>è¯¥ç»“æ„ä½“æ˜¯è°ƒç”¨ <code>KiFilterFiberContext</code> çš„å„ç§æ–¹æ³•ä¸­ï¼Œç”± <code>ExpLicenseWatchInitWorker</code> è°ƒç”¨æ—¶ä¼ é€’çš„ç»“æ„ä½“ã€‚</p>
<p><strong>å‚æ•°äº”ï¼šè¡¨ç¤ºæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®— NT å†…æ ¸å‡½æ•°æ ¡éªŒçš„ Boolean å‹å€¼</strong>ã€‚</p>
<h3 id="1-3-é€šçŸ¥å›è°ƒ"><a href="#1-3-é€šçŸ¥å›è°ƒ" class="headerlink" title="1.3 é€šçŸ¥å›è°ƒ"></a>1.3 é€šçŸ¥å›è°ƒ</h3><h2 id="2-PG-KiInitializePatchGuardContext"><a href="#2-PG-KiInitializePatchGuardContext" class="headerlink" title="2 PG_KiInitializePatchGuardContext"></a>2 PG_KiInitializePatchGuardContext</h2><p>æ ¹æ® 1.3 çš„åˆ†æï¼Œ<code>sub_140A1AEE4</code> å°±æ˜¯å‡½æ•° <code>PG_KiInitializePatchGuardContext</code>ã€‚å¦‚ä¸‹å›¾åœ¨å‡½æ•°çª—å£å°†å‡½æ•°å¤§å°å‡åºæ’åºåï¼Œå¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°æ˜¯æœ€å¤§çš„ä¸€ä¸ªï¼Œä½äº <code>INIT</code> åŒºæ®µä¸­ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/12/14/BSgrqJxlz7IvVAk.png" alt="10.png"></p>
<p>é»˜è®¤æƒ…å†µä¸‹å¯¹è¯¥å‡½æ•° F5 åæ±‡ç¼–ä¼šæç¤ºè¯¥å‡½æ•°å¤ªå¤§æ— æ³•è¿›è¡Œåæ±‡ç¼–ï¼ˆ0x1AAEF &#x3D; 106KB &gt; 64KBï¼‰ï¼Œåªéœ€è¦ä¿®æ”¹ IDA é…ç½®æ–‡ä»¶å³å¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹æ–‡ä»¶ \cfg\hexrays.cfg</span></span><br><span class="line"></span><br><span class="line">MAX_FUNCSIZE            = <span class="number">1024</span>        <span class="comment">// Functions over 64K are not decompiled, Defult:64</span></span><br></pre></td></tr></table></figure>



<p>åœ¨è¯¥å‡½æ•°ä¸­ï¼Œå¤šæ¬¡ä½¿ç”¨äº†å…¨å±€å˜é‡ <code>KdDebuggerNotPresent</code> åœ¨å…³ä¸­æ–­ä¸‹è¿›è¡Œåè°ƒè¯•ã€‚</p>
<ul>
<li><code>KdDebuggerNotPresent != 0</code>ï¼Œå†…æ ¸è°ƒè¯•å™¨ä¸å­˜åœ¨ã€‚</li>
<li><code>KdDebuggerNotPresent == 0</code>ï¼Œå­˜åœ¨å†…æ ¸è°ƒè¯•å™¨ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_disable();</span><br><span class="line">v5 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( !(_BYTE)KdDebuggerNotPresent )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> );</span><br><span class="line">&#125;</span><br><span class="line">_enable();</span><br></pre></td></tr></table></figure>



<h3 id="2-1-FUNCTIONEXTENTLIST-èµ„æºå¤„ç†"><a href="#2-1-FUNCTIONEXTENTLIST-èµ„æºå¤„ç†" class="headerlink" title="2.1 FUNCTIONEXTENTLIST èµ„æºå¤„ç†"></a>2.1 FUNCTIONEXTENTLIST èµ„æºå¤„ç†</h3><p><strong>ä¸€ã€å‚æ•°äºŒï¼Œåˆå§‹åŒ–æ–¹æ³•çš„åˆ¤æ–­ä¸è®¾ç½®</strong>ã€‚</p>
<ul>
<li><code>KI_FILTER_FIBER_PARAM != NULL</code>ï¼Œæœ‰å‚æ•°ï¼Œåªèƒ½ä½¿ç”¨æ–¹æ³• 0ï¼Œ3ï¼Œ5ã€‚</li>
<li><code>KI_FILTER_FIBER_PARAM == NULL &amp;&amp; (a2 != 3 | a2 != 5)</code>ï¼Œæ— å‚æ•°ï¼Œåªèƒ½ä½¿ç”¨æ–¹æ³• 0ï¼Œ1ï¼Œ2ï¼Œ4ï¼Œ7ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// KI_FILTER_FIBER_PARAM != NULL</span></span><br><span class="line">  <span class="comment">// åªèƒ½ä½¿ç”¨æ–¹æ³•0,3,5</span></span><br><span class="line">  v6 = <span class="number">41</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 &gt; <span class="number">5</span> || !_bittest(&amp;v6, a2) ) <span class="comment">// æœ‰å‚æ•°ï¼Œa2 = 1,2,4,7å°†è½¬åŒ–ä¸º0</span></span><br><span class="line">      a2 = <span class="number">0</span>;</span><br><span class="line">    v7 = a5 | <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>  </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (a2 - <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFD</span> ) <span class="comment">//0xD: 1101, a2 - 3 = 2</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4369 = a5;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12; <span class="comment">// KI_FILTER_FIBER_PARAM == NULL &amp;&amp; (a2 != 3 | a2 != 5)</span></span><br><span class="line">    &#125;				 <span class="comment">// æ— å‚æ•°ï¼Œa2 = 0,1,2,4,7æœ‰æ•ˆ</span></span><br><span class="line">    v7 = a5;</span><br><span class="line">    a2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v4369 = v7;</span><br><span class="line">LABEL_12:</span><br><span class="line">  v8 = __2b; <span class="comment">// å…¨å±€å˜é‡ cs:$$2b</span></span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !_bittest(&amp;v8, a2) )</span><br><span class="line">    v10 = a2;</span><br></pre></td></tr></table></figure>



<p><strong>äºŒã€ç–‘ä¼¼å°† <code>ntoskrnl.exe</code> æ¨¡å—å‰ 24 å­—èŠ‚ä¿å­˜è‡³å…¨å±€å˜é‡</strong></p>
<p>è¯¥éƒ¨åˆ†éœ€è¦åŠ¨æ€è°ƒè¯•ç¡®è®¤æ‹·è´çš„å†…å®¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† __2a å‰ 24 å­—èŠ‚æ‹·è´è‡³å…¨å±€å˜é‡ v66ã€v4920_NtoskrnlBase</span></span><br><span class="line"><span class="comment">// __2a ç–‘ä¼¼ Ntoskrnl æ¨¡å—åŸºå€</span></span><br><span class="line"><span class="keyword">if</span> ( __2a )</span><br><span class="line">&#123;</span><br><span class="line">  v64 = <span class="number">24</span>;</span><br><span class="line">  v65 = &amp;__2a;  </span><br><span class="line">  v66 = &amp;v4920_NtoskrnlBase;</span><br><span class="line">  v67 = <span class="number">3</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v64 -= <span class="number">8</span>;</span><br><span class="line">    *v66 = *v65;</span><br><span class="line">    ++v65;</span><br><span class="line">    ++v66;</span><br><span class="line">    --v67;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v67 );</span><br><span class="line">  <span class="keyword">for</span> ( ; v64; --v64 )  <span class="comment">// ä¸ä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">  &#123;</span><br><span class="line">    v68 = *(_BYTE *)v65;</span><br><span class="line">    v65 = (__int64 *)((<span class="keyword">char</span> *)v65 + <span class="number">1</span>);</span><br><span class="line">    *(_BYTE *)v66 = v68;</span><br><span class="line">    v66 = (__int64 *)((<span class="keyword">char</span> *)v66 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_126;</span><br><span class="line">&#125;</span><br><span class="line">v4920_NtoskrnlBase = <span class="number">5368709120</span>i64; <span class="comment">// 0x00000001`40000000, v4920_NtoskrnlBase = g_Ntoskrnl</span></span><br><span class="line">v13_ExAlloc_BugCheckParameter2_+_4 = <span class="number">0</span>i64;</span><br></pre></td></tr></table></figure>



<p><strong>ä¸‰ã€ä» ntoskrl.exe ä¸­è·å– FUNCTIONEXTENTLIST å·²å‹ç¼©èµ„æº</strong></p>
<ol>
<li><p>è°ƒç”¨ <code>LdrResFindResource</code> å‡½æ•°ä» ntoskrl.exe è·å–åç§°ä¸º <code>FUNCTIONEXTENTLIST</code> çš„èµ„æºã€‚æ ¹æ®åå­—åº”è¯¥æ˜¯å‡½æ•°å¯¼å‡ºåˆ—è¡¨åˆ—è¡¨èµ„æºï¼Œåœ¨åé¢çœ‹äº†ä¸€çœ‹åˆ°ï¼Œè¯¥èµ„æºä¸ <code>IMAGE_DIRECTORY_ENTRY_EXCEPTION</code> ç›¸å…³ã€‚å‚è€ƒ <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/libloaderapi/nf-libloaderapi-findresourceexw">FindResourceExW</a> è¯¥å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">LdrResFindResource</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	IN  PVOID ImageBase,		<span class="comment">// ç›®æ ‡èµ„æºæ‰€å±æ¨¡å—åŸºå€ï¼ŒNULLè¡¨ç¤ºå½“å‰æ¨¡å—</span></span></span></span><br><span class="line"><span class="function"><span class="params">	IN  ULONG ResourceType,		<span class="comment">// èµ„æºç±»å‹</span></span></span></span><br><span class="line"><span class="function"><span class="params">	IN  <span class="keyword">wchar_t</span>* ResourceName,	<span class="comment">// èµ„æºåç§°</span></span></span></span><br><span class="line"><span class="function"><span class="params">	IN  ULONG Unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">	OUT PVOID ResourceBuffer,	<span class="comment">// ä¿å­˜è·å–åˆ°çš„èµ„æºç¼“å†²åŒº</span></span></span></span><br><span class="line"><span class="function"><span class="params">	OUT PULONG ResourceSize,	<span class="comment">// è·å–åˆ°çš„èµ„æºå¤§å°ï¼ˆå­—èŠ‚ï¼‰</span></span></span></span><br><span class="line"><span class="function"><span class="params">	OPTIONAL ULONG64 Unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">	OPTIONAL ULONG64 Unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">	OPTIONAL ULONG Unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ResourceType &#x3D; 10ï¼Œå¯¹åº”çš„ <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/menurc/resource-types">ç±»å‹</a> ä¸º <code>RT_RCDATA</code>ï¼ˆApplication-defined resource (raw data)ï¼‰ã€‚</p>
<p>æ ¹æ®ä¸‹é¢çš„åˆ†æï¼Œå¯ä»¥çŸ¥é“è·å–åˆ°çš„èµ„æºæ˜¯ <mark class="label primary"> å‹ç¼©</mark> çš„ï¼Œåé¢è¿˜è¦å¯¹å…¶è¿›è¡Œè§£å‹ã€‚</p>
</li>
<li><p>å¦‚æœ <code>RtlImageNtHeader(NtoskrlBase)</code> å­˜åœ¨ï¼Œåˆ™ä¼šè°ƒç”¨ <code>RtlImageDirectoryEntryToData</code> å‡½æ•°å¾—åˆ° <code>IMAGE_DIRECTORY_ENTRY_EXCEPTION(3)</code> å¼‚å¸¸èµ„æºè¡¨çš„æ•°æ®ã€‚è¯¥å‡½æ•°è¿”å›æŒ‡å®šé•œåƒæ–‡ä»¶ä¸­è·å–åˆ°çš„<strong>æ•°æ®ç›®å½•è¡¨çš„åŸºå€</strong>ã€‚ï¼ˆå‚è€ƒ XP æºç ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID NTAPI <span class="title">RtlImageDirectoryEntryToData</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID Base,		<span class="comment">// æ–‡ä»¶çš„åŸºåœ°å€</span></span></span></span><br><span class="line"><span class="function"><span class="params">    IN BOOLEAN MappedAsImage,	<span class="comment">// TRUE-Image æ–‡ä»¶ï¼ŒFALSE-Mapingçš„æ•°æ®æ–‡ä»¶</span></span></span></span><br><span class="line"><span class="function"><span class="params">    IN USHORT DirectoryEntry,	<span class="comment">// æ•°æ®ç›®å½•è¡¨çš„ç´¢å¼•</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OUT PULONG Size		<span class="comment">// è¿”å›çš„ç›®æ ‡æ•°æ®ç›®å½•è¡¨çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>

<p>æ•°æ®ç›®å½•è¡¨ç´¢å¼•å¦‚ä¸‹ï¼Œå‚è€ƒ <a target="_blank" rel="noopener" href="https://0xrick.github.io/win-internals/pe5/">A dive into the PE file format - PE file structure - Part 4: Data Directories, Section Headers and Sections</a> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXPORT          0   <span class="comment">// Export Directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_IMPORT          1   <span class="comment">// Import Directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_RESOURCE        2   <span class="comment">// Resource Directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_EXCEPTION       3   <span class="comment">// Exception Directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_SECURITY        4   <span class="comment">// Security Directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_BASERELOC       5   <span class="comment">// Base Relocation Table</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_DEBUG           6   <span class="comment">// Debug Directory</span></span></span><br><span class="line"><span class="comment">//      IMAGE_DIRECTORY_ENTRY_COPYRIGHT       7   // (X86 usage)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_ARCHITECTURE    7   <span class="comment">// Architecture Specific Data</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_GLOBALPTR       8   <span class="comment">// RVA of GP</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_TLS             9   <span class="comment">// TLS Directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG    10   <span class="comment">// Load Configuration Directory</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT   11   <span class="comment">// Bound Import Directory in headers</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_IAT            12   <span class="comment">// Import Address Table</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT   13   <span class="comment">// Delay Load Import Descriptors</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR 14   <span class="comment">// COM Runtime descriptor</span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>å››ã€æ ¹æ®å‹ç¼©æ•°æ®çš„ ExceptionDirectory ç­¾åæ‰§è¡Œä¸åŒæ“ä½œ</strong> â€”â€”ç­¾å &#x3D;&#x3D; â€œEXTCâ€</p>
<ol>
<li><p>å‹ç¼©æ•°æ®çš„å‰ 4 å­—èŠ‚è¡¨ç¤º ExceptionDirectory ç­¾åã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_DWORD *)OUT_Compress_ResourceBuffer == <span class="number">1163416643</span> ) <span class="comment">// Signature â€”â€” â€œEXTCâ€</span></span><br></pre></td></tr></table></figure>

<p>å‹ç¼©æ•°æ®çš„ç¬¬äºŒä¸ª <code>DWORD</code> è¡¨ç¤ºå‹ç¼©æ•°æ®çš„å®Œæ•´å¤§å°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v23 = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(OUT_Compress_ResourceBuffer + <span class="number">4</span>); <span class="comment">// å‹ç¼©å¼‚å¸¸æ•°æ®ç›®å½•èµ„æºè¡¨+4 = å¤§å°</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>ä½¿ç”¨å‡½æ•° <code>RtlGetCompressionWorkSpaceSize</code> è·å–å‹ç¼©ã€è§£å‹æ—¶åº”è¯¥ä½¿ç”¨çš„ç©ºé—´å¤§å°ã€‚æ–¹ä¾¿åé¢ä½¿ç”¨ <code>RtlDecompressBufferEx</code> å¯¹è·å–çš„èµ„æºè¿›è¡Œè§£å‹ã€‚å‡½æ•°åŠŸèƒ½å‚è§ã€Š<a target="_blank" rel="noopener" href="https://b1ackie.cn/2021/08/06/%E5%8E%8B%E7%BC%A9%E6%8A%80%E6%9C%AF-windows%E5%8E%8B%E7%BC%A9API/">å‹ç¼©æŠ€æœ¯-windowså‹ç¼©API </a>ã€‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NT_RTL_COMPRESS_API NTSTATUS <span class="title">RtlGetCompressionWorkSpaceSize</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  USHORT CompressionFormatAndEngine,   <span class="comment">// BitmaskæŒ‡å®šå‹ç¼©æ ¼å¼å’Œå¼•æ“ç±»å‹ã€‚</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] PULONG CompressBufferWorkSpaceSize,  <span class="comment">// æ­¤å€¼ç”¨äºç¡®å®šRtlCompressBufferçš„WorkSpaceç¼“å†²åŒºçš„æ­£ç¡®å¤§å°ã€‚</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] PULONG CompressFragmentWorkSpaceSize <span class="comment">// æ­¤å€¼ç”¨äºç¡®å®šRtlDecompressFragmentçš„WorkSpaceç¼“å†²åŒºçš„æ­£ç¡®å¤§å°</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>è¯¥éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä» ntoskrl.exe ä¸­è·å–å¦‚ä¸‹åç§°çš„èµ„æº</span></span><br><span class="line"><span class="comment">// ç„¶åå°†è·å–çš„èµ„æºä¿å­˜è‡³å‚æ•°äº”ä¸­ã€‚èµ„æºå¤§å°ä¿å­˜è‡³å‚æ•°å…­ï¼ˆå­—èŠ‚ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)LdrResFindResource(</span><br><span class="line">                   <span class="number">5368709120</span>i64,  <span class="comment">// 0x00000001`40000000</span></span><br><span class="line">                   <span class="number">10</span>i64,</span><br><span class="line">                   (__int64)<span class="string">L&quot;FUNCTIONEXTENTLIST&quot;</span>, <span class="comment">// IN_ResourceNameï¼Œæ˜¯å‹ç¼©æ•°æ®åç§°</span></span><br><span class="line">                   <span class="number">0</span>i64,</span><br><span class="line">                   (__int64)&amp;OUT_Compress_ResourceBuffer,   <span class="comment">// OUT_Compress_ResourceBuffer</span></span><br><span class="line">                   (__int64)&amp;OUT_Compress_ResourceSize,			<span class="comment">// OUT_Compress_ResourceSize</span></span><br><span class="line">                   <span class="number">0</span>i64,</span><br><span class="line">                   <span class="number">0</span>i64,</span><br><span class="line">                   <span class="number">0</span>) &gt;= <span class="number">0</span></span><br><span class="line">  &amp;&amp; (<span class="keyword">unsigned</span> __int64)(OUT_Compress_ResourceSize - <span class="number">8</span>) &lt;= <span class="number">0xFFFFFFF7</span> ) <span class="comment">// æ³¨æ„è¿™é‡Œçš„ 0xFFFFFFF7 æ˜¯æ— ç¬¦å·æ•°ï¼ˆæ­£æ•°ï¼‰</span></span><br><span class="line">&#123;</span><br><span class="line">  LODWORD(v4374) = OUT_Compress_ResourceSize;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è¿”å›æŒ‡å‘ Ntoskrl.exe æ–‡ä»¶çš„ NtHeader</span></span><br><span class="line">  <span class="keyword">if</span> ( RtlImageNtHeader(<span class="number">5368709120</span>i64) )</span><br><span class="line">  &#123;</span><br><span class="line">    LOBYTE(v14) = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Get ExceptionDirectory, V15 æŒ‡å‘ VA</span></span><br><span class="line">    <span class="comment">// https://bbs.pediy.com/thread-36436.htm</span></span><br><span class="line">    v15_pExceptionDirectory = RtlImageDirectoryEntryToData(<span class="number">5368709120</span>i64, v14, <span class="number">3</span>i64, </span><br><span class="line">                                                            &amp;v4407_ExceptionDirectory_Size);</span><br><span class="line">    <span class="keyword">if</span> ( v15 )</span><br><span class="line">    &#123;</span><br><span class="line">      v16 = <span class="number">0</span>i64;</span><br><span class="line">      v17 = <span class="number">-1073741823</span>; <span class="comment">// 0xC0000001</span></span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)OUT_Compress_ResourceBuffer == <span class="number">1163416643</span> ) <span class="comment">// Signature â€”â€” â€œEXTCâ€</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// NumberOfBytes = RtlCompressBuffer å·¥ä½œç¼“å†²åŒºçš„å¤§å°</span></span><br><span class="line">        <span class="comment">// v4471 = RtlDecompressFragment å·¥ä½œç¼“å†²åŒºçš„å¤§å°</span></span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)RtlGetCompressionWorkSpaceSize(<span class="number">4</span>i64, &amp;NumberOfBytes, &amp;v4471) &lt; <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">        v23_Compress_ResourceSize = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(OUT_Compress_ResourceBuffer + <span class="number">4</span>); <span class="comment">// å‹ç¼©å¼‚å¸¸æ•°æ®ç›®å½•èµ„æºè¡¨+4 = å¤§å°</span></span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v23_Compress_ResourceSize &lt; <span class="number">8</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          HIDWORD(NumberOfBytes) = <span class="number">-805294751</span>;</span><br><span class="line">          KeBugCheckEx(__ROR4__(<span class="number">-805306349</span>, <span class="number">92</span>), <span class="number">0xE</span>ui64, OUT_Compress_ResourceBuffer, <span class="number">0x140000000</span>ui64, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4374);</span><br><span class="line">        &#125;</span><br><span class="line">        v24 = __rdtsc();</span><br><span class="line">        v25 = (__ROR8__(v24, <span class="number">3</span>) ^ v24) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64;</span><br><span class="line">        v4626 = *((_QWORD *)&amp;v25 + <span class="number">1</span>);</span><br><span class="line">        v26 = (v25 ^ *((_QWORD *)&amp;v25 + <span class="number">1</span>))</span><br><span class="line">            - <span class="number">11</span></span><br><span class="line">            * ((<span class="keyword">unsigned</span> __int64)(((<span class="keyword">unsigned</span> __int64)v25 ^ *((_QWORD *)&amp;v25 + <span class="number">1</span>))</span><br><span class="line">                                * (<span class="keyword">unsigned</span> __int128)<span class="number">0x2E8BA2E8BA2E8BA3</span>ui64 &gt;&gt; <span class="number">64</span>) &gt;&gt; <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<ol start="3">
<li><p><strong>ä½¿ç”¨ç®—æ³•ç”Ÿæˆ <code>ExAllocatePoolWithTag</code> çš„ <code>Tag</code> å‚æ•°ç”³è¯·å†…å­˜</strong></p>
<p>ä¸‹é¢ä¼šè°ƒç”¨ <code>ExAllocatePoolWithTag</code> å‡½æ•° 2 æ¬¡ï¼Œéƒ½æ˜¯ç”³è¯·çš„éåˆ†é¡µå†…å­˜ä¸å¯æ‰§è¡Œå†…å­˜ <code>NonPagedPoolNx</code>ã€‚</p>
<ol>
<li><p>ç¬¬ä¸€æ¬¡ã€‚<u><em>ä»åé¢åˆ†æä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™å—å†…å­˜ v16 å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°ï¼Œåº”è¯¥ç®—æ˜¯ä¸€ä¸ªBugäº†</em></u>ã€‚</p>
<ul>
<li>å†…å­˜ç±»å‹ï¼šNonPagedPoolNx</li>
<li>å†…å­˜å¤§å°ï¼šRtlCompressBuffer å‡½æ•°çš„ WorkSpace</li>
<li>å†…å­˜æ ‡ç­¾ï¼šv29</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v16 = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)ExAllocatePoolWithTag(NonPagedPoolNx, </span><br><span class="line">                                            (<span class="keyword">unsigned</span> <span class="keyword">int</span>)Compress_NumberOfBytes, v29);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬äºŒæ¬¡ã€‚<strong>ç”¨æ¥ä¿å­˜ FUNCTIONEXTENTLIST èµ„æºè§£å‹åçš„æ•°æ®ã€‚</strong></p>
<ul>
<li>å†…å­˜ç±»å‹ï¼šNonPagedPoolNx</li>
<li>å†…å­˜å¤§å°ï¼šFUNCTIONEXTENTLIST èµ„æºçš„å¤§å°</li>
<li>å†…å­˜æ ‡ç­¾ï¼šv40</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v13_1ExAlloc_Compress_Point_2DecompressBuffer = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)ExAllocatePoolWithTag(NonPagedPoolNx, </span><br><span class="line">                                                                                  v23_Compress_ResourceSize, v40);</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p><strong>è§£å‹ä¸Šé¢è·å–çš„ FUNCTIONEXTENTLIST èµ„æº</strong></p>
<p><strong>æ³¨æ„</strong>ï¼šæ˜¯ä» FUNCTIONEXTENTLIST èµ„æºçš„ç¬¬ <strong>8</strong> å­—èŠ‚å¼€å§‹è§£å‹ã€‚</p>
<p>è°ƒç”¨å‡½æ•° <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtldecompressbufferex">RtlDecompressBufferEx</a>ï¼Œä» FUNCTIONEXTENTLIST èµ„æºçš„ç¬¬ <strong>8</strong> å­—èŠ‚å¼€å§‹è§£å‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NT_RTL_COMPRESS_API NTSTATUS <span class="title">RtlDecompressBufferEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  USHORT CompressionFormat,	<span class="comment">// æŒ‡å®šå‹ç¼©æ ¼å¼çš„ä½æ©ç </span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] PUCHAR UncompressedBuffer,	<span class="comment">// æ¥æ”¶è§£å‹åæ•°æ®çš„ç¼“å†²åŒº</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  ULONG  UncompressedBufferSize,	<span class="comment">// å‚æ•°äºŒç¼“å†²åŒºçš„å¤§å°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  PUCHAR CompressedBuffer,	<span class="comment">// æŒ‡å‘å‹ç¼©ï¼ˆè¦è§£å‹ï¼‰æ•°æ®çš„æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  ULONG  CompressedBufferSize,	<span class="comment">// å‹ç¼©ï¼ˆè¦è§£å‹ï¼‰æ•°æ®çš„å¤§å°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] PULONG FinalUncompressedSize,	<span class="comment">// å®é™…è§£å‹æ•°æ®ç¼“çš„å¤§å°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  PVOID  WorkSpace	<span class="comment">// RtlDecompressBufferEx å·¥ä½œåŒºå¤§å°ï¼Œä» RtlGetCompressionWorkSpaceSize è·å–</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>è§£å‹è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v47 = RtlDecompressBufferEx(<span class="number">4</span>, (_DWORD)v13_1ExAllocCompressBuffer_2DecompressBuffer,</span><br><span class="line">                            (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v23_Compress_ResourceSize, OUT_Compress_ResourceBuffer + <span class="number">8</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>æ‰€ä»¥åœ¨<strong>ç­¾å &#x3D;&#x3D; â€œEXTCâ€</strong>ï¼Œå¯ä»¥å¾—çŸ¥ <strong>å‹ç¼©çš„ FUNCTIONEXTENTLIST</strong> ç»“æ„ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PG_COMPRESSED_DATA</span>&#123;</span></span><br><span class="line">    ULONG Header;</span><br><span class="line">    ULONG DecompressSize;</span><br><span class="line">    BYTE  CompressedData[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p><strong>å¯¹ ExceptionDirectory è¿›è¡Œç´¯åŠ åå¯¹æ¯”</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å§‹å¯¹ ExceptionDirectory è¿›è¡Œç´¯åŠ ï¼Œæ¯æ¬¡æ“ä½œ 4 å­—èŠ‚</span></span><br><span class="line"><span class="comment">// å°†å¼‚å¸¸æ•°æ®ç›®å½•è¡¨å†…å®¹å¾ªç¯åœ° 4 å­—èŠ‚ç›¸åŠ ï¼Œæœ€åçš„å’Œä¸º v61</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// v4407_ExceptionDirectory_Size ä¸º ExceptionDirectory å¤§å°</span></span><br><span class="line"><span class="comment">// v15_pExceptionDirectory ä¸ºæŒ‡å‘ ExceptionDirectory çš„è™šæ‹Ÿåœ°å€</span></span><br><span class="line"></span><br><span class="line">LABEL_111:</span><br><span class="line">     v60 = <span class="number">0</span>;</span><br><span class="line">     v61 = v15_pExceptionDirectory - <span class="number">0x40000</span></span><br><span class="line">     <span class="keyword">if</span> ( v4407_ExceptionDirectory_Size )</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="keyword">do</span></span><br><span class="line">       &#123;</span><br><span class="line">         v62 = v60; <span class="comment">// 0</span></span><br><span class="line">         v60 += <span class="number">4</span>;</span><br><span class="line">         v61 += *(_DWORD *)(v15_pExceptionDirectory + <span class="number">4</span> * (v62 &gt;&gt; <span class="number">2</span>));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">while</span> ( v60 &lt; v4407_ExceptionDirectory_Size );</span><br><span class="line">     &#125;</span><br><span class="line">		  </span><br><span class="line">		<span class="comment">// v13_1ExAllocCompressBuffer_2DecompressBuffer ä¿å­˜èµ„æº L&quot;FUNCTIONEXTENTLIST&quot; ç¬¬ 8 å­—èŠ‚å¼€å§‹è¿›è¡Œè§£å‹çš„æ•°æ®</span></span><br><span class="line">    <span class="comment">// ä¿å­˜çš„å€¼å°±æ˜¯æœªè§£å‹çš„L&quot;FUNCTIONEXTENTLIST&quot;å¤§å°</span></span><br><span class="line">		v63 = v13_1ExAllocCompressBuffer_2DecompressBuffer[<span class="number">1</span>];</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// ç¡®ä¿è¯¥å€¼ä¸è§£å‹çš„èµ„æºæ•°æ®ç›¸åŒ</span></span><br><span class="line">    <span class="keyword">if</span> ( v61 != (_DWORD)v63 )</span><br><span class="line">    &#123;</span><br><span class="line">      v4236 = <span class="number">-805294751</span>;</span><br><span class="line">      KeBugCheckEx(__ROR4__(<span class="number">-805306349</span>, <span class="number">92</span>), <span class="number">0x10</span>ui64, (ULONG_PTR)v13_1ExAllocCompressBuffer_2DecompressBuffer, <span class="number">0x140000000</span>ui64, v63 ^ v61);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_117;</span><br></pre></td></tr></table></figure>

<p>å¯æ‰€ä»¥åœ¨<strong>ç­¾å &#x3D;&#x3D; â€œEXTCâ€</strong>ï¼Œï¼Œ<strong>FUNCTIONEXTENTLIST èµ„æºè§£å‹åå¹¶ä¸æ˜¯ ExceptionDirectory çš„æ˜æ–‡æ•°æ®</strong>ã€‚</p>
</li>
</ol>
<p>æ‰€ä»¥åœ¨<strong>ç­¾å &#x3D;&#x3D; â€œEXTCâ€</strong>ï¼Œå¾—åˆ° <strong>è§£å‹çš„ FUNCTIONEXTENTLIST</strong> ç»“æ„ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PG_DECOMPRESS_DATA</span>&#123;</span></span><br><span class="line">    ULONG IntegrityCheckLength;</span><br><span class="line">    ULONG InitIntegrityCheckData;</span><br><span class="line">    BYTE UnknownData[<span class="keyword">sizeof</span>(UncompressedData<span class="number">-8</span>)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>äº”ã€æ ¹æ®å‹ç¼©æ•°æ®çš„ ExceptionDirectory ç­¾åæ‰§è¡Œä¸åŒæ“ä½œ</strong> â€”â€”ç­¾å &#x3D;&#x3D; â€œEXTLâ€</p>
<ol>
<li><p>æ ¹æ®è®¡ç®—å¾—åˆ°çš„å‚æ•° <code>v53 = Tag</code> è°ƒç”¨ <code>ExAllocatePoolWithTag</code> ç”³è¯·éåˆ†é¡µå†…å­˜ï¼Œç”³è¯·çš„å¤§å°æ˜¯ <code>sizeof(FUNCTIONEXTENTLIST) - 4</code>ã€‚ç„¶åä» FUNCTIONEXTENTLIST èµ„æºçš„ç¬¬ 4 å››å­—èŠ‚å¼€å§‹çš„åœ°æ–¹æ‹·è´è‡³ç”³è¯·çš„éåˆ†é¡µå†…å­˜ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">v59 = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)ExAllocatePoolWithTag(NonPagedPoolNx, </span><br><span class="line">                                            (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4374_OUT_Compress_ResourceSize - <span class="number">4</span>, v53);</span><br><span class="line"></span><br><span class="line">v13_1ExAllocCompressBuffer_2DecompressBuffer = v59;</span><br><span class="line"><span class="keyword">if</span> ( v59 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// å°†è§£å‹å‰çš„èµ„æº L&quot;FUNCTIONEXTENTLIST&quot; ç¬¬4å­—èŠ‚å¼€å§‹æ‹·è´è‡³éåˆ†é¡µå†…å­˜</span></span><br><span class="line">    memmove(v59, (<span class="keyword">const</span> <span class="keyword">void</span> *)(OUT_Compress_ResourceBuffer + <span class="number">4</span>), </span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4374_OUT_Compress_ResourceSize - <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_111;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ç­¾å &#x3D;&#x3D; â€œEXTCâ€æ˜¯æ˜æ˜¾ä¸åŒçš„ï¼š</p>
<ul>
<li>ç­¾å &#x3D;&#x3D; â€œEXTCâ€ï¼Œä» <code>FUNCTIONEXTENTLIST + 8</code> å¼€å§‹å¤„ç†ã€‚<mark class="label danger"> éœ€è¦</mark>è°ƒç”¨ <code>RtlDecompressBufferEx</code> è¿›è¡Œè§£å‹ã€‚</li>
<li>ç­¾å &#x3D;&#x3D; â€œEXTLâ€ï¼Œä» <code>FUNCTIONEXTENTLIST + 4</code> å¼€å§‹å¤„ç†ã€‚<mark class="label success"> æ— éœ€</mark>è°ƒç”¨ <code>RtlDecompressBufferEx</code> è¿›è¡Œè§£å‹ã€‚</li>
</ul>
</li>
<li><p>ç„¶åé‡å¤ä¸Šé¢çš„æ­¥éª¤ 5 â€”â€”<strong>å¯¹ ExceptionDirectory è¿›è¡Œç´¯åŠ åå¯¹æ¯”</strong>ã€‚</p>
</li>
</ol>
<p><strong>å…­ã€æ€»ç»“</strong></p>
<p>åœ¨å‡½æ•° <code>PG_KiInitializePatchGuardContext</code> ä¸€å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯å¼€å§‹åˆå§‹åŒ– PatchGuard æ—¶ã€‚å¦‚æœå…¨å±€å˜é‡ <code>$$2a &lt;= 0</code>ï¼Œåˆ™ä¼šå¯¹ ntoskrl.exe æ¨¡å—ä¸­åç§°ä¸º <code>FUNCTIONEXTENTLIST</code> çš„èµ„æºè¿›è¡Œå¤„ç†åï¼Œä¸è¯¥æ¨¡å—çš„å¼‚å¸¸èµ„æºè¡¨è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™ç›´æ¥ä¼šè“å±ï¼ˆKeBugCheckExï¼‰ã€‚æˆ‘ä»¬çŸ¥é“å¼‚å¸¸èµ„æºè¡¨ä¸­å­˜æ”¾çš„æ˜¯ <code>RUNTIME_FUNCTION</code>ï¼Œæ‰€ä»¥è¦åœ¨ç³»ç»Ÿå¯åŠ¨å‰ä¿®æ”¹ ntoskrl.exe æ¨¡å—ä¸­çš„å‡½æ•°ï¼Œå°±è¦äº†è§£æœ¬èŠ‚ä¸­ç»†èŠ‚ï¼Œäº†è§£ <code>FUNCTIONEXTENTLIST</code> èµ„æºå¯¹æ¯”å¤„ç†è¿‡ç¨‹ï¼Œç„¶åè¿›è¡Œç»•è¿‡ã€‚</p>
<p>FUNCTIONEXTENTLIST èµ„æºçš„å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/12/15/k8blPWOheHLQtvc.png" alt="11"></p>
<h3 id="2-2-INITKDBG-èŠ‚çš„å¤„ç†"><a href="#2-2-INITKDBG-èŠ‚çš„å¤„ç†" class="headerlink" title="2.2 INITKDBG èŠ‚çš„å¤„ç†"></a>2.2 INITKDBG èŠ‚çš„å¤„ç†</h3><ol>
<li><p>è·å– <code>FsRtlUninitializeSmallMcb</code> å‡½æ•°æ‰€åœ¨çš„æ¨¡å—ã€åŒºæ®µã€‚è¯¥æ¨¡å—ä¸º ntoskrnl.exeã€‚</p>
<p>è°ƒç”¨ <code>RtlPcToFileHeader</code> å‡½æ•°ï¼Œå¾—åˆ°ç›®æ ‡å‡½æ•°æ‰€åœ¨çš„æ¨¡å—åŸºå€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PVOID <span class="title">RtlPcToFileHeader</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID PcValue,		<span class="comment">// ç›®æ ‡å‡½æ•°çš„è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰</span></span></span></span><br><span class="line"><span class="function"><span class="params">    OUT PVOID *BaseOfImage	<span class="comment">// ç›®æ ‡å‡½æ•°æ‰€åœ¨æ¨¡å—çš„åŸºå€ï¼ˆVAï¼‰</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>


</li>
<li><p>è°ƒç”¨ <code>RtlImageNtHeader</code> å‡½æ•°è·å– ntoskrnl.exe çš„ <code>pNtHeader</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PIMAGE_NT_HEADERS <span class="title">RtlImageNtHeader</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID Base <span class="comment">// æ¨¡å—åŸºå€ï¼ˆVAï¼‰</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„è¿”å›å€¼æ˜¯ VA å€¼ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>RtlSectionTableFromVirtualAddress</code> å‡½æ•°è·å–ç›®æ ‡å‡½æ•°æ‰€åœ¨çš„åŒºæ®µ VA åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PIMAGE_SECTION_HEADER <span class="title">RtlSectionTableFromVirtualAddress</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PIMAGE_NT_HEADERS NtHeaders,	<span class="comment">// VA</span></span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID Base,		<span class="comment">// VA</span></span></span></span><br><span class="line"><span class="function"><span class="params">    IN ULONG Address		<span class="comment">// ç›®æ ‡å‡½æ•°åœ°å€ç›¸å¯¹äºåŸºå€çš„ RVA</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>

<p>è¿”å›å€¼æ˜¯ VAã€‚ç›®æ ‡å‡½æ•° <code>FsRtlUninitializeSmallMcb</code> ä½äº <code>INITKDBG</code> åŒºæ®µã€‚</p>
</li>
<li><p>è·å–å¦‚ä¸‹å‡ ä¸ªå‡½æ•°ç›¸å¯¹äº <code>INITKDBG</code> åŒºæ®µçš„ RVAã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sub_140A0DD10</span><br><span class="line">sub_140A0E830</span><br><span class="line">RtlLookupFunctionEntryEx</span><br></pre></td></tr></table></figure>


</li>
<li><p>è®¾ç½®ä¸€ä¸ªå…¨å±€ BOOL å€¼ <code>v4202</code>ã€‚</p>
<p>å¦‚æœå‡½æ•° <code>MmStrongCodeGuaranteesEnforced() &gt; 0</code>ã€<code>sub_140A360D4() &gt; 0</code> ï¼Œåˆ™ <code>v4202 = TRUE</code>ã€‚</p>
<p>å¦‚æœå‡½æ•° <code>PG_KiInitializePatchGuardContext</code> çš„å‚æ•°äºŒï¼ˆè°ƒåº¦æ–¹æ³•ï¼‰ä¸º 7ï¼Œåˆ™ <code>v4202 = TRUE</code>ã€‚ </p>
</li>
<li><p>ç–‘ä¼¼æ£€æŸ¥ EPT Hookã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)MmStrongCodeGuaranteesEnforced() &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)sub_140A360D4() )</span><br></pre></td></tr></table></figure>

<p><code>MmStrongCodeGuaranteesEnforced</code> å‡½æ•°è¿”å› <code>MiFlags[2] &amp; 1</code>ï¼ˆBit 15ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BYTE MiFlags[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 <span class="title">MmStrongCodeGuaranteesEnforced</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> BYTE2(MiFlags) &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sub_140A360D4</code> å‡½æ•°ç–‘ä¼¼æ£€æŸ¥ EPT Hookã€‚å‚è€ƒã€Š<a target="_blank" rel="noopener" href="https://key08.com/index.php/2021/08/18/1301.html">Windows PatchGuard KiErrata671Present</a>ã€‹ã€‚</p>
<ul>
<li>å¦‚æœ KiErrata671Presen å‡½æ•°è¢«æˆåŠŸä¿®æ”¹åˆ™è¿”å› FALSEã€‚</li>
<li>å¦‚æœä¿®æ”¹å¤±è´¥åˆ™è¿”å› TRUEã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_140A360D4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// si</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v4; <span class="comment">// [rsp+50h] [rbp+8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = KeGetCurrentIrql();</span><br><span class="line">  __writecr8(<span class="number">0xF</span>ui64);</span><br><span class="line">  v0 = __readcr0();</span><br><span class="line">  __writecr0(v0 &amp; <span class="number">0xFFFFFFFFFFFEFFFF</span>ui64);</span><br><span class="line">  v1 = *((_BYTE *)KiErrata671Present + <span class="number">2</span>);</span><br><span class="line">  *((_BYTE *)KiErrata671Present + <span class="number">2</span>) = <span class="number">0xC3</span>; <span class="comment">// 0xC3 == ret</span></span><br><span class="line">  v2 = KiErrata671Present();</span><br><span class="line">  <span class="keyword">if</span> ( *((_BYTE *)KiErrata671Present + <span class="number">2</span>) != v1 )</span><br><span class="line">    *((_BYTE *)KiErrata671Present + <span class="number">2</span>) = v1;</span><br><span class="line">  __writecr0(v0);</span><br><span class="line">  __writecr8(v4);</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-3-å…³é”®å‡½æ•°çš„æ£€ç´¢"><a href="#2-3-å…³é”®å‡½æ•°çš„æ£€ç´¢" class="headerlink" title="2.3 å…³é”®å‡½æ•°çš„æ£€ç´¢"></a>2.3 å…³é”®å‡½æ•°çš„æ£€ç´¢</h3><p>å¦‚ä¸‹ä»£ç ï¼Œä¼šå°† <code>off_140C005D8</code> åœ°å€ä¿å­˜åˆ°æ•°ç»„ <code>qword_140C00210[0]</code> ç¬¬ä¸€ä¸ªå…ƒç´ ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qword_140C00210[<span class="number">0</span>] = (__int64)off_140C005D8; </span><br></pre></td></tr></table></figure>

<p><code>qword_140C00210</code> æ•°ç»„å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/12/15/Gz8xaV6tAOmP7NQ.png" alt="12.png"></p>
<p>å¯ä»¥çœ‹åˆ° <code>qword_140C00210[0]</code> æ˜¯ç©ºçš„ï¼Œåœ¨åˆå§‹åŒ– PatchGuard æ—¶è¿›è¡Œå¡«å……ã€‚è€Œå¡«å……çš„åœ°å€æŒ‡å‘ <code>xHalHaltSystem</code> å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000140</span>C005D8 off_140C005D8   dq offset xHalHaltSystem</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ 15 ä¸ªå‡½æ•°éƒ½æ˜¯éå¸¸å…³é”®é‡è¦çš„å‡½æ•°ï¼Œæˆ‘å°†è¿™ä¸ªæ•°ç»„å‘½åä¸º <code>CriticalRoutines</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PVOID CriticalRoutines[<span class="number">15</span>] = &#123;</span><br><span class="line">    xHaliHaltSystem,</span><br><span class="line">    KeBugCheckEx,</span><br><span class="line">    KeBugCheck2,</span><br><span class="line">    KiBugCheckDebugBreak,</span><br><span class="line">    KiDebugTrapOrFault,</span><br><span class="line">    DbgBreakPointWithStatus,</span><br><span class="line">    RtlCaptureContext,</span><br><span class="line">    KeQueryCurrentStackInformation,</span><br><span class="line">    KiSaveProcessorControlState,</span><br><span class="line">    memmove,</span><br><span class="line">    IoSaveBugCheckProgress,</span><br><span class="line">    KeIsEmptyAffinityEx,</span><br><span class="line">    VfNotifyVerifierOfEvent,</span><br><span class="line">    _guard_check_icall,</span><br><span class="line">    KeGuardDispatchICall</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>è°ƒç”¨ <a target="_blank" rel="noopener" href="https://doxygen.reactos.org/d8/d2f/unwind_8c.html#ae54b6e92ac33487731d412097a83cf7a">RtlLookupFunctionTable</a> å‡½æ•°å¾ªç¯æŸ¥æ‰¾ <code>CriticalRoutines</code> æ•°ç»„ 15 ä¸ªå‡½æ•°æ‰€åœ¨æ¨¡å—çš„  <code>KLDR_DATA_TABLE_ENTRY.ExceptionTable</code> çš„åœ°å€ï¼Œå®é™…ä¸Šè·å¾—çš„ç»“æœæ˜¯åŒä¸€ä¸ªï¼Œå› ä¸ºä»–ä»¬éƒ½åœ¨ ntoskrnl.exe æ¨¡å—ä¸­ã€‚è¯¥å‡½æ•°åŠŸèƒ½ï¼šæŸ¥æ‰¾å‚æ•°ä¸€å‡½æ•°æ‰€åœ¨æ¨¡å—çš„ ExceptionTable åŸºå€ï¼Œä¹Ÿæ˜¯å¼‚å¸¸èµ„æºè¡¨ä¸­ç¬¬ä¸€ä¸ª RUNTIME_FUNCTION ç»“æ„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PRUNTIME_FUNCTION <span class="title">RtlLookupFunctionTable</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">   IN  PVOID  ControlPC,	<span class="comment">// ç›®æ ‡å‡½æ•°åœ°å€</span></span></span></span><br><span class="line"><span class="function"><span class="params">   OUT PVOID* ImageBase,	<span class="comment">// æ¥æ”¶ç›®æ ‡å‡½æ•°æ‰€åœ¨æ¨¡å—åŸºå€</span></span></span></span><br><span class="line"><span class="function"><span class="params">   OUT PULONG SizeOfTable	<span class="comment">// sizeof(RUNTIME_FUNCTION) </span></span></span></span><br><span class="line"><span class="function"><span class="params">  )</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="function">NTSYSAPI PRUNTIME_FUNCTION <span class="title">RtlLookupFunctionEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  DWORD64               ControlPc,	<span class="comment">// ç›®æ ‡å‡½æ•°åœ°å€</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] PDWORD64              ImageBase,	<span class="comment">// æ¥æ”¶ç›®æ ‡å‡½æ•°æ‰€åœ¨æ¨¡å—åŸºå€</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] PUNWIND_HISTORY_TABLE HistoryTable</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè°ƒç”¨ <code>RtlLookupFunctionEntry</code> è·å–ç›®æ ‡å‡½æ•°æ‰€åœ¨çš„ <code>RUNTIME_FUNCTION</code> çš„åœ°å€ã€‚</p>
<ul>
<li>RtlLookupFunctionTableï¼šè·å–ç›®æ ‡å‡½æ•°æ‰€åœ¨æ¨¡å—ç¬¬ä¸€ä¸ª RUNTIME_FUNCTION çš„åœ°å€ï¼Œå³ ExceptionTable è¡¨åœ°å€ã€‚</li>
<li>RtlLookupFunctionEntryï¼šè·å–ç›®æ ‡å‡½æ•°æ‰€åœ¨ RUNTIME_FUNCTION çš„åœ°å€ï¼ˆå¹¶ä¸ä¸€å®šæ˜¯ç¬¬ä¸€ä¸ªï¼‰ã€‚</li>
</ul>
<blockquote>
<p>Windows 10 å‰ï¼ŒPEB ä¸Šçš„æ¨¡å—é“¾è¡¨å’Œ <code>pDriver-&gt;DriverSection</code> éƒ½æ˜¯ <code>_LDR_DATA_TABLE_ENTRY</code> ç»“æ„ã€‚<br>Windows 10 å¼€å§‹ï¼ŒPEB ä¸Šçš„æ¨¡å—é“¾è¡¨æ˜¯ <code>_LDR_DATA_TABLE_ENTRY</code>ï¼Œå†…æ ¸ <code>DriverSection</code> çš„æ¨¡å—é“¾æ˜¯ <code>_KLDR_DATA_TABLE_ENTRY</code> ç»“æ„ã€‚</p>
</blockquote>
<p>ä¸‹é¢å°±æ˜¯è¿›è¡Œå…³é”®å‡½æ•°æ£€ç´¢ï¼Œå‰ææ˜¯å·²çŸ¥è¿™äº›å‡½æ•°éƒ½ä½äº ntoskrnl.exe æ¨¡å—ä¸­ã€‚</p>
<ol>
<li>å…ˆè·å–å…³é”®å‡½æ•° <code>CriticalRoutines[i]</code> æ‰€åœ¨æ¨¡å—çš„å¼‚å¸¸èµ„æºè¡¨åŸºåœ°å€ï¼ˆä½¿ç”¨RtlLookupFunctionTableå‡½æ•°ï¼‰ã€‚</li>
<li>ç„¶åä½¿ç”¨ <code>CriticalRoutines[i]</code> å‡½æ•°åœ°å€ï¼Œå¾ªç¯åœ°ä¸å¼‚å¸¸èµ„æºè¡¨ ExceptionTable ä¸­æ¯ä¸€ä¸ª RUNTIME_FUNCTION å‡½æ•°åœ°å€æ¯”è¾ƒã€‚</li>
<li>å¦‚æœ  <code>CriticalRoutines[i]</code> å‡½æ•°ä¸åœ¨å¼‚å¸¸èµ„æºè¡¨ä¸­ï¼Œå°±è·³è½¬åˆ° <code>LABEL_184</code>ï¼Œä¸ä¼šä¿å­˜å‡½æ•°æ‰€åœ¨é¡µé¢çš„ PTEï¼ˆä¸‹é¢2.4èŠ‚å†…å®¹ï¼‰ã€‚</li>
</ol>
<h3 id="2-4-ä¿å­˜å…³é”®å‡½æ•°çš„-PTE-é¡µé¢"><a href="#2-4-ä¿å­˜å…³é”®å‡½æ•°çš„-PTE-é¡µé¢" class="headerlink" title="2.4 ä¿å­˜å…³é”®å‡½æ•°çš„ PTE é¡µé¢"></a>2.4 ä¿å­˜å…³é”®å‡½æ•°çš„ PTE é¡µé¢</h3><p>æ­¥éª¤ 2.3 ä¸­çš„å…³é”®å‡½æ•°éªŒè¯é€šè¿‡åæ‰ä¼šæ‰§è¡Œæœ¬èŠ‚å†…å®¹ï¼Œå¦åˆ™ç›´æ¥è·³è½¬è‡³ <code>LABEL_184</code>ã€‚</p>
<ol>
<li><p>åœ¨ä¸€ä¸ªå¤§å¾ªç¯é‡Œé¢ï¼Œé¦–å…ˆæ‰¾åˆ° <code>CriticalRoutines[i]</code> å‡½æ•°æ‰€åœ¨é¡µé¢åŸºåœ°å€ï¼Œæœ‰å¯èƒ½ä¸€ä¸ªå‡½æ•°çš„å¤§å°è¶…è¿‡ 1 ä¸ªé¡µé¢ï¼Œæ‰€ä»¥è¦æ‰¾åˆ°è¯¥å‡½æ•°æ‰€åœ¨é¡µé¢æ‰€æœ‰çš„é¡µé¢åŸºåœ°å€ï¼Œæˆ‘å°†é¡µé¢åŸºåœ°å€å‘½åä¸º <code>CriticalRoutinesPageBaseAddress</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// è·å–ç›®æ ‡å‡½æ•°æ‰€åœ¨çš„é¡µé¢åŸºå€</span></span><br><span class="line"><span class="comment">// ç›®æ ‡å‡½æ•°å¯èƒ½å¾ˆå¤§ï¼Œè¶…è¿‡ä¸€ä¸ªé¡µé¢ï¼Œæ‰€ä»¥éœ€è¦è®¡ç®—ç›®æ ‡å‡½æ•°çš„ç»ˆæ­¢åœ°å€ v4207</span></span><br><span class="line"><span class="comment">// ç„¶ååœ¨è¿™ä¸ªå‡½æ•°åŒ…å«çš„é¡µé¢ä¸­ï¼Œè¿›è¡Œä¸‹é¢çš„ do-while è¿ç®—</span></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// v99:Ntos_ImageBase</span></span><br><span class="line">v112_PageBasedAddress  = (v99 + v110) &amp; <span class="number">0xFFFFFFFFFFFFF000</span>ui64; <span class="comment">// å¯¹é½ä¸€ä¸ªé¡µé¢</span></span><br><span class="line">v4207 = v99 + v110 + v111; </span><br></pre></td></tr></table></figure>


</li>
<li><p>è·å–é¡µé¢çš„ 4 çº§é¡µè¡¨è™šæ‹Ÿåœ°å€ï¼ˆå®é™…ä¸Šæ˜¯å‡½æ•°æ‰€åœ¨æ‰€æœ‰é¡µé¢ï¼Œå¤–é¢è¿˜æœ‰ä¸€å±‚å¾ªç¯ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– PTE Base</span></span><br><span class="line">v115_PteAddress   = MmPteBase + ((v112_PageBasedAddress  &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7FFFFFFFF8</span>i64);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// X çš„ PTE ä¸º PteAddressï¼ŒPteAddress çš„ PTE = X çš„ PdeAddressã€‚</span></span><br><span class="line">  <span class="comment">// v113_4levelPagetableAddress[0] = PteAddress</span></span><br><span class="line">  <span class="comment">// v113_4levelPagetableAddress[1] = PdeAddress</span></span><br><span class="line">  <span class="comment">// v113_4levelPagetableAddress[2] = PdpteAddress</span></span><br><span class="line">  <span class="comment">// v113_4levelPagetableAddress[3] = Plm4eAddress</span></span><br><span class="line">  *v113_4levelPagetableAddress = v115_PteAddress  ;</span><br><span class="line">  ++v113_4levelPagetableAddress;</span><br><span class="line">  v115_PteAddress   = MmPteBase + ((v115_PteAddress &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7FFFFFFFF8</span>i64);</span><br><span class="line">  --v114;</span><br><span class="line">&#125;<span class="keyword">while</span> ( v114 );</span><br></pre></td></tr></table></figure>


</li>
<li><p>å¦‚æœ 4 çº§é¡µè¡¨çš„ <code>PAT/PS</code> å¯ç”¨ï¼Œåˆ™å°†è¯¥çº§é¡µè¡¨ç½® 0ã€‚</p>
</li>
<li><p>è°ƒç”¨ <code>ExAllocatePoolWithTag</code> å‡½æ•°åˆ†é… <code>NonPagedPoolNx</code> ç±»å‹å†…å­˜ï¼Œå°†è¯¥å‡½æ•°çš„ 4 çº§é¡µè¡¨ä¿å­˜èµ·æ¥ã€‚</p>
</li>
</ol>
<h3 id="2-5-Allocate-PgContext"><a href="#2-5-Allocate-PgContext" class="headerlink" title="2.5 Allocate PgContext"></a>2.5 Allocate PgContext</h3><p>æœ¬èŠ‚ä¸»è¦æ˜¯ç”³è¯·ä¸€å—éåˆ†é¡µå†…å­˜ï¼Œè¿™å—éåˆ†é¡µå†…å­˜å°±æ˜¯ PGContextã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">194</span>_TempPgContext = ExAllocatePoolWithTag(<span class="number">0</span>, v190 + v177, v183);</span><br></pre></td></tr></table></figure>



<ol>
<li><p>å†…å­˜å¤§å°ï¼š<code>v190 + v177</code>ã€‚</p>
<p>v190ï¼šå¯ä»¥çœ‹åˆ° v190 æœ€å¤§ä¸º <code>0x7FF</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v190</span></span><br><span class="line">v189 = __rdtsc();</span><br><span class="line">v4495 = (__ROR8__(v189, <span class="number">3</span>) ^ v189) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64 &gt;&gt; <span class="number">64</span>;</span><br><span class="line">v190 = (v4495 ^ <span class="number">0x4002001</span> * (__ROR8__(v189, <span class="number">3</span>) ^ v189)) &amp; <span class="number">0x7FF</span>;</span><br></pre></td></tr></table></figure>

<p>v177ï¼šæœ€å¤§ä¸º <code>sizeof(INITKDBG) + 0xAA8 + 0x80000 + 0x7FF + Max(0x10*16)ã€4-levelpagetableã€‘ + 16 ä¸ª CriticalRoutines[i] å‡½æ•°å¤§å°</code>ã€‚</p>
</li>
<li><p>æ ‡ç­¾ v183 é€šè¿‡è®¡ç®—è·å¾—ï¼Œæ­¤å¤„å¿½ç•¥ã€‚</p>
</li>
</ol>
<p><strong>æ ¹æ®ä»£ç åˆ†ææœ‰ä»¥ä¸‹ç»“è®ºï¼š</strong></p>
<ol>
<li>ç”³è¯· <code>v190 + v177</code> å¤§å°çš„ PGContextã€‚</li>
<li>åœ¨ PGContext é¦–å°¾ä½¿ç”¨éšæœºå€¼è¿›è¡Œå¡«å……ï¼Œå¡«å……çš„å­—èŠ‚æœ€å¤§ä¸º <code>v190 = 0x7FF</code> å­—èŠ‚ã€‚</li>
<li>PGContext ä¸­é—´æœ‰ <code>v177</code> å¤§å°çš„å¡«å……æ•°æ®ã€‚åŒ…å«ï¼š<ul>
<li>INITKDBG å¤§å°</li>
<li>0xAA8</li>
<li>16 ä¸ª <code>CriticalRoutines[i]</code> å‡½æ•°å¤§å°ã€åŠè¿™ 16 ä¸ªå…³é”®å‡½æ•°å¯¹åº”çš„ 4-level é¡µè¡¨ï¼ˆ0x100ï¼‰ã€‚</li>
<li>0x80000</li>
<li>0x7FFï¼ˆv190æœ€å¤§å¯è¾¾ï¼‰</li>
</ul>
</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/12/17/LFY9WObiSXDepRB.png" alt="13.png"></p>
<p>æ‰€ä»¥ PGContext ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/12/17/Fdrk21ePowVCyGZ.png" alt="14.png"></p>
<p>ç´§æ¥ç€ï¼Œå°† <code>v175 + 0x80000</code> å¤§å°çš„ç©ºé—´æ¸… <code>0</code>ï¼Œå¹¶å¼€å§‹å¯¹ PGContext è¿›è¡Œå¡«å……ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v212_ContextData = (<span class="keyword">char</span> *)<span class="number">194</span>_TempPgContext + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v193_sizeofRandomValue_1;</span><br><span class="line">...</span><br><span class="line"><span class="built_in">memset</span>(v212_ContextData, <span class="number">0</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v175 + <span class="number">0x80000</span>));</span><br></pre></td></tr></table></figure>

<p>è¯¥èŠ‚æè¿°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*************************************************************************************/</span></span><br><span class="line"><span class="comment">// å¡«å…… PGContext é¦–å°¾</span></span><br><span class="line">v189 = __rdtsc();</span><br><span class="line">v4495 = (__ROR8__(v189, <span class="number">3</span>) ^ v189) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64 &gt;&gt; <span class="number">64</span>;</span><br><span class="line">v190 = (v4495 ^ <span class="number">67117057</span> * (__ROR8__(v189, <span class="number">3</span>) ^ v189)) &amp; <span class="number">0x7FF</span>;</span><br><span class="line">v191 = __rdtsc();</span><br><span class="line">v192 = (__ROR8__(v191, <span class="number">3</span>) ^ v191) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64;</span><br><span class="line">v4496 = *((_QWORD *)&amp;v192 + <span class="number">1</span>);</span><br><span class="line">v193_sizeofRandomValue_1 = (*((_QWORD *)&amp;v192 + <span class="number">1</span>) ^ (<span class="keyword">unsigned</span> __int64)v192) % (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v190 + <span class="number">1</span>);</span><br><span class="line"><span class="number">194</span>_TempPgContext = ExAllocatePoolWithTag(<span class="number">0</span>, v190 + v177, v183);</span><br><span class="line"><span class="keyword">if</span> ( !<span class="number">194</span>_TempPgContext )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">v195 = v193_sizeofRandomValue_1;</span><br><span class="line">v196 = <span class="number">194</span>_TempPgContext;</span><br><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v193_sizeofRandomValue_1 &gt;= <span class="number">8</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v197 = (<span class="keyword">unsigned</span> __int64)(<span class="keyword">unsigned</span> <span class="keyword">int</span>)v193_sizeofRandomValue_1 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v198 = __rdtsc();</span><br><span class="line">    v195 -= <span class="number">8</span>;</span><br><span class="line">    v199 = (__ROR8__(v198, <span class="number">3</span>) ^ v198) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64;</span><br><span class="line">    v4497 = *((_QWORD *)&amp;v199 + <span class="number">1</span>);</span><br><span class="line">    *v196 = v199 ^ *((_QWORD *)&amp;v199 + <span class="number">1</span>);</span><br><span class="line">    ++v196;</span><br><span class="line">    --v197;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v197 );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v195 )</span><br><span class="line">&#123;</span><br><span class="line">  v200 = __rdtsc();</span><br><span class="line">  v201 = (__ROR8__(v200, <span class="number">3</span>) ^ v200) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64;</span><br><span class="line">  v4498 = *((_QWORD *)&amp;v201 + <span class="number">1</span>);</span><br><span class="line">  v202 = v201 ^ *((_QWORD *)&amp;v201 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)v196 = v202;</span><br><span class="line">    v196 = (_QWORD *)((<span class="keyword">char</span> *)v196 + <span class="number">1</span>);</span><br><span class="line">    v202 &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    --v195;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v195 );</span><br><span class="line">&#125;</span><br><span class="line">v203 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v193_sizeofRandomValue_1;</span><br><span class="line">v204_sizeofRandomValue_2 = v190 - v193_sizeofRandomValue_1;</span><br><span class="line">v205_RandomValue2_Start = (_QWORD *)((<span class="keyword">char</span> *)<span class="number">194</span>_TempPgContext + </span><br><span class="line">                                     (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v193_sizeofRandomValue_1 + (<span class="keyword">unsigned</span> __int64)v177);</span><br><span class="line"><span class="keyword">if</span> ( v204_sizeofRandomValue_2 &gt;= <span class="number">8</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v206 = (<span class="keyword">unsigned</span> __int64)v204_sizeofRandomValue_2 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v207 = __rdtsc();</span><br><span class="line">    v204_sizeofRandomValue_2 -= <span class="number">8</span>;</span><br><span class="line">    v208 = (__ROR8__(v207, <span class="number">3</span>) ^ v207) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64;</span><br><span class="line">    v4499 = *((_QWORD *)&amp;v208 + <span class="number">1</span>);</span><br><span class="line">    *v205_RandomValue2_Start = v208 ^ *((_QWORD *)&amp;v208 + <span class="number">1</span>);</span><br><span class="line">    ++v205_RandomValue2_Start;</span><br><span class="line">    --v206;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v206 );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v204_sizeofRandomValue_2 )</span><br><span class="line">&#123;</span><br><span class="line">  v209 = __rdtsc();</span><br><span class="line">  v210 = (__ROR8__(v209, <span class="number">3</span>) ^ v209) * (<span class="keyword">unsigned</span> __int128)<span class="number">0x7010008004002001</span>ui64;</span><br><span class="line">  v4500 = *((_QWORD *)&amp;v210 + <span class="number">1</span>);</span><br><span class="line">  v211 = v210 ^ *((_QWORD *)&amp;v210 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)v205_RandomValue2_Start = v211;</span><br><span class="line">    v205_RandomValue2_Start = (_QWORD *)((<span class="keyword">char</span> *)v205_RandomValue2_Start + <span class="number">1</span>);</span><br><span class="line">    v211 &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    --v204_sizeofRandomValue_2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v204_sizeofRandomValue_2 );</span><br><span class="line">&#125;</span><br><span class="line">v212_ContextData = (<span class="keyword">char</span> *)<span class="number">194</span>_TempPgContext + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v193_sizeofRandomValue_1;</span><br><span class="line">v4501 = <span class="number">194</span>_TempPgContext;</span><br><span class="line">v4199 = (<span class="keyword">unsigned</span> __int64)<span class="number">194</span>_TempPgContext + v203;</span><br><span class="line"><span class="keyword">if</span> ( !(_QWORD *)((<span class="keyword">char</span> *)<span class="number">194</span>_TempPgContext + v203) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// v173 = v4201_INITKDBG_VirtualSize, v174 = 0xAA8</span></span><br><span class="line"><span class="comment">// v175 = v173 + v174 == v4201_INITKDBG_VirtualSize + 0xAA8</span></span><br><span class="line">v213 = v175 + <span class="number">0x80000</span>;</span><br><span class="line">v4202_BOOL_GlobleFlag = v175 + <span class="number">0x80000</span>;</span><br><span class="line"><span class="built_in">memset</span>(v212_ContextData, <span class="number">0</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v175 + <span class="number">0x80000</span>));</span><br><span class="line"><span class="comment">/*************************************************************************************/</span></span><br></pre></td></tr></table></figure>





<h2 id="3-PGContext-æ•°æ®å¡«å……"><a href="#3-PGContext-æ•°æ®å¡«å……" class="headerlink" title="3 PGContext æ•°æ®å¡«å……"></a>3 PGContext æ•°æ®å¡«å……</h2><h3 id="3-1-CmpAppendDllSection"><a href="#3-1-CmpAppendDllSection" class="headerlink" title="3.1 CmpAppendDllSection"></a>3.1 CmpAppendDllSection</h3><p>å…ˆè§‚å¯Ÿ <code>CmpAppendDllSection</code> å‡½æ•°ç‰¹å¾ï¼š</p>
<ol>
<li><p>ä» IDA åæ±‡ç¼–ç»“æœæ¥çœ‹å‡½æ•° <code>CmpAppendDllSection</code> å¤§å°ä¸º <code>0xC8</code>ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/12/18/IuSfcrkMeP3Qblt.png" alt="15.png"></p>
<p><code>0x190 + 0xC8 = 0x258</code>ï¼Œå¯ä»¥çœ‹åˆ°å‡½æ•°ä» <code>0x0000000140A36246</code> åˆ° <code>0x0000000140A36258</code> éƒ½æ˜¯å¡«å……æ•°æ®ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INIT:<span class="number">0000000140</span>A36190 CmpAppendDllSection proc near          </span><br><span class="line">INIT:<span class="number">0000000140</span>A36190                                    db      <span class="number">2</span>Eh</span><br><span class="line">INIT:<span class="number">0000000140</span>A36190 <span class="number">2</span>E <span class="number">48</span> <span class="number">31</span> <span class="number">11</span>                        xor     [<span class="type">rcx</span>], rdx</span><br><span class="line">...</span><br><span class="line">INIT:<span class="number">0000000140</span>A36241 BA <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                     mov     edx, <span class="number">1</span></span><br><span class="line">INIT:<span class="number">0000000140</span>A36246 <span class="number">41</span> FF E0                           jmp     r8</span><br><span class="line">INIT:<span class="number">0000000140</span>A36246                          ; -------------------------------------------------------------------</span><br><span class="line">INIT:<span class="number">0000000140</span>A36249 <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>+           db <span class="number">0</span>Fh dup(<span class="number">90</span><span class="built_in">h</span>)</span><br><span class="line">INIT:<span class="number">0000000140</span>A36249 <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span> <span class="number">90</span>     CmpAppendDllSection endp</span><br><span class="line">INIT:<span class="number">0000000140</span>A36258 CC CC CC CC CC CC CC CC+ byte_140A36258  db <span class="number">0</span>Eh dup(<span class="number">0</span>CCh)</span><br></pre></td></tr></table></figure>


</li>
<li><p>å‡½æ•°é¦–å­—èŠ‚ <code>0x2E</code> åƒæ˜¯ä¸€ä¸ª Header Flagï¼Œå¹¶ä¸å‚ä¸å‡½æ•°çš„å®é™…åŠŸèƒ½ã€‚å½·ä½›æ˜¯è¡¨æ˜æ­¤å¤„æ˜¯ <code>CmpAppendDllSection</code> å‡½æ•°ã€‚</p>
</li>
</ol>
<p>ç´§æ¥ç€å°†è¯¥å‡½æ•°æ‹·è´è‡³ PGContext v212 å¼€å§‹çš„ä½ç½®ï¼Œå…±å¤åˆ¶äº† <code>0xC4</code> å­—èŠ‚ã€‚</p>
<p>æ³¨æ„ï¼š<code>_OWORD</code> è¡¨ç¤º 16 Bytesã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">_enable();	<span class="comment">// cli</span></span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">505</span>) = v175;</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">647</span>) = v213;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">249</span>) = v4501;</span><br><span class="line">  v323 = (<span class="keyword">signed</span> __int64)(v212_ContextData + <span class="number">128</span>);</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">585</span>) = v4206;</span><br><span class="line">  *(_OWORD *)v212_ContextData = *(_OWORD *)CmpAppendDllSection;</span><br><span class="line">  *((_OWORD *)v212_ContextData + <span class="number">1</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">1</span>);</span><br><span class="line">  *((_OWORD *)v212_ContextData + <span class="number">2</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">2</span>);</span><br><span class="line">  *((_OWORD *)v212_ContextData + <span class="number">3</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">3</span>);</span><br><span class="line">  *((_OWORD *)v212_ContextData + <span class="number">4</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">4</span>);</span><br><span class="line">  *((_OWORD *)v212_ContextData + <span class="number">5</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">5</span>);</span><br><span class="line">  *((_OWORD *)v212_ContextData + <span class="number">6</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">6</span>);  <span class="comment">// 96~192, Total 112 bytes</span></span><br><span class="line">  *(_OWORD *)(v323 - <span class="number">16</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">7</span>);</span><br><span class="line">  *(_OWORD *)v323 = *((_OWORD *)CmpAppendDllSection + <span class="number">8</span>);</span><br><span class="line">  *(_OWORD *)(v323 + <span class="number">16</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">9</span>);</span><br><span class="line">  *(_OWORD *)(v323 + <span class="number">32</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">10</span>);</span><br><span class="line">  *(_OWORD *)(v323 + <span class="number">48</span>) = *((_OWORD *)CmpAppendDllSection + <span class="number">11</span>); <span class="comment">// 176~192, Total 0xC0 bytes</span></span><br><span class="line">  *(_DWORD *)(v323 + <span class="number">64</span>) = *((_DWORD *)CmpAppendDllSection + <span class="number">48</span>); <span class="comment">// 192~196, Total 0xC4 bytes </span></span><br><span class="line">  LODWORD(v323) = v4210;	<span class="comment">// v4210 = v174</span></span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">508</span>) = v4210 + v4191_ToINITKDBGSectionBase_RVA;</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">506</span>) = v323 + v4190_sub_140A0DD10ToINITKDBGSectionBase_RVA;</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">507</span>) = v323 + v4193_RtlLookupFunctionEntryEx_ToINITKDBGSectionBase_RVA;</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">509</span>) = v323 + v4194_sub_140A0E830_ToINITKDBGSectionBase_RVA;</span><br><span class="line">_disable();	<span class="comment">// sti</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šåœ¨åæ±‡ç¼–ä»£ç ä¸­ï¼Œè¿™éƒ¨åˆ†ä»£ç çš„èµ‹å€¼ä½¿ç”¨ <mark class="label danger"> movups</mark> æŒ‡ä»¤ï¼ˆSSE æŒ‡ä»¤ï¼‰ï¼Œè¡¨ç¤ºå¯¹ 16 å­—èŠ‚ï¼ˆ128 Bytesï¼‰ç§»åŠ¨å¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INIT:<span class="number">0000000140</span>A1DA5B                 lea     rax, CmpAppendDllSection</span><br><span class="line">INIT:<span class="number">0000000140</span>A1DA62                 movups  xmm0, xmmword ptr [rax]</span><br><span class="line">INIT:<span class="number">0000000140</span>A1DA65                 movups  xmmword ptr [r14], xmm0</span><br><span class="line">INIT:<span class="number">0000000140</span>A1DA69                 movups  xmm1, xmmword ptr [rax+<span class="number">10</span>h]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h3 id="3-2-é‡è¦å‡½æ•°-API-åœ°å€å¤‡ä»½"><a href="#3-2-é‡è¦å‡½æ•°-API-åœ°å€å¤‡ä»½" class="headerlink" title="3.2 é‡è¦å‡½æ•°(API)åœ°å€å¤‡ä»½"></a>3.2 é‡è¦å‡½æ•°(API)åœ°å€å¤‡ä»½</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">_enable();	<span class="comment">// cli</span></span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">29</span>) = ExAcquireResourceSharedLite; <span class="comment">// 232~240, Total 0xF0 bytes</span></span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">30</span>) = ExAcquireResourceExclusiveLite;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">31</span>) = ExAllocatePoolWithTag;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">32</span>) = ExFreePoolWithTag;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">33</span>) = ExMapHandleToPointer;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">34</span>) = ExQueueWorkItem;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">35</span>) = ExReleaseResourceLite;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">36</span>) = ExUnlockHandleTableEntry;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">37</span>) = ExAcquirePushLockExclusiveEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">38</span>) = ExReleasePushLockExclusiveEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">39</span>) = ExAcquirePushLockSharedEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">40</span>) = ExReleasePushLockSharedEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">41</span>) = KeAcquireInStackQueuedSpinLockAtDpcLevel;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">42</span>) = ExAcquireSpinLockSharedAtDpcLevel;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">43</span>) = KeBugCheckEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">44</span>) = KeDelayExecutionThread;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">45</span>) = KeEnterCriticalRegionThread;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">46</span>) = KeLeaveCriticalRegion;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">47</span>) = KeEnterGuardedRegion;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">48</span>) = KeLeaveGuardedRegion;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">49</span>) = KeReleaseInStackQueuedSpinLockFromDpcLevel;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">50</span>) = ExReleaseSpinLockSharedFromDpcLevel;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">51</span>) = KeRevertToUserGroupAffinityThread;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">52</span>) = KeProcessorGroupAffinity;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">53</span>) = KeInitializeEnumerationContext;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">54</span>) = KeEnumerateNextProcessor;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">55</span>) = KeCountSetBitsAffinityEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">56</span>) = KeQueryAffinityProcess;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">57</span>) = KeQueryAffinityThread;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">58</span>) = KeSetSystemGroupAffinityThread;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">59</span>) = KeSetCoalescableTimer;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">63</span>) = RtlImageNtHeader;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">66</span>) = RtlSectionTableFromVirtualAddress;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">64</span>) = RtlLookupFunctionTableEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">65</span>) = RtlPcToFileHeader;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">60</span>) = HalPutDmaAdapter;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">61</span>) = &amp;ObReferenceObjectByName;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">62</span>) = RtlImageDirectoryEntryToData;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">67</span>) = DbgPrint;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">68</span>) = MmAllocateIndependentPages;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">69</span>) = MmFreeIndependentPages;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">70</span>) = MmSetPageProtection;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">76</span>) = RtlLookupFunctionEntry;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">77</span>) = KeAcquireSpinLockRaiseToDpc;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">78</span>) = KeReleaseSpinLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">79</span>) = MmGetSessionById;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">80</span>) = MmGetNextSession;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">81</span>) = MmQuitNextSession;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">82</span>) = MmAttachSession;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">83</span>) = MmDetachSession;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">84</span>) = MmGetSessionIdEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">85</span>) = MmIsSessionAddress;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">86</span>) = MmIsAddressValid;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">87</span>) = MmSessionGetWin32Callouts;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">88</span>) = KeInsertQueueApc;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">89</span>) = KeWaitForSingleObject;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">91</span>) = ExReferenceCallBackBlock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">92</span>) = ExGetCallBackBlockRoutine;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">93</span>) = ExDereferenceCallBackBlock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">94</span>) = sub_1403DA4F0;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">95</span>) = PspEnumerateCallback;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">96</span>) = CmpEnumerateCallback;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">97</span>) = DbgEnumerateCallback;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">98</span>) = ExpEnumerateCallback;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">99</span>) = ExpGetNextCallback;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">100</span>) = xHalTimerWatchdogStop;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">101</span>) = KiSchedulerApcTerminate;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">102</span>) = KiSchedulerApc;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">103</span>) = xHalTimerWatchdogStop;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">104</span>) = sub_1403DB560;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">105</span>) = MmAllocatePagesForMdlEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">106</span>) = MmAllocateMappingAddress;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">107</span>) = MmMapLockedPagesWithReservedMapping;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">108</span>) = MmUnmapReservedMapping;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">109</span>) = sub_1403E7C30;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">110</span>) = sub_1403E7CA0;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">111</span>) = MmAcquireLoadLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">112</span>) = MmReleaseLoadLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">113</span>) = KeEnumerateQueueApc;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">114</span>) = KeIsApcRunningThread;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">115</span>) = sub_1403DB430;</span><br><span class="line">  v324 = (__int64)v5121;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">116</span>) = PsAcquireProcessExitSynchronization;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">117</span>) = ObDereferenceProcessHandleTable;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">118</span>) = PsGetNextProcess;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">119</span>) = PsQuitNextProcessThread;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">120</span>) = PsGetNextProcessEx;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">121</span>) = MmIsSessionLeaderProcess;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">122</span>) = PsInvokeWin32Callout;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">123</span>) = MmEnumerateAddressSpaceAndReferenceImages;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">124</span>) = PsGetProcessProtection;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">125</span>) = PsGetProcessSignatureLevel;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">126</span>) = PsGetProcessSectionBaseAddress;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">127</span>) = SeCompareSigningLevels;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">133</span>) = RtlIsMultiSessionSku;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">134</span>) = KiEnumerateCallback;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">135</span>) = KeStackAttachProcess;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">136</span>) = KeUnstackDetachProcess;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">137</span>) = KeIpiGenericCall;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">138</span>) = sub_1403E7A80;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">139</span>) = MmGetPhysicalAddress;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">140</span>) = MmUnlockPages;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">128</span>) = KeComputeSha256;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">129</span>) = KeComputeParallelSha256;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">130</span>) = KeSetEvent;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">141</span>) = VslVerifyPage;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">144</span>) = PsLookupProcessByProcessId;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">145</span>) = PsGetProcessId;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">146</span>) = MmCheckProcessShadow;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">147</span>) = MmGetImageRetpolineCodePage;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">300</span>) = &amp;qword_140C12EC0;</span><br><span class="line">  <span class="keyword">if</span> ( v324 )</span><br><span class="line">    *((_QWORD *)v212_ContextData + <span class="number">90</span>) = *(_QWORD *)(v324 + <span class="number">8</span>);</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">131</span>) = RtlpConvertFunctionEntry;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">132</span>) = RtlpLookupPrimaryFunctionEntry;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">142</span>) = KiGetInterruptObjectAddress;</span><br><span class="line">_disable();	<span class="comment">// sti</span></span><br><span class="line">  <span class="keyword">if</span> ( !(_BYTE)KdDebuggerNotPresent )	<span class="comment">// Anti Debug</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      ;</span><br><span class="line">  &#125;</span><br><span class="line">_enable();</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">599</span>) = v175;</span><br><span class="line">_disable();</span><br><span class="line">...</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">612</span>) ^= (*((_DWORD *)v212_ContextData + <span class="number">612</span>) ^ <span class="number">0x1C00</span>) &amp; <span class="number">0x7C00</span>;</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">596</span>) = dword_140C12E80++;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">256</span>) = <span class="number">0</span>i64;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">294</span>) = VfExcludeSections;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">295</span>) = *(&amp;VfExcludeSections + <span class="number">1</span>);</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">296</span>) = off_140C0EFE0;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">297</span>) = *(&amp;off_140C0EFE0 + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h3 id="3-3-å…¨å±€å˜é‡åŠæŒ‡é’ˆ"><a href="#3-3-å…¨å±€å˜é‡åŠæŒ‡é’ˆ" class="headerlink" title="3.3 å…¨å±€å˜é‡åŠæŒ‡é’ˆ"></a>3.3 å…¨å±€å˜é‡åŠæŒ‡é’ˆ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">_enable();</span><br><span class="line">  *((_DWORD *)v212_ContextData + <span class="number">523</span>) = <span class="number">0x140000</span> / v5120;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">152</span>) = &amp;qword_140C0F140;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">153</span>) = &amp;qword_140C12EA8;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">154</span>) = &amp;qword_140C12EB0;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">155</span>) = &amp;qword_140C12EB8;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">156</span>) = PsInitialSystemProcess;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">157</span>) = KiWaitAlways;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">158</span>) = &amp;KiEntropyTimingRoutine;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">159</span>) = &amp;KiProcessListHead;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">160</span>) = &amp;KiProcessListLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">161</span>) = ObpTypeObjectType;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">162</span>) = IoDriverObjectType;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">163</span>) = PsProcessType;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">164</span>) = &amp;PsActiveProcessHead;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">165</span>) = &amp;PsInvertedFunctionTable;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">166</span>) = &amp;PsLoadedModuleList;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">167</span>) = &amp;PsLoadedModuleResource;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">168</span>) = &amp;PsLoadedModuleSpinLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">169</span>) = &amp;PspActiveProcessLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">170</span>) = &amp;PspCidTable;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">171</span>) = &amp;ExpUuidLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">172</span>) = &amp;AlpcpPortListLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">173</span>) = &amp;KeServiceDescriptorTable;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">174</span>) = &amp;KeServiceDescriptorTableShadow;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">175</span>) = &amp;KeServiceDescriptorTableFilter;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">176</span>) = &amp;VfThunksExtended;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">177</span>) = &amp;PsWin32CallBack;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">178</span>) = &amp;qword_140C12E88;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">179</span>) = &amp;KiTableInformation;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">180</span>) = &amp;HandleTableListHead;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">181</span>) = &amp;HandleTableListLock;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">182</span>) = ObpKernelHandleTable;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">183</span>) = <span class="number">-9345848836096</span>i64; <span class="comment">// 0xFFFFF780000000C4</span></span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">184</span>) = KiWaitNever;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">185</span>) = &amp;SeProtectedMapping;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">187</span>) = &amp;KiStackProtectNotifyEvent;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">188</span>) = MmPteBase;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">189</span>) = PsNtosImageBase;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">190</span>) = PsHalImageBase;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">191</span>) = &amp;KeNumberProcessors_0;</span><br><span class="line">  v333 = &amp;_ti_a;</span><br><span class="line">  v334 = <span class="number">2</span>i64;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">192</span>) = &amp;::Src_INITKDBG_VirtualAddress;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">193</span>) = &amp;qword_140CFC3D0;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">194</span>) = RtlpInvertedFunctionTable;</span><br><span class="line">  *((_QWORD *)v212_ContextData + <span class="number">186</span>) = KiInterruptThunk;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™äº›æ•°æ®å¤§æ¦‚è¡¨è¿°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PG_CONTEXT</span>&#123;</span></span><br><span class="line">	BYTE CmpAppendDllSection[<span class="number">0xC4</span>]; <span class="comment">// 0x0000 - 0x00C4</span></span><br><span class="line">	BYTE UnknownData[<span class="number">0x24</span>]; 	<span class="comment">// 0x00C4 - 0x00E8</span></span><br><span class="line">	PVOID ExAcquireResourceSharedLite;</span><br><span class="line">	PVOID ExAcquireResourceExclusiveLite;</span><br><span class="line">	PVOID ExAllocatePoolWithTag;</span><br><span class="line">	PVOID ExFreePoolWithTag;</span><br><span class="line">	PVOID ExMapHandleToPointer;</span><br><span class="line">	....</span><br><span class="line">&#125;PG_CONTEXT, *PPG_CONTEXT;</span><br></pre></td></tr></table></figure>





<h3 id="3-4-å…¶ä»–æ•°æ®å¤‡ä»½"><a href="#3-4-å…¶ä»–æ•°æ®å¤‡ä»½" class="headerlink" title="3.4 å…¶ä»–æ•°æ®å¤‡ä»½"></a>3.4 å…¶ä»–æ•°æ®å¤‡ä»½</h3><p>0xB6 &#x3D; 182</p>
<p>å›½ç§‘é‡å­</p>
<p>ç»ˆäºå‡ºç°äº†ä¸PatchGuardContextæœ‰ç›´æ¥å…³è”çš„é€»è¾‘ã€‚è¿™é‡Œè¢«å‘½åä¸ºFixPgContextSizeçš„åŸå› æ˜¯,å®é™…ä¸Šæ± æ²¡æœ‰åˆ†é…åˆ°ç›¸åº”çš„å¤§å°ã€‚å› ä¸ºåŒ…æ‹¬PgContextå¤§å°çš„å…¶ä»–æ•°æ®ä¹ŸåŒ…æ‹¬åœ¨å†…ã€‚</p>
<p>åœ¨è¿™é‡Œä»¥ç°åœ¨ä¸ºåŸºå‡†ï¼ŒPgContext å¤§å°ä¸º 0xAA0ï¼Œå¯ä»¥é€šè¿‡å¾ˆå¤šæ–‡ä»¶ç¡®è®¤ã€‚</p>
<p>ä¾‹å¦‚,ç¡®è®¤ KiMarkBugCheckRegions ç¨‹åºçš„æœ€ä¸‹ç«¯å¦‚ä¸‹ã€‚</p>
<p>åç»­å·¥ä½œï¼š</p>
<p>æ¥ä¸‹æ¥åˆ†æå›è°ƒ<strong>b -</strong> <strong>Â«</strong> <strong>TV</strong> <strong>Â»</strong> <strong>å›è°ƒï¼Œç¬¬ä¸€æ¬¡å°†</strong> <strong>PatchGuard</strong> <strong>é“¾æ¥åˆ°</strong> <strong>mssecflt.sys</strong><a target="_blank" rel="noopener" href="https://github.com/0xcpu/ExecutiveCallbackObjects/tree/master/542875F90F9B47F497B64BA219CACF69">https://github.com/0xcpu/ExecutiveCallbackObjects/tree/master/542875F90F9B47F497B64BA219CACF69</a></p>
<p>ç„¶åå‚è€ƒ<a target="_blank" rel="noopener" href="https://shhoya.github.io/windows_pginit2.html">PatchGuard Initialize -2-</a>ã€<a target="_blank" rel="noopener" href="https://shhoya.github.io/windows_pgtravel.html">PatchGuard Initialization Analysis -1-</a>åˆ†æPatchGuardçš„åˆå§‹åŒ–ã€‚</p>
<p>ç„¶ååˆ†æTETRANE-è§¦å‘æ£€æŸ¥</p>
<p>INIT:0000000140A1DA5B                 lea     rax, CmpAppendDllSection<br>INIT:0000000140A1DA62                 movups  xmm0, xmmword ptr [rax]</p>
<!-- flag of hidden posts -->
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    èµèµ
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat å¾®ä¿¡">
        <span>å¾®ä¿¡</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat æ”¯ä»˜å®">
        <span>æ”¯ä»˜å®</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://directoree.github.io/post/Kernel-Patch-Protection2/" title="å†…æ ¸è¡¥ä¸ä¿æŠ¤ï¼ˆäºŒï¼‰åˆå§‹åŒ–">https://directoree.github.io/post/Kernel-Patch-Protection2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Windows%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> Windowså†…æ ¸</a>
              <a href="/tags/x64-PG/" rel="tag"><i class="fa fa-tag"></i> x64 PG</a>
          </div>

        

    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">30:51</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>








<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script data-pjax>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '70px',
  right: 'unset',
  left: '16px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#222',
  buttonColorLight: '#222',
  saveInCookies: false,
  label: '',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  if (toggleButtons && toggleButtons.length > 0) {
    for (i = 0; i < toggleButtons.length; i++) {
      toggleButtons[i].classList.add("darkmode-toggle--white");
    }
  }
}
</script>

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"å¿«æ¥å‹¾æ­æˆ‘å‘€ğŸ¶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/Kernel-Patch-Protection2/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
