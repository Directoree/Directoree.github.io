<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ʕ •̀ o •́ ʔ">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows XP APC（二）">
<meta property="og:url" content="https://directoree.github.io/post/WinXP-APC2/index.html">
<meta property="og:site_name" content="Catecat">
<meta property="og:description" content="ʕ •̀ o •́ ʔ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/06/26/EiufXmxktJYCPq7.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/27/Q5nAgaFuTG3WIEZ.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/27/Pv79dtf5kxi3sCT.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/11/dSNnXgorJvMw4Bj.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/11/y7tn4f6AN9bTUYr.png">
<meta property="article:published_time" content="2022-06-26T06:13:29.000Z">
<meta property="article:modified_time" content="2022-07-22T15:20:54.430Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="WinXP内核">
<meta property="article:tag" content="APC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/06/26/EiufXmxktJYCPq7.png">


<link rel="canonical" href="https://directoree.github.io/post/WinXP-APC2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Windows XP APC（二） | Catecat</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Catecat</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-空调房">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>空调房</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-APC%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C"><span class="nav-text">1 APC函数执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-APC%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="nav-text">1.1 APC函数执行的条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%86%85%E6%A0%B8APC%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">1.2 内核APC执行过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%94%A8%E6%88%B7APC%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">1.3 用户APC执行过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-KiDeliverApc"><span class="nav-text">2 KiDeliverApc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-KeTestAlertThread"><span class="nav-text">3 KeTestAlertThread</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-CONTEXT"><span class="nav-text">4 _CONTEXT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-KiInitializeUserApc"><span class="nav-text">5 KiInitializeUserApc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-KeContextFromKframes"><span class="nav-text">6 KeContextFromKframes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KiUserApcDispatcher"><span class="nav-text">KiUserApcDispatcher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#R3-ZwContinue"><span class="nav-text">R3 ZwContinue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#R0-NtContinue"><span class="nav-text">R0 NtContinue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KiSwapThread"><span class="nav-text">KiSwapThread</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KiFastCallEntry"><span class="nav-text">KiFastCallEntry</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%80%BB%E7%BB%93"><span class="nav-text">7 总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%85%B3%E4%BA%8E%E7%94%A8%E6%88%B7APC%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="nav-text">7.1 关于用户APC的执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E5%A4%9A%E4%B8%AA%E7%94%A8%E6%88%B7APC%E5%9C%A8R0-R3%E6%9D%A5%E5%9B%9E%E5%BE%AA%E7%8E%AF%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">7.2 多个用户APC在R0-R3来回循环执行过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-3%E7%8E%AF%E7%9A%84APC%E6%B3%A8%E5%85%A5"><span class="nav-text">7.3 3环的APC注入</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">143</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">81</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/WinXP-APC2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Catecat">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Windows XP APC（二）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-26 14:13:29" itemprop="dateCreated datePublished" datetime="2022-06-26T14:13:29+08:00">2022-06-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-07-22 23:20:54" itemprop="dateModified" datetime="2022-07-22T23:20:54+08:00">2022-07-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/APC/" itemprop="url" rel="index"><span itemprop="name">APC</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/APC/Windows%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">Windows内核</span></a>
        </span>
    </span>

  
    <span id="/post/WinXP-APC2/" class="post-meta-item leancloud_visitors" data-flag-title="Windows XP APC（二）" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/WinXP-APC2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/WinXP-APC2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>79k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:12</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><a target="_blank" rel="noopener" href="https://unicode-table.com/cn/kaomoji/">ʕ •̀ o •́ ʔ </a></p>
<span id="more"></span>

<h2 id="1-APC函数执行"><a href="#1-APC函数执行" class="headerlink" title="1 APC函数执行"></a>1 APC函数执行</h2><p>上一篇文章《<a href="https://directoree.github.io/post/WinXP-APC/">Windows XP APC（一）</a>》已经将APC内核对象插入到目标线程的APC队列讲解完成了，接下来讲解APC函数在目标线程中是如何执行的。</p>
<p>一个线程如果要执行挂在APC队列的APC函数，最先会调用函数<mark class="label danger">KiDeliverApc</mark>去处理后续的流程。</p>
<h3 id="1-1-APC函数执行的条件"><a href="#1-1-APC函数执行的条件" class="headerlink" title="1.1 APC函数执行的条件"></a>1.1 APC函数执行的条件</h3><div class="note success"><p>哪些情况下线程会执行APC函数：</p>
<ol>
<li><mark class="label warning">线程切换</mark>。线程切换后（<code>KiSwapThread</code>），新线程执行时会调用<code>KiDeliverApc</code>。</li>
<li><mark class="label primary">系统调用、中断、异常</mark>。会执行函数<code>_KiServiceExit</code>，然后调用<code>KiDeliverApc</code>。</li>
</ol>
</div>

<div class="note primary"><p><strong>总结一句话</strong>：凡是会调用<code>KiDeliverApc</code>函数的点，都有机会执行APC函数。</p>
</div>

<p>函数<code>_KiServiceExit</code>是CPU从系统调用、中断或异常处理返回用户空间时的必经之路。</p>
<p>在函数<code>KiDeliverApc</code>按一下<code>X</code>查看一下交叉引用（<code>ntkrpamp.exe</code>2-9-9-12分页多核）：</p>
<p><img data-src="https://s2.loli.net/2022/06/26/EiufXmxktJYCPq7.png" alt="2.png"></p>
<p>实际上调用<code>KiDeliverApc</code>的函数有以上那些。</p>
<p>然后看一下《Windows内核原理与实现5.2 P335》中，在WRK版本里除了上面提到的<strong>线程切换、系统调用、中断、异常</strong>，还有一种情况是：</p>
<blockquote>
<p>当内核代码离开一个临界区或者守护区（调用<code>KeLeaveGuardedRegion</code>或<code>KeLeaveCriticalRegion</code>）时，通过<code>KiCheckForKernelApcDelivery</code>函数直接调用<code>KiDeliverApc</code>，或者调用<code>KiRequestSoftwareInterrupt</code>函数请求一个<code>APC_LEVEL</code>的软件中断。这是因为，当线程进入临界区或守护区时，普通内核模式APC或特殊内核模式APC被禁止了，所以，当离开时，<code>KiCheckForKernelApcDelivery</code>函数被调用，以便及时地交付内核模式APC。</p>
</blockquote>
<h3 id="1-2-内核APC执行过程"><a href="#1-2-内核APC执行过程" class="headerlink" title="1.2 内核APC执行过程"></a>1.2 内核APC执行过程</h3><p>跟着海哥追了一下<code>SwapContext</code>最后的代码，如果切换后的线程NextThread的<code>KernelApcPending != 0</code>，则会返回<code>eax = 1</code>，然后一直返回到函数<code>KiSwapThread</code>中，紧接着该函数就调用函数<code>KiDeliverApc</code>去线程的APC。</p>
<p><code>KiDeliverApc</code>函数执行内核APC流程：<br>1）判断第一个链表是否为空<br>2）判断KTHREAD.ApcState.KernelApcInProgress是否为1<br>3）判断是否禁用内核APC(KTHREAD.KernelApcDisable是否为1)<br>4）将当前KAPC结构体从链表中摘除<br>5）执行KAPC.KernelRoutine指定的函数 释放KAPC结构体占用的空间<br>6）将KTHREAD.ApcState.KernelApcInProgress设置为1 标识正在执行内核APC<br>7）执行真正的内核APC函数(KAPC.NormalRoutine)<br>8）执行完毕 将KernelApcInProgress改为0<br>9）循环</p>
<p>实际执行过程会在后面的<code>KiDeliverApc</code>函数逆向分析时候具体解释。</p>
<p><strong>总结：</strong><br>1）内核APC在线程切换的时候就会执行，这也就意味着，只要插入内核APC很快就会执行。<br>2）在执行用户APC之前会先执行内核APC。<br>3）内核APC在内核空间执行，不需要换栈，一个循环全部执行完毕。</p>
<h3 id="1-3-用户APC执行过程"><a href="#1-3-用户APC执行过程" class="headerlink" title="1.3 用户APC执行过程"></a>1.3 用户APC执行过程</h3><p>处理用户APC要比内核APC复杂的多，因为用户APC函数要在用户空间执行的，这里涉及到大量换栈的操作：</p>
<ol>
<li><p>当线程从用户层进入内核层时，要保留原来的运行环境，比如各种寄存器，栈的位置等等  (<code>_Trap_Frame</code>)，然后切换成内核的堆栈，如果正常返回，恢复堆栈环境即可。</p>
</li>
<li><p>但如果有用户APC要执行的话，就意味着线程要提前返回到用户空间去执行，而且返回的位置不是线程进入内核时的位置，而是返回到其他的位置，每处理一个用户APC都会涉及到：内核 –&gt; 用户空间 –&gt; 再回到内核空间。</p>
<p>​</p>
</li>
</ol>
<p><code>KiDeliverApc</code>函数分析：<br>1）判断用户APC链表是否为空<br>2）判断第一个参数是为1<br>3）判断ApcState.UserApcPending是否为1<br>4）将ApcState.UserApcPending设置为0<br>5）链表操作 将当前APC从用户队列中拆除<br>6）调用函数(KAPC.KernelRoutine)释放KAPC结构体内存空间<br>7）调用<code>KiInitializeUserApc</code>函数</p>
<ol>
<li><p><code>KiInitializeUserApc</code>函数分析：备份<code>CONTEXT</code>。</p>
<p>线程进0环时，原来3环的运行环境（寄存器栈顶等）保存到0环的一块内存<code>_Trap_Frame</code>结构体中，如果要提前返回3环去处理用户APC，就必须要修改<code>_Trap_Frame</code>结构体，但是又要保证不影响正常调用时线程返回到原来3环的地方，所以需要对<code>_Trap_Frame</code>的值进行备份：</p>
<ul>
<li>比如：进0环时的位置存储在EIP中，现在要提前返回，而且返回的并不是原来的位置，那就意味着必须要修改EIP为新的返回位置。还有堆栈ESP也要修改为处理APC需要的堆栈。那原来的值怎么办呢？处理完APC后该如何返回原来的位置呢？</li>
<li>函数<code>KiInitializeUserApc</code>要做的第一件事就是备份：<mark class="label danger">将原来_Trap_Frame的值备份到一个新的结构体中（CONTEXT）</mark>，这个功能由其子函数<code>KeContextFromKframes</code>来完成。</li>
</ul>
</li>
<li><p><code>KiInitializeUserApc</code>函数分析：线程0环与3环堆栈切换、准备用户层执行环境。</p>
<ul>
<li><p>堆栈示意图如下</p>
<p><img data-src="https://s2.loli.net/2022/06/27/Q5nAgaFuTG3WIEZ.png" alt="3.png"></p>
</li>
<li><p>准备用户层执行环境</p>
<p><img data-src="https://s2.loli.net/2022/06/27/Pv79dtf5kxi3sCT.png" alt="4.png"></p>
</li>
</ul>
</li>
<li><p><code>ntdll.KiUserApcDispatcher</code>函数分析：</p>
<p>1、当用户在3环调用<code>QueueUserAPC</code>函数来插入APC时，不需要提供<code>NormalRoutine</code>，这个参数是在<code>QueueUserAPC</code>内部指定的：<br><code>BaseDispatchAPC</code>。<br>2、<code>ZwContinue</code>函数的意义：</p>
<ul>
<li>返回内核，如果还有用户APC，重复上面的执行过程。</li>
<li>如果没有需要执行的用户APC，会将CONTEXT赋值给Trap_Frame结构体。就像从来没有修改过一样。ZwContinue后面的代码不会执行，线程从哪里进0环仍然会从哪里回去。</li>
</ul>
</li>
</ol>
<h2 id="2-KiDeliverApc"><a href="#2-KiDeliverApc" class="headerlink" title="2 KiDeliverApc"></a>2 KiDeliverApc</h2><p><code>KiDeliverApc</code>：This function is called from the APC interrupt code and when one or more of the APC pending flags are set at system exit and the previous IRQL is zero. All <strong>special kernel APC’s are delivered first, followed by normal kernel APC’s if one is not already in progress, and finally if the user APC queue is not empty, the user APC pending flag is set, and the previous mode is user, then a user APC is delivered</strong>. On entry to this routine IRQL is set to APC_LEVEL. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID __stdcall <span class="title">KiDeliverApc</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KPROCESSOR_MODE PreviousMode,	<span class="comment">//调用函数的先前模式</span></span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKEXCEPTION_FRAME ExceptionFrame,<span class="comment">//指向异常帧，在 NT386 模式下该指针为 NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKTRAP_FRAME TrapFrame		<span class="comment">//_Trap_Frame</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>

<p>函数逆向分析如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID __stdcall <span class="title">KiDeliverApc</span><span class="params">(PreviousMode, ExceptionFrame, TrapFrame)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(TrapFrame != <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(TrapFrame-&gt;eip &gt;= (ULONG)&amp;ExpInterlockedPopEntrySListResume &amp;&amp; </span><br><span class="line">     TrapFrame-&gt;eip &lt;= (ULONG)&amp;ExpInterlockedPopEntrySListEnd)</span><br><span class="line">  &#123;</span><br><span class="line">    TrapFrame-&gt;eip = (ULONG)&amp;ExpInterlockedPopEntrySListResume;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Old_TrapFrame = CurrentThread-&gt;TrapFrame;</span><br><span class="line">Old_Process = CurrentThread-&gt;ApcState-&gt;Process;</span><br><span class="line"></span><br><span class="line">CurrentThread-&gt;TrapFrame = TrapFrame;</span><br><span class="line">CurrentThread-&gt;ApcState-&gt;KernelApcPending = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">Thread-&gt;ApcState.KernelApcPending = FALSE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//内核APC不为空</span></span><br><span class="line"><span class="keyword">while</span>(&amp;CurrentThread-&gt;ApcState-&gt;ApcListHead[<span class="number">0</span>] != CurrentThread-&gt;ApcState-&gt;ApcListHead[<span class="number">0</span>]-&gt;Flink)</span><br><span class="line">&#123;</span><br><span class="line">  NextEntry = CurrentThread-&gt;ApcState-&gt;ApcListHead[<span class="number">0</span>]-&gt;Flink;</span><br><span class="line">  Apc = (KAPC)(KAPC-&gt;ApcListEntry - <span class="number">0xC</span>);</span><br><span class="line">  KernelRoutine = Apc-&gt;KernelRoutine;</span><br><span class="line">  NormalRoutine = Apc-&gt;NormalRoutine;</span><br><span class="line">  NormalContext = Apc-&gt;NormalContext;</span><br><span class="line">  SystemArgument1 = Apc-&gt;SystemArgument1;</span><br><span class="line">  SystemArgument2 = Apc-&gt;SystemArgument2;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//普通内核APC函数</span></span><br><span class="line">  <span class="keyword">if</span>(Apc-&gt;NormalRoutine != <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(CurrentThread.ApcState.KernelApcInProgress == <span class="number">0</span> &amp;&amp; CurrentThread.KernelApcDisable == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//将当前APC对象从内核APC队列里摘除</span></span><br><span class="line">      <span class="comment">//将CurrentThread-&gt;ApcState-&gt;ApcListHead[0]-&gt;Flink摘除</span></span><br><span class="line">      ecx = NextEntry-&gt;Flink;</span><br><span class="line">      eax = NextEntry-&gt;Blink;</span><br><span class="line">      NextEntry-&gt;Blink-&gt;Flink = NextEntry-&gt;Flink;</span><br><span class="line">      NextEntry-&gt;Flink-&gt;Blink = NextEntry-&gt;Blink;</span><br><span class="line">      </span><br><span class="line">      Apc.Inserted = <span class="number">0</span>;</span><br><span class="line">      (KernelRoutine)(Apc,</span><br><span class="line">                      &amp;NormalRoutine,</span><br><span class="line">                      &amp;NormalContext,</span><br><span class="line">                      &amp;SystemArgument1,</span><br><span class="line">                      &amp;SystemArgument2);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(Apc-&gt;NormalRoutine != <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        CurrentThread-&gt;ApcState-&gt;KernelApcInProgress = <span class="number">1</span>;</span><br><span class="line">        KfLowerIrql(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        NormalRoutine(NormalContext, SystemArgument1, SystemArgument2);</span><br><span class="line">        </span><br><span class="line">        KfRaiseIrql(<span class="number">1</span>);	<span class="comment">//APC_LEVEL</span></span><br><span class="line">      &#125;	<span class="comment">//00428896</span></span><br><span class="line">      CurrentThread-&gt;ApcState-&gt;KernelApcInProgress = <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>  <span class="comment">//00428967,CurrentThread.ApcState.KernelApcInProgress != 0 || CurrentThread.KernelApcDisable != 0</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">goto</span> BugCheckAndReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//特殊APC,KAPC-&gt;NormalRoutine == 0,00428818</span></span><br><span class="line">  &#125;<span class="keyword">else</span>	</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//将当前APC对象从内核APC队列里摘除</span></span><br><span class="line">    <span class="comment">//将CurrentThread-&gt;ApcState-&gt;ApcListHead[0]-&gt;Flink摘除</span></span><br><span class="line">    ecx = NextEntry-&gt;Flink;</span><br><span class="line">    eax = NextEntry-&gt;Blink;</span><br><span class="line">    NextEntry-&gt;Blink-&gt;Flink = NextEntry-&gt;Flink;</span><br><span class="line">    NextEntry-&gt;Flink-&gt;Blink = NextEntry-&gt;Blink;</span><br><span class="line">    </span><br><span class="line">    Apc.Inserted = <span class="number">0</span>;</span><br><span class="line">    (KernelRoutine)(Apc,</span><br><span class="line">                      &amp;NormalRoutine,</span><br><span class="line">                      &amp;NormalContext,</span><br><span class="line">                      &amp;SystemArgument1,</span><br><span class="line">                      &amp;SystemArgument2);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户APC，004288D4,004288E1</span></span><br><span class="line">NextEntry = CurrentThread-&gt;ApcState-&gt;ApcListHead[<span class="number">1</span>]-&gt;Flink;</span><br><span class="line"><span class="keyword">if</span>(&amp;CurrentThread-&gt;ApcState-&gt;ApcListHead[<span class="number">1</span>] != NextEntry &amp;&amp; PreviousMode == <span class="number">1</span> &amp;&amp;</span><br><span class="line">   CurrentThread-&gt;ApcState[UserMode]-&gt;UserApcPending == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//提前声明用户APC队列没有正在等待执行的用户APC</span></span><br><span class="line">  Thread-&gt;ApcState[UserMode].UserApcPending = FALSE;</span><br><span class="line">  </span><br><span class="line">  Apc = (KAPC)(KAPC-&gt;ApcListEntry - <span class="number">0xC</span>);</span><br><span class="line">  KernelRoutine = Apc-&gt;KernelRoutine;</span><br><span class="line">  NormalRoutine = Apc-&gt;NormalRoutine;</span><br><span class="line">  NormalContext = Apc-&gt;NormalContext;</span><br><span class="line">  SystemArgument1 = Apc-&gt;SystemArgument1;</span><br><span class="line">  SystemArgument2 = Apc-&gt;SystemArgument2;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//将当前APC对象从用户APC队列里摘除</span></span><br><span class="line">  ecx = NextEntry-&gt;Flink;</span><br><span class="line">  eax = NextEntry-&gt;Blink;</span><br><span class="line">  NextEntry-&gt;Blink-&gt;Flink = NextEntry-&gt;Flink;</span><br><span class="line">  NextEntry-&gt;Flink-&gt;Blink = NextEntry-&gt;Blink;</span><br><span class="line">  </span><br><span class="line">  Apc-&gt;Inserted = <span class="number">0</span>;</span><br><span class="line">  (KernelRoutine)(Apc,</span><br><span class="line">                      &amp;NormalRoutine,</span><br><span class="line">                      &amp;NormalContext,</span><br><span class="line">                      &amp;SystemArgument1,</span><br><span class="line">                      &amp;SystemArgument2);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(Apc-&gt;NormalRoutine != <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 准备回3环调用 NormalContext</span></span><br><span class="line">    KiInitializeUserApc(ExceptionFrame,</span><br><span class="line">                        TrapFrame,</span><br><span class="line">                        NormalRoutine,		<span class="comment">// 用户APC总入口 BaseDispatchAPC（3环函数）</span></span><br><span class="line">                        NormalContext,		<span class="comment">// 3环APC函数</span></span><br><span class="line">                        SystemArgument1,	<span class="comment">// 3环APC函数的参数</span></span><br><span class="line">                        SystemArgument2);	<span class="comment">// 作用不明，BaseDispatchAPC 里用到了</span></span><br><span class="line">  &#125;<span class="keyword">else</span>	<span class="comment">//0042893F</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//检查该线程是否可以交付另一个用户模式的APC</span></span><br><span class="line">    KeTestAlertThread(UserMode);	<span class="comment">//UserMode == 1</span></span><br><span class="line">    <span class="keyword">goto</span> BugCheckAndReturn;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BugCheckAndReturn:</span><br><span class="line">	<span class="comment">//Check if process was attached during the APC routine</span></span><br><span class="line">	<span class="keyword">if</span>(CurrentThread-&gt;ApcState-&gt;Process != Old_Process) KeBugCheckEx();</span><br><span class="line">	CurrentThread-&gt;TrapFrame = Old_TrapFrame;</span><br><span class="line">	<span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<div class="note warning"><p>函数<code>KiDeliverApc</code>主要功能如下：</p>
<ol>
<li>先将当前线程的<code>TrapFrame</code>和所属进程进行<strong>备份</strong>，然后使用参数中的<code>TrapFrame</code>给当前线程的<code>TrapFrame</code>赋值；</li>
<li><code>KernelApcPending = FALSE</code>提前声明没有待执行的内核APC函数，因为马上会循环全部执行完；</li>
<li><strong>循环检查内核APC队列</strong>，不为空的话，再判断内核APC函数是普通APC还是特殊APC：<ul>
<li><strong>普通APC</strong>：<ul>
<li>如果<code>KernelApcInProgress ==0 &amp;&amp; CurrentThread.KernelApcDisable == 0</code>，将当前APC对象从内核APC队列里摘除。如果前面的条件不满足就去<code>BugCheckAndReturn</code>检查是否需要调用函数<code>KeBugCheckEx</code>去蓝屏；</li>
<li>执行函数<code>Apc-&gt;KernelRoutine</code>；</li>
<li>如果<code>Apc-&gt;NormalRoutine != 0</code>的话（<code>KernelRoutine</code>的执行有可能改变这个指针的值）就先将<code>KernelApcInProgress = TRUE</code>，并将IRQL降为<code>PASSIVE_LEVEL(0)</code>；</li>
<li>执行函数<code>Apc-&gt;NormalRoutine</code>；</li>
<li>将IRQL升为<code>APC_LEVEL(1)</code>。</li>
<li>设置<code>KernelApcInProgress = FALSE</code>。</li>
</ul>
</li>
<li><strong>特殊APC</strong>：<ul>
<li>将当前APC对象从内核APC队列里摘除；</li>
<li>执行函数<code>Apc-&gt;KernelRoutine</code>；</li>
</ul>
</li>
</ul>
</li>
<li>如果<strong>用户APC队列</strong>不为空，并且<code>UserApcPending == 1</code>，就会试图执行用户APC。<ul>
<li><code>UserApcPending = FALSE</code>，提前声明用户APC队列没有正在等待执行的用户APC，因为一次只会执行一次（没有循环）；</li>
<li>将当前APC对象从用户APC队列里摘除；</li>
<li>执行函数<code>Apc-&gt;KernelRoutine</code>；</li>
<li>判断<code>Apc-&gt;NormalRoutine</code>是否为<code>0</code>（<code>KernelRoutine</code>的执行有可能改变这个指针的值）：<ul>
<li><code>Apc-&gt;NormalRoutine != 0</code>，调用<code>KiInitializeUserApc</code>函数准备回3环调用<code>Apc-&gt;NormalContext</code>；</li>
<li><code>Apc-&gt;NormalRoutine == 0</code>，调用<code>KeTestAlertThread</code>函数（<a target="_blank" rel="noopener" href="https://blog.csdn.net/xiangbaohui/article/details/104897855">没有用户层的回调函数，那么自己alert，执行后面的APC</a>）检查该线程是否可以交付另一个用户模式的APC。</li>
</ul>
</li>
</ul>
</li>
<li><strong>恢复TrapFrame</strong>。用之前备份的<code>TrapFrame</code>给当前线程的<code>TrapFrame</code>赋值。</li>
</ol>
</div>

<div class="note success"><p>需要注意一下几点：</p>
<ul>
<li>执行内核<code>NormalRoutine</code>时才会<code>KernelApcInProgress = 1</code>，执行<code>KernelRoutine</code>时<code>KernelApcInProgress</code>不会置1。</li>
<li>执行内核<code>NormalRoutine</code>IRQL是<code>0</code>。</li>
<li>用函数<code>KiInitializeUserApc</code>去准备回3环调用<code>Apc-&gt;NormalContext</code>时并不会将IRQL降为<code>0</code>。</li>
<li>每次进入函数<code>KiDeliverApc</code>，会将当前线程的所有内核APC函数全部循环执行了，但是只会执行挂在用户APC队列的第一个用户APC函数，处理用户APC函数并没有循环。《Windows内核情景分析5.8 P373》</li>
</ul>
</div>

<p>APC整个执行过程在《Windows内核情景分析5.8》都有函数分析。</p>
<p>源代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">KiDeliverApc</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KPROCESSOR_MODE PreviousMode,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKEXCEPTION_FRAME ExceptionFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKTRAP_FRAME TrapFrame</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="function"><span class="comment">Routine Description:</span></span></span><br><span class="line"><span class="function"><span class="comment">    This function is called from the APC interrupt code and when one or</span></span></span><br><span class="line"><span class="function"><span class="comment">    more of the APC pending flags are set at system exit and the previous</span></span></span><br><span class="line"><span class="function"><span class="comment">    IRQL is zero. All special kernel APC&#x27;s are delivered first, followed</span></span></span><br><span class="line"><span class="function"><span class="comment">    by normal kernel APC&#x27;s if one is not already in progress, and finally</span></span></span><br><span class="line"><span class="function"><span class="comment">    if the user APC queue is not empty, the user APC pending flag is set,</span></span></span><br><span class="line"><span class="function"><span class="comment">    and the previous mode is user, then a user APC is delivered. On entry</span></span></span><br><span class="line"><span class="function"><span class="comment">    to this routine IRQL is set to APC_LEVEL.</span></span></span><br><span class="line"><span class="function"><span class="comment">    </span></span></span><br><span class="line"><span class="function"><span class="comment">    N.B. The exception frame and trap frame addresses are only guaranteed</span></span></span><br><span class="line"><span class="function"><span class="comment">         to be valid if, and only if, the previous mode is user.</span></span></span><br><span class="line"><span class="function"><span class="comment">Arguments:</span></span></span><br><span class="line"><span class="function"><span class="comment">    PreviousMode - Supplies the previous processor mode.</span></span></span><br><span class="line"><span class="function"><span class="comment">    </span></span></span><br><span class="line"><span class="function"><span class="comment">    指向异常帧，在 NT386 模式下该指针为 NULL</span></span></span><br><span class="line"><span class="function"><span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span></span></span><br><span class="line"><span class="function"><span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span></span></span><br><span class="line"><span class="function"><span class="comment">Return Value: None.</span></span></span><br><span class="line"><span class="function"><span class="comment">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    PKAPC Apc;</span><br><span class="line">    PKKERNEL_ROUTINE KernelRoutine;</span><br><span class="line">    KLOCK_QUEUE_HANDLE LockHandle;</span><br><span class="line">    PLIST_ENTRY NextEntry;</span><br><span class="line">    ULONG64 NewPC;</span><br><span class="line">    PVOID NormalContext;</span><br><span class="line">    PKNORMAL_ROUTINE NormalRoutine;</span><br><span class="line">    ULONG64 PC; </span><br><span class="line">    PKPROCESS Process;</span><br><span class="line">    PVOID SystemArgument1;</span><br><span class="line">    PVOID SystemArgument2;</span><br><span class="line">    PKTHREAD Thread;</span><br><span class="line">    PKTRAP_FRAME OldTrapFrame;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If the thread was interrupted in the middle of the SLIST pop code,</span></span><br><span class="line">    <span class="comment">// then back up the PC to the start of the SLIST pop. </span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TrapFrame != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_AMD64_)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((TrapFrame-&gt;Rip &gt;= (ULONG64)&amp;ExpInterlockedPopEntrySListResume) &amp;&amp;</span><br><span class="line">            (TrapFrame-&gt;Rip &lt;= (ULONG64)&amp;ExpInterlockedPopEntrySListEnd)) &#123;</span><br><span class="line"></span><br><span class="line">            TrapFrame-&gt;Rip = (ULONG64)&amp;ExpInterlockedPopEntrySListResume;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_IA64_)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Add the slot number so we do the right thing for the instruction</span></span><br><span class="line">        <span class="comment">// group containing the interlocked compare exchange.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        PC = TrapFrame-&gt;StIIP + ((TrapFrame-&gt;StIPSR &amp; IPSR_RI_MASK) &gt;&gt; PSR_RI);</span><br><span class="line">        NewPC = (ULONG64)((PPLABEL_DESCRIPTOR)ExpInterlockedPopEntrySListResume)-&gt;EntryPoint;</span><br><span class="line">        <span class="keyword">if</span> ((PC &gt;= NewPC) &amp;&amp;</span><br><span class="line">            (PC &lt;= (ULONG64)((PPLABEL_DESCRIPTOR)ExpInterlockedPopEntrySListEnd)-&gt;EntryPoint)) &#123;</span><br><span class="line"></span><br><span class="line">            TrapFrame-&gt;StIIP = NewPC;</span><br><span class="line">            TrapFrame-&gt;StIPSR &amp;= ~IPSR_RI_MASK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(_X86_)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((TrapFrame-&gt;Eip &gt;= (ULONG)&amp;ExpInterlockedPopEntrySListResume) &amp;&amp;</span><br><span class="line">            (TrapFrame-&gt;Eip &lt;= (ULONG)&amp;ExpInterlockedPopEntrySListEnd)) &#123;</span><br><span class="line"></span><br><span class="line">            TrapFrame-&gt;Eip = (ULONG)&amp;ExpInterlockedPopEntrySListResume;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;No Target Architecture&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Raise IRQL to dispatcher level and lock the APC queue.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取当前线程</span></span><br><span class="line">    Thread = KeGetCurrentThread();</span><br><span class="line"></span><br><span class="line">    OldTrapFrame = Thread-&gt;TrapFrame;</span><br><span class="line"></span><br><span class="line">    Thread-&gt;TrapFrame = TrapFrame;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取当前进程（提供CR3的进程）</span></span><br><span class="line">    Process = Thread-&gt;ApcState.Process;</span><br><span class="line"></span><br><span class="line">    KeAcquireInStackQueuedSpinLock(&amp;Thread-&gt;ApcQueueLock, &amp;LockHandle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Get address of current thread object, clear kernel APC pending, and</span></span><br><span class="line">    <span class="comment">// check if any kernel mode APC&#x27;s can be delivered.</span></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接下来要执行内核APC，这里提前声明处理完毕</span></span><br><span class="line">    Thread-&gt;ApcState.KernelApcPending = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 遍历内核APC队列</span></span><br><span class="line">    <span class="keyword">while</span> (IsListEmpty(&amp;Thread-&gt;ApcState.ApcListHead[KernelMode]) == FALSE) &#123;</span><br><span class="line">		<span class="comment">// 获取 APC，获取 APC 的成员</span></span><br><span class="line">        NextEntry = Thread-&gt;ApcState.ApcListHead[KernelMode].Flink;</span><br><span class="line">        Apc = CONTAINING_RECORD(NextEntry, KAPC, ApcListEntry);</span><br><span class="line">        KernelRoutine = Apc-&gt;KernelRoutine;</span><br><span class="line">        NormalRoutine = Apc-&gt;NormalRoutine;</span><br><span class="line">        NormalContext = Apc-&gt;NormalContext;</span><br><span class="line">        SystemArgument1 = Apc-&gt;SystemArgument1;</span><br><span class="line">        SystemArgument2 = Apc-&gt;SystemArgument2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (NormalRoutine == (PKNORMAL_ROUTINE)<span class="literal">NULL</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// NormalRoutine 等于 NULL 的情况属于特殊内核APC，我不知道什么时候会插入这样的APC</span></span><br><span class="line">			<span class="comment">// 所以这里就不分析了，假如您读到这里，又知道相关的信息，不妨留言提示我一下^_^</span></span><br><span class="line">			<span class="comment">// 2020年11月29日21:04:21</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// First entry in the kernel APC queue is a special kernel APC.</span></span><br><span class="line">            <span class="comment">// Remove the entry from the APC queue, set its inserted state</span></span><br><span class="line">            <span class="comment">// to FALSE, release dispatcher database lock, and call the kernel</span></span><br><span class="line">            <span class="comment">// routine. On return raise IRQL to dispatcher level and lock</span></span><br><span class="line">            <span class="comment">// dispatcher database lock.</span></span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">            RemoveEntryList(NextEntry);</span><br><span class="line"></span><br><span class="line">            Apc-&gt;Inserted = FALSE;</span><br><span class="line"></span><br><span class="line">            KeReleaseInStackQueuedSpinLock(&amp;LockHandle);</span><br><span class="line"></span><br><span class="line">            (KernelRoutine)(Apc,</span><br><span class="line">                            &amp;NormalRoutine,</span><br><span class="line">                            &amp;NormalContext,</span><br><span class="line">                            &amp;SystemArgument1,</span><br><span class="line">                            &amp;SystemArgument2);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DBG</span></span><br><span class="line">			<span class="comment">// 蓝屏警告</span></span><br><span class="line">            <span class="keyword">if</span> (KeGetCurrentIrql() != LockHandle.OldIrql) &#123;</span><br><span class="line">                KeBugCheckEx(IRQL_UNEXPECTED_VALUE,</span><br><span class="line">                             KeGetCurrentIrql() &lt;&lt; <span class="number">16</span> | LockHandle.OldIrql &lt;&lt; <span class="number">8</span>,</span><br><span class="line">                             (ULONG_PTR)KernelRoutine,</span><br><span class="line">                             (ULONG_PTR)Apc,</span><br><span class="line">                             (ULONG_PTR)NormalRoutine);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            KeAcquireInStackQueuedSpinLock(&amp;Thread-&gt;ApcQueueLock, &amp;LockHandle);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">      <span class="comment">// 走这个分支说明 NormalRoutine 非空，是普通的内核APC，PspTerminateThreadByPointer 和 NtQueueApcThread 都走这里</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// First entry in the kernel APC queue is a normal kernel APC.</span></span><br><span class="line">            <span class="comment">// If there is not a normal kernel APC in progress and kernel</span></span><br><span class="line">            <span class="comment">// APC&#x27;s are not disabled, then remove the entry from the APC</span></span><br><span class="line">            <span class="comment">// queue, set its inserted state to FALSE, release the APC queue</span></span><br><span class="line">            <span class="comment">// lock, call the specified kernel routine, set kernel APC in</span></span><br><span class="line">            <span class="comment">// progress, lower the IRQL to zero, and call the normal kernel</span></span><br><span class="line">            <span class="comment">// APC routine. On return raise IRQL to dispatcher level, lock</span></span><br><span class="line">            <span class="comment">// the APC queue, and clear kernel APC in progress.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((Thread-&gt;ApcState.KernelApcInProgress == FALSE) &amp;&amp;	<span class="comment">// 没有内核APC正在执行 并且</span></span><br><span class="line">               (Thread-&gt;KernelApcDisable == <span class="number">0</span>))		<span class="comment">// 没有禁用内核APC</span></span><br><span class="line">			&#123;</span><br><span class="line">              <span class="comment">// 从内核 APC 队列中移除这个 APC</span></span><br><span class="line">                RemoveEntryList(NextEntry);</span><br><span class="line"></span><br><span class="line">              <span class="comment">// APC Inserted 标志清零</span></span><br><span class="line">                Apc-&gt;Inserted = FALSE;</span><br><span class="line"></span><br><span class="line">                KeReleaseInStackQueuedSpinLock(&amp;LockHandle);</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 调用 KernelRoutine，举两个例子说明</span></span><br><span class="line">              <span class="comment">// 如果 APC 通过PspTerminateThreadByPointer 构造， KernelRoutine 是 PsExitSpecialApc ，</span></span><br><span class="line">              <span class="comment">// 那么执行的操作就是释放APC内存，并终止当前线程</span></span><br><span class="line">              <span class="comment">// 如果 APC 通过 NtQueueApcThread 构造，KernelRoutine 是 PspQueueApcSpecialApc，</span></span><br><span class="line">              <span class="comment">//执行的操作仅仅是释放APC内存</span></span><br><span class="line">              <span class="comment">// 不过 NtQueueApcThread 插入的属于用户APC，不走这里，而是等内核APC执行完后再执行</span></span><br><span class="line">              <span class="comment">// KernelRoutine 的工作是释放APC内存，也可能包括一些额外的工作，如退出、挂起、恢复线程</span></span><br><span class="line">              <span class="comment">// KernelRoutine 是调用 KeInitializeApc 时决定的，是不确定的，各种函数对参数的使用情况都不一样</span></span><br><span class="line">              <span class="comment">// 例如 PspTerminateThreadByPointer 初始化 KernelRoutine 传的函数是 PsExitSpecialApc，</span></span><br><span class="line">              <span class="comment">//就只使用了第一个参数 Apc</span></span><br><span class="line">                (KernelRoutine)(Apc,</span><br><span class="line">                                &amp;NormalRoutine,</span><br><span class="line">                                &amp;NormalContext,</span><br><span class="line">                                &amp;SystemArgument1,</span><br><span class="line">                                &amp;SystemArgument2);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DBG</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (KeGetCurrentIrql() != LockHandle.OldIrql) &#123;</span><br><span class="line">                    KeBugCheckEx(IRQL_UNEXPECTED_VALUE,</span><br><span class="line">                                 KeGetCurrentIrql() &lt;&lt; <span class="number">16</span> | LockHandle.OldIrql &lt;&lt; <span class="number">8</span> | <span class="number">1</span>,</span><br><span class="line">                                 (ULONG_PTR)KernelRoutine,</span><br><span class="line">                                 (ULONG_PTR)Apc,</span><br><span class="line">                                 (ULONG_PTR)NormalRoutine);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">              <span class="comment">// NormalRoutine 是内核APC函数，经分析，我觉得能执行到这里，NormalRoutine 应该不是 NULL 的</span></span><br><span class="line">              <span class="comment">// 唯一可能修改 NormalRoutine 的就是上面调用的 KernelRoutine 函数</span></span><br><span class="line">                <span class="keyword">if</span> (NormalRoutine != (PKNORMAL_ROUTINE)<span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 内核APC正在执行</span></span><br><span class="line">                    Thread-&gt;ApcState.KernelApcInProgress = TRUE;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 降低IRQL到0</span></span><br><span class="line">                    KeLowerIrql(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 调用内核APC函数</span></span><br><span class="line">                    (NormalRoutine)(NormalContext,</span><br><span class="line">                                    SystemArgument1,</span><br><span class="line">                                    SystemArgument2);</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 恢复IRQL到APC_LEVEL（1）</span></span><br><span class="line">                    KeRaiseIrql(APC_LEVEL, &amp;LockHandle.OldIrql);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                KeAcquireInStackQueuedSpinLock(&amp;Thread-&gt;ApcQueueLock, &amp;LockHandle);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 没有内核APC正在执行</span></span><br><span class="line">                Thread-&gt;ApcState.KernelApcInProgress = FALSE;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                KeReleaseInStackQueuedSpinLock(&amp;LockHandle);</span><br><span class="line">                <span class="keyword">goto</span> CheckProcess;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Kernel APC queue is empty. If the previous mode is user, user APC</span></span><br><span class="line">    <span class="comment">// pending is set, and the user APC queue is not empty, then remove</span></span><br><span class="line">    <span class="comment">// the first entry from the user APC queue, set its inserted state to</span></span><br><span class="line">    <span class="comment">// FALSE, clear user APC pending, release the dispatcher database lock,</span></span><br><span class="line">    <span class="comment">// and call the specified kernel routine. If the normal routine address</span></span><br><span class="line">    <span class="comment">// is not NULL on return from the kernel routine, then initialize the</span></span><br><span class="line">    <span class="comment">// user mode APC context and return. Otherwise, check to determine if</span></span><br><span class="line">    <span class="comment">// another user mode APC can be processed.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">	<span class="comment">// 内核APC执行完毕</span></span><br><span class="line">	<span class="comment">// 如果 PreviousMode 是用户模式（1），并且有用户APC，并且用户APC队列非空</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((IsListEmpty(&amp;Thread-&gt;ApcState.ApcListHead[UserMode]) == FALSE) &amp;&amp;</span><br><span class="line">       (PreviousMode == UserMode) &amp;&amp; </span><br><span class="line">	   (Thread-&gt;ApcState.UserApcPending != FALSE)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 提前声明用户APC队列已清空</span></span><br><span class="line">        Thread-&gt;ApcState.UserApcPending = FALSE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取APC和其属性</span></span><br><span class="line">        NextEntry = Thread-&gt;ApcState.ApcListHead[UserMode].Flink;</span><br><span class="line">        Apc = CONTAINING_RECORD(NextEntry, KAPC, ApcListEntry);</span><br><span class="line">        KernelRoutine = Apc-&gt;KernelRoutine;</span><br><span class="line">        NormalRoutine = Apc-&gt;NormalRoutine;</span><br><span class="line">        NormalContext = Apc-&gt;NormalContext;</span><br><span class="line">        SystemArgument1 = Apc-&gt;SystemArgument1;</span><br><span class="line">        SystemArgument2 = Apc-&gt;SystemArgument2;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从用户APC队列中取出</span></span><br><span class="line">        RemoveEntryList(NextEntry);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 标记插入状态为FALSE</span></span><br><span class="line">        Apc-&gt;Inserted = FALSE;</span><br><span class="line"></span><br><span class="line">        KeReleaseInStackQueuedSpinLock(&amp;LockHandle);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// KernelRoutine 应该就是 PspQueueApcSpecialApc </span></span><br><span class="line">		<span class="comment">// 因为用户APC是 NtQueueApcThread 函数构造和插入的，它就是这样初始化APC的</span></span><br><span class="line">		<span class="comment">// PspQueueApcSpecialApc 的唯一作用是释放APC内存</span></span><br><span class="line">        (KernelRoutine)(Apc,</span><br><span class="line">                        &amp;NormalRoutine,</span><br><span class="line">                        &amp;NormalContext,</span><br><span class="line">                        &amp;SystemArgument1,</span><br><span class="line">                        &amp;SystemArgument2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (NormalRoutine == (PKNORMAL_ROUTINE)<span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="comment">// 此函数定义在 thredobj.c			</span></span><br><span class="line">            KeTestAlertThread(UserMode);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 准备回3环调用 NormalContext</span></span><br><span class="line">            KiInitializeUserApc(ExceptionFrame,</span><br><span class="line">                                TrapFrame,</span><br><span class="line">                                NormalRoutine,		<span class="comment">// 用户APC总入口 BaseDispatchAPC（3环函数）</span></span><br><span class="line">                                NormalContext,		<span class="comment">// 3环APC函数</span></span><br><span class="line">                                SystemArgument1,	<span class="comment">// 3环APC函数的参数</span></span><br><span class="line">                                SystemArgument2);	<span class="comment">// 作用不明，BaseDispatchAPC 里用到了</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        KeReleaseInStackQueuedSpinLock(&amp;LockHandle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if process was attached during the APC routine.</span></span><br><span class="line">    <span class="comment">// 检查当前进程是否发生变化（执行 APC 函数时发生了 attach）</span></span><br><span class="line"></span><br><span class="line">CheckProcess:</span><br><span class="line">    <span class="keyword">if</span> (Thread-&gt;ApcState.Process != Process) &#123;</span><br><span class="line">		<span class="comment">// 蓝屏警告</span></span><br><span class="line">        KeBugCheckEx(INVALID_PROCESS_ATTACH_ATTEMPT,</span><br><span class="line">                     (ULONG_PTR)Process,</span><br><span class="line">                     (ULONG_PTR)Thread-&gt;ApcState.Process,</span><br><span class="line">                     (ULONG)Thread-&gt;ApcStateIndex,</span><br><span class="line">                     (ULONG)KeIsExecutingDpc());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread-&gt;TrapFrame = OldTrapFrame;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-KeTestAlertThread"><a href="#3-KeTestAlertThread" class="headerlink" title="3 KeTestAlertThread"></a>3 KeTestAlertThread</h2><p>通过对函数<code>KiDeliverApc</code>交付（Deliver）用户APC函数的过程，在交付用户过程中会先执行<code>KernelRoutine</code>函数（参数包含<code>NormalRoutine</code>），函数执行过程中有可能会修改<code>NormalRoutine</code>，所以需要对<code>NormalRoutine</code>进行检查是否为<code>0</code>。</p>
<p>为什么需要判断<code>NormalRoutine</code>是否为<code>NULL</code>，是因为多核情况下其他CPU在某个过程中已经执行了这个用户APC么？</p>
<p>我认为，并不是因为多核的原因。因为在交付用户APC函数之前，调用了函数<code>KeReleaseInStackQueuedSpinLock</code>上了自旋锁。同时参考《Windows情景分析P371》，<code>KernelRoutine</code>执行的时候有可能改变指针<code>NormalRoutine</code>的值，所以需要测试一下。</p>
<p>函数<code>KeTestAlertThread</code>：This function tests to determine if the alerted variable for the specified processor mode has a value of TRUE or whether a user mode APC should be delivered to the current thread.（processor mode：UserMode&#x2F;KernelMode处理器模式，variable-变量，specified-指定的）</p>
<p><strong>该函数检查当前线程是否可以交付第一个用户模式的APC</strong></p>
<p><strong>如果吵醒模式AlertMode &#x3D;&#x3D; 1，并且用户APC队列不为空，那就设置 Thread-&gt;ApcState.UserApcPending &#x3D; TRUE 然后交付下一个用户APC。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOLEAN __stdcall <span class="title">KeTestAlertThread</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KPROCESSOR_MODE AlertMode</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BOOLEAN Alerted;</span><br><span class="line">  KLOCK_QUEUE_HANDLE LockHandle;</span><br><span class="line">  PKTHREAD Thread;</span><br><span class="line">  </span><br><span class="line">  ASSERT(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);</span><br><span class="line">  Thread = KeGetCurrentThread();</span><br><span class="line">  KeAcquireInStackQueuedSpinLockRaiseToSynch(&amp;Thread-&gt;ApcQueueLock, &amp;LockHandle);</span><br><span class="line">  KiLockDispatcherDatabaseAtSynchLevel</span><br><span class="line">  </span><br><span class="line">  Alerted = Thread-&gt;Alerted[AlertMode];</span><br><span class="line">  <span class="keyword">if</span> (Alerted == TRUE) &#123;	</span><br><span class="line">    Thread-&gt;Alerted[AlertMode] = FALSE;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((AlertMode == UserMode) &amp;&amp;</span><br><span class="line">             (IsListEmpty(&amp;Thread-&gt;ApcState.ApcListHead[UserMode]) != TRUE)) &#123;</span><br><span class="line">    Thread-&gt;ApcState.UserApcPending = TRUE;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  KiUnlockDispatcherDatabaseFromSynchLevel();</span><br><span class="line">  KeReleaseInStackQueuedSpinLock(&amp;LockHandle);</span><br><span class="line">  <span class="keyword">return</span> Alerted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Alerted：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LittleHann/p/3456697.html">用来说明线程在指定模式下是否为”已经被吵醒” 。</a>具体在哪进行修改，目前就知道在函数<code>KeAlertThread</code>中，当吵醒条件不满足时候就会<code>Thread-&gt;Alerted[AlertMode] = TRUE;</code>来说明已经调用过该函数一次了，只是吵醒条件不满足，如果可以吵醒是不会设置的为<code>TRUE</code>的。所以这里的<code>Thread-&gt;Alerted[AlertMode] = FALSE;</code>我理解就是一个额外的修正操作。**但是在APC的交付过程中，一般使用到该函数的<code>else if</code>处的功能，即<code>Thread-&gt;ApcState.UserApcPending = TRUE</code>**。</p>
<p>在APC注入过程中，经常使用该函数，因为函数<code>KiInsertQueueApc</code>在KAPC插入过后判断条件满足：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Thread.State == Waiting &amp;&amp; Thread.WaitMode == <span class="number">1</span> &amp;&amp; (Thread.Alertable == <span class="number">1</span> || Thread.ApcState.UserApcPending == <span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<p>就会设置<code>Thread.ApcState.UserApcPending = 1</code>然后调用<code>KiUnwaitThread</code>让线程开始转为就绪，线程切换后就有机会执行APC函数。上面可以看到<code>Alertable == 1</code>与<code>UserApcPending == 1</code>满足其一即可，所以一般调用函数<code>KeTestAlertThread</code>就可进行注入，可以参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/361808484">驱动病毒那些事(三)—-APC注入</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252487">深入理解APC机制（二）</a></li>
<li><a target="_blank" rel="noopener" href="https://yhsnlkm.github.io/2021/01/04/%E6%94%BB%E9%98%B2%E4%BF%9D%E6%8A%A4/%E5%9C%A8%E5%86%85%E6%A0%B8%E4%B8%AD%E4%BD%BF%E7%94%A8APC%E6%B3%A8%E5%85%A5DLL%E5%88%B0R3%E8%BF%9B%E7%A8%8B-2/">在内核中使用APC注入DLL到R3进程(2)</a>。</li>
</ul>
<h2 id="4-CONTEXT"><a href="#4-CONTEXT" class="headerlink" title="4 _CONTEXT"></a>4 _CONTEXT</h2><p>每个线程都会维护一个<code>_CONTEXT</code>结构，里面保存着线程<strong>运行在3环时</strong>的寄存器的值，里面保存了线程运行的状态，使得CPU可以记得上次运行该线程运行到哪里了，该从哪里开始运行。在线程的挂起、恢复线程状态切换时经常用到。</p>
<p><code>_CONTEXT</code>结构与<code>_Trap_Frame</code>结构很相似，都是保存一堆寄存器的值，但是在用途上却不一样：</p>
<ul>
<li><code>_CONTEXT</code>：线程发生状态切换时，将当前寄存器的值保存下来，方便恢复线程运行的时候回到原来的地方继续运行（一个CPU就一套寄存器，线程切换后其他线程要使用寄存器，自己的寄存器的值要先保存起来）。</li>
<li><code>_Trap_Frame</code>：线程从3环进入0环时，将<strong>3环的寄存器值保存到该结构</strong>中，线程从0环正常返回到3环后从原来的地方继续运行。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _CONTEXT -v</span><br><span class="line">nt!_CONTEXT</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">CONTEXT</span>, 25 <span class="title">elements</span>, 0<span class="title">x2cc</span> <span class="title">bytes</span></span></span><br><span class="line"><span class="class">   +0<span class="title">x000</span> <span class="title">ContextFlags</span>     :</span> Uint4B</span><br><span class="line">     </span><br><span class="line">   <span class="comment">//调试寄存器组，ContextFlags 设置为 CONTEXT_DEBUG_REGISTERS</span></span><br><span class="line">   <span class="comment">//注意：CONTEXT_DEBUG_REGISTERS 没有被包含在 CONTEXT_FULL 中。</span></span><br><span class="line">   +<span class="number">0x004</span> Dr0              : Uint4B	</span><br><span class="line">   +<span class="number">0x008</span> Dr1              : Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> Dr2              : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> Dr3              : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> Dr6              : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> Dr7              : Uint4B</span><br><span class="line">     </span><br><span class="line">   <span class="comment">//浮点寄存器组，ContextFlags 设置为 CONTEXT_FLOATING_POINT</span></span><br><span class="line">   +<span class="number">0x01c</span> FloatSave        : <span class="class"><span class="keyword">struct</span> _<span class="title">FLOATING_SAVE_AREA</span>, 9 <span class="title">elements</span>, 0<span class="title">x70</span> <span class="title">bytes</span>	</span></span><br><span class="line"><span class="class">     </span></span><br><span class="line"><span class="class">   //段寄存器组，<span class="title">ContextFlags</span> 字包含 <span class="title">CONTEXT_SEGMENTS</span></span></span><br><span class="line"><span class="class">   +0<span class="title">x08c</span> <span class="title">SegGs</span>            :</span> Uint4B		</span><br><span class="line">   +<span class="number">0x090</span> SegFs            : Uint4B</span><br><span class="line">   +<span class="number">0x094</span> SegEs            : Uint4B</span><br><span class="line">   +<span class="number">0x098</span> SegDs            : Uint4B</span><br><span class="line">     </span><br><span class="line">   <span class="comment">//通用数据寄存器（整型寄存器）组，ContextFlags 字包含 CONTEXT_INTEGER</span></span><br><span class="line">   +<span class="number">0x09c</span> Edi              : Uint4B</span><br><span class="line">   +<span class="number">0x0a0</span> Esi              : Uint4B</span><br><span class="line">   +<span class="number">0x0a4</span> Ebx              : Uint4B</span><br><span class="line">   +<span class="number">0x0a8</span> Edx              : Uint4B</span><br><span class="line">   +<span class="number">0x0ac</span> Ecx              : Uint4B</span><br><span class="line">   +<span class="number">0x0b0</span> Eax              : Uint4B</span><br><span class="line">     </span><br><span class="line">   <span class="comment">//控制寄存器组，ContextFlags 字包含 CONTEXT_CONTROL</span></span><br><span class="line">   +<span class="number">0x0b4</span> Ebp              : Uint4B</span><br><span class="line">   +<span class="number">0x0b8</span> Eip              : Uint4B</span><br><span class="line">   +<span class="number">0x0bc</span> SegCs            : Uint4B</span><br><span class="line">   +<span class="number">0x0c0</span> EFlags           : Uint4B</span><br><span class="line">   +<span class="number">0x0c4</span> Esp              : Uint4B</span><br><span class="line">   +<span class="number">0x0c8</span> SegSs            : Uint4B</span><br><span class="line">     </span><br><span class="line">   <span class="comment">//拓展寄存器组，ContextFlags 字包含 CONTEXT_EXTENDED_REGISTERS</span></span><br><span class="line">   +<span class="number">0x0cc</span> ExtendedRegisters : [<span class="number">512</span>] UChar</span><br></pre></td></tr></table></figure>

<p>源代码定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Context Frame</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This frame has a several purposes: 1) it is used as an argument to</span></span><br><span class="line"><span class="comment">//  NtContinue, 2) is is used to constuct a call frame for APC delivery,</span></span><br><span class="line"><span class="comment">//  and 3) it is used in the user level thread creation routines.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The layout of the record conforms to a standard call frame.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CONTEXT</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The flags values within this flag control the contents of</span></span><br><span class="line">    <span class="comment">// a CONTEXT record.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If the context record is used as an input parameter, then</span></span><br><span class="line">    <span class="comment">// for each portion of the context record controlled by a flag</span></span><br><span class="line">    <span class="comment">// whose value is set, it is assumed that that portion of the</span></span><br><span class="line">    <span class="comment">// context record contains valid context. If the context record</span></span><br><span class="line">    <span class="comment">// is being used to modify a threads context, then only that</span></span><br><span class="line">    <span class="comment">// portion of the threads context will be modified.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If the context record is used as an IN OUT parameter to capture</span></span><br><span class="line">    <span class="comment">// the context of a thread, then only those portions of the thread&#x27;s</span></span><br><span class="line">    <span class="comment">// context corresponding to set flags will be returned.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The context record is never used as an OUT only parameter.</span></span><br><span class="line"></span><br><span class="line">    ULONG ContextFlags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This section is specified/returned if CONTEXT_DEBUG_REGISTERS is</span></span><br><span class="line">    <span class="comment">// set in ContextFlags.  Note that CONTEXT_DEBUG_REGISTERS is NOT</span></span><br><span class="line">    <span class="comment">// included in CONTEXT_FULL.</span></span><br><span class="line">    ULONG   Dr0;</span><br><span class="line">    ULONG   Dr1;</span><br><span class="line">    ULONG   Dr2;</span><br><span class="line">    ULONG   Dr3;</span><br><span class="line">    ULONG   Dr6;</span><br><span class="line">    ULONG   Dr7;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_FLOATING_POINT.</span></span><br><span class="line">    FLOATING_SAVE_AREA FloatSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_SEGMENTS.</span></span><br><span class="line">    ULONG   SegGs;</span><br><span class="line">    ULONG   SegFs;</span><br><span class="line">    ULONG   SegEs;</span><br><span class="line">    ULONG   SegDs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_INTEGER.</span></span><br><span class="line">    ULONG   Edi;</span><br><span class="line">    ULONG   Esi;</span><br><span class="line">    ULONG   Ebx;</span><br><span class="line">    ULONG   Edx;</span><br><span class="line">    ULONG   Ecx;</span><br><span class="line">    ULONG   Eax;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_CONTROL.</span></span><br><span class="line">    ULONG   Ebp;</span><br><span class="line">    ULONG   Eip;</span><br><span class="line">    ULONG   SegCs;              <span class="comment">// MUST BE SANITIZED</span></span><br><span class="line">    ULONG   EFlags;             <span class="comment">// MUST BE SANITIZED</span></span><br><span class="line">    ULONG   Esp;</span><br><span class="line">    ULONG   SegSs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This section is specified/returned if the ContextFlags word</span></span><br><span class="line">    <span class="comment">// contains the flag CONTEXT_EXTENDED_REGISTERS.</span></span><br><span class="line">    <span class="comment">// The format and contexts are processor specific</span></span><br><span class="line">    UCHAR   ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];</span><br><span class="line"></span><br><span class="line">&#125; CONTEXT;</span><br></pre></td></tr></table></figure>

<p>该结构的<code>ContextFlags</code>成员很重要，当我们要查询<code>CONTEXT</code>中某些寄存器的值的时候，需要先指定<code>ContextFlags</code>的值，由它来指定有哪些权限，能查询到哪些寄存器的值。</p>
<table>
<thead>
<tr>
<th>寄存器组</th>
<th>ContextFlags</th>
<th>包含的寄存器</th>
<th>对应值</th>
</tr>
</thead>
<tbody><tr>
<td>调试寄存器组</td>
<td>CONTEXT_DEBUG_REGISTERS</td>
<td>Dr0-7</td>
<td>0x00010000 ｜ 0x00000010 &#x3D;&#x3D; 0x00010010</td>
</tr>
<tr>
<td>浮点寄存器组</td>
<td>CONTEXT_FLOATING_POINT</td>
<td>387 state</td>
<td>0x00010000 ｜ 0x00000008 &#x3D;&#x3D; 0x00010008</td>
</tr>
<tr>
<td>段寄存器组</td>
<td>CONTEXT_SEGMENTS</td>
<td>DS, ES, FS, GS</td>
<td>0x00010000 ｜ 0x00000004 &#x3D;&#x3D; 0x00010004</td>
</tr>
<tr>
<td>通用数据寄存器</td>
<td>CONTEXT_INTEGER</td>
<td>AX, BX, CX, DX, SI, DI</td>
<td>0x00010000 ｜ 0x00000002 &#x3D;&#x3D; 0x00010002</td>
</tr>
<tr>
<td>控制寄存器组</td>
<td>CONTEXT_CONTROL</td>
<td>SS:SP, CS:IP, FLAGS, BP</td>
<td>0x00010000 ｜ 0x00000001 &#x3D;&#x3D; 0x00010001</td>
</tr>
<tr>
<td>拓展寄存器组</td>
<td>CONTEXT_EXTENDED_REGISTERS</td>
<td>cpu specific extensions</td>
<td>0x00010000 ｜ 0x00000020 &#x3D;&#x3D; 0x00010020</td>
</tr>
<tr>
<td>FULL字段</td>
<td>CONTEXT_FULL</td>
<td>控制、通用、段寄存器</td>
<td>CONTEXT_CONTROL ｜CONTEXT_INTEGER ｜ CONTEXT_SEGMENTS<br />0x00010000 ｜ 0x00000004 | 0x00000002 | 0x00000001 &#x3D;&#x3D; 0x00010007</td>
</tr>
</tbody></table>
<p>有这样的定义：<code>CONTEXT_i386 = 0x00010000</code>。</p>
<p>还可以参考：<a target="_blank" rel="noopener" href="https://fishc.com.cn/thread-74090-1-1.html">[API档案] CONTEXT 结构</a>、<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_14207158/2570603">Windows线程的上下文结构体（线程本质</a>。</p>
<h2 id="5-KiInitializeUserApc"><a href="#5-KiInitializeUserApc" class="headerlink" title="5 KiInitializeUserApc"></a>5 KiInitializeUserApc</h2><p>函数<code>KiInitializeUserApc</code>：该函数给用户模式的APC初始化一个<code>CONTEXT</code>结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID __stdcall <span class="title">KiInitializeUserApc</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKEXCEPTION_FRAME ExceptionFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKTRAP_FRAME TrapFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKNORMAL_ROUTINE NormalRoutine,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID NormalContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID SystemArgument1,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID SystemArgument2</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>

<p>执行环境条件：<strong>Environment：Kernel mode only, IRQL APC_LEVEL.</strong></p>
<p><code>KiInitializeUserApc</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">KiInitializeUserApc</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKEXCEPTION_FRAME ExceptionFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKTRAP_FRAME TrapFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKNORMAL_ROUTINE NormalRoutine,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID NormalContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID SystemArgument1,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID SystemArgument2</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="function"><span class="comment">Routine Description: This function is called to initialize the context for a user mode APC.</span></span></span><br><span class="line"><span class="function"><span class="comment">Arguments:</span></span></span><br><span class="line"><span class="function"><span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span></span></span><br><span class="line"><span class="function"><span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span></span></span><br><span class="line"><span class="function"><span class="comment">    NormalRoutine - Supplies a pointer to the user mode APC routine.</span></span></span><br><span class="line"><span class="function"><span class="comment">    NormalContext - Supplies a pointer to the user context for the APC routine.</span></span></span><br><span class="line"><span class="function"><span class="comment">    SystemArgument1 - Supplies the first system supplied value.</span></span></span><br><span class="line"><span class="function"><span class="comment">    SystemArgument2 - Supplies the second system supplied value.</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">Return Value: None.</span></span></span><br><span class="line"><span class="function"><span class="comment">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EXCEPTION_RECORD ExceptionRecord;</span><br><span class="line">    CONTEXT ContextFrame;</span><br><span class="line">    LONG Length;</span><br><span class="line">    ULONG UserStack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// APCs are not defined for V86 mode; however, it is possible a</span></span><br><span class="line">    <span class="comment">// thread is trying to set it&#x27;s context to V86 mode - this isn&#x27;t</span></span><br><span class="line">    <span class="comment">// going to work, but we don&#x27;t want to crash the system so we</span></span><br><span class="line">    <span class="comment">// check for the possibility before hand.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK) &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Move machine state from trap and exception frames to the context frame.</span></span><br><span class="line"></span><br><span class="line">    ContextFrame.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span><br><span class="line">    KeContextFromKframes(TrapFrame, ExceptionFrame, &amp;ContextFrame);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transfer the context information to the user stack, initialize the</span></span><br><span class="line">    <span class="comment">// APC routine parameters, and modify the trap frame so execution will</span></span><br><span class="line">    <span class="comment">// continue in user mode at the user mode APC dispatch routine.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ASSERT((TrapFrame-&gt;SegCs &amp; MODE_MASK) != KernelMode); <span class="comment">// Assert usermode frame</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Compute length of context record and new aligned user stack pointer.</span></span><br><span class="line">        Length = ((<span class="keyword">sizeof</span>(CONTEXT) + CONTEXT_ROUND) &amp;</span><br><span class="line">                    ~CONTEXT_ROUND) + <span class="keyword">sizeof</span>(KAPC_RECORD);</span><br><span class="line">        UserStack = (ContextFrame.Esp &amp; ~CONTEXT_ROUND) - Length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Probe user stack area for writability and then transfer the</span></span><br><span class="line">        <span class="comment">// context record to the user stack.</span></span><br><span class="line">        ProbeForWrite((PCHAR)UserStack, Length, CONTEXT_ALIGN);</span><br><span class="line">        RtlCopyMemory((PULONG)(UserStack + (<span class="keyword">sizeof</span>(KAPC_RECORD))),</span><br><span class="line">                     &amp;ContextFrame, <span class="keyword">sizeof</span>(CONTEXT));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Force correct R3 selectors into TrapFrame.</span></span><br><span class="line">        TrapFrame-&gt;SegCs = SANITIZE_SEG(KGDT_R3_CODE, UserMode);</span><br><span class="line">        TrapFrame-&gt;HardwareSegSs = SANITIZE_SEG(KGDT_R3_DATA, UserMode);</span><br><span class="line">        TrapFrame-&gt;SegDs = SANITIZE_SEG(KGDT_R3_DATA, UserMode);</span><br><span class="line">        TrapFrame-&gt;SegEs = SANITIZE_SEG(KGDT_R3_DATA, UserMode);</span><br><span class="line">        TrapFrame-&gt;SegFs = SANITIZE_SEG(KGDT_R3_TEB, UserMode);</span><br><span class="line">        TrapFrame-&gt;SegGs = <span class="number">0</span>;</span><br><span class="line">        TrapFrame-&gt;EFlags = SANITIZE_FLAGS( ContextFrame.EFlags, UserMode );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If thread is supposed to have IOPL, then force it on in eflags</span></span><br><span class="line">        <span class="keyword">if</span> (KeGetCurrentThread()-&gt;Iopl) &#123;</span><br><span class="line">            TrapFrame-&gt;EFlags |= (EFLAGS_IOPL_MASK &amp; <span class="number">-1</span>);  <span class="comment">// IOPL = 3</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the address of the user APC routine, the APC parameters, the</span></span><br><span class="line">        <span class="comment">// new frame pointer, and the new stack pointer in the current trap</span></span><br><span class="line">        <span class="comment">// frame. Set the continuation address so control will be transferred</span></span><br><span class="line">        <span class="comment">// to the user APC dispatcher.</span></span><br><span class="line">        TrapFrame-&gt;HardwareEsp = UserStack;</span><br><span class="line">        TrapFrame-&gt;Eip = (ULONG)KiUserApcDispatcher;	<span class="comment">//当线程回到3环时执行的函数，位于ntdll.dll中</span></span><br><span class="line">        TrapFrame-&gt;ErrCode = <span class="number">0</span>;</span><br><span class="line">        *((PULONG)UserStack)++ = (ULONG)NormalRoutine;</span><br><span class="line">        *((PULONG)UserStack)++ = (ULONG)NormalContext;</span><br><span class="line">        *((PULONG)UserStack)++ = (ULONG)SystemArgument1;</span><br><span class="line">        *((PULONG)UserStack)++ = (ULONG)SystemArgument2;</span><br><span class="line">    &#125; except (KiCopyInformation(&amp;ExceptionRecord,</span><br><span class="line">                                (GetExceptionInformation())-&gt;ExceptionRecord)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the address of the exception to the current program address</span></span><br><span class="line">        <span class="comment">// and raise the exception by calling the exception dispatcher.</span></span><br><span class="line">        ExceptionRecord.ExceptionAddress = (PVOID)(TrapFrame-&gt;Eip);</span><br><span class="line">        KiDispatchException(&amp;ExceptionRecord,</span><br><span class="line">                            ExceptionFrame,</span><br><span class="line">                            TrapFrame,</span><br><span class="line">                            UserMode,</span><br><span class="line">                            TRUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逆向分析<code>KiInitializeUserApc</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0</span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">// VOID __stdcall KiInitializeUserApc (</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">//     IN PKEXCEPTION_FRAME ExceptionFrame,</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">//     IN PKTRAP_FRAME TrapFrame,</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">//     IN PKNORMAL_ROUTINE NormalRoutine,</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">//     IN PVOID NormalContext,</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">//     IN PVOID SystemArgument1,</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">//     IN PVOID SystemArgument2</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">// Attributes: bp-based frame</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0</span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">// __stdcall KiInitializeUserApc(x, x, x, x, x, x)</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 _KiInitializeUserApc@<span class="number">24</span> proc near       <span class="comment">// CODE XREF: KiDeliverApc(x,x,x)+1D0↑p</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0</span><br><span class="line">.text:<span class="number">0042</span>D2C0 ExceptionRecord = EXCEPTION_RECORD ptr <span class="number">-34</span>Ch</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_2FC         = dword ptr <span class="number">-2F</span>Ch</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_2F8         = dword ptr <span class="number">-2F</span>8h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_ExceptionFrame= dword ptr <span class="number">-2F</span>4h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 BugCheckParameter3= dword ptr <span class="number">-2F</span>0h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_2EC         = dword ptr <span class="number">-2</span>ECh</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_2E8         = dword ptr <span class="number">-2E8</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_228         = dword ptr <span class="number">-228</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_224         = dword ptr <span class="number">-224</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 var_JinSiQue    = dword ptr <span class="number">-1</span>Ch</span><br><span class="line">.text:<span class="number">0042</span>D2C0 ms_exc          = CPPEH_RECORD ptr <span class="number">-18</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 ExceptionFrame  = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0 TrapFrame       = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0042</span>D2C0 NormalRoutine   = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 NormalContext   = dword ptr  <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 SystemArgument1 = dword ptr  <span class="number">18</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2C0 SystemArgument2 = dword ptr  <span class="number">1</span>Ch</span><br><span class="line">.text:<span class="number">0042</span>D2C0</span><br><span class="line">.text:<span class="number">0042</span>D2C0 <span class="comment">// __unwind &#123; // __SEH_prolog</span></span><br><span class="line">.text:<span class="number">0042</span>D2C0                 push    <span class="number">33</span>Ch</span><br><span class="line">.text:<span class="number">0042</span>D2C5                 push    offset stru_402AC0</span><br><span class="line">.text:<span class="number">0042</span>D2CA                 call    __SEH_prolog</span><br><span class="line">.text:<span class="number">0042</span>D2CF                 mov     eax, ___security_cookie <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">// 金丝雀</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">// 实际上就是用来检查缓冲区(局部数组)是否已经溢出。</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">// 原来：在函数堆栈存放顺序：ebp/返回地址 security_cookie Buffer[MAX_SIZE]</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">// 由于数组Buffer是从低地址向高地址存放的，如果溢出了就会覆盖掉security_cookie，</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">// 在函数执行的最后快要返回时，判断一下这个变量security_cookie的值是否被覆盖，</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">// 所以金丝雀可以用来检查缓冲区是否溢出。（https://www.kn0sky.com/?p=66）</span></span><br><span class="line">.text:<span class="number">0042</span>D2CF                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D2D4                 mov     [ebp+var_JinSiQue], eax</span><br><span class="line">.text:<span class="number">0042</span>D2D7                 mov     eax, [ebp+ExceptionFrame]</span><br><span class="line">.text:<span class="number">0042</span>D2DA                 mov     [ebp+var_ExceptionFrame], eax</span><br><span class="line">.text:<span class="number">0042</span>D2E0                 mov     ebx, [ebp+TrapFrame]</span><br><span class="line">.text:<span class="number">0042</span>D2E3                 mov     [ebp+BugCheckParameter3], ebx</span><br><span class="line">.text:<span class="number">0042</span>D2E9                 test    byte ptr [ebx+(_KTRAP_FRAME.EFlags+<span class="number">2</span>)], <span class="number">2</span> <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D2E9                                         <span class="comment">// 拿Eflag的高2字节的同 0010 做比较</span></span><br><span class="line">.text:<span class="number">0042</span>D2E9                                         <span class="comment">// 判断是否是虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0042</span>D2E9                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D2ED                 jnz     loc_42D43D      <span class="comment">// 虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0042</span>D2F3                 mov     [ebp+var_2E8], <span class="number">10017</span>h</span><br><span class="line">.text:<span class="number">0042</span>D2FD                 lea     ecx, [ebp+var_2E8] <span class="comment">// ContextRecord</span></span><br><span class="line">.text:<span class="number">0042</span>D303                 push    ecx             <span class="comment">// 一个局部变量的地址</span></span><br><span class="line">.text:<span class="number">0042</span>D304                 push    eax             <span class="comment">// ExceptionFrame</span></span><br><span class="line">.text:<span class="number">0042</span>D305                 push    ebx             <span class="comment">// TrapFrame</span></span><br><span class="line">.text:<span class="number">0042</span>D306                 call    _KeContextFromKframes@<span class="number">12</span> <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">// VOID __stdcall KeContextFromKframes (</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">//     IN PKTRAP_FRAME TrapFrame,</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">//     IN PKEXCEPTION_FRAME ExceptionFrame,</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">//     IN OUT PCONTEXT ContextRecord</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">// 可以看到根本没有使用到 ebp+0xC，即没有使用到ExceptionFrame</span></span><br><span class="line">.text:<span class="number">0042</span>D306                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D30B <span class="comment">//   __try &#123; // __except at loc_42D410</span></span><br><span class="line">.text:<span class="number">0042</span>D30B                 <span class="keyword">and</span>     [ebp+ms_exc.registration.TryLevel], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0042</span>D30F                 mov     eax, <span class="number">2</span>DCh</span><br><span class="line">.text:<span class="number">0042</span>D314                 mov     [ebp+var_2F8], eax <span class="comment">// var_2F8 =0x2DC</span></span><br><span class="line">.text:<span class="number">0042</span>D31A                 mov     esi, [ebp+var_224] <span class="comment">// esi = esp3</span></span><br><span class="line">.text:<span class="number">0042</span>D320                 <span class="keyword">and</span>     esi, <span class="number">0F</span>FFFFFFCh <span class="comment">// 4字节对齐</span></span><br><span class="line">.text:<span class="number">0042</span>D323                 sub     esi, eax        <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">// esp3 = esp3 - 0x2DC，现在的esp3已经抬高</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">// sizeof(CONTEXT) +0x10 == 0x2DC</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">// 这里0x10为：</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">// //APC Parameter structure.</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">// typedef struct _KAPC_RECORD &#123;</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">//     PKNORMAL_ROUTINE NormalRoutine//</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">//     PVOID NormalContext//</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">//     PVOID SystemArgument1//</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">//     PVOID SystemArgument2//</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">// &#125; KAPC_RECORD, *PKAPC_RECORD//</span></span><br><span class="line">.text:<span class="number">0042</span>D323                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D325                 mov     [ebp+var_2EC], esi</span><br><span class="line">.text:<span class="number">0042</span>D32B                 push    <span class="number">4</span>               <span class="comment">// Alignment</span></span><br><span class="line">.text:<span class="number">0042</span>D32D                 push    eax             <span class="comment">// Length</span></span><br><span class="line">.text:<span class="number">0042</span>D32E                 push    esi             <span class="comment">// Address</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                 call    _ProbeForWrite@<span class="number">12</span> <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                                         <span class="comment">// void ProbeForWrite_(PVOID Address, ULONG Length, ULONG Alignment)</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                                         <span class="comment">// 判断指定长度的3环缓冲区是否可写、该长度的缓冲区是否已经按参数三指定的字节长度进行对齐。</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                                         <span class="comment">// 参数一只能指向3环的地址，不能用于0环的地址检查。</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                                         <span class="comment">// 如果不可写或者没有按指定字节长度对齐就会抛出异常</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0042</span>D32F                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0042</span>D334                 lea     edi, [esi+<span class="number">10</span>h]  <span class="comment">// 将局部变量CONTEXT结构拷贝到esp3刚开辟的高0x2CC空间中，剩下0x10的空间用于存放参数</span></span><br><span class="line">.text:<span class="number">0042</span>D337                 mov     ecx, <span class="number">0B</span>3h</span><br><span class="line">.text:<span class="number">0042</span>D33C                 lea     esi, [ebp+var_2E8] <span class="comment">// 将数据从0环复制到3环地址空间</span></span><br><span class="line">.text:<span class="number">0042</span>D342                 rep movsd</span><br><span class="line">.text:<span class="number">0042</span>D344                 mov     [ebx+_KTRAP_FRAME.SegCs], <span class="number">1B</span>h <span class="comment">// 开始修改 TrapFrame 段寄存器的值</span></span><br><span class="line">.text:<span class="number">0042</span>D34B                 push    <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">0042</span>D34D                 pop     eax</span><br><span class="line">.text:<span class="number">0042</span>D34E                 mov     [ebx+_KTRAP_FRAME.HardwareSegSs], eax</span><br><span class="line">.text:<span class="number">0042</span>D351                 mov     [ebx+_KTRAP_FRAME.SegDs], eax</span><br><span class="line">.text:<span class="number">0042</span>D354                 mov     [ebx+_KTRAP_FRAME.SegEs], eax</span><br><span class="line">.text:<span class="number">0042</span>D357                 mov     [ebx+_KTRAP_FRAME.SegFs], <span class="number">3B</span>h</span><br><span class="line">.text:<span class="number">0042</span>D35E                 <span class="keyword">and</span>     [ebx+_KTRAP_FRAME.SegGs], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0042</span>D362                 mov     ecx, [ebp+var_228] <span class="comment">// ecx = CONTEXT.EFlags</span></span><br><span class="line">.text:<span class="number">0042</span>D368                 test    ecx, <span class="number">20000</span>h     <span class="comment">// 判断是否是虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0042</span>D36E                 jz      <span class="keyword">short</span> loc_42D388 <span class="comment">// 非虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0042</span>D370                 cmp     byte ptr _KeI386VdmIoplAllowed, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0042</span>D377                 jz      <span class="keyword">short</span> loc_42D388 <span class="comment">// 非虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0042</span>D379                 mov     eax, _KeI386EFlagsAndMaskV86</span><br><span class="line">.text:<span class="number">0042</span>D37E                 <span class="keyword">and</span>     eax, ecx</span><br><span class="line">.text:<span class="number">0042</span>D380                 <span class="keyword">or</span>      eax, _KeI386EFlagsOrMaskV86</span><br><span class="line">.text:<span class="number">0042</span>D386                 jmp     <span class="keyword">short</span> loc_42D396</span><br><span class="line">.text:<span class="number">0042</span>D388 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0042</span>D388</span><br><span class="line">.text:<span class="number">0042</span>D388 loc_42D388:                             <span class="comment">// CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+AE↑j</span></span><br><span class="line">.text:<span class="number">0042</span>D388                                         <span class="comment">// KiInitializeUserApc(x,x,x,x,x,x)+B7↑j</span></span><br><span class="line">.text:<span class="number">0042</span>D388                 <span class="keyword">and</span>     ecx, <span class="number">3E0</span>DD7h    <span class="comment">// 非虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0042</span>D38E                 <span class="keyword">or</span>      ecx, <span class="number">200</span>h</span><br><span class="line">.text:<span class="number">0042</span>D394                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">0042</span>D396</span><br><span class="line">.text:<span class="number">0042</span>D396 loc_42D396:                             <span class="comment">// CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+C6↑j</span></span><br><span class="line">.text:<span class="number">0042</span>D396                 mov     [ebx+_KTRAP_FRAME.EFlags], eax</span><br><span class="line">.text:<span class="number">0042</span>D399                 mov     eax, large fs:<span class="number">124</span>h</span><br><span class="line">.text:<span class="number">0042</span>D39F                 mov     [ebp+var_2FC], eax</span><br><span class="line">.text:<span class="number">0042</span>D3A5                 cmp     [eax+_KTHREAD.Iopl], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0042</span>D3A9                 jz      <span class="keyword">short</span> loc_42D3AF <span class="comment">// eax == 抬升 0x2DC 后的 ESP3</span></span><br><span class="line">.text:<span class="number">0042</span>D3AB                 <span class="keyword">or</span>      byte ptr [ebx+<span class="number">71</span>h], <span class="number">30</span>h <span class="comment">// If thread is supposed to have IOPL, then force it on in eflags</span></span><br><span class="line">.text:<span class="number">0042</span>D3AF</span><br><span class="line">.text:<span class="number">0042</span>D3AF loc_42D3AF:                             <span class="comment">// CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+E9↑j</span></span><br><span class="line">.text:<span class="number">0042</span>D3AF                 mov     eax, [ebp+var_2EC] <span class="comment">// eax == 抬升 0x2DC 后的 ESP3</span></span><br><span class="line">.text:<span class="number">0042</span>D3B5                 mov     [ebx+_KTRAP_FRAME.HardwareEsp], eax <span class="comment">// 修改 _TRAP_FRAME 的 ESP3，修改堆栈位置</span></span><br><span class="line">.text:<span class="number">0042</span>D3B8                 mov     ecx, _KeUserApcDispatcher</span><br><span class="line">.text:<span class="number">0042</span>D3BE                 mov     [ebx+_KTRAP_FRAME._Eip], ecx <span class="comment">// 修改EIP</span></span><br><span class="line">.text:<span class="number">0042</span>D3C1                 <span class="keyword">and</span>     [ebx+_KTRAP_FRAME.ErrCode], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0042</span>D3C5                 mov     ecx, [ebp+NormalRoutine] <span class="comment">// 4个参数入栈</span></span><br><span class="line">.text:<span class="number">0042</span>D3C8                 mov     [eax], ecx</span><br><span class="line">.text:<span class="number">0042</span>D3CA                 push    <span class="number">4</span></span><br><span class="line">.text:<span class="number">0042</span>D3CC                 pop     ecx</span><br><span class="line">.text:<span class="number">0042</span>D3CD                 add     eax, ecx</span><br><span class="line">.text:<span class="number">0042</span>D3CF                 mov     [ebp+var_2EC], eax</span><br><span class="line">.text:<span class="number">0042</span>D3D5                 mov     edx, [ebp+NormalContext]</span><br><span class="line">.text:<span class="number">0042</span>D3D8                 mov     [eax], edx</span><br><span class="line">.text:<span class="number">0042</span>D3DA                 add     eax, ecx</span><br><span class="line">.text:<span class="number">0042</span>D3DC                 mov     [ebp+var_2EC], eax</span><br><span class="line">.text:<span class="number">0042</span>D3E2                 mov     edx, [ebp+SystemArgument1]</span><br><span class="line">.text:<span class="number">0042</span>D3E5                 mov     [eax], edx</span><br><span class="line">.text:<span class="number">0042</span>D3E7                 add     eax, ecx</span><br><span class="line">.text:<span class="number">0042</span>D3E9                 mov     [ebp+var_2EC], eax</span><br><span class="line">.text:<span class="number">0042</span>D3EF                 mov     edx, [ebp+SystemArgument2]</span><br><span class="line">.text:<span class="number">0042</span>D3F2                 mov     [eax], edx</span><br><span class="line">.text:<span class="number">0042</span>D3F4                 add     eax, ecx</span><br><span class="line">.text:<span class="number">0042</span>D3F6                 mov     [ebp+var_2EC], eax</span><br><span class="line">.text:<span class="number">0042</span>D3FC                 jmp     <span class="keyword">short</span> loc_42D439</span><br><span class="line">.text:<span class="number">0042</span>D3FE <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0042</span>D3FE</span><br><span class="line">.text:<span class="number">0042</span>D3FE loc_42D3FE:                             <span class="comment">// DATA XREF: .text:stru_402AC0↑o</span></span><br><span class="line">.text:<span class="number">0042</span>D3FE <span class="comment">//   __except filter // owned by 42D30B</span></span><br><span class="line">.text:<span class="number">0042</span>D3FE                 mov     eax, [ebp+ms_exc.exc_ptr]</span><br><span class="line">.text:<span class="number">0042</span>D401                 push    dword ptr [eax]</span><br><span class="line">.text:<span class="number">0042</span>D403                 lea     eax, [ebp+ExceptionRecord]</span><br><span class="line">.text:<span class="number">0042</span>D409                 push    eax</span><br><span class="line">.text:<span class="number">0042</span>D40A                 call    _KiCopyInformation@<span class="number">8</span> <span class="comment">// KiCopyInformation(x,x)</span></span><br><span class="line">.text:<span class="number">0042</span>D40F                 retn</span><br><span class="line">.text:<span class="number">0042</span>D410 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0042</span>D410</span><br><span class="line">.text:<span class="number">0042</span>D410 loc_42D410:                             <span class="comment">// DATA XREF: .text:stru_402AC0↑o</span></span><br><span class="line">.text:<span class="number">0042</span>D410 <span class="comment">//   __except(loc_42D3FE) // owned by 42D30B</span></span><br><span class="line">.text:<span class="number">0042</span>D410                 mov     esp, [ebp+ms_exc.old_esp]</span><br><span class="line">.text:<span class="number">0042</span>D413                 mov     eax, [ebp+BugCheckParameter3]</span><br><span class="line">.text:<span class="number">0042</span>D419                 mov     ecx, [eax+<span class="number">68</span>h]</span><br><span class="line">.text:<span class="number">0042</span>D41C                 mov     [ebp+ExceptionRecord.ExceptionAddress], ecx</span><br><span class="line">.text:<span class="number">0042</span>D422                 push    <span class="number">1</span>               <span class="comment">// char</span></span><br><span class="line">.text:<span class="number">0042</span>D424                 push    <span class="number">1</span>               <span class="comment">// int</span></span><br><span class="line">.text:<span class="number">0042</span>D426                 push    eax             <span class="comment">// BugCheckParameter3</span></span><br><span class="line">.text:<span class="number">0042</span>D427                 push    [ebp+var_ExceptionFrame] <span class="comment">// int</span></span><br><span class="line">.text:<span class="number">0042</span>D42D                 lea     eax, [ebp+ExceptionRecord]</span><br><span class="line">.text:<span class="number">0042</span>D433                 push    eax             <span class="comment">// ExceptionRecord</span></span><br><span class="line">.text:<span class="number">0042</span>D434                 call    _KiDispatchException@<span class="number">20</span> <span class="comment">// KiDispatchException(x,x,x,x,x)</span></span><br><span class="line">.text:<span class="number">0042</span>D434 <span class="comment">//   &#125; // starts at 42D30B</span></span><br><span class="line">.text:<span class="number">0042</span>D439</span><br><span class="line">.text:<span class="number">0042</span>D439 loc_42D439:                             <span class="comment">// CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+13C↑j</span></span><br><span class="line">.text:<span class="number">0042</span>D439                 <span class="keyword">or</span>      [ebp+ms_exc.registration.TryLevel], <span class="number">0F</span>FFFFFFFh</span><br><span class="line">.text:<span class="number">0042</span>D43D</span><br><span class="line">.text:<span class="number">0042</span>D43D loc_42D43D:                             <span class="comment">// CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+2D↑j</span></span><br><span class="line">.text:<span class="number">0042</span>D43D                 mov     ecx, [ebp+var_JinSiQue] <span class="comment">// 虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0042</span>D440                 call    @xHalReferenceHandler@<span class="number">4</span> <span class="comment">// xHalReferenceHandler(x)</span></span><br><span class="line">.text:<span class="number">0042</span>D445                 call    __SEH_epilog</span><br><span class="line">.text:<span class="number">0042</span>D44A                 retn    <span class="number">18</span>h</span><br><span class="line">.text:<span class="number">0042</span>D44A <span class="comment">// &#125; // starts at 42D2C0</span></span><br><span class="line">.text:<span class="number">0042</span>D44A _KiInitializeUserApc@<span class="number">24</span> endp</span><br><span class="line">.text:<span class="number">0042</span>D44A</span><br><span class="line">.text:<span class="number">0042</span>D44A <span class="comment">// ---------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>





<h2 id="6-KeContextFromKframes"><a href="#6-KeContextFromKframes" class="headerlink" title="6 KeContextFromKframes"></a>6 KeContextFromKframes</h2><p><code>KeContextFromKframes</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">KeContextFromKframes</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKTRAP_FRAME TrapFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKEXCEPTION_FRAME ExceptionFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN OUT PCONTEXT ContextFrame</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="function"><span class="comment">Routine Description:</span></span></span><br><span class="line"><span class="function"><span class="comment">    This routine moves the selected contents of the specified trap and exception frames</span></span></span><br><span class="line"><span class="function"><span class="comment">    frames into the specified context frame according to the specified context flags.</span></span></span><br><span class="line"><span class="function"><span class="comment">Arguments:</span></span></span><br><span class="line"><span class="function"><span class="comment">    TrapFrame - Supplies a pointer to a trap frame from which volatile context</span></span></span><br><span class="line"><span class="function"><span class="comment">        should be copied into the context record.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame from which context</span></span></span><br><span class="line"><span class="function"><span class="comment">        should be copied into the context record. This argument is ignored since</span></span></span><br><span class="line"><span class="function"><span class="comment">        there is no exception frame on NT386.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ContextFrame - Supplies a pointer to the context frame that receives the</span></span></span><br><span class="line"><span class="function"><span class="comment">        context copied from the trap and exception frames.</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">Return Value: None.</span></span></span><br><span class="line"><span class="function"><span class="comment">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    PFX_SAVE_AREA NpxFrame;</span><br><span class="line">    BOOLEAN StateSaved;</span><br><span class="line">    ULONG i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">FPSaveBuffer</span> &#123;</span></span><br><span class="line">        UCHAR               Buffer[<span class="number">15</span>];</span><br><span class="line">        FLOATING_SAVE_AREA  SaveArea;</span><br><span class="line">    &#125; FloatSaveBuffer;</span><br><span class="line">    PFLOATING_SAVE_AREA PSaveArea;</span><br><span class="line"></span><br><span class="line">    UNREFERENCED_PARAMETER( ExceptionFrame );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set control information if specified.</span></span><br><span class="line">    <span class="keyword">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_CONTROL) == CONTEXT_CONTROL) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set registers ebp, eip, cs, eflag, esp and ss.</span></span><br><span class="line">        ContextFrame-&gt;Ebp = TrapFrame-&gt;Ebp;</span><br><span class="line">        ContextFrame-&gt;Eip = TrapFrame-&gt;Eip;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (((TrapFrame-&gt;SegCs &amp; FRAME_EDITED) == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">            ((TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK) == <span class="number">0</span>)) &#123;</span><br><span class="line">            ContextFrame-&gt;SegCs = TrapFrame-&gt;TempSegCs &amp; SEGMENT_MASK;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ContextFrame-&gt;SegCs = TrapFrame-&gt;SegCs &amp; SEGMENT_MASK;</span><br><span class="line">        &#125;</span><br><span class="line">        ContextFrame-&gt;EFlags = TrapFrame-&gt;EFlags;</span><br><span class="line">        ContextFrame-&gt;SegSs = KiSegSsFromTrapFrame(TrapFrame);</span><br><span class="line">        ContextFrame-&gt;Esp = KiEspFromTrapFrame(TrapFrame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set segment register contents if specified.</span></span><br><span class="line">    <span class="keyword">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_SEGMENTS) == CONTEXT_SEGMENTS) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set segment registers gs, fs, es, ds.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// These values are junk most of the time, but useful</span></span><br><span class="line">        <span class="comment">// for debugging under certain conditions.  Therefore,</span></span><br><span class="line">        <span class="comment">// we report whatever was in the frame.</span></span><br><span class="line">        <span class="keyword">if</span> (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK) &#123;</span><br><span class="line">            ContextFrame-&gt;SegGs = TrapFrame-&gt;V86Gs &amp; SEGMENT_MASK;</span><br><span class="line">            ContextFrame-&gt;SegFs = TrapFrame-&gt;V86Fs &amp; SEGMENT_MASK;</span><br><span class="line">            ContextFrame-&gt;SegEs = TrapFrame-&gt;V86Es &amp; SEGMENT_MASK;</span><br><span class="line">            ContextFrame-&gt;SegDs = TrapFrame-&gt;V86Ds &amp; SEGMENT_MASK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (TrapFrame-&gt;SegCs == KGDT_R0_CODE) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Trap frames created from R0_CODE traps do not save</span></span><br><span class="line">                <span class="comment">// the following selectors.  Set them in the frame now.</span></span><br><span class="line">                TrapFrame-&gt;SegGs = <span class="number">0</span>;</span><br><span class="line">                TrapFrame-&gt;SegFs = KGDT_R0_PCR;</span><br><span class="line">                TrapFrame-&gt;SegEs = KGDT_R3_DATA | RPL_MASK;</span><br><span class="line">                TrapFrame-&gt;SegDs = KGDT_R3_DATA | RPL_MASK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ContextFrame-&gt;SegGs = TrapFrame-&gt;SegGs &amp; SEGMENT_MASK;</span><br><span class="line">            ContextFrame-&gt;SegFs = TrapFrame-&gt;SegFs &amp; SEGMENT_MASK;</span><br><span class="line">            ContextFrame-&gt;SegEs = TrapFrame-&gt;SegEs &amp; SEGMENT_MASK;</span><br><span class="line">            ContextFrame-&gt;SegDs = TrapFrame-&gt;SegDs &amp; SEGMENT_MASK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set integer register contents if specified.</span></span><br><span class="line">    <span class="keyword">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_INTEGER) == CONTEXT_INTEGER) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set integer registers edi, esi, ebx, edx, ecx, eax</span></span><br><span class="line">        ContextFrame-&gt;Edi = TrapFrame-&gt;Edi;</span><br><span class="line">        ContextFrame-&gt;Esi = TrapFrame-&gt;Esi;</span><br><span class="line">        ContextFrame-&gt;Ebx = TrapFrame-&gt;Ebx;</span><br><span class="line">        ContextFrame-&gt;Ecx = TrapFrame-&gt;Ecx;</span><br><span class="line">        ContextFrame-&gt;Edx = TrapFrame-&gt;Edx;</span><br><span class="line">        ContextFrame-&gt;Eax = TrapFrame-&gt;Eax;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((ContextFrame-&gt;ContextFlags &amp; CONTEXT_EXTENDED_REGISTERS) ==</span><br><span class="line">        CONTEXT_EXTENDED_REGISTERS) &amp;&amp;</span><br><span class="line">        ((TrapFrame-&gt;SegCs &amp; MODE_MASK) == UserMode)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the base TrapFrame, and the NpxFrame is on the base</span></span><br><span class="line">        <span class="comment">// of the kernel stack, just above it in memory.</span></span><br><span class="line">        NpxFrame = (PFX_SAVE_AREA)(TrapFrame + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (KeI386NpxPresent) &#123;</span><br><span class="line">            KiFlushNPXState (<span class="literal">NULL</span>);</span><br><span class="line">            RtlCopyMemory( (PVOID)&amp;(ContextFrame-&gt;ExtendedRegisters[<span class="number">0</span>]),</span><br><span class="line">                           (PVOID)&amp;(NpxFrame-&gt;U.FxArea),                    </span><br><span class="line">                           MAXIMUM_SUPPORTED_EXTENSION</span><br><span class="line">                         );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetch floating register contents if requested, and type of target</span></span><br><span class="line">    <span class="comment">// is user.  (system frames have no fp state, so ignore request)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_FLOATING_POINT) ==</span><br><span class="line">          CONTEXT_FLOATING_POINT) &amp;&amp;</span><br><span class="line">         ((TrapFrame-&gt;SegCs &amp; MODE_MASK) == UserMode)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the base TrapFrame, and the NpxFrame is on the base</span></span><br><span class="line">        <span class="comment">// of the kernel stack, just above it in memory.</span></span><br><span class="line">        NpxFrame = (PFX_SAVE_AREA)(TrapFrame + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (KeI386NpxPresent) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Force the coprocessors state to the save area and copy it</span></span><br><span class="line">            <span class="comment">// to the context frame.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (KeI386FxsrPresent == TRUE) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// FP state save was done using fxsave. Get the save</span></span><br><span class="line">                <span class="comment">// area in fnsave format</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Save area must be 16 byte aligned so we cushion it with</span></span><br><span class="line">                <span class="comment">// 15 bytes (in the locals declaration above) and round</span></span><br><span class="line">                <span class="comment">// down to align.</span></span><br><span class="line"></span><br><span class="line">                ULONG_PTR Temp;</span><br><span class="line">                Temp = (ULONG_PTR)&amp;FloatSaveBuffer.SaveArea;</span><br><span class="line">                Temp &amp;= ~<span class="number">0xf</span>;</span><br><span class="line">                PSaveArea = (PFLOATING_SAVE_AREA)Temp;</span><br><span class="line">                KiFlushNPXState (PSaveArea);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                PSaveArea = (PFLOATING_SAVE_AREA)&amp;(NpxFrame-&gt;U.FnArea);</span><br><span class="line">                KiFlushNPXState (<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ContextFrame-&gt;FloatSave.ControlWord   = PSaveArea-&gt;ControlWord;</span><br><span class="line">            ContextFrame-&gt;FloatSave.StatusWord    = PSaveArea-&gt;StatusWord;</span><br><span class="line">            ContextFrame-&gt;FloatSave.TagWord       = PSaveArea-&gt;TagWord;</span><br><span class="line">            ContextFrame-&gt;FloatSave.ErrorOffset   = PSaveArea-&gt;ErrorOffset;</span><br><span class="line">            ContextFrame-&gt;FloatSave.ErrorSelector = PSaveArea-&gt;ErrorSelector;</span><br><span class="line">            ContextFrame-&gt;FloatSave.DataOffset    = PSaveArea-&gt;DataOffset;</span><br><span class="line">            ContextFrame-&gt;FloatSave.DataSelector  = PSaveArea-&gt;DataSelector;</span><br><span class="line">            ContextFrame-&gt;FloatSave.Cr0NpxState   = NpxFrame-&gt;Cr0NpxState;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; SIZE_OF_80387_REGISTERS; i++) &#123;</span><br><span class="line">                ContextFrame-&gt;FloatSave.RegisterArea[i] = PSaveArea-&gt;RegisterArea[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The 80387 is being emulated by the R3 emulator.</span></span><br><span class="line">            <span class="comment">// ** The only time the Npx state is ever obtained or set is</span></span><br><span class="line">            <span class="comment">// ** for userlevel handling.  Current Irql must be 0 or 1.</span></span><br><span class="line">            <span class="comment">// Go slurp the emulator&#x27;s R3 data and generate the floating point context</span></span><br><span class="line">            StateSaved = KiEm87StateToNpxFrame(&amp;ContextFrame-&gt;FloatSave);</span><br><span class="line">            <span class="keyword">if</span> (StateSaved) &#123;</span><br><span class="line">                ContextFrame-&gt;FloatSave.Cr0NpxState = NpxFrame-&gt;Cr0NpxState;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// The floatingpoint state can not be determined.</span></span><br><span class="line">                <span class="comment">// Remove the floatingpoint flag from the context frame flags.</span></span><br><span class="line">                ContextFrame-&gt;ContextFlags &amp;= (~CONTEXT_FLOATING_POINT) | CONTEXT_i386;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetch Dr register contents if requested.  Values may be trash.</span></span><br><span class="line">    <span class="keyword">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_DEBUG_REGISTERS) ==</span><br><span class="line">        CONTEXT_DEBUG_REGISTERS) &#123;</span><br><span class="line"></span><br><span class="line">        ContextFrame-&gt;Dr0 = TrapFrame-&gt;Dr0;</span><br><span class="line">        ContextFrame-&gt;Dr1 = TrapFrame-&gt;Dr1;</span><br><span class="line">        ContextFrame-&gt;Dr2 = TrapFrame-&gt;Dr2;</span><br><span class="line">        ContextFrame-&gt;Dr3 = TrapFrame-&gt;Dr3;</span><br><span class="line">        ContextFrame-&gt;Dr6 = TrapFrame-&gt;Dr6;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If it&#x27;s a user mode frame, and the thread doesn&#x27;t have DRs set,</span></span><br><span class="line">        <span class="comment">// and we just return the trash in the frame, we risk accidentally</span></span><br><span class="line">        <span class="comment">// making the thread active with trash values on a set.  Therefore,</span></span><br><span class="line">        <span class="comment">// Dr7 must be set to 0 if we get a non-active user mode frame.</span></span><br><span class="line">        <span class="keyword">if</span> ((((TrapFrame-&gt;SegCs &amp; MODE_MASK) != KernelMode) ||</span><br><span class="line">            ((TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK) != <span class="number">0</span>)) &amp;&amp;</span><br><span class="line">            (KeGetCurrentThread()-&gt;DebugActive == TRUE)) &#123;</span><br><span class="line"></span><br><span class="line">            ContextFrame-&gt;Dr7 = TrapFrame-&gt;Dr7;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            ContextFrame-&gt;Dr7 = <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="KiUserApcDispatcher"><a href="#KiUserApcDispatcher" class="headerlink" title="KiUserApcDispatcher"></a>KiUserApcDispatcher</h2><p>在<code>ntdll.ll</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">7</span>C92E430 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430 <span class="comment">// __stdcall KiUserApcDispatcher(x, x, x, x, x)</span></span><br><span class="line">.text:<span class="number">7</span>C92E430                 <span class="keyword">public</span> _KiUserApcDispatcher@<span class="number">20</span></span><br><span class="line">.text:<span class="number">7</span>C92E430 _KiUserApcDispatcher@<span class="number">20</span> proc near       <span class="comment">// DATA XREF: .text:off_7C923428↑o</span></span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430 arg_C           = byte ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430                 lea     edi, [esp+arg_C]</span><br><span class="line">.text:<span class="number">7</span>C92E434                 pop     eax</span><br><span class="line">.text:<span class="number">7</span>C92E435                 call    eax</span><br><span class="line">.text:<span class="number">7</span>C92E437                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">7</span>C92E439                 push    edi             <span class="comment">// 在3环函数中保存的 CONTEXT 的首地址</span></span><br><span class="line">.text:<span class="number">7</span>C92E43A                 call    _ZwContinue@<span class="number">8</span>   <span class="comment">// ZwContinue(x,x)</span></span><br><span class="line">.text:<span class="number">7</span>C92E43F                 nop</span><br><span class="line">.text:<span class="number">7</span>C92E43F _KiUserApcDispatcher@<span class="number">20</span> endp <span class="comment">// sp-analysis failed</span></span><br><span class="line">.text:<span class="number">7</span>C92E43F</span><br></pre></td></tr></table></figure>



<h2 id="R3-ZwContinue"><a href="#R3-ZwContinue" class="headerlink" title="R3 ZwContinue"></a>R3 ZwContinue</h2><p>在<code>ntdll.ll</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">7</span>C92D040 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">7</span>C92D040</span><br><span class="line">.text:<span class="number">7</span>C92D040</span><br><span class="line">.text:<span class="number">7</span>C92D040 <span class="comment">// __stdcall ZwContinue(x, x)</span></span><br><span class="line">.text:<span class="number">7</span>C92D040                 <span class="keyword">public</span> _ZwContinue@<span class="number">8</span></span><br><span class="line">.text:<span class="number">7</span>C92D040 _ZwContinue@<span class="number">8</span>   proc near               <span class="comment">// CODE XREF: KiUserApcDispatcher(x,x,x,x,x)+A↓p</span></span><br><span class="line">.text:<span class="number">7</span>C92D040                                         <span class="comment">// KiUserExceptionDispatcher(x,x)+17↓p ...</span></span><br><span class="line">.text:<span class="number">7</span>C92D040                 mov     eax, <span class="number">20</span>h        <span class="comment">// NtContinue</span></span><br><span class="line">.text:<span class="number">7</span>C92D045                 mov     edx, <span class="number">7F</span>FE0300h</span><br><span class="line">.text:<span class="number">7</span>C92D04A                 call    dword ptr [edx]</span><br><span class="line">.text:<span class="number">7</span>C92D04C                 retn    <span class="number">8</span></span><br><span class="line">.text:<span class="number">7</span>C92D04C _ZwContinue@<span class="number">8</span>   endp</span><br><span class="line">.text:<span class="number">7</span>C92D04C</span><br><span class="line">.text:<span class="number">7</span>C92D04C <span class="comment">// ---------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>





<h2 id="R0-NtContinue"><a href="#R0-NtContinue" class="headerlink" title="R0 NtContinue"></a>R0 NtContinue</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C</span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// ==========</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 在KiFastCallEntry进入当前函数之前：</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 1、esp 指向拷贝过来的3环API的第一个参数（此时在本函数中的esp指向返回地址）</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 2、ebp = _KTRAP_FRAME首地址</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 3、ebx = 系统服务函数地址</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 4、edx：指向3环 API 的第一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 5、eax = 系统服务号的低 12 位</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 6、esi == edi = 指向拷贝过来的3环API的最后一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// ==========</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// 参数Context为上一个用户APC函数的Context起始地址</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// TestAlert：3环传来的是 1</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// Attributes: bp-based frame</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C</span><br><span class="line">.text:<span class="number">0046</span>DE6C <span class="comment">// NTSTATUS __stdcall NtContinue(PCONTEXT Context, BOOLEAN TestAlert)</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C _NtContinue@<span class="number">8</span>   proc near               <span class="comment">// DATA XREF: .text:0042D4D0↑o</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C</span><br><span class="line">.text:<span class="number">0046</span>DE6C var_s0          = dword ptr  <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C Context         = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0046</span>DE6C TestAlert       = byte ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>DE6C arg_34          = dword ptr  <span class="number">3</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>DE6C</span><br><span class="line">.text:<span class="number">0046</span>DE6C                 push    ebp</span><br><span class="line">.text:<span class="number">0046</span>DE6D                 mov     ebx, large fs:<span class="number">124</span>h <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>DE6D                                         <span class="comment">// 从3环进来是走 KiFastEntry</span></span><br><span class="line">.text:<span class="number">0046</span>DE6D                                         <span class="comment">// 此时的 ebp 指向3环的 trapflame 首地址</span></span><br><span class="line">.text:<span class="number">0046</span>DE6D                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>DE74                 mov     edx, [ebp+_KTRAP_FRAME._Edx]</span><br><span class="line">.text:<span class="number">0046</span>DE77                 mov     [ebx+_KTHREAD.TrapFrame], edx</span><br><span class="line">.text:<span class="number">0046</span>DE7D                 mov     ebp, esp        <span class="comment">// 指向 Old_TrapFrame</span></span><br><span class="line">.text:<span class="number">0046</span>DE7F                 mov     eax, [ebp+var_s0]</span><br><span class="line">.text:<span class="number">0046</span>DE82                 mov     ecx, [ebp+Context] <span class="comment">// 这里是没有毛病的</span></span><br><span class="line">.text:<span class="number">0046</span>DE85                 push    eax             <span class="comment">// eax 为Old_Trapframe地址</span></span><br><span class="line">.text:<span class="number">0046</span>DE86                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>DE88                 push    ecx</span><br><span class="line">.text:<span class="number">0046</span>DE89                 call    _KiContinue@<span class="number">12</span>  <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">// NTSTATUS KiContinue (</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">//     IN PCONTEXT ContextRecord,</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">//     IN PKEXCEPTION_FRAME ExceptionFrame,</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">//     IN PKTRAP_FRAME TrapFrame</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">// Move information from ContextFrame to TrapFrame according to the</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">// specified context flags In APC_LEVEL.</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">// 实际是恢复到正常调用时的TrapFrame状态</span></span><br><span class="line">.text:<span class="number">0046</span>DE89                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>DE8E                 <span class="keyword">or</span>      eax, eax</span><br><span class="line">.text:<span class="number">0046</span>DE90                 jnz     <span class="keyword">short</span> loc_46DEAC <span class="comment">// KiContinue函数调用失败，紧接着调用KiServiceExit</span></span><br><span class="line">.text:<span class="number">0046</span>DE92                 cmp     [ebp+TestAlert], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>DE96                 jz      <span class="keyword">short</span> loc_46DEA4 <span class="comment">// TestAlert == 0</span></span><br><span class="line">.text:<span class="number">0046</span>DE98                 mov     al, [ebx+_KTHREAD.PreviousMode]</span><br><span class="line">.text:<span class="number">0046</span>DE9E                 push    eax             <span class="comment">// eax == 1</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                 call    _KeTestAlertThread@<span class="number">4</span> <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">// BOOLEAN __stdcall KeTestAlertThread (</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">//     IN KPROCESSOR_MODE AlertMode</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">// 如果吵醒模式AlertMode == 1，并且用户APC队列不为空，</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">// 那就设置 Thread-&gt;ApcState.UserApcPending = TRUE 然后交付下一个用户APC</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">// 【检查该线程是否可以交付另一个用户模式的APC】</span></span><br><span class="line">.text:<span class="number">0046</span>DE9F                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>DEA4</span><br><span class="line">.text:<span class="number">0046</span>DEA4 loc_46DEA4:                             <span class="comment">// CODE XREF: NtContinue(x,x)+2A↑j</span></span><br><span class="line">.text:<span class="number">0046</span>DEA4                 pop     ebp             <span class="comment">// TestAlert == 0</span></span><br><span class="line">.text:<span class="number">0046</span>DEA5                 mov     esp, ebp</span><br><span class="line">.text:<span class="number">0046</span>DEA7                 jmp     _KiServiceExit2</span><br><span class="line">.text:<span class="number">0046</span>DEAC <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>DEAC</span><br><span class="line">.text:<span class="number">0046</span>DEAC loc_46DEAC:                             <span class="comment">// CODE XREF: NtContinue(x,x)+24↑j</span></span><br><span class="line">.text:<span class="number">0046</span>DEAC                 pop     ebp             <span class="comment">// KiContinue函数调用失败，紧接着调用KiServiceExit</span></span><br><span class="line">.text:<span class="number">0046</span>DEAD                 mov     esp, ebp</span><br><span class="line">.text:<span class="number">0046</span>DEAF                 jmp     _KiServiceExit  <span class="comment">// 可以看到这个函数是 KiFastCallEntry 函数的一部分，紧接着这个函数的</span></span><br><span class="line">.text:<span class="number">0046</span>DEAF _NtContinue@<span class="number">8</span>   endp</span><br></pre></td></tr></table></figure>



<h2 id="KiSwapThread"><a href="#KiSwapThread" class="headerlink" title="KiSwapThread"></a>KiSwapThread</h2><p>A线程调用SwapContext函数切换到线程B后，B原路返回执行么？分析一下KiSwapThread，直接将当前线程的context复制给下一个线程？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LONG_PTR FASTCALL <span class="title">KiSwapThread</span><span class="params">(VOID)</span></span>;</span><br><span class="line"></span><br><span class="line">Kprcb = fs:[<span class="number">20</span>];	<span class="comment">//局部变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(Kprcb-&gt;NextThread != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Kprcb-&gt;NextThread = <span class="number">0</span>;</span><br><span class="line">  KiSwapContext(Kprcb-&gt;NextThread);</span><br><span class="line">  <span class="comment">//0042C831</span></span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">KiSwapContext(Kprcb-&gt;NextThread)</span><br><span class="line">&#123;</span><br><span class="line">  ebx = Kpcr = fs:[<span class="number">0x1c</span>];	<span class="comment">//KPCR</span></span><br><span class="line">  esi = Kprcb-&gt;NextThread;</span><br><span class="line">  edi = Kprcb.PrcbData.CurrentThread;</span><br><span class="line">  </span><br><span class="line">  Old_CurrentThread = Kpcr.PrcbData.CurrentThread;</span><br><span class="line">  Kprcb.PrcbData.CurrentThread = Kprcb-&gt;NextThread;	<span class="comment">//并不是进行线程切换，此处更新KPRCB的当前线程</span></span><br><span class="line">  </span><br><span class="line">  ecx = KTHREAD.WaitIrql;</span><br><span class="line">  SwapContext();</span><br><span class="line">  <span class="comment">//0046E996</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SwapContext()</span><br><span class="line">&#123;</span><br><span class="line">  NextThread-&gt;State = Running;	<span class="comment">//2</span></span><br><span class="line">  pushf;	<span class="comment">//在线程切换时，会有很多判断操作，势必会影响到标志寄存器的值，这里需要保存一下</span></span><br><span class="line">  push Kpcr.NtTib.ExceptionList;<span class="comment">//仅仅在Windows Server2003中，5.2版本出现的一个字段，位于NtTib+0x08的位置，主要与日志，调式相关的。</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(Kpcr.PrcbData.DpcRoutineActive ! =<span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    KeBugCheck(<span class="number">0xB8</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  Kpcr.DebugActive = NextThread-&gt;DebugActive;</span><br><span class="line">  cli;	<span class="comment">//屏蔽中断</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//开始线程切换的第一步。</span></span><br><span class="line">  <span class="comment">//InitialStack：栈底 KernelStack：栈顶 StackLimit：栈大小</span></span><br><span class="line">  CurrentThread-&gt;KernelStack = esp;	<span class="comment">//保存旧esp</span></span><br><span class="line">  NextThread-&gt;InitialStack -= <span class="number">0x210</span>;	<span class="comment">//在线程Trap_Frame之前有0x210个字节用于存储浮点寄存器相关的内容</span></span><br><span class="line">  Kpcr.NtTib.StackLimit = NextThread-&gt;StackLimit;</span><br><span class="line">  Kpcr.NtTib.StackBase = NextThread-&gt;InitialStack;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//NpxState（浮点寄存器的状态）</span></span><br><span class="line">  TempNum = NextThread-&gt;InitialStack + <span class="number">0x20C</span>;	<span class="comment">//是某个浮点寄存器</span></span><br><span class="line">  NpxState = NextThread-&gt;NpxState;</span><br><span class="line">  NpxState |= (CR0 &amp; <span class="number">0xFFFFFFF1</span>);	<span class="comment">//将Cr0寄存器的TS、EM、MP位清零,判断NpxState有没有浮点支持</span></span><br><span class="line">  NpxState |= TempNum;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(CR0 != NpxState) CR0 = NpxState;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">//此处用来判断是否是虚拟8086模式</span></span><br><span class="line">  <span class="comment">//如果有V86寄存器的话，eax-1Ch刚好指向Eflag寄存器</span></span><br><span class="line">  <span class="keyword">if</span>(*(PULONG)(NextThread-&gt;InitialStack - <span class="number">0x1c</span> != <span class="number">0x20000</span>)	<span class="comment">//不是虚拟8086模式</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//快速调用从3环进入0环后esp0就是指向这里</span></span><br><span class="line">    <span class="comment">//现在栈底指向 TrapFrame.HardwareSegSs</span></span><br><span class="line">    NextThread-&gt;InitialStack -= <span class="number">0x10</span>;	</span><br><span class="line">  &#125;</span><br><span class="line">     </span><br><span class="line">   Tss = Kpcr-&gt;TSS;</span><br><span class="line">   Tss-&gt;esp0 = NextThread-&gt;InitialStack;</span><br><span class="line">   esp = NextThread-&gt;KernelStack;	<span class="comment">//线程切换</span></span><br><span class="line">     </span><br><span class="line">   Kpcr-&gt;NtTib-&gt;Self = NextThread-&gt;Teb;</span><br><span class="line">   sti;</span><br><span class="line">   </span><br><span class="line">   CurrentThread-&gt;IdleSwapBlock = <span class="number">0</span>;</span><br><span class="line">     </span><br><span class="line">   <span class="comment">//判断两个线程是否属于同一个进程</span></span><br><span class="line">   <span class="keyword">if</span>(NextThread-&gt;ApcState-&gt;Process != NextThread-&gt;ApcState-&gt;Process)</span><br><span class="line">   &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在整个线程切换的过程中，两个线程的堆栈是怎么变化的？trapframe、context又是怎样变化的？</p>
<p>线程切换后，EIP没有切换。就只是切换了esp？是的，将当前的esp修改为新线程的InitStack后，就已经切换到新线程了。然后按照新线程堆栈压入的返回地址进行返回，注意这里的堆栈里的返回地址不是trapFrame里面的esp，不要搞混了。</p>
<p><a target="_blank" rel="noopener" href="https://cataloc.gitee.io/blog/2020/04/03/%E5%88%86%E6%9E%90SwapContext/#%E9%81%97%E7%95%99%E9%97%AE%E9%A2%98">分析SwapContext</a></p>
<p>学完APC就去学异常，应该是分发那里不太一样。调试就是异常处理，异常处理只不过是我们提供了一个函数来处理这个异常，调试器不过就是把这个异常传给另外一个进程，让调试器去处理。</p>
<p>调试器就是想方设法让对方程序抛异常，程序一抛异常了就会把异常传回来，如果此时有调试器，先传给调试器，如果没有调试器就把异常传给异常处理程序。</p>
<p>异常和APC几乎一摸一样，异常也分两类，即0环和3环的异常。</p>
<p>两种被动切换：</p>
<p>正在执行的线程如何知道时间片已经用完？</p>
<p>正在执行的线程如何被其他线程抢占执行的？</p>
<p>难道被动切换是：一个正在执行的线程被下了一个BreakPoint？然后当前线程去处理这个BreakPoint？</p>
<p>可以看一下《Windows内核原理与实现》P166</p>
<p>《Windows内核情景分析》P382</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//精况一：线程等待状态 alertble=0 APC不执行</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WIN32_WINNT 0x0400 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID pM)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//SleepEx(3000, TRUE);</span></span><br><span class="line">  Sleep (<span class="number">10000</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ThreadProc执行了 %d\n&quot;</span>,i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  __asm</span><br><span class="line">  &#123;</span><br><span class="line">	  push eax;</span><br><span class="line">	  push ecx;</span><br><span class="line">	  mov ecx,dword ptr ds:[<span class="number">0x7FFE0300</span>];</span><br><span class="line">	  mov eax,<span class="number">0x103</span>;</span><br><span class="line">	  call  ecx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	  pop ecx;</span><br><span class="line">	  pop eax;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//NtTestAlert();</span></span><br><span class="line">  <span class="comment">//SleepEx(3000, TRUE);</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ThreadProc执行了 %d\n&quot;</span>,k);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">ApcProc</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> para)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ApcProc执行了---------------! \n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">ApcProc2</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> para)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ApcProc2执行了---------------! \n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">         </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span>* arg[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DWORD dwRet;</span><br><span class="line">  HANDLE handle=CreateThread(<span class="literal">NULL</span>,<span class="number">0</span>,ThreadProc,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">//注入APC</span></span><br><span class="line">  Sleep(<span class="number">3000</span>);</span><br><span class="line">  dwRet = QueueUserAPC(ApcProc,handle,<span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span>(dwRet &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;插入OK_1 \n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Sleep(3000);</span></span><br><span class="line">  dwRet = QueueUserAPC(ApcProc2, handle, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span>(dwRet &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;插入OK_2 \n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  CloseHandle (handle);</span><br><span class="line">  Sleep (<span class="number">20000</span>);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img data-src="https://s2.loli.net/2022/07/11/dSNnXgorJvMw4Bj.png" alt="555.png"></p>
<h2 id="KiFastCallEntry"><a href="#KiFastCallEntry" class="headerlink" title="KiFastCallEntry"></a>KiFastCallEntry</h2><p>系统调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0046</span>A520</span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">// 从3环函数 KiFastSystemCall 的 sysenter 指令调用</span></span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">// edx = esp3, eax = 0xIndex</span></span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>A520</span><br><span class="line">.text:<span class="number">0046</span>A520 _KiFastCallEntry proc near              <span class="comment">// DATA XREF: KiLoadFastSyscallMachineSpecificRegisters(x)+24↑o</span></span><br><span class="line">.text:<span class="number">0046</span>A520                                         <span class="comment">// _KiTrap01+74↓o</span></span><br><span class="line">.text:<span class="number">0046</span>A520</span><br><span class="line">.text:<span class="number">0046</span>A520 var_B           = byte ptr <span class="number">-0B</span>h</span><br><span class="line">.text:<span class="number">0046</span>A520</span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">// FUNCTION CHUNK AT .text:0046A4ED SIZE 00000026 BYTES</span></span><br><span class="line">.text:<span class="number">0046</span>A520 <span class="comment">// FUNCTION CHUNK AT .text:0046A7C0 SIZE 00000014 BYTES</span></span><br><span class="line">.text:<span class="number">0046</span>A520</span><br><span class="line">.text:<span class="number">0046</span>A520                 mov     ecx, <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">0046</span>A525                 push    <span class="number">30</span>h             <span class="comment">// 开始修改段寄存器为0环的值</span></span><br><span class="line">.text:<span class="number">0046</span>A527                 pop     fs              <span class="comment">// fs = 0x30</span></span><br><span class="line">.text:<span class="number">0046</span>A529                 mov     ds, ecx</span><br><span class="line">.text:<span class="number">0046</span>A52B                 mov     es, ecx</span><br><span class="line">.text:<span class="number">0046</span>A52D                 mov     ecx, large fs:_KPCR.TSS</span><br><span class="line">.text:<span class="number">0046</span>A534                 mov     esp, [ecx+<span class="number">4</span>]    <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>A534                                         <span class="comment">// esp = TSS.esp0，切换到0环堆栈</span></span><br><span class="line">.text:<span class="number">0046</span>A534                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A534                                         <span class="comment">// TSS.esp0 指向当前线程 TrapFrame 0x7C V86ES</span></span><br><span class="line">.text:<span class="number">0046</span>A534                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A534                                         <span class="comment">// 从这里可以知道 KiFastEntry 的函数堆栈即为当前线程的 TrapFrame</span></span><br><span class="line">.text:<span class="number">0046</span>A534                                         <span class="comment">// 下面开始从 HardwareSegss 开始填充 TrapFrame （当前函数堆栈）</span></span><br><span class="line">.text:<span class="number">0046</span>A534                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>A537                 push    <span class="number">23</span>h             <span class="comment">// HardwareSegSs = 0x23</span></span><br><span class="line">.text:<span class="number">0046</span>A539                 push    edx             <span class="comment">// HardwareSegEsp = esp3 == 3环的第二个返回地址</span></span><br><span class="line">.text:<span class="number">0046</span>A53A                 pushf</span><br><span class="line">.text:<span class="number">0046</span>A53B</span><br><span class="line">.text:<span class="number">0046</span>A53B loc_46A53B:                             <span class="comment">// CODE XREF: _KiFastCallEntry2+23↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A53B                 push    <span class="number">2</span></span><br><span class="line">.text:<span class="number">0046</span>A53D                 add     edx, <span class="number">8</span>          <span class="comment">// 此时 edx 指向 3 环的第一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>A540                 popf                    <span class="comment">// EFlags = 0x02，即清空0环所有标志位</span></span><br><span class="line">.text:<span class="number">0046</span>A541                 <span class="keyword">or</span>      [esp+<span class="number">0</span>Ch+var_B], <span class="number">2</span> <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A541                                         <span class="comment">// 此时esp 指向 KTRAP_FRAME.EFlags</span></span><br><span class="line">.text:<span class="number">0046</span>A541                                         <span class="comment">// eflag(8~15bit)</span></span><br><span class="line">.text:<span class="number">0046</span>A541                                         <span class="comment">// 将3环 EFlags 的 IF = 1,以响应可屏蔽中断</span></span><br><span class="line">.text:<span class="number">0046</span>A541                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A546                 push    <span class="number">1B</span>h             <span class="comment">// KTRAP_FRAME.SegCs = 0x1B = CS3</span></span><br><span class="line">.text:<span class="number">0046</span>A548                 push    dword ptr ds:<span class="number">0F</span>FDF0304h <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A548                                         <span class="comment">// KTRAP_FRAME.Eip = _KUSER_SHARED_DATA.SystemCallReturn返回地址</span></span><br><span class="line">.text:<span class="number">0046</span>A548                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A548                                         <span class="comment">// 也就是说从 0 环返回 3 环时将会返回到这个函数</span></span><br><span class="line">.text:<span class="number">0046</span>A548                                         <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A54E                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A550                 push    ebp</span><br><span class="line">.text:<span class="number">0046</span>A551                 push    ebx</span><br><span class="line">.text:<span class="number">0046</span>A552                 push    esi</span><br><span class="line">.text:<span class="number">0046</span>A553                 push    edi</span><br><span class="line">.text:<span class="number">0046</span>A554                 mov     ebx, large fs:_KPCR.SelfPcr</span><br><span class="line">.text:<span class="number">0046</span>A55B                 push    <span class="number">3B</span>h             <span class="comment">// _KTRAP_FRAME.SegFs = 0x3B</span></span><br><span class="line">.text:<span class="number">0046</span>A55D                 mov     esi, [ebx+_KPCR.PrcbData.CurrentThread]</span><br><span class="line">.text:<span class="number">0046</span>A563                 push    dword ptr [ebx] <span class="comment">// 保存旧的 ExceptionList</span></span><br><span class="line">.text:<span class="number">0046</span>A565                 mov     dword ptr [ebx], <span class="number">0F</span>FFFFFFFh <span class="comment">// 当前线程ExceptionList = -1</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                 mov     ebp, [esi+_KTHREAD.InitialStack] <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">// ebp = _KPCR._KPRCB._KTHREAD.InitialStack（栈底），KernelStack（栈顶）</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">// 从线程切换分析可以知道：KTHREAD.InitialStack（栈底）指向当前线程的浮点寄存器 共0x210字节</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">// 也就是 KTHREAD 堆栈的是这样的：</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">// - TrapFrame（共0x8c字节） + 浮点寄存器（共0x210字节） == 0x29C</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">// - KTHREAD.InitialStack = 指向 TrapFrame + 浮点寄存器，【栈底】</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A56B                                         <span class="comment">// ----</span></span><br><span class="line">.text:<span class="number">0046</span>A56E                 push    <span class="number">1</span>               <span class="comment">// _KTRAP_FRAME.PreviousPreviousMode = 1，表示从3环来</span></span><br><span class="line">.text:<span class="number">0046</span>A570                 sub     esp, <span class="number">48</span>h        <span class="comment">// esp0 指向_TrapFrame首地址</span></span><br><span class="line">.text:<span class="number">0046</span>A573                 sub     ebp, <span class="number">29</span>Ch       <span class="comment">// esp0 = ebp0 = _KTRAP_FRAME首地址</span></span><br><span class="line">.text:<span class="number">0046</span>A579                 mov     [esi+_KTHREAD.PreviousMode], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A580                 cmp     ebp, esp</span><br><span class="line">.text:<span class="number">0046</span>A582                 jnz     <span class="keyword">short</span> loc_46A511 <span class="comment">// esp0 != ebp0，跳到异常处理即 INT 6，6号异常中断--无效操作码</span></span><br><span class="line">.text:<span class="number">0046</span>A584                 <span class="keyword">and</span>     [ebp+_KTRAP_FRAME.Dr7], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A588                 test    [esi+_KTHREAD.DebugActive], <span class="number">0F</span>Fh</span><br><span class="line">.text:<span class="number">0046</span>A58C                 mov     [esi+_KTHREAD.TrapFrame], ebp <span class="comment">// _KTHREAD.TrapFrame = ebp 存起来</span></span><br><span class="line">.text:<span class="number">0046</span>A592                 jnz     Dr_FastCallDrSave <span class="comment">// DebugActive != -1，就表示被调试，会把cr0-cr7存到TrapFrame结构体中</span></span><br><span class="line">.text:<span class="number">0046</span>A592                                         <span class="comment">// 如果当前的线程处于调试状态，那么这里面的值不为零</span></span><br><span class="line">.text:<span class="number">0046</span>A598</span><br><span class="line">.text:<span class="number">0046</span>A598 loc_46A598:                             <span class="comment">// CODE XREF: Dr_FastCallDrSave+10↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A598                                         <span class="comment">// Dr_FastCallDrSave+7C↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A598                 mov     ebx, [ebp+_KTRAP_FRAME._Ebp] <span class="comment">// ebx == ebp3，但是在本函数内，并没有对ebp3进行赋值处理</span></span><br><span class="line">.text:<span class="number">0046</span>A59B                 mov     edi, [ebp+_KTRAP_FRAME._Eip] <span class="comment">// edi = eip3 == _KUSER_SHARED_DATA.SystemCallReturn</span></span><br><span class="line">.text:<span class="number">0046</span>A59E                 mov     [ebp+_KTRAP_FRAME.DbgArgPointer], edx <span class="comment">// edx 指向 3 环的第一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>A5A1                 mov     [ebp+_KTRAP_FRAME.DbgArgMark], <span class="number">0B</span>ADB0D00h</span><br><span class="line">.text:<span class="number">0046</span>A5A8                 mov     [ebp+_KTRAP_FRAME.DbgEbp], ebx</span><br><span class="line">.text:<span class="number">0046</span>A5AB                 mov     [ebp+_KTRAP_FRAME.DbgEip], edi</span><br><span class="line">.text:<span class="number">0046</span>A5AE                 sti</span><br><span class="line">.text:<span class="number">0046</span>A5AF</span><br><span class="line">.text:<span class="number">0046</span>A5AF loc_46A5AF:                             <span class="comment">// CODE XREF: _KiBBTUnexpectedRange+18↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A5AF                                         <span class="comment">// _KiSystemService+72↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A5AF                 mov     edi, eax        <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A5AF                                         <span class="comment">// 下面开始是 KiSystemService 和 KiFastCallEntry 的汇聚点</span></span><br><span class="line">.text:<span class="number">0046</span>A5AF                                         <span class="comment">// - esp = ebp = _KTRAP_FRAME首地址</span></span><br><span class="line">.text:<span class="number">0046</span>A5AF                                         <span class="comment">// - edx == 指向3环参数</span></span><br><span class="line">.text:<span class="number">0046</span>A5AF                                         <span class="comment">// - eax == 系统服务号</span></span><br><span class="line">.text:<span class="number">0046</span>A5AF                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A5B1                 shr     edi, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0046</span>A5B4                 <span class="keyword">and</span>     edi, <span class="number">30</span>h        <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5B4                                         <span class="comment">// 取系统服务号的 bit12,bit13== 0。</span></span><br><span class="line">.text:<span class="number">0046</span>A5B4                                         <span class="comment">// 即00bit13bit12 xxxx &amp; 0011 0000 == 0001 0000/0000 0000</span></span><br><span class="line">.text:<span class="number">0046</span>A5B4                                         <span class="comment">// 结果为：0x10/0x00</span></span><br><span class="line">.text:<span class="number">0046</span>A5B4                                         <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5B7                 mov     ecx, edi</span><br><span class="line">.text:<span class="number">0046</span>A5B9                 add     edi, [esi+_KTHREAD.ServiceTable] <span class="comment">// 取 SSDT/SSDT Shadow 表</span></span><br><span class="line">.text:<span class="number">0046</span>A5BF                 mov     ebx, eax</span><br><span class="line">.text:<span class="number">0046</span>A5C1                 <span class="keyword">and</span>     eax, <span class="number">0F</span>FFh      <span class="comment">// 取系统服务号的低 12 位，即在SST函数表的索引号</span></span><br><span class="line">.text:<span class="number">0046</span>A5C6                 cmp     eax, [edi+<span class="number">8</span>]    <span class="comment">// 系统调用号 - SST.ServiceLimit，判断函数是否在表的范围内</span></span><br><span class="line">.text:<span class="number">0046</span>A5C9                 jnb     _KiBBTUnexpectedRange <span class="comment">// 系统调用号 &gt;= SST.ServiceLimit，不在表里，跳转异常处理</span></span><br><span class="line">.text:<span class="number">0046</span>A5CF                 cmp     ecx, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0046</span>A5D2                 jnz     <span class="keyword">short</span> loc_46A5EF <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5D2                                         <span class="comment">// 判断系统服务号的函数是ntoskrnl.exe</span></span><br><span class="line">.text:<span class="number">0046</span>A5D2                                         <span class="comment">// 系统调用计数加1，即函数KiFastCallEntry被调用次数++</span></span><br><span class="line">.text:<span class="number">0046</span>A5D2                                         <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5D4                 mov     ecx, large fs:<span class="number">18</span>h</span><br><span class="line">.text:<span class="number">0046</span>A5DB                 <span class="keyword">xor</span>     ebx, ebx</span><br><span class="line">.text:<span class="number">0046</span>A5DD</span><br><span class="line">.text:<span class="number">0046</span>A5DD loc_46A5DD:                             <span class="comment">// DATA XREF: _KiTrap0E+117↓o</span></span><br><span class="line">.text:<span class="number">0046</span>A5DD                 <span class="keyword">or</span>      ebx, [ecx+<span class="number">0F</span>70h]</span><br><span class="line">.text:<span class="number">0046</span>A5E3                 jz      <span class="keyword">short</span> loc_46A5EF <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5E3                                         <span class="comment">// 判断系统服务号的函数是ntoskrnl.exe</span></span><br><span class="line">.text:<span class="number">0046</span>A5E3                                         <span class="comment">// 系统调用计数加1，即函数KiFastCallEntry被调用次数++</span></span><br><span class="line">.text:<span class="number">0046</span>A5E3                                         <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5E5                 push    edx</span><br><span class="line">.text:<span class="number">0046</span>A5E6                 push    eax</span><br><span class="line">.text:<span class="number">0046</span>A5E7                 call    ds:_KeGdiFlushUserBatch</span><br><span class="line">.text:<span class="number">0046</span>A5ED                 pop     eax</span><br><span class="line">.text:<span class="number">0046</span>A5EE                 pop     edx</span><br><span class="line">.text:<span class="number">0046</span>A5EF</span><br><span class="line">.text:<span class="number">0046</span>A5EF loc_46A5EF:                             <span class="comment">// CODE XREF: _KiFastCallEntry+B2↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A5EF                                         <span class="comment">// _KiFastCallEntry+C3↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A5EF                 inc     large dword ptr fs:_KPCR.PrcbData.KeSystemCalls <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5EF                                         <span class="comment">// 判断系统服务号的函数是ntoskrnl.exe</span></span><br><span class="line">.text:<span class="number">0046</span>A5EF                                         <span class="comment">// 系统调用计数加1，即函数KiFastCallEntry被调用次数++</span></span><br><span class="line">.text:<span class="number">0046</span>A5EF                                         <span class="comment">// --</span></span><br><span class="line">.text:<span class="number">0046</span>A5F6                 mov     esi, edx        <span class="comment">// edx 指向3环 API 的第一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>A5F8                 mov     ebx, [edi+<span class="number">0</span>Ch]  <span class="comment">// ebx 指向 SST 的参数表，ebx = SST.ArgmentTable</span></span><br><span class="line">.text:<span class="number">0046</span>A5FB                 <span class="keyword">xor</span>     ecx, ecx</span><br><span class="line">.text:<span class="number">0046</span>A5FD                 mov     cl, [eax+ebx]   <span class="comment">// ecx = SST.ArgmentTable + 系统调用号低12位*1，即ecx = 函数参数大小</span></span><br><span class="line">.text:<span class="number">0046</span>A600                 mov     edi, [edi]      <span class="comment">// edi = SST.ServiceTable = KeServiceDescriptorTable</span></span><br><span class="line">.text:<span class="number">0046</span>A602                 mov     ebx, [edi+eax*<span class="number">4</span>] <span class="comment">// ebx = SST.ServiceTable + 系统调用号低12位*4 = 函数地址</span></span><br><span class="line">.text:<span class="number">0046</span>A605                 sub     esp, ecx        <span class="comment">// 0环抬高栈顶，马上将3环参数复制到0环</span></span><br><span class="line">.text:<span class="number">0046</span>A607                 shr     ecx, <span class="number">2</span>          <span class="comment">// ecx = 参数个数 = 参数大小/4，作为拷贝的次数（一次拷贝4字节）</span></span><br><span class="line">.text:<span class="number">0046</span>A60A                 mov     edi, esp</span><br><span class="line">.text:<span class="number">0046</span>A60C                 cmp     esi, ds:_MmUserProbeAddress</span><br><span class="line">.text:<span class="number">0046</span>A612                 jnb     loc_46A7C0</span><br><span class="line">.text:<span class="number">0046</span>A618</span><br><span class="line">.text:<span class="number">0046</span>A618 loc_46A618:                             <span class="comment">// CODE XREF: _KiFastCallEntry+2A4↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A618                                         <span class="comment">// DATA XREF: _KiTrap0E+10D↓o</span></span><br><span class="line">.text:<span class="number">0046</span>A618                 rep movsd               <span class="comment">// 可以得知：当前函数的堆栈（也是当前线程的堆栈）从栈顶到栈底的分布情况：</span></span><br><span class="line">.text:<span class="number">0046</span>A618                                         <span class="comment">// 1. 从3环拷贝过来的3环API参数</span></span><br><span class="line">.text:<span class="number">0046</span>A618                                         <span class="comment">// 2. Trapframe（共0x8C字节）</span></span><br><span class="line">.text:<span class="number">0046</span>A618                                         <span class="comment">// 3. 浮点寄存器（共0x210字节）</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                 call    ebx             <span class="comment">// ==========</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// 此时：</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// 1、esp 指向拷贝过来的3环API的第一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// 2、ebp = _KTRAP_FRAME首地址</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// 3、ebx = 系统服务函数地址</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// 4、edx：指向3环 API 的第一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// 5、eax = 系统服务号的低 12 位</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// 6、esi == edi = 指向拷贝过来的3环API的最后一个参数</span></span><br><span class="line">.text:<span class="number">0046</span>A61A                                         <span class="comment">// ==========</span></span><br><span class="line">.text:<span class="number">0046</span>A61C</span><br><span class="line">.text:<span class="number">0046</span>A61C loc_46A61C:                             <span class="comment">// CODE XREF: _KiFastCallEntry+2AF↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A61C                                         <span class="comment">// DATA XREF: _KiTrap0E+12D↓o ...</span></span><br><span class="line">.text:<span class="number">0046</span>A61C                 mov     esp, ebp</span><br><span class="line">.text:<span class="number">0046</span>A61E</span><br><span class="line">.text:<span class="number">0046</span>A61E loc_46A61E:                             <span class="comment">// CODE XREF: _KiBBTUnexpectedRange+38↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A61E                                         <span class="comment">// _KiBBTUnexpectedRange+43↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A61E                 mov     ecx, large fs:<span class="number">124</span>h</span><br><span class="line">.text:<span class="number">0046</span>A625                 mov     edx, [ebp+_KTRAP_FRAME._Edx] <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// 在ROS P24 有这样的代码：</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// Save the old trap frame pointer where EDX would be saved</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// mov ebx, [esi+KTHREAD_TRAP_FRAME]     //KTHREAD 结构中的指针 TrapFrame</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// mov [ebp+KTRAP_FRAME_EDX], ebx        //暂时保存在这里</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// 这是因为：加入一个线程多次从R3--&gt;R0--&gt;R3--&gt;R0，每一次进来R0都会构建一个新</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// 的TrapFrame结构在当前线程堆栈里面，那么可以使用当前KTRAP_FRAME_EDX来保存上一个</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// TrapFrame，因为这一操作是在下面的指令前进行的操作：</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// mov [esi+_KTHREAD.TrapFrame], ebp</span></span><br><span class="line">.text:<span class="number">0046</span>A625                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A628                 mov     [ecx+_KTHREAD.TrapFrame], edx</span><br><span class="line">.text:<span class="number">0046</span>A628 _KiFastCallEntry endp</span><br><span class="line">.text:<span class="number">0046</span>A628</span><br><span class="line">.text:<span class="number">0046</span>A62E</span><br><span class="line">.text:<span class="number">0046</span>A62E <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0046</span>A62E</span><br><span class="line">.text:<span class="number">0046</span>A62E <span class="comment">// 可以看到这个函数是 KiFastCallEntry 函数的一部分，紧接着这个函数的</span></span><br><span class="line">.text:<span class="number">0046</span>A62E</span><br><span class="line">.text:<span class="number">0046</span>A62E _KiServiceExit  proc near               <span class="comment">// CODE XREF: KiCallUserMode(x,x)+EC↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A62E                                         <span class="comment">// _KiSetLowWaitHighThread+80↓j ...</span></span><br><span class="line">.text:<span class="number">0046</span>A62E</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_C           = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_10          = dword ptr  <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_40          = dword ptr  <span class="number">44</span>h</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_44          = dword ptr  <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_48          = dword ptr  <span class="number">4</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_60          = dword ptr  <span class="number">64</span>h</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_64          = dword ptr  <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_68          = dword ptr  <span class="number">6</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>A62E arg_6C          = dword ptr  <span class="number">70</span>h</span><br><span class="line">.text:<span class="number">0046</span>A62E</span><br><span class="line">.text:<span class="number">0046</span>A62E <span class="comment">// FUNCTION CHUNK AT .text:0046A738 SIZE 00000088 BYTES</span></span><br><span class="line">.text:<span class="number">0046</span>A62E</span><br><span class="line">.text:<span class="number">0046</span>A62E                 cli</span><br><span class="line">.text:<span class="number">0046</span>A62F                 test    [ebp+_KTRAP_FRAME.EFlags], <span class="number">20000</span>h <span class="comment">// 判断是否是虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0046</span>A636                 jnz     <span class="keyword">short</span> loc_46A63E <span class="comment">// 是虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0046</span>A638                 test    byte ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A63C                 jz      <span class="keyword">short</span> loc_46A694 <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A63C                                         <span class="comment">// 来自内核，此时esp指向的trapframe是线程堆栈最栈顶上面的那个，</span></span><br><span class="line">.text:<span class="number">0046</span>A63C                                         <span class="comment">// 就是最近一次从3环进入到0环时使用的</span></span><br><span class="line">.text:<span class="number">0046</span>A63C                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A63E</span><br><span class="line">.text:<span class="number">0046</span>A63E loc_46A63E:                             <span class="comment">// CODE XREF: _KiServiceExit+8↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A63E                                         <span class="comment">// _KiServiceExit+64↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A63E                 mov     ebx, large fs:<span class="number">124</span>h <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A63E                                         <span class="comment">// 从3环退出前，只要还有3环APC还没执行，就会不断的循环去执行</span></span><br><span class="line">.text:<span class="number">0046</span>A63E                                         <span class="comment">// 虽然在 KiDeliverApc 中一次只会执行一个用户APC，但是</span></span><br><span class="line">.text:<span class="number">0046</span>A63E                                         <span class="comment">// 本函数这里是一个循环</span></span><br><span class="line">.text:<span class="number">0046</span>A63E                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A645                 mov     [ebx+_KTHREAD.Alerted], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A649                 cmp     [ebx+_KTHREAD.ApcState.UserApcPending], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A64D                 jz      <span class="keyword">short</span> loc_46A694 <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A64D                                         <span class="comment">// 来自内核，此时esp指向的trapframe是线程堆栈最栈顶上面的那个，</span></span><br><span class="line">.text:<span class="number">0046</span>A64D                                         <span class="comment">// 就是最近一次从3环进入到0环时使用的</span></span><br><span class="line">.text:<span class="number">0046</span>A64D                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A64F                 mov     ebx, ebp</span><br><span class="line">.text:<span class="number">0046</span>A651                 mov     [ebx+_KTRAP_FRAME._Eax], eax</span><br><span class="line">.text:<span class="number">0046</span>A654                 mov     [ebx+_KTRAP_FRAME.SegFs], <span class="number">3B</span>h</span><br><span class="line">.text:<span class="number">0046</span>A65B                 mov     [ebx+_KTRAP_FRAME.SegDs], <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">0046</span>A662                 mov     [ebx+_KTRAP_FRAME.SegEs], <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">0046</span>A669                 mov     [ebx+_KTRAP_FRAME.SegGs], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A670                 mov     ecx, <span class="number">1</span>          <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">0046</span>A675                 call    ds:__imp_@KfRaiseIrql@<span class="number">4</span> <span class="comment">// KfRaiseIrql(x)</span></span><br><span class="line">.text:<span class="number">0046</span>A67B                 push    eax</span><br><span class="line">.text:<span class="number">0046</span>A67C                 sti</span><br><span class="line">.text:<span class="number">0046</span>A67D                 push    ebx</span><br><span class="line">.text:<span class="number">0046</span>A67E                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A680                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A682                 call    _KiDeliverApc@<span class="number">12</span> <span class="comment">// VOID KiDeliverApc (</span></span><br><span class="line">.text:<span class="number">0046</span>A682                                         <span class="comment">//     IN KPROCESSOR_MODE PreviousMode,</span></span><br><span class="line">.text:<span class="number">0046</span>A682                                         <span class="comment">//     IN PKEXCEPTION_FRAME ExceptionFrame,</span></span><br><span class="line">.text:<span class="number">0046</span>A682                                         <span class="comment">//     IN PKTRAP_FRAME TrapFrame</span></span><br><span class="line">.text:<span class="number">0046</span>A682                                         <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">0046</span>A687                 pop     ecx             <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">0046</span>A688                 call    ds:__imp_@KfLowerIrql@<span class="number">4</span> <span class="comment">// KfLowerIrql(x)</span></span><br><span class="line">.text:<span class="number">0046</span>A68E                 mov     eax, [ebx+_KTRAP_FRAME._Eax]</span><br><span class="line">.text:<span class="number">0046</span>A691                 cli</span><br><span class="line">.text:<span class="number">0046</span>A692                 jmp     <span class="keyword">short</span> loc_46A63E <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A692                                         <span class="comment">// 从3环退出前，只要还有3环APC还没执行，就会不断的循环去执行</span></span><br><span class="line">.text:<span class="number">0046</span>A692                                         <span class="comment">// 虽然在 KiDeliverApc 中一次只会执行一个用户APC，但是</span></span><br><span class="line">.text:<span class="number">0046</span>A692                                         <span class="comment">// 本函数这里是一个循环</span></span><br><span class="line">.text:<span class="number">0046</span>A692                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A694 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A694</span><br><span class="line">.text:<span class="number">0046</span>A694 loc_46A694:                             <span class="comment">// CODE XREF: _KiServiceExit+E↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A694                                         <span class="comment">// _KiServiceExit+1F↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A694                 mov     edx, [esp+_KTRAP_FRAME.ExceptionList] <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A694                                         <span class="comment">// 来自内核，此时esp指向的trapframe是线程堆栈最栈顶上面的那个，</span></span><br><span class="line">.text:<span class="number">0046</span>A694                                         <span class="comment">// 就是最近一次从3环进入到0环时使用的</span></span><br><span class="line">.text:<span class="number">0046</span>A694                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A698                 mov     ebx, large fs:_KPCR.DebugActive <span class="comment">// 如果当前的线程处于调试状态，那么这里面的值不为零</span></span><br><span class="line">.text:<span class="number">0046</span>A69F                 mov     large fs:_KPCR, edx</span><br><span class="line">.text:<span class="number">0046</span>A6A6                 mov     ecx, [esp+_KTRAP_FRAME.PreviousPreviousMode]</span><br><span class="line">.text:<span class="number">0046</span>A6AA                 mov     esi, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">.text:<span class="number">0046</span>A6B1                 mov     [esi+_KTHREAD.PreviousMode], cl</span><br><span class="line">.text:<span class="number">0046</span>A6B7                 test    ebx, <span class="number">0F</span>Fh</span><br><span class="line">.text:<span class="number">0046</span>A6BD                 jnz     <span class="keyword">short</span> loc_46A738 <span class="comment">// 异常链表非空，有异常需要处理</span></span><br><span class="line">.text:<span class="number">0046</span>A6BF</span><br><span class="line">.text:<span class="number">0046</span>A6BF loc_46A6BF:                             <span class="comment">// CODE XREF: _KiServiceExit+11A↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A6BF                                         <span class="comment">// _KiServiceExit+149↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A6BF                 test    [esp+_KTRAP_FRAME.EFlags], <span class="number">20000</span>h <span class="comment">// 判断是否是V86（虚拟8086即16位操作系统）</span></span><br><span class="line">.text:<span class="number">0046</span>A6C7                 jnz     loc_46AFD8      <span class="comment">// 虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0046</span>A6CD                 test    word ptr [esp+_KTRAP_FRAME.SegCs], <span class="number">0F</span>FF8h</span><br><span class="line">.text:<span class="number">0046</span>A6D4                 jz      loc_46A78E      <span class="comment">// CS最低位为0，说明先前模式是0</span></span><br><span class="line">.text:<span class="number">0046</span>A6DA                 cmp     word ptr [esp+_KTRAP_FRAME.SegCs], <span class="number">1B</span>h</span><br><span class="line">.text:<span class="number">0046</span>A6E0                 bt      word ptr [esp+_KTRAP_FRAME.SegCs], <span class="number">0</span> <span class="comment">// CF位置1</span></span><br><span class="line">.text:<span class="number">0046</span>A6E7                 cmc                     <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A6E7                                         <span class="comment">// CF取反，则 CF == 0</span></span><br><span class="line">.text:<span class="number">0046</span>A6E7                                         <span class="comment">// https://blog.csdn.net/xiong_xin/article/details/103665440</span></span><br><span class="line">.text:<span class="number">0046</span>A6E7                                         <span class="comment">// ---</span></span><br><span class="line">.text:<span class="number">0046</span>A6E8                 ja      loc_46A77C      <span class="comment">// CF ∨ ZF = 0 时跳转</span></span><br><span class="line">.text:<span class="number">0046</span>A6EE                 cmp     word ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">8</span></span><br><span class="line">.text:<span class="number">0046</span>A6F3                 jz      <span class="keyword">short</span> loc_46A6FA</span><br><span class="line">.text:<span class="number">0046</span>A6F5</span><br><span class="line">.text:<span class="number">0046</span>A6F5 loc_46A6F5:                             <span class="comment">// CODE XREF: _KiServiceExit+15B↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A6F5                 lea     esp, [ebp+_KTRAP_FRAME.SegFs]</span><br><span class="line">.text:<span class="number">0046</span>A6F8                 pop     fs              <span class="comment">// 将3环的 FS 赋值给 FS 寄存器</span></span><br><span class="line">.text:<span class="number">0046</span>A6FA                 assume fs:nothing</span><br><span class="line">.text:<span class="number">0046</span>A6FA</span><br><span class="line">.text:<span class="number">0046</span>A6FA loc_46A6FA:                             <span class="comment">// CODE XREF: _KiServiceExit+C5↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A6FA                 lea     esp, [ebp+_KTRAP_FRAME._Edi]</span><br><span class="line">.text:<span class="number">0046</span>A6FD                 pop     edi</span><br><span class="line">.text:<span class="number">0046</span>A6FE                 pop     esi</span><br><span class="line">.text:<span class="number">0046</span>A6FF                 pop     ebx</span><br><span class="line">.text:<span class="number">0046</span>A700                 pop     ebp             <span class="comment">// 此时的esp指向ErrCode（+0x64）</span></span><br><span class="line">.text:<span class="number">0046</span>A701                 cmp     word ptr [esp<span class="number">-60</span>h+arg_64], <span class="number">80</span>h <span class="comment">// CS</span></span><br><span class="line">.text:<span class="number">0046</span>A708                 ja      loc_46AFF4</span><br><span class="line">.text:<span class="number">0046</span>A70E                 add     esp, <span class="number">4</span>          <span class="comment">// esp指向EIP3（+0x68）</span></span><br><span class="line">.text:<span class="number">0046</span>A711                 test    [esp<span class="number">-64</span>h+arg_64], <span class="number">1</span> <span class="comment">// cs</span></span><br><span class="line">.text:<span class="number">0046</span>A711 _KiServiceExit  endp <span class="comment">// sp-analysis failed</span></span><br><span class="line">.text:<span class="number">0046</span>A711</span><br><span class="line">.text:<span class="number">0046</span>A719</span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0046</span>A719</span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// ========</span></span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// 实际上，如果当前系统支持快速系统调用，那么，这条指令将</span></span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// 被修正为“jnz short _KiSystemCallExi2“。而KiSystemCallExit2 所指的代码使用 sysexit</span></span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// 指令返回用户模式。这条指令的修正工作是在 KiEnableFastSyscallReturn 函数中完成的，</span></span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// 该函数被 KiRestoreFastSyscallReturnState 调用</span></span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// 《Windows内核原理与实现》 P553</span></span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">// ========</span></span><br><span class="line">.text:<span class="number">0046</span>A719 <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A719</span><br><span class="line">.text:<span class="number">0046</span>A719 _KiSystemCallExitBranch proc near       <span class="comment">// DATA XREF: KiDisableFastSyscallReturn()+9↑w</span></span><br><span class="line">.text:<span class="number">0046</span>A719                                         <span class="comment">// KiEnableFastSyscallReturn():loc_427854↑r ...</span></span><br><span class="line">.text:<span class="number">0046</span>A719                 jnz     <span class="keyword">short</span> _KiSystemCallExit</span><br><span class="line">.text:<span class="number">0046</span>A71B                 pop     edx             <span class="comment">// edx = eip3</span></span><br><span class="line">.text:<span class="number">0046</span>A71C                 pop     ecx             <span class="comment">// 从栈中移除cs</span></span><br><span class="line">.text:<span class="number">0046</span>A71D                 popf</span><br><span class="line">.text:<span class="number">0046</span>A71E                 jmp     edx</span><br><span class="line">.text:<span class="number">0046</span>A720 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A720</span><br><span class="line">.text:<span class="number">0046</span>A720 _KiSystemCallExit:                      <span class="comment">// CODE XREF: _KiSystemCallExitBranch↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A720                                         <span class="comment">// _KiSystemCallExit2+5↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A720                                         <span class="comment">// DATA XREF: ...</span></span><br><span class="line">.text:<span class="number">0046</span>A720                 iret</span><br><span class="line">.text:<span class="number">0046</span>A720 _KiSystemCallExitBranch endp <span class="comment">// sp-analysis failed</span></span><br><span class="line">.text:<span class="number">0046</span>A720</span><br><span class="line">.text:<span class="number">0046</span>A721</span><br><span class="line">.text:<span class="number">0046</span>A721 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0046</span>A721</span><br><span class="line">.text:<span class="number">0046</span>A721</span><br><span class="line">.text:<span class="number">0046</span>A721 _KiSystemCallExit2 proc near            <span class="comment">// DATA XREF: KiRestoreFastSyscallReturnState()+16↑o</span></span><br><span class="line">.text:<span class="number">0046</span>A721</span><br><span class="line">.text:<span class="number">0046</span>A721 arg_5           = byte ptr  <span class="number">9</span></span><br><span class="line">.text:<span class="number">0046</span>A721</span><br><span class="line">.text:<span class="number">0046</span>A721                 test    [esp+arg_5], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A726                 jnz     <span class="keyword">short</span> _KiSystemCallExit <span class="comment">// ===========================================================</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">// EFLAG3.TF（Trap flag）!= 0，也就是说是从陷井进来的0环，不是快速调用进来的。</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">// 注意，这里首先测试 eflags 标志寄存器中的TF（陷阱） 标志是必要的，因为</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">// 在 Pentium II 以后的 Windows 系统上，若应用程序绕过KiFastSystemCall，而直接</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">// 利用 “int 2e” 指令进入内核，那么，在此处将会被检测到，从而通过irerd 返回，</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">// 这样就不会发生进人内核模式和返回用户模式不对称的情形。</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">// 《Windows内核原理与实现》 P554</span></span><br><span class="line">.text:<span class="number">0046</span>A726                                         <span class="comment">// ====================================================================</span></span><br><span class="line">.text:<span class="number">0046</span>A728                 pop     edx             <span class="comment">// esp指向EIP3（+0x68）</span></span><br><span class="line">.text:<span class="number">0046</span>A729                 add     esp, <span class="number">4</span>          <span class="comment">// 从栈中移除cs，此时 esp 指向eflag3</span></span><br><span class="line">.text:<span class="number">0046</span>A72C                 <span class="keyword">and</span>     [esp<span class="number">-8</span>+arg_5], <span class="number">0F</span>Dh <span class="comment">// 禁止eflags中的中断标志</span></span><br><span class="line">.text:<span class="number">0046</span>A731                 popf</span><br><span class="line">.text:<span class="number">0046</span>A732                 pop     ecx             <span class="comment">// 弹出esp</span></span><br><span class="line">.text:<span class="number">0046</span>A733                 sti                     <span class="comment">// 恢复中断，因为sysexit指令不会恢复中断标志</span></span><br><span class="line">.text:<span class="number">0046</span>A734                 sysexit                 <span class="comment">// 返回用户模式</span></span><br><span class="line">.text:<span class="number">0046</span>A736                 iret</span><br><span class="line">.text:<span class="number">0046</span>A736 _KiSystemCallExit2 endp <span class="comment">// sp-analysis failed</span></span><br><span class="line">.text:<span class="number">0046</span>A736</span><br><span class="line">.text:<span class="number">0046</span>A736 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A737                 align <span class="number">4</span></span><br><span class="line">.text:<span class="number">0046</span>A738 <span class="comment">// START OF FUNCTION CHUNK FOR _KiServiceExit</span></span><br><span class="line">.text:<span class="number">0046</span>A738</span><br><span class="line">.text:<span class="number">0046</span>A738 loc_46A738:                             <span class="comment">// CODE XREF: _KiServiceExit+8F↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A738                 test    dword ptr [ebp+<span class="number">70</span>h], <span class="number">20000</span>h <span class="comment">// 异常链表非空，有异常需要处理</span></span><br><span class="line">.text:<span class="number">0046</span>A73F                 jnz     <span class="keyword">short</span> loc_46A74E</span><br><span class="line">.text:<span class="number">0046</span>A741                 test    dword ptr [ebp+<span class="number">6</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A748                 jz      loc_46A6BF      <span class="comment">// 判断是否是V86（虚拟8086即16位操作系统）</span></span><br><span class="line">.text:<span class="number">0046</span>A74E</span><br><span class="line">.text:<span class="number">0046</span>A74E loc_46A74E:                             <span class="comment">// CODE XREF: _KiServiceExit+111↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A74E                 <span class="keyword">xor</span>     ebx, ebx</span><br><span class="line">.text:<span class="number">0046</span>A750                 mov     esi, [ebp+<span class="number">18</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A753                 mov     edi, [ebp+<span class="number">1</span>Ch]</span><br><span class="line">.text:<span class="number">0046</span>A756                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">0046</span>A759                 mov     dr0, esi</span><br><span class="line">.text:<span class="number">0046</span>A75C                 mov     ebx, [ebp+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A75F                 mov     dr1, edi</span><br><span class="line">.text:<span class="number">0046</span>A762                 mov     dr2, ebx</span><br><span class="line">.text:<span class="number">0046</span>A765                 mov     esi, [ebp+<span class="number">24</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A768                 mov     edi, [ebp+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A76B                 mov     ebx, [ebp+<span class="number">2</span>Ch]</span><br><span class="line">.text:<span class="number">0046</span>A76E                 mov     dr3, esi</span><br><span class="line">.text:<span class="number">0046</span>A771                 mov     dr6, edi</span><br><span class="line">.text:<span class="number">0046</span>A774                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">0046</span>A777                 jmp     loc_46A6BF      <span class="comment">// 判断是否是V86（虚拟8086即16位操作系统）</span></span><br><span class="line">.text:<span class="number">0046</span>A77C <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A77C</span><br><span class="line">.text:<span class="number">0046</span>A77C loc_46A77C:                             <span class="comment">// CODE XREF: _KiServiceExit+BA↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A77C                 mov     eax, [esp+arg_40]</span><br><span class="line">.text:<span class="number">0046</span>A780                 add     esp, <span class="number">30</span>h</span><br><span class="line">.text:<span class="number">0046</span>A783                 pop     gs</span><br><span class="line">.text:<span class="number">0046</span>A785                 pop     es</span><br><span class="line">.text:<span class="number">0046</span>A786                 assume es:nothing</span><br><span class="line">.text:<span class="number">0046</span>A786                 pop     ds</span><br><span class="line">.text:<span class="number">0046</span>A787                 assume ds:_data</span><br><span class="line">.text:<span class="number">0046</span>A787                 pop     edx</span><br><span class="line">.text:<span class="number">0046</span>A788                 pop     ecx</span><br><span class="line">.text:<span class="number">0046</span>A789                 jmp     loc_46A6F5</span><br><span class="line">.text:<span class="number">0046</span>A78E <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A78E</span><br><span class="line">.text:<span class="number">0046</span>A78E loc_46A78E:                             <span class="comment">// CODE XREF: _KiServiceExit+A6↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A78E                 mov     ebx, [esp+arg_C] <span class="comment">// CS最低位为0，说明先前模式是0</span></span><br><span class="line">.text:<span class="number">0046</span>A792                 mov     [esp+arg_68], ebx</span><br><span class="line">.text:<span class="number">0046</span>A796                 mov     ebx, [esp+arg_10]</span><br><span class="line">.text:<span class="number">0046</span>A79A                 sub     ebx, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>A79D                 mov     [esp+arg_60], ebx</span><br><span class="line">.text:<span class="number">0046</span>A7A1                 mov     esi, [esp+arg_6C]</span><br><span class="line">.text:<span class="number">0046</span>A7A5                 mov     [ebx+<span class="number">8</span>], esi</span><br><span class="line">.text:<span class="number">0046</span>A7A8                 mov     esi, [esp+arg_68]</span><br><span class="line">.text:<span class="number">0046</span>A7AC                 mov     [ebx+<span class="number">4</span>], esi</span><br><span class="line">.text:<span class="number">0046</span>A7AF                 mov     esi, [esp+arg_64]</span><br><span class="line">.text:<span class="number">0046</span>A7B3                 mov     [ebx], esi</span><br><span class="line">.text:<span class="number">0046</span>A7B5                 add     esp, <span class="number">54</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7B8                 pop     edi</span><br><span class="line">.text:<span class="number">0046</span>A7B9                 pop     esi</span><br><span class="line">.text:<span class="number">0046</span>A7BA                 pop     ebx</span><br><span class="line">.text:<span class="number">0046</span>A7BB                 pop     ebp</span><br><span class="line">.text:<span class="number">0046</span>A7BC                 mov     esp, [esp<span class="number">-64</span>h+arg_60]</span><br><span class="line">.text:<span class="number">0046</span>A7BF                 iret</span><br><span class="line">.text:<span class="number">0046</span>A7BF <span class="comment">// END OF FUNCTION CHUNK FOR _KiServiceExit</span></span><br><span class="line">.text:<span class="number">0046</span>A7C0 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A7C0 <span class="comment">// START OF FUNCTION CHUNK FOR _KiFastCallEntry</span></span><br><span class="line">.text:<span class="number">0046</span>A7C0</span><br><span class="line">.text:<span class="number">0046</span>A7C0 loc_46A7C0:                             <span class="comment">// CODE XREF: _KiFastCallEntry+F2↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A7C0                 test    byte ptr [ebp+<span class="number">6</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A7C4                 jz      loc_46A618      <span class="comment">// 可以得知：当前函数的堆栈（也是当前线程的堆栈）从栈顶到栈底的分布情况：</span></span><br><span class="line">.text:<span class="number">0046</span>A7C4                                         <span class="comment">// 1. 从3环拷贝过来的3环API参数</span></span><br><span class="line">.text:<span class="number">0046</span>A7C4                                         <span class="comment">// 2. Trapframe（共0x8C字节）</span></span><br><span class="line">.text:<span class="number">0046</span>A7C4                                         <span class="comment">// 3. 浮点寄存器（共0x210字节）</span></span><br><span class="line">.text:<span class="number">0046</span>A7CA                 mov     eax, <span class="number">0</span>C0000005h</span><br><span class="line">.text:<span class="number">0046</span>A7CF                 jmp     loc_46A61C</span><br><span class="line">.text:<span class="number">0046</span>A7CF <span class="comment">// END OF FUNCTION CHUNK FOR _KiFastCallEntry</span></span><br><span class="line">.text:<span class="number">0046</span>A7D4</span><br><span class="line">.text:<span class="number">0046</span>A7D4 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0046</span>A7D4</span><br><span class="line">.text:<span class="number">0046</span>A7D4</span><br><span class="line">.text:<span class="number">0046</span>A7D4 _KiServiceExit2 proc near               <span class="comment">// CODE XREF: NtContinue(x,x)+3B↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A7D4                                         <span class="comment">// NtRaiseException(x,x,x)+3E↓j ...</span></span><br><span class="line">.text:<span class="number">0046</span>A7D4</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_C           = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_10          = dword ptr  <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_38          = dword ptr  <span class="number">3</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_3C          = dword ptr  <span class="number">40</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_40          = dword ptr  <span class="number">44</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_44          = dword ptr  <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_48          = dword ptr  <span class="number">4</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_60          = dword ptr  <span class="number">64</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_64          = dword ptr  <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_68          = dword ptr  <span class="number">6</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>A7D4 arg_6C          = dword ptr  <span class="number">70</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7D4</span><br><span class="line">.text:<span class="number">0046</span>A7D4                 cli</span><br><span class="line">.text:<span class="number">0046</span>A7D5                 test    dword ptr [ebp+<span class="number">70</span>h], <span class="number">20000</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7DC                 jnz     <span class="keyword">short</span> loc_46A7E4</span><br><span class="line">.text:<span class="number">0046</span>A7DE                 test    byte ptr [ebp+<span class="number">6</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A7E2                 jz      <span class="keyword">short</span> loc_46A818</span><br><span class="line">.text:<span class="number">0046</span>A7E4</span><br><span class="line">.text:<span class="number">0046</span>A7E4 loc_46A7E4:                             <span class="comment">// CODE XREF: _KiServiceExit2+8↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A7E4                                         <span class="comment">// _KiServiceExit2+42↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A7E4                 mov     ebx, large fs:<span class="number">124</span>h</span><br><span class="line">.text:<span class="number">0046</span>A7EB                 mov     byte ptr [ebx+<span class="number">2</span>Eh], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A7EF                 cmp     byte ptr [ebx+<span class="number">4</span>Ah], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A7F3                 jz      <span class="keyword">short</span> loc_46A818</span><br><span class="line">.text:<span class="number">0046</span>A7F5                 mov     ebx, ebp</span><br><span class="line">.text:<span class="number">0046</span>A7F7                 mov     ecx, <span class="number">1</span>          <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">0046</span>A7FC                 call    ds:__imp_@KfRaiseIrql@<span class="number">4</span> <span class="comment">// KfRaiseIrql(x)</span></span><br><span class="line">.text:<span class="number">0046</span>A802                 push    eax</span><br><span class="line">.text:<span class="number">0046</span>A803                 sti</span><br><span class="line">.text:<span class="number">0046</span>A804                 push    ebx</span><br><span class="line">.text:<span class="number">0046</span>A805                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">0046</span>A807                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A809                 call    _KiDeliverApc@<span class="number">12</span> <span class="comment">// VOID KiDeliverApc (</span></span><br><span class="line">.text:<span class="number">0046</span>A809                                         <span class="comment">//     IN KPROCESSOR_MODE PreviousMode,</span></span><br><span class="line">.text:<span class="number">0046</span>A809                                         <span class="comment">//     IN PKEXCEPTION_FRAME ExceptionFrame,</span></span><br><span class="line">.text:<span class="number">0046</span>A809                                         <span class="comment">//     IN PKTRAP_FRAME TrapFrame</span></span><br><span class="line">.text:<span class="number">0046</span>A809                                         <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">0046</span>A80E                 pop     ecx             <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">0046</span>A80F                 call    ds:__imp_@KfLowerIrql@<span class="number">4</span> <span class="comment">// KfLowerIrql(x)</span></span><br><span class="line">.text:<span class="number">0046</span>A815                 cli</span><br><span class="line">.text:<span class="number">0046</span>A816                 jmp     <span class="keyword">short</span> loc_46A7E4</span><br><span class="line">.text:<span class="number">0046</span>A818 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A818</span><br><span class="line">.text:<span class="number">0046</span>A818 loc_46A818:                             <span class="comment">// CODE XREF: _KiServiceExit2+E↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A818                                         <span class="comment">// _KiServiceExit2+1F↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A818                 mov     edx, [esp+arg_48]</span><br><span class="line">.text:<span class="number">0046</span>A81C                 mov     ebx, large fs:<span class="number">50</span>h</span><br><span class="line">.text:<span class="number">0046</span>A823                 mov     large fs:<span class="number">0</span>, edx</span><br><span class="line">.text:<span class="number">0046</span>A82A                 mov     ecx, [esp+arg_44]</span><br><span class="line">.text:<span class="number">0046</span>A82E                 mov     esi, large fs:<span class="number">124</span>h</span><br><span class="line">.text:<span class="number">0046</span>A835                 mov     [esi+<span class="number">140</span>h], cl</span><br><span class="line">.text:<span class="number">0046</span>A83B                 test    ebx, <span class="number">0F</span>Fh</span><br><span class="line">.text:<span class="number">0046</span>A841                 jnz     <span class="keyword">short</span> loc_46A894</span><br><span class="line">.text:<span class="number">0046</span>A843</span><br><span class="line">.text:<span class="number">0046</span>A843 loc_46A843:                             <span class="comment">// CODE XREF: _KiServiceExit2+D0↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A843                                         <span class="comment">// _KiServiceExit2+FB↓j</span></span><br><span class="line">.text:<span class="number">0046</span>A843                 test    [esp+arg_6C], <span class="number">20000</span>h</span><br><span class="line">.text:<span class="number">0046</span>A84B                 jnz     loc_46AFD8      <span class="comment">// 虚拟8086模式</span></span><br><span class="line">.text:<span class="number">0046</span>A851                 test    word ptr [esp+arg_68], <span class="number">0F</span>FF8h</span><br><span class="line">.text:<span class="number">0046</span>A858                 jz      <span class="keyword">short</span> loc_46A8D4</span><br><span class="line">.text:<span class="number">0046</span>A85A                 mov     edx, [esp+arg_38]</span><br><span class="line">.text:<span class="number">0046</span>A85E                 mov     ecx, [esp+arg_3C]</span><br><span class="line">.text:<span class="number">0046</span>A862                 mov     eax, [esp+arg_40]</span><br><span class="line">.text:<span class="number">0046</span>A866                 cmp     word ptr [ebp+<span class="number">6</span>Ch], <span class="number">8</span></span><br><span class="line">.text:<span class="number">0046</span>A86B                 jz      <span class="keyword">short</span> loc_46A879</span><br><span class="line">.text:<span class="number">0046</span>A86D                 lea     esp, [ebp+<span class="number">30</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A870                 pop     gs</span><br><span class="line">.text:<span class="number">0046</span>A872                 pop     es</span><br><span class="line">.text:<span class="number">0046</span>A873                 pop     ds</span><br><span class="line">.text:<span class="number">0046</span>A874                 lea     esp, [ebp+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A877                 pop     fs</span><br><span class="line">.text:<span class="number">0046</span>A879</span><br><span class="line">.text:<span class="number">0046</span>A879 loc_46A879:                             <span class="comment">// CODE XREF: _KiServiceExit2+97↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A879                 lea     esp, [ebp+<span class="number">54</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A87C                 pop     edi</span><br><span class="line">.text:<span class="number">0046</span>A87D                 pop     esi</span><br><span class="line">.text:<span class="number">0046</span>A87E                 pop     ebx</span><br><span class="line">.text:<span class="number">0046</span>A87F                 pop     ebp</span><br><span class="line">.text:<span class="number">0046</span>A880                 cmp     word ptr [esp<span class="number">-60</span>h+arg_64], <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">0046</span>A887                 ja      loc_46AFF4</span><br><span class="line">.text:<span class="number">0046</span>A88D                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0046</span>A890                 iret</span><br><span class="line">.text:<span class="number">0046</span>A890 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A891                 align <span class="number">4</span></span><br><span class="line">.text:<span class="number">0046</span>A894</span><br><span class="line">.text:<span class="number">0046</span>A894 loc_46A894:                             <span class="comment">// CODE XREF: _KiServiceExit2+6D↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A894                 test    dword ptr [ebp+<span class="number">70</span>h], <span class="number">20000</span>h</span><br><span class="line">.text:<span class="number">0046</span>A89B                 jnz     <span class="keyword">short</span> loc_46A8A6</span><br><span class="line">.text:<span class="number">0046</span>A89D                 test    dword ptr [ebp+<span class="number">6</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0046</span>A8A4                 jz      <span class="keyword">short</span> loc_46A843</span><br><span class="line">.text:<span class="number">0046</span>A8A6</span><br><span class="line">.text:<span class="number">0046</span>A8A6 loc_46A8A6:                             <span class="comment">// CODE XREF: _KiServiceExit2+C7↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A8A6                 <span class="keyword">xor</span>     ebx, ebx</span><br><span class="line">.text:<span class="number">0046</span>A8A8                 mov     esi, [ebp+<span class="number">18</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A8AB                 mov     edi, [ebp+<span class="number">1</span>Ch]</span><br><span class="line">.text:<span class="number">0046</span>A8AE                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">0046</span>A8B1                 mov     dr0, esi</span><br><span class="line">.text:<span class="number">0046</span>A8B4                 mov     ebx, [ebp+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A8B7                 mov     dr1, edi</span><br><span class="line">.text:<span class="number">0046</span>A8BA                 mov     dr2, ebx</span><br><span class="line">.text:<span class="number">0046</span>A8BD                 mov     esi, [ebp+<span class="number">24</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A8C0                 mov     edi, [ebp+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0046</span>A8C3                 mov     ebx, [ebp+<span class="number">2</span>Ch]</span><br><span class="line">.text:<span class="number">0046</span>A8C6                 mov     dr3, esi</span><br><span class="line">.text:<span class="number">0046</span>A8C9                 mov     dr6, edi</span><br><span class="line">.text:<span class="number">0046</span>A8CC                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">0046</span>A8CF                 jmp     loc_46A843</span><br><span class="line">.text:<span class="number">0046</span>A8D4 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A8D4</span><br><span class="line">.text:<span class="number">0046</span>A8D4 loc_46A8D4:                             <span class="comment">// CODE XREF: _KiServiceExit2+84↑j</span></span><br><span class="line">.text:<span class="number">0046</span>A8D4                 mov     ebx, [esp+arg_C]</span><br><span class="line">.text:<span class="number">0046</span>A8D8                 mov     [esp+arg_68], ebx</span><br><span class="line">.text:<span class="number">0046</span>A8DC                 mov     ebx, [esp+arg_10]</span><br><span class="line">.text:<span class="number">0046</span>A8E0                 sub     ebx, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0046</span>A8E3                 mov     [esp+arg_60], ebx</span><br><span class="line">.text:<span class="number">0046</span>A8E7                 mov     esi, [esp+arg_6C]</span><br><span class="line">.text:<span class="number">0046</span>A8EB                 mov     [ebx+<span class="number">8</span>], esi</span><br><span class="line">.text:<span class="number">0046</span>A8EE                 mov     esi, [esp+arg_68]</span><br><span class="line">.text:<span class="number">0046</span>A8F2                 mov     [ebx+<span class="number">4</span>], esi</span><br><span class="line">.text:<span class="number">0046</span>A8F5                 mov     esi, [esp+arg_64]</span><br><span class="line">.text:<span class="number">0046</span>A8F9                 mov     [ebx], esi</span><br><span class="line">.text:<span class="number">0046</span>A8FB                 mov     eax, [esp+arg_40]</span><br><span class="line">.text:<span class="number">0046</span>A8FF                 mov     edx, [esp+arg_38]</span><br><span class="line">.text:<span class="number">0046</span>A903                 mov     ecx, [esp+arg_3C]</span><br><span class="line">.text:<span class="number">0046</span>A907                 add     esp, <span class="number">54</span>h</span><br><span class="line">.text:<span class="number">0046</span>A90A                 pop     edi</span><br><span class="line">.text:<span class="number">0046</span>A90B                 pop     esi</span><br><span class="line">.text:<span class="number">0046</span>A90C                 pop     ebx</span><br><span class="line">.text:<span class="number">0046</span>A90D                 pop     ebp</span><br><span class="line">.text:<span class="number">0046</span>A90E                 mov     esp, [esp<span class="number">-64</span>h+arg_60]</span><br><span class="line">.text:<span class="number">0046</span>A911                 iret</span><br><span class="line">.text:<span class="number">0046</span>A911 _KiServiceExit2 endp <span class="comment">// sp-analysis failed</span></span><br><span class="line">.text:<span class="number">0046</span>A911</span><br><span class="line">.text:<span class="number">0046</span>A912 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0046</span>A912                 retn</span><br><span class="line">.text:<span class="number">0046</span>A912 <span class="comment">// ---------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>



<p><img data-src="https://s2.loli.net/2022/07/11/y7tn4f6AN9bTUYr.png" alt="666.png"></p>
<h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7 总结"></a>7 总结</h2><h3 id="7-1-关于用户APC的执行"><a href="#7-1-关于用户APC的执行" class="headerlink" title="7.1 关于用户APC的执行"></a>7.1 关于用户APC的执行</h3><p>在函数<code>KiInsertQueueApc</code>，最后处理用户APC时有如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Thread.State == Waiting &amp;&amp; Thread.WaitMode == UserMode &amp;&amp; (Thread.Alertable == <span class="number">1</span> || </span><br><span class="line">                                                       Thread.ApcState[UserMode].UserApcPending == <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      Thread.ApcState[UserMode].UserApcPending = <span class="number">1</span>;</span><br><span class="line">      KiUnwaitThread();	<span class="comment">//修改线程状态为就绪，并提升优先级</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>需要说明是，如果要让一个刚才插入的用户APC的<code>UserApcPending = 1</code>，最重要的两件事：</p>
<ol>
<li><p><strong>在APC插入前</strong>：目标线程的<code>Thread.Alertable == 1 || Thread.ApcState[UserMode].UserApcPending == 1</code>，<strong>在APC对象插入目标线程前</strong>，才会设置<code>Thread.ApcState[UserMode].UserApcPending = 1</code>。</p>
</li>
<li><p><strong>在APC插入后</strong>：除了上述的那两种情况可以使刚插入的<strong>用户APC</strong>获得执行机会之外，还有一种可以让用户APC可执行的方法。在函数<code>KiDeliverApc</code>中对于非空的用户APC队列有如下的判断，如果符合如下条件就会执行用户APC函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PreviousMode == <span class="number">1</span> &amp;&amp; CurrentThread-&gt;ApcState-&gt;UserApcPending == <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>所以当一个<strong>用户APC对象插入APC队列之后</strong>，在目标线程3环调用函数<code>NtTestAlert</code>也是可以的，因为：</p>
<p>R3 NtTestAlert：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//R3 NtTestAlert</span></span><br><span class="line">.text:<span class="number">7</span>C92DE70 ; <span class="function">_DWORD __stdcall <span class="title">NtTestAlert</span><span class="params">()</span></span></span><br><span class="line">.text:7C92DE70                 public _NtTestAlert@0</span><br><span class="line">.text:<span class="number">7</span>C92DE70 _NtTestAlert@<span class="number">0</span>  proc near               <span class="comment">// CODE XREF: _LdrpInitialize(x,x,x):loc_7C93AFF7↓p</span></span><br><span class="line">.text:<span class="number">7</span>C92DE70                                         <span class="comment">// DATA XREF: .text:off_7C923428↑o</span></span><br><span class="line">.text:<span class="number">7</span>C92DE70                 mov     eax, <span class="number">103</span>h       <span class="comment">// NtTestAlert</span></span><br><span class="line">.text:<span class="number">7</span>C92DE75                 mov     edx, <span class="number">7F</span>FE0300h</span><br><span class="line">.text:<span class="number">7</span>C92DE7A                 call    dword ptr [edx]</span><br><span class="line">.text:<span class="number">7</span>C92DE7C                 retn</span><br><span class="line">.text:<span class="number">7</span>C92DE7C _NtTestAlert@<span class="number">0</span>  endp</span><br></pre></td></tr></table></figure>

<p>R0 NtTestAlert：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//R0 NtTestAlert</span></span><br><span class="line">PAGE:<span class="number">004F</span>DBFE ; =============== S U B R O U T I N E =======================================</span><br><span class="line">PAGE:<span class="number">004F</span>DBFE</span><br><span class="line">PAGE:<span class="number">004F</span>DBFE</span><br><span class="line">PAGE:<span class="number">004F</span>DBFE ; <span class="function">NTSTATUS __stdcall <span class="title">NtTestAlert</span><span class="params">()</span></span></span><br><span class="line">PAGE:004FDBFE _NtTestAlert@0  proc near               // DATA XREF: .text:0042D85C↑o</span><br><span class="line">PAGE:<span class="number">004F</span>DBFE                 mov     eax, large fs:<span class="number">124</span>h</span><br><span class="line">PAGE:<span class="number">004F</span>DC04                 movsx   eax, [eax+_KTHREAD.PreviousMode]</span><br><span class="line">PAGE:<span class="number">004F</span>DC0B                 push    eax</span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                 call    _KeTestAlertThread@<span class="number">4</span> <span class="comment">// ---</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">// BOOLEAN __stdcall KeTestAlertThread (</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">//     IN KPROCESSOR_MODE AlertMode</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">//     )</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">//</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">// 如果吵醒模式AlertMode == 1，并且用户APC队列不为空，</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">// 那就设置 Thread-&gt;ApcState.UserApcPending = TRUE 然后交付</span></span><br><span class="line">  						      <span class="comment">//下一个用户APC</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">// 【检查该线程是否可以交付另一个用户模式的APC】</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC0C                                         <span class="comment">// ---</span></span><br><span class="line">PAGE:<span class="number">004F</span>DC11                 neg     al</span><br><span class="line">PAGE:<span class="number">004F</span>DC13                 sbb     eax, eax</span><br><span class="line">PAGE:<span class="number">004F</span>DC15                 <span class="keyword">and</span>     eax, <span class="number">101</span>h</span><br><span class="line">PAGE:<span class="number">004F</span>DC1A                 retn</span><br><span class="line">PAGE:<span class="number">004F</span>DC1A _NtTestAlert@<span class="number">0</span>  endp</span><br><span class="line">PAGE:<span class="number">004F</span>DC1A</span><br><span class="line">PAGE:<span class="number">004F</span>DC1A ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="7-2-多个用户APC在R0-R3来回循环执行过程"><a href="#7-2-多个用户APC在R0-R3来回循环执行过程" class="headerlink" title="7.2 多个用户APC在R0-R3来回循环执行过程"></a>7.2 多个用户APC在R0-R3来回循环执行过程</h3><p>假设第一个用户APC是在线程正常从R0返回R3时触发的，因为<code>KiFastCallEntry</code>函数在<code>call ebx</code>调用完成之后（<code>ebx</code>是<code>Nt*</code>函数），会继续往下走直接调用函数<code>KiServiceExit</code>。    </p>
<p>在<code>KiServiceExit</code>函数开头判断<code>KTRAP_FRAME.SegCs</code>最低位为<code>1</code>，这里实际上就是类似验证<code>PreviousMode</code>是来自3环，就会调用函数<code>KiDeliverApc</code>。  </p>
<p>这个时候才会开始进行APC的交付调度。  </p>
<ol>
<li><p>在函数<code>KiDeliverApc</code>中对用户APC作如下判断，如果条件符合就开始交付：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(&amp;CurrentThread-&gt;ApcState-&gt;ApcListHead[<span class="number">1</span>] != NextEntry &amp;&amp; PreviousMode == <span class="number">1</span> &amp;&amp; </span><br><span class="line">   								CurrentThread-&gt;ApcState[UserMode]-&gt;UserApcPending == <span class="number">1</span>)</span><br></pre></td></tr></table></figure>


</li>
<li><p>首先会设置<code>Thread-&gt;ApcState[UserMode].UserApcPending = FALSE</code>，然后往下判断<code>Apc-&gt;NormalRoutine != 0</code>就会调用<code>KiInitializeUserApc</code>去将“从3环经过快速调用进0环后”在函数<code>KiFastCallEntry</code>中的<code>TrapFrame</code>拷贝到<code>Conntext</code>后对<code>TrapFrame</code>相关成员进行修改，使其从<code>KiServiceExit</code>返回到<code>ntdll.dll!KiUserApcDispatcher</code>函数中去。（我将这里的<code>TrapFrame</code>叫做<code>TrapFrame_Initial</code>）</p>
</li>
<li><p>在函数<code>KiUserApcDispatcher</code>中做了以下这些事：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//R3 ntdll.dll KiUserApcDispatcher</span></span><br><span class="line">.text:<span class="number">7</span>C92E430 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430 <span class="comment">// __stdcall KiUserApcDispatcher(x, x, x, x, x)</span></span><br><span class="line">.text:<span class="number">7</span>C92E430                 <span class="keyword">public</span> _KiUserApcDispatcher@<span class="number">20</span></span><br><span class="line">.text:<span class="number">7</span>C92E430 _KiUserApcDispatcher@<span class="number">20</span> proc near       <span class="comment">// DATA XREF: .text:off_7C923428↑o</span></span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430 pR3_Stack_Context     = byte ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">7</span>C92E430</span><br><span class="line">.text:<span class="number">7</span>C92E430                 lea     edi, [esp+pR3_Stack_Context]</span><br><span class="line">.text:<span class="number">7</span>C92E434                 pop     eax             <span class="comment">// NormalRoutine</span></span><br><span class="line">.text:<span class="number">7</span>C92E435                 call    eax</span><br><span class="line">.text:<span class="number">7</span>C92E437                 push    <span class="number">1</span>               <span class="comment">// TestAlert</span></span><br><span class="line">.text:<span class="number">7</span>C92E439                 push    edi             <span class="comment">// 在3环函数中保存的 CONTEXT 的首地址</span></span><br><span class="line">.text:<span class="number">7</span>C92E43A                 call    _ZwContinue@<span class="number">8</span>   <span class="comment">// __stdcall NtContinue(PCONTEXT Context, BOOLEAN TestAlert)</span></span><br><span class="line">.text:<span class="number">7</span>C92E43F                 nop</span><br><span class="line">.text:<span class="number">7</span>C92E43F _KiUserApcDispatcher@<span class="number">20</span> endp <span class="comment">// sp-analysis failed</span></span><br></pre></td></tr></table></figure>

<p>然后在3环的<code>ZwContinue</code>函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//R3 ZwContinue</span></span><br><span class="line">.text:<span class="number">7</span>C92D040 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">7</span>C92D040</span><br><span class="line">.text:<span class="number">7</span>C92D040 <span class="comment">// NTSTATUS __stdcall NtContinue(PCONTEXT Context, BOOLEAN TestAlert)</span></span><br><span class="line">.text:<span class="number">7</span>C92D040</span><br><span class="line">.text:<span class="number">7</span>C92D040 <span class="comment">// __stdcall ZwContinue(x, x)</span></span><br><span class="line">.text:<span class="number">7</span>C92D040                 <span class="keyword">public</span> _ZwContinue@<span class="number">8</span></span><br><span class="line">.text:<span class="number">7</span>C92D040 _ZwContinue@<span class="number">8</span>   proc near               <span class="comment">// CODE XREF: KiUserApcDispatcher(x,x,x,x,x)+A↓p</span></span><br><span class="line">.text:<span class="number">7</span>C92D040                                         <span class="comment">// KiUserExceptionDispatcher(x,x)+17↓p ...</span></span><br><span class="line">.text:<span class="number">7</span>C92D040                 mov     eax, <span class="number">20</span>h        <span class="comment">// NtContinue</span></span><br><span class="line">.text:<span class="number">7</span>C92D045                 mov     edx, <span class="number">7F</span>FE0300h</span><br><span class="line">.text:<span class="number">7</span>C92D04A                 call    dword ptr [edx]</span><br><span class="line">.text:<span class="number">7</span>C92D04C                 retn    <span class="number">8</span></span><br><span class="line">.text:<span class="number">7</span>C92D04C _ZwContinue@<span class="number">8</span>   endp</span><br><span class="line">.text:<span class="number">7</span>C92D04C</span><br><span class="line">.text:<span class="number">7</span>C92D04C <span class="comment">// ---------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>可以看到，通过<code>_ZwContinue</code>函数走的是快速调用<code>KiFastSystemCall</code>进的0环。进入0环后的函数是<code>KiFastCallEntry</code>，然后将其分发到函数<code>NtContinue</code>中。</p>
</li>
<li><p>0环<code>NtContinue</code>函数调用<code>KiContinue</code>将保存在3环的<code>Context</code>拷贝到<code>TrapFrame_Initial</code>使其被更新，然后调用<code>KeTestAlertThread</code>去设置<code>Thread.ApcState[UserMode].UserApcPending = 1</code>。</p>
</li>
<li><p>然后<code>NtContinue</code>接着调用函数<code>KiServiceExit2</code>继续去判断是否还有用户APC待执行，<strong>这样就会构成一个循环</strong>。让用户APC全部能够得到执行。</p>
</li>
</ol>
<div class="note success"><p>以上可以看到，步骤2每当在<code>KiDeliverApc</code>中准备去执行一个用户APC时会设置<code>Thread-&gt;ApcState[UserMode].UserApcPending = FALSE</code>，而步骤5当这一个用户APC在3环执行完毕并返回0环后，会调用<code>KeTestAlertThread</code>去设置<code>Thread.ApcState[UserMode].UserApcPending = 1</code>。这样在<code>NtContinue</code>又会接着调用函数<code>KiServiceExit2</code>继续去判断是否还有用户APC待执行，<strong>这样就会构成一个循环</strong>。让用户APC全部能够得到执行。</p>
</div>

<h3 id="7-3-3环的APC注入"><a href="#7-3-3环的APC注入" class="headerlink" title="7.3 3环的APC注入"></a>7.3 3环的APC注入</h3><p>​    </p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/WinXP-APC2/" title="Windows XP APC（二）">https://directoree.github.io/post/WinXP-APC2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/WinXP%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> WinXP内核</a>
              <a href="/tags/APC/" rel="tag"><i class="fa fa-tag"></i> APC</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/WinXP-APC/" rel="prev" title="Windows XP APC（一）">
                  <i class="fa fa-chevron-left"></i> Windows XP APC（一）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/WinXp-InterruptAndException/" rel="next" title="Windows XP 中断与异常（段内容补充一）">
                  Windows XP 中断与异常（段内容补充一） <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">2.2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">32:53</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/WinXP-APC2/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
