<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ğŸ˜„">
<meta property="og:type" content="article">
<meta property="og:title" content="x64 å¼‚å¸¸å¤„ç†">
<meta property="og:url" content="https://directoree.github.io/post/x64-Disassembly3/index.html">
<meta property="og:site_name" content="Catecat">
<meta property="og:description" content="ğŸ˜„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/10/24/zdUJXADSMcZ7oRh.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/25/yQKnSvhNlAVUi1j.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/24/XlPBxk7STz9CLKM.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/24/RmPadEeVi5xy4wu.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/26/lToEdBCway8bctH.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/24/4bMW1qHsR3QKNny.png">
<meta property="article:published_time" content="2022-10-23T16:03:07.000Z">
<meta property="article:modified_time" content="2022-10-28T18:17:29.224Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="Windowså†…æ ¸">
<meta property="article:tag" content="x64 å¼‚å¸¸å¤„ç†">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/10/24/zdUJXADSMcZ7oRh.png">


<link rel="canonical" href="https://directoree.github.io/post/x64-Disassembly3/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>x64 å¼‚å¸¸å¤„ç† | Catecat</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Catecat</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">çˆ±ä½ æ‰€çˆ±ï¼Œè¡Œä½ æ‰€è¡Œï¼Œå¬ä»ä½ å¿ƒï¼Œæ— é—®è¥¿ä¸œã€‚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-æ›´æ–°æ—¥å¿—">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>æ›´æ–°æ—¥å¿—</a>

  </li>
        <li class="menu-item menu-item-ç©ºè°ƒæˆ¿">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>ç©ºè°ƒæˆ¿</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%9F%BA%E7%A1%80"><span class="nav-text">1 å¼‚å¸¸å¤„ç†åŸºç¡€</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%8F%B6%E5%87%BD%E6%95%B0%E4%B8%8E%E9%9D%9E%E5%8F%B6%E5%87%BD%E6%95%B0"><span class="nav-text">1.1 å¶å‡½æ•°ä¸éå¶å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-prolog-%E5%92%8C-epilog"><span class="nav-text">1.2 prolog å’Œ epilog</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-RUNTIME-FUNCTION"><span class="nav-text">2 RUNTIME_FUNCTION</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-UNWIND-INFO"><span class="nav-text">2.1 UNWIND_INFO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-UNWIND-CODE"><span class="nav-text">2.2 UNWIND_CODE</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-x64%E5%A0%86%E6%A0%88%E5%9B%9E%E6%BB%9A"><span class="nav-text">3 x64å †æ ˆå›æ»š</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Windbg%E8%B0%83%E8%AF%95%E5%A0%86%E6%A0%88%E5%9B%9E%E6%BB%9A"><span class="nav-text">3.1 Windbgè°ƒè¯•å †æ ˆå›æ»š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-UNWIND-INFO%E5%A0%86%E6%A0%88%E5%9B%9E%E6%BB%9A"><span class="nav-text">3.2 UNWIND_INFOå †æ ˆå›æ»š</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-text">4 å¼‚å¸¸å¤„ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%BC%82%E5%B8%B8%E4%BA%A7%E7%94%9F%E4%B8%8E%E9%87%87%E9%9B%86"><span class="nav-text">4.1 å¼‚å¸¸äº§ç”Ÿä¸é‡‡é›†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%BC%82%E5%B8%B8%E5%88%86%E5%8F%91"><span class="nav-text">4.2 å¼‚å¸¸åˆ†å‘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E5%86%85%E6%A0%B8%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-text">4.3 å†…æ ¸å¼‚å¸¸å¤„ç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E7%94%A8%E6%88%B7%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-text">4.4 ç”¨æˆ·å¼‚å¸¸å¤„ç†</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">144</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">76</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail â†’ mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ â†’ http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/x64-Disassembly3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Catecat">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          x64 å¼‚å¸¸å¤„ç†
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-10-24 00:03:07" itemprop="dateCreated datePublished" datetime="2022-10-24T00:03:07+08:00">2022-10-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-29 02:17:29" itemprop="dateModified" datetime="2022-10-29T02:17:29+08:00">2022-10-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/x64-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">x64 å¼‚å¸¸å¤„ç†</span></a>
        </span>
    </span>

  
    <span id="/post/x64-Disassembly3/" class="post-meta-item leancloud_visitors" data-flag-title="x64 å¼‚å¸¸å¤„ç†" title="é˜…è¯»æ¬¡æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/post/x64-Disassembly3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/x64-Disassembly3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>23k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>21 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ğŸ˜„</p>
<span id="more"></span>

<h2 id="1-å¼‚å¸¸å¤„ç†åŸºç¡€"><a href="#1-å¼‚å¸¸å¤„ç†åŸºç¡€" class="headerlink" title="1 å¼‚å¸¸å¤„ç†åŸºç¡€"></a>1 å¼‚å¸¸å¤„ç†åŸºç¡€</h2><h3 id="1-1-å¶å‡½æ•°ä¸éå¶å‡½æ•°"><a href="#1-1-å¶å‡½æ•°ä¸éå¶å‡½æ•°" class="headerlink" title="1.1 å¶å‡½æ•°ä¸éå¶å‡½æ•°"></a>1.1 å¶å‡½æ•°ä¸éå¶å‡½æ•°</h3><ul>
<li><mark class="label warning">éå¶å‡½æ•°</mark>ï¼šåœ¨å‡½æ•°ä¸­è°ƒç”¨å…¶ä»–å‡½æ•°ï¼ˆå­å‡½æ•°ï¼‰ã€åœ¨å‡½æ•°ä¸­å¼€è¾Ÿæ ˆç©ºé—´ã€ä¿å­˜éæ˜“å¤±å¯„å­˜å™¨ã€ä½¿ç”¨ SEH ç­‰è¡Œä¸ºçš„å‡½æ•°ï¼ˆæ¯ä¸ªâ€œã€â€è¡¨ç¤ºâ€æˆ–â€œï¼‰ã€‚</li>
<li><mark class="label success">å¶å‡½æ•°</mark>ï¼šæ—¢ä¸è°ƒç”¨å‡½æ•°ï¼Œåˆæ²¡æœ‰ä¿®æ”¹æ ˆæŒ‡é’ˆ RSPï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨ SEH çš„å‡½æ•°å°±å«åšå¶å‡½æ•°ã€‚</li>
</ul>
<p>æ˜“å¤±å¯„å­˜å™¨ä¸éå¤±å˜å¯„å­˜å™¨å¯„å­˜å™¨ï¼š</p>
<ul>
<li>æ˜“å¤±å¯„å­˜å™¨ï¼šRAX, RCX, RDX, R8-R11</li>
<li>éå¤±å˜å¯„å­˜å™¨ï¼šRBP, RBX, RSI, RDI, R12-R15</li>
</ul>
<h3 id="1-2-prolog-å’Œ-epilog"><a href="#1-2-prolog-å’Œ-epilog" class="headerlink" title="1.2 prolog å’Œ epilog"></a>1.2 prolog å’Œ epilog</h3><p>x64 ä¸­çš„å‡½æ•°è¢«åˆ†æˆä¸‰ä¸ªç»“æ„ï¼š<strong>prolog â€” å‡½æ•°ä½“ â€” epilog</strong>ã€‚</p>
<p>x64 çš„å‡½æ•°å†…åœ¨ä¸€å¼€å§‹ä½¿ç”¨ <code>prolog</code> æ¥å¼€è¾Ÿå †æ ˆï¼Œåœ¨æœ€åæ—¶æ‰ä½¿ç”¨ <code>epilog</code> æ¥å¹³è¡¡å †æ ˆã€‚è€Œä¸åƒæ˜¯ x86 ä¸­çš„ <code>__cdecl</code> è°ƒç”¨çº¦å®šé‚£æ ·æ¯æ¬¡è°ƒç”¨å®Œå‡½æ•°ç«‹å³è¦å¹³è¡¡å †æ ˆã€‚<strong>x64 æ˜¯åœ¨å‡½æ•°æœ€åçš„ <code>epilog</code> æ¥å¹³è¡¡å †æ ˆ</strong>ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/10/24/zdUJXADSMcZ7oRh.png" alt="21.png"></p>
<div class="note danger"><p><code>x64</code> å‡½æ•°å°† <code>push</code> å’Œ <code>pop</code> æŒ‡ä»¤åˆ†åˆ«é™åˆ¶åœ¨ <code>prolog</code> å’Œ <code>epilog</code>ä¸­ä½¿ç”¨ã€‚å †æ ˆæŒ‡é’ˆåœ¨ <code>prolog</code> å’Œ <code>epilog</code> ä¹‹é—´ä¸€å®šä¿æŒä¸å˜è¿™ä¸€äº‹å®æ˜¯ <code>x64</code> å‡½æ•°çš„ä¸€ä¸ªç‰¹å¾ã€‚</p>
</div>

<p>å‡½æ•°çš„æ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/25/yQKnSvhNlAVUi1j.png" alt="25.png"></p>
<p>ä»£ç å¦‚ä¸‹ï¼Œå®é™…ä¸Šå…¶ä¸­å‡½æ•°1è°ƒç”¨2ï¼Œä½†æ˜¯éƒ½å·²ç»ä¼˜åŒ–åœ¨ <code>main</code> å‡½æ•°ä¸­è¿›è¡Œè°ƒç”¨ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯è°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…å…±äº«åŒä¸€ä¸ªæ ˆå¸§ï¼Œå‡å°‘å¼€é”€ã€‚ </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000140001070</span> <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0000000140001070</span></span><br><span class="line">.text:<span class="number">0000000140001070</span></span><br><span class="line">.text:<span class="number">0000000140001070</span> sub_140001070   proc near               <span class="comment">// CODE XREF: sub_1400011F4+107â†“p</span></span><br><span class="line">.text:<span class="number">0000000140001070</span>                                         <span class="comment">// DATA XREF: .pdata:000000014000400Câ†“o</span></span><br><span class="line">.text:<span class="number">0000000140001070</span>                 push    rbx</span><br><span class="line">.text:<span class="number">0000000140001072</span>                 sub     rsp, <span class="number">20</span>h	<span class="comment">//prolog åˆ°æ­¤è¡Œ</span></span><br><span class="line">.text:<span class="number">0000000140001076</span>                 call    sub_1400010C0</span><br><span class="line">.text:<span class="number">000000014000107B</span>                 mov     rdx, rax</span><br><span class="line">.text:<span class="number">000000014000107</span>E                 lea     rcx, unk_140002240</span><br><span class="line">.text:<span class="number">0000000140001085</span>                 mov     rbx, rax</span><br><span class="line">.text:<span class="number">0000000140001088</span>                 call    sub_140001010</span><br><span class="line">.text:<span class="number">000000014000108</span>D                 lea     rdx, [rbx+<span class="number">10</span>h]</span><br><span class="line">.text:<span class="number">0000000140001091</span>                 lea     rcx, a0xLlx     <span class="comment">// &quot;0x%llx\n&quot;</span></span><br><span class="line">.text:<span class="number">0000000140001098</span>                 call    sub_140001010</span><br><span class="line">.text:<span class="number">000000014000109</span>D                 lea     rcx, Command    <span class="comment">// &quot;pause&quot;</span></span><br><span class="line">.text:<span class="number">00000001400010</span>A4                 call    cs:system</span><br><span class="line">.text:<span class="number">00000001400010</span>AA                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">00000001400010</span>AC                 add     rsp, <span class="number">20</span>h	<span class="comment">//epilog ä»æ­¤è¡Œå¼€å§‹</span></span><br><span class="line">.text:<span class="number">00000001400010B</span>0                 pop     rbx</span><br><span class="line">.text:<span class="number">00000001400010B</span>1                 retn</span><br><span class="line">.text:<span class="number">00000001400010B</span>1 sub_140001070   endp</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨ x86 CPU ä¸Šï¼ŒFS æ®µå¯„å­˜å™¨æŒ‡å‘çº¿ç¨‹ç¯å¢ƒå— (TEB) å’Œå¤„ç†å™¨æ§åˆ¶åŒºåŸŸ (<code>KPCR</code>)ï¼Œä½†åœ¨ x64 ä¸Šï¼ŒGS å¯„å­˜å™¨åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æŒ‡å‘ TEBï¼Œåœ¨å†…æ ¸ä¸­æŒ‡å‘ KPCR çš„æ–°æ¨¡å¼ã€‚ç„¶è€Œï¼Œå½“è¿è¡Œ WOW64 åº”ç”¨ç¨‹åºï¼ˆå³ x64 ç³»ç»Ÿä¸Šçš„ 32 ä½åº”ç”¨ç¨‹åºï¼‰æ—¶ï¼ŒFS å¯„å­˜å™¨ç»§ç»­æŒ‡å‘ 32 ä½ç‰ˆæœ¬çš„ TEBã€‚<code>x64</code>ä¸Šçš„é™·é˜±å¸§ç»“æ„ä½“ <code>nt!_KTRAP_FRAME</code> <mark class="label danger">ä¸åŒ…å«éæ˜“å¤±æ€§å¯„å­˜å™¨çš„æœ‰æ•ˆå†…å®¹</mark>ã€‚å¦‚æœæ‰“ç®—ä¿®æ”¹éæ˜“å¤±æ€§å¯„å­˜å™¨ï¼Œ<code>X64</code>å‡½æ•°çš„<code>prolog</code>ä¼šä¿å­˜éæ˜“å¤±æ€§å¯„å­˜å™¨çš„å€¼ã€‚è°ƒè¯•å™¨å§‹ç»ˆå¯ä»¥ä»å †æ ˆä¸­æå–è¿™äº›éæ˜“å¤±æ€§å¯„å­˜å™¨çš„ä¿å­˜å€¼ï¼Œè€Œä¸å¿…ä»é™·é˜±å¸§ä¸­è·å–å®ƒä»¬ã€‚ åœ¨<code>x64</code>ä¸Šçš„å†…æ ¸æ¨¡å¼è°ƒè¯•æœŸé—´ï¼Œ<code>.trap</code>å‘½ä»¤çš„è¾“å‡ºä¼šæ‰“å°ä¸€æ¡æ³¨é‡Šï¼Œçªå‡ºæ˜¾ç¤ºä»é™·é˜±ä¸­æ£€ç´¢åˆ°çš„æ‰€æœ‰å¯„å­˜å™¨çš„å€¼å¯èƒ½ä¸å‡†ç¡®çš„äº‹å®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚æ­¤è§„åˆ™æœ‰ä¾‹å¤–ï¼Œä¾‹å¦‚ï¼Œä¸ºç”¨æˆ·åˆ°å†…æ ¸æ¨¡å¼è½¬æ¢ç”Ÿæˆçš„é™·é˜±å¸§ç¡®å®åŒ…å«æ‰€æœ‰å¯„å­˜å™¨çš„æ­£ç¡®å€¼ã€‚</p>
</blockquote>
<h2 id="2-RUNTIME-FUNCTION"><a href="#2-RUNTIME-FUNCTION" class="headerlink" title="2 RUNTIME_FUNCTION"></a>2 RUNTIME_FUNCTION</h2><p>x64 çš„ PE32+ å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ¯” 32 ä½çš„ PE æ–‡ä»¶å¤šä¸€ä¸ª <code>.pdata</code> èŠ‚åŒºï¼ŒåŒæ—¶è¿˜ä¼šä½¿ç”¨<strong>å¼‚å¸¸ç›®å½•</strong>æ•°æ®è¡¨ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/10/24/XlPBxk7STz9CLKM.png" alt="22.png"></p>
<p><strong>æ¯ä¸ªéå¶å‡½æ•°éƒ½æœ‰ä¸€ä¸ª <code>RUNTIME_FUNCTION</code> ç»“æ„</strong>ã€‚<code>RUNTIME_FUNCTION</code> ç»“æ„æè¿°äº†éå¶å‡½æ•°ä¿¡æ¯åŠ <code>prolog</code> ä¸­ç›¸å…³çš„æ“ä½œï¼ˆåŒ…æ‹¬å †æ ˆæå‡å’Œéå¶å‡½æ•°æ˜¯å¦å®‰è£…äº† SEHç­‰ï¼‰ã€‚æŒ‰ <code>BeginAddress</code> å‡åºæ’åˆ—ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_RUNTIME_FUNCTION_ENTRY</span> &#123;</span></span><br><span class="line">  ULONG BeginAddress;	<span class="comment">// RVA</span></span><br><span class="line">  ULONG EndAddress;	<span class="comment">// RVA</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    ULONG UnwindInfoAddress;</span><br><span class="line">    ULONG UnwindData;	<span class="comment">// RVA</span></span><br><span class="line">  &#125; DUMMYUNIONNAME;</span><br><span class="line">&#125; RUNTIME_FUNCTION, *PRUNTIME_FUNCTION, _IMAGE_RUNTIME_FUNCTION_ENTRY, *_PIMAGE_RUNTIME_FUNCTION_ENTRY;</span><br></pre></td></tr></table></figure>

<ul>
<li>BeginAddressï¼šå½“å‰éå¶å‡½æ•°ç¬¬ä¸€æ¡æŒ‡ä»¤ç›¸å¯¹äº <code>ImageBase</code> çš„ <code>RVA</code> èµ·å§‹åœ°å€ã€‚</li>
<li>EndAddressï¼šå½“å‰éå¶å‡½æ•°æœ€åä¸€æ¡æŒ‡ä»¤ç›¸å¯¹äº <code>ImageBase</code> çš„ <code>RVA</code> ç»ˆæ­¢åœ°å€ã€‚</li>
<li>UnwindInfoAddressï¼šä¸€ä¸ªæŒ‡å‘å±•å¼€ä¿¡æ¯ç»“æ„ï¼ˆ<code>UNWIND_INFO </code>ï¼‰çš„æŒ‡é’ˆ <code>RVA</code>ï¼Œè¯¥ç»“æ„æè¿°äº†åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶å¦‚ä½•å±•å¼€å‡½æ•°çš„è°ƒç”¨å †æ ˆã€‚</li>
</ul>
<div class="note success"><p>å½“å‡½æ•°å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨å½“å‰ <code>RIP</code> åˆ° <code>RUNTIME_FUNCTION</code> è¡¨ä¸­ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ°å½“å‰å‡½æ•°çš„æ ˆå±•å¼€ä¿¡æ¯ <code>UNWIND_INFO</code>ã€‚</p>
</div>



<p><strong>ç»ƒä¹ ï¼šæŸ¥çœ‹æŒ‡å®šå‡½æ•°çš„ RUNTIME_FUNCTION</strong></p>
<p><code>.fnent </code>å‘½ä»¤æ˜¾ç¤ºæœ‰å…³ç»™å®šå‡½æ•°çš„ <code>RUNTIME_FUNCTION</code> ç»“æ„çš„ä¿¡æ¯ã€‚</p>
<p>ç”¨æˆ·æ¨¡å¼çš„é¡¶å±‚å¤„ç†å‡½æ•° SEH å®‰è£…åœ¨ <code>ntdll!RtlUserThreadStart</code> ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; .fnent ntdll!RtlUserThreadStart</span><br><span class="line">Debugger function entry <span class="number">00000137</span>`<span class="number">838</span>a88d8 <span class="keyword">for</span>:</span><br><span class="line">(<span class="number">00007f</span>f9`<span class="number">40</span>ec2680)   ntdll!RtlUserThreadStart   |  (<span class="number">00007f</span>f9`<span class="number">40</span>ec26d0)   ntdll!TpReleaseCleanupGroupMembers</span><br><span class="line">Exact matches:</span><br><span class="line"></span><br><span class="line">BeginAddress      = <span class="number">00000000</span>`<span class="number">00052680</span></span><br><span class="line">EndAddress        = <span class="number">00000000</span>`<span class="number">000526</span>c9</span><br><span class="line">UnwindInfoAddress = <span class="number">00000000</span>`<span class="number">0014763</span>c</span><br><span class="line"></span><br><span class="line">Unwind info at <span class="number">00007f</span>f9`<span class="number">40f</span>b763c, <span class="number">10</span> bytes</span><br><span class="line">  version <span class="number">1</span>, flags <span class="number">1</span>, prolog <span class="number">4</span>, codes <span class="number">1</span></span><br><span class="line">  handler routine: ntdll!_C_specific_handler (<span class="number">00007f</span>f9`<span class="number">40</span>efc720), data <span class="number">1</span></span><br><span class="line">  <span class="number">00</span>: offs <span class="number">4</span>, unwind op <span class="number">2</span>, op info e	UWOP_ALLOC_SMALL.</span><br></pre></td></tr></table></figure>

<ol>
<li><p>æŸ¥çœ‹å‡½æ•°çš„ <code>BeginAddress</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; lm ntdll</span><br><span class="line">Unknown option <span class="string">&#x27;d&#x27;</span></span><br><span class="line">start             end                 <span class="keyword">module</span> name</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40e70000</span> <span class="number">00007f</span>f9`<span class="number">41068000</span>   ntdll    ntdll.<span class="function">dll    <span class="title">FE96C48E</span> <span class="params">(This is a reproducible build file hash, <span class="keyword">not</span> a timestamp)</span></span></span><br><span class="line">fffff801`78600000 fffff801`79646000   nt       ntkrnlmp.exe 2FF0D722 (This is a reproducible build file hash, not a timestamp)</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: kd&gt; u <span class="number">0x00007ff9</span>`<span class="number">40e70000</span>+<span class="number">0x00000000</span>`<span class="number">00052680</span></span><br><span class="line">ntdll!RtlUserThreadStart:</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec2680 <span class="number">4883</span>ec78        sub     rsp,<span class="number">78</span>h</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec2684 <span class="number">4</span>c8bc9          mov     r9,rcx</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec2687 <span class="number">488b</span>0562991100  mov     rax,qword ptr [ntdll!Kernel32ThreadInitThunkFunction (<span class="number">00007f</span>f9`<span class="number">40f</span>dbff0)]</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec268e <span class="number">4885</span>c0          test    rax,rax</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec2691 <span class="number">7410</span>            je      ntdll!RtlUserThreadStart+<span class="number">0x23</span> (<span class="number">00007f</span>f9`<span class="number">40</span>ec26a3)</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec2693 <span class="number">4</span>c8bc2          mov     r8,rdx</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec2696 <span class="number">488b</span>d1          mov     rdx,rcx</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec2699 <span class="number">33</span>c9            <span class="keyword">xor</span>     ecx,ecx</span><br></pre></td></tr></table></figure>


</li>
<li><p>æŸ¥çœ‹å‡½æ•°çš„ <code>EndAddress</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; ub <span class="number">0x00007ff9</span>`<span class="number">40e70000</span>+<span class="number">0x00000000</span>`<span class="number">000526</span>c9</span><br><span class="line">ntdll!RtlUserThreadStart+<span class="number">0x36</span>:</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26b6 <span class="number">90</span>              nop</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26b7 <span class="number">8b</span>d0            mov     edx,eax</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26b9 <span class="number">4883</span>c9ff        <span class="keyword">or</span>      rcx,<span class="number">0F</span>FFFFFFFFFFFFFFFh</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26bd e8aeae0400      call    ntdll!NtTerminateProcess (<span class="number">00007f</span>f9`<span class="number">40f</span>0d570)</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26c2 <span class="number">90</span>              nop</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26c3 <span class="number">4883</span>c478        add     rsp,<span class="number">78</span>h</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26c7 c3              ret</span><br><span class="line"><span class="number">00007f</span>f9`<span class="number">40</span>ec26c8 cc              <span class="keyword">int</span>     <span class="number">3</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><img data-src="https://s2.loli.net/2022/10/24/RmPadEeVi5xy4wu.png" alt="24.png"></p>
<h3 id="2-1-UNWIND-INFO"><a href="#2-1-UNWIND-INFO" class="headerlink" title="2.1 UNWIND_INFO"></a>2.1 UNWIND_INFO</h3><p><code>RUNTIME_FUNCTION</code> ç»“æ„çš„ <code>UnwindInfoAddress</code> å­—æ®µæ˜¯ä¸€ä¸ª <code>UNWIND_INFO</code> ç»“æ„çš„åç§»é‡ï¼Œå®ƒå‘Šè¯‰æ“ä½œç³»ç»Ÿè¿è¡Œæ—¶å®ƒåº”è¯¥å¦‚ä½•å±•å¼€å †æ ˆã€‚<code>UNWIND_INFO</code> ç»“æ„åŒ…å«æ•°é‡ä¸å®šçš„ <code>UNWIND_CODE</code> ç»“æ„ï¼Œæ¯ä¸ªç»“æ„éƒ½å­˜å‚¨ç€å¯¹åº”éå¶å‡½æ•° <code>prolog</code> å¯¹å †æ ˆç›¸å…³æ“ä½œçš„ä¿¡æ¯ã€‚</p>
<p><strong><code>UNWIND_INFO</code> ç»“æ„ä½“ä¿å­˜äº†å¼‚å¸¸å¤„ç†çš„ä¿¡æ¯</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_NHANDLER 0x0		<span class="comment">// æ²¡æœ‰å®‰è£…SEHï¼Œæ—¢æ²¡æœ‰ EXCEPT_FILTER ä¹Ÿæ²¡æœ‰ EXCEPT_HANDLER</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_EHANDLER 0x1		<span class="comment">// è¡¨ç¤ºè¯¥å‡½æ•°æœ‰ EXCEPT_FILTER &amp; EXCEPT_HANDLER</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_UHANDLER 0x2		<span class="comment">// è¡¨ç¤ºè¯¥å‡½æ•°æœ‰ FINALLY_HANDLER</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_CHAININFO 0x4		<span class="comment">// è¡¨ç¤ºè¯¥å‡½æ•°æœ‰å¤šä¸ª UNWIND_INFOï¼Œå®ƒä»¬ä¸²æ¥åœ¨ä¸€èµ·ï¼ˆæ‰€è°“çš„ chainé“¾ï¼‰</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">UNWIND_INFO</span> &#123;</span></span><br><span class="line"><span class="comment">/* +00 */</span>        UCHAR Version : <span class="number">3</span>;	<span class="comment">// ä½3ä½ï¼ˆç‰ˆæœ¬å·ï¼‰ï¼Œç›®å‰ä¸º1</span></span><br><span class="line"><span class="comment">/* +00 */</span>        UCHAR Flags : <span class="number">5</span>;	<span class="comment">// é«˜5ä½ï¼ˆæ ‡å¿—ï¼‰å€¼ä¸ºä¸Šè¿°defineå®šä¹‰ä¸­çš„ä¸€ä¸ª</span></span><br><span class="line"><span class="comment">/* +01 */</span>        UCHAR SizeOfProlog;	<span class="comment">// prolog çš„å¤§å°ï¼ˆå­—èŠ‚å•ä½ï¼‰</span></span><br><span class="line"><span class="comment">/* +02 */</span>        UCHAR CountOfCodes;	<span class="comment">// è¡¨ç¤ºå½“å‰ UNWIND_INFO åŒ…å«å¤šå°‘ä¸ª UNWIND_CODE ç»“æ„</span></span><br><span class="line"><span class="comment">/* +03 */</span>        UCHAR FrameRegister : <span class="number">4</span>;<span class="comment">// å¦‚æœå‡½æ•°å»ºç«‹äº†æ ˆå¸§ï¼Œå®ƒè¡¨ç¤ºæ ˆå¸§çš„ç´¢å¼•ï¼ˆç›¸å¯¹äº CONTEXT::RAX çš„åç§»ï¼‰ã€‚å¦åˆ™è¯¥æˆå‘˜çš„å€¼ä¸º0</span></span><br><span class="line"><span class="comment">/* +03 */</span>        UCHAR FrameOffset : <span class="number">4</span>;	<span class="comment">// è¡¨ç¤ºFrameRegisterè·ç¦»å‡½æ•°æœ€åˆæ ˆé¡¶ï¼ˆå®Œæˆprologï¼Œæ²¡æœ‰æ‰§è¡Œå…¶ä»–æŒ‡ä»¤æ—¶çš„æ ˆé¡¶ï¼‰åç§»</span></span><br><span class="line"><span class="comment">/* +04 */</span>        UNWIND_CODE UnwindCode[<span class="number">1</span>];<span class="comment">// UnwindCode æ•°ç»„è¯¦ç»†è®°å½•äº†å‡½æ•°ä¿®æ”¹æ ˆã€ä¿å­˜éæ˜“å¤±æ€§å¯„å­˜å™¨çš„æŒ‡ä»¤</span></span><br><span class="line">     </span><br><span class="line">     		<span class="comment">//å¦‚æœFlagsè®¾ç½®äº†UNW_FLAG_EHANDLERæˆ–UNW_FLAG_UHANDLERï¼Œä¸‹é¢å­˜æ”¾ExceptionHandlerã€ExceptionData</span></span><br><span class="line">     		<span class="comment">//å¦‚æœFlagsè®¾ç½®äº†UNW_FLAG_CHAININFOï¼Œåˆ™ä¸‹é¢å­˜æ”¾çš„æ˜¯RUNTIME_FUNCTIONç»“æ„</span></span><br><span class="line">     		<span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">       		<span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line"><span class="comment">/* +08 */</span>          		OPTIONAL ULONG ExceptionHandler;    <span class="comment">// RVA, Exception handler routine</span></span><br><span class="line"><span class="comment">/* +0C */</span>          		OPTIONAL ULONG ExceptionData[];     <span class="comment">// RVA, Scope table structure</span></span><br><span class="line">            		&#125;;</span><br><span class="line">		</span><br><span class="line"><span class="comment">/* +08 */</span> OPTIONAL RUNTIME_FUNCTION RuntimeFunctionChain;</span><br><span class="line">     		&#125;; </span><br><span class="line">  </span><br><span class="line">&#125; UNWIND_INFO, *PUNWIND_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SCOPE_TABLE</span> &#123;</span></span><br><span class="line">        ULONG Count;		<span class="comment">// ä¸‹é¢ ScopeRecord ç»“æ„æ•°ç»„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG BeginAddress;	<span class="comment">// RVA,__tryå—çš„å¼€å§‹åœ°å€</span></span><br><span class="line">            ULONG EndAddress;	<span class="comment">// RVA,__tryå—çš„ç»“æŸåœ°å€</span></span><br><span class="line">            ULONG HandlerAddress;<span class="comment">// ç›¸å¯¹äºBeginAddressçš„RVA</span></span><br><span class="line">          			<span class="comment">// __try__except:è¿‡æ»¤è¡¨è¾¾å¼ï¼Œ__try__finally:FINALLY_HANDLER</span></span><br><span class="line">            ULONG JumpTarget;	<span class="comment">// RVA__try__except:EXCEPT_HANDLERï¼Œ__try__finally:0</span></span><br><span class="line">        &#125; ScopeRecord[<span class="number">1</span>];</span><br><span class="line">    &#125; SCOPE_TABLE, *PSCOPE_TABLE;</span><br></pre></td></tr></table></figure>



<p><strong>SCOPE_TABLE</strong>ï¼š</p>
<p><code>SCOPE_TABLE</code> æ˜¯ä¸€ä¸ªå˜é•¿çš„ç»“æ„ä½“ï¼Œç”¨æ¥æè¿°æ¯ä¸€ä¸ª<code>__try__except </code> æˆ– <code>__try__finally</code> çš„ä½ç½®ï¼Œæ¯ä¸€ä¸ªè¡¨é¡¹å¯¹åº”ä¸€ä¸ª <code>__try</code> è¯­å¥ã€‚</p>
<ol>
<li><p>åœ¨ IDA ä¸­å¯¹å®‰è£…äº† SEH çš„å‡½æ•°è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œå¯ä»¥çœ‹åˆ° <code>UNWIND_INFO.ExceptionHandler</code> éƒ½æ˜¯ä¸º <code>__C_specific_hander</code> å‡½æ•°ï¼Œè¿™ç›¸å½“äº x86 SEH å¤„ç†çš„ <code>__except_hander3</code> å‡½æ•°ï¼Œå³ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†åˆ†å‘å…¥å£ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/10/26/lToEdBCway8bctH.png" alt="26.png"></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/devnotes/--c-specific-handler2">__C_specific_handler</a> å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_CRTIMP  __C_specific_handler(</span><br><span class="line">  _In_    struct _EXCEPTION_RECORD   *ExceptionRecord,</span><br><span class="line">  _In_    <span class="keyword">void</span>                       *EstablisherFrame,</span><br><span class="line">  _Inout_ struct _CONTEXT            *ContextRecord,</span><br><span class="line">  _Inout_ struct _DISPATCHER_CONTEXT *DispatcherContext</span><br><span class="line">);</span><br></pre></td></tr></table></figure>






</li>
<li><p><code>SCOPE_TABLE.JumpTarget</code> å¯¹åº”çš„å°±æ˜¯ <code>__except</code> å¤„ç†å‡½æ•°ã€‚</p>
<p>å‚è€ƒ<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/exception-handling-x64?view=msvc-170">MSDN-x64 å¼‚å¸¸å¤„ç†</a>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">EXCEPTION_DISPOSITION</span> <span class="params">(*PEXCEPTION_ROUTINE)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  IN PEXCEPTION_RECORD ExceptionRecord;</span></span></span><br><span class="line"><span class="function"><span class="params">  IN ULONG64 EstablisherFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN OUT PCONTEXT ContextRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN OUT PDISPATCHER_CONTEXT Dispatchercontext</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>ExceptionRecordï¼šå¼‚å¸¸é‡‡é›†ä¿¡æ¯ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘å…·æœ‰æ ‡å‡† Win64 å®šä¹‰çš„å¼‚å¸¸è®°å½•ã€‚</li>
<li>EstablisherFrameï¼šæ˜¯æ­¤å¼‚å¸¸å‘ç”Ÿå‡½æ•°çš„å›ºå®šå †æ ˆåˆ†é…çš„åŸºå€ã€‚</li>
<li>ContextRecordï¼šæŒ‡å‘å¼•å‘å¼‚å¸¸æ—¶çš„å¼‚å¸¸ä¸Šä¸‹æ–‡ï¼ˆåœ¨å¼‚å¸¸å¤„ç†ç¨‹åºçš„æƒ…å†µä¸‹ï¼‰æˆ–å½“å‰çš„å±•å¼€ä¸Šä¸‹æ–‡ï¼ˆåœ¨ç»ˆæ­¢å¤„ç†ç¨‹åºçš„æƒ…å†µä¸‹ï¼‰ã€‚</li>
<li>DispatcherContextï¼šæŒ‡å‘æ­¤å‡½æ•°çš„è°ƒåº¦ç¨‹åºä¸Šä¸‹æ–‡ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_RECORD64</span> &#123;</span></span><br><span class="line">  NTSTATUS ExceptionCode;</span><br><span class="line">  ULONG ExceptionFlags;</span><br><span class="line">  ULONG64 ExceptionRecord;</span><br><span class="line">  ULONG64 ExceptionAddress;</span><br><span class="line">  ULONG NumberParameters;</span><br><span class="line">  ULONG __unusedAlignment;</span><br><span class="line">  ULONG64 ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];</span><br><span class="line">&#125; EXCEPTION_RECORD64, *PEXCEPTION_RECORD64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_POINTERS</span> &#123;</span></span><br><span class="line">  PEXCEPTION_RECORD ExceptionRecord;</span><br><span class="line">  PCONTEXT ContextRecord;</span><br><span class="line">&#125; EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>PEXCEPTION_ROUTINE</code> çš„ <code>Dispatchercontext(PDISPATCHER_CONTEXT)</code> å‚æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DISPATCHER_CONTEXT</span> &#123;</span></span><br><span class="line">    ULONG64 ControlPc;</span><br><span class="line">    ULONG64 ImageBase;</span><br><span class="line">    PRUNTIME_FUNCTION FunctionEntry;</span><br><span class="line">    ULONG64 EstablisherFrame;</span><br><span class="line">    ULONG64 TargetIp;</span><br><span class="line">    PCONTEXT ContextRecord;</span><br><span class="line">    PEXCEPTION_ROUTINE LanguageHandler;</span><br><span class="line">    PVOID HandlerData;</span><br><span class="line">&#125; DISPATCHER_CONTEXT, *PDISPATCHER_CONTEXT;</span><br></pre></td></tr></table></figure>

<ul>
<li>ControlPcï¼šæ˜¯æ­¤å‡½æ•°ä¸­çš„ RIP å€¼ï¼ˆå¼‚å¸¸è§¦å‘ç‚¹ï¼‰ã€‚æ­¤å€¼å¯ä»¥æ˜¯å¼‚å¸¸åœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯æ§åˆ¶ç¦»å¼€å»ºç«‹å‡½æ•°çš„åœ°å€ã€‚</li>
<li>ImageBaseï¼šæ˜¯åŒ…å«æ­¤å‡½æ•°çš„æ¨¡å—çš„æ˜ åƒåŸºï¼ˆåŠ è½½åœ°å€ï¼‰ï¼Œå°†å…¶æ·»åŠ åˆ°å‡½æ•°å…¥å£ä½¿ç”¨çš„32ä½åç§»ï¼Œä»¥è®°å½•ç›¸å¯¹åœ°å€ã€‚</li>
<li>FunctionEntryï¼šæä¾›ä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ä¿å­˜æ­¤å‡½æ•°çš„å‡½æ•°å’Œå±•å¼€ä¿¡æ¯å›¾åƒåŸºç›¸å¯¹åœ°å€çš„ <code>RUNTIME_FUNCTION</code> å‡½æ•°é¡¹ã€‚</li>
<li>EstablisherFrameï¼š<code>ControlPc</code> æ‰€åœ¨å‡½æ•°çš„æ ˆå¸§ï¼ˆå¦‚æœå»ºç«‹äº†æ ˆå¸§ï¼‰æˆ– RSPã€‚</li>
<li>TargetIpï¼šå¤„ç†å¼‚å¸¸çš„ <code>__except</code> ä»£ç å—ï¼ˆç”± <code>__C_specific_hander</code> æ¥è´Ÿè´£è°ƒç”¨ï¼‰ã€‚å¦‚æœæœªæŒ‡å®š EstablisherFrameï¼Œåˆ™å¿½ç•¥æ­¤åœ°å€ã€‚</li>
<li>ContextRecordï¼šæŒ‡å‘å¼‚å¸¸ä¸Šä¸‹æ–‡ï¼Œä¾›ç³»ç»Ÿå¼‚å¸¸è°ƒåº¦&#x2F;å±•å¼€ä»£ç ä½¿ç”¨ã€‚</li>
<li>LanguageHandlerï¼šæŒ‡å‘è°ƒç”¨çš„å¼‚å¸¸å¤„ç†ç¨‹åºä¾‹ç¨‹ï¼ˆ<code>UNWIND_INFO.ExceptionHandler</code>ï¼Œå³ <code>__C_specific_hander</code>ï¼‰ã€‚</li>
<li>HandlerDataï¼šæŒ‡å‘æ­¤å‡½æ•°çš„å¼‚å¸¸å¤„ç†ç¨‹åºæ•°æ®ï¼ˆ<code>UNWIND_INFO.ExceptionData</code> ä¸­ <code>SCOPE_TABLE.ScopeRecord</code>ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<h3 id="2-2-UNWIND-CODE"><a href="#2-2-UNWIND-CODE" class="headerlink" title="2.2 UNWIND_CODE"></a>2.2 UNWIND_CODE</h3><p><code>UNWIND_CODE</code> ç»“æ„ç”¨æ¥æ¢å¤å‡½æ•° prolog å¯¹å †æ ˆæ‰§è¡Œçš„æ“ä½œï¼Œæ¯ä¸ª <code>UNWIND_CODE</code>  ç»“æ„ä»…å¯¹åº”ä¸€ä¸ªæ“ä½œï¼Œè¦ä¹ˆæ˜¯å¼€è¾Ÿå †æ ˆç©ºé—´ã€è¦ä¹ˆæ˜¯ <code>push</code> éæ˜“å¤±å¯„å­˜å™¨ã€‚</p>
<p><code>UNWIND_CODE</code> ç»“æ„çš„å†…å®¹æ˜¯åŒ…å«åœ¨ <code>UNWIND_INFO</code> é‡Œé¢çš„ï¼Œä¸æ˜¯é€šè¿‡ RVA å¾—åˆ°çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">UNWIND_OP_CODES</span> &#123;</span></span><br><span class="line">    UWOP_PUSH_NONVOL = <span class="number">0</span>,   <span class="comment">// 0, å‹å…¥éæ˜“å¤±æ€§æ•´æ•°å¯„å­˜å™¨ï¼Œå…·ä½“å‹å…¥å–å†³äºOpInfoå€¼</span></span><br><span class="line">    UWOP_ALLOC_LARGE,       <span class="comment">// 1</span></span><br><span class="line">    UWOP_ALLOC_SMALL,       <span class="comment">// 2</span></span><br><span class="line">    UWOP_SET_FPREG,         <span class="comment">// 3</span></span><br><span class="line">    UWOP_SAVE_NONVOL,       <span class="comment">// 4</span></span><br><span class="line">    UWOP_SAVE_NONVOL_FAR,   <span class="comment">// 5</span></span><br><span class="line">    UWOP_SPARE_CODE1,       <span class="comment">// 6</span></span><br><span class="line">    UWOP_SPARE_CODE2,       <span class="comment">// 7</span></span><br><span class="line">    UWOP_SAVE_XMM128,       <span class="comment">// 8</span></span><br><span class="line">    UWOP_SAVE_XMM128_FAR,   <span class="comment">// 9</span></span><br><span class="line">    UWOP_PUSH_MACHFRAME     <span class="comment">// 10</span></span><br><span class="line">&#125; UNWIND_OP_CODES, *PUNWIND_OP_CODES;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">UNWIND_CODE</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        UCHAR CodeOffset;</span><br><span class="line">        UCHAR UnwindOp : <span class="number">4</span>;</span><br><span class="line">        UCHAR OpInfo : <span class="number">4</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    USHORT FrameOffset;</span><br><span class="line">&#125; UNWIND_CODE, *PUNWIND_CODE;</span><br></pre></td></tr></table></figure>

<ul>
<li>CodeOffsetï¼šå½“å‰æŒ‡ä»¤åˆ° prolog ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åç§»ã€‚</li>
<li>UnwindOpï¼šå±•å¼€æ“ä½œç ï¼Œä¸º <code>UNWIND_OP_CODES</code> æšä¸¾å€¼ä¹‹ä¸€ã€‚å…·ä½“å«ä¹‰å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/exception-handling-x64?view=msvc-170">MSDN-x64 å¼‚å¸¸å¤„ç†-å±•å¼€æ“ä½œä»£ç </a>ã€‚</li>
<li>OpInfoï¼šå±•å¼€ä¿¡æ¯ï¼Œå–å†³äº UnwindOpï¼Œå…·ä½“å‚è€ƒ<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/exception-handling-x64?view=msvc-170">MSDN-x64 å¼‚å¸¸å¤„ç†-æ“ä½œä¿¡æ¯</a>ã€‚</li>
</ul>
<p><strong>æ³¨æ„</strong>ï¼šåœ¨æ¯ä¸€ä¸ª <code>UNWIND_INFO</code> ä¸‹çš„å¤šä¸ª <code>UNWIND_CODE</code> ä¸­ï¼Œ<code>UNWIND_CODE</code> <mark class="label danger">è¡¨ç¤ºçš„æ“ä½œä¸å®é™… prolog å¯¹å †æ ˆæ‰§è¡Œçš„æ“ä½œæ˜¯ç›¸åçš„</mark>ã€‚å¦‚ä¸‹å›¾ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/10/24/4bMW1qHsR3QKNny.png" alt="23.png"></p>
<p>å¯¹ <code>Exception Directory</code> çš„è§£æï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_NHANDLER 0x0		<span class="comment">// æ²¡æœ‰å®‰è£…SEHï¼Œæ—¢æ²¡æœ‰ EXCEPT_FILTER ä¹Ÿæ²¡æœ‰ EXCEPT_HANDLER</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_EHANDLER 0x1		<span class="comment">// è¡¨ç¤ºè¯¥å‡½æ•°æœ‰ EXCEPT_FILTER &amp; EXCEPT_HANDLER</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_UHANDLER 0x2		<span class="comment">// è¡¨ç¤ºè¯¥å‡½æ•°æœ‰ FINALLY_HANDLER</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UNW_FLAG_CHAININFO 0x4		<span class="comment">// è¡¨ç¤ºè¯¥å‡½æ•°æœ‰å¤šä¸ª UNWIND_INFOï¼Œå®ƒä»¬ä¸²æ¥åœ¨ä¸€èµ·ï¼ˆæ‰€è°“çš„ chainé“¾ï¼‰</span></span></span><br><span class="line"></span><br><span class="line">CHAR File_Name[] = <span class="string">&quot;C:\\Users\\alvin\\Desktop\\VS2019é¡¹ç›®æ–‡ä»¶å¤¹\\x64\\First_Inline_x64\\x64\\Release\\First_Inline_x64.exe&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">UNWIND_CODE</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		UCHAR CodeOffset;</span><br><span class="line">		UCHAR UnwindOp : <span class="number">4</span>;</span><br><span class="line">		UCHAR OpInfo : <span class="number">4</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	USHORT FrameOffset;</span><br><span class="line">&#125; UNWIND_CODE, * PUNWIND_CODE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">UNWIND_INFO</span> &#123;</span></span><br><span class="line">	<span class="comment">/* +00 */</span>        UCHAR Version : <span class="number">3</span>;	<span class="comment">// ä½3ä½ï¼ˆç‰ˆæœ¬å·ï¼‰ï¼Œç›®å‰ä¸º1</span></span><br><span class="line">	<span class="comment">/* +00 */</span>        UCHAR Flags : <span class="number">5</span>;	<span class="comment">// é«˜5ä½ï¼ˆæ ‡å¿—ï¼‰å€¼ä¸ºä¸Šè¿°defineå®šä¹‰ä¸­çš„ä¸€ä¸ª</span></span><br><span class="line">	<span class="comment">/* +01 */</span>        UCHAR SizeOfProlog;	<span class="comment">// prolog çš„å¤§å°ï¼ˆå­—èŠ‚å•ä½ï¼‰</span></span><br><span class="line">	<span class="comment">/* +02 */</span>        UCHAR CountOfCodes;	<span class="comment">// è¡¨ç¤ºå½“å‰ UNWIND_INFO åŒ…å«å¤šå°‘ä¸ª UNWIND_CODE ç»“æ„</span></span><br><span class="line">	<span class="comment">/* +03 */</span>        UCHAR FrameRegister : <span class="number">4</span>;<span class="comment">// å¦‚æœå‡½æ•°å»ºç«‹äº†æ ˆå¸§ï¼Œå®ƒè¡¨ç¤ºæ ˆå¸§çš„ç´¢å¼•ï¼ˆç›¸å¯¹äº CONTEXT::RAX çš„åç§»ï¼‰ã€‚å¦åˆ™è¯¥æˆå‘˜çš„å€¼ä¸º0</span></span><br><span class="line">	<span class="comment">/* +03 */</span>        UCHAR FrameOffset : <span class="number">4</span>;	<span class="comment">// è¡¨ç¤ºFrameRegisterè·ç¦»å‡½æ•°æœ€åˆæ ˆé¡¶ï¼ˆå®Œæˆprologï¼Œæ²¡æœ‰æ‰§è¡Œå…¶ä»–æŒ‡ä»¤æ—¶çš„æ ˆé¡¶ï¼‰åç§»</span></span><br><span class="line">	<span class="comment">/* +04 */</span>        UNWIND_CODE UnwindCode[<span class="number">1</span>];<span class="comment">// UnwindCode æ•°ç»„è¯¦ç»†è®°å½•äº†å‡½æ•°ä¿®æ”¹æ ˆã€ä¿å­˜éæ˜“å¤±æ€§å¯„å­˜å™¨çš„æŒ‡ä»¤</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">//å¦‚æœFlagsè®¾ç½®äº†UNW_FLAG_EHANDLERæˆ–UNW_FLAG_UHANDLERï¼Œä¸‹é¢å­˜æ”¾ExceptionHandlerã€ExceptionData</span></span><br><span class="line">				<span class="comment">//å¦‚æœFlagsè®¾ç½®äº†UNW_FLAG_CHAININFOï¼Œåˆ™ä¸‹é¢å­˜æ”¾çš„æ˜¯RUNTIME_FUNCTIONç»“æ„</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* +08 */</span>          		OPTIONAL ULONG ExceptionHandler;    <span class="comment">// RVA, Exception handler routine</span></span><br><span class="line">			<span class="comment">/* +0C */</span>          		OPTIONAL ULONG ExceptionData[];     <span class="comment">// RVA, Scope table structure</span></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* +08 */</span> OPTIONAL RUNTIME_FUNCTION RuntimeFunctionChain;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125; UNWIND_INFO, * PUNWIND_INFO;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ReadPEFile</span><span class="params">(IN LPCSTR lpszFile, OUT PVOID64* pFileBuffer, OUT PULONG64 FileSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE* pFile = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG uError = <span class="number">0</span>;</span><br><span class="line">	ULONG64 fileSize = <span class="number">0</span>;        				</span><br><span class="line">	PVOID64 pTempFileBuffer = <span class="literal">NULL</span>; 	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ‰“å¼€æ–‡ä»¶	</span></span><br><span class="line">	uError = fopen_s(&amp;pFile, lpszFile, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (uError || pFile == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; æ— æ³•æ‰“å¼€ EXE æ–‡ä»¶! uError = %d, pFile = %llx\n&quot;</span>, uError, (ULONG64)pFile);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è¯»å–æ–‡ä»¶å¤§å°		</span></span><br><span class="line">	fseek(pFile, <span class="number">0</span>, SEEK_END);	</span><br><span class="line">	fileSize = ftell(pFile);	</span><br><span class="line">	fseek(pFile, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">	<span class="comment">//åˆ†é…ç¼“å†²åŒº</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;è¯»å–çš„æ–‡ä»¶å¤§å°ï¼š0x%llxå­—èŠ‚\n&quot;</span>, fileSize);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (fileSize &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; æ–‡ä»¶è¯»å–å¤±è´¥! &quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	pTempFileBuffer = <span class="built_in">malloc</span>(fileSize);</span><br><span class="line">	<span class="keyword">if</span> (!pTempFileBuffer)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; åˆ†é…ç©ºé—´å¤±è´¥! &quot;</span>);</span><br><span class="line">		fclose(pFile);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memset</span>(pTempFileBuffer, <span class="number">0</span>, fileSize);</span><br><span class="line">	<span class="comment">//å°†æ–‡ä»¶æ•°æ®è¯»å–åˆ°ç¼“å†²åŒº	</span></span><br><span class="line">	ULONG64 n = fread(pTempFileBuffer, fileSize, <span class="number">1</span>, pFile);</span><br><span class="line">	<span class="keyword">if</span> (!n)</span><br><span class="line">	&#123;         </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; è¯»å–æ•°æ®å¤±è´¥! &quot;</span>);</span><br><span class="line">		<span class="built_in">free</span>(pTempFileBuffer);</span><br><span class="line">		fclose(pFile);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	*pFileBuffer = pTempFileBuffer;</span><br><span class="line">	*FileSize = fileSize;</span><br><span class="line">	<span class="comment">//å…³é—­æ–‡ä»¶	</span></span><br><span class="line">	fclose(pFile);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ULONG64 <span class="title">RVAToFOA</span><span class="params">(IN ULONG64 RVA, IN PVOID64 pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS64  pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_FILE_HEADER pFileHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER64 pOptionHeader64 = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG dwSizeOfHeaders = <span class="number">0</span>;</span><br><span class="line">	BYTE uSignature[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pFileBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;pImageBufferç¼“å†²åŒºæŒ‡é’ˆå‡ºé”™...\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	uSignature[<span class="number">0</span>] = *(PBYTE)pFileBuffer;</span><br><span class="line">	uSignature[<span class="number">1</span>] = *(PBYTE)((BYTE*)pFileBuffer+<span class="number">1</span>);</span><br><span class="line">	<span class="comment">//åˆ¤æ–­æ˜¯å¦å«æœ‰æœ‰æ•ˆMZå’ŒPEæ ‡å¿—</span></span><br><span class="line">	<span class="keyword">if</span> (*(PUSHORT)uSignature != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;éæœ‰æ•ˆçš„MZæ ‡å¿—\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">	<span class="keyword">if</span> (*((PDWORD)((BYTE*)pDosHeader + pDosHeader-&gt;e_lfanew)) != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;éæœ‰æ•ˆçš„PEæ ‡å¿—\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//æ‰¾åˆ°æ‰€æœ‰PEæ–‡ä»¶ç»“æ„çš„å¤´åœ°å€</span></span><br><span class="line">	pNTHeader = (PIMAGE_NT_HEADERS64)((BYTE*)pDosHeader + pDosHeader-&gt;e_lfanew);</span><br><span class="line">	pFileHeader = (PIMAGE_FILE_HEADER)((BYTE*)pNTHeader + <span class="keyword">sizeof</span>(DWORD));</span><br><span class="line">	pOptionHeader64 = (PIMAGE_OPTIONAL_HEADER64)((BYTE*)pFileHeader + IMAGE_SIZEOF_FILE_HEADER);</span><br><span class="line">	pSectionHeader = (PIMAGE_SECTION_HEADER)((BYTE*)pOptionHeader64 + pFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">	dwSizeOfHeaders = pOptionHeader64-&gt;SizeOfHeaders;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (RVA &lt; dwSizeOfHeaders)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> RVA;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//å¾ªç¯åˆ¤æ–­RVAåœ¨å“ªä¸ªèŠ‚è¡¨å†…</span></span><br><span class="line">		DWORD i = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (; i &lt; pNTHeader-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ((pSectionHeader[i].VirtualAddress &lt;= RVA) &amp;&amp; (RVA &lt; (pSectionHeader[i].VirtualAddress + pSectionHeader[i].Misc.VirtualSize)))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//åœ¨æŸä¸ªèŠ‚ä¸­ï¼Œç»ˆæ­¢å¾ªç¯</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//æ‰¾åˆ°RVAç›¸å¯¹è¯¥èŠ‚è¡¨çš„åç§»ï¼Œåç§»+è¯¥èŠ‚è¡¨åœ¨æ–‡ä»¶å†…çš„èµ·å§‹åœ°å€åˆ™ä¸ºFOA</span></span><br><span class="line">		<span class="keyword">return</span> RVA - pSectionHeader[i].VirtualAddress + pSectionHeader[i].PointerToRawData;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">ParserExceptionDirectory</span><span class="params">(PVOID64 pFileBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIMAGE_DOS_HEADER pDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_NT_HEADERS64  pNTHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_FILE_HEADER pFileHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER64 pOptionHeader64 = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_SECTION_HEADER pSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">	PIMAGE_DATA_DIRECTORY pDataDirectory = <span class="literal">NULL</span>;</span><br><span class="line">	PRUNTIME_FUNCTION pRuntimeFunction = <span class="literal">NULL</span>;</span><br><span class="line">	PUNWIND_INFO pUnwindInfo = <span class="literal">NULL</span>;</span><br><span class="line">	PUNWIND_CODE pUnwindCode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">	pNTHeader = (PIMAGE_NT_HEADERS64)((BYTE*)pFileBuffer + pDosHeader-&gt;e_lfanew);</span><br><span class="line">	pOptionHeader64 = (PIMAGE_OPTIONAL_HEADER64)((BYTE*)pNTHeader + IMAGE_SIZEOF_FILE_HEADER + <span class="keyword">sizeof</span>(DWORD));</span><br><span class="line">	pSectionHeader = (PIMAGE_SECTION_HEADER)((BYTE*)pOptionHeader64 + pNTHeader-&gt;FileHeader.SizeOfOptionalHeader);</span><br><span class="line">	pDataDirectory = (PIMAGE_DATA_DIRECTORY)(pOptionHeader64-&gt;DataDirectory);</span><br><span class="line">	pRuntimeFunction = (PRUNTIME_FUNCTION)((BYTE*)pDosHeader + RVAToFOA(pDataDirectory[<span class="number">3</span>].VirtualAddress, pFileBuffer));</span><br><span class="line"></span><br><span class="line">	ULONG j = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(pRuntimeFunction[j].BeginAddress)</span><br><span class="line">	&#123;</span><br><span class="line">		j++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; --j &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (pRuntimeFunction-&gt;BeginAddress)</span><br><span class="line">	&#123;</span><br><span class="line">		pUnwindInfo = (PUNWIND_INFO)((BYTE*)pDosHeader + RVAToFOA(pRuntimeFunction-&gt;UnwindInfoAddress, pFileBuffer));</span><br><span class="line">		pUnwindCode = (PUNWIND_CODE)(pUnwindInfo-&gt;UnwindCode);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-------------------------------------------------------------------------&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;UNWIND_INFO:&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Version = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;Version) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Flags = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;Flags) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;SizeOfProlog = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;SizeOfProlog) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;CountOfCodes = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;CountOfCodes) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;FrameRegister = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;FrameRegister) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;FrameOffset = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;FrameOffset) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;UnwindCode = &quot;</span> &lt;&lt; hex &lt;&lt; (ULONG)(pUnwindInfo-&gt;UnwindCode) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">if</span> ((ULONG)(pUnwindInfo-&gt;Flags) &amp; (UNW_FLAG_EHANDLER | UNW_FLAG_UHANDLER))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;ExceptionHandler(RVA) = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;ExceptionHandler) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;ExceptionData(RVA,Scopetable) = &quot;</span> &lt;&lt; (ULONG)(pUnwindInfo-&gt;ExceptionData) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((ULONG)(pUnwindInfo-&gt;Flags) == UNW_FLAG_CHAININFO)</span><br><span class="line">		&#123;</span><br><span class="line">			RUNTIME_FUNCTION RuntimeFuntion = pUnwindInfo-&gt;RuntimeFunctionChain;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;BeginAddress(RVA) = &quot;</span> &lt;&lt; (ULONG64)(RuntimeFuntion.BeginAddress) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;EndAddress(RVA) = &quot;</span> &lt;&lt; (ULONG64)(RuntimeFuntion.EndAddress) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;UnwindInfoAddress(RVA) = &quot;</span> &lt;&lt; (ULONG64)(RuntimeFuntion.UnwindInfoAddress) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-------------------------------------------------------------------------&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (ULONG i = <span class="number">0</span>; i &lt; (ULONG)(pUnwindInfo-&gt;CountOfCodes); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;UNWIND_CODE:&quot;</span> &lt;&lt; i + <span class="number">1</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;CodeOffset = &quot;</span> &lt;&lt; (ULONG)(pUnwindCode[i].CodeOffset) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;UnwindOp = &quot;</span> &lt;&lt; (ULONG)(pUnwindCode[i].UnwindOp) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;OpInfo = &quot;</span> &lt;&lt; (ULONG)(pUnwindCode[i].OpInfo) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;FrameOffset = &quot;</span> &lt;&lt; (ULONG)(pUnwindCode[i].FrameOffset) &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;-------------------------------------------------------------------------&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		pRuntimeFunction++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span><br><span class="line">&#123;</span><br><span class="line">	PVOID64 pFileBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	ULONG64 uFileSize = <span class="number">0</span>;</span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">	bRet = ReadPEFile(File_Name, &amp;pFileBuffer, &amp;uFileSize);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The file buffer : 0x%llx\n&quot;</span>, (ULONG64)pFileBuffer);</span><br><span class="line">	bRet = ParserPEFile(pFileBuffer);	</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-x64å †æ ˆå›æ»š"><a href="#3-x64å †æ ˆå›æ»š" class="headerlink" title="3 x64å †æ ˆå›æ»š"></a>3 x64å †æ ˆå›æ»š</h2><h3 id="3-1-Windbgè°ƒè¯•å †æ ˆå›æ»š"><a href="#3-1-Windbgè°ƒè¯•å †æ ˆå›æ»š" class="headerlink" title="3.1 Windbgè°ƒè¯•å †æ ˆå›æ»š"></a>3.1 Windbgè°ƒè¯•å †æ ˆå›æ»š</h3><p>å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span>  <span class="function">PVOID64 _fastcall <span class="title">GetPebLdr</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function">__int64 <span class="title">Test3Parameters</span><span class="params">(__int64* arg_1, __int64 arg_2, __int64 arg_3, OUT PVOID64* OutAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __int64 iLocal = <span class="number">0</span>;</span><br><span class="line">    iLocal = *arg_1;</span><br><span class="line">    DebugBreak();</span><br><span class="line">    *OutAddress = GetPebLdr();</span><br><span class="line">    <span class="keyword">return</span> iLocal + arg_2 + arg_3 + (ULONG64)*OutAddress;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PVOID64 OutAddress = <span class="literal">NULL</span>;</span><br><span class="line">    INT64 Temp = <span class="number">2</span>;</span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        INT64 Test = Test3Parameters(&amp;Temp, <span class="number">5</span>, <span class="number">9</span>, &amp;OutAddress);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, OutAddress);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%llx\n&quot;</span>, Test);</span><br><span class="line">    &#125;</span><br><span class="line">    __except(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, TEXT(<span class="string">&quot;å‘ç”Ÿå¼‚å¸¸&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å‡½æ•°è°ƒç”¨å…³ç³»ï¼šmain â€” Test3Parameters â€” DebugBreak(int 3)ã€‚</p>
<p>åœ¨ Release ç‰ˆæœ¬ä¸‹é¢æŸ¥çœ‹æ­¤æ—¶æ–­ç‚¹æ–­ä¸‹æ¥åçš„å †æ ˆï¼š</p>
<p><code>knf</code> å‘½ä»¤æ˜¾ç¤ºè°ƒç”¨å †æ ˆä»¥åŠå †æ ˆä¸­æ¯ä¸€å¸§ä½¿ç”¨çš„å †æ ˆç©ºé—´é‡ <code>Memory</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; .process ffff998de9a560c0</span><br><span class="line">Implicit process is now ffff998d`e9a560c0</span><br><span class="line">WARNING: .cache forcedecodeuser is <span class="keyword">not</span> enabled</span><br><span class="line"><span class="number">0</span>: kd&gt; knf</span><br><span class="line"> #   Memory  Child-SP          RetAddr               Call Site</span><br><span class="line"><span class="number">00</span>           <span class="number">00000008</span>`f531fa08 <span class="number">00007f</span>f6`<span class="number">8306107</span>c     KERNELBASE!wil::details::DebugBreak+<span class="number">0x2</span></span><br><span class="line"><span class="number">01</span>         <span class="number">8</span> (Inline Function) --------`--------     First_Inline_x64!Test3Parameters+<span class="number">0x6</span> </span><br><span class="line"><span class="number">02</span>         <span class="number">0</span> <span class="number">00000008</span>`f531fa10 <span class="number">00007f</span>f6`<span class="number">83061310</span>     First_Inline_x64!main+<span class="number">0xc</span>  </span><br><span class="line"><span class="number">03</span>        <span class="number">30</span> (Inline Function) --------`--------     First_Inline_x64!invoke_main+<span class="number">0x22</span> </span><br><span class="line"><span class="number">04</span>         <span class="number">0</span> <span class="number">00000008</span>`f531fa40 <span class="number">00007f</span>ff`bad37034     First_Inline_x64!__scrt_common_main_seh+<span class="number">0x10c</span> </span><br><span class="line"><span class="number">05</span>        <span class="number">40</span> <span class="number">00000008</span>`f531fa80 <span class="number">00007f</span>ff`bb5426a1     KERNEL32!BaseThreadInitThunk+<span class="number">0x14</span></span><br><span class="line"><span class="number">06</span>        <span class="number">30</span> <span class="number">00000008</span>`f531fab0 <span class="number">00000000</span>`<span class="number">00000000</span>     ntdll!RtlUserThreadStart+<span class="number">0x21</span></span><br></pre></td></tr></table></figure>

<ol>
<li>Memoryï¼šå­å‡½æ•°å †æ ˆå¤§å°ã€‚</li>
<li>Child-SPï¼šå½“å‰å‡½æ•° RSP ä½ç½®ã€‚</li>
<li>RetAddrï¼šå½“å‰å‡½æ•°çš„è¿”å›åœ°å€ã€‚</li>
<li>Call Siteï¼šå­å‡½æ•°çš„è¿”å›åœ°å€ã€‚</li>
<li>Args to Childï¼šå½“å‰å‡½æ•°çš„å®å‚ã€‚</li>
</ol>
<ul>
<li><p><strong>Call Site</strong>ï¼šè°ƒç”¨å­å‡½æ•°çš„ä½ç½®ã€‚<strong>å®é™…ä¸ºå­å‡½æ•°è¿”å›åœ°å€</strong>ã€‚<mark class="label primary">éœ€è¦ä»æ•´ä¸ªåˆ—å€’åºæ¥çœ‹å‡½æ•°è°ƒç”¨é¡ºåº</mark>ã€‚</p>
<p>å¦‚ <mark class="label info">#01</mark> å·å¸§ï¼Œ<code>Call Site = First_Inline_x64!Test3Parameters+0x6</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; u First_Inline_x64!Test3Parameters</span><br><span class="line">First_Inline_x64!Test3Parameters:</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">83061076</span> ff15840f0000    call    qword ptr [First_Inline_x64!_imp_DebugBreak (<span class="number">00007f</span>f6`<span class="number">83062000</span>)]</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">8306107</span>c e84f000000      call    First_Inline_x64!GetPebLdr (<span class="number">00007f</span>f6`<span class="number">830610</span>d0)</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">83061081</span> <span class="number">488</span>d5810        lea     rbx,[rax+<span class="number">10</span>h]</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å®é™…ä¸Š <code>00007ff6&#39;83061076 + 6 = 00007ff6&#39;8306107c</code> ä¸ºå­å‡½æ•°çš„è¿”å›åœ°å€ã€‚</p>
</li>
<li><p><strong>Memory</strong>ï¼š<strong>å­å‡½æ•°</strong>æ ˆå¸§çš„å¤§å°<strong>ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œ</strong>åå…­è¿›åˆ¶ã€‚<mark class="label primary">éœ€è¦ä»ä¸Šä¸‹ä¸¤è¡Œæ¥çœ‹å­å‡½æ•°å †æ ˆä½¿ç”¨äº†å¤šå°‘å­—èŠ‚ï¼Œå¦‚ #05 å·å¸§çš„ 0x40 å­—èŠ‚è¡¨ç¤ºå­å‡½æ•°çš„å †æ ˆä½¿ç”¨æƒ…å†µ</mark>ã€‚</p>
<p>$å‡½æ•°æ ˆå¸§çš„å¤§å°\ &#x3D;\ è¿”å›åœ°å€ï¼ˆ8 ä¸ªå­—èŠ‚ï¼‰+ éæ˜“å¤±å˜å¯„å­˜å™¨ + å±€éƒ¨å˜é‡ + åŸºäºæ ˆçš„å‚æ•° + é¢„ç•™çš„ 0x20 å­—èŠ‚ï¼ˆshadow spaceï¼‰$<br>$å‡½æ•°æ ˆå¸§çš„å¤§å°\ &#x3D;\ è¿”å›åœ°å€ï¼ˆ8ä¸ªå­—èŠ‚ï¼‰+\ unwind\_code$</p>
<p>å…¬å¼çš„è¿”å›åœ°å€æ˜¯è°ƒç”¨è€…å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå…¶ä½™å€¼éƒ½æ˜¯å­å‡½æ•°çš„ã€‚</p>
<p>ç»“è®ºï¼š<strong>å½“å‰å‡½æ•°æ ˆå¸§çš„å¤§å°ä½äºä¸‹ä¸€å¸§çš„ Memory ä¸­</strong>ã€‚</p>
</li>
<li><p><strong>Child-SP</strong>ï¼šè¡¨ç¤º<mark class="label danger">å½“å‰å‡½æ•°</mark>åˆå§‹åŒ–å®Œæˆåçš„ RSP çŠ¶æ€å€¼ï¼Œå½“å‰å‡½æ•°ä¸­æ­¤æ—¶çš„ RSP å·²ç»å®Œæˆ prolog æ“ä½œã€‚</p>
<p>å¦‚ <mark class="label info">#04</mark> å·å¸§ï¼Œæ­¤æ—¶ Child-SP æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹å°±è¡¨ç¤ºå‡½æ•° <code>__scrt_common_main_seh</code> å®Œæˆ prolog åçš„ RSP çš„ä½ç½®ã€‚<mark class="label primary">éœ€è¦ä»æ•´ä¸ªåˆ—æ¥çœ‹ RSP å®é™…å˜åŒ–æƒ…å†µ</mark>ã€‚å¦‚ #04 å·å¸§åˆ° #05 å·å¸§çš„ RSP å˜åŒ–ä¸º 0x40 å­—èŠ‚ï¼Œè¡¨ç¤º #04 å·å¸§ç”¨äº† 0x40 å­—èŠ‚ã€‚</p>
<ol>
<li><p>å…ˆæ¥éªŒè¯ #04 å·å¸§ Memoryï¼Œå…¶å¯¹åº”çš„å€¼ä¸ºçˆ¶å‡½æ•°å¸§çš„ 0x40 å­—èŠ‚ã€‚</p>
<ul>
<li><p>è¿”å›åœ°å€ï¼š8 å­—èŠ‚ã€‚</p>
</li>
<li><p>åˆ†æå‡½æ•°ï¼šæå‡å †æ ˆä¸º 8+0x30 &#x3D; 0x38 å­—èŠ‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; u __scrt_common_main_seh</span><br><span class="line">First_Inline_x64!__scrt_common_main_seh:</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">83061204</span> <span class="number">48895</span>c2408      mov     qword ptr [rsp+<span class="number">8</span>],rbx</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">83061209</span> <span class="number">4889742410</span>      mov     qword ptr [rsp+<span class="number">10</span>h],rsi</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">8306120</span>e <span class="number">57</span>              push    rdi</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">8306120f</span> <span class="number">4883</span>ec30        sub     rsp,<span class="number">30</span>h</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">83061213</span> b901000000      mov     ecx,<span class="number">1</span></span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">83061218</span> e82f030000      call    First_Inline_x64!__scrt_initialize_crt (<span class="number">00007f</span>f6`<span class="number">8306154</span>c)</span><br><span class="line"><span class="number">00007f</span>f6`<span class="number">8306121</span>d <span class="number">84</span>c0            test    al,al</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ™æ€»å…±ä¸º <code>8 + 8 + 0x30 = 0x40</code> å­—èŠ‚ï¼Œä¸ Memory å¯¹åº”ä¸Šäº†ã€‚</p>
</li>
</ul>
</li>
<li><p>æ­¤æ—¶ <mark class="label info">#04</mark> å·å¸§ Child-SPï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; dq <span class="number">00000008</span>`f531fa40</span><br><span class="line"><span class="number">00000008</span>`f531fa40  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">00000008</span>`f531fa50  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">00000008</span>`f531fa60  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br><span class="line"><span class="number">00000008</span>`f531fa70  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00007f</span>ff`bad37034 &lt;--RetAddr </span><br><span class="line"><span class="number">00000008</span>`f531fa80  <span class="number">00000000</span>`<span class="number">00000000</span> <span class="number">00000000</span>`<span class="number">00000000</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<p><strong>æ³¨æ„</strong>ï¼š<code>.frame /r 02</code> è¡¨ç¤ºåˆ—å‡º <code>#02</code> å·å¸§çš„å¯„å­˜å™¨çš„å€¼ï¼Œæ­¤æ—¶çš„å¯„å­˜å™¨ä¿å­˜çš„å€¼æ˜¯ä» <code>#01</code> å·å¸§ prolog ä¿å­˜éæ˜“å¤±å¯„å­˜å™¨çš„æ—¶å¾—åˆ°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ <code>.frame /r 02</code> çš„å¯„å­˜å™¨çŠ¶æ€æ˜¯è°ƒç”¨å­å‡½æ•°æ—¶çš„å¯„å­˜å™¨ï¼Œä¸æ˜¯è¿›å…¥ <code>#02</code> å·å¸§æ—¶çš„å¯„å­˜å™¨ã€‚</p>
<h3 id="3-2-UNWIND-INFOå †æ ˆå›æ»š"><a href="#3-2-UNWIND-INFOå †æ ˆå›æ»š" class="headerlink" title="3.2 UNWIND_INFOå †æ ˆå›æ»š"></a>3.2 UNWIND_INFOå †æ ˆå›æ»š</h3><p>x64 çš„å‡½æ•°æ ˆå›æº¯ï¼Œæ— éœ€å€ŸåŠ©ç¨‹åºçš„ç¬¦å·è¡¨ã€‚åªéœ€è¦å€ŸåŠ© <code>RUNTIME_FUNCTION</code>ã€<code>UNWIND_INFO</code> å’Œ <code>UNWIND_CODE</code> ç»“æ„å³å¯ä» <code>PE</code> æ–‡ä»¶æœ¬èº«ä¸­çš„ä¿¡æ¯æ¥å¾—å‡ºæ¯ä¸ªå‡½æ•°å †æ ˆä¸Šåˆ†é…çš„ç©ºé—´ã€‚</p>
<p>$å‡½æ•°æ ˆå¸§çš„å¤§å°\ &#x3D;\ è¿”å›åœ°å€ï¼ˆ8 ä¸ªå­—èŠ‚ï¼‰+ éæ˜“å¤±å˜å¯„å­˜å™¨ + å±€éƒ¨å˜é‡ + åŸºäºæ ˆçš„å‚æ•° + é¢„ç•™çš„ 0x20 å­—èŠ‚ï¼ˆshadow spaceï¼‰$<br>$å‡½æ•°æ ˆå¸§çš„å¤§å°\ &#x3D;\ è¿”å›åœ°å€ï¼ˆ8ä¸ªå­—èŠ‚ï¼‰+\ unwind\_code$</p>
<p>æœ¬èŠ‚å®éªŒè¿˜æ˜¯å€ŸåŠ© Windbgï¼Œåœ¨ IDA ä¸­å…¶å®æ›´å¥½åˆ†æã€‚å‚è€ƒã€Š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/khacker/p/12164723.html">æ·±å…¥X64æ¶æ„(ç¿»è¯‘ï¼‰</a>ã€‹ã€ã€Š<a target="_blank" rel="noopener" href="https://v2as.com/article/6565511d-265a-48bb-a073-33808b564e94">æ·±å…¥ x64</a>ã€‹ã€‚</p>
<p>æœ¬èŠ‚è¿˜æ˜¯ä»¥ä¸Šé¢æåˆ°çš„ <code>#04</code> å·å¸§åšä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; knf</span><br><span class="line"> #   Memory  Child-SP          RetAddr               Call Site</span><br><span class="line"><span class="number">00</span>           <span class="number">00000008</span>`f531fa08 <span class="number">00007f</span>f6`<span class="number">8306107</span>c     KERNELBASE!wil::details::DebugBreak+<span class="number">0x2</span></span><br><span class="line"><span class="number">01</span>         <span class="number">8</span> (Inline Function) --------`--------     First_Inline_x64!Test3Parameters+<span class="number">0x6</span> </span><br><span class="line"><span class="number">02</span>         <span class="number">0</span> <span class="number">00000008</span>`f531fa10 <span class="number">00007f</span>f6`<span class="number">83061310</span>     First_Inline_x64!main+<span class="number">0xc</span>  </span><br><span class="line"><span class="number">03</span>        <span class="number">30</span> (Inline Function) --------`--------     First_Inline_x64!invoke_main+<span class="number">0x22</span> </span><br><span class="line"><span class="number">04</span>         <span class="number">0</span> <span class="number">00000008</span>`f531fa40 <span class="number">00007f</span>ff`bad37034     First_Inline_x64!__scrt_common_main_seh+<span class="number">0x10c</span> </span><br><span class="line"><span class="number">05</span>        <span class="number">40</span> <span class="number">00000008</span>`f531fa80 <span class="number">00007f</span>ff`bb5426a1     KERNEL32!BaseThreadInitThunk+<span class="number">0x14</span></span><br><span class="line"><span class="number">06</span>        <span class="number">30</span> <span class="number">00000008</span>`f531fab0 <span class="number">00000000</span>`<span class="number">00000000</span>     ntdll!RtlUserThreadStart+<span class="number">0x21</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹å‡½æ•° <code>UNWIND_INFO</code> æƒ…å†µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: kd&gt; .fnent First_Inline_x64!__scrt_common_main_seh</span><br><span class="line">Debugger function entry <span class="number">00000228</span>`<span class="number">6b</span>61eb38 <span class="keyword">for</span>:</span><br><span class="line">(<span class="number">00007f</span>f6`<span class="number">83061204</span>)   First_Inline_x64!__scrt_common_main_seh   |  (<span class="number">00007f</span>f6`<span class="number">83061380</span>)   First_Inline_x64!mainCRTStartup</span><br><span class="line">Exact matches:</span><br><span class="line">    First_Inline_x64!__scrt_common_main_seh (<span class="keyword">void</span>)</span><br><span class="line"></span><br><span class="line">BeginAddress      = <span class="number">00000000</span>`<span class="number">00001204</span></span><br><span class="line">EndAddress        = <span class="number">00000000</span>`<span class="number">00001380</span></span><br><span class="line">UnwindInfoAddress = <span class="number">00000000</span>`<span class="number">00002814</span></span><br><span class="line"></span><br><span class="line">Unwind info at <span class="number">00007f</span>f6`<span class="number">83062814</span>, <span class="number">18</span> bytes</span><br><span class="line">  version <span class="number">1</span>, flags <span class="number">1</span>, prolog f, codes <span class="number">6</span></span><br><span class="line">  handler routine: First_Inline_x64!_C_specific_handler (<span class="number">00007f</span>f6`<span class="number">83061</span>cc0), data <span class="number">2</span></span><br><span class="line">  <span class="number">00</span>: offs f, unwind op <span class="number">4</span>, op info <span class="number">6</span>	UWOP_SAVE_NONVOL FrameOffset: <span class="number">48</span> reg: rsi.</span><br><span class="line">  <span class="number">02</span>: offs f, unwind op <span class="number">4</span>, op info <span class="number">3</span>	UWOP_SAVE_NONVOL FrameOffset: <span class="number">40</span> reg: rbx.</span><br><span class="line">  <span class="number">04</span>: offs f, unwind op <span class="number">2</span>, op info <span class="number">5</span>	UWOP_ALLOC_SMALL.</span><br><span class="line">  <span class="number">05</span>: offs b, unwind op <span class="number">0</span>, op info <span class="number">7</span>	UWOP_PUSH_NONVOL reg: rdi.</span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸æ¥è¯´ <code>UNWIND_CODE</code> åº”è¯¥æ˜¯é€†åºæ’åºçš„ã€‚</p>
<ul>
<li>UWOP_SAVE_NONVOLï¼š<code>mov qword ptr[rsp+0x8], rbx</code>ï¼Œ0 bytesã€‚</li>
<li>UWOP_SAVE_NONVOLï¼š<code>mov qword ptr[rsp+0x10], rsi</code>ï¼Œ0 bytesã€‚</li>
<li>UWOP_PUSH_NONVOLï¼š<code>push rdi</code>ï¼Œ8 bytesã€‚</li>
<li>UWOP_ALLOC_SMALLï¼š<code>sub rsp, 5*8+8</code>ï¼Œ0x30 bytesã€‚</li>
</ul>
<p>å‡½æ•°æ ˆå¸§çš„å¤§å° &#x3D; è¿”å›åœ°å€ï¼ˆ8 bytesï¼‰+unwind_code(0x38) &#x3D; 0x40å­—èŠ‚ã€‚å’Œ #05 å¸§çš„ Memory å¯¹ä¸Šã€‚</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/khacker/p/12164723.html">æ·±å…¥X64æ¶æ„(ç¿»è¯‘ï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://v2as.com/article/6565511d-265a-48bb-a073-33808b564e94">æ·±å…¥ x64</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/247688#h3-10">å¦‚ä½•åˆ†æX64çš„SEH</a></li>
<li><a target="_blank" rel="noopener" href="https://jhinxs.com/x86%E4%B8%8Ex64%E6%A0%88%E5%9B%9E%E6%BA%AF/#x64-%E6%A0%88%E5%9B%9E%E6%BA%AF">x86ä¸x64æ ˆå›æº¯</a></li>
<li><a target="_blank" rel="noopener" href="http://uninformed.org/index.cgi?v=4&a=1&p=11">Exception Handling on x64</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19808172/struct-runtime-function"><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19808172/struct-runtime-function">Struct RUNTIME_FUNCTION</a></a></li>
</ul>
<h2 id="4-å¼‚å¸¸å¤„ç†"><a href="#4-å¼‚å¸¸å¤„ç†" class="headerlink" title="4 å¼‚å¸¸å¤„ç†"></a>4 å¼‚å¸¸å¤„ç†</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.pediy.com/kssd/pediy12/142371.html">SEHåˆ†æç¬”è®°ï¼ˆX64ç¯‡ï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://dbgtech.github.io/2017/08/04/Windows-X64-Try-Except-Finally.html">Windows X64çš„Ring3å±‚å¼‚å¸¸å¤„ç†æœºåˆ¶</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.talosintelligence.com/2014/06/exceptional-behavior-windows-81-x64-seh.html">Exceptional behavior: the Windows 8.1 X64 SEH Implementation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1663524-1-1.html">Windows 10 x64 å¼‚å¸¸åˆ†å‘</a></li>
<li><a target="_blank" rel="noopener" href="https://revers.engineering/applied-re-exceptions/">Applied Reverse Engineering: Exceptions And Interrupts</a></li>
</ul>
<h3 id="4-1-å¼‚å¸¸äº§ç”Ÿä¸é‡‡é›†"><a href="#4-1-å¼‚å¸¸äº§ç”Ÿä¸é‡‡é›†" class="headerlink" title="4.1 å¼‚å¸¸äº§ç”Ÿä¸é‡‡é›†"></a>4.1 å¼‚å¸¸äº§ç”Ÿä¸é‡‡é›†</h3><h3 id="4-2-å¼‚å¸¸åˆ†å‘"><a href="#4-2-å¼‚å¸¸åˆ†å‘" class="headerlink" title="4.2 å¼‚å¸¸åˆ†å‘"></a>4.2 å¼‚å¸¸åˆ†å‘</h3><h3 id="4-3-å†…æ ¸å¼‚å¸¸å¤„ç†"><a href="#4-3-å†…æ ¸å¼‚å¸¸å¤„ç†" class="headerlink" title="4.3 å†…æ ¸å¼‚å¸¸å¤„ç†"></a>4.3 å†…æ ¸å¼‚å¸¸å¤„ç†</h3><h3 id="4-4-ç”¨æˆ·å¼‚å¸¸å¤„ç†"><a href="#4-4-ç”¨æˆ·å¼‚å¸¸å¤„ç†" class="headerlink" title="4.4 ç”¨æˆ·å¼‚å¸¸å¤„ç†"></a>4.4 ç”¨æˆ·å¼‚å¸¸å¤„ç†</h3>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    èµèµ
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat å¾®ä¿¡">
        <span>å¾®ä¿¡</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat æ”¯ä»˜å®">
        <span>æ”¯ä»˜å®</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://directoree.github.io/post/x64-Disassembly3/" title="x64 å¼‚å¸¸å¤„ç†">https://directoree.github.io/post/x64-Disassembly3/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Windows%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> Windowså†…æ ¸</a>
              <a href="/tags/x64-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> x64 å¼‚å¸¸å¤„ç†</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/x64-Disassembly2/" rel="prev" title="x64 æ±‡ç¼–åŸºç¡€">
                  <i class="fa fa-chevron-left"></i> x64 æ±‡ç¼–åŸºç¡€
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/x64-Kernel/" rel="next" title="x64 å†…æ ¸ï¼ˆä¸€ï¼‰IA-32e å¯„å­˜å™¨ç ”ç©¶">
                  x64 å†…æ ¸ï¼ˆä¸€ï¼‰IA-32e å¯„å­˜å™¨ç ”ç©¶ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">29:46</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"å¿«æ¥å‹¾æ­æˆ‘å‘€ğŸ¶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/x64-Disassembly3/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
