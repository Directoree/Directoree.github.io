<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ʕ •̀ o •́ ʔ">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows XP 中断与异常（段内容补充）">
<meta property="og:url" content="https://directoree.github.io/post/WinXp-InterruptAndException/index.html">
<meta property="og:site_name" content="Catecat">
<meta property="og:description" content="ʕ •̀ o •́ ʔ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.shields.io/badge/%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%BC%82%E5%B8%B8-1fd0f6.svg?colorA=ff69b4">
<meta property="og:image" content="https://img.shields.io/badge/%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B%E3%80%8AWindows%E5%86%85%E6%A0%B8%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90%E3%80%8B-%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7-1fd0f6.svg?colorA=ff69b4">
<meta property="og:image" content="https://s2.loli.net/2022/07/02/sGziKQf3gD1eNWX.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/02/JVYqAoIOk5hjCP1.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/05/XvoBtC7yVIJOS6Q.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/03/PkctBC18j3vgMQ4.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/07/M6QHAUlEZi98mOp.png">
<meta property="article:published_time" content="2022-07-02T08:36:51.000Z">
<meta property="article:modified_time" content="2022-07-07T13:54:29.865Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="WinXP内核">
<meta property="article:tag" content="中断与异常">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.shields.io/badge/%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%BC%82%E5%B8%B8-1fd0f6.svg?colorA=ff69b4">


<link rel="canonical" href="https://directoree.github.io/post/WinXp-InterruptAndException/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Windows XP 中断与异常（段内容补充） | Catecat</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Catecat</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-空调房">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>空调房</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-text">1 线程优先级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-text">1.1 线程优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7%E8%B0%83%E6%95%B4"><span class="nav-text">1.2 线程优先级调整</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%BC%82%E5%B8%B8"><span class="nav-text">2 中断与异常</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8%E7%9A%84%E5%BC%82%E5%90%8C"><span class="nav-text">2.1 中断和异常的异同</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD%E7%9A%84%E5%8F%91%E7%94%9F%E5%92%8C%E5%A4%84%E7%90%86"><span class="nav-text">2.2 硬件中断的发生和处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-APIC%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-text">2.3 APIC的功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E8%A1%A8"><span class="nav-text">2.4 中断向量表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82%E7%BA%A7%E5%88%AB%EF%BC%88IRQL%EF%BC%89"><span class="nav-text">3 中断请求级别（IRQL）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%B8%AD%E6%96%AD%E5%AF%B9%E8%B1%A1%EF%BC%88%E5%A4%96%E9%83%A8%E8%AE%BE%E5%A4%87%E4%BD%BF%E7%94%A8%EF%BC%89"><span class="nav-text">4 中断对象（外部设备使用）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-DPC"><span class="nav-text">5 DPC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%97%B6%E9%92%9F%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="nav-text">6 时钟中断与定时器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%BC%82%E5%B8%B8%E5%88%86%E5%8F%91"><span class="nav-text">7 异常分发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6"><span class="nav-text">8 线程调度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="nav-text">9 注册表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-text">10 文件系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%BC%8F%E5%9B%9E%E7%94%A8%E6%88%B7%E6%A8%A1%E5%BC%8F"><span class="nav-text">11 内核模式回用户模式</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">118</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/WinXp-InterruptAndException/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Catecat">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Windows XP 中断与异常（段内容补充）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-02 16:36:51" itemprop="dateCreated datePublished" datetime="2022-07-02T16:36:51+08:00">2022-07-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-07-07 21:54:29" itemprop="dateModified" datetime="2022-07-07T21:54:29+08:00">2022-07-07</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%82%E5%B8%B8/" itemprop="url" rel="index"><span itemprop="name">异常</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%82%E5%B8%B8/%E4%B8%AD%E6%96%AD/" itemprop="url" rel="index"><span itemprop="name">中断</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%82%E5%B8%B8/%E4%B8%AD%E6%96%AD/Windows%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">Windows内核</span></a>
        </span>
    </span>

  
    <span id="/post/WinXp-InterruptAndException/" class="post-meta-item leancloud_visitors" data-flag-title="Windows XP 中断与异常（段内容补充）" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/WinXp-InterruptAndException/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/WinXp-InterruptAndException/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><a target="_blank" rel="noopener" href="https://unicode-table.com/cn/kaomoji/">ʕ •̀ o •́ ʔ </a></p>
<a id="more"></a>

<p><img data-src="https://img.shields.io/badge/%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%BC%82%E5%B8%B8-1fd0f6.svg?colorA=ff69b4"></p>
<p><img data-src="https://img.shields.io/badge/%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B%E3%80%8AWindows%E5%86%85%E6%A0%B8%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90%E3%80%8B-%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7-1fd0f6.svg?colorA=ff69b4"></p>
<h2 id="1-线程优先级"><a href="#1-线程优先级" class="headerlink" title="1 线程优先级"></a>1 线程优先级</h2><p>本节内容是对《Windows内核原理与实现3.5.1 P150》及《Windows内核情景分析 5.10 P409》关于线程优先级的内容整理。</p>
<p>Windows 内核基本上是严格按优先级高低调度的。Windows 内核将线程的优先级分成 32 级，分别<strong>对应着 32 个就绪线程队列</strong>。其中以 0 级为最低，31 级为最高，16 级以上用于实时线程，16 级以下则用于普通线程。</p>
<h3 id="1-1-线程优先级"><a href="#1-1-线程优先级" class="headerlink" title="1.1 线程优先级"></a>1.1 线程优先级</h3><p>线程优先级：0-31，共32个等级：</p>
<table>
<thead>
<tr>
<th>优先级类别</th>
<th>线程优先级</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><strong>实时类别</strong></td>
<td>16~31</td>
<td></td>
</tr>
<tr>
<td><strong>动态类别</strong></td>
<td>1~15</td>
<td><strong>动态优先级</strong>，运行在动态优先级类别中的线程，它们的实际优先级可能会根据特定的情形而作调，它往往是在 <code>BasePriority</code> 域的基础上提升一定的优先级增量。但是，无论怎么调整，<code>Priority</code>域值的范围一直是<code>1~15</code>。</td>
</tr>
<tr>
<td>系统类别</td>
<td>0</td>
<td>Passive Level</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOW_PRIORITY 0              <span class="comment">// Lowest thread priority level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOW_REALTIME_PRIORITY 16    <span class="comment">// Lowest realtime priority level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIGH_PRIORITY 31            <span class="comment">// Highest thread priority level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXIMUM_PRIORITY 32         <span class="comment">// Number of thread priority levels</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXIMUM_WAIT_OBJECTS 64     <span class="comment">// Maximum number of wait objects</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXCHAR 255</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXIMUM_SUSPEND_COUNT MAXCHAR <span class="comment">// Maximum times thread can be suspended</span></span></span><br></pre></td></tr></table></figure>



<p>KTHREAD优先级的描述：</p>
<ul>
<li><code>BasePriority</code>：<strong>静态优先级</strong>（基本优先级），继承至进程的<code>BasePriority</code>。</li>
<li><code>Priority</code>：<strong>动态优先级</strong>，运行在动态优先级类别中的线程，它们的实际优先级可能会根据特定的情形而作调，它往往是在 <code>BasePriority</code> 域的基础上提升一定的优先级增量（使用函数<code>KeSetPriorityAndQuantumProcess</code>、<code>KeSetBasePriorityThread</code>）。但是，无论怎么调整，<code>Priority</code>域值的范围一直是<code>1~15</code>。</li>
</ul>
<h3 id="1-2-线程优先级调整"><a href="#1-2-线程优先级调整" class="headerlink" title="1.2 线程优先级调整"></a>1.2 线程优先级调整</h3><p><strong>优先级提升应该发生在该线程被作出调度决定（即插入到对应优先级的调度链表中）以前</strong>。内核提供的带<code>Increment</code>参数的函数包括：</p>
<ul>
<li>KeInsertQueueApc</li>
<li>KePulseEvent</li>
<li>KeSetEvent</li>
<li>KeReleaseMutant</li>
<li>KeReleaseSemaphore</li>
<li>KeSetProcess</li>
<li>KeBoostProirityThread</li>
<li>KeTerminateThread.</li>
</ul>
<p>⚠️<strong>注意</strong>：如果一个线程已经被挂入了某个优先级就绪队列，可是现在优先级变了，岂不就应该给它换一个就绪队列吗，所以线程优先级的改变并不只是简单的赋值。由函数<code>KiSetPriorityThread</code>来完成相关操作。</p>
<p>函数<code>KiSetPriorityThread</code>说明，对处于不同状态的线程，改变其线程优先级时，处理方法不同（《Windows内核情景分析5.10 P417》）。</p>
<p>IRQL：CPU此时所处的状态。</p>
<p>线程优先级：线程的优先级只影响系统线程调度程序（分发函数Dispatch）的决策，在同一堆就绪线程中，<mark class="label default">优先级高的线程较优先级低的线程先被调度</mark>。还有另一个区别，<mark class="label warning">优先级高时间片就越大</mark>。</p>
<ul>
<li>非分页内存池：内存页不可以交换出内存。</li>
<li>分页内存池：内存页可以交换出内存。</li>
</ul>
<h2 id="2-中断与异常"><a href="#2-中断与异常" class="headerlink" title="2 中断与异常"></a>2 中断与异常</h2><h3 id="2-1-中断和异常的异同"><a href="#2-1-中断和异常的异同" class="headerlink" title="2.1 中断和异常的异同"></a>2.1 中断和异常的异同</h3><p>本节内容是对《Windows内核原理与实现5.2 P310》内容进行整理。</p>
<p>中断和异常都会改变一个正在执行的线程的正常任务执行，甚至切换线程。但是中断和异常是不同的，这个区别非常重要：<mark class="label danger">中断是异步的</mark><mark class="label success">异常是同步的</mark>。</p>
<p><strong>中断是异步的</strong>：一个正在执行的线程，突然受到一个时钟中断或硬件设备打扰，那会在一定条件下去处理这个中断（类似于APC）。</p>
<p><strong>异常是同步的</strong>：在代码中，如果某个地方可能会发生错误导致异常，一般会使用<code>try-except</code>来处理，在一个线程上处理时不是异步处理的。</p>
<div class="note warning"><p>中断和异常都可以由硬件&#x2F;软件产生：</p>
<ul>
<li><p>硬件中断：由I&#x2F;O设备引发。</p>
</li>
<li><p>软件中断：如使用<code>INT N</code>指令。</p>
<p>汇编代码中可以屏蔽那些可屏蔽的中断：<code>cli</code>，解除屏蔽：<code>sti</code>。</p>
</li>
<li><p>硬件异常：如除零错误、页面错误。</p>
</li>
<li><p>软件异常：如内存访问错误等。</p>
</li>
</ul>
</div>

<div class="note success"><p>用于处理中断的机制是一种被称为<strong>中断对象的内核对象</strong>，它允许设备驱动程序为它的设备注册一个ISR（中断服务例程）。内核在接收到一个中断时，可以将该中断分发到那些已经为该中断向量注册了中断对象的设备驱动程序中，5.2.3节将介绍中断对象。类似地，Windows内核也提供了一套灵活的、可扩展的机制来分发异常，允许内核调试器或进程调试器、内核或应用程序本身，以及环境子系统有机会处理异常，5.2.7节将介绍<strong>异常分发</strong>过程。</p>
</div>



<h3 id="2-2-硬件中断的发生和处理"><a href="#2-2-硬件中断的发生和处理" class="headerlink" title="2.2 硬件中断的发生和处理"></a>2.2 硬件中断的发生和处理</h3><p>现在绝大多数 Intel x86 系统使用了 APIC（高级可编程中断控制器），在 Intel x86 处理器的芯片中内置了一个<strong>本地 APIC</strong>模块，由它负责接收来自处理器上中断管脚、内部中断源和外部 I&#x2F; O APIC 的中断。而在多处理器系统中，本地 APIC 也负责发送和接收处理器间的中断（IPI, interprocessor interrupt）消息。因此，系统总线上的逻辑处理器之间通过各个处理器的本地 APIC 发送和接收 IPI 消息进行通信。</p>
<div class="note danger"><p>⚠️注意：APIC 和 I&#x2F;O APIC是不同的。<strong>APIC是中断的处理模块（包含本地APIC及I&#x2F;O APIC）</strong>。<strong>APIC 分成两部分 LAPIC 和 I&#x2F;O APIC，前者 LAPIC 位于 CPU 内部，每个 CPU 都有一个 LAPIC，后者 I&#x2F;O APIC 与外设相连</strong>。I&#x2F;O APIC 负责接收外部中断，并且将它们传递给本地 APIC，也就是说 APIC &#x3D; LAPIC + I&#x2F;O APIC。APIC就是一个总称。</p>
</div>

<p>APIC可以接收两种中断源，LAPIC接收本地中断源（如热传感器中断、APIC内部错误中断），还能接收I&#x2F;O APIC传递过来的中断源。</p>
<p><img data-src="https://s2.loli.net/2022/07/02/sGziKQf3gD1eNWX.png" alt="1.png"></p>
<h3 id="2-3-APIC的功能"><a href="#2-3-APIC的功能" class="headerlink" title="2.3 APIC的功能"></a>2.3 APIC的功能</h3><p><strong>一个中断的起末会经历设备，中断控制器，CPU 三个阶段：设备产生中断信号，中断控制器翻译信号，CPU 来实际处理信号</strong>。</p>
<p>LAPIC 和 I&#x2F;O APIC的功能很复杂，其中对于本节的学习最重要的就是：<mark class="label danger">将中断信号翻译成中断向量</mark>，使得每一个中断都能够对应一个中断向量。</p>
<p>本地 APIC 的初始化工作是在 Windows 体系结构的 HAL模块中完成的。</p>
<p>可参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/MachineGunJoe/article/details/120089826">一文讲透！Windows内核 &amp; x86中断机制详解</a>、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/393195942">再谈中断（APIC）</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/humanof/article/details/121673112">【x86架构】APIC – 高级可编程中断控制器</a>、<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wsg1100/p/14055863.html">X86中断&#x2F;异常与APIC</a>。</p>
<h3 id="2-4-中断向量表"><a href="#2-4-中断向量表" class="headerlink" title="2.4 中断向量表"></a>2.4 中断向量表</h3><p>当一个中断信号被转换为指定的中断向量之后，CPU会根据这个中断向量去执行对应的系统服务（函数）。系统初始化时使用<code>KiSystemStartup</code>函数来完成相关的工作。</p>
<ol>
<li>Intel X86 一共定义了 256 个中断向量编号（也称为中断向量），从0～255。中断向量表也称为中断描述符表（IDT, Interrupt Descriptor Table）。</li>
<li>IDT 将每个中断或异常与一个处理该中断或异常的函数程关联了起来。</li>
<li>与 GDT 和 LDT 类似，IDT 中的每一项是一个 8 字节的描述符。</li>
<li>处理器内部的 IDTR 寄存器记录了 IDT 的位置和它的最大限制。<code>LIDT</code> 和 <code>SIDT</code> 指令分别用于加载和存储 IDTR 寄存器。<code>LITD</code> 只有在特权级 0 下才可以执行。</li>
</ol>
<p>下图反应如何将<code>INT N</code>转换为指定函数地址的转换（注意<strong>IDT段描述符中的段选择子是一个对应GDT代码段的描述符</strong>）：</p>
<p>具体见《<a href="https://directoree.github.io/post/WinXP-ProtectionMode-Segment3/">Windows XP 段保护（三）</a>》中断门。</p>
<p><img data-src="https://s2.loli.net/2022/07/02/JVYqAoIOk5hjCP1.png" alt="INT_N转换为服务过程.png"></p>
<p>中断和异常的差异：<strong>中断是异步的，异常是同步的</strong>。</p>
<p>中断向量：</p>
<ul>
<li>0～19：给异常使用（2号是不可屏蔽中断）。</li>
<li>20～31：Intel保留。</li>
<li>32～255：用户定义的中断。</li>
</ul>
<p><strong>异常分为三类：</strong></p>
<ul>
<li><strong>错误</strong>（fault）：处理器期待这类异常条件可被修正，<strong>它会返回到原来出错的指令处</strong>，典型的例子是页面错误。</li>
<li><strong>陷阱</strong>（trap）：处理器期待原来的指令流仍然是连续可执行的，这只是一个陷阱而已，所以，<strong>它会返回到发生异常的指令后面的那条指令</strong>，典型的例子是调试断点。</li>
<li><strong>中止</strong>（abort）：处理器<strong>并不期待程序或系统还能够从失败中恢复</strong>，这通常用于报告严重的错误，比如硬件错误或者系统数据结构中的不一致性。</li>
</ul>
<p>具体如下表（Intel x86中断和异常一览表）：</p>
<table>
<thead>
<tr>
<th>向量号</th>
<th>名称</th>
<th>类型</th>
<th>错误码</th>
<th>描述（或来源）</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>除法错</td>
<td>错误</td>
<td>无</td>
<td>DIV 和 IDIV 指令产生的错误</td>
</tr>
<tr>
<td>1</td>
<td>调试</td>
<td>错误&#x2F;陷阱</td>
<td>无</td>
<td>调试异常</td>
</tr>
<tr>
<td>2</td>
<td>NMI</td>
<td>中断</td>
<td>无</td>
<td>不可屏蔽外部中断</td>
</tr>
<tr>
<td>3</td>
<td>断点</td>
<td>陷阱</td>
<td>无</td>
<td><code>INT 3</code> 指令</td>
</tr>
<tr>
<td>4</td>
<td>溢出 Overflow</td>
<td>陷阱</td>
<td>无</td>
<td><code>int O</code>指令，不是<code>int 0</code></td>
</tr>
<tr>
<td>5</td>
<td>BOUND 越界</td>
<td>错误</td>
<td>无</td>
<td>BOUND 指令</td>
</tr>
<tr>
<td>6</td>
<td>无效操作码</td>
<td>错误</td>
<td>无</td>
<td>UD2 指令或保留的操作码（opcode)</td>
</tr>
<tr>
<td>7</td>
<td>协处理器不可用</td>
<td>错误</td>
<td>无</td>
<td>浮点或 WAIT&#x2F; FWAIT 指令</td>
</tr>
<tr>
<td>8</td>
<td>双重错误</td>
<td>中止</td>
<td>是（零）</td>
<td>可产生异常、NMI 或 INTR 的任何指令</td>
</tr>
<tr>
<td>9</td>
<td>协处理器段溢出</td>
<td>错误</td>
<td>无</td>
<td>浮点指令</td>
</tr>
<tr>
<td>10</td>
<td>无效 TSS</td>
<td>错误</td>
<td>是</td>
<td>任务切换或 TSS 访问</td>
</tr>
<tr>
<td>11</td>
<td>段不存在</td>
<td>错误</td>
<td>是</td>
<td>装载段寄存器或访问系统段</td>
</tr>
<tr>
<td>12</td>
<td>栈段错误</td>
<td>错误</td>
<td>是</td>
<td>栈操作和 SS 寄存器装载</td>
</tr>
<tr>
<td>13</td>
<td>一般保护错</td>
<td>错误</td>
<td>是</td>
<td>任何内存引用或其他保护检查</td>
</tr>
<tr>
<td>14</td>
<td>页面错误</td>
<td>错误</td>
<td>是</td>
<td>任何内存引用</td>
</tr>
<tr>
<td>15</td>
<td>Intel 保留</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>16</td>
<td>x87 浮点</td>
<td>错误</td>
<td>无</td>
<td>x87 FPU 浮点或 WAIT&#x2F; FWAIT 指令</td>
</tr>
<tr>
<td>17</td>
<td>对齐检查</td>
<td>错误</td>
<td>是（零）</td>
<td>对内存中数据的引用</td>
</tr>
<tr>
<td>18</td>
<td>机器检查</td>
<td>中止</td>
<td>无</td>
<td>错误码和异常来源与特定模型相关</td>
</tr>
<tr>
<td>19</td>
<td>SIMD 浮点异常</td>
<td>错误</td>
<td>无</td>
<td>SSE&#x2F;SSE2&#x2F;SSE3浮点指令</td>
</tr>
<tr>
<td>20~31</td>
<td>Intel 保留</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>32~255</td>
<td>用户定义的中断</td>
<td>中断</td>
<td>…</td>
<td>外部中断或 <code>INT N</code> 指令（N &gt;&#x3D; 32)</td>
</tr>
</tbody></table>
<p>   ⚠️<strong>注意</strong>：这里的错误码实际上就是<code>TrapFrame</code>里面<code>ErrCode(0x64)</code>。</p>
<p><img data-src="https://s2.loli.net/2022/04/05/XvoBtC7yVIJOS6Q.png" alt="40.png"></p>
<p>中断号的具体的分配情况:</p>
<table>
<thead>
<tr>
<th>中断号（十进制&#x2F;十六进制）</th>
<th>分配情况</th>
</tr>
</thead>
<tbody><tr>
<td>0D～19D，0x00～0x13</td>
<td>固定<strong>分配给异常</strong>使用。</td>
</tr>
<tr>
<td>20D～31D，0x14-0x1F</td>
<td>Intel保留给他公司将来自己使用（OS和用户都不要试图去使用这个号段，不安全）。</td>
</tr>
<tr>
<td>32D～41D，0x20-0x29</td>
<td>Windows没占用，因此这块号段我们也可以自由使用。</td>
</tr>
<tr>
<td>42D～46D，0x2A-0x2E</td>
<td>Windows自己本身使用的5个中断号：KiGetTickCount、KiCallbaclReturn、KiRaiseAssertion、KiDebugService、KiSystemService。</td>
</tr>
<tr>
<td>48D～255D，0x30-0xFF</td>
<td>Windows决定把这块剩余的号段让给硬件和用户使用。</td>
</tr>
</tbody></table>
<blockquote>
<p>参见《寒江独钓》一书P93页注册键盘中断时，搜索空闲未用表项是从0x20开始，到0x29结束的,就知道为什么寒江独钓是在这段范围内搜索空白表项了（其实我们也完全可以从0x14开始搜索）。</p>
<p>Windows系统中，0x30-0xFF这块号段让给了硬件和用户自己使用。事实上，这块号段的开头部分默认都是让给硬件IRQ使用的，也即是分配给硬件IRQ的。IRQ N默认映射到中断号<code>0x30+N</code>，如IRQ0用于系统时钟，系统时钟中断号默认对应就是0x30。当然程序员也可以修改APIC（可编程中断控制器）将IRQ映射到自定义的中断号。</p>
</blockquote>
<h2 id="3-中断请求级别（IRQL）"><a href="#3-中断请求级别（IRQL）" class="headerlink" title="3 中断请求级别（IRQL）"></a>3 中断请求级别（IRQL）</h2><p>Intel 在 CPU 中虽然内置了APIC 来对中断信号进行转换及其他处理，但是 Software 在区分各类中断的优先级&#x2F;紧急情况时自己做了一套优先级方案，称为<strong>中断请求级别</strong>（IRQL, Interrupt Request Level）。在 Intel x86 系统中，Windows 使用 0~31来表示优先级，<strong>数值越大，优先级越高</strong>。</p>
<ul>
<li>软件中断或非中断代码的 IRQL是在内核中管理的。</li>
<li>硬件中断则在 HAL 中被映射到对应的 IRQL。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PASSIVE_LEVEL 0             <span class="comment">// Passive release level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOW_LEVEL 0                 <span class="comment">// Lowest interrupt level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> APC_LEVEL 1                 <span class="comment">// APC interrupt level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPATCH_LEVEL 2            <span class="comment">// Dispatcher level</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROFILE_LEVEL 27            <span class="comment">// timer used for profiling.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLOCK1_LEVEL 28             <span class="comment">// Interval clock 1 level - Not used on x86</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLOCK2_LEVEL 28             <span class="comment">// Interval clock 2 level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPI_LEVEL 29                <span class="comment">// Interprocessor interrupt level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POWER_LEVEL 30              <span class="comment">// Power failure level</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIGH_LEVEL 31               <span class="comment">// Highest interrupt level</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(NT_UP)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYNCH_LEVEL DISPATCH_LEVEL  <span class="comment">// 针对单处理器系统的同步级别</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYNCH_LEVEL (IPI_LEVEL-1)   <span class="comment">// 针对多处理器系统的同步级别</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>IRQL</th>
<th>IQRL级别</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>PASSIVE_LEVEL</td>
<td>用户模式代码（或驱动代码）运行在次最低级别上。</td>
</tr>
<tr>
<td>1</td>
<td>APC_LEVEL</td>
<td>APC异步过程调用</td>
</tr>
<tr>
<td>2</td>
<td>DISPATCH_LEVEL</td>
<td>一般是线程调度器正在运行，如<code>KiDispatchInterrupt</code>、<code>SwapContext</code>。或者正在处理硬件中断的后半部分。注意DPC与线程无关。是最高的软件中断级别，但是又要比所有的硬件中断IRQL低。</td>
</tr>
<tr>
<td>3～26</td>
<td>DIRQL</td>
<td>3~26 之间的 IRQL 被分配给设备，称为设备 IRQL（或 DIRQL)，HAL 规定它们的分配方案。<br />在 Intel x86 多处理器系统中，HAL 会循环地将中断向量号映射到这段 IRQL 范围中。<br/>DIRQL 范围中的 IRQL并无优先级区别，不同的设备中断只是被映射到相同或不同的 IRQL 而已。</td>
</tr>
<tr>
<td>27</td>
<td>PROFILE_LEVEL</td>
<td>是一个专用于性能剖析定时器的 IRQL。<br />当内核的性能剖析功能（利用 Microsoft 提供的 Kernrate 工具）打开时，系统时钟就会周期性地对当前处理器的代码地址（即被中断处的代码的地址）进行采样，从而建立起一张地址采样表，用来分析各个内核模块被执行的情况。在执行内核性能剖析功能时，处理器的 IRQL 将提升到<code>PROFILE_LEVEL</code>。</td>
</tr>
<tr>
<td>28</td>
<td>CLOCK_LEVEL</td>
<td>是系统时钟中断使用的 IRQL，内核利用此 IRQL来更新系统时间以及<strong>触发定时器</strong>。</td>
</tr>
<tr>
<td>29</td>
<td>IPI_LEVEL</td>
<td>是处理器之间通信的中断级别，它优先于时钟中断。</td>
</tr>
<tr>
<td>30</td>
<td>POWER_LEVEL</td>
<td>被定义为电源失败，但并未在 Windows 中真正使用。</td>
</tr>
<tr>
<td>31</td>
<td>HIGH_LEVEL</td>
<td>用于一些最高级别的任务，它禁止了所有其他级别的中断。当系统发生不可恢复错误而进入错误检查（BugCheck）状态时，会将 IRQL 提升至 <code>HIGH_LEVEL</code>，以屏蔽所有其他的中断。</td>
</tr>
</tbody></table>
<p><img data-src="https://s2.loli.net/2022/07/03/PkctBC18j3vgMQ4.png" alt="3.png"></p>
<div class="note default"><ul>
<li>Windows 总是运行在一个高度并发的环境中，<strong>任何时候，每个处理器都运行在某一IRQL 上</strong>。当中断发生时，处理器把被中断的线程的状态保存起来，然后调用 IDT中设定的中断例程。</li>
<li>一个处于内核模式中的线程根据它所要做的事情来提升<code>KeRaiselrql</code>或者降低<code>KeLowerlrql</code>当前处理器的 IRQL。尤其是，当线程要<strong>访问全局的数据结构或执行关键的任务时</strong>，必须考虑是否提升IRQL，在完成以后，再降低IRQL。提升 IRQL可以屏较低 IRQL 的线程或中断。</li>
<li>但是，<strong>作为内核代码，它总是应该尽可能地保持当前处理器的 IRQL 在 <code>PASSIVE_LEVEL</code>上</strong>，这<br>样用户代码才有机会得以运行。</li>
<li><code>KPCR-&gt;irql</code>记录当前CPU所处的IRQL。</li>
</ul>
</div>

<div class="note warning"><p>关于<code>DISPATCH_LEVEL</code>需要注意：</p>
<p><code>DISPATCH_LEVEL</code>是最高的软件中断级别，但是又要比所有的硬件中断IRQL低。</p>
<ol>
<li><strong>不能做任何等待动作</strong>：如果某个线程已经运行在这个级别，则不得切换到其他线程（比如，等待一个同步对象，当前IRQL得线程不能等其他低级别线程等待的被等待对象，换句话说就是<strong>不能做任何等待动作</strong>），因为线程切换是通过系统调度器来完成的，而系统调度器运行在 <code>DISPATCH_LEVEL</code> 上。</li>
<li><strong>不能访问换页内存区</strong>：因为一旦发生换页动作，就需要执行 I&#x2F;O 操作，从磁盘上读入页面，<strong>期间至少有一个等待动作</strong>。因此，在中断处理例程中，只能访问非换页内存。</li>
</ol>
</div>

<p>在 Intel x86 系统上，DPC 也运行在 <code>DISPATCH _LEVEL</code> 上，所以，这些规则均适用于 DPC 代码。在设备驱动程序中，这也是常见的错误原因。</p>
<h2 id="4-中断对象（外部设备使用）"><a href="#4-中断对象（外部设备使用）" class="headerlink" title="4 中断对象（外部设备使用）"></a>4 中断对象（外部设备使用）</h2><p>中断对象是 Windows 提供的一种中断扩展机制，它允许<strong>设备驱动程序</strong>将一个中断服务例程（ISR,Interrupt Service Routine）与某一特定的中断向量关联起来。通过中断对象机制，设备驱动程序无须操纵 IDT 就可以处理设备中断。</p>
<div class="note danger"><p>其实我们不必要关注这么多细节，这些任务操作系统或者设备驱动开发的人已经做好了。最重要的就是要知道：<strong>APIC将中断信号转换成中断向量，<code>IoConnectInterrupt</code>将中断向量与中断服务函数ISR关联起来，以后只要对应的中断发生就直接去执行ISR了</strong>。我们常说的<strong>IDT HOOK</strong>，实际上就是将这里的ISR替换成我们事先准备好的一个函数，然后我们去修改IDT段描述符的偏移Offset和对应的GDT段描述符的BaseAddress即可。</p>
</div>

<p>中断对象是一种强大而方便的系统机制，它允许设备驱动程序通过一种可移植的途径插入它们的中断服务例程，从而支持硬件设备的中断处理。这种能力有重要的意义，它使得硬件设备，包括各种硬件总线、视频设备、网络设备等，共享同样的硬件中断向量。然而，<strong>Windows内核本身并不使用中断对象来处理中断</strong>。内核处理的中断包括定时器中断、电源失败、机器错误检查，以及内部使用的一些软件中断。这些中断例程是用汇编语言编写的，往往与具体的系统硬件平台紧密相关。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KINTERRUPT</span><br><span class="line">nt!_KINTERRUPT</span><br><span class="line">   +<span class="number">0x000</span> Type             : Int2B</span><br><span class="line">   +<span class="number">0x002</span> Size             : Int2B</span><br><span class="line">   +<span class="number">0x004</span> InterruptListEntry : _LIST_ENTRY</span><br><span class="line">   +<span class="number">0x00c</span> ServiceRoutine   : Ptr32     <span class="keyword">unsigned</span> <span class="keyword">char</span> </span><br><span class="line">   +<span class="number">0x010</span> ServiceContext   : Ptr32 Void</span><br><span class="line">   +<span class="number">0x014</span> SpinLock         : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> TickCount        : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> ActualLock       : Ptr32 Uint4B</span><br><span class="line">   +<span class="number">0x020</span> DispatchAddress  : Ptr32     <span class="keyword">void</span> <span class="comment">//中断分发函数的地址，KiInterruptDispatch</span></span><br><span class="line">   +<span class="number">0x024</span> Vector           : Uint4B</span><br><span class="line">   +<span class="number">0x028</span> Irql             : UChar</span><br><span class="line">   +<span class="number">0x029</span> SynchronizeIrql  : UChar</span><br><span class="line">   +<span class="number">0x02a</span> FloatingSave     : UChar</span><br><span class="line">   +<span class="number">0x02b</span> Connected        : UChar</span><br><span class="line">   +<span class="number">0x02c</span> Number           : Char</span><br><span class="line">   +<span class="number">0x02d</span> ShareVector      : UChar</span><br><span class="line">   +<span class="number">0x030</span> Mode             : _KINTERRUPT_MODE</span><br><span class="line">   +<span class="number">0x034</span> ServiceCount     : Uint4B</span><br><span class="line">   +<span class="number">0x038</span> DispatchCount    : Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> DispatchCode     : [<span class="number">106</span>] Uint4B</span><br></pre></td></tr></table></figure>

<p>在一个中断对象中，InterruptListEntry 域使得一组中断对象相互链接起来，与同一个中断向最关联的中断对象构成了一个双链表，因此，当中断发生时，这些中断对象都能被执行。SeviceRoutine 域是中断对象的处理例程，即中断服务例程。Vector 城指明了一个中断对象的向量编号。Irql 域表示该中断处理例程执行时的 IRQL。 DispatehCode 域包含了基本的中断处理代码，它是在中断对象初始化时已填好的少量汇编指令。当中断发生时，这些代码首先被执行。Mode 域是一个C枚举类型成员，代表了该中断对象的模式，有两种可能：LevelSensitive 或 Latched, LevelSensitive 模式的中断是指，当中断请求信号出现(asserted）时，中断就会发生，因此，中断对象的例程必须消除中断的原因；而 Latched模式的中断是指，仅当中断请求信号从无信号（deasserted）到有信号（asserted ）发生变化时，中断才会发生。</p>
<ul>
<li>IoConnectInterrupt：将一个中断服务程序连接到给定的中断向量上。</li>
</ul>
<p>设备驱动程序并不直接调用 Kelnitializelnterrupt 和 KeConnectInterrupt 函数，相反地，它们调用 IoConnectlnterrupt 函数来使用中断对象。IoConnectinterrupt 封装了这两个内核函数。在函数 IoConnectinterrupt 中，会先后调用 Keinitializelnterrupt和 KeConnectinterrupt，前者是 KINTERRUPT 对象结构的初始化，后者<strong>将其连接到系统的中断向量及中断分发函数</strong>。</p>
<ol>
<li>KeInitializeInterrupt：除了将参数中的值赋给中断对象以外，还会将KeInterruptTemplate数组中的指令拷贝到中断对象的DispatchCode成员中，并且修正其中的一条指令，使其指向当前中断对象。</li>
<li>中断对象在经过初始化以后，便可以调用 KeConnectlnterrupt 函数，将它挂到中断对象中指定的中断向量的 IDT 项中。</li>
<li>KeConnectlnterrupt 用到了两个辅助函数 KiConnectVectorAndlnterruptObject 和 KiGetVeetorinfo，并通过数据结构 DISPATCHL_INFO 来传递中断设置。其中KiConneetVeetorAndinterruptObjeet 函数负责把中断对象的 DispatchCode 代码中的“jmp_KeSynchronizeBxecution”指令的目标地址修正为与<strong>该中断向量相匹配的中断分发函数</strong>。系统提供的中断分发两数为：KiInterruptDispatch、 KiFloatingDispatch 和 KiChainedDispatch，或者 KilnterruptDispatch2ndLyl、 KilnterruptDispatch2ndLvl 和 KiChainedDispatch2ndLvl。</li>
<li>其中后三个分发函数针对二级分发，由 HAL 决定。链式中断分发函数，即 KiChainedDispatch 和 KiChainedDispatch2ndLvl 的流程是：针对链表中的每个中断对象，提升 IRQL，获得服务例程自旋锁（即中断对象的 ActualLock 域），调用中断对象的服务例程，然后释放自旋锁，恢复 IRQL。</li>
<li>对于 LevelSensitive 模式的中断，一旦链表上有一个中断对象的中断服务例程已经处理了一个中断，则后面的中断对象不再有机会处理该中断；而对于 Latched模式的中，中断分发函数会遍历整个链表，因而链表上所有中断对象都可以处理该中断。</li>
<li>KiConnectVectorAndlnterruptObject 函数通过C宏 KiSetHandlerAddressTOIDT 将中断对象中的中断分发函数插人到 IDT中。一旦 KeConnectInterrupt 函数完成这一步并打开中断开关，<strong>以后当中断发生时，该中断分发函数就会被调用</strong>。</li>
</ol>
<ul>
<li><p>Windows内核原理与实现：初始化和连接工作完成后，以后只要中断一触发，就会首先调用DispatchCode成员，在该成员指向的代码中会jmp到对应的KiInterruptDispatch。</p>
</li>
<li><p>Windows内核情景分析：当中断发生时，CPU 首先进入的是中断响应程序（KiInterruptDispatch），再由中断响应程序“分发（Dispatch）”进入预设的中断服务程序。</p>
</li>
</ul>
<p>基于上述关于中断机制的介绍，我们可以知道，当一个中断发生时，其处理过程如下：</p>
<ul>
<li>中断对象的 DispatchCode 代码块首先获得控制，它把该代码块所在的中断对象放到edi寄存器中，然后跳转到该中断向量对应的中断分发函数。</li>
<li>在中断分发函数中，它提升 IRQL，获取自旋锁，然后调用中断对象的服务例程，即KINTERRUPT 的 ServiceRoutine 成员，待返回以后，释放自旋锁，恢复IRQL。依据不同的中断分发函数以及中断对象的模式，可能还会处理中断对象链表上的其他中断<br>对象，如上文所介绍。</li>
<li>最后，中断分发函数通过 Kei386EoiHelper 辅助函数返回。Kei386EoiHelper 中的 iretd 指令结束整个中断处理。</li>
</ul>
<p>图5.7显示了两个中断对象连接到同一个中断向量情形下的中断控制流程。图中的实线箭头代表了实际的控制流，虚线箭头代表了指针关系。</p>
<p><img data-src="https://s2.loli.net/2022/07/07/M6QHAUlEZi98mOp.png" alt="4.png"></p>
<div class="note primary"><p><strong>下面描述一个外部设备的建立，然后将分配给改设备的中断向量号与对应的ISR建立的过程：</strong></p>
<ol>
<li>Pnp设备（即插即用设备）在插入系统后，相应的总线驱动会自动为其创建一个用作栈底基石的pdo，然后给这个pdo发出一个<code>IRP_MN_QUERY_RESOURCE_REQUIREMENTS</code>，查询得到初步的资源需求。</li>
<li>然后，pnp管理器会找到相应的硬件端口驱动，调用其<code>AddDevice</code>函数，当这个函数返回后，该硬件设备的设备栈已经建立起立了，pnp管理器就给栈顶设备发出一个<code>IRP_MN_FILTER_RESOURCE_REQUIREMENTS</code>再次询问该硬件需要的资源（功能驱动此时可以拦截处理这个irp，修改资源需求），当确定好最终的资源需求后，系统就协调分配端口号、中断号、DIRQL等硬件资源给它。</li>
<li>分配完后，就发出一个<code>IRP_MN_START_DEVICE</code>给栈顶设备请求启动该硬件设备。当该irp下发来到端口驱动（指真正的硬件驱动）时， 端口驱动这时就需要在分配的中断号上注册一个中断服务例程ISR，以处理硬件中断，与设备进行交互。函数<code>IoConnectInterrupt</code>就是用来注册中断服务例程。</li>
</ol>
<p>上面内容参考《Windows内核情景分析下第九章》，其实我们不必要关注这么多细节，这些任务操作系统或者设备驱动开发的人已经做好了。最重要的就是要知道：<strong>APIC将中断信号转换成中断向量，<code>IoConnectInterrupt</code>将中断向量与中断服务函数ISR关联起来，以后只要对应的中断发生就直接去执行ISR了</strong>。我们常说的IDT HOOK，实际上就是将这里的ISR替换成我们事先准备好的一个函数，然后我们去修改IDT段描述符的偏移Offset和对应的GDT段描述符的BaseAddress。</p>
</div>

<p>可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/maomao171314/article/details/22917019?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165693748716780357242611%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=165693748716780357242611&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-3-22917019-null-null.142%5Ev30%5Epc_search_v2,185%5Ev2%5Econtrol&utm_term=Windows%E5%86%85%E6%A0%B8%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90-%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86&spm=1018.2226.3001.4187">windows内核情景分析—中断处理</a>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">IoConnectInterrupt</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OUT PKINTERRUPT *InterruptObject,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKSERVICE_ROUTINE ServiceRoutine,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID ServiceContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKSPIN_LOCK SpinLock OPTIONAL,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ULONG Vector,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KIRQL Irql,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KIRQL SynchronizeIrql,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KINTERRUPT_MODE InterruptMode,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN BOOLEAN ShareVector,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KAFFINITY ProcessorEnableMask,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN BOOLEAN FloatingSave</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="function"><span class="comment">Routine Description:</span></span></span><br><span class="line"><span class="function"><span class="comment">    This routine allocates, initializes, and connects interrupt objects for</span></span></span><br><span class="line"><span class="function"><span class="comment">    all of the processors specified in the processor enable mask.</span></span></span><br><span class="line"><span class="function"><span class="comment">Arguments:</span></span></span><br><span class="line"><span class="function"><span class="comment">    InterruptObject - Address of a variable to receive a pointer to the first</span></span></span><br><span class="line"><span class="function"><span class="comment">        interrupt object allocated and initialized.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ServiceRoutine - Address of the interrupt service routine (ISR) that should</span></span></span><br><span class="line"><span class="function"><span class="comment">        be executed when the interrupt occurs.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ServiceContext - Supplies a pointer to the context information required</span></span></span><br><span class="line"><span class="function"><span class="comment">        by the ISR.</span></span></span><br><span class="line"><span class="function"><span class="comment">    SpinLock - Supplies a pointer to a spin lock to be used when synchronizing</span></span></span><br><span class="line"><span class="function"><span class="comment">        with the ISR.</span></span></span><br><span class="line"><span class="function"><span class="comment">    Vector - Supplies the vector upon which the interrupt occurs.</span></span></span><br><span class="line"><span class="function"><span class="comment">    Irql - Supplies the IRQL upon which the interrupt occurs.</span></span></span><br><span class="line"><span class="function"><span class="comment">    SynchronizeIrql - The request priority that the interrupt should be</span></span></span><br><span class="line"><span class="function"><span class="comment">        synchronized with.</span></span></span><br><span class="line"><span class="function"><span class="comment">    InterruptMode - Specifies the interrupt mode of the device.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ShareVector - Supplies a boolean value that specifies whether the</span></span></span><br><span class="line"><span class="function"><span class="comment">        vector can be shared with other interrupt objects or not.  If FALSE</span></span></span><br><span class="line"><span class="function"><span class="comment">        then the vector may not be shared, if TRUE it may be. Latched.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ProcessorEnableMask - Specifies a bit-vector for each processor on which</span></span></span><br><span class="line"><span class="function"><span class="comment">        the interrupt is to be connected.  A value of one in the bit position</span></span></span><br><span class="line"><span class="function"><span class="comment">        cooresponding to the processor number indicates that the interrupt</span></span></span><br><span class="line"><span class="function"><span class="comment">        should be allowed on that processor.  At least one bit must be set.</span></span></span><br><span class="line"><span class="function"><span class="comment">    FloatingSave - A BOOLEAN that specifies whether or not the machine&#x27;s</span></span></span><br><span class="line"><span class="function"><span class="comment">        floating point state should be saved before invoking the ISR.</span></span></span><br><span class="line"><span class="function"><span class="comment">Return Value:</span></span></span><br><span class="line"><span class="function"><span class="comment">    The function value is the final function status.  The three status values</span></span></span><br><span class="line"><span class="function"><span class="comment">    that this routine can itself return are:</span></span></span><br><span class="line"><span class="function"><span class="comment">        STATUS_SUCCESS - Everything worked successfully.</span></span></span><br><span class="line"><span class="function"><span class="comment">        STATUS_INVALID_PARAMETER - No processors were specified.</span></span></span><br><span class="line"><span class="function"><span class="comment">        STATUS_INSUFFICIENT_RESOURCES - There was not enough nonpaged pool.</span></span></span><br><span class="line"><span class="function"><span class="comment">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CCHAR count;</span><br><span class="line">    BOOLEAN builtinUsed;</span><br><span class="line">    PKINTERRUPT interruptObject;</span><br><span class="line">    KAFFINITY processorMask;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    PIO_INTERRUPT_STRUCTURE interruptStructure;</span><br><span class="line">    PKSPIN_LOCK spinLock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>  INTR_BINDING</span></span><br><span class="line">    ULONG AssignedProcessor;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// INTR_BINDING</span></span></span><br><span class="line"></span><br><span class="line">    PAGED_CODE();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the return pointer and assume success.</span></span><br><span class="line">    *InterruptObject = (PKINTERRUPT) <span class="literal">NULL</span>;</span><br><span class="line">    status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine how much memory is to be allocated based on how many</span></span><br><span class="line">    <span class="comment">// processors this system may have and how many bits are set in the</span></span><br><span class="line">    <span class="comment">// processor enable mask.</span></span><br><span class="line">    processorMask = ProcessorEnableMask &amp; KeActiveProcessors;</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (processorMask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (processorMask &amp; <span class="number">1</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        processorMask &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If any interrupt objects are to be allocated and initialized, allocate</span></span><br><span class="line">    <span class="comment">// the memory now.</span></span><br><span class="line">    <span class="keyword">if</span> (count) &#123;</span><br><span class="line"></span><br><span class="line">        interruptStructure = ExAllocatePoolWithTag( NonPagedPool,</span><br><span class="line">                                                    ((count - <span class="number">1</span>) * <span class="keyword">sizeof</span>( KINTERRUPT )) +</span><br><span class="line">                                                    <span class="keyword">sizeof</span>( IO_INTERRUPT_STRUCTURE ),</span><br><span class="line">                                                    &#x27;nioI&#x27; );</span><br><span class="line">        <span class="keyword">if</span> (interruptStructure == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        status = STATUS_INVALID_PARAMETER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the caller specified a spin lock to be used for the interrupt object,</span></span><br><span class="line">    <span class="comment">// use it.  Otherwise, provide one by using the one in the structure that</span></span><br><span class="line">    <span class="comment">// was just allocated.</span></span><br><span class="line">    <span class="keyword">if</span> (ARGUMENT_PRESENT( SpinLock )) &#123;</span><br><span class="line">        spinLock = SpinLock;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        spinLock = &amp;interruptStructure-&gt;SpinLock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the pool allocation was successful, initialize and connect the</span></span><br><span class="line">    <span class="comment">// interrupt objects to the appropriate processors.</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS( status )) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Return the address of the first interrupt object in case an</span></span><br><span class="line">        <span class="comment">// interrupt is pending for the device when it is initially connected</span></span><br><span class="line">        <span class="comment">// and the driver must synchronize its execution with the ISR.</span></span><br><span class="line">        *InterruptObject = &amp;interruptStructure-&gt;InterruptObject;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Begin by getting a pointer to the start of the memory to be used</span></span><br><span class="line">        <span class="comment">// for interrupt objects other than the builtin object.</span></span><br><span class="line">        interruptObject = (PKINTERRUPT) (interruptStructure + <span class="number">1</span>);</span><br><span class="line">        builtinUsed = FALSE;</span><br><span class="line">        processorMask = ProcessorEnableMask &amp; KeActiveProcessors;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now zero the interrupt structure itself so that if something goes</span></span><br><span class="line">        <span class="comment">// wrong it can be backed out.</span></span><br><span class="line">        RtlZeroMemory( interruptStructure, <span class="keyword">sizeof</span>( IO_INTERRUPT_STRUCTURE ) );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For each entry in the processor enable mask that is set, connect</span></span><br><span class="line">        <span class="comment">// and initialize an interrupt object.  The first bit that is set</span></span><br><span class="line">        <span class="comment">// uses the builtin interrupt object, and all others use the pointers that follow it.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (count = <span class="number">0</span>; processorMask; count++, processorMask &gt;&gt;= <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (processorMask &amp; <span class="number">1</span>) &#123;</span><br><span class="line">                KeInitializeInterrupt( builtinUsed ?</span><br><span class="line">                                       interruptObject :</span><br><span class="line">                                       &amp;interruptStructure-&gt;InterruptObject,</span><br><span class="line">                                       ServiceRoutine,</span><br><span class="line">                                       ServiceContext,</span><br><span class="line">                                       spinLock,</span><br><span class="line">                                       Vector,</span><br><span class="line">                                       Irql,</span><br><span class="line">                                       SynchronizeIrql,</span><br><span class="line">                                       InterruptMode,</span><br><span class="line">                                       ShareVector,</span><br><span class="line">                                       count,</span><br><span class="line">                                       FloatingSave );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!KeConnectInterrupt( builtinUsed ?</span><br><span class="line">                                         interruptObject :</span><br><span class="line">                                         &amp;interruptStructure-&gt;InterruptObject )) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// An error occurred while attempting to connect the</span></span><br><span class="line">                    <span class="comment">// interrupt.  This means that the driver either specified</span></span><br><span class="line">                    <span class="comment">// the wrong type of interrupt mode, or attempted to connect</span></span><br><span class="line">                    <span class="comment">// to some processor that didn&#x27;t exist, or whatever.  In</span></span><br><span class="line">                    <span class="comment">// any case, the problem turns out to be an invalid</span></span><br><span class="line">                    <span class="comment">// parameter was specified.  Simply back everything out</span></span><br><span class="line">                    <span class="comment">// and return an error status.</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// Note that if the builtin entry was used, then the entire</span></span><br><span class="line">                    <span class="comment">// structure needs to be walked as there are entries that</span></span><br><span class="line">                    <span class="comment">// were successfully connected.  Otherwise, the first</span></span><br><span class="line">                    <span class="comment">// attempt to connect failed, so simply free everything in-line.</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (builtinUsed) &#123;</span><br><span class="line">                        IoDisconnectInterrupt( &amp;interruptStructure-&gt;InterruptObject );</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ExFreePool( interruptStructure );</span><br><span class="line">                    &#125;</span><br><span class="line">                    status = STATUS_INVALID_PARAMETER;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If the builtin entry has been used, then the interrupt</span></span><br><span class="line">                <span class="comment">// object just connected was one of the pointers, so fill</span></span><br><span class="line">                <span class="comment">// it in with the address of the memory actually used.</span></span><br><span class="line">              </span><br><span class="line">                <span class="keyword">if</span> (builtinUsed) &#123;</span><br><span class="line">                    interruptStructure-&gt;InterruptArray[count] = interruptObject++;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Otherwise, the builtin entry was used, so indicate</span></span><br><span class="line">                    <span class="comment">// that it is no longer valid to use and start using</span></span><br><span class="line">                    <span class="comment">// the pointers instead.</span></span><br><span class="line"></span><br><span class="line">                    builtinUsed = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Finally, reset the address of the interrupt object if the function</span></span><br><span class="line">    <span class="comment">// failed and return the final status of the operation.</span></span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS( status )) &#123;</span><br><span class="line">        *InterruptObject = (PKINTERRUPT) <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数 <code>KeInitializeInterrupt</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID <span class="title">KeInitializeInterrupt</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKINTERRUPT Interrupt,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKSERVICE_ROUTINE ServiceRoutine,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PVOID ServiceContext,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PKSPIN_LOCK SpinLock OPTIONAL,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ULONG Vector,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KIRQL Irql,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KIRQL SynchronizeIrql,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN KINTERRUPT_MODE InterruptMode,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN BOOLEAN ShareVector,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN CCHAR ProcessorNumber,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN BOOLEAN FloatingSave</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="function"><span class="comment">Routine Description:</span></span></span><br><span class="line"><span class="function"><span class="comment">    This function initializes a kernel interrupt object. The service routine,</span></span></span><br><span class="line"><span class="function"><span class="comment">    service context, spin lock, vector, IRQL, SynchronizeIrql, and floating</span></span></span><br><span class="line"><span class="function"><span class="comment">    context save flag are initialized.</span></span></span><br><span class="line"><span class="function"><span class="comment">Arguments:</span></span></span><br><span class="line"><span class="function"><span class="comment">    Interrupt - Supplies a pointer to a control object of type interrupt.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ServiceRoutine - Supplies a pointer to a function that is to be</span></span></span><br><span class="line"><span class="function"><span class="comment">        executed when an interrupt occurs via the specified interrupt vector.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ServiceContext - Supplies a pointer to an arbitrary data structure which is</span></span></span><br><span class="line"><span class="function"><span class="comment">        to be passed to the function specified by the ServiceRoutine parameter.</span></span></span><br><span class="line"><span class="function"><span class="comment">    SpinLock - Supplies a pointer to an executive spin lock.</span></span></span><br><span class="line"><span class="function"><span class="comment">    Vector - Supplies the index of the entry in the Interrupt Dispatch Table</span></span></span><br><span class="line"><span class="function"><span class="comment">        that is to be associated with the ServiceRoutine function.</span></span></span><br><span class="line"><span class="function"><span class="comment">    Irql - Supplies the request priority of the interrupting source.</span></span></span><br><span class="line"><span class="function"><span class="comment">    SynchronizeIrql - The request priority that the interrupt should be synchronized with.</span></span></span><br><span class="line"><span class="function"><span class="comment">    InterruptMode - Supplies the mode of the interrupt; LevelSensitive or</span></span></span><br><span class="line"><span class="function"><span class="comment"></span></span></span><br><span class="line"><span class="function"><span class="comment">    ShareVector - Supplies a boolean value that specifies whether the</span></span></span><br><span class="line"><span class="function"><span class="comment">        vector can be shared with other interrupt objects or not.  If FALSE</span></span></span><br><span class="line"><span class="function"><span class="comment">        then the vector may not be shared, if TRUE it may be. Latched.</span></span></span><br><span class="line"><span class="function"><span class="comment">    ProcessorNumber - Supplies the number of the processor to which the</span></span></span><br><span class="line"><span class="function"><span class="comment">        interrupt will be connected.</span></span></span><br><span class="line"><span class="function"><span class="comment">    FloatingSave - Supplies a boolean value that determines whether the</span></span></span><br><span class="line"><span class="function"><span class="comment">        floating point registers and pipe line are to be saved before calling</span></span></span><br><span class="line"><span class="function"><span class="comment">        the ServiceRoutine function.</span></span></span><br><span class="line"><span class="function"><span class="comment">Return Value: None.</span></span></span><br><span class="line"><span class="function"><span class="comment">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    LONG Index;</span><br><span class="line">    PULONG pl;</span><br><span class="line">    PULONG NormalDispatchCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize standard control object header.</span></span><br><span class="line">    Interrupt-&gt;Type = InterruptObject;</span><br><span class="line">    Interrupt-&gt;Size = <span class="keyword">sizeof</span>(KINTERRUPT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the address of the service routine,</span></span><br><span class="line">    <span class="comment">// the service context, the address of the spin lock, the vector</span></span><br><span class="line">    <span class="comment">// number, the IRQL of the interrupting source, the Irql used for</span></span><br><span class="line">    <span class="comment">// synchronize execution, the interrupt mode, the processor</span></span><br><span class="line">    <span class="comment">// number, and the floating context save flag.</span></span><br><span class="line">  </span><br><span class="line">    Interrupt-&gt;ServiceRoutine = ServiceRoutine;</span><br><span class="line">    Interrupt-&gt;ServiceContext = ServiceContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ARGUMENT_PRESENT(SpinLock)) &#123;</span><br><span class="line">        Interrupt-&gt;ActualLock = SpinLock;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        KeInitializeSpinLock (&amp;Interrupt-&gt;SpinLock);</span><br><span class="line">        Interrupt-&gt;ActualLock = &amp;Interrupt-&gt;SpinLock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Interrupt-&gt;Vector = Vector;</span><br><span class="line">    Interrupt-&gt;Irql = Irql;</span><br><span class="line">    Interrupt-&gt;SynchronizeIrql = SynchronizeIrql;</span><br><span class="line">    Interrupt-&gt;Mode = InterruptMode;</span><br><span class="line">    Interrupt-&gt;ShareVector = ShareVector;</span><br><span class="line">    Interrupt-&gt;Number = ProcessorNumber;</span><br><span class="line">    Interrupt-&gt;FloatingSave = FloatingSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize fields for the interrupt storm detection. Set these</span></span><br><span class="line">    <span class="comment">// to -1 so that the first time through the interrupt dispatch they</span></span><br><span class="line">    <span class="comment">// will be reset correctly.</span></span><br><span class="line"></span><br><span class="line">    Interrupt-&gt;TickCount = (ULONG)<span class="number">-1</span>;</span><br><span class="line">    Interrupt-&gt;DispatchCount = (ULONG)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy the interrupt dispatch code template into the interrupt object</span></span><br><span class="line">    <span class="comment">// and edit the machine code stored in the structure (please see</span></span><br><span class="line">    <span class="comment">// _KiInterruptTemplate in intsup.asm.)  Finally, flush the dcache</span></span><br><span class="line">    <span class="comment">// on all processors that the current thread can</span></span><br><span class="line">    <span class="comment">// run on to ensure that the code is actually in memory.</span></span><br><span class="line"></span><br><span class="line">    NormalDispatchCode = &amp;(Interrupt-&gt;DispatchCode[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    pl = NormalDispatchCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; NORMAL_DISPATCH_LENGTH; Index += <span class="number">1</span>) &#123;</span><br><span class="line">        *NormalDispatchCode++ = KiInterruptTemplate[Index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The following two instructions set the address of current interrupt</span></span><br><span class="line">    <span class="comment">// object the the NORMAL dispatching code.</span></span><br><span class="line"></span><br><span class="line">    pl = (PULONG)((PUCHAR)pl + ((PUCHAR)&amp;KiInterruptTemplateObject -</span><br><span class="line">                                (PUCHAR)KiInterruptTemplate) <span class="number">-4</span>); </span><br><span class="line">    *pl = (ULONG)Interrupt;</span><br><span class="line"></span><br><span class="line">    KeSweepDcache(FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the connected state of the interrupt object to FALSE.</span></span><br><span class="line"></span><br><span class="line">    Interrupt-&gt;Connected = FALSE;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>函数<code>KeConnectInterrupt</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOLEAN <span class="title">KeConnectInterrupt</span><span class="params">(IN PKINTERRUPT Interrupt)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="function"><span class="comment">Routine Description:</span></span></span><br><span class="line"><span class="function"><span class="comment">    This function connects an interrupt object to the interrupt vector</span></span></span><br><span class="line"><span class="function"><span class="comment">    specified by the interrupt object. If the interrupt object is already</span></span></span><br><span class="line"><span class="function"><span class="comment">    connected, or an attempt is made to connect to an interrupt that cannot</span></span></span><br><span class="line"><span class="function"><span class="comment">    be connected, then a value of FALSE is returned. Else the specified</span></span></span><br><span class="line"><span class="function"><span class="comment">    interrupt object is connected to the interrupt vector, the connected</span></span></span><br><span class="line"><span class="function"><span class="comment">    state is set to TRUE, and TRUE is returned as the function value.</span></span></span><br><span class="line"><span class="function"><span class="comment">Arguments: Interrupt - Supplies a pointer to a control object of type interrupt.</span></span></span><br><span class="line"><span class="function"><span class="comment">Return Value:</span></span></span><br><span class="line"><span class="function"><span class="comment">    If the interrupt object is already connected or an attempt is made to</span></span></span><br><span class="line"><span class="function"><span class="comment">    connect to an interrupt vector that cannot be connected, then a value</span></span></span><br><span class="line"><span class="function"><span class="comment">    of FALSE is returned. Else a value of TRUE is returned.</span></span></span><br><span class="line"><span class="function"><span class="comment">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DISPATCH_INFO DispatchInfo;</span><br><span class="line">    BOOLEAN Connected;</span><br><span class="line">    BOOLEAN ConnectError;</span><br><span class="line">    BOOLEAN Enabled;</span><br><span class="line">    KIRQL Irql;</span><br><span class="line">    CCHAR Number;</span><br><span class="line">    KIRQL OldIrql;</span><br><span class="line">    ULONG Vector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the interrupt object is already connected, the interrupt vector</span></span><br><span class="line">    <span class="comment">// number is invalid, an attempt is being made to connect to a vector</span></span><br><span class="line">    <span class="comment">// that cannot be connected, the interrupt request level is invalid, or</span></span><br><span class="line">    <span class="comment">// the processor number is invalid, then do not connect the interrupt</span></span><br><span class="line">    <span class="comment">// object. Else connect interrupt object to the specified vector and</span></span><br><span class="line">    <span class="comment">// establish the proper interrupt dispatcher.</span></span><br><span class="line"></span><br><span class="line">    Connected = FALSE;</span><br><span class="line">    ConnectError = FALSE;</span><br><span class="line">    Irql = Interrupt-&gt;Irql;</span><br><span class="line">    Number = Interrupt-&gt;Number;</span><br><span class="line">    Vector = Interrupt-&gt;Vector;</span><br><span class="line">    <span class="keyword">if</span> ( !((Irql &gt; HIGH_LEVEL) ||</span><br><span class="line">           (Number &gt;= KeNumberProcessors) ||</span><br><span class="line">           (Interrupt-&gt;SynchronizeIrql &lt; Irql) ||</span><br><span class="line">           (Interrupt-&gt;FloatingSave)    <span class="comment">// R0 x87 usage not supported on x86</span></span><br><span class="line">          )</span><br><span class="line">       ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set system affinity to the specified processor.</span></span><br><span class="line"></span><br><span class="line">        KeSetSystemAffinityThread((KAFFINITY)(<span class="number">1</span>&lt;&lt;Number));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span></span><br><span class="line">        KiLockDispatcherDatabase(&amp;OldIrql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Is interrupt object already connected?</span></span><br><span class="line">        <span class="keyword">if</span> (!Interrupt-&gt;Connected) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Determine interrupt dispatch vector</span></span><br><span class="line">            KiGetVectorInfo (</span><br><span class="line">                Vector,</span><br><span class="line">                &amp;DispatchInfo</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If dispatch vector is not connected, then connect it</span></span><br><span class="line">            <span class="keyword">if</span> (DispatchInfo.Type == NoConnect) &#123;</span><br><span class="line">                Connected = TRUE;</span><br><span class="line">                Interrupt-&gt;Connected = TRUE;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Connect interrupt dispatch to interrupt object dispatch code</span></span><br><span class="line"></span><br><span class="line">                InitializeListHead(&amp;Interrupt-&gt;InterruptListEntry);</span><br><span class="line">                KiConnectVectorAndInterruptObject (Interrupt, NormalConnect);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Enabled system vector</span></span><br><span class="line">                Enabled = HalEnableSystemInterrupt(Vector, Irql, Interrupt-&gt;Mode);</span><br><span class="line">                <span class="keyword">if</span> (!Enabled) &#123;</span><br><span class="line">                    ConnectError = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DispatchInfo.Type != UnkownConnect &amp;&amp;</span><br><span class="line">                       Interrupt-&gt;ShareVector  &amp;&amp;</span><br><span class="line">                       DispatchInfo.Interrupt-&gt;ShareVector  &amp;&amp;</span><br><span class="line">                       DispatchInfo.Interrupt-&gt;Mode == Interrupt-&gt;Mode) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Vector is already connected as sharable.  New vector is sharable</span></span><br><span class="line">                <span class="comment">// and modes match.  Chain new vector.</span></span><br><span class="line"></span><br><span class="line">                Connected = TRUE;</span><br><span class="line">                Interrupt-&gt;Connected = TRUE;</span><br><span class="line"></span><br><span class="line">                ASSERT (Irql &lt;= SYNCH_LEVEL);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If not already using chained dispatch handler, set it up</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DispatchInfo.Type != ChainConnect) &#123;</span><br><span class="line">                    KiConnectVectorAndInterruptObject (DispatchInfo.Interrupt, ChainConnect);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Add to tail of chained dispatch</span></span><br><span class="line">                InsertTailList(</span><br><span class="line">                    &amp;DispatchInfo.Interrupt-&gt;InterruptListEntry,</span><br><span class="line">                    &amp;Interrupt-&gt;InterruptListEntry</span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Unlock dispatcher database and lower IRQL to its previous value.</span></span><br><span class="line">        KiUnlockDispatcherDatabase(OldIrql);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// Set system affinity back to the original value.</span></span><br><span class="line">        KeRevertToUserAffinityThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Connected  &amp;&amp;  ConnectError) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DBG</span></span><br><span class="line">        DbgPrint (<span class="string">&quot;HalEnableSystemInterrupt failed\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        KeDisconnectInterrupt (Interrupt);</span><br><span class="line">        Connected = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Return whether interrupt was connected to the specified vector.</span></span><br><span class="line">    <span class="keyword">return</span> Connected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-DPC"><a href="#5-DPC" class="headerlink" title="5 DPC"></a>5 DPC</h2><h2 id="6-时钟中断与定时器"><a href="#6-时钟中断与定时器" class="headerlink" title="6 时钟中断与定时器"></a>6 时钟中断与定时器</h2><h2 id="7-异常分发"><a href="#7-异常分发" class="headerlink" title="7 异常分发"></a>7 异常分发</h2><h2 id="8-线程调度"><a href="#8-线程调度" class="headerlink" title="8 线程调度"></a>8 线程调度</h2><h2 id="9-注册表"><a href="#9-注册表" class="headerlink" title="9 注册表"></a>9 注册表</h2><h2 id="10-文件系统"><a href="#10-文件系统" class="headerlink" title="10 文件系统"></a>10 文件系统</h2><h2 id="11-内核模式回用户模式"><a href="#11-内核模式回用户模式" class="headerlink" title="11 内核模式回用户模式"></a>11 内核模式回用户模式</h2><p>Windows内核原理与实现 8.1.2 P550</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/WinXp-InterruptAndException/" title="Windows XP 中断与异常（段内容补充）">https://directoree.github.io/post/WinXp-InterruptAndException/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/WinXP%E5%86%85%E6%A0%B8/" rel="tag"># WinXP内核</a>
              <a href="/tags/%E4%B8%AD%E6%96%AD%E4%B8%8E%E5%BC%82%E5%B8%B8/" rel="tag"># 中断与异常</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/WinXP-APC2/" rel="prev" title="Windows XP APC（二）">
                  <i class="fa fa-chevron-left"></i> Windows XP APC（二）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/column-1/" rel="next" title="读书笔记">
                  读书笔记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.3m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">19:16</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/WinXp-InterruptAndException/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
