<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="😊">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 编程基础">
<meta property="og:url" content="https://directoree.github.io/post/linux-programming-basics/index.html">
<meta property="og:site_name" content="˗ˋˏ♡ˎˊ˗">
<meta property="og:description" content="😊">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/07/05/bMtxysp4uwWB1en.png">
<meta property="og:image" content="https://s2.loli.net/2023/07/06/OqeAsRZPkVyvLuJ.png">
<meta property="og:image" content="https://s2.loli.net/2023/07/06/cHQL8UNlI6ykahp.png">
<meta property="og:image" content="https://s2.loli.net/2023/07/06/s9tACrzf8SciogT.png">
<meta property="og:image" content="https://s2.loli.net/2023/07/12/XpvPWriklaybC3Q.png">
<meta property="og:image" content="https://i.loli.net/2020/09/14/L45tdmbn1crSwAe.png">
<meta property="og:image" content="https://s2.loli.net/2023/07/07/iPXD4TaIHh6QLle.png">
<meta property="og:image" content="https://s2.loli.net/2023/07/09/2m8HdNbQ4KpwiIM.png">
<meta property="og:image" content="https://s2.loli.net/2023/07/31/Ebqp1VgJtvl37aL.png">
<meta property="article:published_time" content="2023-07-05T15:39:00.000Z">
<meta property="article:modified_time" content="2023-10-25T16:22:29.196Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="x86-64">
<meta property="article:tag" content="Linux 逆向">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/07/05/bMtxysp4uwWB1en.png">


<link rel="canonical" href="https://directoree.github.io/post/linux-programming-basics/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Linux 编程基础 | ˗ˋˏ♡ˎˊ˗</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#222;--content-bg-color:#222;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#2d2f31;--highlight-foreground:#ccc;--highlight-gutter-background:#333;--highlight-gutter-foreground:#888}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#fff;background:#555}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">˗ˋˏ♡ˎˊ˗</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-空调房">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>空调房</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Linx-%E4%B8%8B-C-%E7%A8%8B%E5%BA%8F"><span class="nav-text">1 Linx 下 C 程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-C-%E6%A0%87%E5%87%86"><span class="nav-text">1.1 C 标准</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E7%BC%96%E7%A0%81%E9%A3%8E%E6%A0%BC"><span class="nav-text">1.2 编码风格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%A8%8B%E5%BA%8F%E7%BC%96%E8%AF%91"><span class="nav-text">1.3 程序编译</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%BA%93%E6%96%87%E4%BB%B6"><span class="nav-text">2 库文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E9%9D%99%E6%80%81%E5%BA%93"><span class="nav-text">2.1 静态库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%8A%A8%E6%80%81%E5%BA%93"><span class="nav-text">2.2 动态库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E5%BA%93%E6%96%87%E4%BB%B6%E6%90%9C%E7%B4%A2%E9%A1%BA%E5%BA%8F"><span class="nav-text">2.3 库文件搜索顺序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%8A%A8%E6%80%81%E5%BA%93%E7%89%88%E6%9C%AC%E5%8F%8A%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99"><span class="nav-text">3 动态库版本及命名规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%85%B1%E4%BA%AB%E5%BA%93%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="nav-text">3.1 共享库的兼容性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%85%B1%E4%BA%AB%E5%BA%93%E5%91%BD%E5%90%8D"><span class="nav-text">3.2 共享库命名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-SO-NAME"><span class="nav-text">3.3 SO-NAME</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">4 目标文件常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-ar-%E5%BD%92%E6%A1%A3%E9%9D%99%E6%80%81%E5%BA%93"><span class="nav-text">4.1 ar 归档静态库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-ldd-%E6%9F%A5%E7%9C%8B%E5%8A%A8%E6%80%81%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-text">4.2 ldd 查看动态依赖库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-nm-%E6%9F%A5%E7%9C%8B%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E4%B8%AD%E5%87%BD%E6%95%B0"><span class="nav-text">4.3 nm 查看目标文件中函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-gcc-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">4.4 gcc 常用命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-main-%E5%87%BD%E6%95%B0"><span class="nav-text">5 main 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E8%BE%93%E5%85%A5%E5%8F%82%E6%95%B0"><span class="nav-text">5.1 输入参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-getopt-%E5%87%BD%E6%95%B0"><span class="nav-text">5.2 getopt 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-text">6 错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-errno"><span class="nav-text">6.1 errno</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-strerror-r"><span class="nav-text">6.2 strerror_r</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-perror"><span class="nav-text">6.3 perror</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.gitee.io/" title="Cutecat → https:&#x2F;&#x2F;catecat.gitee.io" rel="noopener" target="_blank"><i class="fas fa-heartbeat fa-fw"></i>Cutecat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.top/" title="Directoree → https:&#x2F;&#x2F;catecat.top" rel="noopener" target="_blank"><i class="fas fa-heart fa-fw"></i>Directoree</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/linux-programming-basics/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="˗ˋˏ♡ˎˊ˗">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux 编程基础
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-07-05 23:39:00" itemprop="dateCreated datePublished" datetime="2023-07-05T23:39:00+08:00">2023-07-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-10-26 00:22:29" itemprop="dateModified" datetime="2023-10-26T00:22:29+08:00">2023-10-26</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux-%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">Linux 逆向</span></a>
        </span>
    </span>

  
    <span id="/post/linux-programming-basics/" class="post-meta-item leancloud_visitors" data-flag-title="Linux 编程基础" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/linux-programming-basics/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/linux-programming-basics/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>23k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>21 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>😊</p>
<span id="more"></span>

<h2 id="1-Linx-下-C-程序"><a href="#1-Linx-下-C-程序" class="headerlink" title="1 Linx 下 C 程序"></a>1 Linx 下 C 程序</h2><h3 id="1-1-C-标准"><a href="#1-1-C-标准" class="headerlink" title="1.1 C 标准"></a>1.1 C 标准</h3><p>在 Linux 操作系统下进行 C 程序开发的标准主要有两个：<mark class="label danger">C</mark> 标准和 <mark class="label success">POSIX</mark> 标准。</p>
<ul>
<li><p><strong>C89、C90</strong>。ANSI（美国国家标准委员会）C语言标准（x3.159-1989）最终于1989 年获批，随之于1990 年被 ISO（国际标准化组织）所采纳（ISO&#x2F;EC 9899：1990）。通常将 C 语言的这一版本称为 <code>C89</code> 或者（不太常见的） <code>C90</code>, Kernighan 和 Ritchie 所著的 <em>The C Programming Language</em> 第 2 版（1988）对其有完整描述。这份标准在定义 C 语言<strong>语法和语义</strong>的同时，还对<strong>标准 C 语言库</strong>操作进行了描述， 这包括 <strong>stdio 函数、字符串处理函数、数学函数、各种头文件</strong>等等。</p>
</li>
<li><p><strong>C99</strong>：1999 年，ISO 又正式批准了对 C 语言标准的修订版。通常将这一标准称为 <code>C99</code>，其中包括了对 C 语言及其标准库的一系列修改，诸如，增加了 <code>long long</code> 和<code>布尔数据类型</code>、C++风格的注释（<code>//</code>）、受限指针以及可变长数组等。自从 ANSI 委员会批准了 C99 修订版之后，确切说来，<strong>现在的 ANSI C 应该是 C99</strong>。</p>
</li>
<li><p>C11（2011）、C18（2018）、C23（2023）。</p>
<blockquote>
<p>C 语言标准独立于任何操作系统，换言之，C 语言并不依附于 UNIX 系统。这也意味着仅仅利用标准（语言库编写而成的 C 语言程序可以移植到支持 C 语言实现的<strong>任何计算机或操作系统</strong>上。</p>
<p>具体的支持情况要看编译器，而在使用上，我们写代码时主要关注的变化是：头文件、数据类型、编码格式等。</p>
<p>具体的变化可参考《<a target="_blank" rel="noopener" href="https://www.axutongxue.top/2022/04/c-primer-plus-6.html">C Primer Plus第6版-中文版</a>》（<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1bo9Gvqn">网盘</a>）、《<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1jImZ1zC">C++ Primer Plus 第6版 中文版</a>》、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/363380373">C语言标准——C89、C99、C11、C17、C2x</a>。</p>
</blockquote>
<p>C89 不仅定义了 C 编程语言的语法和语义，而且还定义了一个标准库。ISO C 标准定义的头文件如表 1-1 所示。</p>
<p><img data-src="https://s2.loli.net/2023/07/05/bMtxysp4uwWB1en.png" alt="10.png"></p>
</li>
<li><p><strong>POSIX 标准</strong>，可移植操作系统 Portable Operating System Interface 的缩写，是 IEEE（电器及电子工程师协会）制定的标准。POSIX.1 和 POSIX.2 分别定义了兼容操作系统的 C 语言系统接口以及工具标准。Posix 是<strong>类 UNIX 系统都遵循的标准</strong>，例如 Ubuntu 下和 RedHat 下没有代码不需要移植可直接编译后执行，而在 Linux下基于 Posix 标准完成的代码就无法在 Windows下直接编译并执行。 表1-2 所示为26 项 POSIX 标准定义的头文件，表1-3 所示为 26 项 POSIX 标准定义的 XSI 扩展头文件，表1-4所示为：项 POSIX 标准定义的可选头文件。</p>
<p><img data-src="https://s2.loli.net/2023/07/06/OqeAsRZPkVyvLuJ.png" alt="11.png"></p>
<p><img data-src="https://s2.loli.net/2023/07/06/cHQL8UNlI6ykahp.png" alt="12.png"></p>
<p><img data-src="https://s2.loli.net/2023/07/06/s9tACrzf8SciogT.png" alt="13.png"></p>
<blockquote>
<p>POSIX.1 版本1996 年诞生，对<strong>实时性和线程进行扩展</strong>。</p>
<p>POSIX.2，对 shell 和包括 C 编译器命令行接口在内的各种 UNIX 工具进行了标准化。</p>
<p>POSIX.1b 实时性扩展包括<strong>文件同步、异步 IO、进程调度、高精度时钟和定时器、采用信号量、共享内存，以及消息队列的进程间通信</strong>。这 3 种进程间通信方法的称谓前通常冠以 <code>POSIX</code>，以示其有别于与之类似而又较为古老的 <code>System V</code> 信号、共享内存以及消息队列。</p>
</blockquote>
</li>
<li><p>X&#x2F;Open 公司和 The Open Group（XPG4、SUSv2）。</p>
<p><code>X/Open</code> 公司是由多家国际计算机厂商所组成的联盟，致力于采纳和改进现有标准，以制 定出一套全面而又一致的开放系统标准。该公司编纂的《X&#x2F;Open 可移植性指南》<strong>是一套基于 POSIX 标准的可移植性指导丛书</strong>，如 XPG3、XPG4 两个版本。</p>
<p>随后 XPG4 v2 版本被升级改造为 SUS（Single UNIX Specification）单一 UNIX 规范。并于 1997 年发布了 SUSv2 规范（也称作 XPG5）。</p>
<p>1996 年，X&#x2F;Open 与开放软件基金会（OSF）合并，成立 The Open Group。</p>
</li>
<li><p><strong>SUSv3 和 POSIX.1-2001</strong>。</p>
<p>由 IEEE、 Open 集团以及 IEC 联合技术委员会共同成立了奥斯丁公共标准修订工作组（CSRG）。该工作组正式批准了 <code>POSIX 1003.1-2001</code>，有时简称为 <code>POSIX.1-2001</code>（后来也称作 SUSv3）。该标准取代了 <code>SUSv2</code>、 <code>POSIX.1</code>、 <code>POSIX.2</code> 以及大批的早期 POSIX 标准。SUSv3 规范了：</p>
<ul>
<li>基本定义（XBD）。包含了定义、术语、概念以及对头文件内容的规范。</li>
<li>系统接口（XSH)。主要包含对各种函数（在特定的 UNIX 实现中，这些函数要么是作为系统调用，要么是作为库函数来实现的）的定义。</li>
<li>Shell 和实用工具（XCU)。明确定义了 shell 和各种 UNIX 命令的行为。</li>
<li>定义了对规范的两级符合度。其中之一是 XSI（X&#x2F;Open 系统接口[X&#x2F;Open System Interfacel]）规范符合度，是 SUSv3 的超集。这些扩展支持以下特性：线程、mmap() 和 munmap()、 dlopen API、资源限制、伪终端、System V IPC、 syslog API、poll() 以及登录记账。后来称“符合 SUSv3 规范”是指“符合 XSI 规范”。</li>
</ul>
</li>
<li><p><strong>SUSV4 和 POSIX.1-2008</strong>。</p>
<p>2008 年，奥斯丁工作组完成了对己合并的 POSIX 和 SUS 规范的修订工作。发布了 SUSv4：</p>
<ul>
<li>SUSv4 为一系列函数添加了新规范。本书将会介绍以下新标准中定义的如下函数：dirfd0、fdopendir()、 fexecve())、 futimens()、 mkdtemp()、 psignal()、 strsignal() 以及 utimensat()。另一组与文件相关的函数，例如：openat()。</li>
<li>SUSv4 废止了 SUSv3 中的某些函数，这包括 asctime()、 ctime()、 fiw()、 gettimeofday()、getitimer()、 setitimer() 以及 siginterrupt()。</li>
<li>SUSv4 对 SUSv3 现有规范的各方面细节进行了修改。例如，对于应满足异步信号安全（async-signal-safe）的函数列表，二者内容就有所不同。</li>
</ul>
</li>
</ul>
<p>从 <code>POSIX.1-2008</code> 开始实现了大一统，如下图（实线表示标准间的直接过渡，虚线则表示标准间有一定的瓜葛，这无非有两种情况：其一，一个标准被并入了另一标准；其二，一个标准依附于另一个标准。）：</p>
<p><img data-src="https://s2.loli.net/2023/07/12/XpvPWriklaybC3Q.png" alt="16.png"></p>
<p>目前新的标准有 <a target="_blank" rel="noopener" href="https://pubs.opengroup.org/onlinepubs/9699919799.2018edition/">POSIX.1-2017</a> 及 <a target="_blank" rel="noopener" href="https://standards.ieee.org/ieee/1003.1/7101/">POSIX.1-202x</a>。</p>
<p>参考资料：</p>
<ul>
<li>《<a target="_blank" rel="noopener" href="https://github.com/stelectronic/doc/tree/master">Linux-UNIX系统编程手册（上册）1.3 标准化</a>》</li>
<li><a target="_blank" rel="noopener" href="https://kolegite.com/EE_library/books_and_lectures/Linux/The_Linux_Programming_Interface.pdf">《The Linux Programming Interface Chapter3 Standardization—英文版》</a></li>
</ul>
<h3 id="1-2-编码风格"><a href="#1-2-编码风格" class="headerlink" title="1.2 编码风格"></a>1.2 编码风格</h3><div class="note danger"><p>一、GNU 编码规范</p>
<ul>
<li>函数开头的左花括号放到最左边，避免把任何其他的左花括号、左括号或者左方括号放到最左边。</li>
<li>尽力避免让两个不同优先级的操作符出现在相同的对齐方式中。</li>
<li>每个程序开头都应该有一段简短的说明其功能的注释。</li>
<li>每个函数都加上注释，以说明函数做了些什么，需要哪些种类的参数，参数可能值的含义以及用途。</li>
<li>不要跨行声明多个变量。在每一行中都以一个新的声明开头。</li>
<li>当在一个 <code>if</code> 语句中嵌套了另一个 <code>if-else</code> 语句时，应用花括号把 <code>if-else</code> 括起来。</li>
<li>要在同一个声明中同时说明结构标识和变量，或者结构标识和类型定义（typedef)。</li>
<li>尽量避免在 <code>if</code> 的条件中进行赋值。</li>
<li>在名字中使用下划线以分隔单词，<strong>尽量使用小写</strong>；在宏或者枚举中通常使用大写常量。</li>
<li>使用一个命令行选项时，给出的变量应该在选项含义的说明之后，而不是选项字符之后。</li>
</ul>
</div>

<div class="note info"><p>二、Linux 内核编码規范</p>
<ul>
<li>缩进采用 <code>tab</code> 制表符。</li>
<li>在 <code>if</code> 或者 <code>for</code> 循环中，将开始的大括号放在一行的最后，而将结束大括号放在本段语句结束行的第一位，函数中的大括号除外。</li>
<li>变量命名尽量使用简短的名字，简写或者单词间采用了 <code>_</code> 隔开，比如 <code>sys_cfg_data</code>。</li>
<li>函数最好短小精悍，一个函数最好只做一件事情，而且函数中的<strong>变量</strong>一般不超过 <code>10</code> 个，大小一般都小于 <code>80</code> 行。</li>
<li>一个模块的注释一般注明了作者、版权、注释说明代码的功能，而不是说明其实现原理，这也和 Linux 的文化有关。</li>
</ul>
</div>



<h3 id="1-3-程序编译"><a href="#1-3-程序编译" class="headerlink" title="1.3 程序编译"></a>1.3 程序编译</h3><blockquote>
<p>Linux 应用程序表现为两种特殊类型的文件：<strong>可执行文件</strong>和<strong>脚本文件</strong>。</p>
<ul>
<li>可执行文件：可以直接运行的 ELF 文件，类似于Windows 下的 <code>.exe</code> 可执行文件。</li>
<li>脚本文件：是一组指令的集合，这些指令将由另一个程序（即解释器）来执行。它们相当于 Windows 中的 <code>.bat</code> 文件，<code>.cmd</code> 文件或解释执行的 <code>BASIC</code> 程序。登录 Linux 系统后，交互的 shell 界面就是 bash 程序。</li>
</ul>
<p><strong>Linux 并不要求可执行文件或脚本文件具有特殊的文件名或扩展名</strong>。文件系统属性用来指明一个文件是否为可执行的程序。</p>
</blockquote>
<p>C 语言程序编译成一个可执行程序一般要经过以下 4 个步骤（GCC&#x2F;G++ 是 GNU 中C 和 C++ 的编译器）：</p>
<table>
<thead>
<tr>
<th>过程</th>
<th>解释</th>
<th>GCC&#x2F;G++ 参数</th>
<th>文件后缀</th>
</tr>
</thead>
<tbody><tr>
<td>预处理（Preprocessing）</td>
<td>对源代码文件中的文件包含 <code>include</code>、宏定义、预编译语句进行分析和替换。<br />会将头文件所有代码在 <code>#include</code> 处展开。</td>
<td><code>-E</code></td>
<td>C：<code>.i</code><br />C++：<code>.ii</code></td>
</tr>
<tr>
<td>编译（Compilation）</td>
<td>将高级语言编译为汇编语言的文件。</td>
<td><code>-s</code></td>
<td><code>.s</code>、<code>.S</code></td>
</tr>
<tr>
<td>汇编（Assembly）</td>
<td>将汇编语言的文件汇编为二进制目标文件。</td>
<td><code>-c</code></td>
<td><code>.o</code></td>
</tr>
<tr>
<td>链接（Linking）</td>
<td>将静态库、目标文件等链接成可执行程序。</td>
<td><code>-o</code></td>
<td>NULL</td>
</tr>
</tbody></table>
<p><img data-src="https://i.loli.net/2020/09/14/L45tdmbn1crSwAe.png" alt="编译过程"></p>
<p><img data-src="https://s2.loli.net/2023/07/07/iPXD4TaIHh6QLle.png" alt="14.png"></p>
<p>具体文件命名可以通过 <code>GCC</code> 帮助文件查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="meta"># man gcc</span></span><br><span class="line">文件 (FILE)</span><br><span class="line">       file.c             C 源文件</span><br><span class="line">       file.h             C 头文件 (预处理文件)</span><br><span class="line">       file.i             预处理后 的 C 源文件</span><br><span class="line">       file.C             C++ 源文件</span><br><span class="line">       file.cc            C++ 源文件</span><br><span class="line">       file.cxx           C++ 源文件</span><br><span class="line">       file.m             Objective-C 源文件</span><br><span class="line">       file.s             汇编语言文件</span><br><span class="line">       file.o             目标文件</span><br><span class="line">       a.out              连接的输出文件</span><br><span class="line">       TMPDIR/cc∗         临时文件</span><br><span class="line">       LIBDIR/cpp         预处理器</span><br><span class="line">       LIBDIR/cc1         C 编译器</span><br><span class="line">       LIBDIR/cc1plus     C++ 编译器</span><br><span class="line">       LIBDIR/collect     某些机器需要的连接器前端(front end)程序</span><br><span class="line">       LIBDIR/libgcc.a    GCC 子例程 (subroutine) 库</span><br><span class="line">       /lib/crt[<span class="number">01</span>n].o    启动例程 (start-up)</span><br><span class="line">       LIBDIR/ccrt0       C++ 的附加启动例程</span><br><span class="line">       /lib/libc.a        标准 C 库, 另见 intro (<span class="number">3</span>)</span><br><span class="line">       /usr/include       <span class="meta">#<span class="meta-keyword">include</span> 文件的标准目录</span></span><br><span class="line">       LIBDIR/include     <span class="meta">#<span class="meta-keyword">include</span> 文件的标准 gcc 目录</span></span><br><span class="line">       LIBDIR/g++-include <span class="meta">#<span class="meta-keyword">include</span> 文件的附加 g++ 目录</span></span><br><span class="line"></span><br><span class="line">       LIBDIR 通常为 /usr/local/lib/machine/version.</span><br><span class="line">       TMPDIR 来自 环境变量 TMPDIR (如果 存在, 缺省为 /usr/tmp , 否则为 /tmp).</span><br><span class="line"></span><br><span class="line">  其他后缀名的文件被传递给连接器(linker). 通常包括:</span><br><span class="line"></span><br><span class="line">  .o    目标文件 (Object file)</span><br><span class="line">  .a    归档库文件 (Archive file)</span><br></pre></td></tr></table></figure>

<p>使用一步编译链接生成可执行文件示例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 program]<span class="meta"># vim test.c</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># cat test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span>* <span class="built_in">string</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">string</span> = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="built_in">string</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 program]<span class="meta"># gcc test.c -o test.exe</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># ls</span></span><br><span class="line">test.c  test.exe</span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># hexdump -n 16 -C test.exe </span></span><br><span class="line"><span class="number">00000000</span>  <span class="number">7f</span> <span class="number">45</span> <span class="number">4</span>c <span class="number">46</span> <span class="number">02</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.ELF............|</span><br><span class="line"><span class="number">00000010</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 program]# ./test.exe </span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>

<p>分步骤示例如下：</p>
<ol>
<li><p>预处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 program]<span class="meta"># gcc -E test.c -o test.i</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># ls</span></span><br><span class="line">test.c  test.i</span><br></pre></td></tr></table></figure>

<p>此时若是使用 <code>cat</code> 查看 <code>test.i</code> 文件内容，会发现 <code>#include &lt;stdio.h&gt;</code> 被替换为该头文件的内容。</p>
</li>
<li><p>编译（将高级语言转换为汇编语言）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 program]<span class="meta"># gcc -s test.c -o test.s</span></span><br><span class="line"></span><br><span class="line">[root@centos7 program]<span class="meta"># ls</span></span><br><span class="line">test.c  test.i  test.s</span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># hexdump -n 16 -C test.s</span></span><br><span class="line"><span class="number">00000000</span>  <span class="number">7f</span> <span class="number">45</span> <span class="number">4</span>c <span class="number">46</span> <span class="number">02</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.ELF............|</span><br><span class="line"><span class="number">00000010</span></span><br></pre></td></tr></table></figure>

<p>可以看到此时 <code>test.s</code> 文件格式已经是目标文件了。</p>
</li>
<li><p>汇编（将汇编语言转换为机器语言）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 program]<span class="meta"># gcc -c test.c -o test.o</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># ls</span></span><br><span class="line">test.c  test.i  test.o  test.s</span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># hexdump -n 16 -C test.o</span></span><br><span class="line"><span class="number">00000000</span>  <span class="number">7f</span> <span class="number">45</span> <span class="number">4</span>c <span class="number">46</span> <span class="number">02</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |.ELF............|</span><br><span class="line"><span class="number">00000010</span></span><br></pre></td></tr></table></figure>

<p>此时的 <code>test.o</code> 也是目标文件。</p>
</li>
<li><p>链接（生成可执行文件）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 program]<span class="meta"># gcc test.c -o test.exe</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 program]<span class="meta"># ls</span></span><br><span class="line">test.c  test.exe  test.i  test.o  test.s</span><br><span class="line"></span><br><span class="line">[root@centos7 program]# ./test.exe </span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure></li>
</ol>
<p>参考：</p>
<ul>
<li>Linux 程序设计（第4版）</li>
<li>Linux 高级程序设计中文第三版</li>
<li>Linux环境编程：从应用到内核</li>
</ul>
<h2 id="2-库文件"><a href="#2-库文件" class="headerlink" title="2 库文件"></a>2 库文件</h2><p>库文件包括静态库和动态库（共享库，动态链接库），<mark class="label primary">库文件也是目标文件</mark> 。标准的<strong>系统库文件</strong>一般存储在 <code>/lib</code>、<code>/usr/lib</code> 目录中。<br>库文件必须严格遵守命名规范：</p>
<ul>
<li>必须以 <code>lib</code> 开头。<code>.a</code> 表示静态库，<code>.so</code> 表示动态库。</li>
<li><code>libxxx.a</code>，表示静态库文件。<code>xxx</code> 为库文件名称，文件以 <code>.a</code> 结尾。</li>
<li><code>libxxx.so.major.minor</code> ，表示动态库文件。<code>xxx</code> 为库文件名称，<code>major</code> 表示主版本号，<code>minjor</code> 表示副（次）版本号。</li>
</ul>
<p>在编译生成目标文件时，可以使用：</p>
<ul>
<li><code>-L</code> ，指定库文件所在的绝对路径，参数 <code>-L</code> 和绝对路径之间没有空格。</li>
<li><code>-l</code>，指定库文件的名称，即上述的 <code>xxx</code>，是 <code>lib</code> 和 <code>.a/.so</code> 中间的部分，参数 <code>-l</code> 和库名称之间没有空格。</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o test.exe -L/usr/lib64 test.c -lc_nonshared</span><br></pre></td></tr></table></figure>

<p>这条命令使用 <code>/usr/lib64</code> 目录下 <code>c_nonshared</code> 库文件来编译和链接生成 <code>test.exe</code> 程序。但是从这条命令上区分不出是静态库还是动态库。</p>
<h3 id="2-1-静态库"><a href="#2-1-静态库" class="headerlink" title="2.1 静态库"></a>2.1 静态库</h3><p>静态库，也称作归档文件（archive），文件名以 <code>.a</code> 结尾。<strong>注意</strong>：静态库是由一个或多个目标文件归档生成的，使用 <code>ar</code> 命令。</p>
<div class="note success"><p>组成静态库的文件是<mark class="label warning">目标文件</mark>，所以需要使用 <code>gcc -c</code> 参数来生成目标文件。</p>
</div>

<p><strong>说明</strong>：程序链接时需要将静态库一起链接到可执行文件中，这样的可执行程序可能会很大。</p>
<p>制作静态库示例：在 <code>/home/program/staticlib</code> 文件夹中有如下 4 个文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># ls</span></span><br><span class="line">addfun.c  head.h  main.c  subfun.c</span><br><span class="line">  </span><br><span class="line"><span class="comment">// main.c</span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># cat main.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;head.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> addresult, subresult;</span><br><span class="line"></span><br><span class="line">	addresult = addfunction(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">	subresult = subfunction(<span class="number">9</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;addresult = %d, subresult = %d\n&quot;</span>, addresult, subresult);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// head.h </span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># cat head.h </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addfunction</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">subfunction</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// addfun.c </span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># cat addfun.c </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addfunction</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;a + b = %d\n&quot;</span>, a+b);</span><br><span class="line">	<span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// subfun.c </span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># cat subfun.c </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">subfunction</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;a - b = %d\n&quot;</span>, a-b);</span><br><span class="line">	<span class="keyword">return</span> a-b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>将  <code>addfunction</code>、<code>subfunction</code> 函数所在文件编译为目标文件。使用 <code>gcc -c</code> 参数，而不能直接链接为一个可执行程序，这是因为文件中没有 <code>main</code> 函数，会报错。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># gcc -c addfun.c  subfun.c </span></span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.o</span></span><br><span class="line">addfun.o  subfun.o</span><br></pre></td></tr></table></figure>


</li>
<li><p>在不使用静态库的情况下链接生成可执行文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成 main.o 目标文件</span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># gcc -c main.c </span></span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.o</span></span><br><span class="line">addfun.o  main.o  subfun.o</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将目标文件链接为可执行程序 main.exe</span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># gcc -o main.exe addfun.o subfun.o main.o</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.exe</span></span><br><span class="line">main.exe</span><br><span class="line"></span><br><span class="line">[root@centos7 staticlib]# ./main.exe </span><br><span class="line">a + b = <span class="number">7</span></span><br><span class="line">a - b = <span class="number">8</span></span><br><span class="line">addresult = <span class="number">7</span>, subresult = <span class="number">8</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>使用静态库链接生成可执行文件。</p>
<ul>
<li><p>制作静态库（静态库是归档文件，使用 <code>ar</code> 命令）。将 <code>addfun.o</code>、<code>subfun.o</code> 制作静态库。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># ar -crv libaddsub.a addfun.o subfun.o</span></span><br><span class="line">a - addfun.o</span><br><span class="line">a - subfun.o</span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.a</span></span><br><span class="line">libaddsub.a</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 查看静态库包含的文件，使用 -t 参数</span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ar -t libaddsub.a </span></span><br><span class="line">addfun.o</span><br><span class="line">subfun.o</span><br></pre></td></tr></table></figure>

<p>在某些系统，尤其是从 Berkeley UNIX 衍生的系统中，要想成功地使用静态库，你还需要为静态库生成一个<strong>符号表</strong>，可以使用 <code>ranlib xxx.a</code> 命令或者 <code>ar -s</code> 参数。在 Linux 中，当你使用的是 GNU 的软件开发工具时，这一步骤并不是必需的（但做了也无妨）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># ranlib libaddsub.a</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>编译 <code>main.c</code> 并链接静态库，生成可执行程序。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># gcc main.c -L. -laddsub -o main.exec</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.exec</span></span><br><span class="line">main.exec</span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]# ./main.exec</span><br><span class="line">a + b = <span class="number">7</span></span><br><span class="line">a - b = <span class="number">8</span></span><br><span class="line">addresult = <span class="number">7</span>, subresult = <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>这里用：</p>
<p><code>-L</code> ，指定库文件所在的绝对路径，参数 <code>-L</code> 和绝对路径之间没有空格。</p>
<p><code>-l</code>，指定库文件的名称，是 <code>lib</code> 和 <code>.a/.so</code> 中间的部分，参数 <code>-l</code> 和库名称之间没有空格。</p>
</li>
</ul>
</li>
</ol>
<h3 id="2-2-动态库"><a href="#2-2-动态库" class="headerlink" title="2.2 动态库"></a>2.2 动态库</h3><p>静态库在程序链接时会全部链接进去，只要链接了该静态库的可执行程序运行时，每个进程中静态库的代码都会占用到大量的内存空间。所以应该尽量使用动态库，需要使用库的时候动态加载，物理内存中只保留一份动态库的内容，所有进程都可以映射这块物理内存到自己的进程空间中。</p>
<div class="note success"><p>动态库命名格式：<code>libxxx.so.major.minor</code> ，<code>xxx</code> 为库文件名称，<code>major</code> 表示主版本号，<code>minjor</code> 表示副（次）版本号。动态库也是<mark class="label danger">目标文件</mark>。</p>
<p>GCC 编译时使用参数：</p>
<ul>
<li><code>-shared</code>：表示要生成文件为动态链接库文件。</li>
<li><code>-fPIC</code> 或  <code>fpic</code>：开启动态链接库的基址重定位。</li>
</ul>
</div>

<ol>
<li><p>将源文件编译为动态库。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># gcc -fPIC -shared addfun.c subfun.c -o libmathas.so</span></span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.so</span></span><br><span class="line">libmathas.so</span><br></pre></td></tr></table></figure>


</li>
<li><p>链接生成可执行文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># gcc main.c -L. -lmathas -o main.exeas</span></span><br><span class="line"> </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.exeas</span></span><br><span class="line">main.exeas</span><br></pre></td></tr></table></figure>

<p>此时执行该可执行程序，运行失败：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]# ./main.exeas </span><br><span class="line">./main.exeas: error <span class="keyword">while</span> loading shared libraries: libmathas.so: cannot open shared object file: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>

<p>查看该程序的依赖库：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># ldd main.exeas </span></span><br><span class="line">	linux-vdso.so<span class="number">.1</span> =&gt;  (<span class="number">0x00007ffca19f4000</span>)</span><br><span class="line">	libmathas.so =&gt; <span class="keyword">not</span> found</span><br><span class="line">	libc.so<span class="number">.6</span> =&gt; /lib64/libc.so<span class="number">.6</span> (<span class="number">0x00007eff7c6ff000</span>)</span><br><span class="line">	/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007eff7cacd000</span>)</span><br></pre></td></tr></table></figure>

<p>发现 <code>    libmathas.so</code> 并没有找到。</p>
<p>可以知道可执行程序执行过程中，动态库的搜索方式和静态库是不同的，后面会总结。</p>
</li>
<li><p>配置动态库。</p>
<p>有常用三种方式可以进行配置：</p>
<ul>
<li>1，在环境变量 <code>LD_LIBRARY_PATH</code> 指定动态库搜索路径中添加动态库路径。</li>
<li>2，修改动态库搜索路径配置文件 <code>/etc/ld.so.conf</code>。</li>
<li>3，将动态库拷贝至动态库搜索路径 <code>/lib, /usr/lib</code>。</li>
</ul>
<p>本例使用<strong>方法 2</strong>，关于环境变量的配置后面学了再弄。</p>
<p>查看 <code>/etc/ld.so.conf</code> 文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># cat /etc/ld.so.conf</span></span><br><span class="line">include ld.so.conf.d<span class="comment">/*.conf</span></span><br></pre></td></tr></table></figure>

<p>可以看到，搜索路径在 <code>ld.so.conf.d/*.conf</code> 配置文件中指定的路径。此时只需要在后面添加当前动态链接库的路径即可：修改文件之后，一定要使用 <code>ldconfig</code> 刷新 <code>ld</code> 链接器共享库的缓存列表 <code>/etc/ld.so.cache</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># pwd</span></span><br><span class="line">/home/program/staticlib</span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># cat /etc/ld.so.conf</span></span><br><span class="line">include ld.so.conf.d<span class="comment">/*.conf</span></span><br><span class="line"><span class="comment">/home/program/staticlib</span></span><br></pre></td></tr></table></figure>

<p>执行程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]# ./main.exeas </span><br><span class="line">a + b = <span class="number">7</span></span><br><span class="line">a - b = <span class="number">8</span></span><br><span class="line">addresult = <span class="number">7</span>, subresult = <span class="number">8</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="2-3-库文件搜索顺序"><a href="#2-3-库文件搜索顺序" class="headerlink" title="2.3 库文件搜索顺序"></a>2.3 库文件搜索顺序</h3><p>在可执行文件生成时，我们使用了 <code>-L</code> 参数来指定库文件所在的路径。而库名通过 <code>-l</code> 参数指定。如果有 <code>libtest.a</code> 和 <code>libtest.so</code> 两个库。我们链接时的命令如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -L. -ltest -o main</span><br></pre></td></tr></table></figure>

<p>在有相同名称的动态库和静态库时，GCC&#x2F;G++ 的链接程序，<strong>默认链接动态库，如果没有则会找静态库</strong>。如果指定<strong>只链接静态库</strong>，则需要使用参数 <code>-static</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -L. -ltest -<span class="keyword">static</span> -o main</span><br></pre></td></tr></table></figure>

<div class="note warning"><p>（1）<strong>静态库链接时，搜索路径的顺序：</strong></p>
<ol>
<li><code>ld</code> 会去找 <code>gcc/g++</code> 命令中的参数 <code>-L</code> 指定的路径。</li>
<li>再找 <code>gcc</code> 的环境变量 <code>LIBRARY_PATH</code>，它指定程序静态链接库文件搜索路径。</li>
<li>最后找默认库目录 <code>/lib/usr/lib</code>、<code> /usr/local/lib</code>。</li>
</ol>
<p>（2）<strong>动态链接时，搜索路径顺序：</strong></p>
<ol>
<li>首先在环境变量 <code>LD_LIBRARY_PATH</code> 所记录的路径中查找。</li>
<li>然后从缓存文件 <code>/etc/ld.so.cache</code> 中查找。这个缓存文件由 <code>ldconfig</code> 命令读取配置文件 <code>/etc/ld.so.conf</code> 之后生成。</li>
<li>如果上述步骤都找不到，则到默认的系统路径中查找，先是 <code>/usr/lib</code> 然后是 <code>/lib</code>。</li>
</ol>
</div>





<h2 id="3-动态库版本及命名规则"><a href="#3-动态库版本及命名规则" class="headerlink" title="3 动态库版本及命名规则"></a>3 动态库版本及命名规则</h2><p>本章节内容参考《程序员的自我修养–链接、装载与库 Chapter 8》。</p>
<h3 id="3-1-共享库的兼容性"><a href="#3-1-共享库的兼容性" class="headerlink" title="3.1 共享库的兼容性"></a>3.1 共享库的兼容性</h3><p>在介绍共享库的命名规则前，先说明下<strong>共享库的兼容性</strong>。</p>
<p>共享库的更新分为：</p>
<ul>
<li>兼容性更新：原有接口保持不变</li>
<li>非兼容性更新：共享库更新了原来的接口，使用该共享库原有的接口可能不能正常运行或运行不正常。</li>
</ul>
<p>这里所说的接口是二进制接口 ABI（Application binary interface），共享库的 ABI 跟程序语言有关很大的关心，导致 C 语言共享库 ABI 改变的4 种主要行为：</p>
<ol>
<li>导出函数的行为发生改变，调用这个函数产生的结果和以前不一样。</li>
<li>导出函数被删除。</li>
<li>导出的数据结构发生变化，如成员顺序、类型改变，成员被删除等。不过，通常在结构末尾新增成员并不会导致不兼容。</li>
<li>导出函数接口发生变化，如参数类型、个数、顺序，返回值类型等。</li>
</ol>
<p>C++ 开发的共享库，问题会更多，一般不建议使用 C++ 开发共享库，如果非要使用 C++ 开发共享库，需要注意一下事项，以防止 ABI 不兼容：</p>
<ol>
<li>不要在接口类中使用虚函数，万不得已要使用虚函数时，不要随意删除、添加或在子类中添加新的实现函数，这种会导致类的虚函数表结构发生变化；</li>
<li>不要改变类中任何成员变量的位置和类型；</li>
<li>不要删除非内嵌的public或protected成员函数；</li>
<li>不要将非内嵌的成员函数改变成内嵌成员函数；</li>
<li>不要改变成员函数的访问权限；</li>
<li>不要在接口中使用模板；</li>
<li>最重要的是，不要改变接口的任何部分或干脆不要使用C++作为共享库接口。</li>
</ol>
<h3 id="3-2-共享库命名"><a href="#3-2-共享库命名" class="headerlink" title="3.2 共享库命名"></a>3.2 共享库命名</h3><p>有几种办法可用于解决共享库的兼容性问题，有效办法之一就是使用共享库版本的方法。Linux有一套规则来命名系统中的每一个共享库，它规定共享库的文件名规则必须如下：</p>
<div class="note success"><p>$$libname.so.x.y.z$$</p>
<ul>
<li><code>lib</code>：前缀；</li>
<li><code>.so</code>：库的名字；</li>
<li><code>x.y.z</code>：版本号。<ul>
<li><code>x</code>：主版本号（Major Version Number）</li>
<li><code>y</code>：次版本号（Minor Version Number）</li>
<li><code>z</code>：发布版本号（Release Version Number）</li>
</ul>
</li>
</ul>
<p>1、主版本号表示库的重大升级，<strong>不同主版本号的库之间是不兼容的</strong>，依赖于旧的主版本号的程序需要改动相应的部分，并且重新编译，才可以在新版的共享库中运行；或者系统必须保留旧版的共享库，使得那些依赖于旧版共享库的程序能够正常运行。</p>
<p>2、次版本号表示库的增量升级，即增加一些新的接口符号，且保持原来的符号不变。<strong>在主版本号相同的情况下，高的次版本号的库向后兼容低的次版本号的库</strong>。一个依赖于旧的次版本号共享库的程序，可以在新的次版本号共享库中运行，因为新版中保留了原来所有的接口，并且不改变它们的定义和含义。</p>
<p>3、发布版本号表示库的一些错误的修正、性能的改进等，并不添加任何新的接口，也不对接口进行更改。<mark class="label danger">相同主版本号、次版本号的共享库，不同的发布版本号之间完全兼容</mark>，<strong>依赖于某个发布版本号的程序可以在任何一个其它发布版本号中正常运行，而无需做任何修改</strong>。当然现在Linux中也存在不少不遵循上述规定的“顽固分子”，比如最基本的C语言库 <code>Glibc</code> 就不使用这种规则，它的 C 语言共享库使用 <code>libc-x.y.z.so</code> 的命名方式。</p>
<p><mark class="label info">共享库主版本号和次版本号决定了一个共享库的接口</mark>。</p>
</div>



<h3 id="3-3-SO-NAME"><a href="#3-3-SO-NAME" class="headerlink" title="3.3 SO-NAME"></a>3.3 SO-NAME</h3><div class="note primary"><ol>
<li>定义：<ul>
<li>每个共享库都有一个对应的 “SO-NAME”，这个 SO-NAME 即共享库的文件名去掉次版本号和发布版本号，保留主版本号，体现在<code>.dynamic</code> 节的 <code>DT_SONAME</code> 字段中。</li>
<li>系统会在共享库所在的目录中，建立一个和 SO-NAME 同名的软链接，该软链接指向该目录下最新版本的共享库。比如有 <code>lib64/libfoo.so.2.6.1</code> 和 <code>lib64/libfoo.so.2.5.3</code>，则 Linux 会在 <code>lib64</code> 目录下创建 <code>lib64/libfoo.so.2</code> 的软链接并指向 <code>lib64/libfoo.so.2.6.1</code> 文件。</li>
</ul>
</li>
<li>作用：简化共享库版本信息，方便版本升级后动态链接。</li>
<li>用途：用于 <code>.dynamic</code> 节的 <code>DT_NEEDED</code>、<code>DT_SONAME</code> 两个字段。</li>
<li>原理：由于不同主版本号之问的共享库是完全不兼容的，较高的次版本号的共享库兼容较低的次版本号的共享库。</li>
<li>说明：SO-NAME 并不等同于 <code>DT_SONAME</code>，他是共享库版本的简化，应用在 <code>DT_SONAME</code>、<code>DT_NEEDED</code> 等字段中。</li>
</ol>
</div>

<p>举例说明：A 文件依赖于 B 文件，如果 A 文件的 <code>DT_NEEDED</code> 记录值是 <code>libfoo.so.2.6.1</code>，当该文件版本升级至 <code>libfoo.so.2.7.2</code> 后，为了节约空间原目录下已经不存在旧版本共享库，且“<strong>由于不同主版本号之问的共享库是完全不兼容的，较高的次版本号的共享库兼容较低的次版本号的共享库</strong>”，导致 A 文件无法链接到 B 文件。解决方法：如果将共享库的 SO-NAME 名 <code>libfoo.so.2</code> 写到共享库的 <code>DT_NEEDED</code>，因为每次更新共享库时系统都会更新 SO-NAME 软链接指向的最新版本共享库。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@centos<span class="number">-7</span> program]<span class="meta"># readelf -d /usr/lib64/libplist.so.3.0.0 </span></span><br><span class="line"></span><br><span class="line">Dynamic section at offset <span class="number">0x9de8</span> contains <span class="number">26</span> entries:</span><br><span class="line">  标记        类型                         名称/值</span><br><span class="line"> <span class="number">0x0000000000000001</span> (NEEDED)             共享库：[libxml2.so<span class="number">.2</span>]	<span class="comment">// 使用到目标文件的 SO-NAME</span></span><br><span class="line"> <span class="number">0x0000000000000001</span> (NEEDED)             共享库：[libc.so<span class="number">.6</span>]	<span class="comment">// 使用到目标文件的 SO-NAME</span></span><br><span class="line"> <span class="number">0x000000000000000e</span> (SONAME)             Library soname: [libplist.so<span class="number">.3</span>]	<span class="comment">// SO-NAME</span></span><br><span class="line"> <span class="number">0x000000000000000c</span> (INIT)               <span class="number">0x1ac0</span></span><br><span class="line"> <span class="number">0x000000000000000d</span> (FINI)               <span class="number">0x7658</span></span><br><span class="line"> <span class="number">0x0000000000000019</span> (INIT_ARRAY)         <span class="number">0x209dc8</span></span><br><span class="line"> <span class="number">0x000000000000001b</span> (INIT_ARRAYSZ)       <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x000000000000001a</span> (FINI_ARRAY)         <span class="number">0x209dd0</span></span><br><span class="line"> <span class="number">0x000000000000001c</span> (FINI_ARRAYSZ)       <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x000000006ffffef5</span> (GNU_HASH)           <span class="number">0x1f0</span></span><br><span class="line"> <span class="number">0x0000000000000005</span> (STRTAB)             <span class="number">0xd48</span></span><br><span class="line"> <span class="number">0x0000000000000006</span> (SYMTAB)             <span class="number">0x3b8</span></span><br><span class="line"> <span class="number">0x000000000000000a</span> (STRSZ)              <span class="number">1623</span> (bytes)</span><br><span class="line"> <span class="number">0x000000000000000b</span> (SYMENT)             <span class="number">24</span> (bytes)</span><br><span class="line"> <span class="number">0x0000000000000003</span> (PLTGOT)             <span class="number">0x20a000</span></span><br><span class="line"> <span class="number">0x0000000000000002</span> (PLTRELSZ)           <span class="number">1248</span> (bytes)</span><br><span class="line"> <span class="number">0x0000000000000014</span> (PLTREL)             RELA</span><br><span class="line"> <span class="number">0x0000000000000017</span> (JMPREL)             <span class="number">0x15e0</span></span><br><span class="line"> <span class="number">0x0000000000000007</span> (RELA)               <span class="number">0x14f0</span></span><br><span class="line"> <span class="number">0x0000000000000008</span> (RELASZ)             <span class="number">240</span> (bytes)</span><br><span class="line"> <span class="number">0x0000000000000009</span> (RELAENT)            <span class="number">24</span> (bytes)</span><br><span class="line"> <span class="number">0x000000006ffffffe</span> (VERNEED)            <span class="number">0x1470</span></span><br><span class="line"> <span class="number">0x000000006fffffff</span> (VERNEEDNUM)         <span class="number">2</span></span><br><span class="line"> <span class="number">0x000000006ffffff0</span> (VERSYM)             <span class="number">0x13a0</span></span><br><span class="line"> <span class="number">0x000000006ffffff9</span> (RELACOUNT)          <span class="number">3</span></span><br><span class="line"> <span class="number">0x0000000000000000</span> (<span class="literal">NULL</span>)               <span class="number">0x0</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// 查看和 SO-NAME 同名的软链接</span></span><br><span class="line">[root@centos<span class="number">-7</span> program]<span class="meta"># ll /usr/lib64/libxml2.so.2</span></span><br><span class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">16</span> <span class="number">6</span>月  <span class="number">26</span> <span class="number">21</span>:<span class="number">16</span> /usr/lib64/libxml2.so<span class="number">.2</span> -&gt; libxml2.so<span class="number">.2</span><span class="number">.9</span><span class="number">.1</span></span><br><span class="line">  </span><br><span class="line">[root@centos<span class="number">-7</span> program]<span class="meta"># ll /usr/lib64/libc.so.6 </span></span><br><span class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">12</span> <span class="number">6</span>月  <span class="number">26</span> <span class="number">21</span>:<span class="number">16</span> /usr/lib64/libc.so<span class="number">.6</span> -&gt; libc<span class="number">-2.17</span>.so</span><br></pre></td></tr></table></figure>







<h2 id="4-目标文件常用命令"><a href="#4-目标文件常用命令" class="headerlink" title="4 目标文件常用命令"></a>4 目标文件常用命令</h2><h3 id="4-1-ar-归档静态库"><a href="#4-1-ar-归档静态库" class="headerlink" title="4.1 ar 归档静态库"></a>4.1 ar 归档静态库</h3><p>静态库，也称作归档文件（archive)，由一个或多个目标文件归档而成，按惯例它们的文件名都以 <code>.a</code> 结尾，使用 <code>ar</code> 命令来进行归档。</p>
<p><code>ar</code> 命令用于建立或修改档案文件，或是从档案文件中抽取文件。</p>
<p>语法（常用的参数是 <code>crv</code>）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ar [-dmpqrtx][cfosSuvV][a&lt;成员文件&gt;][b&lt;成员文件&gt;][i&lt;成员文件&gt;][备存文件][成员文件]</span><br></pre></td></tr></table></figure>

<p><img data-src="https://s2.loli.net/2023/07/09/2m8HdNbQ4KpwiIM.png" alt="15.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># ar -crsv libaddsub.a addfun.o subfun.o</span></span><br><span class="line">a - addfun.o</span><br><span class="line">a - subfun.o</span><br><span class="line">  </span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ls *.a</span></span><br><span class="line">libaddsub.a</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 查看静态库包含的文件，使用 -t 参数</span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ar -t libaddsub.a </span></span><br><span class="line">addfun.o</span><br><span class="line">subfun.o</span><br></pre></td></tr></table></figure>





<h3 id="4-2-ldd-查看动态依赖库"><a href="#4-2-ldd-查看动态依赖库" class="headerlink" title="4.2 ldd 查看动态依赖库"></a>4.2 ldd 查看动态依赖库</h3><p><code>ldd</code> 显示可执行程序、动态库的依赖情况。</p>
<p>选项 (OPTIONS)</p>
<ul>
<li>-v     显示 ldd 的版本号.</li>
<li>-V     显示动态连接器 ld.so 的版本号.</li>
<li>-d     进行重定位(relocation), 而且报告缺少的函数(仅限于 ELF).</li>
<li>-r     对数据目标 (data object) 和函数进行重定位, 而且报告缺少的数据目标 (仅限于 ELF).</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看动态库依赖情况</span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ldd libmathas.so </span></span><br><span class="line">	linux-vdso.so<span class="number">.1</span> =&gt;  (<span class="number">0x00007ffd73781000</span>)</span><br><span class="line">	libc.so<span class="number">.6</span> =&gt; /lib64/libc.so<span class="number">.6</span> (<span class="number">0x00007fcc55027000</span>)</span><br><span class="line">	/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007fcc555f7000</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 查看可执行文件的依赖情况</span></span><br><span class="line">[root@centos7 staticlib]<span class="meta"># ldd main.exeas</span></span><br><span class="line">	linux-vdso.so<span class="number">.1</span> =&gt;  (<span class="number">0x00007fff3b23a000</span>)</span><br><span class="line">	libmathas.so =&gt; <span class="keyword">not</span> found</span><br><span class="line">	libc.so<span class="number">.6</span> =&gt; /lib64/libc.so<span class="number">.6</span> (<span class="number">0x00007fc62a99d000</span>)</span><br><span class="line">	/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007fc62ad6b000</span>)</span><br></pre></td></tr></table></figure>





<h3 id="4-3-nm-查看目标文件中函数"><a href="#4-3-nm-查看目标文件中函数" class="headerlink" title="4.3 nm 查看目标文件中函数"></a>4.3 nm 查看目标文件中函数</h3><p><code>nm</code> 是 <code>name</code> 的缩写，用来分析二进制文件、库文件、可执行文件中的<strong>符号表</strong>。</p>
<p>参数不常用，此处不在罗列，但是输出符号中关于函数的需要特别说明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 staticlib]<span class="meta"># nm main.exe</span></span><br><span class="line"><span class="number">000000000040052</span>d T addfunction</span><br><span class="line"><span class="number">0000000000601034</span> B __bss_start</span><br><span class="line">                 U __libc_start_main@@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">0000000000400593</span> T main</span><br><span class="line">                 U <span class="built_in">printf</span>@@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">0000000000400440</span> T _start</span><br><span class="line"><span class="number">000000000040055</span>e T subfunction</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>T</code>：该符号在代码段，也表示<strong>在当前文件中定义</strong>的函数。</li>
<li><code>U</code>：在当前文件中调用的函数，但<strong>不是在当前文件中定义</strong>的函数。</li>
</ul>
<table>
<thead>
<tr>
<th>符号类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>A</td>
<td>该符号的值是绝对的，在以后的链接过程中，不允许进行改变。这样的符号值，常常出现在中断向量表中，例如用符号来表示各个中断向量函数在中断向量表中的位置。</td>
</tr>
<tr>
<td>B</td>
<td>该符号的值出现在非初始化数据段(bss)中。例如，在一个文件中定义全局static int test。则该符号test的类型为b，位于bss section中。其值表示该符号在bss段中的偏移。一般而言，bss段分配于RAM中。</td>
</tr>
<tr>
<td>C</td>
<td>该符号为common。common symbol是未初始话数据段。该符号没有包含于一个普通section中。只有在链接过程中才进行分配。符号的值表示该符号需要的字节数。例如在一个c文件中，定义int test，并且该符号在别的地方会被引用，则该符号类型即为C。否则其类型为B。</td>
</tr>
<tr>
<td>D</td>
<td>该符号位于初始话数据段中。一般来说，分配到data section中。例如定义全局int baud_table[5] &#x3D; {9600, 19200, 38400, 57600, 115200}，则会分配于初始化数据段中。</td>
</tr>
<tr>
<td>G</td>
<td>该符号也位于初始化数据段中。主要用于small object提高访问small data object的一种方式。</td>
</tr>
<tr>
<td>I</td>
<td>该符号是对另一个符号的间接引用。</td>
</tr>
<tr>
<td>N</td>
<td>该符号是一个debugging符号。</td>
</tr>
<tr>
<td>R</td>
<td>该符号位于只读数据区。例如定义全局const int test[] &#x3D; {123, 123};则test就是一个只读数据区的符号。注意在cygwin下如果使用gcc直接编译成MZ格式时，源文件中的test对应_test，并且其符号类型为D，即初始化数据段中。但是如果使用m6812-elf-gcc这样的交叉编译工具，源文件中的test对应目标文件的test,即没有添加下划线，并且其符号类型为R。一般而言，位于rodata section。值得注意的是，如果在一个函数中定义const char *test &#x3D; “abc”, const char test_int &#x3D; 3。使用nm都不会得到符号信息，但是字符串“abc”分配于只读存储器中，test在rodata section中，大小为4。</td>
</tr>
<tr>
<td>S</td>
<td>符号位于非初始化数据区，用于small object。</td>
</tr>
<tr>
<td>T</td>
<td>该符号位于代码区text section。</td>
</tr>
<tr>
<td>U</td>
<td>该符号在当前文件中是未定义的，即该符号的定义在别的文件中。例如，当前文件调用另一个文件中定义的函数，在这个被调用的函数在当前就是未定义的；但是在定义它的文件中类型是T。但是对于全局变量来说，在定义它的文件中，其符号类型为C，在使用它的文件中，其类型为U。</td>
</tr>
<tr>
<td>V</td>
<td>该符号是一个weak object。</td>
</tr>
<tr>
<td>W</td>
<td>该符号是没有被明确标记为weak object的弱符号类型。</td>
</tr>
<tr>
<td>-</td>
<td>该符号是a.out格式文件中的stabs symbol。</td>
</tr>
<tr>
<td>?</td>
<td>该符号类型没有定义。</td>
</tr>
</tbody></table>
<h3 id="4-4-gcc-常用命令"><a href="#4-4-gcc-常用命令" class="headerlink" title="4.4 gcc 常用命令"></a>4.4 gcc 常用命令</h3><table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-ansi</td>
<td align="left">只支持 ANSI 标准的 C 语法。这一选项将禁止 GNU C 的某些特色， 例如 asm 或 typeof 关键词。</td>
</tr>
<tr>
<td align="left">-c</td>
<td align="left">只编译并生成目标文件。</td>
</tr>
<tr>
<td align="left">-DMACRO</td>
<td align="left">以字符串”1”定义 MACRO 宏。</td>
</tr>
<tr>
<td align="left">-DMACRO&#x3D;DEFN</td>
<td align="left">以字符串”DEFN”定义 MACRO 宏。</td>
</tr>
<tr>
<td align="left">-E</td>
<td align="left">只运行 C 预编译器。</td>
</tr>
<tr>
<td align="left">-g</td>
<td align="left">生成调试信息。GNU 调试器可利用该信息。</td>
</tr>
<tr>
<td align="left">-IDIRECTORY</td>
<td align="left">指定额外的<strong>头文件</strong>搜索路径DIRECTORY。</td>
</tr>
<tr>
<td align="left">-LDIRECTORY</td>
<td align="left">指定额外的函数库搜索路径DIRECTORY。</td>
</tr>
<tr>
<td align="left">-lLIBRARY</td>
<td align="left">连接时搜索指定的函数库LIBRARY。</td>
</tr>
<tr>
<td align="left">-m486</td>
<td align="left">针对 486 进行代码优化。</td>
</tr>
<tr>
<td align="left">-o FILE</td>
<td align="left">生成指定的输出文件。用在生成可执行文件时。</td>
</tr>
<tr>
<td align="left">-O0</td>
<td align="left">不进行优化处理。</td>
</tr>
<tr>
<td align="left">-O 或 -O1</td>
<td align="left">优化生成代码。</td>
</tr>
<tr>
<td align="left">-O2</td>
<td align="left">进一步优化。</td>
</tr>
<tr>
<td align="left">-O3</td>
<td align="left">比 -O2 更进一步优化，包括 inline 函数。</td>
</tr>
<tr>
<td align="left">-shared</td>
<td align="left">生成共享目标文件。通常用在建立共享库时。</td>
</tr>
<tr>
<td align="left">-static</td>
<td align="left">禁止使用共享连接。</td>
</tr>
<tr>
<td align="left">-UMACRO</td>
<td align="left">取消对 MACRO 宏的定义。</td>
</tr>
<tr>
<td align="left">-w</td>
<td align="left">不生成任何警告信息。</td>
</tr>
<tr>
<td align="left">-Wall</td>
<td align="left">生成所有警告信息。</td>
</tr>
</tbody></table>
<h2 id="5-main-函数"><a href="#5-main-函数" class="headerlink" title="5 main 函数"></a>5 main 函数</h2><h3 id="5-1-输入参数"><a href="#5-1-输入参数" class="headerlink" title="5.1 输入参数"></a>5.1 输入参数</h3><p>本章节并不是讲解函数执行流程，执行流程在 Windows 内核部分（x86 异常顶层处理）已经分析过了。本章节主要讲解输入参数的处理。</p>
<p><code>main</code> 函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span></span><br></pre></td></tr></table></figure>

<p><code>main</code> 函数是带参数的，我们在 Linux 上使用的命令，如 <code>ls -al</code> 都是带参数的，这些参数都是输入给 <code>main</code> 函数的。3 个参数的意义如下：</p>
<ul>
<li><code>argc</code>：以空格作为分隔，命令行输入的字段个数。由系统根据输入的字段数量自动进行统计，不是用户手动指定。</li>
<li><code>argv</code>：是一个字符串指针数组，从 <code>argv[0]</code> 开始存储输入的每个字段，空格不存储。因为 C 语言没有 String 类，所以使用二级指针存储字符串。</li>
<li><code>envp</code>：环境变量参数。保存当前进程所属用户所有的系统环境变量。</li>
</ul>
<p><img data-src="https://s2.loli.net/2023/07/31/Ebqp1VgJtvl37aL.png" alt="29.png"></p>
<p>举例说明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./test.exe -b time -k year</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	argc = 5		// 输入共 5 个字段，由系统给句输入自动统计。以空格作为分割。</span></span><br><span class="line"><span class="comment">	argv[0] = ./test.exe	// 输入的第一个字段</span></span><br><span class="line"><span class="comment">	argv[1] = -b, argv[2] = time</span></span><br><span class="line"><span class="comment">	argv[3] = -k, argv[4] = year</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<p>举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[alvin@centos<span class="number">-7</span> program]$ cat test_main_arg.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;argc = %d\n&quot;</span>, argc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(argc--)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;argv[%d] = %s\n&quot;</span>, i, argv[i]);</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;---------------------------------\n&quot;</span>);</span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(envp[i] != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;envp[%d] = %s\n&quot;</span>, i, envp[i]);</span><br><span class="line">		i++;	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[alvin@centos<span class="number">-7</span> program]$ ./test_main_arg.exe -b time -k year</span><br><span class="line">argc = <span class="number">5</span></span><br><span class="line">argv[<span class="number">0</span>] = ./test_main_arg.exe</span><br><span class="line">argv[<span class="number">1</span>] = -b</span><br><span class="line">argv[<span class="number">2</span>] = time</span><br><span class="line">argv[<span class="number">3</span>] = -k</span><br><span class="line">argv[<span class="number">4</span>] = year</span><br><span class="line">---------------------------------</span><br><span class="line">envp[<span class="number">0</span>] = XDG_SESSION_ID=<span class="number">79</span></span><br><span class="line">envp[<span class="number">1</span>] = HOSTNAME=centos<span class="number">-7.9</span>.shared</span><br><span class="line">envp[<span class="number">2</span>] = SHELL=/bin/bash</span><br><span class="line">envp[<span class="number">3</span>] = TERM=xterm<span class="number">-256</span>color</span><br><span class="line">envp[<span class="number">4</span>] = HISTSIZE=<span class="number">1000</span></span><br><span class="line">envp[<span class="number">5</span>] = USER=alvin</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h3 id="5-2-getopt-函数"><a href="#5-2-getopt-函数" class="headerlink" title="5.2 getopt 函数"></a>5.2 getopt 函数</h3><p>Linux 的标准 C 库（ANSI C）提供了两个专门支持处理命令函输入的参数，<code>getopt</code>、<code>getopt_long</code>。借用这两个函数，可以方便开发者更好地处理从 <code>main</code> 输入的命令行。这两个函数包含在 <code>/usr/include/unistd.h</code> 头文件中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getopt</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> argv[], <span class="keyword">const</span> <span class="keyword">char</span> *optstring)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getopt_long</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> argv[], \</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span> *optstring, <span class="keyword">const</span> struct option *longopts, <span class="keyword">int</span> *longindex)</span></span>;  </span><br><span class="line">    </span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span>* optarg;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> optind, opterr, optopt;</span><br></pre></td></tr></table></figure>

<p>关于 <code>getopt</code> 函数说明：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>参数</td>
<td>1、 <code>argc</code>、<code>argv</code> 即从 <code>main</code> 函数前 2 个参数传递而来。<br />2、 <code>optstring</code>：该程序可用的参数选项，以 <code>-x</code> 开头的表示参数选项。 有着独特的格式，如 <code>ab:m::k:</code>，意义如下：<br />- 单个字符：表示选项，后面不需要接参数。<br />- 字符后接一个冒号 <code>b:</code>：表示 <code>-b</code> 选项之后必须跟一个参数。<br />- 字符后接两个冒号 <code>m::</code>：表示 <code>-m</code> 选项之后接一个可选参数。如果有参数，选项和参数之间不能有空格。</td>
</tr>
<tr>
<td>系统变量</td>
<td><code>getopt</code> 函数还会定义 4 个系统变量，生命周期为父函数的生命周期（调用 <code>getopt</code> 的函数），<strong>并不是</strong>调用一次 <code>getopt</code> 这几个变量就被刷新。<br /><br />如果 <code>getopt</code> 函数成功执行，则会返回匹配到的相关参数选项，如上如果匹配到选项 <code>a</code> 则会返回字母 <code>a</code> 的 ASCII，同时设置如下变量。<br /> <code>optarg</code>：指向匹配到的参数字符串，如果没有参数则为 <code>NULL</code>。<br /> <code>optind</code>：下次调用 <code>getopt</code> 函数时，要处理的 <code>argv</code> 数组元素的下标。<br /> <code>opterr</code>：正常运行状态下为 0。非零时表示存在无效选项或者缺少选项参数，并输出其错误信息。<br /><code>optopt</code>：当命令行中的选项不包括在 <code>optstring</code>，则该选项将存储在 <code>optopt</code> 中，<code>getopt</code> 函数返回 <code>?</code>。</td>
</tr>
<tr>
<td>返回值</td>
<td>每次调用 <code>getopt</code> 函数返回值都不一样。<br />1、正常情况下返回匹配到的参数选项字符 ASCII，相应的参数值字符串由 <code>optarg</code> 指向。<br />2、如果参数解析完毕或参数无效（<code>optiond</code> 指向的参数无意义），则返回 <code>-1</code>。<br />3、命令行中的参数在 <code>optstring</code> 中没有找到，返回 <code>?</code>。</td>
</tr>
</tbody></table>
<p>该函数一般用在一个循环里面，当返回值 <code>!= -1</code> 时就在循环里面进行处理。</p>
<p>举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[alvin@centos<span class="number">-7</span> program]$ cat test_getopt.c </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span>* optarg;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> optind, opterr, optopt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret_ascii = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>((ret_ascii = getopt(argc, argv, <span class="string">&quot;uc:p::k&quot;</span>)) != <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">switch</span>(ret_ascii)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;opt = -u, arg = %s, next_opt_index = %d\n&quot;</span>, optarg, optind);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;opt = -c, arg = %s, next_opt_index = %d\n&quot;</span>, optarg, optind);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;opt = -p, arg = %s, next_opt_index = %d\n&quot;</span>, optarg, optind);</span><br><span class="line">                        	<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;k&#x27;</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;opt = -k, arg = %s, next_opt_index = %d\n&quot;</span>, optarg, optind);</span><br><span class="line">                        	<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t find the opt in optstring\n&quot;</span>);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;opt = -?, arg = %s, next_opt_index = %d\n&quot;</span>, optarg, optind);</span><br><span class="line">                        	<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;default, arg = %s, next_opt_index = %d\n&quot;</span>, optarg, optind);</span><br><span class="line">                        	<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[alvin@centos<span class="number">-7</span> program]$ ./test_getopt.exe -u -c time -pproc -k</span><br><span class="line">opt = -u, arg = (null), next_opt_index = <span class="number">2</span></span><br><span class="line">opt = -c, arg = time, next_opt_index = <span class="number">4</span></span><br><span class="line">opt = -p, arg = proc, next_opt_index = <span class="number">5</span></span><br><span class="line">opt = -k, arg = (null), next_opt_index = <span class="number">6</span></span><br></pre></td></tr></table></figure>





<h2 id="6-错误处理"><a href="#6-错误处理" class="headerlink" title="6 错误处理"></a>6 错误处理</h2><h3 id="6-1-errno"><a href="#6-1-errno" class="headerlink" title="6.1 errno"></a>6.1 errno</h3><p>函数调用过程中，如存在权限不足、参数错误等错误时，函数都会返回一个值，返回值常常是一个正&#x2F;负整数（类似于Windows 下的 <code>NTSTATUS</code> 类型返回值），可根据返回值知道错误原因。</p>
<p>在 Linux 下，函数返回的错误号称为 <code>errno</code>，其对应的常量值定义在 <code>/usr/include/asm-generic/errno.h</code> 中，这些常量大部分以 <code>E</code> 字母开头。关于 <code>errno</code> 号的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Function to get address of global &#x27;errno&#x27; variable.  */</span></span><br><span class="line"><span class="comment">/* When using threads, errno is a per-thread value.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> *__errno_location (<span class="keyword">void</span>) __THROW __attribute__ ((__const__));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> errno (*__errno_location ())</span></span><br></pre></td></tr></table></figure>

<p>可以看到，宏 <code>errno</code> 即为错误号，为整数，替换上一行的 <code>int</code>。对于 <code>errno</code> 应当知道两条规则。</p>
<ul>
<li>第一条规则是：如果没有出错，则其值不会被一个例程清除。因此，仅当函数的返回值指明出错时，才检验其值</li>
<li>第二条是：任一函数都不会将  <code>errno</code> 值设置为0，在 <code>&lt;errno.h&gt;</code> 中定义的所有常量都不为 <code>0</code>。</li>
</ul>
<p> <code>errno</code> 号常量举例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  /usr/include/asm-generic/errno.h  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EDEADLK		35	<span class="comment">/* Resource deadlock would occur */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ENAMETOOLONG	36	<span class="comment">/* File name too long */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ENOLCK		37	<span class="comment">/* No record locks available */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ENOSYS		38	<span class="comment">/* Function not implemented */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ENOTEMPTY	39	<span class="comment">/* Directory not empty */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ELOOP		40	<span class="comment">/* Too many symbolic links encountered */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EWOULDBLOCK	EAGAIN	<span class="comment">/* Operation would block */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ENOMSG		42	<span class="comment">/* No message of desired type */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EIDRM		43	<span class="comment">/* Identifier removed */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ECHRNG		44	<span class="comment">/* Channel number out of range */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EL2NSYNC	45	<span class="comment">/* Level 2 not synchronized */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EL3HLT		46	<span class="comment">/* Level 3 halted */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EL3RST		47	<span class="comment">/* Level 3 reset */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ELNRNG		48	<span class="comment">/* Link number out of range */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EUNATCH		49	<span class="comment">/* Protocol driver not attached */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ENOCSI		50	<span class="comment">/* No CSI structure available */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EL2HLT		51	<span class="comment">/* Level 2 halted */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EBADE		52	<span class="comment">/* Invalid exchange */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EBADR		53	<span class="comment">/* Invalid request descriptor */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EXFULL		54	<span class="comment">/* Exchange full */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	ENOANO		55	<span class="comment">/* No anode */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EBADRQC		56	<span class="comment">/* Invalid request code */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	EBADSLT		57	<span class="comment">/* Invalid slot */</span></span></span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>C 标准定义了两个函数：<code>strerror</code>、<code>perror</code>，它们帮助打印出错信息。</p>
<h3 id="6-2-strerror-r"><a href="#6-2-strerror-r" class="headerlink" title="6.2 strerror_r"></a>6.2 strerror_r</h3><p><code>strerror</code> 函数定义在 <code>/usr/include/string.h</code> 中，将对应的 <code>errno</code> 号映射为对应的错误描述字符串，并且返回指向此字符串的指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  /usr/include/string.h  */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">char</span> *<span class="title">strerror</span> <span class="params">(<span class="keyword">int</span> __errnum)</span> __THROW</span>;</span><br></pre></td></tr></table></figure>

<p><code>__errnum</code> 为 <code>errno</code> 号。</p>
<p>举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Error: %s\n&quot;</span>, strerror(errno));</span><br></pre></td></tr></table></figure>

<p>输出为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[*] Error: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>

<p>注意：由于 <code>strerror</code> 函数返回的是一个字符串的地址，可能会被更改，所以 <code>strerror</code> 函数不是线程安全的，可以使用 <code>strerror_r</code> 线程安全函数替代：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">char</span> *<span class="title">strerror_r</span> <span class="params">(<span class="keyword">int</span> __errnum, <span class="keyword">char</span> *__buf, <span class="keyword">size_t</span> __buflen)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>__buf</code>：用来接收 <code>__errnum</code> 所映射的字符串。</li>
<li><code>__buflen</code>：参数二 <code>__buf</code> 的长度。</li>
</ul>
<p>所以上面的代码可以改为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">strerror_r(errno, buf, <span class="number">100</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[**] %s\n&quot;</span>, buf);</span><br></pre></td></tr></table></figure>

<p>返回值：成功时返回 <code>1</code>，失败时返回 <code>-1</code>。有意思的是，这个函数在错误时也设置 <code>errno</code>。</p>
<h3 id="6-3-perror"><a href="#6-3-perror" class="headerlink" title="6.3 perror"></a>6.3 perror</h3><p>Linux 下错误信息的处理要比 Windows 下更便捷，在 Linux 下，当一个函数出错时，可以调用 <code>perror</code> 函数。</p>
<p><code>perror</code> 函数作用：该函数向 <code>stderr</code>（标准错误输出）打印以 <code>str</code> 指向的字符串为前缀，紧跟着一个冒号， 然后输出由 <code>errno</code> 表示的当前错误的字符串。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">perror</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line">...</span><br><span class="line">perror(<span class="string">&quot;[*] &quot;</span>);</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[*] : No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>





<p>参考资料：</p>
<ul>
<li>《Unix 环境高级编程 第二版 1.7》</li>
<li>《Linux 系统编程 第二版 1.4.8》</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/linux-programming-basics/" title="Linux 编程基础">https://directoree.github.io/post/linux-programming-basics/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/x86-64/" rel="tag"><i class="fa fa-tag"></i> x86-64</a>
              <a href="/tags/Linux-%E9%80%86%E5%90%91/" rel="tag"><i class="fa fa-tag"></i> Linux 逆向</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/System-V-AMD64-ABI/" rel="prev" title="System V AMD64 ABI">
                  <i class="fa fa-chevron-left"></i> System V AMD64 ABI
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/linux-file-systems_basics/" rel="next" title="Linux 文件系统知识">
                  Linux 文件系统知识 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.3m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">19:56</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>








<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script data-pjax>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '70px',
  right: 'unset',
  left: '16px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#222',
  buttonColorLight: '#222',
  saveInCookies: false,
  label: '',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  if (toggleButtons && toggleButtons.length > 0) {
    for (i = 0; i < toggleButtons.length; i++) {
      toggleButtons[i].classList.add("darkmode-toggle--white");
    }
  }
}
</script>

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/linux-programming-basics/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
