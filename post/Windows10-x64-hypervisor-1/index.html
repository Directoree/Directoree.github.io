<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="😄">
<meta property="og:type" content="article">
<meta property="og:title" content="Hypervisor（一）：VMX 架构与 VMXON region">
<meta property="og:url" content="https://directoree.github.io/post/Windows10-x64-hypervisor-1/index.html">
<meta property="og:site_name" content="˗ˋˏ♡ˎˊ˗">
<meta property="og:description" content="😄">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/04/11/LE4ultM5NgaVkqs.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/09/PJBqN8C2DS9Mhvt.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/09/MSi93wzgvoUDE7G.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/09/jt7m6Awy5LsRE2D.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/10/ptrFhJRTISdC6EQ.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/10/Gzp3edAOJfaKx45.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/11/ifbrcYvzDNVFBHS.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/12/EeLKsWIPNMabtGC.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/12/dXrTKVC8UJNtuO9.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/15/5cyNYBezLA6PXtT.png">
<meta property="og:image" content="https://s2.loli.net/2023/04/19/jUmipvGlJWbCsYO.png">
<meta property="article:published_time" content="2023-04-07T14:17:09.000Z">
<meta property="article:modified_time" content="2023-06-29T16:23:09.015Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="Windows内核">
<meta property="article:tag" content="虚拟化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/04/11/LE4ultM5NgaVkqs.png">


<link rel="canonical" href="https://directoree.github.io/post/Windows10-x64-hypervisor-1/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Hypervisor（一）：VMX 架构与 VMXON region | ˗ˋˏ♡ˎˊ˗</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#222;--content-bg-color:#222;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#2d2f31;--highlight-foreground:#ccc;--highlight-gutter-background:#333;--highlight-gutter-foreground:#888}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#fff;background:#555}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">˗ˋˏ♡ˎˊ˗</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-空调房">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>空调房</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Hypervisor"><span class="nav-text">1 Hypervisor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Type-1-hypervisor"><span class="nav-text">2 Type 1 hypervisor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-VMware-ESX"><span class="nav-text">2.1 VMware ESX</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Citrix-Hypervisor-Xen"><span class="nav-text">2.2 Citrix Hypervisor (Xen)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Microsoft-Hyper-V"><span class="nav-text">2.3 Microsoft Hyper-V</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%A1%AC%E4%BB%B6%E8%BE%85%E5%8A%A9%E7%9A%84%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-text">3 硬件辅助的虚拟化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E7%A1%AC%E4%BB%B6%E8%BE%85%E5%8A%A9%E7%9A%84%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-text">3.1 硬件辅助的虚拟化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A9%E5%B1%95%E6%9E%B6%E6%9E%84%EF%BC%88VMX%EF%BC%89"><span class="nav-text">3.2 虚拟机扩展架构（VMX）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E6%A3%80%E6%B5%8B-CPU-%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81-VMX"><span class="nav-text">3.3 检测 CPU 是否支持 VMX</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E5%90%AF%E7%94%A8-VMX"><span class="nav-text">3.4 启用 VMX</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E7%A6%81%E7%94%A8-VMX"><span class="nav-text">3.5 禁用 VMX</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-%E8%BF%9B%E5%85%A5-VMX-operation-%E6%9D%A1%E4%BB%B6"><span class="nav-text">3.6 进入 VMX operation 条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-%E6%80%BB%E7%BB%93"><span class="nav-text">3.7 总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-VMXON-region"><span class="nav-text">4 VMXON region</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">4.1 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-IA32-VMX-BASIC"><span class="nav-text">4.2 IA32_VMX_BASIC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E7%94%B3%E8%AF%B7-VMXON-region"><span class="nav-text">4.3 申请 VMXON region</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-text">5 逻辑处理器</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.gitee.io/" title="Cutecat → https:&#x2F;&#x2F;catecat.gitee.io" rel="noopener" target="_blank"><i class="fas fa-heartbeat fa-fw"></i>Cutecat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.top/" title="Directoree → https:&#x2F;&#x2F;catecat.top" rel="noopener" target="_blank"><i class="fas fa-heart fa-fw"></i>Directoree</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/Windows10-x64-hypervisor-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="˗ˋˏ♡ˎˊ˗">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hypervisor（一）：VMX 架构与 VMXON region
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-07 22:17:09" itemprop="dateCreated datePublished" datetime="2023-04-07T22:17:09+08:00">2023-04-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-06-30 00:23:09" itemprop="dateModified" datetime="2023-06-30T00:23:09+08:00">2023-06-30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">虚拟化</span></a>
        </span>
    </span>

  
    <span id="/post/Windows10-x64-hypervisor-1/" class="post-meta-item leancloud_visitors" data-flag-title="Hypervisor（一）：VMX 架构与 VMXON region" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/Windows10-x64-hypervisor-1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/Windows10-x64-hypervisor-1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>😄</p>
<span id="more"></span>



<h2 id="1-Hypervisor"><a href="#1-Hypervisor" class="headerlink" title="1 Hypervisor"></a>1 Hypervisor</h2><p>Hypervisor 虚拟机监视器（VMM），由它来实现对物理资源虚拟化。并控制着多个虚拟机（VM）对物理硬件资源的访问。</p>
<ul>
<li>CPU</li>
<li>内存</li>
<li>I&#x2F;O</li>
<li>网络</li>
</ul>
<p>1960s，Hypervisor 是在大型机上用来开发和调试操作系统的。1990s，小型机发展起来后也开发出新的 Hypervisor，Hypervisor 可以运行在操作系统之上，也可以不依赖操作系统直接运行在硬件之上。有两种类型的 Hypervisor：</p>
<ol>
<li>👆<mark class="label success">Type 1</mark>：也叫做裸机型（Bare-metal），<strong>直接运行在硬件服务器之上</strong>，其下没有操作系统。比 Type 2 型的 Hypervisor 更高效、更安全。</li>
<li>✌️<mark class="label warning">Type 2</mark>：也叫做主机型（Hosted），<strong>Hypervisor 只是主机操作系统上的一个应用程序</strong>。这种类型的 Hypervisor 能适应更多类型的硬件，因为操作系统在之下已经进行了适配。这种类型的 Hypervisor 也比 Type 1 Hypervisor 安装方便。但是 VM 执行效率较 Type 1 型的低，比如 VM 发起的 I&#x2F;O 请求会先交给 Hypervisor，然后Hypervisor 再请求操作系统处理，操作系统处理完成后再逐步传回 VM。</li>
</ol>
<div class="note danger"><p>Hypervisor 的三个作用：</p>
<ol>
<li>提供与物理环境相同的环境。Provide an environment identical to the physical environment.</li>
<li>以最小的性能成本提供该环境。Provide that environment with minimal performance cost.</li>
<li>保留对系统资源的完全控制。Retain complete control of the system resources.</li>
</ol>
</div>

<p><img data-src="https://s2.loli.net/2023/04/11/LE4ultM5NgaVkqs.png" alt="1.png"></p>
<h2 id="2-Type-1-hypervisor"><a href="#2-Type-1-hypervisor" class="headerlink" title="2 Type 1 hypervisor"></a>2 Type 1 hypervisor</h2><h3 id="2-1-VMware-ESX"><a href="#2-1-VMware-ESX" class="headerlink" title="2.1 VMware ESX"></a>2.1 VMware ESX</h3><p>2001 年，VMware 发布了 ESX 1.0 和 GSX 1.0。 ESX 是 Type 1 hypervisor，而 GSX 是 Type 2 hypervisor。 ESX 今天仍然存在，并且仍在得到增强和更新。 不过，GSX 已更名为 VMware Server，但不再可用。</p>
<p>ESX 的原始架构由两部分组成，hypervisor + 基于 Linux 的服务控制台模块（充当管理接口）。管理接口往往非常大，如 hypervisor（32MB），服务控制台约 900 MB。服务控制台的安全性也会影响着 hypervisor 的安全性。所以后来<strong>基于相同的 hypervisor 开发出 ESXi，但是不再有控制台</strong>。2011 年后只有 ESXi 架构可用。</p>
<p><img data-src="https://s2.loli.net/2023/04/09/PJBqN8C2DS9Mhvt.png" alt="2.png"></p>
<h3 id="2-2-Citrix-Hypervisor-Xen"><a href="#2-2-Citrix-Hypervisor-Xen" class="headerlink" title="2.2 Citrix Hypervisor (Xen)"></a>2.2 Citrix Hypervisor (Xen)</h3><p><strong>开源的</strong>，开源的解决方案！但是目前商业市场份额还不到 5%。</p>
<p>Xen 管理程序始于 1990 年代末剑桥大学的一个研究项目，其目标是为分布式计算创建一个高效的平台。 2002 年，该代码成为一个开源项目，允许任何人为改进特性和功能做出贡献。XenSource 成立于 2004 年，旨在将 Xen 虚拟机管理程序推向市场，该开源项目至今仍保持开放状态。Citrix Systems 收购了 XenSource 以补充其应用程序交付解决方案。 2013 年，Citrix Systems 宣布 Xen 的开发将成为 Linux Foundation Collaborative Project，将开发回归到开源社区。</p>
<p>Xen 模型有一个称为 <code>Domain 0</code> 的特殊 Guest OS，也称为 <code>Dom0</code>。 这个 Guest 在 hypervisor 启动时被启动，并且它具有不同于其他 Guest 的管理权限，可以直接访问物理硬件资源。Type 1 Hypervisor。</p>
<p>如下图，当其他 Guest OS 请求访问物理硬件资源时，这些请求首先会传递给 Hypervisor，然后接着传递到 <code>Dom0</code> Guest OS，然后去访问资源。当资源访问到之后再原路返回。</p>
<p><img data-src="https://s2.loli.net/2023/04/09/MSi93wzgvoUDE7G.png" alt="3.png"></p>
<p><code>Dom0</code> 的重启将中断所有其他 Guest OS。 因为 <code>Dom0</code> 也是 Guest，它会消耗资源并与系统中的其他 Guest 争夺资源。</p>
<h3 id="2-3-Microsoft-Hyper-V"><a href="#2-3-Microsoft-Hyper-V" class="headerlink" title="2.3 Microsoft Hyper-V"></a>2.3 Microsoft Hyper-V</h3><p>微软在几年前从 Connectix 收购了该解决方案后，于 2005 年通过 Virtual Server 开始涉足虚拟化领域。 与 GSX 一样，Virtual Server 是 Type 2 虚拟机管理程序，但已停产以支持 Hyper-V（Type 1 Hypervisor）。 Microsoft Hyper-V 于 2008 年作为 Windows Server 2008 操作系统的可安装部分发布。 图 2.10 显示了 Hyper-V 的体系结构。</p>
<p><img data-src="https://s2.loli.net/2023/04/09/jt7m6Awy5LsRE2D.png" alt="4.png"></p>
<p>Hyper-V 是 Type 1 Hypervisor，Hypervisor 代码直接存在于硬件上。 不过，命名法略有不同——虚拟化工作负载称为分区，而不是 Guest。 <strong>与 Xen 模型类似，它需要一个可以直接访问硬件资源的特殊根分区</strong>。 与 <code>Dom0</code> 一样，根分区运行操作系统——在本例中为 Windows Server。 该分区创建和管理子分区并处理系统管理功能和设备驱动程序。 由于它使用类似于 XenServer 的模型，因此在修补和争用方面也存在相同的可用性漏洞。目前 Hyper-V 拥有大约 20% 的市场份额。</p>
<blockquote>
<p>其他一些基本都是在开源的 Xen 进行修改发展起来的，Red Hat 是另一种解决方案，随着时间的推移经历了一些不同的排列。 最初，它还使用开源 Xen 代码，因为它非常适合其开源解决方案的业务模型。 2008 年，红帽收购了 Qumranet 及其基于内核的虚拟机 (KVM) 解决方案。 KVM 与 Linux 本身一样，也是基于同名的开源项目。 有一段时间，Red Hat Enterprise Linux (RHEL) 版本同时支持 KVM 和 Xen 虚拟化技术。 2012年，Red Hat表示KVM是其未来方向，不再支持Xen。 KVM 作为 Linux 内核模块提供，允许您利用 Linux 的许多功能，例如调度程序和内存管理，而无需将它们作为代码的一部分包含在内。 对于 Red Hat 本身的现有用户来说，KVM 的使用随着时间的推移而增长。 然而，开源云计算项目 OpenStack 的兴起有所帮助，因为 KVM 可以用作虚拟机管理程序的选择之一。</p>
</blockquote>
<p>参考资料：</p>
<ul>
<li>Virtualization Essentials (Matthew Portnoy) Third Edition</li>
<li><a target="_blank" rel="noopener" href="https://github.com/0voice/Introduce_to_virtualization#nav_vt0_chapter1">500篇关于虚拟化的经典资料</a></li>
</ul>
<h2 id="3-硬件辅助的虚拟化"><a href="#3-硬件辅助的虚拟化" class="headerlink" title="3 硬件辅助的虚拟化"></a>3 硬件辅助的虚拟化</h2><h3 id="3-1-硬件辅助的虚拟化"><a href="#3-1-硬件辅助的虚拟化" class="headerlink" title="3.1 硬件辅助的虚拟化"></a>3.1 硬件辅助的虚拟化</h3><p>在虚拟化技术早期，主要有两种在软件层面来将物理 CPU 虚拟成虚拟 vCPU 的技术：</p>
<ul>
<li>全虚拟化（Full Virtualization）：以 VMware 为代表，<strong>动态处理</strong>非特权指令“运行时监控，捕捉后在 VMM 中模拟”。（无需修改，直接运行）</li>
<li>半虚拟化（Para Virtualization）：以 Xen 为代表，<strong>静态处理</strong>非特权指令“将 VM 中全部非特权指令进行替换处理”。提高效率。</li>
</ul>
<p>后来 Intel、AMD 硬件厂商均推出了在硬件级支持虚拟化的 CPU——硬件辅助的虚拟化，本文主要关注 Intel 的 CPU 硬件虚拟化。</p>
<div class="note warning"><p>Intel 推出了以下三个层面的虚拟化技术：</p>
<ol>
<li><p>基于处理器的虚拟化技术（<mark class="label danger">Intel VT-x</mark>)， 全称为 Virtualization Technology for x86。</p>
</li>
<li><p>基于PCI总线域设备实现的 I&#x2F;O 虚拟化技术（<mark class="label default">Intel VT-d</mark>) ，全称为 Virtualization Technology for Directed I&#x2F;O。</p>
</li>
<li><p>基于网络的虚拟化技术（<mark class="label warning">Intel VT-c</mark>)，主要在服务器平台提供， 全称为 Virtualization Technology for Connectify。</p>
<p>在处理器虚拟化方面，Intel 也为 Itanium（奔腾） 平台提供了虚拟化，即 <mark class="label info">Intel VT-i</mark>。</p>
</li>
</ol>
</div>

<div class="note primary"><p>以下几个概念需要弄清楚：</p>
<ol>
<li>Intel 处理器级的虚拟化技术叫做 <code>Intel VT-x</code>，用来实现虚拟化的功能叫做 VMX（Virtual Machine Extension，虚拟机扩展），也可以将 <code>Intel VT-x</code> 叫做 <code>VMX</code>，也可以叫做硬件虚拟化技术（Hardware Enabled Virtualization，HEV）。虚拟机扩展定义了在 IA-32 处理器上对虚拟机的处理器级支持。</li>
<li>虚拟机扩展架构（VMX）下定义了两个角色、两种模式、一组指令：<ul>
<li>两个角色：虚拟机管理器（Virtual Machine Monitor，VMM）和客户机（Guest OS）。</li>
<li>两种模式：VMX root operation（ring -1），VMX non-root operation。VMM 运行在 VMX root 模式，Guest OS 运行在 VMX non-root 模式。</li>
<li>一组专门用在 VMM 中的指令，叫做 <strong>VMX 指令</strong>，VMX 指令只能在 VMX root 模式下执行。</li>
</ul>
</li>
</ol>
</div>

<div class="note info"><p>注意：处理器（Processor）和 CPU 的差别，处理器一般指逻辑处理器（Logical Processor）。在多核 CPU 中，一个 CPU 上可能会有多个核， 而<strong>在操作系统视角中，一个核才是一个逻辑处理器</strong>，因此通过操作系统查看的逻辑处理器数量往往大于真实 CPU 的数量，并且<strong>逻辑处理器才是能够运行 Hypervisor 的基础</strong>。</p>
</div>

<p><img data-src="https://s2.loli.net/2023/04/10/ptrFhJRTISdC6EQ.png" alt="5.png"></p>
<h3 id="3-2-虚拟机扩展架构（VMX）"><a href="#3-2-虚拟机扩展架构（VMX）" class="headerlink" title="3.2 虚拟机扩展架构（VMX）"></a>3.2 虚拟机扩展架构（VMX）</h3><p>Intel 实现了 VMX 架构来支持 CPU 端的虚拟化技术（Intel VT-x 技术），引入了一种新的处理器操作模式，被称为 VMX operation。也加入了一系列的 VMX 指令支持 VMX operation 模式。</p>
<p>处理器提供 VMX operation 使得处理器支持虚拟化。在硬件虚拟化中，有时也称 VMM 为 “Hypervisor” 专指在使用 VT 技术时创建的特权层，也就是 Ring 0 之 下的 Ring -1。处在这个层次的代码具有“上帝视角”，能监控计算机的各种行为，例如特权指令、内存访问、IO 访问等。该层提供给虚拟机开发者，<strong>Hypervisor 的权限级别要大于或等于操作系统权限</strong>。</p>
<p>在 VT 技术中，VMX root operation 和 VMX non-root operation 模式切换过程如下：</p>
<p><img data-src="https://s2.loli.net/2023/04/10/Gzp3edAOJfaKx45.png" alt="6.png"></p>
<ol>
<li>对于 VMM 层，进入此层则代表进入了 VMX root 模式。<ul>
<li>为每个虚拟机提供虚拟处理器，并且可以在恰当的时候把它放在真正的物理处理器上，从而使得这个虚拟处理器可以处理指令。</li>
<li>VMM 通过虚拟机控制结构（Virtual-Machine Control Strueture，VMCS）设置需要截获的硬件访问，例如指令、中断、内存访问和异常等。如果 Guest OS 在执行时触发了这些条件设置，将引起 VM 退出（<code>#VMExit</code>），此时 CPU 会从 non-Root 模式切换到 Root 模式，VMM 会获得系统控制杈并执行相应的处理程序。</li>
</ul>
</li>
<li>对于 Guest（VM）层，进入此层则代表进入了 VMX non-root 模式。<ul>
<li>每个虚拟机使用相同的接口来使用虚拟处理器、内存、存储设备等资源。</li>
<li>每个虚拟机可以独立地不受干扰地运行，虚拟机间都是相互独立的。</li>
<li>对于虚拟机来说，VMM 层像是完全透明的。</li>
</ul>
</li>
<li>软件通过执行 <code>VMXON</code> 指令进入 VMX Root 模式下，开启了虚拟机管理器的运行环境。然后通过使用 <code>VMLAUNCH</code> 指令使得目标系统正式运行在虚拟机中（开启 VM）。 当 VM 中某条指令产生了 <code>#VMEXIT</code> 事件后，会陷入虚拟机管理器中，待其处理完这个事件， 可以通过 <code>VMRESUME</code> 指令将控制权移交回发生 <code>#VMEXIT</code> 事件的虚拟机。直到某个时刻，在 Hypervisor 中显式地调用了 <code>VMXOFF</code> 指令，Hypervisor 才会被关闭。</li>
</ol>
<div class="note danger"><p>创建一个典型的 VT 技术 Hypervisor 例子主要有以下几个步骤：</p>
<ol>
<li>先检测当前处理器是否支持 VMX（VT-x）。</li>
<li>分配 4KB（0x1000）对齐的 VMXON 区域和 VMCS 控制块。</li>
<li>填写 VMCS 控制块。VMCS 控制块用于控制要监控什么特权指令、是否开启 EPT 机制、是否监控 I&#x2F;O 访问等。</li>
<li>调用 <code>VMLAUNCH</code> 指令启动虚拟机。</li>
<li>当产生 <code>#VMExit</code> 事件时调用 <code>VMExitProc</code> 函数，并处理各种感兴趣的虚拟机陷入消息。</li>
</ol>
</div>

<p>关于 VMX 指令，将在后面章节进行介绍。</p>
<h3 id="3-3-检测-CPU-是否支持-VMX"><a href="#3-3-检测-CPU-是否支持-VMX" class="headerlink" title="3.3 检测 CPU 是否支持 VMX"></a>3.3 检测 CPU 是否支持 VMX</h3><p>在使用 <code>VMXON</code> 进入到 VMX operation 模式之前，先要判断当前 CPU 是否是 Intel，是否支持 VMX。通过以下两个步骤：</p>
<ol>
<li>判断是否是 Intel 处理器。<code>CPUID.00H, RBX+RDX+RCX = Genuntelinel</code>。</li>
<li>判断是否支持 VMX。<code>CPUID.01H:ECX.VMX[bit 5] = 1</code>。</li>
</ol>
<p>–Test_Support_VMX.asm–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">option casemap :none</span><br><span class="line"></span><br><span class="line">EXTERN R_EBX:dword</span><br><span class="line">EXTERN R_ECX:dword</span><br><span class="line">EXTERN R_EDX:dword</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">;Var_1 qword ?</span><br><span class="line"></span><br><span class="line">.CODE </span><br><span class="line">Test_Support_Intel PROC</span><br><span class="line">	<span class="keyword">xor</span> eax, eax;</span><br><span class="line">	<span class="keyword">xor</span> ebx, ebx;</span><br><span class="line">	<span class="keyword">xor</span> ecx, ecx;</span><br><span class="line">	<span class="keyword">xor</span> edx, edx;</span><br><span class="line"></span><br><span class="line">	mov eax, <span class="number">0</span>;</span><br><span class="line">	cpuid;</span><br><span class="line"></span><br><span class="line">	mov dword ptr R_EBX, ebx;</span><br><span class="line">	mov dword ptr R_ECX, ecx;</span><br><span class="line">	mov dword ptr R_EDX, edx;</span><br><span class="line"></span><br><span class="line">	ret;</span><br><span class="line">Test_Support_Intel ENDP</span><br><span class="line"></span><br><span class="line">DetectVMXSupport PROC</span><br><span class="line">	<span class="keyword">xor</span> eax, eax;</span><br><span class="line">	inc eax;</span><br><span class="line">	cpuid</span><br><span class="line"></span><br><span class="line">	<span class="keyword">xor</span> eax, eax;</span><br><span class="line">	<span class="keyword">and</span> ecx, <span class="number">020</span>h;	</span><br><span class="line">	mov eax, ecx;</span><br><span class="line"></span><br><span class="line">	ret;</span><br><span class="line">DetectVMXSupport ENDP</span><br><span class="line">  </span><br><span class="line">END</span><br></pre></td></tr></table></figure>

<hr>
<p>–main.c–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">EXTERN_C  VOID _fastcall <span class="title">Test_Support_Intel</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function">EXTERN_C  ULONG _fastcall <span class="title">DetectVMXSupport</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">ULONG R_EBX, R_ECX, R_EDX = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNREFERENCED_PARAMETER(pDriver);</span><br><span class="line"></span><br><span class="line">	DbgPrint(<span class="string">&quot;Goodbye~\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriver, PUNICODE_STRING pRegPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNREFERENCED_PARAMETER(pRegPath);</span><br><span class="line">	pDriver-&gt;DriverUnload = DriverUnload;</span><br><span class="line"></span><br><span class="line">	Test_Support_Intel();</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> (R_EBX == <span class="number">0x756E6547</span> &amp;&amp; R_ECX == <span class="number">0x6C65746E</span> &amp;&amp; R_EDX == <span class="number">0x49656E69</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Parallels Desktop for Mac 需要开启嵌套虚拟化才支持 VMX(VT-x)</span></span><br><span class="line">		<span class="keyword">if</span> (DetectVMXSupport() == <span class="number">0x20</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DbgPrint(<span class="string">&quot;This CPU SUPPORT VMX!!!\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<p><img data-src="https://s2.loli.net/2023/04/11/ifbrcYvzDNVFBHS.png" alt="8.png"></p>
<h3 id="3-4-启用-VMX"><a href="#3-4-启用-VMX" class="headerlink" title="3.4 启用 VMX"></a>3.4 启用 VMX</h3><p>在进入 VMX operation 之前，需要通过设置 <code>CR4.VMXE[bit 13] = 1</code> 来启用 VMX。然后通过执行 <code>VMXON</code> 指令进入 VMX operation。其他的 VMX 指令只有在进入到 VMX operation 模式后才能使用后。</p>
<p>如果在 <code>CR4.VMXE = 0</code> 的情况下执行，执行 <code>VMXON</code> 会导致无效操作码异常（<code>#UD</code>）。一旦进入 VMX operation，就不可清除 <code>CR4.VMXE</code>。 系统软件通过执行 <code>VMXOFF</code> 指令退出 VMX 操作， 执行 <code>VMXOFF</code> 后，才可以在 VMX operation 之外清除 <code>CR4.VMXE</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AsmEnableVmxOperation PROC PUBLIC</span><br><span class="line"></span><br><span class="line">	PUSH RAX	; Save the state</span><br><span class="line">	</span><br><span class="line">	XOR RAX, RAX	; Clear the RAX</span><br><span class="line">	MOV RAX, CR4</span><br><span class="line"></span><br><span class="line">	OR RAX,<span class="number">02000</span>h	; Set the <span class="number">14</span>th bit</span><br><span class="line">	MOV CR4, RAX</span><br><span class="line">	</span><br><span class="line">	POP RAX		; Restore the state</span><br><span class="line">	RET</span><br><span class="line"></span><br><span class="line">AsmEnableVmxOperation ENDP</span><br></pre></td></tr></table></figure>

<h3 id="3-5-禁用-VMX"><a href="#3-5-禁用-VMX" class="headerlink" title="3.5 禁用 VMX"></a>3.5 禁用 VMX</h3><p><code>VMXON</code> 指令由 <code>IA32_FEATURE_CONTROL(0x3A)</code> MSR 控制。当逻辑处理器重置时，该 MSR 的值会被重置为零。</p>
<p>这里主要关注 <code>IA32_FEATURE_CONTROL[bit 0]</code>：</p>
<ul>
<li>该位是 <code>locked</code> 位。当 <code>locked</code> 位为 <code>0</code> 时，执行 <code>VMXON</code> 指令将产生 #GP 异常（VMX support was disabled in the BIOS）。因此，执行 <code>VMXON</code> 指令前必须确保 <code>locked</code> 位为 <code>1</code> 值，也就是锁上 <code>IA32_FEATURE_CONTROL</code> 寄存器。上锁后如果对 <code>IA32_FEATURE_CONTROL</code> 寄存器进行写操作（WRMSR），将产生 #GP 异常。</li>
<li>一旦该位置位（set 1）后，就不可以再使用 <code>WRMSR</code> 来修改该 MSR 寄存器的值，否则会产生通用保护（#GP）异常。</li>
</ul>
<p>这是什么意思？这意味着我们可以禁用 VMX 功能。只有在系统重置后，我们才能启用 VMX。</p>
<p>如下，一般 CPU 默认启用该位。可以在系统 BIOS 中可以将该位清零，以禁用对 VMX 的支持。但是不能使用 <code>WRMSR</code> 来将该位清零。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; rdmsr <span class="number">0x3A</span></span><br><span class="line">msr[<span class="number">3</span>a] = <span class="number">00000000</span>`<span class="number">00000005</span></span><br></pre></td></tr></table></figure>



<h3 id="3-6-进入-VMX-operation-条件"><a href="#3-6-进入-VMX-operation-条件" class="headerlink" title="3.6 进入 VMX operation 条件"></a>3.6 进入 VMX operation 条件</h3><p>进入到 VMX operation 模式使用 <code>VMXON</code> 指令，使用该指令前，以下条件必须得到满足才可以。</p>
<ol>
<li><p><code>VMXON</code> 指令由 <code>IA32_FEATURE_CONTROL(0x3A)</code> MSR 控制才能执行。</p>
<ul>
<li>locked 位，<code>bit 0 = 1</code>。</li>
<li><code>CPUID.01H:ECX[bit 6] == 1</code> 表示 CPU 支持 SMX 模式。然后查看 <code>CR4.SMXE[bit 14]</code> 是否已启用 SMX 模式。<ul>
<li><code>CR4.SMXE == 1</code>，表示 CPU 运行在 SMX 模式中，此时必须先置位 <code>IA32_FEATURE_CONTROL[bit 1] = 1</code>，且 <code>IA32_FEATURE_CONTROL[bit 0] = 1</code>  才能使用 <code>VMXON</code> 指令。</li>
<li><code>CR4.SMXE == 0</code>，表示 CPU 没有运行在 SMX 模式，此时必须先置位 <code>IA32_FEATURE_CONTROL[bit 2] = 1</code>，且 <code>IA32_FEATURE_CONTROL[bit 0] = 1</code>  才能使用 <code>VMXON</code> 指令。</li>
</ul>
</li>
</ul>
<p><img data-src="https://s2.loli.net/2023/04/12/EeLKsWIPNMabtGC.png" alt="10.png"></p>
<p><img data-src="https://s2.loli.net/2023/04/12/dXrTKVC8UJNtuO9.png" alt="11.png"></p>
<p>（Intel 手册 2 Chapter 6）</p>
</li>
<li><p><code>CR0, CR4</code> 寄存器和 4 个 MSR 寄存器。</p>
<p><code>IA32_VMX_CR0_FIXED0(0x486), IA32_VMX_CR0_FIXED1(0x487)</code>，</p>
<p><code>IA32_VMX_CR4_FIXED0(0x488), IA32_VMX_CR4_FIXED1(0x489)</code>。</p>
<ul>
<li>当 <code>FIXED0</code> 寄存器的位为 1 值时，CR0 和 CR4 寄存器对应的位必须为 1 值。</li>
<li>当 <code>FIXED1</code> 寄存器的位为 0 值时，CR0 和 CR4 寄存器对应的位必须为 0 值。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IA32_VMX_CR0_FIXED0</span></span><br><span class="line">kd&gt; rdmsr <span class="number">0x486</span></span><br><span class="line">msr[<span class="number">486</span>] = <span class="number">00000000</span>`<span class="number">80000021</span>	<span class="comment">// PE(bit0), NE(bit5), PG(bit31)</span></span><br><span class="line">kd&gt; .formats <span class="number">0x00000000</span>`<span class="number">80000021</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     <span class="number">00000000</span>`<span class="number">80000021</span></span><br><span class="line">  Decimal: <span class="number">2147483681</span></span><br><span class="line">  Octal:   <span class="number">0000000000020000000041</span></span><br><span class="line">  Binary:  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">10000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00100001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IA32_VMX_CR0_FIXED1</span></span><br><span class="line">kd&gt; rdmsr <span class="number">0x487</span></span><br><span class="line">msr[<span class="number">487</span>] = <span class="number">00000000</span>`ffffffff</span><br><span class="line">kd&gt; .formats <span class="number">0x00000000</span>`ffffffff</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     <span class="number">00000000</span>`ffffffff</span><br><span class="line">  Decimal: <span class="number">4294967295</span></span><br><span class="line">  Octal:   <span class="number">0000000000037777777777</span></span><br><span class="line">  Binary:  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">11111111</span> <span class="number">11111111</span> <span class="number">11111111</span> <span class="number">11111111</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">// IA32_VMX_CR4_FIXED0</span></span><br><span class="line">kd&gt; rdmsr <span class="number">0x488</span></span><br><span class="line">msr[<span class="number">488</span>] = <span class="number">00000000</span>`<span class="number">00002000</span>	<span class="comment">// VMXE(bit13)</span></span><br><span class="line">kd&gt; .formats <span class="number">0x00000000</span>`<span class="number">00002000</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     <span class="number">00000000</span>`<span class="number">00002000</span></span><br><span class="line">  Decimal: <span class="number">8192</span></span><br><span class="line">  Octal:   <span class="number">0000000000000000020000</span></span><br><span class="line">  Binary:  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00100000</span> <span class="number">00000000</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">// IA32_VMX_CR4_FIXED1</span></span><br><span class="line">kd&gt; rdmsr <span class="number">0x489</span></span><br><span class="line">msr[<span class="number">489</span>] = <span class="number">00000000</span>`<span class="number">003727f</span>f</span><br><span class="line">kd&gt; .formats <span class="number">0x00000000</span>`<span class="number">003727f</span>f</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     <span class="number">00000000</span>`<span class="number">003727f</span>f</span><br><span class="line">  Decimal: <span class="number">3614719</span></span><br><span class="line">  Octal:   <span class="number">0000000000000015623777</span></span><br><span class="line">  Binary:  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00110111</span> <span class="number">00100111</span> <span class="number">11111111</span></span><br></pre></td></tr></table></figure>

<p>CR0 置位：PE(bit0) 保护模式，NE(bit5) x87 FPU，PG(bit31)分页。</p>
<p>CR4 置位：VMXE(bit13)。</p>
</li>
<li><p>A20M 模式。</p>
<p>当处理器处于 A20M 模式（即 A20 线 mask 模式），也不允许进入 VMX operation 模式，执行 VMXON 指令将引发 #GP 异常。A20M 模式会屏蔽 A20 地址线产生所谓的 “wrapping” 现象，从而模拟 8086 处理器的 IM地址内访问行为。A20M 模式主要由旧操作系统使用，而不是现代操作系统使用。在较新的英特尔 64 处理器上，A20M# 可能不存在。</p>
</li>
</ol>
<h3 id="3-7-总结"><a href="#3-7-总结" class="headerlink" title="3.7 总结"></a>3.7 总结</h3><p>综上所述关于 CPU 是否支持 VMX，支持的话就启用 VMX。</p>
<p>使用 <code>VMXON</code> 指令前对 CPU 状态进行检查，符合要求才可以使用该指令。封装成以下两个函数。 </p>
<p>因为逻辑判断较多，用汇编写这部分函数反而效率低，还是用 C 写更快一些。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://learn.microsoft.com/zh-cn/cpp/intrinsics/cpuid-cpuidex?view=msvc-170</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSR_IA32_FEATURE_CONTROL 0x3A</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IA32_VMX_CR0_FIXED0 0x486</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IA32_VMX_CR0_FIXED1 0x487</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IA32_VMX_CR4_FIXED0 0x488</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IA32_VMX_CR4_FIXED1 0x489</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CPUID</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG EAX;</span><br><span class="line">    ULONG EBX;</span><br><span class="line">    ULONG ECX;</span><br><span class="line">    ULONG EDX;</span><br><span class="line">&#125; CPUID, *PCPUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">IA32_FEATURE_CONTROL_MSR</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG64 All;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG64 Lock : <span class="number">1</span>;                <span class="comment">// [0]</span></span><br><span class="line">        ULONG64 EnableSMX : <span class="number">1</span>;           <span class="comment">// [1]</span></span><br><span class="line">        ULONG64 EnableVmxon : <span class="number">1</span>;         <span class="comment">// [2]</span></span><br><span class="line">        ULONG64 Reserved1 : <span class="number">5</span>;           <span class="comment">// [3-7]</span></span><br><span class="line">        ULONG64 EnableLocalSENTER : <span class="number">7</span>;   <span class="comment">// [8-14]</span></span><br><span class="line">        ULONG64 EnableGlobalSENTER : <span class="number">1</span>;  <span class="comment">// [15]</span></span><br><span class="line">        ULONG64 Reserved2 : <span class="number">1</span>;           <span class="comment">// [16]</span></span><br><span class="line">        ULONG64 EnableSGXLanch : <span class="number">1</span>;      <span class="comment">// [17]</span></span><br><span class="line">        ULONG64 EnableSGXGlobal : <span class="number">1</span>;     <span class="comment">// [18]</span></span><br><span class="line">        ULONG64 Reserved3 : <span class="number">1</span>;           <span class="comment">// [19]</span></span><br><span class="line">        ULONG64 LMCEOn : <span class="number">1</span>;              <span class="comment">// [20]</span></span><br><span class="line">        ULONG64 Reserved4 : <span class="number">43</span>;          <span class="comment">// [21-63]</span></span><br><span class="line">    &#125; Fields;</span><br><span class="line">&#125; IA32_FEATURE_CONTROL_MSR, *PIA32_FEATURE_CONTROL_MSR;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 1. Detect this CPU is Intel or not.</span></span><br><span class="line"><span class="comment">// 2. If CPU support VME: CPUID.01H:ECX.VMX[bit5] == 1, set CR4.VMXE(bit13) to 1. </span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">DetectVMXSupportAndEnableCr4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CPUID Cpuid = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ULONG64 Cr4 = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// detect cpu is intel or not.</span></span><br><span class="line">	__cpuid(&amp;Cpuid, <span class="number">0x0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Intel: Genuntelinel</span></span><br><span class="line">	<span class="comment">// test CPUID.00H, RBX+RDX+RCX = Genuntelinel ?</span></span><br><span class="line">	<span class="keyword">if</span> (Cpuid.EBX == <span class="number">0x756E6547</span> &amp;&amp; Cpuid.ECX == <span class="number">0x6C65746E</span> &amp;&amp; Cpuid.EDX == <span class="number">0x49656E69</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		RtlSecureZeroMemory((PVOID)&amp;Cpuid, <span class="keyword">sizeof</span>(CPUID));</span><br><span class="line">		__cpuid(&amp;Cpuid, <span class="number">0x1</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// test CPUID.01H:ECX.VMX[bit 5] = 1 ?</span></span><br><span class="line">		<span class="keyword">if</span>(_bittest(&amp;Cpuid.ECX, <span class="number">5</span>) == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DbgPrint(<span class="string">&quot;[*] This CPU support VMX!\n&quot;</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Enable cr4 register, set cr4.VMXE(bit 13) = 1</span></span><br><span class="line">			Cr4 = __readcr4();</span><br><span class="line">			_bittestandset((PLONG)&amp;Cr4, <span class="number">13</span>);</span><br><span class="line">			__writecr4(Cr4);</span><br><span class="line">			<span class="keyword">return</span> TRUE;</span><br><span class="line">		&#125;<span class="keyword">else</span> DbgPrint(<span class="string">&quot;[*] This CPU Not support VMX!\n&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> DbgPrint(<span class="string">&quot;[*] This CPU Not Intel!\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 1. Detect IA32_FEATURE_CONTROL(0x3A) lock(bit0), EnableSMX(bit1), EnableVmxon(bit2) and set.</span></span><br><span class="line"><span class="comment">// 2. If bit X is 1 in FIXED0, then set that bits of CR0 and CR4 to 1.</span></span><br><span class="line"><span class="comment">// 3. If bit X is 0 in FIXED1, then set that bits of CR0 and CR4 to 0.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">SetEntryVMXoperationCondition</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IA32_FEATURE_CONTROL_MSR MsrControl = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	CPUID Cpuid = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ULONG64 Cr0, Cr4 = <span class="number">0</span>;</span><br><span class="line">	BOOLEAN InSMXmode = FALSE;</span><br><span class="line">	ULONG64 Cr0Fixed0, Cr0Fixed1, Cr4Fixed0, Cr4Fixed1 = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// detect CPU in SMX mode or not.</span></span><br><span class="line">	__cpuid(&amp;Cpuid, <span class="number">0x1</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(_bittest((PLONG)&amp;Cpuid.ECX, <span class="number">6</span>) == <span class="number">1</span>) <span class="comment">// support SMX mode</span></span><br><span class="line">	&#123;</span><br><span class="line">		Cr4 = __readcr4();</span><br><span class="line">		<span class="keyword">if</span>(_bittest((PLONG)&amp;Cr4, <span class="number">14</span>) == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			InSMXmode = TRUE;</span><br><span class="line">			DbgPrint(<span class="string">&quot;[*] This CPU in SMX mode.\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			InSMXmode = FALSE;</span><br><span class="line">			DbgPrint(<span class="string">&quot;[*] This CPU NOT in SMX mode.\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// read MSR_IA32_FEATURE_CONTROL MSR register.</span></span><br><span class="line">	<span class="comment">// set Lock, EnableSMX, EnableVmxon.</span></span><br><span class="line">	MsrControl.All = __readmsr(MSR_IA32_FEATURE_CONTROL);</span><br><span class="line">	<span class="keyword">if</span>(MsrControl.Fields.Lock == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(InSMXmode)</span><br><span class="line">		&#123;</span><br><span class="line">			MsrControl.Fields.Lock = <span class="number">1</span>;</span><br><span class="line">			MsrControl.Fields.EnableSMX = <span class="number">1</span>;</span><br><span class="line">			__writemsr(MSR_IA32_FEATURE_CONTROL, MsrControl.All);</span><br><span class="line">			DbgPrint(<span class="string">&quot;[*] Set entry VMX operation condition inside SMX mode OK.&quot;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			MsrControl.Fields.Lock = <span class="number">1</span>;</span><br><span class="line">			MsrControl.Fields.EnableVmxon = <span class="number">1</span>;</span><br><span class="line">			__writemsr(MSR_IA32_FEATURE_CONTROL, MsrControl.All);</span><br><span class="line">			DbgPrint(<span class="string">&quot;[*] Set entry VMX operation condition outside SMX mode OK.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (MsrControl.Fields.EnableVmxon == FALSE)	<span class="comment">// lock = 1, but EnableVmxon = 0</span></span><br><span class="line">    &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[*] VMX locked off in BIOS&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// set CR0, CR4 according to FIXED0 and FIXED1.</span></span><br><span class="line">	Cr0Fixed0 = __readmsr(IA32_VMX_CR0_FIXED0);</span><br><span class="line">	Cr0Fixed1 = __readmsr(IA32_VMX_CR0_FIXED1);</span><br><span class="line">	Cr4Fixed0 = __readmsr(IA32_VMX_CR4_FIXED0);</span><br><span class="line">	Cr4Fixed1 = __readmsr(IA32_VMX_CR4_FIXED1);</span><br><span class="line">	Cr0 = __readcr0();</span><br><span class="line">	Cr4 = __readcr4();</span><br><span class="line">	</span><br><span class="line">	Cr0 |= Cr0Fixed0;</span><br><span class="line">	Cr0 &amp;= Cr0Fixed1;</span><br><span class="line">	Cr4 |= Cr4Fixed0;</span><br><span class="line">	Cr4 &amp;= Cr4Fixed1;</span><br><span class="line">	</span><br><span class="line">	__writecr0(Cr0);</span><br><span class="line">	__writecr4(Cr4);</span><br><span class="line">	</span><br><span class="line">	DbgPrint(<span class="string">&quot;[*] Now you can entry VMX operation.&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="4-VMXON-region"><a href="#4-VMXON-region" class="headerlink" title="4 VMXON region"></a>4 VMXON region</h2><h3 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h3><p>在 VMX 架构下，至少需要实现一个被称为 <mark class="label danger">VMXON region</mark>，以及一个被称为 <mark class="label success">VMCS region</mark> 的物理区域。在使用 <code>VMXON</code> 指令进入 VMX root operation 前，需要为逻辑处理器分配一块<strong>物理内存</strong>区域作为 VMXON 区域。</p>
<p>VMM 需要用一个被称为 VMIXON region 的区域来管理整个 VMX operation 模式，<strong>VMXON 区域大小及所支持的 cache 类型与 VMCS 区域是一致的</strong>。指向 VMXON 区域的指针被称为 VMXON-point（指向物理地址）。VMXON 区域的物理指针需要作为操作数提供给 <code>VMXON</code> 指令。 <code>VMXON</code> 指令的<strong>操作数是物理地址</strong>。指令格式：<code>VMXON VMXON-point</code>。</p>
<ul>
<li>VMXON region，对应于 VMM。对 VMM 进行一些记录或者维护工作。</li>
<li>VMCS region，对应于 VM 中的一个虚拟处理器（逻辑处理器）。</li>
</ul>
<p>关于 VMXON region 有以下几点需要注意：</p>
<ol>
<li>存放 VMXON region 区域的物理内存需要对齐在 4KB 字节边界上（bits 11:0 为 0）。</li>
<li>VMXON region 和  VMCS region 的<strong>大小</strong>、<strong>内存 Cache 类型</strong>都来自 <code>IA32_VMX_BASIC(0x480)</code> MSR 寄存器。</li>
</ol>
<h3 id="4-2-IA32-VMX-BASIC"><a href="#4-2-IA32-VMX-BASIC" class="headerlink" title="4.2 IA32_VMX_BASIC"></a>4.2 IA32_VMX_BASIC</h3><p><code>IA32_VMX_BASIC(0x480)</code> MSR 寄存器如下：</p>
<p><img data-src="https://s2.loli.net/2023/04/15/5cyNYBezLA6PXtT.png" alt="13.png"></p>
<p>Intel 卷3 Table A-1, 24.2 指出当前支持 VMX operation 模式的 CPU 使用的都是 write-back 类型，可使用 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/wdm/nf-wdm-mmallocatecontiguousmemoryspecifycache">MmAllocateContiguousMemorySpecifyCache</a> 函数来申请。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Buffer = MmAllocateContiguousMemorySpecifyCache(VMXONSize, Lowest, Highest, Lowest, MmNonCached);</span><br></pre></td></tr></table></figure>

<ul>
<li>Write-through：直写或透写。CPU 向 Cache 写入数据时，同时向内存也写一份，使 Cache 和内存的数据保持一致。</li>
<li>Write-back：回写。CPU 只将数据写入 Cache 不写入内存。只在数据被替换出缓存时，被修改的缓存数据才会被写到内存(flush)。</li>
</ul>
<p><img data-src="https://s2.loli.net/2023/04/19/jUmipvGlJWbCsYO.png" alt="22.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; rdmsr <span class="number">0x480</span></span><br><span class="line">msr[<span class="number">480</span>] = <span class="number">00</span>da1000`<span class="number">00000004</span></span><br><span class="line">kd&gt; .formats <span class="number">0x00da1000</span>`<span class="number">00000004</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     <span class="number">00</span>da1000`<span class="number">00000004</span></span><br><span class="line">  Decimal: <span class="number">61379137108967428</span></span><br><span class="line">  Octal:   <span class="number">0003320400000000000004</span></span><br><span class="line">  Binary:  <span class="number">00000000</span> <span class="number">11011010</span> <span class="number">00010000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000100</span></span><br></pre></td></tr></table></figure>



<h3 id="4-3-申请-VMXON-region"><a href="#4-3-申请-VMXON-region" class="headerlink" title="4.3 申请 VMXON region"></a>4.3 申请 VMXON region</h3><p>在使用 <code>VMXON</code> 指令进入 VMX root operation 模式前，除了上述章节 2 中支持 VMX 的条件得到满足外，还需要准备好一块物理内存，填充部分字段进行初始化后，才能使用 <code>VMXON</code> 指令。<code>VMXON</code> 指令执行完成后，处理器会将 VMM 相关状态信息保存在 VMXON region 中，Intel 并没有公开 VMXON region 的具体内容。</p>
<div class="note info"><p>按照 Intel 卷3 24.11.5 指出，初始化  VMXON region 时，只需要将 31 bits 的 VMCS revision identifier 写入  VMXON region 前 4 字节即可，然后  VMXON region 的 <code>bit 31 = 0</code>，接着就可以使用 <code>VMXON</code> 指令了。</p>
</div>

<p>注意：<mark class="label info">在执行 VMXON 和 VMXOFF 的整个期间都不能通过软件的方式修改 VMXON region 的值</mark>。</p>
<p>申请步骤如下：</p>
<ol>
<li>通过 <code>IA32_VMX_BASIC[44:32]</code> 得到 VMXON region 所需<strong>空间大小</strong>。</li>
<li>通过 <code>IA32_VMX_BASIC[53:50]</code> 得到 VMXON region 所需<strong>内存类型</strong>，如 write-back。</li>
<li>调用 <code>MmAllocateContiguousMemorySpecifyCache</code> 函数申请连续指定大小和类型的物理内存。</li>
<li>判断返回地址是否在边界对齐 4KB（bit 11:0 为 0）。</li>
<li>将 <code>IA32_VMX_BASIC[31:0]</code> 的 VMCS revision identifier 写入  VMXON region 前 4 字节。</li>
<li>将 VMXON region 的 <code>bit 31 = 0</code>。</li>
<li>使用 <code>VMXON</code> 进入 VMX root operation（使用 <code>__vmx_on</code> 函数）。如果 <code>VMXON</code> 指令执行失败，则有 <code>Rflags.CF = 1</code>。</li>
<li>判断 <code>__vmx_on</code> 函数的返回值是否是 <code>TRUE</code>。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSR_IA32_VMX_BASIC 0x480</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">VIRTUAL_MACHINE_STATE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">// BOOLEAN IsOnVmxRootMode;		// Detects whether the current logical core is on Executing on VMX Root Mode</span></span><br><span class="line">	<span class="comment">// BOOLEAN IncrementRip;		// Checks whether it has to redo the previous instruction or not (it used mainly in Ept routines)</span></span><br><span class="line">	<span class="comment">// BOOLEAN HasLaunched;			// Indicate whether the core is virtualized or not</span></span><br><span class="line">	ULONG64 VmxonRegionPhysicalAddress;	<span class="comment">// VMXON region physical address</span></span><br><span class="line">	ULONG64 VmxonRegionVirtualAddress;	<span class="comment">// VMXON region virtual address</span></span><br><span class="line">	<span class="comment">// ULONG64 VmcsRegionPhysicalAddress;	// VMCS region physical address</span></span><br><span class="line">	<span class="comment">// ULONG64 VmcsRegionVirtualAddress;	// VMCS region virtual address</span></span><br><span class="line">	<span class="comment">// ULONG64 VmmStack;			// Stack for VMM in VM-Exit State</span></span><br><span class="line">	<span class="comment">// ULONG64 MsrBitmapVirtualAddress;	// Msr Bitmap Virtual Address</span></span><br><span class="line">	<span class="comment">// ULONG64 MsrBitmapPhysicalAddress;	// Msr Bitmap Physical Address</span></span><br><span class="line">	<span class="comment">// VMX_VMXOFF_STATE VmxoffState;	// Shows the vmxoff state of the guest</span></span><br><span class="line">	<span class="comment">// PEPT_HOOKED_PAGE_DETAIL MtfEptHookRestorePoint;	// It shows the detail of the hooked paged that should be restore in MTF vm-exit</span></span><br><span class="line">&#125; VIRTUAL_MACHINE_STATE, * PVIRTUAL_MACHINE_STATE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">IA32_VMX_BASIC_MSR</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	ULONG64 All;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		ULONG64 RevisionIdentifier : <span class="number">31</span>;   <span class="comment">// [0-30]</span></span><br><span class="line">		ULONG64 Reserved1 : <span class="number">1</span>;             <span class="comment">// [31]</span></span><br><span class="line">		ULONG64 RegionSize : <span class="number">13</span>;           <span class="comment">// [32-44]</span></span><br><span class="line">		ULONG64 Reserved2 : <span class="number">3</span>;             <span class="comment">// [45-47]</span></span><br><span class="line">		ULONG64 SupportedIA64 : <span class="number">1</span>;         <span class="comment">// [48]</span></span><br><span class="line">		ULONG64 SupportedDualMoniter : <span class="number">1</span>;  <span class="comment">// [49]</span></span><br><span class="line">		ULONG64 MemoryType : <span class="number">4</span>;            <span class="comment">// [50-53]</span></span><br><span class="line">		ULONG64 VmExitReport : <span class="number">1</span>;          <span class="comment">// [54]</span></span><br><span class="line">		ULONG64 VmxCapabilityHint : <span class="number">1</span>;     <span class="comment">// [55]</span></span><br><span class="line">		ULONG64 VmxDeliverExceptionToVmm : <span class="number">1</span>;	<span class="comment">// [56]</span></span><br><span class="line">		ULONG64 Reserved3 : <span class="number">7</span>;             <span class="comment">// [57-63]</span></span><br><span class="line">	&#125; Fields;</span><br><span class="line">&#125; IA32_VMX_BASIC_MSR, * PIA32_VMX_BASIC_MSR;</span><br><span class="line"></span><br><span class="line">PVIRTUAL_MACHINE_STATE g_pGuestState = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 1. 通过 IA32_VMX_BASIC[44:32] 得到 VMXON region 所需空间大小。</span></span><br><span class="line"><span class="comment">// 2. 通过 IA32_VMX_BASIC[53:50] 得到 VMXON region 所需内存类型，如 write-back。</span></span><br><span class="line"><span class="comment">// 3. 调用 MmAllocateContiguousMemorySpecifyCache 函数申请连续指定大小和类型的物理内存。</span></span><br><span class="line"><span class="comment">// 4. 判断返回地址是否在边界对齐 4KB（bit 11:0 为 0）。</span></span><br><span class="line"><span class="comment">// 5. 将 IA32_VMX_BASIC[31:0] 的 VMCS revision identifier 写入 VMXON region 前 4 字节。</span></span><br><span class="line"><span class="comment">// 6. 将 VMXON region 的 bit 31 = 0。</span></span><br><span class="line"><span class="comment">// 5. Write VMXON region lowest 4 bytes from IA32_VMX_BASIC[31:0] that VMCS revision identifier.</span></span><br><span class="line"><span class="comment">// 6. Set VMXON region bit 31 to 0.</span></span><br><span class="line"><span class="comment">// 7. 使用 VMXON 进入 VMX root operation（使用 __vmx_on 函数）。</span></span><br><span class="line"><span class="comment">// 8. 判断 __vmx_on 函数的返回值是否是 TRUE。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">VmxAllocateVmxonRegion</span><span class="params">(VIRTUAL_MACHINE_STATE * CurrentGuestState)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG VmxRegionSize = <span class="number">0</span>;</span><br><span class="line">	UCHAR VmxRegionType = <span class="number">0</span>;</span><br><span class="line">	PVOID pVmxRegion_VA = <span class="number">0</span>;</span><br><span class="line">	PHYSICAL_ADDRESS pVmxRegion_Phy = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	PHYSICAL_ADDRESS Lowphys = &#123; <span class="number">0</span> &#125;, Highphys = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	ULONG64 uAlignVirtualAddress = <span class="number">0</span>;</span><br><span class="line">	ULONG64 uAlignPhysicalAddress = <span class="number">0</span>;</span><br><span class="line">	IA32_FEATURE_CONTROL_MSR MsrControl = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// get the Vmx region size and type.</span></span><br><span class="line">	IA32_VMX_BASIC_MSR MsrVmxBasic = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	MsrVmxBasic.All = __readmsr(MSR_IA32_VMX_BASIC);</span><br><span class="line">	<span class="keyword">if</span>(MsrVmxBasic.All)</span><br><span class="line">	&#123;</span><br><span class="line">		VmxRegionSize = (MsrVmxBasic.All &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0x1FFF</span>;</span><br><span class="line">		VmxRegionType = (MsrVmxBasic.All &gt;&gt; <span class="number">50</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(VmxRegionSize != PAGE_SIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : The VMX region size is error getting from IA32_VMX_BASIC[44:32].&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">// PVOID MmAllocateContiguousMemorySpecifyCache(</span></span><br><span class="line">		<span class="comment">// [in]           SIZE_T              NumberOfBytes,</span></span><br><span class="line">		<span class="comment">// [in]           PHYSICAL_ADDRESS    LowestAcceptableAddress,</span></span><br><span class="line">		<span class="comment">// [in]           PHYSICAL_ADDRESS    HighestAcceptableAddress,</span></span><br><span class="line">		<span class="comment">// [in, optional] PHYSICAL_ADDRESS    BoundaryAddressMultiple,</span></span><br><span class="line">		<span class="comment">// [in]           MEMORY_CACHING_TYPE CacheType</span></span><br><span class="line">		<span class="comment">// );</span></span><br><span class="line">		Lowphys.QuadPart = <span class="number">0</span>;</span><br><span class="line">		Highphys.QuadPart = <span class="number">-1</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">switch</span>(VmxRegionType)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:	<span class="comment">// uncache</span></span><br><span class="line">				pVmxRegion_VA = MmAllocateContiguousMemorySpecifyCache(VmxRegionSize*<span class="number">2</span>, Lowphys, Highphys, Lowphys, MmNonCached);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">6</span>:	<span class="comment">// write-back</span></span><br><span class="line">				pVmxRegion_VA = MmAllocateContiguousMemorySpecifyCache(VmxRegionSize*<span class="number">2</span>, Lowphys, Highphys, Lowphys, MmCached);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(pVmxRegion_VA == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			DbgPrint(<span class="string">&quot;[*] Error : Couldn&#x27;t Allocate Buffer for VMXON Region.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> FALSE;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		RtlSecureZeroMemory(pVmxRegion_VA, VmxRegionSize);</span><br><span class="line">		pVmxRegion_Phy = MmGetPhysicalAddress(pVmxRegion_VA);</span><br><span class="line">		uAlignVirtualAddress = (ULONG64)pVmxRegion_VA;</span><br><span class="line">		uAlignPhysicalAddress = (ULONG64)pVmxRegion_Phy.QuadPart;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// align the physical address to 0x1000(bit 11:0 to 0)</span></span><br><span class="line">		<span class="comment">// the address align formula: if align to n bytes,(address + n-1) &amp; (~(n-1))</span></span><br><span class="line">		<span class="comment">// https://catecat.top/post/WinXP-Struct/</span></span><br><span class="line">		uAlignPhysicalAddress = ((ULONG64)uAlignPhysicalAddress + PAGE_SIZE - <span class="number">1</span>) &amp; (~(PAGE_SIZE - <span class="number">1</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span>((uAlignPhysicalAddress &amp; <span class="number">0xFFF</span> != <span class="number">0</span>) &amp;&amp; ((ULONG64)uAlignPhysicalAddress - (ULONG64)pVmxRegion_Phy.QuadPart &lt;= PAGE_SIZE))</span><br><span class="line">		&#123;</span><br><span class="line">			uAlignPhysicalAddress++;</span><br><span class="line">			uAlignPhysicalAddress = ((ULONG64)uAlignPhysicalAddress + PAGE_SIZE - <span class="number">1</span>) &amp; (~(PAGE_SIZE - <span class="number">1</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">while</span>(uAlignPhysicalAddress &amp; <span class="number">0xFFF</span> != <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(uAlignVirtualAddress == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : MmGetVirtualForPhysical have a fault in VmxAllocateVmxonRegion function.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	pVmxRegion_Phy.QuadPart = uAlignPhysicalAddress;</span><br><span class="line">	uAlignVirtualAddress = (ULONG64)MmGetVirtualForPhysical(pVmxRegion_Phy);</span><br><span class="line">	</span><br><span class="line">	CurrentGuestState-&gt;VmxonRegionVirtualAddress = uAlignVirtualAddress;</span><br><span class="line">	CurrentGuestState-&gt;VmxonRegionPhysicalAddress = uAlignPhysicalAddress;</span><br><span class="line">	</span><br><span class="line">	DbgPrint(<span class="string">&quot;[*] Virtual allocated buffer for VMXON at %llx\n&quot;</span>, pVmxRegion_VA);</span><br><span class="line">	DbgPrint(<span class="string">&quot;[*] Virtual aligned allocated buffer for VMXON at %llx\n&quot;</span>, uAlignVirtualAddress);</span><br><span class="line">	DbgPrint(<span class="string">&quot;[*] Aligned physical buffer allocated for VMXON at %llx\n&quot;</span>, uAlignPhysicalAddress);</span><br><span class="line">	</span><br><span class="line">	*(PULONG64)uAlignVirtualAddress = MsrVmxBasic.Fields.RevisionIdentifier;</span><br><span class="line">	_bittestandreset64((PULONG64)uAlignVirtualAddress, <span class="number">31</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> TRUE;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 1. Call DetectVMXSupportAndEnableCr4, SetEntryVMXoperationCondition functions.</span></span><br><span class="line"><span class="comment">// 2. Check MSR_IA32_FEATURE_CONTROL lock, EnableSMX, EnableVmxon bits.</span></span><br><span class="line"><span class="comment">// 3. Check FIXED0 and FIXED1 correspondingly bits in CR0, CR4.</span></span><br><span class="line"><span class="comment">// 4. Call VmxAllocateVmxonRegion function.</span></span><br><span class="line"><span class="comment">// 5. Use VMXON instruction into VMX root operation（use the __vmx_on function）。</span></span><br><span class="line"><span class="comment">// 6. Check the return value is TRUE about __vmx_on function or not.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">EnableVmxon</span><span class="params">(IN VIRTUAL_MACHINE_STATE * CurrentGuestState)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG64 Cr0, Cr4 = <span class="number">0</span>;</span><br><span class="line">	ULONG64 Cr0Fixed0 = <span class="number">0</span>, Cr0Fixed1 = <span class="number">0</span>, Cr4Fixed0 = <span class="number">0</span>, Cr4Fixed1 = <span class="number">0</span>;</span><br><span class="line">	IA32_FEATURE_CONTROL_MSR MsrFeatureControl = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(DetectVMXSupportAndEnableCr4() == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : DetectVMXSupportAndEnableCr4 have fault.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(SetEntryVMXoperationCondition() == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : SetEntryVMXoperationCondition have fault.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	MsrFeatureControl.All = __readmsr(MSR_IA32_FEATURE_CONTROL);</span><br><span class="line">	<span class="keyword">if</span>(MsrFeatureControl.All != <span class="number">3</span> || MsrFeatureControl.All != <span class="number">5</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : The MSR_IA32_FEATURE_CONTROL MSR lock, EnableSMX, EnableVmxon bits have fault.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	Cr0Fixed0 = __readmsr(MSR_IA32_VMX_CR0_FIXED0);</span><br><span class="line">	Cr0Fixed1 = __readmsr(MSR_IA32_VMX_CR0_FIXED1);</span><br><span class="line">	Cr4Fixed0 = __readmsr(MSR_IA32_VMX_CR4_FIXED0);</span><br><span class="line">	Cr4Fixed1 = __readmsr(MSR_IA32_VMX_CR4_FIXED1);</span><br><span class="line">	Cr0 = __readcr0();</span><br><span class="line">	Cr4 = __readcr4();</span><br><span class="line">	<span class="keyword">if</span>((Cr0Fixed0 &amp; Cr0 != Cr0Fixed0) || (Cr4Fixed0 &amp; Cr4 != Cr4Fixed0) || (Cr0Fixed1 | Cr0 != Cr0Fixed1) || (Cr4Fixed1 | Cr4 != Cr4Fixed1))</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : FIXED0 and FIXED1 correspondingly bits in CR0, CR4.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(VmxAllocateVmxonRegion(g_pGuestState) == FALSE)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : VmxAllocateVmxonRegion have fault.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (__vmx_on((PULONG)&amp;g_pGuestState-&gt;VmxonRegionPhysicalAddress) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;[*] Error : VMXON launch failed.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>__vmx_ on</strong> 是执行 <code>VMXON</code> 的函数。返回值显示不同的含义。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>操作成功。</td>
</tr>
<tr>
<td>1</td>
<td>操作失败，当前VMCS的<code>VM-instructionerrorfield</code>中提供了扩展状态。</td>
</tr>
<tr>
<td>2</td>
<td>操作失败，状态不可用。</td>
</tr>
</tbody></table>
<p>参考资料：</p>
<ul>
<li>处理器虚拟化技术（邓志）</li>
<li>New Blue Pill 深入理解硬件虚拟机</li>
<li>加密与解密第 4 版 Chapter 10</li>
<li>Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 3 (3A, 3B, 3C &amp; 3D): System Programming Guide Chapter 23</li>
</ul>
<h2 id="5-逻辑处理器"><a href="#5-逻辑处理器" class="headerlink" title="5 逻辑处理器"></a>5 逻辑处理器</h2><ul>
<li><p><strong>处理器</strong>（Processor）：物理处理器，一个处理器上可以有多个核心（Core），常见的就是一个处理器上有两核心。</p>
</li>
<li><p><strong>核心</strong>（Core）：每个核心都有一套自己的寄存器，各个核心可以并行执行指令（同一时间同时执行指令）。</p>
</li>
<li><p><strong>逻辑处理器</strong>（Logical Processor，LP）：是机器可以同时处理的线程数，实际上 <code>1 core == 1 logical processor(LP)</code>。</p>
</li>
<li><p>在虚拟化中：一个虚拟处理器（ Virtual Processor ，VP）也叫做 Virtual CPU（vCPU），就是一个 Physical Core（PC）。</p>
<p>所以有以下等式：</p>
<p><code>1 VP == 1 vCPU == 1 core(PC) == 1 LP</code>。</p>
<ul>
<li>LP：Logical Processor，逻辑处理器。</li>
<li>VP：Virtual Processor，虚拟处理器。</li>
<li>vCPU：Virtual CPU，虚拟 CPU。</li>
<li>PC：Physical Core，物理核心。</li>
</ul>
</li>
</ul>
<p>我们使用的一个 VMX region、VMCS region 对应一个逻辑处理器</p>
<blockquote>
<p><strong>Processor</strong></p>
<p>When I say <strong><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Processor_(computing)">processor</a></strong> I’m referring to the physical hardware. The component responsible for all processing operations. A machine can have more than one processor, just as some servers have a bi-processor setup. This is also referred to as a socket, CPU, or package.</p>
<p><strong>Core</strong></p>
<p>Within a physical processor there is an operation unit called a <strong><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multi-core_processor">core</a></strong>. It’s often said that a core is like a processor, so a single processor with 2 cores means it has a single physical piece of hardware with two independent processing units that can fetch and execute instructions. Most processors today are multi-core.</p>
<p><strong>Logical Processor</strong></p>
<p>A <strong><a target="_blank" rel="noopener" href="http://www.directionsonmicrosoft.com/licensing/30-licensing/3420-sql-server-2012-adopts-per-core-licensing-model.html">logical processor</a></strong> is the number of threads a machine can handle at the same time. This is an abstraction of a processor, at least on Windows. It’s able to fetch and execute its own stream of instructions in the same processor time slot. The number of logical processors on your machine can be found by multiplying the number of physical cores by the thread count.</p>
<p>In virtualization literature you may see the term <strong><a target="_blank" rel="noopener" href="https://whatis.techtarget.com/definition/virtual-CPU-vCPU">virtual processor</a></strong> (VP) used, however, by today’s standards a virtual processor is equivalent to a physical core. That means if you need to allocate a number of virtual processors for your virtual machine you determine the number of cores in your physical processor and assign however many that is. If I have a quad core processor, I allocate 4 virtual processors to the virtual machine. In this series, we start with a single processor setup, and then move to support a multi-processor environment – and to do that we must have control structures allocated for each core so that we can manage the virtual processor state.</p>
<p>——<a target="_blank" rel="noopener" href="https://revers.engineering/day-2-entering-vmx-operation/">Day 2: Entering VMX Operation, Explaining Implementation Requirements</a></p>
</blockquote>
<p>虚拟地址（VA)： 指 Guest OS 提供给其应用程序使用的线性地址空间。<br>物理地址(PA)：  经 VMM 抽象的、虚拟机看到的伪物理地址。<br>机器地址（MA)：真实的机器地址，即地址总线上出现的地址信号。</p>
<p>这样的话，会存在两张页表：</p>
<ul>
<li>VMM 维护一张页表，负责 PA 到 MA 的映射。$VMM:MA &#x3D; g(PA)$。</li>
<li>Guest OS 维护一张页表，负责 VA 到 PA 的映射。$Guest\ OS:PA &#x3D; f(VA)$。</li>
</ul>
<ol>
<li><a target="_blank" rel="noopener" href="http://front.sjtu.edu.cn/~jinyh/OS_guest/Virtualization.pdf">交大课件</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.nsfocus.net/malicious-sample-analysis-manual-virtual-machine-test-top/">恶意样本分析手册-虚拟机检测篇（上）</a></li>
<li><a target="_blank" rel="noopener" href="https://rayanfam.com/tutorials/">Hypervisor From Scratch</a></li>
<li><a target="_blank" rel="noopener" href="https://www.4hou.com/posts/BRQk">从头开始了解和使用Hypervisor（第1部分）</a></li>
<li>加密与解密第四版</li>
<li>Windows Internals 7</li>
<li>Virtualization Essentials 3(Matthew Portnoy)</li>
<li>New Blue Pill</li>
<li><a target="_blank" rel="noopener" href="https://revers.engineering/mmu-ept-technical-details/">MMU Virtualization Via Intel EPT: Technical Details</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cs.toronto.edu/~delara/courses/ece1779/handouts/virtualization_slides.pdf">N. Sahgal, D. Rodgers, Unclerstanding Intel Virtualization Technology</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/Windows10-x64-hypervisor-1/" title="Hypervisor（一）：VMX 架构与 VMXON region">https://directoree.github.io/post/Windows10-x64-hypervisor-1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Windows%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> Windows内核</a>
              <a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag"><i class="fa fa-tag"></i> 虚拟化</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/Kernel-Patch-Protection3/" rel="prev" title="内核补丁保护（三）触发 PG 检查">
                  <i class="fa fa-chevron-left"></i> 内核补丁保护（三）触发 PG 检查
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/Windows10-x64-hypervisor-2/" rel="next" title="Hypervisor（二）：VMCS region">
                  Hypervisor（二）：VMCS region <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">18:21</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>








<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script data-pjax>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '70px',
  right: 'unset',
  left: '16px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#222',
  buttonColorLight: '#222',
  saveInCookies: false,
  label: '',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  if (toggleButtons && toggleButtons.length > 0) {
    for (i = 0; i < toggleButtons.length; i++) {
      toggleButtons[i].classList.add("darkmode-toggle--white");
    }
  }
}
</script>

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/Windows10-x64-hypervisor-1/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
