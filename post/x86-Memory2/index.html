<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ğŸ˜„">
<meta property="og:type" content="article">
<meta property="og:title" content="x86 å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰ç§æœ‰å†…å­˜-å…±äº«å†…å­˜-ç‰©ç†å†…å­˜">
<meta property="og:url" content="https://directoree.github.io/post/x86-Memory2/index.html">
<meta property="og:site_name" content="Ë—Ë‹Ëâ™¡ËËŠË—">
<meta property="og:description" content="ğŸ˜„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/yoxQT1VZiSzdCDW.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/XtBhPw5dEJUy9oK.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/XBNtEFcw3f7OaWn.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/ELUCylM1neu7Bmd.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/qVPyK2LmSribcTt.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/13/A7oTHyE5hvWPRVj.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/2BWpCvei3fbJ6tz.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/15/LJ6BHmSiZaKsqM1.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/20/rzK8iQdO4D21TER.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/22/vafHMNWZi6U8bkY.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/15/7lpKhndRtaiJYrs.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/13/kI3UpiP4vx8as5Q.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/oes68xkmvpQBc5J.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/16/s5LJR4fForSVUci.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/16/jaE71MS9ylmR4nI.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/17/KPqWhvGFib6asro.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/19/oZlgijpwkI3EQqh.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/nIzl2HFJRX5OKam.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/8LAd1QcKhUpxHSY.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/b1qF2h9TYySRGmD.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/vaLGTWrONI9l8Ku.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/LB7bekR18TanqCF.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/mPz7AuWVfl2YCOJ.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/6JLlha4kA9nwBuD.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/VksKUSpejFOHciA.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/jqom3Dwup4Cysrb.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/ouCj1v2DJwVdl8Y.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/nvXEz8kPMuxiqJV.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/24/M3651Rt2CLOwPhq.png">
<meta property="article:published_time" content="2022-09-13T14:21:52.000Z">
<meta property="article:modified_time" content="2024-01-03T11:30:29.604Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="WinXPå†…æ ¸">
<meta property="article:tag" content="x86å†…å­˜ç®¡ç†">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png">


<link rel="canonical" href="https://directoree.github.io/post/x86-Memory2/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>x86 å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰ç§æœ‰å†…å­˜-å…±äº«å†…å­˜-ç‰©ç†å†…å­˜ | Ë—Ë‹Ëâ™¡ËËŠË—</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#222;--content-bg-color:#222;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#2d2f31;--highlight-foreground:#ccc;--highlight-gutter-background:#333;--highlight-gutter-foreground:#888}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#fff;background:#555}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ë—Ë‹Ëâ™¡ËËŠË—</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">çˆ±ä½ æ‰€çˆ±ï¼Œè¡Œä½ æ‰€è¡Œï¼Œå¬ä»ä½ å¿ƒï¼Œæ— é—®è¥¿ä¸œã€‚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-æ›´æ–°æ—¥å¿—">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>æ›´æ–°æ—¥å¿—</a>

  </li>
        <li class="menu-item menu-item-ç©ºè°ƒæˆ¿">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>ç©ºè°ƒæˆ¿</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%99%A8%E6%8F%90%E4%BE%9B%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="nav-text">1 å†…å­˜ç®¡ç†å™¨æä¾›çš„æœåŠ¡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6"><span class="nav-text">1.1 å…±äº«å†…å­˜å’Œæ˜ å°„æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%86%85%E5%AD%98%E5%8C%BA%E5%AF%B9%E8%B1%A1"><span class="nav-text">1.2 å†…å­˜åŒºå¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%BB%83%E4%B9%A0%EF%BC%9A%E5%A4%9A%E5%BC%80%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%A9%E7%90%86%E9%A1%B5%E6%98%A0%E5%B0%84"><span class="nav-text">1.3 ç»ƒä¹ ï¼šå¤šå¼€ç¨‹åºçš„ç‰©ç†é¡µæ˜ å°„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%A7%81%E6%9C%89%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">1 ç§æœ‰å†…å­˜ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%A0%86%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-text">1.1 å †ç®¡ç†å™¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E7%BB%83%E4%B9%A0%EF%BC%9A%E5%A0%86%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7"><span class="nav-text">1.2 ç»ƒä¹ ï¼šå †å†…å­˜ç”³è¯·</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Mapped-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">2 Mapped å†…å­˜ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-CreateFileMappingW"><span class="nav-text">2.1 CreateFileMappingW</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-NtCreateSection"><span class="nav-text">2.2 NtCreateSection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E5%86%85%E5%AD%98%E5%8C%BA%E5%AF%B9%E8%B1%A1%E6%B5%85%E6%9E%90"><span class="nav-text">2.3 å†…å­˜åŒºå¯¹è±¡æµ…æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-text">3 ç‰©ç†å†…å­˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-PFN-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">3.1 PFN æ•°æ®åº“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E7%89%A9%E7%90%86%E9%A1%B5%E9%9D%A2%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB"><span class="nav-text">3.2 ç‰©ç†é¡µé¢çŠ¶æ€è½¬ç§»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6"><span class="nav-text">3.3 ç‰©ç†å†…å­˜é™åˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E7%BB%83%E4%B9%A0%EF%BC%9A%E6%9F%A5%E7%9C%8BPFN%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">3.4 ç»ƒä¹ ï¼šæŸ¥çœ‹PFNæ•°æ®åº“</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MmPfnDatabase"><span class="nav-text">MmPfnDatabase</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pfn-pageframe"><span class="nav-text">!pfn pageframe</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vtop-CR3-VirtualAddress"><span class="nav-text">!vtop CR3 VirtualAddress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pte-VirtualAddress-x2F-Physical-Address"><span class="nav-text">!pte VirtualAddress&#x2F;Physical Address</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#memusage%E4%B8%8E-vm"><span class="nav-text">!memusageä¸!vm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dml-proc"><span class="nav-text">!dml_proc</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E7%BB%83%E4%B9%A0%EF%BC%9A%E7%94%B3%E8%AF%B7%E7%A7%81%E6%9C%89%E5%86%85%E5%AD%98%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%88%86%E9%85%8D%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-text">3.5 ç»ƒä¹ ï¼šç”³è¯·ç§æœ‰å†…å­˜æŸ¥çœ‹æ˜¯å¦åˆ†é…ç‰©ç†å†…å­˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-MDL-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-text">3.6 MDL ç‰©ç†å†…å­˜</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">62</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">81</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail â†’ mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ â†’ http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.gitee.io/" title="Cutecat â†’ https:&#x2F;&#x2F;catecat.gitee.io" rel="noopener" target="_blank"><i class="fas fa-heartbeat fa-fw"></i>Cutecat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://catecat.top/" title="Directoree â†’ https:&#x2F;&#x2F;catecat.top" rel="noopener" target="_blank"><i class="fas fa-heart fa-fw"></i>Directoree</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/x86-Memory2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ë—Ë‹Ëâ™¡ËËŠË—">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          x86 å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰ç§æœ‰å†…å­˜-å…±äº«å†…å­˜-ç‰©ç†å†…å­˜
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-13 22:21:52" itemprop="dateCreated datePublished" datetime="2022-09-13T22:21:52+08:00">2022-09-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-01-03 19:30:29" itemprop="dateModified" datetime="2024-01-03T19:30:29+08:00">2024-01-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/x86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">x86å†…å­˜ç®¡ç†</span></a>
        </span>
    </span>

  
    <span id="/post/x86-Memory2/" class="post-meta-item leancloud_visitors" data-flag-title="x86 å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰ç§æœ‰å†…å­˜-å…±äº«å†…å­˜-ç‰©ç†å†…å­˜" title="é˜…è¯»æ¬¡æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/post/x86-Memory2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/x86-Memory2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>37k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>33 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ğŸ˜„</p>
<span id="more"></span>

<h2 id="1-å†…å­˜ç®¡ç†å™¨æä¾›çš„æœåŠ¡"><a href="#1-å†…å­˜ç®¡ç†å™¨æä¾›çš„æœåŠ¡" class="headerlink" title="1 å†…å­˜ç®¡ç†å™¨æä¾›çš„æœåŠ¡"></a>1 å†…å­˜ç®¡ç†å™¨æä¾›çš„æœåŠ¡</h2><p>å†…å­˜ç®¡ç†å™¨æä¾›çš„<strong>ç³»ç»ŸæœåŠ¡</strong>åŒ…æ‹¬ï¼šç”³è¯·å’Œé‡Šæ”¾è™šæ‹Ÿå†…å­˜ã€å…±äº«å†…å­˜ç®¡ç†ã€å°†æ–‡ä»¶æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ã€å°†è™šæ‹Ÿé¡µé¢æ¢å‡ºåˆ°ç£ç›˜æ–‡ä»¶ã€ç»´æŠ¤è™šæ‹Ÿé¡µé¢ä¿¡æ¯ã€ä¿®æ”¹è™šæ‹Ÿé¡µé¢ä¿æŠ¤å±æ€§ã€å°†è™šæ‹Ÿé¡µé¢é”åœ¨å†…å­˜ä¸­ã€‚</p>
<p>ä¸Šè¿°å¤§éƒ¨åˆ†ç³»ç»ŸæœåŠ¡éƒ½é€šè¿‡ API æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œè¿™äº› API åŒ…æ‹¬ 4 ç±»ï¼š</p>
<ol>
<li><strong>Virtual AP</strong>Iï¼šä»¥é¡µé¢ç²’åº¦æ“ä½œï¼Œéå¸¸å¼ºå¤§ã€‚å¦‚ VirtualAllocExï¼ŒVirtualFreeExï¼ŒVirtualProtectEx ç­‰ã€‚</li>
<li><strong>Heap API</strong>ï¼šå¯¹è¿›ç¨‹å †è¿›è¡Œåˆ†é…å’Œç®¡ç†ï¼ˆä¸€èˆ¬ç”¨äºç”³è¯·å°äº4KBçš„è™šæ‹Ÿå†…å­˜ï¼‰ã€‚å¦‚ HeapAllocï¼ŒHeapFreeï¼ŒHeapCreateï¼ŒHeapReAlloc ç­‰ã€‚</li>
<li>Local&#x2F;Global APIsï¼šè¿™äº›æ˜¯ 16 ä½ Windows çš„é—ç•™éƒ¨åˆ†ï¼Œç°åœ¨ä½¿ç”¨ Heap API å®ç°ã€‚</li>
<li><strong>Memory-mapped files</strong>ï¼šè¿™äº›å‡½æ•°å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œæœ‰äº›æ˜ å°„çš„æ–‡ä»¶è¿˜å¯ä»¥å’Œå…¶ä»–è¿›ç¨‹å…±äº«ã€‚è¿™äº›å‡½æ•°åŒ…æ‹¬ Create FileMappingã€OpenFileMappingã€MapViewofFile ç­‰ã€‚</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png" alt="27.png"></p>
<blockquote>
<p>è™šçº¿æ¡†çš„ï¼Œå› ä¸ºæ­¤å®ç°ä¾èµ–äºç¼–è¯‘å™¨å¹¶ä¸”å½“ç„¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼ˆå°½ç®¡å¾ˆå¸¸è§ï¼‰ï¼Œå®ƒä»¬ä½¿ç”¨ Heap APIã€‚</p>
<p>åœ¨å†…æ ¸ä¸­ç»™é©±åŠ¨ç¨‹åºä½¿ç”¨çš„çš„å‡½æ•°å‡ä»¥ <code>Mm</code> ä¸ºå‰ç¼€ã€‚</p>
</blockquote>
<p>æ³¨æ„å‡ ä¸ªæ¦‚å¿µï¼š</p>
<ol>
<li>å·²æäº¤é¡µé¢æ˜¯ç§æœ‰å†…å­˜ã€‚</li>
<li>å°è¯•è®¿é—®ç©ºé—²æˆ–ä¿ç•™å†…å­˜ä¼šå¯¼è‡´è®¿é—®å†²çªå¼‚å¸¸ï¼Œå› ä¸ºè¯¥é¡µé¢æœªæ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚</li>
<li>å·²æäº¤çš„å†…å­˜ï¼ˆç§æœ‰å†…å­˜ï¼‰ä¼šè¢«åˆå§‹åŒ–ä¸º0ã€‚å·²æäº¤çš„é¡µé¢è¿˜æœ‰å¯èƒ½è¢«å†™å…¥åˆ° page fileï¼ˆæ¢å‡ºåˆ°ç£ç›˜ï¼‰ã€‚</li>
<li><code>ReadProcessMemory</code>ã€<code>WriteProcessMemory</code> è¿›å…¥ 0 ç¯åï¼Œéƒ½éœ€è¦é™„åŠ åˆ°ç›®æ ‡è¿›ç¨‹ã€‚å®ƒä»¬è¿˜è¦æœ‰ç›®æ ‡è¿›ç¨‹çš„å®‰å…¨æè¿°ç¬¦ï¼Œå®ƒä»¬éœ€è¦ <code>PROCESS_VM_READ</code> æˆ– <code>PROCESS_VM_WRITE</code> æƒé™ï¼Œæˆ–è€…æ‹¥æœ‰ <code>SeDebugPrivilege</code> æƒé™ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»…æˆäºˆç®¡ç†å‘˜ç»„çš„æˆå‘˜ã€‚</li>
<li>å†…å­˜åŒºæ˜¯ä½œä¸ºæ–‡ä»¶æ˜ å°„å¯¹è±¡æš´éœ²ç»™ Windows API ä½¿ç”¨çš„ã€‚</li>
<li>å…±äº«å†…å­˜ã€æ˜ å°„æ–‡ä»¶ã€å†…å­˜åŒºå¯¹è±¡æ˜¯ä¸‰ä¸ªæ¦‚å¿µã€‚</li>
</ol>
<p>memory-mapped files (internally called section objects)</p>
<h3 id="1-1-å…±äº«å†…å­˜å’Œæ˜ å°„æ–‡ä»¶"><a href="#1-1-å…±äº«å†…å­˜å’Œæ˜ å°„æ–‡ä»¶" class="headerlink" title="1.1 å…±äº«å†…å­˜å’Œæ˜ å°„æ–‡ä»¶"></a>1.1 å…±äº«å†…å­˜å’Œæ˜ å°„æ–‡ä»¶</h3><p>å…±äº«å†…å­˜ï¼šæœ‰ä¸€ä¸ªç‰©ç†é¡µåœ¨å¤šä¸ªè¿›ç¨‹ä¸­éƒ½æ˜ å°„äº†è™šæ‹Ÿåœ°å€ï¼Œè¿™äº›è¿›ç¨‹éƒ½å¯ä»¥é€šè¿‡è‡ªå·±çš„è™šæ‹Ÿåœ°å€è®¿é—®è¿™ä¸ªç‰©ç†é¡µã€‚</p>
<div class="note success"><p>å…±äº«å†…å­˜æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>å¦‚æœå¤šä¸ªç¨‹åºåŠ è½½åŒä¸€ä»½ç£ç›˜ä¸Šçš„ DLLï¼Œåˆ™åœ¨ç‰©ç†å†…å­˜ä¸­åªä¼šæ˜ å°„ä¸€æ¬¡è¯¥ DLLã€‚</li>
<li>å¦‚æœå¤šä¸ªè¿›ç¨‹åŠ è½½ç»Ÿä¸€ä»½ç£ç›˜ä¸Šçš„ EXEï¼ˆå¤šå¼€ï¼‰ï¼Œåˆ™åœ¨ç‰©ç†å†…å­˜ä¸­åªä¼šæ˜ å°„ä¸€æ¬¡è¯¥ EXEã€‚</li>
</ol>
</div>

<p><img data-src="https://s2.loli.net/2022/09/14/yoxQT1VZiSzdCDW.png" alt="32.png"></p>
<p><img data-src="https://s2.loli.net/2022/09/14/XtBhPw5dEJUy9oK.png" alt="33.png"></p>
<p>1.3 èŠ‚ç”¨ä¸ªå®éªŒè¯´æ˜è¿™ä¸ªæƒ…å†µã€‚åˆ—å‡ºæ‰€æœ‰è¿›ç¨‹ EPROCESSï¼š!dml_proc ã€!process 0 0</p>
<div class="note warning"><p>å†…å­˜ç®¡ç†å™¨ä¸­ç”¨<strong>å†…å­˜åŒºå¯¹è±¡ï¼Œä¹Ÿå«å†…å­˜åŒº</strong>ï¼ˆsection object, <code>_SECTION</code>ï¼‰æ¥å®ç°å…±äº«å†…å­˜ï¼Œåœ¨ Windows API ä¸­å®ƒä¹Ÿè¢«ç§°ä¸º<strong>æ–‡ä»¶æ˜ å°„å¯¹è±¡</strong>ï¼ˆfile mapping objectï¼‰ï¼Œæ³¨æ„ä¸æ˜¯æ–‡ä»¶å¯¹è±¡ <code>_FILE_OBJECT</code>ã€‚</p>
<p>ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼ˆimage file, page file, data fileï¼‰ã€ç‰©ç†å†…å­˜ï¼Œä»–ä»¬æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜åï¼Œéƒ½æœ‰å…¶å¯¹åº”çš„å†…å­˜åŒºå¯¹è±¡ã€‚å†…å­˜åŒºå¯¹è±¡å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ã€‚</p>
</div>

<p>æœ‰ä¸¤ç§ç±»å‹çš„å†…å­˜åŒºï¼šå†…å­˜åŒºå¯¹è±¡æœ‰ä¸¤ç§ï¼Œä¸€ç§å»ºç«‹åœ¨é¡µé¢æ–‡ä»¶çš„åŸºç¡€ä¸Šï¼Œç§°ä¸ºé¡µé¢æ–‡ä»¶æ”¯æ’‘çš„å†…å­˜åŒºï¼ˆpage-file-backed-sectionsï¼‰ã€‚å¦ä¸€ç§è¢«æ˜ å°„åˆ°å…¶ä»–æ–‡ä»¶ä¸­ï¼Œç§°ä¸ºæ–‡ä»¶æ”¯æ’‘çš„å†…å­˜åŒºï¼Œä¹Ÿç§°ä¸ºæ–‡ä»¶å¯¹è±¡ã€‚</p>
<p>å¯ä»¥åˆ›å»ºå†…å­˜åŒºå¯¹è±¡çš„ 3 ç¯APIï¼š<code>CreateFileMapping, CreateFileMappingNuma(Ex), CreateFileMappingFromApp</code>ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå‚æ•° <code>HANDLE</code>ï¼šå¦‚æœæ˜¯ Mapped file åˆ™éœ€è¦æŒ‡å®šæ–‡ä»¶å¯¹è±¡<code>_FIEL_OBJECT</code>æŒ‡é’ˆï¼›å¦‚æœæ˜¯é¡µé¢æ–‡ä»¶æ”¯æ’‘çš„å†…å­˜åŒºåˆ™è¯¥å‚æ•°ä¸º <code>INVALID_HANDLE_VALUE(0)</code>ã€‚</p>
<p>å¦‚æœå†…å­˜åŒºæœ‰åç§°çš„è¯ï¼Œå…¶ä»–çš„è¿›ç¨‹å°±å¯ä»¥é€šè¿‡ <code>OpenFileMapping</code> æ¥æ‰“å¼€è¯¥å†…å­˜åŒºã€‚</p>
<p>è®¾å¤‡é©±åŠ¨ç¨‹åºè¿˜å¯ä»¥åˆ©ç”¨ <code>ZwOpenSection, ZwMapViewOfSection, ZwUnmapViewOfSection</code> å‡½æ•°æ¥æ“ä½œå†…å­˜åŒºå¯¹è±¡ã€‚</p>
<div class="note default"><p><strong>æ³¨æ„</strong>ï¼šå¯¹äºä¸€ä¸ªéå¸¸å¤§çš„æ˜ å°„å†…å­˜ï¼Œå³è¯¥å†…å­˜åŒºå¯¹è±¡è¡¨ç¤ºçš„å†…å­˜åŒºéå¸¸å¤§ã€‚ä½†æ˜¯æŸäº›è¿›ç¨‹å¯èƒ½åªæ˜¯ä½¿ç”¨å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œåˆ™è¿™äº›è¿›ç¨‹å¯ä»¥åªæ˜ å°„è¯¥å†…å­˜åŒºä¸­çš„ä¸€éƒ¨åˆ†ä½¿ç”¨ï¼Œæ˜ å°„çš„è¿™ä¸€éƒ¨åˆ†ç§°ä¸ºè¯¥å†…å­˜åŒºçš„ä¸€ä¸ª<mark class="label danger">è§†å›¾</mark>ã€‚è°ƒç”¨ <code>MapViewOfFile, MapViewOfFileEx, MapViewOfFileExNuma</code> æŒ‡å®šæ˜ å°„èŒƒå›´å³å¯ã€‚</p>
</div>

<p>ä½¿ç”¨å†…å­˜åŒºå¯¹è±¡çš„åœ°æ–¹ï¼šå¯æ‰§è¡Œæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ã€è®¾å¤‡é©±åŠ¨å¯¹è±¡å°„åˆ°å†…å­˜ã€ç¼“å­˜ç®¡ç†å™¨ã€‚</p>
<h3 id="1-2-å†…å­˜åŒºå¯¹è±¡"><a href="#1-2-å†…å­˜åŒºå¯¹è±¡" class="headerlink" title="1.2 å†…å­˜åŒºå¯¹è±¡"></a>1.2 å†…å­˜åŒºå¯¹è±¡</h3><p>ä¸€ä¸ªç‰©ç†é¡µé¢ä¹Ÿå¯ä»¥è¢«æ˜ å°„åˆ°å¤šä¸ªè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´ï¼Œç”±è¿™æ ·çš„ç‰©ç†é¡µé¢æ˜ å°„åœ¨è™šå­˜ç©ºé—´å½¢æˆçš„è¿ç»­åŒºé—´ï¼Œå°±ç§°ä¸ºå†…å­˜åŒºï¼ˆSectionï¼‰ã€‚</p>
<p>å†…å­˜åŒºå¯¹è±¡ï¼ˆsection objectï¼‰ä»£è¡¨äº†ä¸¤ä¸ªæˆ–è€…å¤šä¸ªè¿›ç¨‹å¯ä»¥å…±äº«çš„ä¸€å—å†…å­˜ï¼ŒWindows å­ç³»ç»Ÿå°†å…¶ç§°ä¸ºæ–‡ä»¶æ˜ å°„å¯¹è±¡ï¼ˆ file<br>mapping objectï¼‰ã€‚å¯ä»¥åˆ©ç”¨å†…å­˜åŒºå¯¹è±¡æŠŠä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ã€‚</p>
<p>å†…å­˜åŒºå¯¹è±¡ï¼Œå¦‚åŒå…¶ä»–çš„å¯¹è±¡ä¸€æ ·ï¼Œä¹Ÿæ˜¯ç”±å¯¹è±¡ç®¡ç†å™¨æ¥åˆ†é…å’Œé‡Šæ”¾çš„ã€‚å¯¹è±¡ç®¡ç†å™¨åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡å¤´ï¼ˆå®ƒä½¿ç”¨å¯¹è±¡å¤´æ¥ç®¡ç†è¿™äº›å¯¹è±¡)ï¼›è€Œå†…å­˜ç®¡ç†å™¨å®šä¹‰å†…å­˜åŒºå¯¹è±¡çš„å¯¹è±¡ä½“ã€‚æˆ‘ä»¬ä¸»è¦å…³æ³¨å¯¹è±¡ä½“ï¼Œå°±åƒ <code>_EPROCESS</code> å¯¹è±¡ä½“ä¸€æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x28 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SECTION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_BALANCED_NODE</span> <span class="title">SectionNode</span>;</span>                                  <span class="comment">//0x0</span></span><br><span class="line">    ULONG StartingVpn;                                                      <span class="comment">//0xc</span></span><br><span class="line">    ULONG EndingVpn;                                                        <span class="comment">//0x10</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">CONTROL_AREA</span>* <span class="title">ControlArea</span>;</span>                                  <span class="comment">//0x14</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">FILE_OBJECT</span>* <span class="title">FileObject</span>;</span>                                    <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteImageFileObject:<span class="number">1</span>;                                      <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteDataFileObject:<span class="number">1</span>;                                       <span class="comment">//0x14</span></span><br><span class="line">    &#125; u1;                                                                   <span class="comment">//0x14</span></span><br><span class="line">    ULONGLONG SizeOfSection;                                                <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LongFlags;                                                    <span class="comment">//0x20</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">MMSECTION_FLAGS</span> <span class="title">Flags</span>;</span>                                      <span class="comment">//0x20</span></span><br><span class="line">    &#125; u;                                                                    <span class="comment">//0x20</span></span><br><span class="line">    ULONG InitialPageProtection:<span class="number">12</span>;                                         <span class="comment">//0x24</span></span><br><span class="line">    ULONG SessionId:<span class="number">19</span>;                                                     <span class="comment">//0x24</span></span><br><span class="line">    ULONG NoValidationNeeded:<span class="number">1</span>;                                             <span class="comment">//0x24</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>æ¦‚å¿µè¯´å¤šäº†éƒ½æ˜¯æ‰¯æ·¡ï¼Œç›´æ¥å¼€å¹²ã€‚</p>
<p>åˆ©ç”¨å†…å­˜åŒºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ä¸€ä¸ªæ˜ å°„æ–‡ä»¶è¢«å…±äº«ï¼Œä¹Ÿå¯ä»¥åªæ˜¯ç®€å•çš„å»ºç«‹ä¸€å—å…±äº«å†…å­˜ã€‚åˆ›å»ºå†…å­˜å–å¯¹è±¡ä½¿ç”¨ <code>CreateFileMapping</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE __stdcall <span class="title">CreateFileMappingA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPSECURITY_ATTRIBUTES lpFileMappingAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD flProtect,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeHigh,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeLow,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCSTR lpName</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>









<p>å†…å­˜åŒºå¯¹è±¡åˆ†ä¸ºä¸¤ç±»ï¼Œåœ¨åˆ›å»ºå†…å­˜åŒºå¯¹è±¡æ—¶å°±å¯ä»¥åŒºåˆ†</p>
<h3 id="1-3-ç»ƒä¹ ï¼šå¤šå¼€ç¨‹åºçš„ç‰©ç†é¡µæ˜ å°„"><a href="#1-3-ç»ƒä¹ ï¼šå¤šå¼€ç¨‹åºçš„ç‰©ç†é¡µæ˜ å°„" class="headerlink" title="1.3 ç»ƒä¹ ï¼šå¤šå¼€ç¨‹åºçš„ç‰©ç†é¡µæ˜ å°„"></a>1.3 ç»ƒä¹ ï¼šå¤šå¼€ç¨‹åºçš„ç‰©ç†é¡µæ˜ å°„</h3><p>å¯¹ç£ç›˜ä¸ŠåŒä¸€ä¸ª EXE åŒå‡»è¿è¡Œä¸¤æ¬¡ï¼ŒæŸ¥çœ‹å…¶æœ¬èº«é•œåƒåŠåŠ è½½çš„ DLL åœ¨ç‰©ç†å†…å­˜çš„æ˜ å°„æƒ…å†µã€‚</p>
<p>å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> z = <span class="number">0x6666</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">0x12345678</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;å±€éƒ¨å˜é‡xåœ°å€ï¼š0x%x\n&quot;</span>, &amp;x);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;å…¨å±€å˜é‡xåœ°å€ï¼š0x%x\n&quot;</span>, &amp;z);</span><br><span class="line">	LoadLibrary(TEXT(<span class="string">&quot;FirstDll32.dll&quot;</span>));</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ è½½åŒä¸€ä¸ª DLLï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>,<span class="string">L&quot;FirstDll Success!&quot;</span>, <span class="string">L&quot;A1v1n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¿è¡Œä¸¤ä¸ªå®ä¾‹å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/14/XBNtEFcw3f7OaWn.png" alt="29.png"></p>
<ol>
<li><p><code>!process 0 0</code> æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PROCESS a6c53040  SessionId: <span class="number">1</span>  Cid: <span class="number">17</span>c0    Peb: <span class="number">00</span>d1c000  ParentCid: <span class="number">0e84</span></span><br><span class="line">    DirBase: <span class="number">7f</span>0ebf00  ObjectTable: b16fa4c0  HandleCount:  <span class="number">83.</span></span><br><span class="line">    Image: <span class="number">20220913</span>_HeapAlloc.exe</span><br><span class="line"></span><br><span class="line">PROCESS afdc3040  SessionId: <span class="number">1</span>  Cid: <span class="number">12e4</span>    Peb: <span class="number">00</span>c9c000  ParentCid: <span class="number">0e84</span></span><br><span class="line">    DirBase: <span class="number">7f</span>0ebb80  ObjectTable: <span class="number">9</span>a1fc080  HandleCount:  <span class="number">83.</span></span><br><span class="line">    Image: <span class="number">20220913</span>_HeapAlloc.exe</span><br></pre></td></tr></table></figure>


</li>
<li><p>æŸ¥çœ‹ VAD æ ‘ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _eprocess vadroot a6c53040</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x350</span> VadRoot : _RTL_AVL_TREE</span><br><span class="line">kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,afdc3040 -r1 (*((ntdll!_RTL_AVL_TREE *)<span class="number">0xa6c53390</span>))</span><br><span class="line">(*((ntdll!_RTL_AVL_TREE *)<span class="number">0xa6c53390</span>))                 [Type: _RTL_AVL_TREE]</span><br><span class="line">    [+<span class="number">0x000</span>] Root             : <span class="number">0xae01f420</span> [Type: _RTL_BALANCED_NODE *]</span><br><span class="line">kd&gt; !vad <span class="number">0xae01f420</span></span><br><span class="line">VAD   Level     Start       End Commit</span><br><span class="line">a6d5fd90  <span class="number">4</span>        <span class="number">80</span>        <span class="number">85</span>      <span class="number">2</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\<span class="number">20220913</span>_HeapAlloc.exe      </span><br><span class="line">...</span><br><span class="line">a37bf290  <span class="number">4</span>     <span class="number">6f</span>c60     <span class="number">6f</span>c7e     <span class="number">19</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\FirstDll32.dll</span><br><span class="line">...</span><br><span class="line">     </span><br><span class="line">kd&gt; dt _eprocess vadroot afdc3040 </span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x350</span> VadRoot : _RTL_AVL_TREE</span><br><span class="line">kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,afdc3040 -r1 (*((ntdll!_RTL_AVL_TREE *)<span class="number">0xafdc3390</span>))</span><br><span class="line">(*((ntdll!_RTL_AVL_TREE *)<span class="number">0xafdc3390</span>))                 [Type: _RTL_AVL_TREE]</span><br><span class="line">    [+<span class="number">0x000</span>] Root             : <span class="number">0xa5878df8</span> [Type: _RTL_BALANCED_NODE *]</span><br><span class="line">kd&gt; !vad <span class="number">0xa5878df8</span></span><br><span class="line">VAD   Level     Start       End Commit</span><br><span class="line"><span class="number">8141b</span>c18  <span class="number">5</span>        <span class="number">80</span>        <span class="number">85</span>      <span class="number">2</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\<span class="number">20220913</span>_HeapAlloc.exe</span><br><span class="line">...</span><br><span class="line">afcc9eb8  <span class="number">3</span>     <span class="number">6f</span>c60     <span class="number">6f</span>c7e     <span class="number">19</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\FirstDll32.dll  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªè¿›ç¨‹ä¸­è¿æ˜ å°„çš„ EXEã€DLLè™šæ‹Ÿåœ°å€éƒ½ä¸€æ ·ã€‚</li>
<li>æ³¨æ„çœ‹ï¼ŒVAD èŠ‚ç‚¹åœ°å€æ˜¯ä¸ä¸€æ ·çš„ã€‚</li>
</ul>
</li>
<li><p>æŸ¥çœ‹ EXEã€DLL æ˜¯å¦åœ¨åŒä¸€ä¸ªç‰©ç†é¡µã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/14/ELUCylM1neu7Bmd.png" alt="30.png"></p>
<p><img data-src="https://s2.loli.net/2022/09/14/qVPyK2LmSribcTt.png" alt="31.png"></p>
</li>
</ol>
<p>å¯¹äºå†…å­˜ç©ºé—´æœ‰ä¸¤ç§æè¿°æ–¹å¼ï¼š</p>
<ol>
<li>ä¸€ç§æ˜¯ç‰©ç†å†…å­˜çš„è§’åº¦ï¼Œæ‰€æœ‰åœ°å€åªåˆ†ä¸ºä¸¤ç±»ï¼ŒæŒ‚äº†ç‰©ç†é¡µçš„åœ°å€ä¸æ²¡æœ‰æŒ‚ç‰©ç†é¡µçš„åœ°å€ï¼Œå…¶å±æ€§ç”±PDE&#x2F;PTEå†³å®šã€‚</li>
<li><strong>å¦ä¸€ç§æ˜¯çº¿æ€§åœ°å€çš„è§’åº¦ï¼Œåˆ†ä¸ºç§æœ‰å†…å­˜ä¸æ˜ å°„å†…å­˜</strong>ã€‚</li>
</ol>
<p>å†…å­˜ç®¡ç†å™¨æä¾›äº†ä¸€ç»„ç³»ç»ŸæœåŠ¡æ¥å®Œæˆä»¥ä¸‹å„ç§ä»»åŠ¡ï¼šåˆ†é…å’Œé‡Šæ”¾è™šæ‹Ÿå†…å­˜ï¼Œåœ¨è¿›ç¨‹ä¹‹ é—´å…±äº«å†…å­˜ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œå°†è™šæ‹Ÿé¡µé¢åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œè·å¾—æœ‰å…³ä¸€å®šèŒƒå›´å†…è™šæ‹Ÿé¡µ é¢çš„ä¿¡æ¯ï¼Œæ”¹å˜è™šæ‹Ÿé¡µé¢çš„ä¿æŠ¤å±æ€§ï¼Œä»¥åŠå°†è™šæ‹Ÿé¡µé¢é”åœ¨å†…å­˜ä¸­ã€‚</p>
<p>è¿™äº›æœåŠ¡ä¸­çš„å¤§å¤šæ•°æ˜¯é€šè¿‡Windows APIæš´éœ²ç»™å®¢æˆ·çš„ã€‚Windows API æœ‰ 4 ç»„å‡½æ•°å¯ç”¨æ¥ç®¡ç†åº”ç”¨ç¨‹åºä¸­çš„å†…å­˜ï¼š</p>
<ol>
<li><strong>Virtual AP</strong>Iï¼šä»¥é¡µé¢ç²’åº¦æ“ä½œï¼Œéå¸¸å¼ºå¤§ã€‚å¦‚ VirtualAllocExï¼ŒVirtualFreeExï¼ŒVirtualProtectEx ç­‰ã€‚</li>
<li><strong>Heap API</strong>ï¼šå¯¹è¿›ç¨‹å †è¿›è¡Œåˆ†é…å’Œç®¡ç†ã€‚å¦‚ HeapAllocï¼ŒHeapFreeï¼ŒHeapCreateï¼ŒHeapReAlloc ç­‰ã€‚</li>
<li>Local&#x2F;Global APIsï¼šè¿™äº›æ˜¯ 16 ä½ Windows çš„é—ç•™éƒ¨åˆ†ï¼Œç°åœ¨ä½¿ç”¨ Heap API å®ç°ï¼ˆå·²å¼ƒç”¨ï¼‰ã€‚</li>
<li><strong>Memory-mapped files</strong>ï¼šè¿™äº›å‡½æ•°å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œæœ‰äº›æ˜ å°„çš„æ–‡ä»¶è¿˜å¯ä»¥å’Œå…¶ä»–è¿›ç¨‹å…±äº«ã€‚è¿™äº›å‡½æ•°åŒ…æ‹¬ Create FileMappingã€OpenFileMappingã€MapViewofFile ç­‰ã€‚</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png" alt="27.png"></p>
<p>è¿™éƒ¨åˆ†å†…å®¹ï¼šã€ŠWindows Internals Part1 7th 5.2.5ã€‹ã€ã€ŠWindows 10 System Programming 12, 13ã€‹ã€ã€ŠWindows å†…æ ¸åŸç†ä¸å®ç° 4.3.4ã€‹ã€ã€ŠWindows å†…æ ¸æƒ…æ™¯åˆ†æ 3.4ã€‹ã€‚</p>
<h2 id="1-ç§æœ‰å†…å­˜ç®¡ç†"><a href="#1-ç§æœ‰å†…å­˜ç®¡ç†" class="headerlink" title="1 ç§æœ‰å†…å­˜ç®¡ç†"></a>1 ç§æœ‰å†…å­˜ç®¡ç†</h2><p>å¦‚ä¸‹å›¾ï¼Œç”¨æˆ·ç©ºé—´çš„ <code>Private</code> ã€<code>Mapped</code> å†…å­˜ç”± <code>VadFlags.PrivateMemory</code>ä½å†³å®šï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/13/A7oTHyE5hvWPRVj.png" alt="25.png"></p>
<p>è¿™ä¸¤ç±»å†…å­˜çš„åŒºåˆ«ä¸»è¦æœ‰2ç‚¹ä¸åŒï¼š</p>
<ul>
<li>ç”³è¯·å†…å­˜çš„æ–¹å¼ä¸åŒï¼š<ul>
<li>ç§æœ‰å†…å­˜ï¼šé€šè¿‡ <code>VirtualAlloc/VirtualAllocEx</code> ç”³è¯·çš„ï¼ˆæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„ VAD èŠ‚ç‚¹ï¼‰ã€‚</li>
<li>æ˜ å°„å†…å­˜ï¼šé€šè¿‡ <code>CreateFileMapping</code> æ˜ å°„çš„ã€‚</li>
</ul>
</li>
<li>ä½¿ç”¨æ–¹å¼ä¸åŒï¼š<ul>
<li>ç§æœ‰å†…å­˜ï¼šç‹¬äº«ç‰©ç†é¡µã€‚</li>
<li>æ˜ å°„å†…å­˜ï¼šå¯èƒ½è¦ä¸å…¶å®ƒè¿›ç¨‹å…±äº«ç‰©ç†é¡µã€‚</li>
</ul>
</li>
</ul>
<h3 id="1-1-å †ç®¡ç†å™¨"><a href="#1-1-å †ç®¡ç†å™¨" class="headerlink" title="1.1 å †ç®¡ç†å™¨"></a>1.1 å †ç®¡ç†å™¨</h3><p>è¿›ç¨‹ç”¨æˆ·ç©ºé—´ç§æœ‰å†…å­˜åŒ…æ‹¬ï¼š<strong>æ ˆã€å †</strong>ã€‚è€Œåœ¨ç³»ç»Ÿå±‚é¢ï¼Œç§æœ‰å†…å­˜åŒ…æ‹¬ç³»ç»Ÿè¿›ç¨‹&#x2F;çº¿ç¨‹æ ˆã€å †ï¼ˆåˆ†é¡µ&#x2F;æ¢é¡µå†…å­˜æ± ï¼Œéåˆ†é¡µ&#x2F;æ¢é¡µå†…å­˜æ± ï¼‰ã€‚æœ¬ç« æˆ‘ä»¬å…ˆåªç ”ç©¶è¿›ç¨‹ç”¨æˆ·ç©ºé—´çš„ç§æœ‰å†…å­˜ç®¡ç†ã€‚</p>
<p>æ ˆå†…å­˜æ˜¯ç”±ç³»ç»Ÿä½¿ç”¨ ASLR è‡ªå·±ç®¡ç†çš„ï¼Œæˆ‘ä»¬æ— æ³•æŒæ§å…¶åˆ†é…ã€‚ä½†æ˜¯å †å†…å­˜æˆ‘ä»¬å¯ä»¥è‡ªå·±ç”³è¯·ã€‚</p>
<p>åœ¨å‰é¢ä¸€ç¯‡æ–‡ç« ä¸­å·²ç»ä»‹ç»è¿‡ VAD ä½å›¾çš„ä¸€ä½è¡¨ç¤º 64 KBï¼Œä½†æ˜¯ Windows æä¾›äº†å †ç®¡ç†å™¨ï¼Œä½¿å¾— <code>VirtualAlloc</code> å’Œ<code>VirtualAllocExNuma </code>æ¥åˆ†é…æ¯”æœ€å°åˆ†é…ç²’åº¦ 64KB å°å¾—å¤šçš„å†…å­˜å—ï¼ˆåˆ†é…ç²’åº¦ä¸º <code>4KB</code>ï¼‰ã€‚è¿™æ˜¯å› ä¸ºæ— è®ºæ˜¯ä»å†…å­˜ä½¿ç”¨æ•ˆç‡çš„è§’åº¦ï¼Œè¿˜æ˜¯ä»æ€§èƒ½çš„è§’åº¦æ¥çœ‹ï¼Œä¸ºç›¸å¯¹è¾ƒå°çš„å†…å­˜è¯·æ±‚åˆ†é…å¦‚æ­¤å¤§çš„ä¸€ä¸ªåŒºåŸŸæ˜¾ç„¶ä¸æ˜¯æœ€ä¼˜çš„ã€‚ä¸ºäº†æ»¡è¶³è¿™ç§éœ€æ±‚ï¼ŒWindowsæä¾›äº†ä¸€ä¸ªè¢«ç§°ä¸ºå †ç®¡ç†å™¨ï¼ˆheap managerï¼‰çš„ç»„ä»¶ï¼Œå®ƒè´Ÿè´£ç®¡ç†å¤§å†…å­˜åŒºåŸŸä¸­çš„å†…å­˜åˆ†é…ï¼Œè¿™äº›å¤§å†…å­˜åŒºåŸŸæ˜¯é€šè¿‡ä¸€äº›é¡µé¢ç²’åº¦çš„å†…å­˜åˆ†é…å‡½æ•°æ¥ä¿ç•™çš„ã€‚</p>
<div class="note success"><p>å †ç®¡ç†å™¨ä¸­çš„åˆ†é…ç²’åº¦ç›¸å¯¹è¾ƒå°ï¼š<strong>åœ¨ 32 ä½ç³»ç»Ÿä¸Šæ˜¯ 8 å­—èŠ‚ï¼Œåœ¨ 64ä½ ç³»ç»Ÿä¸Šæ˜¯ 16 å­—èŠ‚</strong>ã€‚</p>
</div>

<div class="note danger"><p>å †ç®¡ç†å™¨å­˜åœ¨äºä¸¤ä¸ªåœ°æ–¹ï¼š<code>Ntdll.dll</code>å’Œ <code>Ntoskrl.exe</code>ã€‚éƒ½æ˜¯ä»¥ <code>Rtl</code> ä¸ºå‰ç¼€ï¼Œ<code>malloc, free, new</code> ç­‰å‡½æ•°æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ä»¥ <code>Heap</code> ä¸ºå‰ç¼€çš„å‡½æ•°ï¼Œç„¶åè°ƒç”¨<code>Ntdll.dll</code>ä¸­çš„åŸç”Ÿå‡½æ•°ã€‚è€Œä¸”ï¼Œä» 16 ä½æ“ä½œç³»ç»Ÿé—ç•™çš„ä»¥ <code>Local</code> æˆ– <code>Global</code> ä¸ºå‰ç¼€å‡½æ•°ä»ç„¶æ˜¯å¯ç”¨çš„ï¼Œä»¥ä¾¿æ”¯æŒè€çš„ Windowsåº”ç”¨ç¨‹åºã€‚</p>
</div>

<p>åœ¨ 3 ç¯ç”³è¯·å†…å­˜çš„å‡½æ•°æœ‰å¦‚ä¸‹ä¸€äº›ï¼Œä½†æ˜¯éœ€è¦è¿›è¡Œè¯´æ˜çš„æ˜¯  C è¯­è¨€çš„ <code>malloc</code> å’Œ C++çš„ <code>new</code> ä»–ä»¬ä¼šå…ˆç”³è¯·è¿›ç¨‹åˆ›å»ºæ—¶é¢„ç•™ç»™å †ä½¿ç”¨çš„å†…å­˜ï¼Œä½†æ˜¯å½“é¢„ç•™ç»™å †çš„å†…å­˜ä¸å¤Ÿæ—¶è¿˜æ˜¯ä¼šè¿›å…¥ 0 ç¯ç”³è¯·å†…å­˜å¹¶åˆ†é… VAD èŠ‚ç‚¹ã€‚ä¸‹é¢ä¸€å°èŠ‚å°†è¿›è¡Œå®éªŒè¯´æ˜ã€‚ï¼ˆå…³äº <code>VirtualAlloc2</code> ç­‰å‡½æ•°çš„ä½¿ç”¨å¯ä»¥çœ‹ã€ŠWindows 10 System Programming Chapter 13ã€‹ï¼Œæœ¬èŠ‚å°±ä¸æµªè´¹å¢¨æ°´äº†ï¼‰</p>
<p><img data-src="https://s2.loli.net/2022/09/14/2BWpCvei3fbJ6tz.png" alt="23.png"></p>
<div class="note default"><p>æ¯ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªå †ï¼Œç›´åˆ°è¿›ç¨‹ç»“æŸæ‰ä¼šé‡Šæ”¾ã€‚</p>
<p>è¿›ç¨‹é»˜è®¤å †ç©ºé—´å¤§å°ï¼š1MB &#x3D; 256*4KBï¼Œå¯ä»¥åœ¨ç¼–è¯‘ç¨‹åºæ—¶é€šè¿‡ <code>/HEAP</code>  ä¿®æ”¹ã€‚è¿›ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­å †çš„å¤§å°ä¼šè¢«è‡ªåŠ¨æ‰©å……ã€‚è¿™éƒ¨åˆ†ä½¿ç”¨<strong>ä½ç¢ç‰‡å †</strong>ï¼ˆLFHï¼Œ Low Fragmentation Heapï¼‰åˆ†é…ç­–ç•¥è¿›è¡Œç®¡ç†ï¼ˆå…·ä½“è§Windows Internals â€“Heap managerâ€“ä½ç¢ç‰‡å †ï¼‰ã€‚</p>
</div>

<p><strong>æœ‰ä¸€ç§ç‰¹æ®Šçš„æƒ…å†µ</strong>ï¼šWin32 GUI å­ç³»ç»Ÿé©±åŠ¨ç¨‹åºï¼ˆWin32k.sysï¼‰çš„å †æ˜¯å»ºç«‹åœ¨<strong>å†…å­˜æ˜ å°„æ–‡ä»¶åŒºåŸŸ</strong>åŸºç¡€ä¹‹ä¸Šçš„ï¼Œå®ƒè¢«ç”¨æ¥åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹å…±äº«GDIå’ŒUserå¯¹è±¡ã€‚</p>
<div class="note default"><p>å¯¹ã€ŠWindows Internals7 â€“Heap managerã€‹æå–ä¸€äº›çŸ¥è¯†ç‚¹ï¼š</p>
<ol>
<li><p>åœ¨ Windows 10 å’Œ Server 2016 ä¹‹å‰ï¼Œåªæœ‰ä¸€ç§å †ç±»å‹ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º NT å †ã€‚NT å †ç”±å¯é€‰çš„å‰ç«¯å±‚æ‰©å……ï¼Œä½¿ç”¨ä½ç¢ç‰‡å † ï¼ˆLFHï¼‰ ç­–ç•¥åˆ†é…å†…å­˜ã€‚</p>
</li>
<li><p>Windows 10 å¼•å…¥äº†ä¸€ç§ç§°ä¸ºç¢ç‰‡å †ï¼ˆsegment heapï¼‰çš„æ–°å †ç±»å‹ã€‚è¿™ä¸¤ç§å †ç±»å‹åŒ…æ‹¬å…¬å…±å…ƒç´ ï¼Œä½†ç»“æ„å’Œå®ç°æ–¹å¼ä¸åŒã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ†æ®µå †ç”±æ‰€æœ‰ UWP åº”ç”¨å’ŒæŸäº›ç³»ç»Ÿè¿›ç¨‹ä½¿ç”¨ï¼Œè€Œ NT å †ç”±æ‰€æœ‰å…¶ä»–è¿›ç¨‹ä½¿ç”¨ã€‚è¿™å¯ä»¥åœ¨æ³¨å†Œè¡¨ä¸­è¿›è¡Œæ›´æ”¹ã€‚</p>
</li>
<li><p>Windowsé€šç”¨åº”ç”¨å¹³å° ï¼ˆUWPï¼‰ ï¼šå¯ä»¥è®©åŸºäºè¯¥å¹³å°å¼€å‘çš„åº”ç”¨è¿è¡Œåœ¨ <strong>è¿è¡Œ Windows 10 çš„ç§»åŠ¨ç«¯å’Œ PC ç«¯</strong>ã€‚</p>
</li>
</ol>
</div>

<ol>
<li><p>NT å †ï¼ˆNT Heapï¼‰ã€‚åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹å †ç®¡ç†å™¨æ˜¯ä¸€ä¸ªä¸¤å±‚ç»“æ„ï¼šå¯é€‰çš„å‰ç«¯å †å±‚å’Œæ ¸å¿ƒå †å±‚ï¼ˆåç«¯å †å±‚ï¼‰ã€‚å‰æ®µå †ä½¿ç”¨ä½ç¢ç‰‡å †ç­–ç•¥åˆ†é…å†…å­˜(<strong>LFH</strong>ï¼Œ Low Fragmentation Heapï¼‰ï¼Œ<strong>å‰ç«¯å †ä»…ç”¨äºç”¨æˆ·æ¨¡å¼</strong>ã€‚æ ¸å¿ƒå †å±‚å¤„ç†åŸºæœ¬çš„åŠŸèƒ½ï¼Œå¤„ç†å¸¸è§çš„ä»ç”¨æˆ·æ¨¡å¼è¿›å…¥å†…æ ¸æ¨¡å¼çš„å †å®ç°ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬æ®µå†…éƒ¨çš„å†…å­˜å—çš„ç®¡ç†ã€æ®µçš„ç®¡ç†ã€å †çš„æ‰©å±•ç­–ç•¥ã€æäº¤å†…å­˜å’Œè§£é™¤æäº¤ï¼Œä»¥åŠå¤§å—çš„ç®¡ç†ã€‚ï¼ˆå®é™…å‰ç«¯åç«¯ä¸»è¦å°±æ˜¯çœ‹è¿›ä¸è¿› 0 ç¯ï¼‰ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/15/LJ6BHmSiZaKsqM1.png" alt="34.png"></p>
<p><strong>LFH å†…å­˜åˆ†é…æ–¹æ³•</strong>ï¼šä½¿ç”¨æ¡¶ï¼ˆLFH bucketsï¼‰ï¼Œæ¡¶çš„åˆ†é…ç²’åº¦å‘ˆé˜¶æ¢¯å‹ï¼Œæœ€å°ä¸€ä¸ªæ¡¶ç²’åº¦ä¸º 8 å­—èŠ‚ï¼Œæœ€å¤§çš„æ¡¶ç²’åº¦ä¸º 512 å­—èŠ‚ã€‚æ€»å…± 128 ä¸ªæ¡¶ï¼Œæœ€å¤§èŒƒå›´ä¸º <code>16384 bytes = 16384/1024 = 16KB</code>ã€‚</p>
<p><code>malloc/aloca</code> ç­‰å‡½æ•°ï¼š</p>
<ul>
<li>x86ï¼šæœ€å°åˆ†é… 8 å­—èŠ‚ã€‚</li>
<li>x64ï¼šæœ€å°åˆ†é… 16 å­—èŠ‚ã€‚</li>
</ul>
<p>x86ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/10/20/rzK8iQdO4D21TER.png" alt="72.png"></p>
<p>x64ï¼šã€Š<a target="_blank" rel="noopener" href="https://github.com/peleghd/Windows-10-Exploitation/blob/master/Low_Fragmentation_Heap_(LFH)_Exploitation_-_Windows_10_Userspace_by_Saar_Amar.pdf">Low Fragmentation Heap (LFH) Exploitation Windows 10 Userspace</a>ã€‹</p>
<p><img data-src="https://s2.loli.net/2022/10/22/vafHMNWZi6U8bkY.png" alt="73.png"></p>
</li>
<li><p>ç¢ç‰‡å †ï¼ˆSegment Heapï¼‰ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œç®¡ç†åˆ†é…çš„ç­–ç•¥å–å†³äºç”³è¯·å†…å­˜çš„å¤§å°ï¼ˆ16368bytes &#x3D; 16KBï¼‰ã€‚</p>
<ul>
<li><p>x &lt;&#x3D; 16368bytesï¼ŒLFH å¤„ç†ã€‚</p>
</li>
<li><p>16368bytes &lt; x &lt;&#x3D; 128KBï¼Œå¼•å…¥ VS åˆ†é…å™¨ï¼Œä½†æ˜¯ VS å’Œ LFH åˆ†é…å™¨éƒ½ä½¿ç”¨é¢„å…ˆå †é¢„ç•™çš„å†…å­˜ã€‚</p>
</li>
<li><p>128KB &lt; x &lt;&#x3D; 508KBï¼Œåç«¯å †æä¾›çš„ç­–ç•¥ä¸è¿›å…¥ 0 ç¯ã€‚</p>
</li>
<li><p>x &gt; 508KBï¼Œé€šè¿‡ç›´æ¥è°ƒç”¨å†…å­˜ç®¡ç†å™¨ï¼ˆVirtualAllocï¼‰è¿›è¡Œå¤„ç†ï¼Œè¿›å…¥ 0 ç¯ã€‚å› ä¸ºè¿™äº›åˆ†é…éå¸¸å¤§ï¼Œä»¥è‡³äºä½¿ç”¨é»˜è®¤çš„ 64 KB åˆ†é…ç²’åº¦ï¼ˆå¹¶èˆå…¥åˆ°æœ€æ¥è¿‘çš„é¡µé¢å¤§å°ï¼‰è¢«è®¤ä¸ºè¶³å¤Ÿå¥½ã€‚</p>
</li>
</ul>
<p><img data-src="https://s2.loli.net/2022/09/15/7lpKhndRtaiJYrs.png" alt="35.png"></p>
</li>
</ol>
<h3 id="1-2-ç»ƒä¹ ï¼šå †å†…å­˜ç”³è¯·"><a href="#1-2-ç»ƒä¹ ï¼šå †å†…å­˜ç”³è¯·" class="headerlink" title="1.2 ç»ƒä¹ ï¼šå †å†…å­˜ç”³è¯·"></a>1.2 ç»ƒä¹ ï¼šå †å†…å­˜ç”³è¯·</h3><p>å¯¹äºä»¥çº¿æ€§åœ°å€ä¸ºè§’åº¦æè¿°å†…å­˜æ—¶ï¼Œåˆ†ä¸ºç§æœ‰å†…å­˜ä¸æ˜ å°„å†…å­˜ã€‚<strong>ç”³è¯·ç§æœ‰å†…å­˜çš„å‡½æ•°ä¸ºVirtualAlloc&#x2F;VirtualAllocExï¼Œç”³è¯·æ˜ å°„å†…å­˜çš„å‡½æ•°ä¸ºCreateFileMappingã€‚</strong>C è¯­è¨€çš„ <code>malloc</code> å’Œ C++çš„ <code>new</code> éƒ½ä¸æ˜¯çœŸæ­£çš„ç”³è¯·å†…å­˜ï¼Œä»–ä»¬ç”³è¯·ä½¿ç”¨çš„æ˜¯è¿›ç¨‹åˆ›å»ºé¢„ç•™ç»™å †ä½¿ç”¨çš„å†…å­˜ï¼Œä½†æ˜¯å½“é¢„ç•™ç»™å †çš„å†…å­˜ä¸å¤Ÿæ—¶è¿˜æ˜¯ä¼šè¿›å…¥ 0 ç¯ç”³è¯·å†…å­˜å¹¶åˆ†é… VAD èŠ‚ç‚¹ã€‚ã€‚</p>
<p><code>malloc</code> ä¸ <code>new</code> çš„åº•å±‚è°ƒç”¨è¿‡ç¨‹ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span> -&gt; _nh_malloc_dbg -&gt; _heap_alloc_dbg -&gt; _heap_alloc_base -&gt; kernel32!HeapAlloc -&gt; ntdll!RtlHeapAlloc</span><br><span class="line"><span class="keyword">new</span> -&gt; _nh_malloc -&gt; _nh_malloc_dbg -&gt; _heap_alloc_dbg -&gt; _heap_alloc_base -&gt; kernel32!HeapAlloc -&gt; ntdll!RtlHeapAlloc</span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œå°±è¦äº†è§£ä¸€ä¸‹å †çš„æ¦‚å¿µï¼Œä»€ä¹ˆæ˜¯å †å‘¢ï¼Ÿ<strong>å †å…¶å®å°±æ˜¯æ“ä½œç³»ç»Ÿé€šè¿‡è°ƒç”¨ VirtualAlloc å‡½æ•°é¢„å…ˆåˆ†é…å¥½çš„ä¸€å¤§å—å†…å­˜ã€‚</strong><code>ntdll!RtlHeapAlloc</code> çš„ä½œç”¨å°±æ˜¯åœ¨è¿™ä¸€å¤§å—å·²ç»é¢„å…ˆåˆ†é…å¥½çš„å†…å­˜é‡Œé¢ï¼Œåˆ†ä¸€äº›å°ä»½å‡ºæ¥ç”¨ã€‚ä½œä¸ªæ¯”å–»ï¼Œå¯ä»¥è®¤ä¸º <code>VirtualAlloc</code> å°±æ˜¯æ‰¹å‘å¸‚åœºï¼Œä¸€æ¬¡å¿…é¡»æ‰¹é‡ä»æ“ä½œç³»ç»Ÿé‚£é‡Œè´­ä¹°å†…å­˜ï¼Œå¿…é¡»æ˜¯ 4KB çš„æ•´æ•°å€æ‰å¯ä»¥ï¼›è€Œ <code>ntdll!RtlHeapAlloc</code>å°±æ˜¯é›¶å”®å•†ï¼Œä» <code>VirtualAlloc</code> å·²ç»æ‰¹æ¥çš„è´§é‡Œé¢ï¼ˆå †ï¼‰ä¹°ä¸€éƒ¨åˆ†èµ°ã€‚</p>
<p>å®éªŒï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> z = <span class="number">0x6666</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">0x12345678</span>;</span><br><span class="line">  </span><br><span class="line">  getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>* y = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)*<span class="number">128</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;æ ˆ:%x \n&quot;</span>,&amp;x);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;å †:%x \n&quot;</span>,y);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;å…¨å±€å˜é‡ï¼š%x\n&quot;</span>, &amp;z);</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>è¿è¡Œåˆ°ç¬¬ä¸€ä¸ª <code>getchar()</code> æ—¶ï¼Œä¸è¿è¡Œåˆ°ç¬¬äºŒä¸ª <code>getchar()</code> æ—¶æŸ¥çœ‹è¯¥è¿›ç¨‹å½“å‰çš„ VAD æ ‘æ˜¯ä¸€æ ·çš„ã€‚<strong>æ³¨æ„</strong>ï¼š1200-14ff æ˜¯è¿›ç¨‹é¢„ç•™çš„ 1MB å †ç©ºé—´ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/13/kI3UpiP4vx8as5Q.png" alt="26.png"></p>
</li>
<li><p>å¦‚ä¸Šå›¾ï¼Œå¯ä»¥çœ‹åˆ°å †å’Œæ ˆçš„å†…å­˜éƒ½æ˜¯åœ¨è¿›ç¨‹é¢„å…ˆåˆ†é…å¥½çš„  <code>Private</code> å†…å­˜ä¸­ã€‚å…¨å±€å˜é‡ä½¿ç”¨çš„å†…å­˜æ˜¯åœ¨ Image æ–‡ä»¶æ˜ å°„åŒºåŸŸä¸­ã€‚</p>
</li>
<li><p>å¦‚æœ <code>malloc</code> ç”³è¯·çš„å†…å­˜å¾ˆå¤§æ—¶ï¼Œè¿˜æ˜¯ä¼šè¿›å…¥ 0 ç¯å»ç”³è¯·ä¸€å—å†…å­˜ï¼Œå¹¶å»ºç«‹ AVD èŠ‚ç‚¹ã€‚</p>
</li>
<li><p>ä½¿ç”¨ <code>VirtualAlloc</code> ç”³è¯·å†…å­˜æ—¶ï¼Œå°½ç®¡æ˜¯ 1 å­—èŠ‚ï¼Œéƒ½ä¼šè¿›å…¥ 0 ç¯ï¼Œç„¶åæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„ VAD èŠ‚ç‚¹ï¼ˆæ­¤æ—¶å†…å­˜ç®¡ç†å™¨ä¼šä»¥æœ€å°å•ä½4KBç»™ä¸€é¡µï¼‰ã€‚</p>
</li>
</ol>
<p>ä¼šå‘ç°ï¼Œ<strong>æ— è®ºæ˜¯å…¨å±€å˜é‡ï¼Œå±€éƒ¨å˜é‡ï¼Œæˆ–è€…è°ƒç”¨ malloc å‡½æ•°ï¼Œå®ƒéƒ½æ²¡æœ‰åˆ†é…æ–°çš„å†…å­˜ç©ºé—´ï¼Œåªä¸è¿‡æ˜¯ä½¿ç”¨äº†å½“å‰è¿›ç¨‹å·²æœ‰çš„å†…å­˜ç©ºé—´</strong>ã€‚</p>
<p>ä¸è¿‡è¿˜æ˜¯æœ‰å‡ ä¸ªéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œæ¯”å¦‚å±€éƒ¨å˜é‡çš„åœ°å€æ˜¯ <code>0x110fdf8</code>ï¼Œè€Œå®ƒæ‰€åœ¨çš„å†…å­˜å—çš„èŒƒå›´æ˜¯ <code>0x1010 000~0x110f fff</code>ï¼Œä¸»è¦åŸå› æ˜¯ï¼Œ<strong>æ ˆæ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€å»¶ç”³çš„</strong>ï¼Œå› æ­¤åˆšå¼€å§‹ä½¿ç”¨çš„åœ°å€éƒ½æ˜¯å½“å‰å†…å­˜å—çš„é«˜åœ°å€ã€‚å †çš„è¯ï¼Œå°±æ˜¯ç›´æ¥ä½¿ç”¨äº†ä¸€å—å·²æœ‰çš„å†…å­˜ï¼Œå¯ä»¥å›æƒ³ä¹‹å‰æ‰¹å‘å•†ä¸é›¶å”®å•†çš„ä¾‹å­ã€‚å…¨å±€å˜é‡ï¼Œå°±æ¯”è¾ƒä¸ä¼—ä¸åŒäº†ï¼Œå®ƒæ˜ å°„äº†å½“å‰è¿›ç¨‹çš„ <code>.exe</code> æ–‡ä»¶ï¼Œè¿™éƒ¨åˆ†ä¸‹ç¯‡å­¦ä¹ æ˜ å°„å†…å­˜æ—¶ä¼šè®²åˆ°ã€‚</p>
<p><strong>æ€»ç»“</strong>ï¼š</p>
<ol>
<li>VirtualAlloc&#x2F;VirtualAllocEx æ˜¯ç”³è¯·ç§æœ‰å†…å­˜çš„å”¯ä¸€æ–¹å¼ã€‚</li>
<li>å¦‚æœå·²ç»é¢„ç•™çš„å†…å­˜æ»¡è¶³æœ¬æ¬¡ç”³è¯·çš„å†…å­˜ï¼Œnew ä¸ malloc çš„å†…éƒ¨è°ƒç”¨æ˜¯ ntdll!RtlHeapAllocï¼Œè¿™ç§æƒ…å†µä¸‹ ntdll!RtlHeapAlloc ä¸è¿›å…¥ 0 ç¯ï¼Œä»…åˆ†é…ä¸€äº›å·²ç»ç»è¿‡  VirtualAlloc&#x2F;VirtualAllocEx ç”³è¯·å¥½çš„å†…å­˜ã€‚</li>
<li>å¦‚æœä¿ç•™çš„å†…å­˜é¡µä¸èƒ½å¤Ÿæ»¡è¶³æœ¬æ¬¡ <code>malloc</code> ç”³è¯·çš„å†…å­˜æ—¶ï¼Œntdll!RtlHeapAlloc ä¼šè¿›å…¥ 0 ç¯ç”³è¯·ä¸€å—æ–°çš„å†…å­˜ã€‚</li>
</ol>
<p>å¦‚ä¸‹å›¾ï¼Œçº¢æ¡†ä¸­çš„ <code>13ff*0x1000+0xfff - (1200*0x1000) = 0x001fffff = 512KB</code>ï¼Œæ˜¯è¿›ç¨‹åˆ›å»ºæ—¶é¢„ç•™çš„ã€‚å½“æˆ‘ä»¬ç”³è¯·128ã€508ã€509KBæ—¶è¿›ç¨‹ä¼šå¤šæäº¤ä¸€é¡µï¼Œå¹¶å»ºç«‹ç›¸åº”çš„ VADèŠ‚ç‚¹ã€‚ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼Œå…¶ä¸­æœ‰ä¸€æ¬¡å°±æ˜¯å½“æˆ‘ç”³è¯· 4KB æ—¶ï¼Œå†…å­˜ç®¡ç†å™¨ä¼šå°†æŸä¸¤ä¸ª VAD èŠ‚ç‚¹åˆå¹¶ä»¥æä¾›è¶³å¤Ÿçš„ç©ºé—´ã€‚ï¼ˆæˆ‘çš„åº”ç”¨ä¸æ˜¯ UWP åº”ç”¨ï¼‰ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/14/oes68xkmvpQBc5J.png" alt="28.png"></p>
<h2 id="2-Mapped-å†…å­˜ç®¡ç†"><a href="#2-Mapped-å†…å­˜ç®¡ç†" class="headerlink" title="2 Mapped å†…å­˜ç®¡ç†"></a>2 Mapped å†…å­˜ç®¡ç†</h2><p>æ˜ å°„å†…å­˜ä¸»è¦æœ‰ä¸¤ç±»ï¼šä¸€ç§æ˜¯å…±äº«ç‰©ç†é¡µï¼Œå¦ä¸€ç§æ˜¯å…±äº«æ–‡ä»¶ã€‚åŸºäºé¡µé¢ï¼ŒåŸºäºæ–‡ä»¶ï¼ˆæ–‡ä»¶æ˜ å°„å¯¹è±¡ï¼‰â€“æ•°æ®æ–‡ä»¶ã€é•œåƒæ–‡ä»¶ã€‚</p>
<p>éƒ½æ˜¯ä½¿ç”¨å‡½æ•° <code>CreateFileMapping</code> å‡½æ•°ï¼Œ<code>CreateFileMapping</code> åªæ˜¯åœ¨åº•å±‚å‡†å¤‡å¥½ä¸€ä¸ªç‰©ç†é¡µ&#x2F;æ–‡ä»¶ï¼Œæƒ³å°†å‡†å¤‡å¥½çš„ç‰©ç†é¡µ&#x2F;æ–‡ä»¶ä¸å½“å‰è¿›ç¨‹å…³è”èµ·æ¥ï¼Œå°±è¦ä¾èµ– <code>MapViewOfFile</code> å‡½æ•°å°†ç‰©ç†é¡µæ˜ å°„åˆ°è‡ªå·±è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ã€‚å¦‚æœå…¶ä»–è¿›ç¨‹æƒ³è¦å…±äº«å¹¶ä½¿ç”¨è¿™ä¸ªå†…å­˜åŒºï¼Œåªéœ€è¦ä½¿ç”¨ <code>OpenFileMapping</code> æ¥è·å–å†…å­˜åŒºå¯¹è±¡å¥æŸ„ï¼Œç„¶åå†ä½¿ç”¨ <code>MapViewOfFile</code> å°†ç‰©ç†é¡µæ˜ å°„åˆ°è‡ªå·±çš„åœ°å€ç©ºé—´ä¸­å³å¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NtCreateSection --&gt; MiCreateSectionCommon --&gt; MiCreateSection --&gt; MiCreateImageOrDataSection/MiCreatePagingFileMap</span><br><span class="line"></span><br><span class="line">MiCreateImageOrDataSection --&gt; MiCreateNewSection --&gt; MiCreateImageFileMap/MiCreateDataFileMap </span><br></pre></td></tr></table></figure>





<h3 id="2-1-CreateFileMappingW"><a href="#2-1-CreateFileMappingW" class="headerlink" title="2.1 CreateFileMappingW"></a>2.1 CreateFileMappingW</h3><p><code>CreateFileMapping</code> å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE __stdcall <span class="title">CreateFileMappingW</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPSECURITY_ATTRIBUTES lpFileMappingAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD flProtect,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeHigh,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeLow,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCWSTR lpName</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>hFile</td>
<td>hFile !&#x3D; NULLï¼Œåˆ›å»ºåŸºäºæ–‡ä»¶çš„å†…å­˜åŒºå¯¹è±¡ï¼ˆæ–‡ä»¶æ˜ å°„å¯¹è±¡ï¼‰ï¼ŒæŒ‡å‘æ–‡ä»¶å¯¹è±¡çš„å¥æŸ„ã€‚<br />hFile &#x3D;&#x3D; INVALID_HANDLE_VALUE(-1)ï¼Œåªåˆ›å»ºä¸€å—å…±äº«çš„å†…å­˜ï¼ˆå†…å­˜åŒºå¯¹è±¡ï¼ŒåŸºäºé¡µé¢page fileï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜å¿…é¡»åœ¨<em>dwMaximumSizeHigh</em>å’Œ<em>dwMaximumSizeLow</em>å‚æ•°ä¸­æŒ‡å®šæ˜ å°„å¯¹è±¡çš„å¤§å°ï¼Œè¿™ç§æƒ…å†µä¸‹è¯¥å‡½æ•°<strong>åˆ›å»ºä¸€ä¸ªæŒ‡å®šå¤§å°çš„æ–‡ä»¶æ˜ å°„å¯¹è±¡</strong>ã€‚</td>
</tr>
<tr>
<td>lpFileMappingAttributes</td>
<td>å®‰å…¨æè¿°ç¬¦ã€‚ç”¨äºç¡®å®šè¯¥å‡½æ•°è¿”å›çš„å†…å­˜åŒºå¯¹è±¡å¥æŸ„æ˜¯å¦å¯ä»¥ç”±å­è¿›ç¨‹ç»§æ‰¿ã€‚å…¸å‹çš„<strong>NULL</strong>å€¼è¡¨ç¤ºå¥æŸ„æ— æ³•è¢«ç»§æ‰¿ã€‚</td>
</tr>
<tr>
<td>flProtect</td>
<td>å†…å­˜åŒºè¢«åˆ›å»ºåï¼Œç‰©ç†å†…å­˜è¢«è®¿é—®æ—¶æä¾›çš„æƒé™ã€‚ä¸‹é¢çš„ä¿æŠ¤å±æ€§å¯ä»¥å’Œ <code>SEC_COMMIT</code>ã€<code>SEC_IMAGE</code>ã€<code>SEC_IMAGE_NO_EXECUTE</code>ã€<code>SEC_LARGE_PAGES</code>ã€<code>SEC_NOCACHE</code>ã€<code>SEC_RESERVE</code>ã€<code>SEC_WRITECOMBINE</code>ç»„åˆä½¿ç”¨ã€‚<img data-src="https://s2.loli.net/2022/09/16/s5LJR4fForSVUci.png" alt="37.png"><img data-src="https://s2.loli.net/2022/09/16/jaE71MS9ylmR4nI.png" alt="38.png"></td>
</tr>
<tr>
<td>dwMaximumSizeHigh</td>
<td>æ–‡ä»¶æ˜ å°„å¯¹è±¡æœ€å¤§å¤§å°çš„é«˜ 32 ä½ã€‚</td>
</tr>
<tr>
<td>dwMaximumSizeLow</td>
<td>1. æ–‡ä»¶æ˜ å°„å¯¹è±¡æœ€å¤§å¤§å°çš„ä½32ä½ï¼Œ<strong>æ˜ å°„é¡µé¢æ–‡ä»¶æ—¶éœ€è¦æŒ‡å®šè¿™ä¸¤ä¸ªå€¼å¤§å°ï¼Œæ˜ å°„æ–‡ä»¶è®¾ç½®ä¸º0å³å¯ã€‚</strong><br/>2. å°†å®ƒä»¬è®¾ç½®ä¸ºå°äºæ–‡ä»¶é•¿åº¦ï¼Œåªèƒ½æ˜ å°„æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒæŒ‡å®šä¸€ä¸ªå¤§äºæ–‡ä»¶é•¿åº¦çš„å¤§å°åˆ™ä¼šæ‰©å±•æ–‡ä»¶ã€‚æœ€åï¼Œå¦‚è¿™ä¸ªå‚æ•°å’Œ dwMaximumSizeHigh éƒ½æ˜¯é›¶ï¼Œé‚£ä¹ˆæ–‡ä»¶æ˜ å°„å¯¹è±¡çš„æœ€å¤§å¤§å°ç­‰äº hFile æŒ‡å®šæ–‡ä»¶çš„å®é™…å¤§å°ã€‚<br/>3. æ˜ å°„ä¸€ä¸ªå¤§å°ä¸º 0 çš„ç£ç›˜æ–‡ä»¶å°†ä¼šå¼•å‘å‡ºé”™ç ä¸º ERROR_FILE_INVALID çš„é”™è¯¯ã€‚åº”ç”¨ç¨‹åºåº”è¯¥æ£€æµ‹å¤§å°ä¸º 0 çš„æ–‡ä»¶ï¼Œå¹¶æ‹’ç»è¿™äº›æ–‡ä»¶ã€‚</td>
</tr>
<tr>
<td>lpName</td>
<td>1. æ–‡ä»¶æ˜ å°„å¯¹è±¡çš„åç§°<br/>2. å¦‚æœè¿™ä¸ªå‚æ•°ä¸ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶æ˜ å°„å¯¹è±¡çš„åç§°ç›¸åŒï¼Œé‚£ä¹ˆè¯¥å‡½æ•°è¯·æ±‚ä»¥ flProtect æŒ‡å®šçš„ä¿æŠ¤å±æ€§è®¿é—®è¯¥å¯¹è±¡<br/>3. å¦‚æœè¿™ä¸ªå‚æ•°ä¸º NULLï¼Œé‚£ä¹ˆåˆ›å»ºçš„è¿™ä¸ªæ–‡ä»¶æ˜ å°„å¯¹è±¡å°†æ²¡æœ‰åç§°<br/>4. å¦‚æœ lpName ä¸ä¸€ä¸ªç°æœ‰çš„äº‹ä»¶,ä¿¡å·é‡,äº’æ–¥é”,å¯ç­‰å¾…å®šæ—¶å™¨,æˆ–å·¥ä½œå¯¹è±¡åŒåï¼Œé‚£ä¹ˆå‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œå¹¶ä¸” <a target="_blank" rel="noopener" href="http://bbs.fishc.com/thread-69138-1-1.html">GetLassError</a> å‡½æ•°è¿”å› ERROR_INVALID_HANDLEã€‚å› ä¸ºè¿™äº›å¯¹è±¡å…±äº«ç›¸åŒçš„å‘½åç©ºé—´<br/>5. è¯¥åç§°å¯ä»¥æœ‰ä¸€ä¸ª â€œGlobal&quot; æˆ– â€œLocal&quot; å‰ç¼€æ¥åœ¨å…¨å±€æˆ–ä¼šè¯å‘½åç©ºé—´ä¸­æ˜¾ç¤ºåœ°åˆ›å»ºå¯¹è±¡ã€‚å…¶ä½™çš„åç§°å¯ä»¥åŒ…å«é™¤åæ–œæ å­—ç¬¦ï¼ˆ\ï¼‰ä»¥å¤–çš„ä»»ä½•å­—ç¬¦ã€‚åœ¨å…¨å±€å‘½åç©ºé—´ä¸­ä»ä¸€ä¸ªä¼šè¯è€Œä¸æ˜¯ä¼šè¯0ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ˜ å°„å¯¹è±¡éœ€è¦ <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa375728(v=vs.85).aspx">SeCreateGlobalPrivilege</a> ç‰¹æƒã€‚æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382954(v=vs.85).aspx">Kernel Object Namespaces</a><br/>6. å¿«é€Ÿç”¨æˆ·åˆ‡æ¢æ˜¯é€šè¿‡ä½¿ç”¨ç»ˆç«¯æœåŠ¡ä¼šè¯å®ç°çš„ã€‚ç¬¬ä¸€ä¸ªç”¨æˆ·ä»¥ä¼šè¯ 0 ç™»é™†ï¼Œç¬¬äºŒä¸ªç”¨æˆ·ä»¥ä¼šè¯ 1 ç™»é™†ç­‰ç­‰ã€‚å†…æ ¸å¯¹è±¡åç§°å¿…é¡»éµå¾ªä¸ºç»ˆç«¯æœåŠ¡æ‰€åˆ—å‡ºçš„æŒ‡å¯¼åŸåˆ™ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºå¯ä»¥æ”¯æŒå¤šä¸ªç”¨æˆ·</td>
</tr>
</tbody></table>
<p>å‡½æ•°å‚æ•°å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://fishc.com.cn/thread-70452-1-1.html">CreateFileMapping</a>â€“å°ç”²é±¼è®ºå›ã€‚</p>
<p>è¯¥å‡½æ•°çš„è°ƒç”¨è·¯çº¿å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel32!CreateFileMappingA --&gt; api-ms-win-core-memory-l1<span class="number">-1</span><span class="number">-1</span>!CreateFileMappingNumaW --&gt; </span><br><span class="line">KernelBase!CreateFileMappingNumaW --&gt; ntdll!NtCreateSection</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>api-ms-win-core-memory-l1-1-1.dll</code> åªæ˜¯åšäº†ä¸­è½¬ï¼Œå°†æ¥è‡ª <code>kernel32</code> çš„å‡½æ•°è°ƒç”¨ä¸­è½¬åˆ° <code>kernelbase</code> ä¸­ã€‚å…·ä½“çš„ä¸­è½¬ç®—æ³•å¯ä»¥çœ‹ï¼š<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7019">æ·±å…¥å‰–æ api-ms-* ç³»åˆ—åŠ¨æ€é“¾æ¥åº“</a>ã€<a target="_blank" rel="noopener" href="https://bitbucket.org/evolution536/crysearch-memory-scanner/raw/3c6486f841d4a7febceed3e467e000057ca776f3/PortableExecutable.cpp"> api-ms-*ä¸­è½¬æºç </a>ã€‚</p>
<h3 id="2-2-NtCreateSection"><a href="#2-2-NtCreateSection" class="headerlink" title="2.2 NtCreateSection"></a>2.2 NtCreateSection</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">NtCreateSection</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OUT PHANDLE SectionHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PLARGE_INTEGER MaximumSize OPTIONAL,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ULONG SectionPageProtection,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ULONG AllocationAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN HANDLE FileHandle OPTIONAL</span></span></span><br><span class="line"><span class="function"><span class="params">     )</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>SectionHandleï¼šè¾“å‡ºçš„å†…å­˜åŒºå¯¹è±¡ã€‚</p>
</li>
<li><p>DesiredAccessï¼šå†…å­˜åŒºå¯¹è±¡å¼€æ”¾çš„è®¿é—®æƒé™ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_QUERY       0x0001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_MAP_WRITE   0x0002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_MAP_READ    0x0004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_MAP_EXECUTE 0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_EXTEND_SIZE 0x0010</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_ALL_ACCESS (STANDARD_RIGHTS_REQUIRED|SECTION_QUERY|</span></span><br><span class="line">                            SECTION_MAP_WRITE |      </span><br><span class="line">                            SECTION_MAP_READ |       </span><br><span class="line">                            SECTION_MAP_EXECUTE |    </span><br><span class="line">                            SECTION_EXTEND_SIZE)</span><br><span class="line"><span class="comment">// SECTION_ALL_ACCESS == 0x000F001F                      </span></span><br><span class="line">                              </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STANDARD_RIGHTS_REQUIRED         (0x000F0000L)</span></span><br><span class="line"><span class="comment">// STANDARD_RIGHTS_REQUIREDæ˜¯ä¸‹é¢å››ä¸ªå±æ€§é›†åˆï¼Œè¡¨ç¤ºåŒ¿åç”¨æˆ·å¯¹å¯¹è±¡æ ‡å‡†è®¿é—®æƒé™</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE                           (0x00010000L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_CONTROL                     (0x00020000L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WRITE_DAC                        (0x00040000L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WRITE_OWNER                      (0x00080000L)</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>ObjectAttributesï¼šæŒ‡å‘ OBJECT_ATTRIBUTES ç»“æ„çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„åŒ…å«ä»¥å¯¹è±¡å‘½åç©ºé—´æ ¼å¼è¡¨ç¤ºçš„ Section åç§°ã€‚è¯¥å€¼å–è‡³CreateFileMappingçš„lpFileMappingAttributeså‚æ•°ã€‚</p>
</li>
<li><p>MaximumSizeï¼šæŒ‡å®šè¯¥å†…å­˜åŒºçš„æœ€å¤§å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</p>
<ul>
<li>page fileæ”¯æ’‘çš„å†…å­˜åŒºï¼šæŒ‡å®šè¯¥éƒ¨åˆ†çš„å®é™…å¤§å°ã€‚</li>
<li>æ˜ å°„æ–‡ä»¶æ”¯æ’‘çš„å†…å­˜åŒºï¼šæ–‡ä»¶å¯ä»¥æ‰©å±•æˆ–æ˜ å°„åˆ°çš„æœ€å¤§å¤§å°ã€‚</li>
</ul>
</li>
<li><p>SectionPageProtectionï¼šæŒ‡å®šå†…å­˜åŒºä¸­æ¯ä¸€ä¸ªé¡µé¢çš„ä¿æŠ¤å±æ€§ï¼Œä½¿ç”¨è¿™å››ä¸ªå€¼ä¹‹ä¸€ï¼šPAGE_READONLYã€PAGE_READWRITEã€PAGE_EXECUTEæˆ–PAGE_WRITECOPYã€‚</p>
</li>
<li><p>AllocationAttributesï¼šå†…å­˜åŒºçš„åˆ†é…å±æ€§ï¼Œç”± CreateFileMapping-flProtect.flags æ ‡å¿—ä¼ å…¥ã€‚</p>
</li>
<li><p>FileHandleï¼šå¯é€‰æ‹©æŒ‡å®šæ‰“å¼€çš„æ–‡ä»¶å¯¹è±¡çš„å¥æŸ„ã€‚å¦‚æœè¯¥å€¼ä¸º<strong>NULL</strong>ï¼Œåˆ™è¯¥éƒ¨åˆ†ç”±åˆ†é¡µæ–‡ä»¶æ”¯æŒã€‚å¦åˆ™ï¼Œè¯¥éƒ¨åˆ†ç”±æŒ‡å®šçš„æ–‡ä»¶æ”¯æŒã€‚</p>
</li>
</ul>
<p>å®é™…ä¸Š <code>SectionPageProtection </code>å’Œ <code>AllocationAttributes</code> å°±æ˜¯å°† <code>CreateFileMapping</code> çš„å‚æ•° <code>flProtect</code> çš„ä¸¤ä¸ªéƒ¨åˆ†æ‹†å¼€ã€‚</p>
<h3 id="2-3-å†…å­˜åŒºå¯¹è±¡æµ…æ"><a href="#2-3-å†…å­˜åŒºå¯¹è±¡æµ…æ" class="headerlink" title="2.3 å†…å­˜åŒºå¯¹è±¡æµ…æ"></a>2.3 å†…å­˜åŒºå¯¹è±¡æµ…æ</h3><p>å†…å­˜åŒºå¯¹è±¡ï¼Œå¦‚åŒå…¶ä»–çš„å¯¹è±¡ä¸€æ ·ï¼Œä¹Ÿæ˜¯ç”±å¯¹è±¡ç®¡ç†å™¨æ¥åˆ†é…å’Œé‡Šæ”¾çš„ã€‚<strong>å¯¹è±¡ç®¡ç†å™¨</strong>åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª<strong>å¯¹è±¡å¤´</strong>ï¼ˆå®ƒä½¿ç”¨å¯¹è±¡å¤´æ¥ç®¡ç†è¿™äº›å¯¹è±¡ï¼‰ï¼›è€Œå†…å­˜ç®¡ç†å™¨å®šä¹‰å†…å­˜åŒºå¯¹è±¡çš„å¯¹è±¡ä½“ã€‚æˆ‘ä»¬ä¸»è¦å…³æ³¨å¯¹è±¡ä½“ï¼Œå°±åƒ <code>_EPROCESS</code> å¯¹è±¡ä½“ä¸€æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x28 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SECTION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_BALANCED_NODE</span> <span class="title">SectionNode</span>;</span>                                  <span class="comment">//0x0</span></span><br><span class="line">    ULONG StartingVpn;                                                      <span class="comment">//0xc</span></span><br><span class="line">    ULONG EndingVpn;                                                        <span class="comment">//0x10</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">CONTROL_AREA</span>* <span class="title">ControlArea</span>;</span>                                  <span class="comment">//0x14</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">FILE_OBJECT</span>* <span class="title">FileObject</span>;</span>                                    <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteImageFileObject:<span class="number">1</span>;                                      <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteDataFileObject:<span class="number">1</span>;                                       <span class="comment">//0x14</span></span><br><span class="line">    &#125; u1;                                                                   <span class="comment">//0x14</span></span><br><span class="line">    ULONGLONG SizeOfSection;                                                <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LongFlags;                                                    <span class="comment">//0x20</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">MMSECTION_FLAGS</span> <span class="title">Flags</span>;</span>                                      <span class="comment">//0x20</span></span><br><span class="line">    &#125; u;                                                                    <span class="comment">//0x20</span></span><br><span class="line">    ULONG InitialPageProtection:<span class="number">12</span>;                                         <span class="comment">//0x24</span></span><br><span class="line">    ULONG SessionId:<span class="number">19</span>;                                                     <span class="comment">//0x24</span></span><br><span class="line">    ULONG NoValidationNeeded:<span class="number">1</span>;                                             <span class="comment">//0x24</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p><code>CreateFileMapping</code> å‡½æ•°è¿”å›å€¼ä¸ºå…¶æ‰€åˆ›å»ºçš„å†…å­˜åŒºå¯¹è±¡å¥æŸ„ï¼Œè¯¥å¥æŸ„æŒ‡å‘ <code>_SECTION</code> å¯¹è±¡ã€‚ <code>_SECTION</code> å¯¹è±¡ä¸­æœ€é‡è¦çš„æˆå‘˜å°±æ˜¯æ§åˆ¶åŒº <code>ControlArea(_CONTROL_AREA)</code> æˆå‘˜ã€‚æ§åˆ¶åŒºæ˜¯ä¸€ä¸ªè¿æ¥å…¶ä»–å†…å­˜ç®¡ç†ç»„ä»¶çš„ä¸­é—´æ¢çº½ï¼Œæ§åˆ¶åŒºä¸­çš„æ®µ <code>Segment(_SEGMENT)</code> é™¤äº†å’Œæ§åˆ¶åŒºäº’ç›¸æŒ‡å‘ä¹‹å¤–ï¼Œæœ€é‡è¦çš„å°±æ˜¯<strong>æä¾›å†…å­˜åŒºçš„åŸå‹PTEæ•°ç»„</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !handle <span class="number">0</span> <span class="number">3</span> Section</span><br><span class="line">PROCESS <span class="number">8b</span>f02040  SessionId: <span class="number">0</span>  Cid: <span class="number">0448</span>    Peb: <span class="number">02</span>eb2000  ParentCid: <span class="number">02</span>a0</span><br><span class="line">    DirBase: <span class="number">7f</span>0eb400  ObjectTable: <span class="number">9</span>a03d700  HandleCount: <span class="number">2463.</span></span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">Handle table at <span class="number">9</span>a03d700 with <span class="number">2463</span> entries in use</span><br><span class="line">...</span><br><span class="line"><span class="number">1f</span>54: Object: f65a8780  GrantedAccess: <span class="number">000f</span>0007 Entry: a5b8dea8</span><br><span class="line">Object: f65a8780  Type: (<span class="number">853f</span>d3f0) Section</span><br><span class="line">    ObjectHeader: f65a8768 (<span class="keyword">new</span> version)</span><br><span class="line">        HandleCount: <span class="number">1</span>  PointerCount: <span class="number">14</span></span><br><span class="line">        Directory Object: <span class="number">00000000</span>  Name: \Windows\SoftwareDistribution\DataStore\DataStore.edb</span><br></pre></td></tr></table></figure>



<ol>
<li><p>æŸ¥çœ‹è¯¥<strong>å†…å­˜åŒºçš„ä¿¡æ¯</strong>ã€‚å¯ä»¥çœ‹åˆ°è¯¥å†…å­˜åŒºè¿˜æ²¡æœ‰æ˜ å°„åˆ°å½“å‰è¿›ç¨‹ï¼Œè¿˜æ²¡æœ‰ VAD èŠ‚ç‚¹ç›¸å…³ä¿¡æ¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _SECTION <span class="number">0xf65a8780</span> /r1</span><br><span class="line">nt!_SECTION</span><br><span class="line">   +<span class="number">0x000</span> SectionNode      : _RTL_BALANCED_NODE</span><br><span class="line">      +<span class="number">0x000</span> Children         : [<span class="number">2</span>] (null) </span><br><span class="line">      +<span class="number">0x000</span> Left             : (null) </span><br><span class="line">      +<span class="number">0x004</span> Right            : (null) </span><br><span class="line">      +<span class="number">0x008</span> Red              : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x008</span> Balance          : <span class="number">0</span>y00</span><br><span class="line">      +<span class="number">0x008</span> ParentValue      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> StartingVpn      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x010</span> EndingVpn        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x014</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">      +<span class="number">0x000</span> FileObject       : <span class="number">0x80e38928</span> _FILE_OBJECT</span><br><span class="line">      +<span class="number">0x000</span> RemoteImageFileObject : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> RemoteDataFileObject : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x018</span> SizeOfSection    : <span class="number">0x1540000</span></span><br><span class="line">   +<span class="number">0x020</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> LongFlags        : <span class="number">0x8018080</span></span><br><span class="line">      +<span class="number">0x000</span> Flags            : _MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x024</span> InitialPageProtection : <span class="number">0</span>y000000000100 (<span class="number">0x4</span>)</span><br><span class="line">   +<span class="number">0x024</span> SessionId        : <span class="number">0</span>y0000000000000000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x024</span> NoValidationNeeded : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœ‹ä¸€ä¸‹è¯¥å†…å­˜åŒºçš„ç›¸å…³ä¿æŠ¤ä¿¡æ¯ï¼ˆ<code>Flags(_MMSECTION_FLAGS)</code>ï¼‰ã€‚</p>
<p>å¯ä»¥çœ‹åˆ° <code>File == 1</code>ï¼Œè¯´æ˜æ˜¯ç”±æ–‡ä»¶æ˜ å°„çš„å†…å­˜åŒºã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _MMSECTION_FLAGS <span class="number">0xf65a87a0</span></span><br><span class="line">nt!_MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x000</span> BeingDeleted     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingCreated     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingPurged      : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoModifiedWriting : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FailAllIo        : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Image            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Based            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> File             : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> AttemptingDelete : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PrefetchCreated  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PhysicalMemory   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> ImageControlAreaOnRemovableMedia : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Reserve          : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Commit           : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoChange         : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> WasPurged        : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> UserReference    : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> GlobalMemory     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> DeleteOnClose    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FilePointerNull  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredNode    : <span class="number">0</span>y000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x000</span> GlobalOnlyPerSession : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UserWritable     : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> SystemVaAllocated : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredFsCompressionBoundary : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UsingFileExtents : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PageSize64K      : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure>


</li>
<li><p>æŸ¥çœ‹<strong>æ§åˆ¶åŒºç›¸å…³ä¿¡æ¯</strong>ã€‚å¯ä»¥çœ‹åˆ°æ§åˆ¶åŒºç¬¬ä¸€ä¸ªæˆå‘˜ <code>Segment</code>ã€‚<code>Segment</code> çš„ç¬¬ä¸€ä¸ªæˆå‘˜åˆæŒ‡å‘æ§åˆ¶åŒºæœ¬èº«ï¼Œä»–ä»¬æ˜¯äº’æŒ‡çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt <span class="number">0x80e38928</span> _CONTROL_AREA /r1</span><br><span class="line">nt!_CONTROL_AREA</span><br><span class="line">   +<span class="number">0x000</span> Segment          : <span class="number">0x948308d0</span> _SEGMENT</span><br><span class="line">      +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">      +<span class="number">0x004</span> TotalNumberOfPtes : <span class="number">0x1600</span></span><br><span class="line">      +<span class="number">0x008</span> SegmentFlags     : _SEGMENT_FLAGS</span><br><span class="line">      +<span class="number">0x00c</span> NumberOfCommittedPages : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x010</span> SizeOfSegment    : <span class="number">0x1600000</span></span><br><span class="line">      +<span class="number">0x018</span> ExtendInfo       : (null) </span><br><span class="line">      +<span class="number">0x018</span> BasedAddress     : (null) </span><br><span class="line">      +<span class="number">0x01c</span> SegmentLock      : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x024</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x028</span> PrototypePte     : <span class="number">0xeabc46a0</span> _MMPTE</span><br><span class="line">   +<span class="number">0x004</span> ListHead         : _LIST_ENTRY [ <span class="number">0xa36e76b8</span> - <span class="number">0xae401270</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0xa36e76b8</span> _LIST_ENTRY [ <span class="number">0xa36e78c8</span> - <span class="number">0x80e3892c</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0xae401270</span> _LIST_ENTRY [ <span class="number">0x80e3892c</span> - <span class="number">0x8a23d860</span> ]</span><br><span class="line">   +<span class="number">0x004</span> AweContext       : <span class="number">0xa36e76b8</span> Void</span><br><span class="line">   +<span class="number">0x00c</span> NumberOfSectionReferences : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x010</span> NumberOfPfnReferences : <span class="number">0xcc0</span></span><br><span class="line">   +<span class="number">0x014</span> NumberOfMappedViews : <span class="number">0x134</span></span><br><span class="line">   +<span class="number">0x018</span> NumberOfUserReferences : <span class="number">0x135</span></span><br><span class="line">   +<span class="number">0x01c</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> LongFlags        : <span class="number">0x8080</span></span><br><span class="line">      +<span class="number">0x000</span> Flags            : _MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x020</span> FilePointer      : _EX_FAST_REF</span><br><span class="line">      +<span class="number">0x000</span> Object           : <span class="number">0x8153ad45</span> Void</span><br><span class="line">      +<span class="number">0x000</span> RefCnt           : <span class="number">0</span>y101</span><br><span class="line">      +<span class="number">0x000</span> Value            : <span class="number">0x8153ad45</span></span><br><span class="line">   +<span class="number">0x024</span> ControlAreaLock  : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x028</span> ModifiedWriteCount : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> WaitList         : (null) </span><br><span class="line">   +<span class="number">0x030</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> e2               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x03c</span> FileObjectLock   : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x000</span> Locked           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waiting          : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waking           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> MultipleShared   : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Shared           : <span class="number">0</span>y0000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Value            : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x000</span> Ptr              : (null) </span><br><span class="line">   +<span class="number">0x040</span> LockedPages      : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x048</span> u3               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> IoAttributionContext : <span class="number">0</span>y00000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Spare            : <span class="number">0</span>y000</span><br><span class="line">      +<span class="number">0x000</span> ImageCrossPartitionCharge : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x000</span> CommittedPageCount : <span class="number">0</span>y00000000000000000000 (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜æ˜¯å…³å¿ƒ<strong>æè¿°è¯¥æ§åˆ¶åŒºæ‰€åœ¨å†…å­˜åŒºå±æ€§</strong>çš„ <code>Flags(_MMSECTION_FLAGS)</code>ï¼š</p>
<ul>
<li><code>Image: 0y0</code> è¯´æ˜è¯¥å†…å­˜åŒºæ˜ å°„æ–‡ä»¶æ˜¯ä¸€ä¸ªæ•°æ®æ–‡ä»¶ï¼ŒéPEæ–‡ä»¶ã€‚</li>
<li><code>PhysicalMemory: 0y0</code> è¯´æ˜è¯¥å†…å­˜åŒºè¿˜æ²¡æœ‰æŒ‚ä¸Šç‰©ç†é¡µã€‚</li>
<li><code>Reserve/Commit: 0y0</code> ä¸€èˆ¬ç”¨äºåŸºäº page file çš„å…±äº«å†…å­˜ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _MMSECTION_FLAGS <span class="number">0x80e38944</span></span><br><span class="line">nt!_MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x000</span> BeingDeleted     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingCreated     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingPurged      : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoModifiedWriting : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FailAllIo        : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Image            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Based            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> File             : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> AttemptingDelete : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PrefetchCreated  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PhysicalMemory   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> ImageControlAreaOnRemovableMedia : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Reserve          : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Commit           : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoChange         : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> WasPurged        : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> UserReference    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> GlobalMemory     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> DeleteOnClose    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FilePointerNull  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredNode    : <span class="number">0</span>y000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x000</span> GlobalOnlyPerSession : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UserWritable     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> SystemVaAllocated : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredFsCompressionBoundary : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UsingFileExtents : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PageSize64K      : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure>

<p>å…³äºæ§åˆ¶åŒºï¼Œæˆ‘ä»¬è¿˜å…³å¿ƒåœ¨ AVD ç« èŠ‚å­¦ä¹ åˆ°çš„ï¼Œæ–‡ä»¶å¯¹è±¡ <code>FilePointer</code> çš„å¿«é€Ÿå¼•ç”¨ <code>_EX_FAST_REF</code>ã€‚</p>
<p>å¯ä»¥çœ‹åˆ° <code>RefCnt == 0y101 == 0x5</code>ï¼Œå¼•ç”¨æ¬¡æ•°ä¸º <code>15 - 5 == 10</code> æ¬¡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+<span class="number">0x020</span> FilePointer      : _EX_FAST_REF</span><br><span class="line">   +<span class="number">0x000</span> Object           : <span class="number">0x8153ad45</span> Void</span><br><span class="line">   +<span class="number">0x000</span> RefCnt           : <span class="number">0</span>y101</span><br><span class="line">   +<span class="number">0x000</span> Value            : <span class="number">0x8153ad45</span></span><br></pre></td></tr></table></figure>



<p>x86ä¸‹ï¼Œä½¿ç”¨æ©ç  <code>0xFFFFFFF8</code> æŸ¥çœ‹æ–‡ä»¶å¯¹è±¡ <code>_FILE_OBJECT</code> ä¿¡æ¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _FILE_OBJECT (<span class="number">0x8153ad45</span> &amp; <span class="number">0xFFFFFFF8</span>)</span><br><span class="line">nt!_FILE_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : <span class="number">0</span>n5</span><br><span class="line">   +<span class="number">0x002</span> Size             : <span class="number">0</span>n128</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : <span class="number">0x8b889ca0</span> _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x008</span> Vpb              : <span class="number">0x89ef8dc8</span> _VPB</span><br><span class="line">   +<span class="number">0x00c</span> FsContext        : <span class="number">0x9d5ee830</span> Void</span><br><span class="line">   +<span class="number">0x010</span> FsContext2       : <span class="number">0x9d5ee9f0</span> Void</span><br><span class="line">   +<span class="number">0x014</span> SectionObjectPointer : <span class="number">0x814a57fc</span> _SECTION_OBJECT_POINTERS</span><br><span class="line">   +<span class="number">0x018</span> PrivateCacheMap  : (null) </span><br><span class="line">   +<span class="number">0x01c</span> FinalStatus      : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x020</span> RelatedFileObject : (null) </span><br><span class="line">   +<span class="number">0x024</span> LockOperation    : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x025 DeletePending    : 0 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x026</span> ReadAccess       : <span class="number">0x1</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x027 WriteAccess      : 0x1 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x028</span> DeleteAccess     : <span class="number">0x1</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x029 SharedRead       : 0 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x02a</span> SharedWrite      : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x02b SharedDelete     : 0 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x02c</span> Flags            : <span class="number">0x144050</span></span><br><span class="line">   +<span class="number">0x030</span> FileName         : _UNICODE_STRING <span class="string">&quot;\Windows\SoftwareDistribution\DataStore\DataStore.edb&quot;</span></span><br><span class="line">   +<span class="number">0x038</span> CurrentByteOffset : _LARGE_INTEGER <span class="number">0x0</span></span><br><span class="line">   +<span class="number">0x040</span> Waiters          : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Busy             : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> LastLock         : (null) </span><br><span class="line">   +<span class="number">0x04c</span> Lock             : _KEVENT</span><br><span class="line">   +<span class="number">0x05c</span> Event            : _KEVENT</span><br><span class="line">   +<span class="number">0x06c</span> CompletionContext : (null) </span><br><span class="line">   +<span class="number">0x070</span> IrpListLock      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x074</span> IrpList          : _LIST_ENTRY [ <span class="number">0x8153adb4</span> - <span class="number">0x8153adb4</span> ]</span><br><span class="line">   +<span class="number">0x07c</span> FileObjectExtension : (null) </span><br></pre></td></tr></table></figure>




</li>
<li><p>æŸ¥çœ‹æ–‡ä»¶å¯¹è±¡çš„ <code>SectionObjectPointer(_SECTION_OBJECT_POINTERS)</code> æˆå‘˜ä¿¡æ¯ã€‚</p>
<p>å¯¹äºæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼ˆé€šè¿‡ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡æ¥è¡¨ç¤ºï¼‰ï¼Œéƒ½æœ‰ä¸€ä¸ª<strong>å†…å­˜åŒºå¯¹è±¡æŒ‡é’ˆæ•°ç»„</strong>ï¼ˆsection object pointersï¼‰çš„ç»“æ„ <code>_SECTION_OBJECT_POINTERS</code>ã€‚æ­¤ç»“æ„å¯¹äºç»´æŠ¤å„ç§ç±»å‹çš„æ–‡ä»¶è®¿é—®çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä»¥åŠä¸ºæ–‡ä»¶æä¾›ç¼“å­˜èƒ½åŠ›æ˜¯éå¸¸å…³é”®çš„ã€‚å†…å­˜åŒºå¯¹è±¡æŒ‡é’ˆæ•°ç»„ç»“æ„æŒ‡å‘<strong>ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªæ§åˆ¶åŒºåŸŸ</strong>ï¼ˆcontrol areaï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xc bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SECTION_OBJECT_POINTERS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// åªæœ‰DataSectionObjectã€ImageSectionObjectæŒ‡å‘æ‰€åœ¨å†…å­˜åŒºçš„æ§åˆ¶åŒº</span></span><br><span class="line">    VOID* DataSectionObject;                                                <span class="comment">//0x0</span></span><br><span class="line">    VOID* SharedCacheMap;                                                   <span class="comment">//0x4</span></span><br><span class="line">    VOID* ImageSectionObject;                                               <span class="comment">//0x8</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªæ§åˆ¶åŒºåŸŸçš„ç”¨é€”æ˜¯ï¼Œå½“è¯¥æ–‡ä»¶è¢«å½“ä½œä¸€ä¸ª<strong>æ•°æ®æ–‡ä»¶æ¥è®¿é—®æ—¶</strong>ï¼Œè¯¥æ§åˆ¶åŒºåŸŸè¢«ç”¨äºæ˜ å°„æ­¤æ–‡ä»¶ï¼›å¦ä¸€ä¸ªæ§åˆ¶åŒºåŸŸçš„ç”¨é€”æ˜¯ï¼Œå½“è¯¥æ–‡ä»¶è¢«å½“ä½œ<strong>å¯æ‰§è¡Œæ˜ åƒæ¥è¿è¡Œæ—¶</strong>ï¼Œå®ƒè¢«ç”¨äºæ˜ å°„æ­¤æ­¤æ–‡ä»¶ã€‚<strong>å¯¹äºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆæ˜¯åŒæ—¶å­˜åœ¨</strong>ã€‚å¯ä»¥çœ‹ä¸‹é¢çœ‹é›ªçš„è¿™ç¯‡æ–‡ä»¶ï¼Œæœ‰ç›¸å…³ä»‹ç»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt <span class="number">0x814a57fc</span> _SECTION_OBJECT_POINTERS</span><br><span class="line">nt!_SECTION_OBJECT_POINTERS</span><br><span class="line">   +<span class="number">0x000</span> DataSectionObject : <span class="number">0x80e38928</span> Void</span><br><span class="line">   +<span class="number">0x004</span> SharedCacheMap   : <span class="number">0x81497b50</span> Void</span><br><span class="line">   +<span class="number">0x008</span> ImageSectionObject : (null) </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªæˆå‘˜ <code>DataSectionObject:0x80e38928</code> æ˜¯åªæƒ³ä¸Šé¢æåˆ°çš„æ§åˆ¶åŒº <code>_CONTROL_AREA</code> çš„ã€‚  </p>
</li>
<li><p>æŸ¥çœ‹<strong>æ®µç›¸å…³ä¿¡æ¯</strong>ã€‚ç¬¬ä¸€ä¸ªæˆå‘˜ <code>ControlArea</code> æŒ‡å‘ä¹‹å‰çš„æ§åˆ¶åŒºï¼Œæ‰€ä»¥æ®µå’Œæ§åˆ¶åŒºæ˜¯äº’æŒ‡çš„ã€‚å…¶ä¸­ï¼š</p>
<ul>
<li><code>BasedAddress: NULL</code>ï¼Œå¦‚æœæ˜¯PEæ–‡ä»¶ï¼Œè¿™ä¸ªåœ°æ–¹æ˜¯PEæ–‡ä»¶æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€çš„ <code>ImageBase</code>ã€‚ASLR åŠ¨æ€åŠ è½½è®¡ç®—çš„å°±æ˜¯è¿™ä¸ªåœ°æ–¹ã€‚å¯ä»¥å‚è€ƒã€Š<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268856.htm">æ–‡ä»¶æ˜ å°„ä¹‹åœ°å€éšæœºåŒ–åŸç†ï¼ˆWin10 x64ï¼‰-â€œç¼“å­˜â€</a>ã€‹ã€‚</li>
<li>å…¶æ¬¡æˆ‘ä»¬æ¯”è¾ƒå…³ç³»æè¿° <code>_SEGMENT</code> å±æ€§çš„<code>_SEGMENT_FLAGS</code>ã€‚&#x3D;&#x3D;&#x3D; <code>ImageSigningType: 0y000</code> è¯´æ˜è¯¥æ˜ å°„æ–‡ä»¶æ˜¯ä¸€ä¸ªæ•°æ®æ–‡ä»¶ï¼ŒéPEæ–‡ä»¶ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt <span class="number">0x948308d0</span> _SEGMENT /r1</span><br><span class="line">nt!_SEGMENT</span><br><span class="line">   +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">      +<span class="number">0x000</span> Segment          : <span class="number">0x948308d0</span> _SEGMENT</span><br><span class="line">      +<span class="number">0x004</span> ListHead         : _LIST_ENTRY [ <span class="number">0xa36e76b8</span> - <span class="number">0xae401270</span> ]</span><br><span class="line">      +<span class="number">0x004</span> AweContext       : <span class="number">0xa36e76b8</span> Void</span><br><span class="line">      +<span class="number">0x00c</span> NumberOfSectionReferences : <span class="number">2</span></span><br><span class="line">      +<span class="number">0x010</span> NumberOfPfnReferences : <span class="number">0xcc0</span></span><br><span class="line">      +<span class="number">0x014</span> NumberOfMappedViews : <span class="number">0x134</span></span><br><span class="line">      +<span class="number">0x018</span> NumberOfUserReferences : <span class="number">0x135</span></span><br><span class="line">      +<span class="number">0x01c</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x020</span> FilePointer      : _EX_FAST_REF</span><br><span class="line">      +<span class="number">0x024</span> ControlAreaLock  : <span class="number">0</span>n0</span><br><span class="line">      +<span class="number">0x028</span> ModifiedWriteCount : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x02c</span> WaitList         : (null) </span><br><span class="line">      +<span class="number">0x030</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x03c</span> FileObjectLock   : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x040</span> LockedPages      : <span class="number">1</span></span><br><span class="line">      +<span class="number">0x048</span> u3               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x004</span> TotalNumberOfPtes : <span class="number">0x1600</span></span><br><span class="line">   +<span class="number">0x008</span> SegmentFlags     : _SEGMENT_FLAGS</span><br><span class="line">      +<span class="number">0x000</span> TotalNumberOfPtes4132 : <span class="number">0</span>y0000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Spare0           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> SessionDriverProtos : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> LargePages       : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> DebugSymbolsLoaded : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> WriteCombined    : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> NoCache          : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Short0           : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x002</span> Spare            : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x002</span> DefaultProtectionMask : <span class="number">0</span>y00110 (<span class="number">0x6</span>)</span><br><span class="line">      +<span class="number">0x002</span> Binary32         : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x002</span> ContainsDebug    : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x002</span> UChar1           : <span class="number">0xc</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      +0x003 ForceCollision   : 0y0</span><br><span class="line">      +<span class="number">0x003</span> ImageSigningType : <span class="number">0</span>y000</span><br><span class="line">      +<span class="number">0x003</span> ImageSigningLevel : <span class="number">0</span>y0000</span><br><span class="line">      +<span class="number">0x003</span> UChar2           : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x00c NumberOfCommittedPages : 0</span><br><span class="line">   +<span class="number">0x010</span> SizeOfSegment    : <span class="number">0x1600000</span></span><br><span class="line">   +<span class="number">0x018</span> ExtendInfo       : (null) </span><br><span class="line">   +<span class="number">0x018</span> BasedAddress     : (null) </span><br><span class="line">   +<span class="number">0x01c</span> SegmentLock      : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x000</span> Locked           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waiting          : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waking           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> MultipleShared   : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Shared           : <span class="number">0</span>y0000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Value            : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x000</span> Ptr              : (null) </span><br><span class="line">   +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> ImageCommitment  : <span class="number">0x6050000</span></span><br><span class="line">      +<span class="number">0x000</span> CreatingProcessId : <span class="number">0x6050000</span></span><br><span class="line">   +<span class="number">0x024</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> ImageInformation : <span class="number">0x7346744e</span> _MI_SECTION_IMAGE_INFORMATION</span><br><span class="line">      +<span class="number">0x000</span> FirstMappedVa    : <span class="number">0x7346744e</span> Void</span><br><span class="line">   +<span class="number">0x028</span> PrototypePte     : <span class="number">0xeabc46a0</span> _MMPTE</span><br><span class="line">      +<span class="number">0x000</span> u                : &lt;anonymous-tag&gt;</span><br></pre></td></tr></table></figure>


</li>
<li><p>ä½¿ç”¨æ§åˆ¶åŒºä¸“ç”¨æŒ‡ä»¤ <code>!ca</code> æ¥è§£ææ§åˆ¶åŒºå¯¹è±¡ã€‚å¯ä»¥çœ‹åˆ°åœ¨æ§åˆ¶åŒºåé¢æœ‰å¾ˆå¤šä¸ª <code>subsection</code>ã€‚å¯¹äºå…±äº«å†…å­˜ï¼ˆä¸æ˜ å°„æ–‡ä»¶ç›¸åï¼‰ï¼Œé€šå¸¸åªæœ‰ä¸€ä¸ª<strong>subsection</strong>çš„å®ä¾‹ï¼Œæ‰€ä»¥ <code>subsection</code>å¯¹<strong>segment</strong>å·²ç»æä¾›çš„ä¿¡æ¯æ²¡æœ‰å¢åŠ å¤šå°‘ï¼Œç„¶è€Œå®ƒçš„é‡è¦æ€§åœ¨æ˜ å°„æ–‡ä»¶ä¸­ä¼šå˜å¾—æ›´æ˜æ˜¾ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !ca <span class="number">0x80e38928</span> </span><br><span class="line"></span><br><span class="line">ControlArea  @ <span class="number">80e38928</span></span><br><span class="line">  Segment      <span class="number">948308</span>d0  Flink      a36e76b8  Blink        ae401270</span><br><span class="line">  Section Ref         <span class="number">2</span>  Pfn Ref         cc0  Mapped Views      <span class="number">134</span></span><br><span class="line">  User Ref          <span class="number">135</span>  WaitForDel        <span class="number">0</span>  Flush Count         <span class="number">0</span></span><br><span class="line">  File Object  <span class="number">8153</span>ad40  ModWriteCount     <span class="number">0</span>  System Views        <span class="number">0</span></span><br><span class="line">  WritableRefs        <span class="number">1</span>  PartitionId        <span class="number">0</span>  </span><br><span class="line">  Flags (<span class="number">8080</span>) File WasPurged </span><br><span class="line"></span><br><span class="line">      \Windows\SoftwareDistribution\DataStore\DataStore.edb</span><br><span class="line">Control area <span class="number">80e38928</span> file object-&gt;sectionobjectpointers linkage invalid.</span><br><span class="line"></span><br><span class="line">Segment @ <span class="number">948308</span>d0</span><br><span class="line">  ControlArea       <span class="number">80e38928</span>  ExtendInfo    <span class="number">00000000</span></span><br><span class="line">  Total Ptes            <span class="number">1600</span></span><br><span class="line">  Segment Size       <span class="number">1600000</span>  Committed            <span class="number">0</span></span><br><span class="line">  Flags (c0000) ProtectionMask </span><br><span class="line"></span><br><span class="line">Subsection <span class="number">1</span> @ <span class="number">80e38978</span></span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector        <span class="number">0</span>  Number Of Sectors  <span class="number">800</span></span><br><span class="line">  Base Pte     <span class="number">9b</span>23e000  Ptes In Subsect      <span class="number">800</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags               d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed </span><br><span class="line">  Flink        <span class="number">80e389</span>ac  Blink           <span class="number">80e389</span>ac  MappedViews         <span class="number">49</span></span><br><span class="line"></span><br><span class="line">Subsection <span class="number">2</span> @ <span class="number">85360e18</span></span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector      <span class="number">800</span>  Number Of Sectors  <span class="number">800</span></span><br><span class="line">  Base Pte     <span class="number">9b</span>37b000  Ptes In Subsect      <span class="number">800</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags               d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed </span><br><span class="line">  Flink        <span class="number">85360e4</span>c  Blink           <span class="number">85360e4</span>c  MappedViews         c8</span><br><span class="line"></span><br><span class="line">Subsection <span class="number">3</span> @ <span class="number">85387b</span>18</span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector     <span class="number">1000</span>  Number Of Sectors  <span class="number">400</span></span><br><span class="line">  Base Pte     <span class="number">9b</span>3c0000  Ptes In Subsect      <span class="number">400</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags               d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed </span><br><span class="line">  Flink        <span class="number">85387b</span>4c  Blink           <span class="number">85387b</span>4c  MappedViews         <span class="number">20</span></span><br><span class="line"></span><br><span class="line">Subsection <span class="number">4</span> @ <span class="number">8</span>a2e81b0</span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector     <span class="number">1400</span>  Number Of Sectors  <span class="number">200</span></span><br><span class="line">  Base Pte     b5dde000  Ptes In Subsect      <span class="number">200</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags           <span class="number">1000</span>d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed Static </span><br><span class="line">  Flink        <span class="number">8</span>a2e81e4  Blink           <span class="number">8</span>a2e81e4  MappedViews          <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  VAD ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶åŒº <code>_CONTROL_AREA</code>  åªæ˜¯ <code>_SUBSECTION</code> çš„ç¬¬ä¸€ä¸ªæˆå‘˜ã€‚æ‰€ä»¥è¿™é‡Œçœ‹èµ·æ¥æœ‰ä¸€äº›å¥‡æ€ªï¼Œä¸ºä»€ä¹ˆè¿™é‡Œçš„æ§åˆ¶åŒºåé¢è·Ÿç€è¿™ä¹ˆå¤šå­å†…å­˜åŒºå‘¢ï¼Ÿæ‰€ä»¥<strong>æˆ‘æ¥è®ºè¯è¿™é‡Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª <code>_SUBSECTION</code> ç»“æ„</strong>ï¼š</p>
<ul>
<li><p>é¦–å…ˆæ¥æŸ¥çœ‹ <code>_SUBSECTION</code> ç»“æ„ï¼Œæˆ‘çŒœæµ‹ <code>_CONTROL_AREA</code> æœ¬èº«å°±æ˜¯ä¸€ä¸ª <code>_SUBSECTION</code> çš„æˆå‘˜ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹ä½¿ç”¨çš„ç»“æ„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _SUBSECTION</span><br><span class="line">nt!_SUBSECTION</span><br><span class="line">   +<span class="number">0x000</span> ControlArea      : Ptr32 _CONTROL_AREA</span><br><span class="line">   +<span class="number">0x004</span> SubsectionBase   : Ptr32 _MMPTE</span><br><span class="line">   +<span class="number">0x008</span> NextSubsection   : Ptr32 _SUBSECTION</span><br><span class="line">   +<span class="number">0x00c</span> GlobalPerSessionHead : _RTL_AVL_TREE</span><br><span class="line">   +<span class="number">0x00c</span> CreationWaitList : Ptr32 _MI_CONTROL_AREA_WAIT_BLOCK</span><br><span class="line">   +<span class="number">0x00c</span> SessionDriverProtos : Ptr32 _MI_PER_SESSION_PROTOS</span><br><span class="line">   +<span class="number">0x010</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x014</span> StartingSector   : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> NumberOfFullSectors : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> PtesInSubsection : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x024</span> UnusedPtes       : Pos <span class="number">0</span>, <span class="number">30</span> Bits</span><br><span class="line">   +<span class="number">0x024</span> ExtentQueryNeeded : Pos <span class="number">30</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x024</span> DirtyPages       : Pos <span class="number">31</span>, <span class="number">1</span> Bit</span><br></pre></td></tr></table></figure>


</li>
<li><p>è¿™é‡Œçš„ <code>ControlArea</code> åœ°å€ä¸º <code>0x80e38928</code>ï¼Œç¬¬ä¸€ä¸ª <code>_SUBSECTION</code> åœ°å€ä¸º <code>80e38978</code>ï¼š</p>
<p><strong>æ³¨æ„çœ‹</strong>ï¼šç¬¬ä¸€ä¸ªæˆå‘˜æ§åˆ¶åŒºçš„åœ°å€ <code>0x80e38928</code>ï¼Œä»¥åŠä¸‹ä¸€ä¸ª <code>_SUBSECTION</code> å’Œä¸Šé¢ <code>!ca</code> æŒ‡ä»¤è¾“å‡ºçš„æƒ…å†µæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚</p>
<p>æ‰€ä»¥å¾—åˆ°éªŒè¯ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šè¿™äº›<mark class="label success">æ‰€æœ‰å­å†…å­˜åŒºæŒ‡å‘çš„æ§åˆ¶åŒºå¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ª</mark>ï¼Œéƒ½æ˜¯ <code>0x80e38928</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _SUBSECTION <span class="number">0x80e38978</span></span><br><span class="line">nt!_SUBSECTION</span><br><span class="line">   +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">   +<span class="number">0x004</span> SubsectionBase   : <span class="number">0x9b23e000</span> _MMPTE</span><br><span class="line">   +<span class="number">0x008</span> NextSubsection   : <span class="number">0x85360e18</span> _SUBSECTION</span><br><span class="line">   +<span class="number">0x00c</span> GlobalPerSessionHead : _RTL_AVL_TREE</span><br><span class="line">   +<span class="number">0x00c</span> CreationWaitList : (null) </span><br><span class="line">   +<span class="number">0x00c</span> SessionDriverProtos : (null) </span><br><span class="line">   +<span class="number">0x010</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x014</span> StartingSector   : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x018</span> NumberOfFullSectors : <span class="number">0x800</span></span><br><span class="line">   +<span class="number">0x01c</span> PtesInSubsection : <span class="number">0x800</span></span><br><span class="line">   +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x024</span> UnusedPtes       : <span class="number">0</span>y000000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x024</span> ExtentQueryNeeded : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x024</span> DirtyPages       : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>ä¸‹é¢åˆ—å‡ºå‡ ä¸ªå¯¹è±¡ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/17/KPqWhvGFib6asro.png" alt="40.png"></p>
</li>
</ol>
<p>å…³äºæœ¬èŠ‚åç»­å·¥ä½œï¼š</p>
<ol>
<li>å‚è€ƒæ–‡ç« <a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1651211-1-1.html">ã€ŠWindows 7 x64å†…å­˜ç®¡ç†ã€‹ä¹‹ç”¨æˆ·èŒƒå›´å†…å­˜ç®¡ç†  Final</a>ï¼Œç»“åˆ Windbgï¼Œå•æ­¥è§£æå…±äº«å†…å­˜ã€æ˜ å°„é•œåƒæ–‡ä»¶ã€æ•°æ®æ–‡ä»¶çš„å·®å¼‚ã€‚</li>
<li>é€†å‘åˆ†æ <code>NtCreateSection</code> å…¨è¿‡ç¨‹ã€‚</li>
</ol>
<h2 id="3-ç‰©ç†å†…å­˜"><a href="#3-ç‰©ç†å†…å­˜" class="headerlink" title="3 ç‰©ç†å†…å­˜"></a>3 ç‰©ç†å†…å­˜</h2><p>å­¦ä¹ æœ¬ç« å‰ï¼Œå…ˆäº†è§£ä¸¤ä¸ªæ¦‚å¿µï¼š</p>
<ol>
<li>è™šæ‹Ÿå†…å­˜åœ°å€ï¼šå°†32ä½æ‹†æˆä¸¤éƒ¨åˆ†ï¼Œé«˜20ä½å«åšè™šæ‹Ÿé¡µå·ï¼ˆVPNï¼‰ï¼Œä½12ä½ä¸ºé¡µå†…åç§»ã€‚é«˜20ä½åˆå¯ä»¥æ‹†æˆ[PDPTE]ã€PDEã€PTEã€‚</li>
<li>ç‰©ç†å†…å­˜åœ°å€ï¼šé«˜20ä½å«åšç‰©ç†é¡µé¢ç¼–å·ï¼ˆä¹Ÿå«åšé¡µé¢å¸§ç¼–å·ï¼ŒPFNï¼‰ï¼Œç”±20ä½çš„VPNè½¬è¯‘è€Œæ¥ã€‚ä½12ä½é¡µå†…åç§»ä½¿ç”¨çš„å°±æ˜¯è™šæ‹Ÿåœ°å€çš„é¡µå†…åç§»ã€‚<strong>é¡µå†…åç§»çš„12ä½å¹¶ä¸å‚ä¸åœ°å€çš„è½¬è¯‘è¿‡ç¨‹</strong>ã€‚</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/19/oZlgijpwkI3EQqh.png" alt="41.png"></p>
<p><strong>å·¥ä½œé›†</strong>æè¿°äº†ä¸€ä¸ªè¿›ç¨‹æˆ–è€…ç³»ç»Ÿæ‰€æ‹¥æœ‰çš„é©»ç•™åœ¨å†…å­˜ä¸­çš„é¡µé¢ã€‚é¡µé¢å¸§ç¼–å·ï¼ˆPFN, page frame numberï¼‰<strong>æ•°æ®åº“åˆ™æè¿°äº†ç‰©ç†å†…å­˜ä¸­æ¯ä¸ªé¡µé¢çš„çŠ¶æ€</strong>ã€‚</p>
<p>æŸ¥çœ‹ç‰©ç†å†…å­˜ä½¿ç”¨æƒ…å†µï¼š</p>
<ol>
<li><p>æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨-èµ„æºç›‘è§†å™¨å¯ä»¥çœ‹åˆ°è¯¥è™šæ‹Ÿæœºæˆ‘åˆ†é…äº† 2GB å†…å­˜ï¼Œä¸‹å›¾æ˜¾ç¤º 2025 MBã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/21/nIzl2HFJRX5OKam.png" alt="47.png"></p>
</li>
<li><p>åœ¨ <code>_KUSER_SHARED_DATA</code> ä¸­æœ‰ä¸€ä¸ªæˆå‘˜ <code>NumberOfPhysicalPages</code> å­˜å‚¨ç€è¯¥ç³»ç»Ÿæ€»å…±çš„ç‰©ç†é¡µé¢æ•°é‡ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼š<code>_KUSER_SHARED_DATA</code> çš„åœ°å€æ²¡æœ‰è¢«éšæœºåŒ–ï¼Œå›ºå®šåœ°å€å¦‚ä¸‹ã€‚å…³äº<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/ntddk/ns-ntddk-kuser_shared_data">KUSER_SHARED_DATAç»“æ„</a>ç»“æ„æˆå‘˜å¯ä»¥æŸ¥çœ‹è¯¥é“¾æ¥å®˜æ–¹æ–‡æ¡£ã€‚</p>
<table>
<thead>
<tr>
<th></th>
<th>å†…æ ¸èµ·å§‹åœ°å€</th>
<th>å†…æ ¸ç»“æŸåœ°å€</th>
<th>ç”¨æˆ·èµ·å§‹åœ°å€</th>
<th>ç”¨æˆ·ç»“æŸåœ°å€</th>
</tr>
</thead>
<tbody><tr>
<td>32 ç³»ç»Ÿ</td>
<td><strong>0xFFDF0000</strong></td>
<td>0xFFDF0FFF</td>
<td><strong>0x7FFE0000</strong></td>
<td>0x7FFE0FFF</td>
</tr>
<tr>
<td>64 ç³»ç»Ÿ</td>
<td>0xFFFFF780&#96;00000000</td>
<td>0xFFFFF780&#96;00000FFF</td>
<td>0x7FFE0000</td>
<td>0x7FFE0FFF</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KUSER_SHARED_DATA <span class="number">0xFFDF0000</span></span><br><span class="line">ntdll!_KUSER_SHARED_DATA</span><br><span class="line">...</span><br><span class="line">+<span class="number">0x2e8</span> NumberOfPhysicalPages : <span class="number">0x7e955</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ 0x7e955 é¡µï¼Œåˆ™å…± $0x7E955*4KB &#x3D; 0x1FA554KB &#x3D; 2073940KB &#x3D; 2025MB$ã€‚</p>
</li>
</ol>
<h3 id="3-1-PFN-æ•°æ®åº“"><a href="#3-1-PFN-æ•°æ®åº“" class="headerlink" title="3.1 PFN æ•°æ®åº“"></a>3.1 PFN æ•°æ®åº“</h3><p>æ“ä½œç³»ç»Ÿä½¿ç”¨ä¸€ä¸ª<strong>ç»“æ„ä½“æ•°ç»„</strong>æ¥è¡¨ç¤º PFN æ•°æ®åº“ã€‚</p>
<p>PFN æ•°æ®åº“æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé¡µé¢å¸§ç¼–å· PFN ä¸ºè¯¥æ•°ç»„çš„ç´¢å¼•ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸€ä¸ªå…ƒç´ ä¸º <code>_MMPFN</code> ç»“æ„ã€‚è¯¥æ•°ç»„çš„å¤§å°ä¸º <code>MmPfnDatabase[_KUSER_SHARED_DATA.NumberOfPhysicalPages]</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x1c bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">MMPFN</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ListEntry</span>;</span>                                       <span class="comment">//0x0</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_BALANCED_NODE</span> <span class="title">TreeNode</span>;</span>                                 <span class="comment">//0x0</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">NextSlistPfn</span>;</span>                     <span class="comment">//0x0</span></span><br><span class="line">                VOID* Next;                                                 <span class="comment">//0x0</span></span><br><span class="line">                ULONG Flink;                                                <span class="comment">//0x0</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> _<span class="title">MI_ACTIVE_PFN</span> <span class="title">Active</span>;</span>                               <span class="comment">//0x0</span></span><br><span class="line">            &#125; u1;                                                           <span class="comment">//0x0</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> _<span class="title">MMPTE</span>* <span class="title">PteAddress</span>;</span>                                  <span class="comment">//0x4</span></span><br><span class="line">                ULONG PteLong;                                              <span class="comment">//0x4</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">MMPTE</span> <span class="title">OriginalPte</span>;</span>                                      <span class="comment">//0x8</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">MIPFNBLINK</span> <span class="title">u2</span>;</span>                                                  <span class="comment">//0x10</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT ReferenceCount;                                          <span class="comment">//0x14</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">MMPFNENTRY1</span> <span class="title">e1</span>;</span>                                         <span class="comment">//0x16</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">MMPFNENTRY3</span> <span class="title">e3</span>;</span>                                         <span class="comment">//0x17</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT ReferenceCount;                                          <span class="comment">//0x14</span></span><br><span class="line">        &#125; e2;                                                               <span class="comment">//0x14</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG EntireField;                                              <span class="comment">//0x14</span></span><br><span class="line">        &#125; e4;                                                               <span class="comment">//0x14</span></span><br><span class="line">    &#125; u3;                                                                   <span class="comment">//0x14</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG PteFrame:<span class="number">23</span>;                                                  <span class="comment">//0x18</span></span><br><span class="line">        ULONG ResidentPage:<span class="number">1</span>;                                               <span class="comment">//0x18</span></span><br><span class="line">        ULONG AnchorLargePageSize:<span class="number">2</span>;                                        <span class="comment">//0x18</span></span><br><span class="line">        ULONG ModifiedListBucketIndex:<span class="number">2</span>;                                    <span class="comment">//0x18</span></span><br><span class="line">        ULONG PageIdentity:<span class="number">3</span>;                                               <span class="comment">//0x18</span></span><br><span class="line">        ULONG PrototypePte:<span class="number">1</span>;                                               <span class="comment">//0x18</span></span><br><span class="line">        ULONG EntireField;                                                  <span class="comment">//0x18</span></span><br><span class="line">    &#125; u4;                                                                   <span class="comment">//0x18</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> PMMPFN MmPfnDatabase;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MI_PFN_ELEMENT(index) (&amp;MmPfnDatabase[index])</span></span><br></pre></td></tr></table></figure>

<div class="note success"><p><code>MmPfnDatabase</code> ä¸º PFN æ•°ç»„çš„èµ·å§‹åœ°å€ï¼ŒPFN ä¸ºæ•°ç»„çš„ç´¢å¼•ã€‚å® <code>MI_PFN_ELEMENT</code> å¯ä»¥æ ¹æ® PFN ç´¢å¼•è·å–æŒ‡å®šçš„ PFN é¡¹ã€‚</p>
</div>

<p><code>MmPfnDatabase</code> æ•°ç»„ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png" alt="51.png"></p>
<p>å¯ä»¥å‚è€ƒæ–‡ç« ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part1/#memusage">Inside Windows Page Frame Number (PFN) - Part 1</a></p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part2/">Inside Windows Page Frame Number (PFN) â€“ Part 2</a></p>
<p>é’ˆå¯¹ä»¥ä¸Š <code>_MMPFN</code> ç»“æ„ï¼Œä¸åŒçŠ¶æ€ä¸‹ä½¿ç”¨ä¸åŒçš„æˆå‘˜ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/20/8LAd1QcKhUpxHSY.png" alt="46.png"></p>
<p>ä¸‹é¢åˆæ­¥ç½—åˆ—ä¸€äº›æˆå‘˜ï¼Œå…·ä½“æˆå‘˜ä¿¡æ¯åŠä½¿ç”¨è¯·çœ‹ã€ŠWindows Internals 7 ç‰©ç†å†…å­˜-PFNæ•°æ®ç»“æ„ã€‹ã€‚</p>
<ul>
<li><p>u1.Activeï¼šæè¿°æ´»åŠ¨é¡µé¢ç›¸å…³å±æ€§ã€‚</p>
</li>
<li><p>PteAddressï¼šæŒ‡å‘å½“å‰ç‰©ç†é¡µé¢å¯¹åº”çš„ PTE çš„è™šæ‹Ÿåœ°å€ã€‚</p>
</li>
<li><p>OriginalPteï¼šæŒ‡å‘æ­¤é¡µé¢ PTE çš„åŸå§‹å†…å®¹ã€‚åŸå§‹å†…å®¹å¯èƒ½æ˜¯ä¸€ä¸ªåŸå‹ PTEã€‚è®°å½•å½“å‰ç‰©ç†é¡µä¸Šä¸€æ¬¡å¯¹åº”çš„ PTEï¼Œä»¥åå½“æ”¹ç‰©ç†é¡µé¢ä¸å†ä½¿ç”¨æ—¶ï¼Œå¯ä»¥æ¢å¤ä¸ºåŸæ¥çš„ PTEã€‚</p>
</li>
<li><p>u2.ShareCountï¼šè¡¨æ˜æŒ‡å‘è¯¥ç‰©ç†é¡µé¢çš„ PTE çš„æ•°é‡ã€‚</p>
</li>
<li><p>u3ï¼šæ˜¯æ‰€æœ‰çŠ¶æ€çš„ PFN é¡¹å…±äº«çš„ï¼Œå¾ˆé‡è¦ï¼Œæè¿°ç‰©ç†é¡µé¢çš„çŠ¶æ€ã€‚</p>
</li>
<li><p>u3.e2.ReferenceCountï¼šè¡¨ç¤ºè¿™ä¸ªé¡µé¢å¿…é¡»è¦ä¿ç•™åœ¨å†…å­˜ä¸­çš„å¼•ç”¨è®¡æ•°ï¼ŒåŒ…æ‹¬è¯¥é¡µé¢è¢«åŠ å…¥å·¥ä½œé›†æˆ–è€…ç”±äº I&#x2F;O çš„éœ€è¦è€Œè¢«é”å®šçš„æ¬¡æ•°ã€‚</p>
</li>
<li><p>u3.e1.PageLocationï¼šè¡¨ç¤ºå½“å‰ç‰©ç†é¡µå¤„åœ¨å“ªä¸€ä¸ªçŠ¶æ€ä¸­ã€‚ <code>_MMLIST</code> åˆ—å‡ºæ‰€æœ‰çš„çŠ¶æ€å’Œå¯¹åº”çš„æšä¸¾å€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x4 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> _<span class="title">MMLISTS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ZeroedPageList = <span class="number">0</span>,</span><br><span class="line">    FreePageList = <span class="number">1</span>,</span><br><span class="line">    StandbyPageList = <span class="number">2</span>,</span><br><span class="line">    ModifiedPageList = <span class="number">3</span>,</span><br><span class="line">    ModifiedNoWritePageList = <span class="number">4</span>,</span><br><span class="line">    BadPageList = <span class="number">5</span>,</span><br><span class="line">    ActiveAndValid = <span class="number">6</span>,</span><br><span class="line">    TransitionPage = <span class="number">7</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
</li>
<li><p>u3.e1.ReadInProgress&#x2F;WriteInProgressï¼šè¡¨ç¤ºè¯»æ“ä½œå’Œå†™æ“ä½œæ­£åœ¨è¿›è¡Œã€‚</p>
</li>
<li><p>u3.e1.Modifiedï¼šè¡¨ç¤ºç‰©ç†é¡µé¢å·²è¢«ä¿®æ”¹ã€‚</p>
</li>
<li><p>u4.PteFrameï¼šå½“å‰ PFN ç¼–å·ã€‚</p>
</li>
<li><p>u4.PrototypePteï¼šè¡¨ç¤ºè¯¥ PFN é¡¹å¼•ç”¨çš„ PTE æ˜¯ä¸€ä¸ªåŸå‹ PTEã€‚</p>
</li>
</ul>
<p>é¡µé¢çš„çŠ¶æ€ç±»å‹å­˜æ”¾åœ¨ <code>_MMPFN.u3.e1.PageLocation</code> æˆå‘˜é‡Œï¼ŒçŠ¶æ€å€¼ç”± <strong>_MMLISTS</strong> æ¥æšä¸¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x4 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> _<span class="title">MMLISTS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ZeroedPageList = <span class="number">0</span>,</span><br><span class="line">    FreePageList = <span class="number">1</span>,</span><br><span class="line">    StandbyPageList = <span class="number">2</span>,</span><br><span class="line">    ModifiedPageList = <span class="number">3</span>,</span><br><span class="line">    ModifiedNoWritePageList = <span class="number">4</span>,</span><br><span class="line">    BadPageList = <span class="number">5</span>,</span><br><span class="line">    ActiveAndValid = <span class="number">6</span>,</span><br><span class="line">    TransitionPage = <span class="number">7</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<div class="note default"><p>åœ¨è¿™ 9 ç§çŠ¶æ€ä¸­ï¼Œæœ‰ 6 ç§çŠ¶æ€æ˜¯é€šè¿‡é“¾è¡¨è¿›è¡Œç»´æŠ¤çš„ï¼ˆé™¤æ´»åŠ¨ã€è½¬ç§»ã€åçš„é™¤å¤–ï¼‰ã€‚<strong>å¤‡ç”¨çŠ¶æ€å…±æœ‰ 8 ä¸ªé“¾è¡¨è¡¨ï¼Œå¯¹åº”äº 8 ä¸­ä¸åŒä¼˜å…ˆçº§çš„é¡µé¢</strong>ã€‚é›¶åŒ–é¡µé¢ã€ç©ºé—²é¡µé¢ä¸ºå•é“¾è¡¨ï¼Œå…¶ä½™é“¾è¡¨ä¸ºåŒé“¾è¡¨ã€‚</p>
</div>

<p><code>u3.e1.PageLocation</code> åŸŸä¿å­˜çš„æšä¸¾å€¼ä¸ä»…è¯´æ˜å½“å‰ç‰©ç†é¡µå¤„äºä»€ä¹ˆçŠ¶æ€ï¼Œè¿˜è¡¨æ˜è¯¥é¡µé¢å¤„äºå“ªä¸€ä¸ªé“¾è¡¨ä¸­ã€‚</p>
<p>åœ¨ Windows XP ä¸‹å…¨å±€æ•°ç»„ <code>MmPageLocationList</code> åˆ—å‡ºäº†ä¸Šè¿° 6 ç§çŠ¶æ€é¡µé¢çš„<mark class="label danger">é“¾è¡¨å¤´</mark>ï¼Œè¯¥æ•°ç»„çš„ç´¢å¼•ä¸º <code>_MMLISTS</code> æšä¸¾å€¼ï¼Œæ¯ä¸€ä¸ªå…ƒç´ ä¸º <code>_MMPFNLIST</code> ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x14 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">MMPFNLIST</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Total;                                                            <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> _<span class="title">MMLISTS</span> <span class="title">ListName</span>;</span>                                                 <span class="comment">//0x4</span></span><br><span class="line">    ULONG Flink;                                                            <span class="comment">//0x8</span></span><br><span class="line">    ULONG Blink;                                                            <span class="comment">//0xc</span></span><br><span class="line">    ULONG Lock;                                                             <span class="comment">//0x10</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹å…¨å±€å˜é‡ä»…åœ¨ XP ä¸‹ä½¿ç”¨</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUMBER_OF_PAGE_LISTS 8</span></span><br><span class="line">PMMPFNLIST MmPageLocationList[NUMBER_OF_PAGE_LISTS] = &#123;</span><br><span class="line">                                      &amp;MmZeroedPageListHead,</span><br><span class="line">                                      &amp;MmFreePageListHead,</span><br><span class="line">                                      &amp;MmStandbyPageListHead,</span><br><span class="line">                                      &amp;MmModifiedPageListHead,</span><br><span class="line">                                      &amp;MmModifiedNoWritePageListHead,</span><br><span class="line">                                      &amp;MmBadPageListHead,</span><br><span class="line">                                      <span class="literal">NULL</span>,</span><br><span class="line">                                      <span class="literal">NULL</span> &#125;;</span><br></pre></td></tr></table></figure>

<div class="note primary"><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>MmPfnDatabase[PFN]</code> å®šä½åˆ°è¯¥é¡µé¢å¯¹åº”çš„ <code>_MMPFN</code> ç»“æ„ï¼Œç„¶åæ ¹æ® <code>MmPageLocationList[MMPFN.u3.e1.PageLocation]</code> æ‰¾åˆ°å¯¹åº”çŠ¶æ€é¡µé¢çš„é“¾è¡¨å¤´ã€‚</p>
<p>æ³¨æ„ï¼š<strong>é›¶åŒ–é¡µé¢å’Œç©ºé—²é¡µé¢ä»…æ„æˆå•é“¾è¡¨</strong>ï¼Œå…¶ä½™çš„æ˜¯åŒé“¾è¡¨ã€‚</p>
</div>

<p>ä»¥ä¸‹ä¸º XP çš„å›¾ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/20/b1qF2h9TYySRGmD.png" alt="44.png"></p>
<h3 id="3-2-ç‰©ç†é¡µé¢çŠ¶æ€è½¬ç§»"><a href="#3-2-ç‰©ç†é¡µé¢çŠ¶æ€è½¬ç§»" class="headerlink" title="3.2 ç‰©ç†é¡µé¢çŠ¶æ€è½¬ç§»"></a>3.2 ç‰©ç†é¡µé¢çŠ¶æ€è½¬ç§»</h3><p>å†…å­˜ç®¡ç†å™¨æ ¹æ®ç³»ç»Ÿå†…å­˜çš„æ•°é‡ä»¥åŠå„ä¸ªè¿›ç¨‹å¯¹äºå†…å­˜çš„éœ€æ±‚ï¼ŒåŠ¨æ€åœ°è°ƒåº¦è¿™äº›ç‰©ç†é¡µé¢çš„ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦å†…å­˜æ—¶ï¼Œå†…å­˜ç®¡ç†å™¨å¯ä»¥ä»é›¶åŒ–é“¾è¡¨æˆ–ç©ºé—²é“¾è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé¡µé¢æ¥æ»¡è¶³è¿›ç¨‹çš„éœ€æ±‚ï¼›å½“è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå†…å­˜ç®¡ç†å™¨å›æ”¶è¯¥è¿›ç¨‹çš„é¡µé¢ï¼›å½“ç‰©ç†å†…å­˜ç´§ç¼ºæ—¶ï¼Œå†…å­˜ç®¡ç†å™¨æŒ‰ç…§ç‰¹å®šçš„ç­–ç•¥å°†æœ‰äº›è¿›ç¨‹ä¸­çš„é¡µé¢æ¢å‡ºåˆ°å¤–å­˜ä¸­ï¼Œä»è€Œè…¾å‡ºç‰©ç†å†…å­˜ä»¥ä½œä»–ç”¨ã€‚åœ¨å†…å­˜ç®¡ç†å™¨çš„åŠ¨æ€è°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªé¡µé¢éƒ½æœ‰å¯èƒ½ç»å†å„ç§çŠ¶æ€å˜åŒ–ã€‚è¿™ä¸€èŠ‚æˆ‘ä»¬æ¥è®¨è®ºç‰©ç†é¡µé¢çš„çŠ¶æ€å˜åŒ–ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/20/vaLGTWrONI9l8Ku.png" alt="43.png"></p>
<p>åœ¨ä»¥ä¸‹è½¬ç§»æè¿°ä¸­ï¼Œä¸è€ƒè™‘å·²ä¿®æ”¹ä½†ä¸å†™å‡ºï¼ˆä¸ç”¨äºç”¨æˆ·æ¨¡å¼ï¼‰ã€åé¡µé¢ã€ROMã€‚</p>
<p>æˆ‘ä»¬ä»é¡µé¢é”™è¯¯å¤„ç†çš„è§’åº¦å‡ºå‘ï¼Œæ¥çœ‹ç‰©ç†é¡µé¢çš„çŠ¶æ€è½¬ç§»ã€‚åœ¨é¡µé¢é”™è¯¯å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå½“è¿›ç¨‹éœ€è¦ä¸€ä¸ªé¡µé¢æ—¶ï¼Œå®ƒæœ‰å¯èƒ½ä»ä»¥ä¸‹å‡ ä¸ªé“¾è¡¨ä¸­è·å¾—ç‰©ç†å†…å­˜é¡µé¢ï¼Œä»è€Œè§£å†³é¡µé¢é”™è¯¯ã€‚æ‰€ä»¥ï¼Œè¿™å‡ ä¸ªé“¾è¡¨ä¸­çš„é¡µé¢éƒ½æœ‰å¯èƒ½è¿›å…¥åˆ°ä¸€ä¸ªå·¥ä½œé›†ä¸­ã€‚</p>
<ol>
<li><p>å¦‚æœ<strong>é¡µé¢é”™è¯¯éœ€è¦ä¸€ä¸ªé›¶é¡µé¢æ¥æ»¡è¶³</strong>ï¼ˆè¦æ±‚é›¶çš„é¡µé¢é”™è¯¯ï¼šå¼•ç”¨ä¸€ä¸ªè¢«å®šä¹‰ä¸ºå…¨é›¶çš„é¡µé¢ï¼Œæˆ–è€…ä¸€ä¸ªä»æœªè¢«è®¿é—®è¿‡çš„ç”¨æˆ·æ¨¡å¼ç§æœ‰æäº¤é¡µé¢ï¼‰ï¼Œæ­¤æ—¶å†…å­˜ç®¡ç†å™¨ä¼šé¦–å…ˆè¯•å›¾ä»é›¶é¡µé¢åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªé¡µé¢ï¼Œå¦‚æœè¯¥åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œåˆ™å®ƒä»ç©ºé—²é¡µé¢åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªï¼Œå¹¶ä¸”é›¶åŒ–è¯¥é¡µé¢ï¼ˆå³ç”¨é›¶å¡«å……)ã€‚å¦‚æœç©ºé—²åˆ—è¡¨ä¹Ÿæ˜¯ç©ºçš„ï¼Œåˆ™å®ƒè½¬åˆ°å¤‡ç”¨åˆ—è¡¨ï¼Œå¹¶é›¶åŒ–æ­¤é¡µé¢ã€‚</p>
<p>é¡µé¢æŸ¥æ‰¾é¡ºåºï¼šé›¶åŒ–é¡µé¢ --&gt; ç©ºé—²é¡µé¢ --&gt; å¤‡ç”¨é“¾è¡¨ã€‚ </p>
<blockquote>
<p>ä»ç©ºé—²é“¾è¡¨åˆ°é›¶åŒ–é“¾è¡¨çš„è½¬ç§»æ˜¯ç”±ä¸€ä¸ªç§°ä¸ºé›¶é¡µé¢çº¿ç¨‹ï¼ˆzero page thread, System è¿›ç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼‰çš„ç³»ç»Ÿçº¿ç¨‹æ¥å®Œæˆçš„ã€‚ç³»ç»Ÿåœ¨é˜¶æ®µ 1 åˆå§‹åŒ–å®Œæˆä»¥åï¼Œè°ƒç”¨ <code>MmZeroPageThread</code> å‡½æ•°ï¼Œå› æ­¤ï¼Œé˜¶æ®µ1åˆå§‹åŒ–çº¿ç¨‹èœ•å˜æˆé›¶é¡µé¢çº¿ç¨‹ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ã€‚</p>
<p>å½“ç©ºé—²åˆ—è¡¨æœ‰ 8 ä¸ªæˆ–è€…æ›´å¤šé¡µé¢æ—¶ï¼Œé›¶é¡µé¢çº¿ç¨‹å°±ä¼šå¾—åˆ°äº‹ä»¶ä¿¡å·ï¼Œæ‰§è¡Œé›¶åŒ–ä»»åŠ¡ã€‚è¯¥çº¿ç¨‹çš„ä¼˜å…ˆçº§ä¸º0ï¼Œè€Œç”¨æˆ·çº¿ç¨‹æœ€ä½ä¼˜å…ˆçº§ä¸º1ï¼Œæ‰€ä»¥åªæœ‰åœ¨ CPU ç©ºé—²çš„æ—¶å€™æ‰ä¼šæœ‰æœºä¼šåˆ‡æ¢åˆ°é›¶åŒ–çº¿ç¨‹ä¸Šã€‚</p>
</blockquote>
</li>
<li><p>å½“å†…å­˜ç®¡ç†å™¨<strong>ä¸è¦æ±‚ä¸€ä¸ªé›¶åˆå§‹åŒ–çš„é¡µé¢</strong>æ—¶ï¼Œå®ƒé¦–å…ˆåˆ°ç©ºé—²åˆ—è¡¨ä¸Šå¯»æ‰¾é¡µé¢ã€‚å¦‚æœè¯¥åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œåˆ™è½¬åˆ°é›¶åŒ–çš„åˆ—è¡¨ä¸Šã€‚å¦‚æœé›¶åŒ–çš„åˆ—è¡¨ä¹Ÿæ˜¯ç©ºçš„ï¼Œåˆ™è½¬åˆ°å¤‡ç”¨åˆ—è¡¨ä¸Šã€‚å†…å­˜ç®¡ç†å™¨åœ¨ä½¿ç”¨ä¸€ä¸ªæ¥è‡ªå¤‡ç”¨åˆ—è¡¨çš„é¡µé¢å¸§ä»¥å‰ï¼Œå®ƒå¿…é¡»é¦–å…ˆå‘åå›é€€ä¸€ä¸‹ï¼Œ ä»ä»ç„¶æŒ‡å‘è¯¥é¡µé¢å¸§çš„æ— æ•ˆPTEï¼ˆæˆ–è€…åŸå‹PTEï¼‰ä¸­åˆ é™¤æ­¤å¼•ç”¨ã€‚å› ä¸ºPFNæ•°æ®åº“ä¸­çš„è¡¨é¡¹åŒ…å«äº†æŒ‡å›åˆ°åŸå…ˆç”¨æˆ·çš„é¡µè¡¨ï¼ˆæˆ–è€…å¯¹äºå…±äº«é¡µé¢è€Œè¨€ï¼ŒæŒ‡å‘åŸå‹PTEï¼‰çš„æŒ‡é’ˆï¼Œæ‰€ä»¥ï¼Œå†…å­˜ç®¡ç†å™¨å¯ä»¥å¾ˆå¿«åœ°æ‰¾åˆ°è¯¥PTEï¼Œå¹¶ä¸”åšå‡ºæ­£ç¡®çš„ä¿®æ”¹ã€‚</p>
<p>é¡µé¢æŸ¥æ‰¾é¡ºåºï¼šç©ºé—²é¡µé¢ --&gt; é›¶åŒ–é¡µé¢ --&gt; å¤‡ç”¨é“¾è¡¨ã€‚ </p>
</li>
<li><p>å½“ä¸€ä¸ªè¿›ç¨‹å¿…é¡»<strong>ä»å®ƒçš„å·¥ä½œé›†ä¸­æ”¾å¼ƒä¸€ä¸ªé¡µé¢</strong>ï¼ˆå› ä¸ºå®ƒå¼•ç”¨äº†ä¸€ä¸ªæ–°çš„é¡µé¢è€Œå®ƒçš„å·¥ä½œé›†æ˜¯æ»¡çš„ï¼Œæˆ–è€…å› ä¸ºå†…å­˜ç®¡ç†å™¨ä¿®å‰ªäº†å®ƒçš„å·¥ä½œé›†ï¼‰æ—¶ï¼Œå¦‚æœè¯¥é¡µé¢æ˜¯**å¹²å‡€çš„ ï¼ˆæœªè¢«ä¿®æ”¹è¿‡)**ï¼Œåˆ™å®ƒè¢«è½¬åˆ°å¤‡ç”¨åˆ—è¡¨ä¸­ï¼›å¦‚æœè¯¥é¡µé¢é©»ç•™äºå·¥ä½œé›†çš„æ—¶å€™å·²è¢«ä¿®æ”¹è¿‡ï¼Œåˆ™è½¬åˆ°ä¿®æ”¹åˆ—è¡¨ä¸­ã€‚</p>
</li>
<li><p>å½“ä¸€ä¸ª<strong>è¿›ç¨‹é€€å‡º</strong>çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ç§æœ‰é¡µé¢éƒ½è¢«è½¬åˆ°ç©ºé—²åˆ—è¡¨ä¸­ã€‚è€Œä¸”ï¼Œå½“ä¸€ä¸ªç”±é¡µ é¢æ–‡ä»¶æ”¯æ’‘çš„å†…å­˜åŒºçš„æœ€åä¸€ä¸ªå¼•ç”¨è¢«å…³é—­æ—¶ï¼Œå¦‚æœè¯¥å†…å­˜åŒºå·²ç»æ²¡æœ‰å‰©ä½™çš„æ˜ å°„è§†å›¾ï¼Œé‚£ä¹ˆè¿™äº›é¡µé¢ä¹Ÿè¢«è½¬åˆ°ç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/20/LB7bekR18TanqCF.png" alt="45.png"></p>
<p>éšç€å·¥ä½œé›†ä¸­çš„é¡µé¢è¢«åŠ å…¥åˆ°ä¿®æ”¹é“¾è¡¨ä¸­ï¼Œä¿®æ”¹é“¾è¡¨å¯èƒ½ä¼šå˜å¾—å¾ˆå¤§ï¼Œè€Œé›¶åŒ–é“¾è¡¨æˆ–å¤‡ç”¨é“¾è¡¨åˆ™è¶Šæ¥è¶Šå°ï¼Œåˆ°ä¸€å®šæ—¶å€™ï¼Œå†…å­˜ç®¡ç†å™¨ä¼š<strong>æŠŠä¿®æ”¹é“¾è¡¨ä¸­çš„é¡µé¢æ•°æ®å†™åˆ°ç£ç›˜ä¸Š</strong>ï¼Œ ä»è€ŒæŠŠé¡µé¢è½¬ç§»åˆ°å¤‡ç”¨é“¾è¡¨ä¸­ï¼Œè¿™ä¸€ä»»åŠ¡æ˜¯ç”±ä¸€ä¸ªç§°ä¸ºä¿®æ”¹é¡µé¢å†™å‡ºå™¨ï¼ˆmodified page writerï¼‰çš„ç»„ä»¶ï¼ˆMiModifiedPageWriter å‡½æ•°ï¼‰å’Œä¸€ä¸ªç§°ä¸ºæ˜ å°„é¡µé¢å†™å‡ºå™¨ï¼ˆmapped page writerï¼‰çš„ç»„ä»¶ï¼ˆ MiMappedPageWriter å‡½æ•°ï¼‰æ¥å®Œæˆçš„ï¼Œå…³äºè¿™ä¸¤ä¸ªå†™å‡ºå™¨çš„å·¥ä½œè¿‡ç¨‹ï¼Œè¯·å‚è€ƒ 4.5.4 èŠ‚ã€‚</p>
<p>ç‰¹åˆ«è¯´æ˜ï¼šç”³è¯·å†…å­˜æ—¶ï¼Œå¹¶ä¸ä¼šå°†è™šæ‹Ÿå†…å­˜æŒ‚ä¸Šç‰©ç†é¡µé¢ã€‚å½“ä¸€ä¸ªæ–°åˆ†é…çš„åœ°å€ç¬¬ä¸€æ¬¡è¢«å¼•ç”¨æ—¶ï¼Œä¼šå‘ç”Ÿä¸€ä¸ªé¡µé¢é”™è¯¯ï¼Œå› ä¸ºVMMåœ¨ç¬¬ä¸€æ¬¡å®é™…è®¿é—®è¿™ä¸ªåœ°å€å‰éƒ½ä¸ä¼šä¸ºå…¶åˆ†é…ç‰©ç†é¡µé¢ã€‚æ­¤æ—¶çš„é”™è¯¯ç§°ä¸º<strong>demand-zero</strong>é”™è¯¯ï¼Œå› ä¸ºä»–å¿…é¡»å®Œæˆ<strong>VA</strong>åˆ°ç‰©ç†é¡µçš„æ˜ å°„ï¼Œå¹¶ä¸”è¿™ä¸ªé¡µé¢è¦åˆå§‹åŒ–ä¸º0ã€‚</p>
<h3 id="3-3-ç‰©ç†å†…å­˜é™åˆ¶"><a href="#3-3-ç‰©ç†å†…å­˜é™åˆ¶" class="headerlink" title="3.3 ç‰©ç†å†…å­˜é™åˆ¶"></a>3.3 ç‰©ç†å†…å­˜é™åˆ¶</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/memory/memory-limits-for-windows-releases?redirectedfrom=MSDN">Windows å’Œ Windows Server ç‰ˆæœ¬çš„å†…å­˜é™åˆ¶</a></p>
<h3 id="3-4-ç»ƒä¹ ï¼šæŸ¥çœ‹PFNæ•°æ®åº“"><a href="#3-4-ç»ƒä¹ ï¼šæŸ¥çœ‹PFNæ•°æ®åº“" class="headerlink" title="3.4 ç»ƒä¹ ï¼šæŸ¥çœ‹PFNæ•°æ®åº“"></a>3.4 ç»ƒä¹ ï¼šæŸ¥çœ‹PFNæ•°æ®åº“</h3><p>åœ¨ä¸Šé¢çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œäº†è§£äº†ä¸åŒçŠ¶æ€ä¸‹ä½¿ç”¨ <code>_MMPFN</code> ç»“æ„ä¸åŒæˆå‘˜ã€‚åœ¨ XP ä¸­ï¼Œæœ‰ <code>MmPageLocationList</code> å…¨å±€å˜é‡å°†æè¿°ä¸åŒçŠ¶æ€çš„ 6 ä¸ªé“¾è¡¨è¿›è¡Œè¡¨è¾¾ã€‚ä½†æ˜¯ Windows 10 ä¸Šå¹¶æ²¡æœ‰å‘ç°è¿™äº›ç±»ä¼¼çš„å…¨å±€å˜é‡ã€‚ä½†æ˜¯ã€ŠWindows Internals 7 P442ã€‹ç»™å‡ºäº†ç›¸å…³ç»“æ„çš„æˆå‘˜ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/21/mPz7AuWVfl2YCOJ.png" alt="49.png"></p>
<p>å…³äºç»“æ„ <code>MI_PARTITION</code>ï¼Œçœ‹é›ªè¿™ç¯‡æ–‡ç«  <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-270131.htm">åˆ†äº«ä¸€ä¸‹win10çš„å†…å­˜å‹ç¼©</a>æœ‰éƒ¨åˆ†æåŠã€‚</p>
<h4 id="MmPfnDatabase"><a href="#MmPfnDatabase" class="headerlink" title="MmPfnDatabase"></a>MmPfnDatabase</h4><p>æ•°ç»„ <code>MmPfnDatabase</code> ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png" alt="51.png"></p>
<ol>
<li><p>æŸ¥çœ‹ <code>MmPfnDatabase</code> æ•°ç»„åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd MmPfnDatabase</span><br><span class="line"><span class="number">821187</span>c4  <span class="number">84400000</span> <span class="number">83b</span>7f000 <span class="number">19801268</span> <span class="number">00000e07</span></span><br><span class="line"><span class="number">821187</span>d4  <span class="number">85935b</span>28 <span class="number">0007f</span>0ec <span class="number">00000000</span> <span class="number">81e0</span>f000</span><br><span class="line"><span class="number">821187e4</span>  <span class="number">82585000</span> <span class="number">825f</span>1000 <span class="number">82585000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">821187f</span>4  <span class="number">00000000</span> <span class="number">859f</span>5e40 <span class="number">23</span>c62a67 <span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>MmPfnDatabase</code> æ•°ç»„çš„åœ°å€ä¸º <code>0x84400000</code>ã€‚</p>
</li>
<li><p>æŸ¥çœ‹ <code>MmPfnDatabase[0]</code>ï¼Œå³ PFN &#x3D; 0 æ—¶ï¼Œç‰©ç†é¡µé¢ <code>0~0xfff</code> å¯¹åº”çš„ <code>_MMPFN</code> ç»“æ„å…¨éƒ¨ä¸º <code>0</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd <span class="number">0x84400000</span> </span><br><span class="line"><span class="number">84400000</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">84400010</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">84400020</span>  c07fe800 <span class="number">00000080</span> <span class="number">00002000</span> <span class="number">00000001</span></span><br><span class="line"><span class="number">84400030</span>  <span class="number">00560001</span> <span class="number">0000191</span>a <span class="number">00000000</span> c07fe808</span><br></pre></td></tr></table></figure>


</li>
<li><p>æŸ¥çœ‹ <code>MmPfnDatabase[8]</code> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _MMPFN <span class="number">0x84400000</span>+<span class="number">0x1c</span>*<span class="number">8</span></span><br><span class="line">nt!_MMPFN</span><br><span class="line">   +<span class="number">0x000</span> ListEntry        : _LIST_ENTRY [ <span class="number">0x0</span> - <span class="number">0xc07fe838</span> ]</span><br><span class="line">   +<span class="number">0x000</span> TreeNode         : _RTL_BALANCED_NODE</span><br><span class="line">   +<span class="number">0x000</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x004</span> PteAddress       : <span class="number">0xc07fe838</span> _MMPTE</span><br><span class="line">   +<span class="number">0x004</span> PteLong          : <span class="number">0xc07fe838</span></span><br><span class="line">   +<span class="number">0x008</span> OriginalPte      : _MMPTE</span><br><span class="line">   +<span class="number">0x010</span> u2               : _MIPFNBLINK</span><br><span class="line">   +<span class="number">0x014</span> u3               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x018</span> u4               : &lt;anonymous-tag&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="pfn-pageframe"><a href="#pfn-pageframe" class="headerlink" title="!pfn pageframe"></a>!pfn pageframe</h4><p>ä½¿ç”¨ <code>!pfn PageFrame</code> æŸ¥çœ‹å¯¹åº” <code>PFN</code> çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pfn <span class="number">8</span></span><br><span class="line">    PFN <span class="number">00000008</span> at address <span class="number">844000E0</span></span><br><span class="line">    flink       <span class="number">00000000</span>  blink / share count <span class="number">00000001</span>  pteaddress C07FE838</span><br><span class="line">    reference count <span class="number">0001</span>   Cached     color <span class="number">0</span>   Priority <span class="number">0</span></span><br><span class="line">    restore pte <span class="number">200000000080</span>  containing page <span class="number">00191</span>A  Active     M       </span><br><span class="line">    Modified   </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¯¥æŒ‡ä»¤è§£æçš„ä¿¡æ¯å’Œ <code>dt _MMPFN 0x84400000+0x1c*8</code> æ˜¯ä¸€æ ·çš„ã€‚</p>
<h4 id="vtop-CR3-VirtualAddress"><a href="#vtop-CR3-VirtualAddress" class="headerlink" title="!vtop CR3 VirtualAddress"></a>!vtop CR3 VirtualAddress</h4><p><code>!vtop</code> æŒ‡ä»¤å¯ä»¥å°†è™šæ‹Ÿåœ°å€è½¬æ¢æˆå¯¹åº”çš„ç‰©ç†åœ°å€ã€‚æ ¼å¼ä¸ºï¼š<code>!vtop CR3 VirtualAddress</code>ã€‚ä½¿ç”¨è¯¥æŒ‡ä»¤ä¹‹å‰éœ€è¦ä½¿ç”¨åˆ° <code>!process</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">!process <span class="number">0</span> <span class="number">0</span>		<span class="comment">// åˆ—å‡ºæ‰€æœ‰è¿›ç¨‹ä¿¡æ¯</span></span><br><span class="line">!process @$proc <span class="number">0</span>	<span class="comment">// åˆ—å‡ºå½“å‰æ‰€é™„åŠ çš„è¿›ç¨‹ä¿¡æ¯</span></span><br><span class="line">!process è¿›ç¨‹å/PID <span class="number">0</span> == !process è¿›ç¨‹å/PID	<span class="comment">//åˆ—å‡ºè¿›ç¨‹è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ‰€æœ‰çº¿ç¨‹ï¼‰</span></span><br><span class="line">  </span><br><span class="line">.process EPROCESS	<span class="comment">//é™„åŠ åˆ°ç›®æ ‡è¿›ç¨‹</span></span><br></pre></td></tr></table></figure>

<p>æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span></span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">PROCESS <span class="number">859586</span>c0  SessionId: none  Cid: <span class="number">0004</span>    Peb: <span class="number">00000000</span>  ParentCid: <span class="number">0000</span></span><br><span class="line">    DirBase: <span class="number">001</span>a8000  ObjectTable: <span class="number">86603040</span>  HandleCount: <span class="number">2434.</span></span><br><span class="line">    Image: System</span><br><span class="line">...</span><br><span class="line">PROCESS bf4d1040  SessionId: <span class="number">1</span>  Cid: <span class="number">07</span>a4    Peb: <span class="number">002</span>db000  ParentCid: <span class="number">0</span>ad8</span><br><span class="line">    DirBase: <span class="number">7f</span>0a91c0  ObjectTable: b15f2c00  HandleCount:  <span class="number">39.</span></span><br><span class="line">    Image: <span class="number">20220812</span>_VC_SEHOP.exe</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™„åŠ åˆ°è¿›ç¨‹20220812_VC_SEHOP.exe</span></span><br><span class="line">kd&gt; .process bf4d1040 </span><br><span class="line">ReadVirtual: bf4d1058 <span class="keyword">not</span> properly sign extended</span><br><span class="line">Implicit process is now bf4d1040</span><br><span class="line">WARNING: .cache forcedecodeuser is <span class="keyword">not</span> enabled</span><br><span class="line">  </span><br><span class="line"><span class="comment">// å°†è™šæ‹Ÿåœ°å€0x844000E0è½¬æ¢ä¸ºç‰©ç†åœ°å€</span></span><br><span class="line">kd&gt; !vtop <span class="number">7f</span>0a91c0 <span class="number">844000E0</span></span><br><span class="line">X86VtoP: Virt <span class="number">00000000844000e0</span>, pagedir <span class="number">000000007f</span>0a91c0</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a91d0 - <span class="number">0000000006846801</span>	<span class="comment">//æ³¨æ„è¿™äº›éƒ½æ˜¯ç‰©ç†åœ°å€ï¼ŒåŒ…æ‹¬CR3éƒ½ä¸æ˜¯è™šæ‹Ÿåœ°å€</span></span><br><span class="line">X86VtoP: PAE PDE <span class="number">0000000006846110</span> - <span class="number">800000007</span>ae008e3</span><br><span class="line">X86VtoP: PAE Large page mapped phys <span class="number">000000007</span>ae000e0</span><br><span class="line">Virtual address <span class="number">844000e0</span> translates to physical address <span class="number">7</span>ae000e0.</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç‰©ç†åœ°å€ä¸º<code>7ae000e0</code>ï¼Œåˆ™ <code>PFN == 7ae00</code>ã€‚</p>
<h4 id="pte-VirtualAddress-x2F-Physical-Address"><a href="#pte-VirtualAddress-x2F-Physical-Address" class="headerlink" title="!pte VirtualAddress&#x2F;Physical Address"></a>!pte VirtualAddress&#x2F;Physical Address</h4><p>è¯¥æŒ‡ä»¤ç”¨æ¥è¯†åˆ«ä¸€ä¸ªåœ°å€æ˜¯è™šæ‹Ÿåœ°å€è¿˜æ˜¯ç‰©ç†åœ°å€ï¼Œå¹¶å°†åœ°å€å¯¹åº”çš„ PDEã€PTE åˆ—å‡ºæ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0x844000E0</span></span><br><span class="line">                    VA <span class="number">844000e0</span></span><br><span class="line">PDE at C0602110            PTE at C0422000</span><br><span class="line">contains <span class="number">800000007</span>AE008E3  contains <span class="number">0000000000000000</span></span><br><span class="line">pfn <span class="number">7</span>ae00     --LDA--KW-V    LARGE PAGE pfn <span class="number">7</span>ae00 </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è™šæ‹Ÿåœ°å€ <code>0x844000E0</code> è¢«è¯†åˆ«å‡ºæ¥æ˜¯ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå…¶å¯¹åº”çš„ PTE ä¸º<code>0xC0422000</code>ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰ã€‚PFN ä¸º<code>7ae00 </code>ã€‚</p>
<h4 id="memusageä¸-vm"><a href="#memusageä¸-vm" class="headerlink" title="!memusageä¸!vm"></a>!memusageä¸!vm</h4><p>æŒ‡ä»¤ <code>!memusage</code> å¯ä»¥åˆ—å‡ºæ‰€æœ‰<strong>ç‰©ç†å†…å­˜</strong>ä½¿ç”¨çš„æƒ…å†µï¼Œè¯¥æŒ‡ä»¤å»ºè®®ä¸€èˆ¬ä¸è¦ä½¿ç”¨ï¼Œä¸è¦éœ€è¦åŠ è½½å¾ˆä¹…éå†æ•´ä¸ªç‰©ç†å†…å­˜ã€‚</p>
<p>æŒ‡ä»¤ <code>!vm</code> åˆ†æ<strong>è™šæ‹Ÿå†…å­˜</strong>çš„ä½¿ç”¨æƒ…å†µã€‚</p>
<p>å¯ä»¥å‚è€ƒæ–‡ç« ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part1/#memusage">Inside Windows Page Frame Number (PFN) - Part 1</a></p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part2/">Inside Windows Page Frame Number (PFN) â€“ Part 2</a></p>
<h4 id="dml-proc"><a href="#dml-proc" class="headerlink" title="!dml_proc"></a>!dml_proc</h4><p><code>!dml_proc</code> å¯ä»¥ç½—åˆ—å‡ºæ‰€æœ‰è¿›ç¨‹çš„ <code>EPROCESS</code>ã€‚</p>
<h3 id="3-5-ç»ƒä¹ ï¼šç”³è¯·ç§æœ‰å†…å­˜æŸ¥çœ‹æ˜¯å¦åˆ†é…ç‰©ç†å†…å­˜"><a href="#3-5-ç»ƒä¹ ï¼šç”³è¯·ç§æœ‰å†…å­˜æŸ¥çœ‹æ˜¯å¦åˆ†é…ç‰©ç†å†…å­˜" class="headerlink" title="3.5 ç»ƒä¹ ï¼šç”³è¯·ç§æœ‰å†…å­˜æŸ¥çœ‹æ˜¯å¦åˆ†é…ç‰©ç†å†…å­˜"></a>3.5 ç»ƒä¹ ï¼šç”³è¯·ç§æœ‰å†…å­˜æŸ¥çœ‹æ˜¯å¦åˆ†é…ç‰©ç†å†…å­˜</h3><p>æœ¬å®éªŒç›®çš„ï¼šå…ˆåœ¨æŒ‡å®šå†…å­˜ç”³è¯·ä¸€å—å†…å­˜ï¼Œä»…é¢„ç•™ï¼ˆMEM_RESERVEï¼‰ä¸æäº¤ï¼ˆMEM_COMMITï¼‰ï¼Œæ­¤æ—¶æŸ¥çœ‹è¯¥è™šæ‹Ÿå†…å­˜æ˜¯å¦æŒ‚ä¸Š PTEã€‚ç„¶åå»æäº¤å†…å­˜ï¼Œçœ‹ PTE å˜åŒ–ã€‚</p>
<p><strong>ä¸€ã€ç”³è¯·é¢„ç•™å†…å­˜åè¿›è¡Œæäº¤ï¼Œç„¶åè®¿é—®å†…å­˜ï¼Œè§‚å¯Ÿ PTE</strong></p>
<ol>
<li><p>åœ¨ <code>0x00520120</code> ç”³è¯·é¢„ç•™å†…å­˜ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/22/6JLlha4kA9nwBuD.png" alt="52.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span></span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">PROCESS b11cd040  SessionId: <span class="number">1</span>  Cid: <span class="number">1e98</span>    Peb: <span class="number">00939000</span>  ParentCid: <span class="number">0</span>ad8</span><br><span class="line">    DirBase: <span class="number">7f</span>0a9800  ObjectTable: b15f34c0  HandleCount:  <span class="number">36.</span></span><br><span class="line">    Image: <span class="number">20220921</span>_VirtualAlloc_Test2.exe</span><br><span class="line"></span><br><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800  <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000000f</span>86a801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000000f</span>86a010 - <span class="number">0000000000000000</span></span><br><span class="line">X86VtoP: PAE zero PDE</span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0xD0000147</span>.</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶å†…å­˜è¿˜æ²¡æœ‰æäº¤ï¼Œè¯¥è™šæ‹Ÿåœ°å€è¿˜æ²¡æœ‰æŒ‚ä¸Šç›¸åº”çš„ PTEï¼Œä¹Ÿæ²¡æœ‰å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçš„è¿”å›åœ°å€ <code>Va</code> æ˜¯é¡µé¢èµ·å§‹åœ°å€ <code>0x520000</code>ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img data-src="https://s2.loli.net/2022/09/22/VksKUSpejFOHciA.png" alt="55.png"></p>
</li>
<li><p>ç°åœ¨å»æäº¤å†…å­˜ï¼ˆ<code>Va = (int*)VirtualAlloc((LPVOID)0x520120, 4*0x1000, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</code>ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800  <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000000f</span>86a801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000000f</span>86a010 - <span class="number">0000000009</span>c98867</span><br><span class="line">X86VtoP: PAE PTE <span class="number">0000000009</span>c98900 - <span class="number">00002000000000</span>c0</span><br><span class="line">X86VtoP: PAE PTE <span class="keyword">not</span> present, pagefile <span class="number">0</span>:<span class="number">0000000000002000</span></span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0x10000114</span>.</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶ PTE(<code>00002000000000c0</code>) çš„ P ä½è¿˜æ˜¯ä¸º <code>0</code>ã€‚æ­¤æ—¶ PATã€PCD ä½éƒ½è¢«ç½®1ã€‚</p>
</li>
<li><p>æ­¤æ—¶å»å¾€åœ°å€é‡Œé¢å†™æ•°æ®ï¼ˆè®¿é—®åœ°å€ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800  <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000000f</span>86a801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000000f</span>86a010 - <span class="number">0000000009</span>c98867</span><br><span class="line">X86VtoP: PAE PTE <span class="number">0000000009</span>c98900 - <span class="number">000000003</span>d819967</span><br><span class="line">X86VtoP: PAE Mapped phys <span class="number">000000003</span>d819000</span><br><span class="line">Virtual address <span class="number">520000</span> translates to physical address <span class="number">3</span>d819000.</span><br></pre></td></tr></table></figure>



<p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçš„è¿”å›åœ°å€ <code>Va</code> æ˜¯é¡µé¢èµ·å§‹åœ°å€ <code>0x520000</code>ã€‚<img data-src="https://s2.loli.net/2022/09/22/jqom3Dwup4Cysrb.png" alt="53.png"></p>
<p><img data-src="https://s2.loli.net/2022/09/22/ouCj1v2DJwVdl8Y.png" alt="54.png"></p>
</li>
</ol>
<p><strong>äºŒã€ç”³è¯·é¢„ç•™å†…å­˜åï¼Œä¸æäº¤ï¼Œç›´æ¥è®¿é—®å†…å­˜ï¼Œè§‚å¯Ÿ PTE</strong></p>
<ol>
<li><p>åœ¨ <code>0x00520120</code> ç”³è¯·é¢„ç•™å†…å­˜ï¼Œè§‚å¯Ÿ PTEã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dml_proc</span><br><span class="line">Address  PID  Image file name</span><br><span class="line"><span class="number">8</span>c2b0040 <span class="number">1040</span> <span class="number">20220921</span>_Virtu..</span><br><span class="line">  </span><br><span class="line">kd&gt; !process <span class="number">1040</span> <span class="number">0</span></span><br><span class="line">Searching <span class="keyword">for</span> Process with Cid == <span class="number">1040</span></span><br><span class="line">PROCESS <span class="number">8</span>c2b0040  SessionId: <span class="number">1</span>  Cid: <span class="number">1040</span>    Peb: <span class="number">01022000</span>  ParentCid: <span class="number">0</span>ad8</span><br><span class="line">    DirBase: <span class="number">7f</span>0a9800  ObjectTable: b15f4900  HandleCount:  <span class="number">36.</span></span><br><span class="line">    Image: <span class="number">20220921</span>_VirtualAlloc_Test2.exe</span><br><span class="line"></span><br><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800 <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000005</span>efa7801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000005</span>efa7010 - <span class="number">0000000000000000</span></span><br><span class="line">X86VtoP: PAE zero PDE</span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0xD0000147</span>.</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ PDE ä¸º 0ï¼Œæ²¡æœ‰æŒ‚ä¸Š PTEã€‚</p>
</li>
<li><p>ç›´æ¥å¾€åœ°å€ <code>0x520000</code> å†™å…¥æ•°æ®ï¼Œè§‚å¯Ÿ PTEã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800 <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000005</span>efa7801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000005</span>efa7010 - <span class="number">0000000000000000</span></span><br><span class="line">X86VtoP: PAE zero PDE</span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0xD0000147</span>.</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ PDE è¿˜ä¸º 0ï¼Œæ²¡æœ‰æŒ‚ä¸Š PTEã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/22/nvXEz8kPMuxiqJV.png" alt="56.png"></p>
</li>
</ol>
<h3 id="3-6-MDL-ç‰©ç†å†…å­˜"><a href="#3-6-MDL-ç‰©ç†å†…å­˜" class="headerlink" title="3.6 MDL ç‰©ç†å†…å­˜"></a>3.6 MDL ç‰©ç†å†…å­˜</h3><p>ã€ŠWindows å†…æ ¸åŸç†ä¸å®ç° P279ã€‹ã€ã€ŠWindows å†…æ ¸æƒ…æ™¯åˆ†æä¸‹ 9.12 P918ã€‹ã€‚</p>
<p><img data-src="https://s2.loli.net/2022/09/24/M3651Rt2CLOwPhq.png" alt="71.png"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    èµèµ
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat å¾®ä¿¡">
        <span>å¾®ä¿¡</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat æ”¯ä»˜å®">
        <span>æ”¯ä»˜å®</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://directoree.github.io/post/x86-Memory2/" title="x86 å†…å­˜ç®¡ç†ï¼ˆäºŒï¼‰ç§æœ‰å†…å­˜-å…±äº«å†…å­˜-ç‰©ç†å†…å­˜">https://directoree.github.io/post/x86-Memory2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/WinXP%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> WinXPå†…æ ¸</a>
              <a href="/tags/x86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> x86å†…å­˜ç®¡ç†</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/WinXp-Memory/" rel="prev" title="x86 å†…å­˜ç®¡ç†ï¼ˆä¸€ï¼‰è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€-ASLR-VAD">
                  <i class="fa fa-chevron-left"></i> x86 å†…å­˜ç®¡ç†ï¼ˆä¸€ï¼‰è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€-ASLR-VAD
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/x86-Memory3/" rel="next" title="x86 å†…å­˜ç®¡ç†ï¼ˆä¸‰ï¼‰æ— æ•ˆ/åŸå‹ PTE ä¸é¡µé¢é”™è¯¯">
                  x86 å†…å­˜ç®¡ç†ï¼ˆä¸‰ï¼‰æ— æ•ˆ/åŸå‹ PTE ä¸é¡µé¢é”™è¯¯ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">2m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">30:39</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  




  <script src="/js/local-search.js"></script>








<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script data-pjax>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








    <div class="pjax">
  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '70px',
  right: 'unset',
  left: '16px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#222',
  buttonColorLight: '#222',
  saveInCookies: false,
  label: '',
  autoMatchOsTheme: false
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
if (window.darkmode && !window.darkmode.isActivated()) {
  window.darkmode.toggle();
  var toggleButtons = document.getElementsByClassName("darkmode-toggle");
  if (toggleButtons && toggleButtons.length > 0) {
    for (i = 0; i < toggleButtons.length; i++) {
      toggleButtons[i].classList.add("darkmode-toggle--white");
    }
  }
}
</script>

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"å¿«æ¥å‹¾æ­æˆ‘å‘€ğŸ¶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/x86-Memory2/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

    </div>
</body>
</html>
