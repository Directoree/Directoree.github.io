<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="😄">
<meta property="og:type" content="article">
<meta property="og:title" content="x86 内存管理（二）私有内存-共享内存-物理内存">
<meta property="og:url" content="https://directoree.github.io/post/x86-Memory2/index.html">
<meta property="og:site_name" content="Catecat">
<meta property="og:description" content="😄">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/yoxQT1VZiSzdCDW.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/XtBhPw5dEJUy9oK.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/XBNtEFcw3f7OaWn.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/ELUCylM1neu7Bmd.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/qVPyK2LmSribcTt.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/13/A7oTHyE5hvWPRVj.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/2BWpCvei3fbJ6tz.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/15/LJ6BHmSiZaKsqM1.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/20/rzK8iQdO4D21TER.png">
<meta property="og:image" content="https://s2.loli.net/2022/10/22/vafHMNWZi6U8bkY.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/15/7lpKhndRtaiJYrs.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/13/kI3UpiP4vx8as5Q.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/14/oes68xkmvpQBc5J.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/16/s5LJR4fForSVUci.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/16/jaE71MS9ylmR4nI.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/17/KPqWhvGFib6asro.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/19/oZlgijpwkI3EQqh.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/nIzl2HFJRX5OKam.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/8LAd1QcKhUpxHSY.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/b1qF2h9TYySRGmD.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/vaLGTWrONI9l8Ku.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/20/LB7bekR18TanqCF.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/mPz7AuWVfl2YCOJ.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/6JLlha4kA9nwBuD.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/VksKUSpejFOHciA.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/jqom3Dwup4Cysrb.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/ouCj1v2DJwVdl8Y.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/22/nvXEz8kPMuxiqJV.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/24/M3651Rt2CLOwPhq.png">
<meta property="article:published_time" content="2022-09-13T14:21:52.000Z">
<meta property="article:modified_time" content="2022-10-21T16:41:29.987Z">
<meta property="article:author" content="Catecat">
<meta property="article:tag" content="WinXP内核">
<meta property="article:tag" content="x86内存管理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png">


<link rel="canonical" href="https://directoree.github.io/post/x86-Memory2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>x86 内存管理（二）私有内存-共享内存-物理内存 | Catecat</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Catecat</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/newcategories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-空调房">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>空调房</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%99%A8%E6%8F%90%E4%BE%9B%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="nav-text">1 内存管理器提供的服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6"><span class="nav-text">1.1 共享内存和映射文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%86%85%E5%AD%98%E5%8C%BA%E5%AF%B9%E8%B1%A1"><span class="nav-text">1.2 内存区对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%BB%83%E4%B9%A0%EF%BC%9A%E5%A4%9A%E5%BC%80%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%A9%E7%90%86%E9%A1%B5%E6%98%A0%E5%B0%84"><span class="nav-text">1.3 练习：多开程序的物理页映射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%A7%81%E6%9C%89%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">1 私有内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%A0%86%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-text">1.1 堆管理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E7%BB%83%E4%B9%A0%EF%BC%9A%E5%A0%86%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7"><span class="nav-text">1.2 练习：堆内存申请</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Mapped-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">2 Mapped 内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-CreateFileMappingW"><span class="nav-text">2.1 CreateFileMappingW</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-NtCreateSection"><span class="nav-text">2.2 NtCreateSection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E5%86%85%E5%AD%98%E5%8C%BA%E5%AF%B9%E8%B1%A1%E6%B5%85%E6%9E%90"><span class="nav-text">2.3 内存区对象浅析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-text">3 物理内存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-PFN-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">3.1 PFN 数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E7%89%A9%E7%90%86%E9%A1%B5%E9%9D%A2%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB"><span class="nav-text">3.2 物理页面状态转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6"><span class="nav-text">3.3 物理内存限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-%E7%BB%83%E4%B9%A0%EF%BC%9A%E6%9F%A5%E7%9C%8BPFN%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">3.4 练习：查看PFN数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MmPfnDatabase"><span class="nav-text">MmPfnDatabase</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pfn-pageframe"><span class="nav-text">!pfn pageframe</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vtop-CR3-VirtualAddress"><span class="nav-text">!vtop CR3 VirtualAddress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pte-VirtualAddress-x2F-Physical-Address"><span class="nav-text">!pte VirtualAddress&#x2F;Physical Address</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#memusage%E4%B8%8E-vm"><span class="nav-text">!memusage与!vm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dml-proc"><span class="nav-text">!dml_proc</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-%E7%BB%83%E4%B9%A0%EF%BC%9A%E7%94%B3%E8%AF%B7%E7%A7%81%E6%9C%89%E5%86%85%E5%AD%98%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%88%86%E9%85%8D%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-text">3.5 练习：申请私有内存查看是否分配物理内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-MDL-%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-text">3.6 MDL 物理内存</span></a></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Catecat"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Catecat</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/newcategories/">
          
        <span class="site-state-item-count">62</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/x86-Memory2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Catecat">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Catecat">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          x86 内存管理（二）私有内存-共享内存-物理内存
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-13 22:21:52" itemprop="dateCreated datePublished" datetime="2022-09-13T22:21:52+08:00">2022-09-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-22 00:41:29" itemprop="dateModified" datetime="2022-10-22T00:41:29+08:00">2022-10-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/x86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">x86内存管理</span></a>
        </span>
    </span>

  
    <span id="/post/x86-Memory2/" class="post-meta-item leancloud_visitors" data-flag-title="x86 内存管理（二）私有内存-共享内存-物理内存" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/x86-Memory2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/x86-Memory2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>37k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>33 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>😄</p>
<span id="more"></span>

<h2 id="1-内存管理器提供的服务"><a href="#1-内存管理器提供的服务" class="headerlink" title="1 内存管理器提供的服务"></a>1 内存管理器提供的服务</h2><p>内存管理器提供的<strong>系统服务</strong>包括：申请和释放虚拟内存、共享内存管理、将文件映射到虚拟内存、将虚拟页面换出到磁盘文件、维护虚拟页面信息、修改虚拟页面保护属性、将虚拟页面锁在内存中。</p>
<p>上述大部分系统服务都通过 API 暴露给用户使用，这些 API 包括 4 类：</p>
<ol>
<li><strong>Virtual AP</strong>I：以页面粒度操作，非常强大。如 VirtualAllocEx，VirtualFreeEx，VirtualProtectEx 等。</li>
<li><strong>Heap API</strong>：对进程堆进行分配和管理（一般用于申请小于4KB的虚拟内存）。如 HeapAlloc，HeapFree，HeapCreate，HeapReAlloc 等。</li>
<li>Local&#x2F;Global APIs：这些是 16 位 Windows 的遗留部分，现在使用 Heap API 实现。</li>
<li><strong>Memory-mapped files</strong>：这些函数将文件映射到内存中，有些映射的文件还可以和其他进程共享。这些函数包括 Create FileMapping、OpenFileMapping、MapViewofFile 等。</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png" alt="27.png"></p>
<blockquote>
<p>虚线框的，因为此实现依赖于编译器并且当然不是强制性的（尽管很常见），它们使用 Heap API。</p>
<p>在内核中给驱动程序使用的的函数均以 <code>Mm</code> 为前缀。</p>
</blockquote>
<p>注意几个概念：</p>
<ol>
<li>已提交页面是私有内存。</li>
<li>尝试访问空闲或保留内存会导致访问冲突异常，因为该页面未映射到物理内存。</li>
<li>已提交的内存（私有内存）会被初始化为0。已提交的页面还有可能被写入到 page file（换出到磁盘）。</li>
<li><code>ReadProcessMemory</code>、<code>WriteProcessMemory</code> 进入 0 环后，都需要附加到目标进程。它们还要有目标进程的安全描述符，它们需要 <code>PROCESS_VM_READ</code> 或 <code>PROCESS_VM_WRITE</code> 权限，或者拥有 <code>SeDebugPrivilege</code> 权限，默认情况下仅授予管理员组的成员。</li>
<li>内存区是作为文件映射对象暴露给 Windows API 使用的。</li>
<li>共享内存、映射文件、内存区对象是三个概念。</li>
</ol>
<p>memory-mapped files (internally called section objects)</p>
<h3 id="1-1-共享内存和映射文件"><a href="#1-1-共享内存和映射文件" class="headerlink" title="1.1 共享内存和映射文件"></a>1.1 共享内存和映射文件</h3><p>共享内存：有一个物理页在多个进程中都映射了虚拟地址，这些进程都可以通过自己的虚拟地址访问这个物理页。</p>
<div class="note success"><p>共享内存有以下特点：</p>
<ol>
<li>如果多个程序加载同一份磁盘上的 DLL，则在物理内存中只会映射一次该 DLL。</li>
<li>如果多个进程加载统一份磁盘上的 EXE（多开），则在物理内存中只会映射一次该 EXE。</li>
</ol>
</div>

<p><img data-src="https://s2.loli.net/2022/09/14/yoxQT1VZiSzdCDW.png" alt="32.png"></p>
<p><img data-src="https://s2.loli.net/2022/09/14/XtBhPw5dEJUy9oK.png" alt="33.png"></p>
<p>1.3 节用个实验说明这个情况。列出所有进程 EPROCESS：!dml_proc 、!process 0 0</p>
<div class="note warning"><p>内存管理器中用<strong>内存区对象，也叫内存区</strong>（section object, <code>_SECTION</code>）来实现共享内存，在 Windows API 中它也被称为<strong>文件映射对象</strong>（file mapping object），注意不是文件对象 <code>_FILE_OBJECT</code>。</p>
<p>磁盘上的文件（image file, page file, data file）、物理内存，他们映射到虚拟内存后，都有其对应的内存区对象。内存区对象可以被多个进程共享。</p>
</div>

<p>有两种类型的内存区：内存区对象有两种，一种建立在页面文件的基础上，称为页面文件支撑的内存区（page-file-backed-sections）。另一种被映射到其他文件中，称为文件支撑的内存区，也称为文件对象。</p>
<p>可以创建内存区对象的 3 环API：<code>CreateFileMapping, CreateFileMappingNuma(Ex), CreateFileMappingFromApp</code>。其中有一个参数 <code>HANDLE</code>：如果是 Mapped file 则需要指定文件对象<code>_FIEL_OBJECT</code>指针；如果是页面文件支撑的内存区则该参数为 <code>INVALID_HANDLE_VALUE(0)</code>。</p>
<p>如果内存区有名称的话，其他的进程就可以通过 <code>OpenFileMapping</code> 来打开该内存区。</p>
<p>设备驱动程序还可以利用 <code>ZwOpenSection, ZwMapViewOfSection, ZwUnmapViewOfSection</code> 函数来操作内存区对象。</p>
<div class="note default"><p><strong>注意</strong>：对于一个非常大的映射内存，即该内存区对象表示的内存区非常大。但是某些进程可能只是使用其中一部分，则这些进程可以只映射该内存区中的一部分使用，映射的这一部分称为该内存区的一个<mark class="label danger">视图</mark>。调用 <code>MapViewOfFile, MapViewOfFileEx, MapViewOfFileExNuma</code> 指定映射范围即可。</p>
</div>

<p>使用内存区对象的地方：可执行文件映射到内存、设备驱动对象射到内存、缓存管理器。</p>
<h3 id="1-2-内存区对象"><a href="#1-2-内存区对象" class="headerlink" title="1.2 内存区对象"></a>1.2 内存区对象</h3><p>一个物理页面也可以被映射到多个进程的用户空间，由这样的物理页面映射在虚存空间形成的连续区间，就称为内存区（Section）。</p>
<p>内存区对象（section object）代表了两个或者多个进程可以共享的一块内存，Windows 子系统将其称为文件映射对象（ file<br>mapping object）。可以利用内存区对象把一个文件映射到进程地址空间中。</p>
<p>内存区对象，如同其他的对象一样，也是由对象管理器来分配和释放的。对象管理器创建并初始化一个对象头（它使用对象头来管理这些对象)；而内存管理器定义内存区对象的对象体。我们主要关注对象体，就像 <code>_EPROCESS</code> 对象体一样。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x28 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SECTION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_BALANCED_NODE</span> <span class="title">SectionNode</span>;</span>                                  <span class="comment">//0x0</span></span><br><span class="line">    ULONG StartingVpn;                                                      <span class="comment">//0xc</span></span><br><span class="line">    ULONG EndingVpn;                                                        <span class="comment">//0x10</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">CONTROL_AREA</span>* <span class="title">ControlArea</span>;</span>                                  <span class="comment">//0x14</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">FILE_OBJECT</span>* <span class="title">FileObject</span>;</span>                                    <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteImageFileObject:<span class="number">1</span>;                                      <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteDataFileObject:<span class="number">1</span>;                                       <span class="comment">//0x14</span></span><br><span class="line">    &#125; u1;                                                                   <span class="comment">//0x14</span></span><br><span class="line">    ULONGLONG SizeOfSection;                                                <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LongFlags;                                                    <span class="comment">//0x20</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">MMSECTION_FLAGS</span> <span class="title">Flags</span>;</span>                                      <span class="comment">//0x20</span></span><br><span class="line">    &#125; u;                                                                    <span class="comment">//0x20</span></span><br><span class="line">    ULONG InitialPageProtection:<span class="number">12</span>;                                         <span class="comment">//0x24</span></span><br><span class="line">    ULONG SessionId:<span class="number">19</span>;                                                     <span class="comment">//0x24</span></span><br><span class="line">    ULONG NoValidationNeeded:<span class="number">1</span>;                                             <span class="comment">//0x24</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>概念说多了都是扯淡，直接开干。</p>
<p>利用内存区，我们可以使一个映射文件被共享，也可以只是简单的建立一块共享内存。创建内存取对象使用 <code>CreateFileMapping</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE __stdcall <span class="title">CreateFileMappingA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPSECURITY_ATTRIBUTES lpFileMappingAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD flProtect,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeHigh,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeLow,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCSTR lpName</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>









<p>内存区对象分为两类，在创建内存区对象时就可以区分</p>
<h3 id="1-3-练习：多开程序的物理页映射"><a href="#1-3-练习：多开程序的物理页映射" class="headerlink" title="1.3 练习：多开程序的物理页映射"></a>1.3 练习：多开程序的物理页映射</h3><p>对磁盘上同一个 EXE 双击运行两次，查看其本身镜像及加载的 DLL 在物理内存的映射情况。</p>
<p>如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> z = <span class="number">0x6666</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">0x12345678</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;局部变量x地址：0x%x\n&quot;</span>, &amp;x);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;全局变量x地址：0x%x\n&quot;</span>, &amp;z);</span><br><span class="line">	LoadLibrary(TEXT(<span class="string">&quot;FirstDll32.dll&quot;</span>));</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加载同一个 DLL：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>,<span class="string">L&quot;FirstDll Success!&quot;</span>, <span class="string">L&quot;A1v1n&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>运行两个实例如下：</p>
<p><img data-src="https://s2.loli.net/2022/09/14/XBNtEFcw3f7OaWn.png" alt="29.png"></p>
<ol>
<li><p><code>!process 0 0</code> 查看进程信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PROCESS a6c53040  SessionId: <span class="number">1</span>  Cid: <span class="number">17</span>c0    Peb: <span class="number">00</span>d1c000  ParentCid: <span class="number">0e84</span></span><br><span class="line">    DirBase: <span class="number">7f</span>0ebf00  ObjectTable: b16fa4c0  HandleCount:  <span class="number">83.</span></span><br><span class="line">    Image: <span class="number">20220913</span>_HeapAlloc.exe</span><br><span class="line"></span><br><span class="line">PROCESS afdc3040  SessionId: <span class="number">1</span>  Cid: <span class="number">12e4</span>    Peb: <span class="number">00</span>c9c000  ParentCid: <span class="number">0e84</span></span><br><span class="line">    DirBase: <span class="number">7f</span>0ebb80  ObjectTable: <span class="number">9</span>a1fc080  HandleCount:  <span class="number">83.</span></span><br><span class="line">    Image: <span class="number">20220913</span>_HeapAlloc.exe</span><br></pre></td></tr></table></figure>


</li>
<li><p>查看 VAD 树。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _eprocess vadroot a6c53040</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x350</span> VadRoot : _RTL_AVL_TREE</span><br><span class="line">kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,afdc3040 -r1 (*((ntdll!_RTL_AVL_TREE *)<span class="number">0xa6c53390</span>))</span><br><span class="line">(*((ntdll!_RTL_AVL_TREE *)<span class="number">0xa6c53390</span>))                 [Type: _RTL_AVL_TREE]</span><br><span class="line">    [+<span class="number">0x000</span>] Root             : <span class="number">0xae01f420</span> [Type: _RTL_BALANCED_NODE *]</span><br><span class="line">kd&gt; !vad <span class="number">0xae01f420</span></span><br><span class="line">VAD   Level     Start       End Commit</span><br><span class="line">a6d5fd90  <span class="number">4</span>        <span class="number">80</span>        <span class="number">85</span>      <span class="number">2</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\<span class="number">20220913</span>_HeapAlloc.exe      </span><br><span class="line">...</span><br><span class="line">a37bf290  <span class="number">4</span>     <span class="number">6f</span>c60     <span class="number">6f</span>c7e     <span class="number">19</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\FirstDll32.dll</span><br><span class="line">...</span><br><span class="line">     </span><br><span class="line">kd&gt; dt _eprocess vadroot afdc3040 </span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">   +<span class="number">0x350</span> VadRoot : _RTL_AVL_TREE</span><br><span class="line">kd&gt; dx -id <span class="number">0</span>,<span class="number">0</span>,afdc3040 -r1 (*((ntdll!_RTL_AVL_TREE *)<span class="number">0xafdc3390</span>))</span><br><span class="line">(*((ntdll!_RTL_AVL_TREE *)<span class="number">0xafdc3390</span>))                 [Type: _RTL_AVL_TREE]</span><br><span class="line">    [+<span class="number">0x000</span>] Root             : <span class="number">0xa5878df8</span> [Type: _RTL_BALANCED_NODE *]</span><br><span class="line">kd&gt; !vad <span class="number">0xa5878df8</span></span><br><span class="line">VAD   Level     Start       End Commit</span><br><span class="line"><span class="number">8141b</span>c18  <span class="number">5</span>        <span class="number">80</span>        <span class="number">85</span>      <span class="number">2</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\<span class="number">20220913</span>_HeapAlloc.exe</span><br><span class="line">...</span><br><span class="line">afcc9eb8  <span class="number">3</span>     <span class="number">6f</span>c60     <span class="number">6f</span>c7e     <span class="number">19</span> Mapped  Exe  EXECUTE_WRITECOPY  \Users\alvin\Desktop\Release\FirstDll32.dll  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到两个进程中连映射的 EXE、DLL虚拟地址都一样。</li>
<li>注意看，VAD 节点地址是不一样的。</li>
</ul>
</li>
<li><p>查看 EXE、DLL 是否在同一个物理页。</p>
<p><img data-src="https://s2.loli.net/2022/09/14/ELUCylM1neu7Bmd.png" alt="30.png"></p>
<p><img data-src="https://s2.loli.net/2022/09/14/qVPyK2LmSribcTt.png" alt="31.png"></p>
</li>
</ol>
<p>对于内存空间有两种描述方式：</p>
<ol>
<li>一种是物理内存的角度，所有地址只分为两类，挂了物理页的地址与没有挂物理页的地址，其属性由PDE&#x2F;PTE决定。</li>
<li><strong>另一种是线性地址的角度，分为私有内存与映射内存</strong>。</li>
</ol>
<p>内存管理器提供了一组系统服务来完成以下各种任务：分配和释放虚拟内存，在进程之 间共享内存，将文件映射到内存中，将虚拟页面刷新到磁盘中，获得有关一定范围内虚拟页 面的信息，改变虚拟页面的保护属性，以及将虚拟页面锁在内存中。</p>
<p>这些服务中的大多数是通过Windows API暴露给客户的。Windows API 有 4 组函数可用来管理应用程序中的内存：</p>
<ol>
<li><strong>Virtual AP</strong>I：以页面粒度操作，非常强大。如 VirtualAllocEx，VirtualFreeEx，VirtualProtectEx 等。</li>
<li><strong>Heap API</strong>：对进程堆进行分配和管理。如 HeapAlloc，HeapFree，HeapCreate，HeapReAlloc 等。</li>
<li>Local&#x2F;Global APIs：这些是 16 位 Windows 的遗留部分，现在使用 Heap API 实现（已弃用）。</li>
<li><strong>Memory-mapped files</strong>：这些函数将文件映射到内存中，有些映射的文件还可以和其他进程共享。这些函数包括 Create FileMapping、OpenFileMapping、MapViewofFile 等。</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/14/F6WLCU1j983gVrK.png" alt="27.png"></p>
<p>这部分内容：《Windows Internals Part1 7th 5.2.5》、《Windows 10 System Programming 12, 13》、《Windows 内核原理与实现 4.3.4》、《Windows 内核情景分析 3.4》。</p>
<h2 id="1-私有内存管理"><a href="#1-私有内存管理" class="headerlink" title="1 私有内存管理"></a>1 私有内存管理</h2><p>如下图，用户空间的 <code>Private</code> 、<code>Mapped</code> 内存由 <code>VadFlags.PrivateMemory</code>位决定：</p>
<p><img data-src="https://s2.loli.net/2022/09/13/A7oTHyE5hvWPRVj.png" alt="25.png"></p>
<p>这两类内存的区别主要有2点不同：</p>
<ul>
<li>申请内存的方式不同：<ul>
<li>私有内存：通过 <code>VirtualAlloc/VirtualAllocEx</code> 申请的（每次都要创建新的 VAD 节点）。</li>
<li>映射内存：通过 <code>CreateFileMapping</code> 映射的。</li>
</ul>
</li>
<li>使用方式不同：<ul>
<li>私有内存：独享物理页。</li>
<li>映射内存：可能要与其它进程共享物理页。</li>
</ul>
</li>
</ul>
<h3 id="1-1-堆管理器"><a href="#1-1-堆管理器" class="headerlink" title="1.1 堆管理器"></a>1.1 堆管理器</h3><p>进程用户空间私有内存包括：<strong>栈、堆</strong>。而在系统层面，私有内存包括系统进程&#x2F;线程栈、堆（分页&#x2F;换页内存池，非分页&#x2F;换页内存池）。本章我们先只研究进程用户空间的私有内存管理。</p>
<p>栈内存是由系统使用 ASLR 自己管理的，我们无法掌控其分配。但是堆内存我们可以自己申请。</p>
<p>在前面一篇文章中已经介绍过 VAD 位图的一位表示 64 KB，但是 Windows 提供了堆管理器，使得 <code>VirtualAlloc</code> 和<code>VirtualAllocExNuma </code>来分配比最小分配粒度 64KB 小得多的内存块（分配粒度为 <code>4KB</code>）。这是因为无论是从内存使用效率的角度，还是从性能的角度来看，为相对较小的内存请求分配如此大的一个区域显然不是最优的。为了满足这种需求，Windows提供了一个被称为堆管理器（heap manager）的组件，它负责管理大内存区域中的内存分配，这些大内存区域是通过一些页面粒度的内存分配函数来保留的。</p>
<div class="note success"><p>堆管理器中的分配粒度相对较小：<strong>在 32 位系统上是 8 字节，在 64位 系统上是 16 字节</strong>。</p>
</div>

<div class="note danger"><p>堆管理器存在于两个地方：<code>Ntdll.dll</code>和 <code>Ntoskrl.exe</code>。都是以 <code>Rtl</code> 为前缀，<code>malloc, free, new</code> 等函数最终都会调用以 <code>Heap</code> 为前缀的函数，然后调用<code>Ntdll.dll</code>中的原生函数。而且，从 16 位操作系统遗留的以 <code>Local</code> 或 <code>Global</code> 为前缀函数仍然是可用的，以便支持老的 Windows应用程序。</p>
</div>

<p>在 3 环申请内存的函数有如下一些，但是需要进行说明的是  C 语言的 <code>malloc</code> 和 C++的 <code>new</code> 他们会先申请进程创建时预留给堆使用的内存，但是当预留给堆的内存不够时还是会进入 0 环申请内存并分配 VAD 节点。下面一小节将进行实验说明。（关于 <code>VirtualAlloc2</code> 等函数的使用可以看《Windows 10 System Programming Chapter 13》，本节就不浪费墨水了）</p>
<p><img data-src="https://s2.loli.net/2022/09/14/2BWpCvei3fbJ6tz.png" alt="23.png"></p>
<div class="note default"><p>每个进程至少有一个堆，直到进程结束才会释放。</p>
<p>进程默认堆空间大小：1MB &#x3D; 256*4KB，可以在编译程序时通过 <code>/HEAP</code>  修改。进程运行过程中堆的大小会被自动扩充。这部分使用<strong>低碎片堆</strong>（LFH， Low Fragmentation Heap）分配策略进行管理（具体见Windows Internals –Heap manager–低碎片堆）。</p>
</div>

<p><strong>有一种特殊的情况</strong>：Win32 GUI 子系统驱动程序（Win32k.sys）的堆是建立在<strong>内存映射文件区域</strong>基础之上的，它被用来在用户模式下共享GDI和User对象。</p>
<div class="note default"><p>对《Windows Internals7 –Heap manager》提取一些知识点：</p>
<ol>
<li><p>在 Windows 10 和 Server 2016 之前，只有一种堆类型，我们称之为 NT 堆。NT 堆由可选的前端层扩充，使用低碎片堆 （LFH） 策略分配内存。</p>
</li>
<li><p>Windows 10 引入了一种称为碎片堆（segment heap）的新堆类型。这两种堆类型包括公共元素，但结构和实现方式不同。默认情况下，分段堆由所有 UWP 应用和某些系统进程使用，而 NT 堆由所有其他进程使用。这可以在注册表中进行更改。</p>
</li>
<li><p>Windows通用应用平台 （UWP） ：可以让基于该平台开发的应用运行在 <strong>运行 Windows 10 的移动端和 PC 端</strong>。</p>
</li>
</ol>
</div>

<ol>
<li><p>NT 堆（NT Heap）。在用户模式下堆管理器是一个两层结构：可选的前端堆层和核心堆层（后端堆层）。前段堆使用低碎片堆策略分配内存(<strong>LFH</strong>， Low Fragmentation Heap），<strong>前端堆仅用于用户模式</strong>。核心堆层处理基本的功能，处理常见的从用户模式进入内核模式的堆实现，其核心功能包括段内部的内存块的管理、段的管理、堆的扩展策略、提交内存和解除提交，以及大块的管理。（实际前端后端主要就是看进不进 0 环）。</p>
<p><img data-src="https://s2.loli.net/2022/09/15/LJ6BHmSiZaKsqM1.png" alt="34.png"></p>
<p><strong>LFH 内存分配方法</strong>：使用桶（LFH buckets），桶的分配粒度呈阶梯型，最小一个桶粒度为 8 字节，最大的桶粒度为 512 字节。总共 128 个桶，最大范围为 <code>16384 bytes = 16384/1024 = 16KB</code>。</p>
<p><code>malloc/aloca</code> 等函数：</p>
<ul>
<li>x86：最小分配 8 字节。</li>
<li>x64：最小分配 16 字节。</li>
</ul>
<p>x86：</p>
<p><img data-src="https://s2.loli.net/2022/10/20/rzK8iQdO4D21TER.png" alt="72.png"></p>
<p>x64：《<a target="_blank" rel="noopener" href="https://github.com/peleghd/Windows-10-Exploitation/blob/master/Low_Fragmentation_Heap_(LFH)_Exploitation_-_Windows_10_Userspace_by_Saar_Amar.pdf">Low Fragmentation Heap (LFH) Exploitation Windows 10 Userspace</a>》</p>
<p><img data-src="https://s2.loli.net/2022/10/22/vafHMNWZi6U8bkY.png" alt="73.png"></p>
</li>
<li><p>碎片堆（Segment Heap）。如图所示，管理分配的策略取决于申请内存的大小（16368bytes &#x3D; 16KB）。</p>
<ul>
<li><p>x &lt;&#x3D; 16368bytes，LFH 处理。</p>
</li>
<li><p>16368bytes &lt; x &lt;&#x3D; 128KB，引入 VS 分配器，但是 VS 和 LFH 分配器都使用预先堆预留的内存。</p>
</li>
<li><p>128KB &lt; x &lt;&#x3D; 508KB，后端堆提供的策略不进入 0 环。</p>
</li>
<li><p>x &gt; 508KB，通过直接调用内存管理器（VirtualAlloc）进行处理，进入 0 环。因为这些分配非常大，以至于使用默认的 64 KB 分配粒度（并舍入到最接近的页面大小）被认为足够好。</p>
</li>
</ul>
<p><img data-src="https://s2.loli.net/2022/09/15/7lpKhndRtaiJYrs.png" alt="35.png"></p>
</li>
</ol>
<h3 id="1-2-练习：堆内存申请"><a href="#1-2-练习：堆内存申请" class="headerlink" title="1.2 练习：堆内存申请"></a>1.2 练习：堆内存申请</h3><p>对于以线性地址为角度描述内存时，分为私有内存与映射内存。<strong>申请私有内存的函数为VirtualAlloc&#x2F;VirtualAllocEx，申请映射内存的函数为CreateFileMapping。</strong>C 语言的 <code>malloc</code> 和 C++的 <code>new</code> 都不是真正的申请内存，他们申请使用的是进程创建预留给堆使用的内存，但是当预留给堆的内存不够时还是会进入 0 环申请内存并分配 VAD 节点。。</p>
<p><code>malloc</code> 与 <code>new</code> 的底层调用过程，具体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span> -&gt; _nh_malloc_dbg -&gt; _heap_alloc_dbg -&gt; _heap_alloc_base -&gt; kernel32!HeapAlloc -&gt; ntdll!RtlHeapAlloc</span><br><span class="line"><span class="keyword">new</span> -&gt; _nh_malloc -&gt; _nh_malloc_dbg -&gt; _heap_alloc_dbg -&gt; _heap_alloc_base -&gt; kernel32!HeapAlloc -&gt; ntdll!RtlHeapAlloc</span><br></pre></td></tr></table></figure>



<p>这里就要了解一下堆的概念，什么是堆呢？<strong>堆其实就是操作系统通过调用 VirtualAlloc 函数预先分配好的一大块内存。</strong><code>ntdll!RtlHeapAlloc</code> 的作用就是在这一大块已经预先分配好的内存里面，分一些小份出来用。作个比喻，可以认为 <code>VirtualAlloc</code> 就是批发市场，一次必须批量从操作系统那里购买内存，必须是 4KB 的整数倍才可以；而 <code>ntdll!RtlHeapAlloc</code>就是零售商，从 <code>VirtualAlloc</code> 已经批来的货里面（堆）买一部分走。</p>
<p>实验：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> z = <span class="number">0x6666</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">0x12345678</span>;</span><br><span class="line">  </span><br><span class="line">  getchar();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>* y = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)*<span class="number">128</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;栈:%x \n&quot;</span>,&amp;x);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;堆:%x \n&quot;</span>,y);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;全局变量：%x\n&quot;</span>, &amp;z);</span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>运行到第一个 <code>getchar()</code> 时，与运行到第二个 <code>getchar()</code> 时查看该进程当前的 VAD 树是一样的。<strong>注意</strong>：1200-14ff 是进程预留的 1MB 堆空间。</p>
<p><img data-src="https://s2.loli.net/2022/09/13/kI3UpiP4vx8as5Q.png" alt="26.png"></p>
</li>
<li><p>如上图，可以看到堆和栈的内存都是在进程预先分配好的  <code>Private</code> 内存中。全局变量使用的内存是在 Image 文件映射区域中。</p>
</li>
<li><p>如果 <code>malloc</code> 申请的内存很大时，还是会进入 0 环去申请一块内存，并建立 AVD 节点。</p>
</li>
<li><p>使用 <code>VirtualAlloc</code> 申请内存时，尽管是 1 字节，都会进入 0 环，然后每次都要创建新的 VAD 节点（此时内存管理器会以最小单位4KB给一页）。</p>
</li>
</ol>
<p>会发现，<strong>无论是全局变量，局部变量，或者调用 malloc 函数，它都没有分配新的内存空间，只不过是使用了当前进程已有的内存空间</strong>。</p>
<p>不过还是有几个需要说明一下，比如局部变量的地址是 <code>0x110fdf8</code>，而它所在的内存块的范围是 <code>0x1010 000~0x110f fff</code>，主要原因是，<strong>栈是从高地址向低地址延申的</strong>，因此刚开始使用的地址都是当前内存块的高地址。堆的话，就是直接使用了一块已有的内存，可以回想之前批发商与零售商的例子。全局变量，就比较与众不同了，它映射了当前进程的 <code>.exe</code> 文件，这部分下篇学习映射内存时会讲到。</p>
<p><strong>总结</strong>：</p>
<ol>
<li>VirtualAlloc&#x2F;VirtualAllocEx 是申请私有内存的唯一方式。</li>
<li>如果已经预留的内存满足本次申请的内存，new 与 malloc 的内部调用是 ntdll!RtlHeapAlloc，这种情况下 ntdll!RtlHeapAlloc 不进入 0 环，仅分配一些已经经过  VirtualAlloc&#x2F;VirtualAllocEx 申请好的内存。</li>
<li>如果保留的内存页不能够满足本次 <code>malloc</code> 申请的内存时，ntdll!RtlHeapAlloc 会进入 0 环申请一块新的内存。</li>
</ol>
<p>如下图，红框中的 <code>13ff*0x1000+0xfff - (1200*0x1000) = 0x001fffff = 512KB</code>，是进程创建时预留的。当我们申请128、508、509KB时进程会多提交一页，并建立相应的 VAD节点。经过多次测试，其中有一次就是当我申请 4KB 时，内存管理器会将某两个 VAD 节点合并以提供足够的空间。（我的应用不是 UWP 应用）。</p>
<p><img data-src="https://s2.loli.net/2022/09/14/oes68xkmvpQBc5J.png" alt="28.png"></p>
<h2 id="2-Mapped-内存管理"><a href="#2-Mapped-内存管理" class="headerlink" title="2 Mapped 内存管理"></a>2 Mapped 内存管理</h2><p>映射内存主要有两类：一种是共享物理页，另一种是共享文件。基于页面，基于文件（文件映射对象）–数据文件、镜像文件。</p>
<p>都是使用函数 <code>CreateFileMapping</code> 函数，<code>CreateFileMapping</code> 只是在底层准备好一个物理页&#x2F;文件，想将准备好的物理页&#x2F;文件与当前进程关联起来，就要依赖 <code>MapViewOfFile</code> 函数将物理页映射到自己进程的虚拟地址空间中。如果其他进程想要共享并使用这个内存区，只需要使用 <code>OpenFileMapping</code> 来获取内存区对象句柄，然后再使用 <code>MapViewOfFile</code> 将物理页映射到自己的地址空间中即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NtCreateSection --&gt; MiCreateSectionCommon --&gt; MiCreateSection --&gt; MiCreateImageOrDataSection/MiCreatePagingFileMap</span><br><span class="line"></span><br><span class="line">MiCreateImageOrDataSection --&gt; MiCreateNewSection --&gt; MiCreateImageFileMap/MiCreateDataFileMap </span><br></pre></td></tr></table></figure>





<h3 id="2-1-CreateFileMappingW"><a href="#2-1-CreateFileMappingW" class="headerlink" title="2.1 CreateFileMappingW"></a>2.1 CreateFileMappingW</h3><p><code>CreateFileMapping</code> 函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE __stdcall <span class="title">CreateFileMappingW</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HANDLE hFile,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPSECURITY_ATTRIBUTES lpFileMappingAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD flProtect,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeHigh,</span></span></span><br><span class="line"><span class="function"><span class="params">    DWORD dwMaximumSizeLow,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCWSTR lpName</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>hFile</td>
<td>hFile !&#x3D; NULL，创建基于文件的内存区对象（文件映射对象），指向文件对象的句柄。<br />hFile &#x3D;&#x3D; INVALID_HANDLE_VALUE(-1)，只创建一块共享的内存（内存区对象，基于页面page file）。这种情况下，还必须在<em>dwMaximumSizeHigh</em>和<em>dwMaximumSizeLow</em>参数中指定映射对象的大小，这种情况下该函数<strong>创建一个指定大小的文件映射对象</strong>。</td>
</tr>
<tr>
<td>lpFileMappingAttributes</td>
<td>安全描述符。用于确定该函数返回的内存区对象句柄是否可以由子进程继承。典型的<strong>NULL</strong>值表示句柄无法被继承。</td>
</tr>
<tr>
<td>flProtect</td>
<td>内存区被创建后，物理内存被访问时提供的权限。下面的保护属性可以和 <code>SEC_COMMIT</code>、<code>SEC_IMAGE</code>、<code>SEC_IMAGE_NO_EXECUTE</code>、<code>SEC_LARGE_PAGES</code>、<code>SEC_NOCACHE</code>、<code>SEC_RESERVE</code>、<code>SEC_WRITECOMBINE</code>组合使用。<img data-src="https://s2.loli.net/2022/09/16/s5LJR4fForSVUci.png" alt="37.png"><img data-src="https://s2.loli.net/2022/09/16/jaE71MS9ylmR4nI.png" alt="38.png"></td>
</tr>
<tr>
<td>dwMaximumSizeHigh</td>
<td>文件映射对象最大大小的高 32 位。</td>
</tr>
<tr>
<td>dwMaximumSizeLow</td>
<td>1. 文件映射对象最大大小的低32位，<strong>映射页面文件时需要指定这两个值大小，映射文件设置为0即可。</strong><br/>2. 将它们设置为小于文件长度，只能映射文件的一部分，而指定一个大于文件长度的大小则会扩展文件。最后，如这个参数和 dwMaximumSizeHigh 都是零，那么文件映射对象的最大大小等于 hFile 指定文件的实际大小。<br/>3. 映射一个大小为 0 的磁盘文件将会引发出错码为 ERROR_FILE_INVALID 的错误。应用程序应该检测大小为 0 的文件，并拒绝这些文件。</td>
</tr>
<tr>
<td>lpName</td>
<td>1. 文件映射对象的名称<br/>2. 如果这个参数与一个已经存在的文件映射对象的名称相同，那么该函数请求以 flProtect 指定的保护属性访问该对象<br/>3. 如果这个参数为 NULL，那么创建的这个文件映射对象将没有名称<br/>4. 如果 lpName 与一个现有的事件,信号量,互斥锁,可等待定时器,或工作对象同名，那么函数调用失败，并且 <a target="_blank" rel="noopener" href="http://bbs.fishc.com/thread-69138-1-1.html">GetLassError</a> 函数返回 ERROR_INVALID_HANDLE。因为这些对象共享相同的命名空间<br/>5. 该名称可以有一个 “Global&quot; 或 “Local&quot; 前缀来在全局或会话命名空间中显示地创建对象。其余的名称可以包含除反斜杠字符（\）以外的任何字符。在全局命名空间中从一个会话而不是会话0中创建一个文件映射对象需要 <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa375728(v=vs.85).aspx">SeCreateGlobalPrivilege</a> 特权。更多信息，请参考 <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa382954(v=vs.85).aspx">Kernel Object Namespaces</a><br/>6. 快速用户切换是通过使用终端服务会话实现的。第一个用户以会话 0 登陆，第二个用户以会话 1 登陆等等。内核对象名称必须遵循为终端服务所列出的指导原则，以便应用程序可以支持多个用户</td>
</tr>
</tbody></table>
<p>函数参数可以参考：<a target="_blank" rel="noopener" href="https://fishc.com.cn/thread-70452-1-1.html">CreateFileMapping</a>–小甲鱼论坛。</p>
<p>该函数的调用路线如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel32!CreateFileMappingA --&gt; api-ms-win-core-memory-l1<span class="number">-1</span><span class="number">-1</span>!CreateFileMappingNumaW --&gt; </span><br><span class="line">KernelBase!CreateFileMappingNumaW --&gt; ntdll!NtCreateSection</span><br></pre></td></tr></table></figure>

<p>其中 <code>api-ms-win-core-memory-l1-1-1.dll</code> 只是做了中转，将来自 <code>kernel32</code> 的函数调用中转到 <code>kernelbase</code> 中。具体的中转算法可以看：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7019">深入剖析 api-ms-* 系列动态链接库</a>、<a target="_blank" rel="noopener" href="https://bitbucket.org/evolution536/crysearch-memory-scanner/raw/3c6486f841d4a7febceed3e467e000057ca776f3/PortableExecutable.cpp"> api-ms-*中转源码</a>。</p>
<h3 id="2-2-NtCreateSection"><a href="#2-2-NtCreateSection" class="headerlink" title="2.2 NtCreateSection"></a>2.2 NtCreateSection</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">NtCreateSection</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    OUT PHANDLE SectionHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ACCESS_MASK DesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN PLARGE_INTEGER MaximumSize OPTIONAL,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ULONG SectionPageProtection,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN ULONG AllocationAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">    IN HANDLE FileHandle OPTIONAL</span></span></span><br><span class="line"><span class="function"><span class="params">     )</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>SectionHandle：输出的内存区对象。</p>
</li>
<li><p>DesiredAccess：内存区对象开放的访问权限。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_QUERY       0x0001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_MAP_WRITE   0x0002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_MAP_READ    0x0004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_MAP_EXECUTE 0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_EXTEND_SIZE 0x0010</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_ALL_ACCESS (STANDARD_RIGHTS_REQUIRED|SECTION_QUERY|</span></span><br><span class="line">                            SECTION_MAP_WRITE |      </span><br><span class="line">                            SECTION_MAP_READ |       </span><br><span class="line">                            SECTION_MAP_EXECUTE |    </span><br><span class="line">                            SECTION_EXTEND_SIZE)</span><br><span class="line"><span class="comment">// SECTION_ALL_ACCESS == 0x000F001F                      </span></span><br><span class="line">                              </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STANDARD_RIGHTS_REQUIRED         (0x000F0000L)</span></span><br><span class="line"><span class="comment">// STANDARD_RIGHTS_REQUIRED是下面四个属性集合，表示匿名用户对对象标准访问权限</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE                           (0x00010000L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> READ_CONTROL                     (0x00020000L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WRITE_DAC                        (0x00040000L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WRITE_OWNER                      (0x00080000L)</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>ObjectAttributes：指向 OBJECT_ATTRIBUTES 结构的指针，该结构包含以对象命名空间格式表示的 Section 名称。该值取至CreateFileMapping的lpFileMappingAttributes参数。</p>
</li>
<li><p>MaximumSize：指定该内存区的最大大小（以字节为单位）。</p>
<ul>
<li>page file支撑的内存区：指定该部分的实际大小。</li>
<li>映射文件支撑的内存区：文件可以扩展或映射到的最大大小。</li>
</ul>
</li>
<li><p>SectionPageProtection：指定内存区中每一个页面的保护属性，使用这四个值之一：PAGE_READONLY、PAGE_READWRITE、PAGE_EXECUTE或PAGE_WRITECOPY。</p>
</li>
<li><p>AllocationAttributes：内存区的分配属性，由 CreateFileMapping-flProtect.flags 标志传入。</p>
</li>
<li><p>FileHandle：可选择指定打开的文件对象的句柄。如果该值为<strong>NULL</strong>，则该部分由分页文件支持。否则，该部分由指定的文件支持。</p>
</li>
</ul>
<p>实际上 <code>SectionPageProtection </code>和 <code>AllocationAttributes</code> 就是将 <code>CreateFileMapping</code> 的参数 <code>flProtect</code> 的两个部分拆开。</p>
<h3 id="2-3-内存区对象浅析"><a href="#2-3-内存区对象浅析" class="headerlink" title="2.3 内存区对象浅析"></a>2.3 内存区对象浅析</h3><p>内存区对象，如同其他的对象一样，也是由对象管理器来分配和释放的。<strong>对象管理器</strong>创建并初始化一个<strong>对象头</strong>（它使用对象头来管理这些对象）；而内存管理器定义内存区对象的对象体。我们主要关注对象体，就像 <code>_EPROCESS</code> 对象体一样。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x28 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SECTION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_BALANCED_NODE</span> <span class="title">SectionNode</span>;</span>                                  <span class="comment">//0x0</span></span><br><span class="line">    ULONG StartingVpn;                                                      <span class="comment">//0xc</span></span><br><span class="line">    ULONG EndingVpn;                                                        <span class="comment">//0x10</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">CONTROL_AREA</span>* <span class="title">ControlArea</span>;</span>                                  <span class="comment">//0x14</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">FILE_OBJECT</span>* <span class="title">FileObject</span>;</span>                                    <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteImageFileObject:<span class="number">1</span>;                                      <span class="comment">//0x14</span></span><br><span class="line">        ULONG RemoteDataFileObject:<span class="number">1</span>;                                       <span class="comment">//0x14</span></span><br><span class="line">    &#125; u1;                                                                   <span class="comment">//0x14</span></span><br><span class="line">    ULONGLONG SizeOfSection;                                                <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG LongFlags;                                                    <span class="comment">//0x20</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">MMSECTION_FLAGS</span> <span class="title">Flags</span>;</span>                                      <span class="comment">//0x20</span></span><br><span class="line">    &#125; u;                                                                    <span class="comment">//0x20</span></span><br><span class="line">    ULONG InitialPageProtection:<span class="number">12</span>;                                         <span class="comment">//0x24</span></span><br><span class="line">    ULONG SessionId:<span class="number">19</span>;                                                     <span class="comment">//0x24</span></span><br><span class="line">    ULONG NoValidationNeeded:<span class="number">1</span>;                                             <span class="comment">//0x24</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p><code>CreateFileMapping</code> 函数返回值为其所创建的内存区对象句柄，该句柄指向 <code>_SECTION</code> 对象。 <code>_SECTION</code> 对象中最重要的成员就是控制区 <code>ControlArea(_CONTROL_AREA)</code> 成员。控制区是一个连接其他内存管理组件的中间枢纽，控制区中的段 <code>Segment(_SEGMENT)</code> 除了和控制区互相指向之外，最重要的就是<strong>提供内存区的原型PTE数组</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !handle <span class="number">0</span> <span class="number">3</span> Section</span><br><span class="line">PROCESS <span class="number">8b</span>f02040  SessionId: <span class="number">0</span>  Cid: <span class="number">0448</span>    Peb: <span class="number">02</span>eb2000  ParentCid: <span class="number">02</span>a0</span><br><span class="line">    DirBase: <span class="number">7f</span>0eb400  ObjectTable: <span class="number">9</span>a03d700  HandleCount: <span class="number">2463.</span></span><br><span class="line">    Image: svchost.exe</span><br><span class="line"></span><br><span class="line">Handle table at <span class="number">9</span>a03d700 with <span class="number">2463</span> entries in use</span><br><span class="line">...</span><br><span class="line"><span class="number">1f</span>54: Object: f65a8780  GrantedAccess: <span class="number">000f</span>0007 Entry: a5b8dea8</span><br><span class="line">Object: f65a8780  Type: (<span class="number">853f</span>d3f0) Section</span><br><span class="line">    ObjectHeader: f65a8768 (<span class="keyword">new</span> version)</span><br><span class="line">        HandleCount: <span class="number">1</span>  PointerCount: <span class="number">14</span></span><br><span class="line">        Directory Object: <span class="number">00000000</span>  Name: \Windows\SoftwareDistribution\DataStore\DataStore.edb</span><br></pre></td></tr></table></figure>



<ol>
<li><p>查看该<strong>内存区的信息</strong>。可以看到该内存区还没有映射到当前进程，还没有 VAD 节点相关信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _SECTION <span class="number">0xf65a8780</span> /r1</span><br><span class="line">nt!_SECTION</span><br><span class="line">   +<span class="number">0x000</span> SectionNode      : _RTL_BALANCED_NODE</span><br><span class="line">      +<span class="number">0x000</span> Children         : [<span class="number">2</span>] (null) </span><br><span class="line">      +<span class="number">0x000</span> Left             : (null) </span><br><span class="line">      +<span class="number">0x004</span> Right            : (null) </span><br><span class="line">      +<span class="number">0x008</span> Red              : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x008</span> Balance          : <span class="number">0</span>y00</span><br><span class="line">      +<span class="number">0x008</span> ParentValue      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x00c</span> StartingVpn      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x010</span> EndingVpn        : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x014</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">      +<span class="number">0x000</span> FileObject       : <span class="number">0x80e38928</span> _FILE_OBJECT</span><br><span class="line">      +<span class="number">0x000</span> RemoteImageFileObject : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> RemoteDataFileObject : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x018</span> SizeOfSection    : <span class="number">0x1540000</span></span><br><span class="line">   +<span class="number">0x020</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> LongFlags        : <span class="number">0x8018080</span></span><br><span class="line">      +<span class="number">0x000</span> Flags            : _MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x024</span> InitialPageProtection : <span class="number">0</span>y000000000100 (<span class="number">0x4</span>)</span><br><span class="line">   +<span class="number">0x024</span> SessionId        : <span class="number">0</span>y0000000000000000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x024</span> NoValidationNeeded : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure>

<p>接着看一下该内存区的相关保护信息（<code>Flags(_MMSECTION_FLAGS)</code>）。</p>
<p>可以看到 <code>File == 1</code>，说明是由文件映射的内存区。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _MMSECTION_FLAGS <span class="number">0xf65a87a0</span></span><br><span class="line">nt!_MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x000</span> BeingDeleted     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingCreated     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingPurged      : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoModifiedWriting : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FailAllIo        : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Image            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Based            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> File             : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> AttemptingDelete : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PrefetchCreated  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PhysicalMemory   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> ImageControlAreaOnRemovableMedia : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Reserve          : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Commit           : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoChange         : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> WasPurged        : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> UserReference    : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> GlobalMemory     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> DeleteOnClose    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FilePointerNull  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredNode    : <span class="number">0</span>y000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x000</span> GlobalOnlyPerSession : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UserWritable     : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> SystemVaAllocated : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredFsCompressionBoundary : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UsingFileExtents : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PageSize64K      : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure>


</li>
<li><p>查看<strong>控制区相关信息</strong>。可以看到控制区第一个成员 <code>Segment</code>。<code>Segment</code> 的第一个成员又指向控制区本身，他们是互指的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt <span class="number">0x80e38928</span> _CONTROL_AREA /r1</span><br><span class="line">nt!_CONTROL_AREA</span><br><span class="line">   +<span class="number">0x000</span> Segment          : <span class="number">0x948308d0</span> _SEGMENT</span><br><span class="line">      +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">      +<span class="number">0x004</span> TotalNumberOfPtes : <span class="number">0x1600</span></span><br><span class="line">      +<span class="number">0x008</span> SegmentFlags     : _SEGMENT_FLAGS</span><br><span class="line">      +<span class="number">0x00c</span> NumberOfCommittedPages : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x010</span> SizeOfSegment    : <span class="number">0x1600000</span></span><br><span class="line">      +<span class="number">0x018</span> ExtendInfo       : (null) </span><br><span class="line">      +<span class="number">0x018</span> BasedAddress     : (null) </span><br><span class="line">      +<span class="number">0x01c</span> SegmentLock      : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x024</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x028</span> PrototypePte     : <span class="number">0xeabc46a0</span> _MMPTE</span><br><span class="line">   +<span class="number">0x004</span> ListHead         : _LIST_ENTRY [ <span class="number">0xa36e76b8</span> - <span class="number">0xae401270</span> ]</span><br><span class="line">      +<span class="number">0x000</span> Flink            : <span class="number">0xa36e76b8</span> _LIST_ENTRY [ <span class="number">0xa36e78c8</span> - <span class="number">0x80e3892c</span> ]</span><br><span class="line">      +<span class="number">0x004</span> Blink            : <span class="number">0xae401270</span> _LIST_ENTRY [ <span class="number">0x80e3892c</span> - <span class="number">0x8a23d860</span> ]</span><br><span class="line">   +<span class="number">0x004</span> AweContext       : <span class="number">0xa36e76b8</span> Void</span><br><span class="line">   +<span class="number">0x00c</span> NumberOfSectionReferences : <span class="number">2</span></span><br><span class="line">   +<span class="number">0x010</span> NumberOfPfnReferences : <span class="number">0xcc0</span></span><br><span class="line">   +<span class="number">0x014</span> NumberOfMappedViews : <span class="number">0x134</span></span><br><span class="line">   +<span class="number">0x018</span> NumberOfUserReferences : <span class="number">0x135</span></span><br><span class="line">   +<span class="number">0x01c</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> LongFlags        : <span class="number">0x8080</span></span><br><span class="line">      +<span class="number">0x000</span> Flags            : _MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x020</span> FilePointer      : _EX_FAST_REF</span><br><span class="line">      +<span class="number">0x000</span> Object           : <span class="number">0x8153ad45</span> Void</span><br><span class="line">      +<span class="number">0x000</span> RefCnt           : <span class="number">0</span>y101</span><br><span class="line">      +<span class="number">0x000</span> Value            : <span class="number">0x8153ad45</span></span><br><span class="line">   +<span class="number">0x024</span> ControlAreaLock  : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x028</span> ModifiedWriteCount : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x02c</span> WaitList         : (null) </span><br><span class="line">   +<span class="number">0x030</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> e2               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x03c</span> FileObjectLock   : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x000</span> Locked           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waiting          : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waking           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> MultipleShared   : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Shared           : <span class="number">0</span>y0000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Value            : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x000</span> Ptr              : (null) </span><br><span class="line">   +<span class="number">0x040</span> LockedPages      : <span class="number">1</span></span><br><span class="line">   +<span class="number">0x048</span> u3               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> IoAttributionContext : <span class="number">0</span>y00000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Spare            : <span class="number">0</span>y000</span><br><span class="line">      +<span class="number">0x000</span> ImageCrossPartitionCharge : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x000</span> CommittedPageCount : <span class="number">0</span>y00000000000000000000 (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>我们还是关心<strong>描述该控制区所在内存区属性</strong>的 <code>Flags(_MMSECTION_FLAGS)</code>：</p>
<ul>
<li><code>Image: 0y0</code> 说明该内存区映射文件是一个数据文件，非PE文件。</li>
<li><code>PhysicalMemory: 0y0</code> 说明该内存区还没有挂上物理页。</li>
<li><code>Reserve/Commit: 0y0</code> 一般用于基于 page file 的共享内存。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _MMSECTION_FLAGS <span class="number">0x80e38944</span></span><br><span class="line">nt!_MMSECTION_FLAGS</span><br><span class="line">   +<span class="number">0x000</span> BeingDeleted     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingCreated     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> BeingPurged      : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoModifiedWriting : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FailAllIo        : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Image            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Based            : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> File             : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> AttemptingDelete : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PrefetchCreated  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PhysicalMemory   : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> ImageControlAreaOnRemovableMedia : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Reserve          : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> Commit           : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> NoChange         : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> WasPurged        : <span class="number">0</span>y1</span><br><span class="line">   +<span class="number">0x000</span> UserReference    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> GlobalMemory     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> DeleteOnClose    : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> FilePointerNull  : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredNode    : <span class="number">0</span>y000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x000</span> GlobalOnlyPerSession : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UserWritable     : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> SystemVaAllocated : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PreferredFsCompressionBoundary : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> UsingFileExtents : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x000</span> PageSize64K      : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure>

<p>关于控制区，我们还关心在 AVD 章节学习到的，文件对象 <code>FilePointer</code> 的快速引用 <code>_EX_FAST_REF</code>。</p>
<p>可以看到 <code>RefCnt == 0y101 == 0x5</code>，引用次数为 <code>15 - 5 == 10</code> 次。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+<span class="number">0x020</span> FilePointer      : _EX_FAST_REF</span><br><span class="line">   +<span class="number">0x000</span> Object           : <span class="number">0x8153ad45</span> Void</span><br><span class="line">   +<span class="number">0x000</span> RefCnt           : <span class="number">0</span>y101</span><br><span class="line">   +<span class="number">0x000</span> Value            : <span class="number">0x8153ad45</span></span><br></pre></td></tr></table></figure>



<p>x86下，使用掩码 <code>0xFFFFFFF8</code> 查看文件对象 <code>_FILE_OBJECT</code> 信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _FILE_OBJECT (<span class="number">0x8153ad45</span> &amp; <span class="number">0xFFFFFFF8</span>)</span><br><span class="line">nt!_FILE_OBJECT</span><br><span class="line">   +<span class="number">0x000</span> Type             : <span class="number">0</span>n5</span><br><span class="line">   +<span class="number">0x002</span> Size             : <span class="number">0</span>n128</span><br><span class="line">   +<span class="number">0x004</span> DeviceObject     : <span class="number">0x8b889ca0</span> _DEVICE_OBJECT</span><br><span class="line">   +<span class="number">0x008</span> Vpb              : <span class="number">0x89ef8dc8</span> _VPB</span><br><span class="line">   +<span class="number">0x00c</span> FsContext        : <span class="number">0x9d5ee830</span> Void</span><br><span class="line">   +<span class="number">0x010</span> FsContext2       : <span class="number">0x9d5ee9f0</span> Void</span><br><span class="line">   +<span class="number">0x014</span> SectionObjectPointer : <span class="number">0x814a57fc</span> _SECTION_OBJECT_POINTERS</span><br><span class="line">   +<span class="number">0x018</span> PrivateCacheMap  : (null) </span><br><span class="line">   +<span class="number">0x01c</span> FinalStatus      : <span class="number">0</span>n0</span><br><span class="line">   +<span class="number">0x020</span> RelatedFileObject : (null) </span><br><span class="line">   +<span class="number">0x024</span> LockOperation    : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x025 DeletePending    : 0 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x026</span> ReadAccess       : <span class="number">0x1</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x027 WriteAccess      : 0x1 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x028</span> DeleteAccess     : <span class="number">0x1</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x029 SharedRead       : 0 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x02a</span> SharedWrite      : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x02b SharedDelete     : 0 &#x27;&#x27;</span><br><span class="line">   +<span class="number">0x02c</span> Flags            : <span class="number">0x144050</span></span><br><span class="line">   +<span class="number">0x030</span> FileName         : _UNICODE_STRING <span class="string">&quot;\Windows\SoftwareDistribution\DataStore\DataStore.edb&quot;</span></span><br><span class="line">   +<span class="number">0x038</span> CurrentByteOffset : _LARGE_INTEGER <span class="number">0x0</span></span><br><span class="line">   +<span class="number">0x040</span> Waiters          : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x044</span> Busy             : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x048</span> LastLock         : (null) </span><br><span class="line">   +<span class="number">0x04c</span> Lock             : _KEVENT</span><br><span class="line">   +<span class="number">0x05c</span> Event            : _KEVENT</span><br><span class="line">   +<span class="number">0x06c</span> CompletionContext : (null) </span><br><span class="line">   +<span class="number">0x070</span> IrpListLock      : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x074</span> IrpList          : _LIST_ENTRY [ <span class="number">0x8153adb4</span> - <span class="number">0x8153adb4</span> ]</span><br><span class="line">   +<span class="number">0x07c</span> FileObjectExtension : (null) </span><br></pre></td></tr></table></figure>




</li>
<li><p>查看文件对象的 <code>SectionObjectPointer(_SECTION_OBJECT_POINTERS)</code> 成员信息。</p>
<p>对于每个打开的文件（通过一个文件对象来表示），都有一个<strong>内存区对象指针数组</strong>（section object pointers）的结构 <code>_SECTION_OBJECT_POINTERS</code>。此结构对于维护各种类型的文件访问的数据一致性，以及为文件提供缓存能力是非常关键的。内存区对象指针数组结构指向<strong>一个或者两个控制区域</strong>（control area）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0xc bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SECTION_OBJECT_POINTERS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// 只有DataSectionObject、ImageSectionObject指向所在内存区的控制区</span></span><br><span class="line">    VOID* DataSectionObject;                                                <span class="comment">//0x0</span></span><br><span class="line">    VOID* SharedCacheMap;                                                   <span class="comment">//0x4</span></span><br><span class="line">    VOID* ImageSectionObject;                                               <span class="comment">//0x8</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>第一个控制区域的用途是，当该文件被当作一个<strong>数据文件来访问时</strong>，该控制区域被用于映射此文件；另一个控制区域的用途是，当该文件被当作<strong>可执行映像来运行时</strong>，它被用于映射此此文件。<strong>对于一个可执行文件来说，这两个指针是同时存在</strong>。可以看下面看雪的这篇文件，有相关介绍。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt <span class="number">0x814a57fc</span> _SECTION_OBJECT_POINTERS</span><br><span class="line">nt!_SECTION_OBJECT_POINTERS</span><br><span class="line">   +<span class="number">0x000</span> DataSectionObject : <span class="number">0x80e38928</span> Void</span><br><span class="line">   +<span class="number">0x004</span> SharedCacheMap   : <span class="number">0x81497b50</span> Void</span><br><span class="line">   +<span class="number">0x008</span> ImageSectionObject : (null) </span><br></pre></td></tr></table></figure>

<p>可以看到第一个成员 <code>DataSectionObject:0x80e38928</code> 是只想上面提到的控制区 <code>_CONTROL_AREA</code> 的。  </p>
</li>
<li><p>查看<strong>段相关信息</strong>。第一个成员 <code>ControlArea</code> 指向之前的控制区，所以段和控制区是互指的。其中：</p>
<ul>
<li><code>BasedAddress: NULL</code>，如果是PE文件，这个地方是PE文件映射到虚拟地址的 <code>ImageBase</code>。ASLR 动态加载计算的就是这个地方。可以参考《<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-268856.htm">文件映射之地址随机化原理（Win10 x64）-“缓存”</a>》。</li>
<li>其次我们比较关系描述 <code>_SEGMENT</code> 属性的<code>_SEGMENT_FLAGS</code>。&#x3D;&#x3D;&#x3D; <code>ImageSigningType: 0y000</code> 说明该映射文件是一个数据文件，非PE文件。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt <span class="number">0x948308d0</span> _SEGMENT /r1</span><br><span class="line">nt!_SEGMENT</span><br><span class="line">   +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">      +<span class="number">0x000</span> Segment          : <span class="number">0x948308d0</span> _SEGMENT</span><br><span class="line">      +<span class="number">0x004</span> ListHead         : _LIST_ENTRY [ <span class="number">0xa36e76b8</span> - <span class="number">0xae401270</span> ]</span><br><span class="line">      +<span class="number">0x004</span> AweContext       : <span class="number">0xa36e76b8</span> Void</span><br><span class="line">      +<span class="number">0x00c</span> NumberOfSectionReferences : <span class="number">2</span></span><br><span class="line">      +<span class="number">0x010</span> NumberOfPfnReferences : <span class="number">0xcc0</span></span><br><span class="line">      +<span class="number">0x014</span> NumberOfMappedViews : <span class="number">0x134</span></span><br><span class="line">      +<span class="number">0x018</span> NumberOfUserReferences : <span class="number">0x135</span></span><br><span class="line">      +<span class="number">0x01c</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x020</span> FilePointer      : _EX_FAST_REF</span><br><span class="line">      +<span class="number">0x024</span> ControlAreaLock  : <span class="number">0</span>n0</span><br><span class="line">      +<span class="number">0x028</span> ModifiedWriteCount : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x02c</span> WaitList         : (null) </span><br><span class="line">      +<span class="number">0x030</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x03c</span> FileObjectLock   : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x040</span> LockedPages      : <span class="number">1</span></span><br><span class="line">      +<span class="number">0x048</span> u3               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x004</span> TotalNumberOfPtes : <span class="number">0x1600</span></span><br><span class="line">   +<span class="number">0x008</span> SegmentFlags     : _SEGMENT_FLAGS</span><br><span class="line">      +<span class="number">0x000</span> TotalNumberOfPtes4132 : <span class="number">0</span>y0000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Spare0           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> SessionDriverProtos : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> LargePages       : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> DebugSymbolsLoaded : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> WriteCombined    : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> NoCache          : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Short0           : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x002</span> Spare            : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x002</span> DefaultProtectionMask : <span class="number">0</span>y00110 (<span class="number">0x6</span>)</span><br><span class="line">      +<span class="number">0x002</span> Binary32         : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x002</span> ContainsDebug    : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x002</span> UChar1           : <span class="number">0xc</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">      +0x003 ForceCollision   : 0y0</span><br><span class="line">      +<span class="number">0x003</span> ImageSigningType : <span class="number">0</span>y000</span><br><span class="line">      +<span class="number">0x003</span> ImageSigningLevel : <span class="number">0</span>y0000</span><br><span class="line">      +<span class="number">0x003</span> UChar2           : <span class="number">0</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">   +0x00c NumberOfCommittedPages : 0</span><br><span class="line">   +<span class="number">0x010</span> SizeOfSegment    : <span class="number">0x1600000</span></span><br><span class="line">   +<span class="number">0x018</span> ExtendInfo       : (null) </span><br><span class="line">   +<span class="number">0x018</span> BasedAddress     : (null) </span><br><span class="line">   +<span class="number">0x01c</span> SegmentLock      : _EX_PUSH_LOCK</span><br><span class="line">      +<span class="number">0x000</span> Locked           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waiting          : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Waking           : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> MultipleShared   : <span class="number">0</span>y0</span><br><span class="line">      +<span class="number">0x000</span> Shared           : <span class="number">0</span>y0000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">      +<span class="number">0x000</span> Value            : <span class="number">0</span></span><br><span class="line">      +<span class="number">0x000</span> Ptr              : (null) </span><br><span class="line">   +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> ImageCommitment  : <span class="number">0x6050000</span></span><br><span class="line">      +<span class="number">0x000</span> CreatingProcessId : <span class="number">0x6050000</span></span><br><span class="line">   +<span class="number">0x024</span> u2               : &lt;anonymous-tag&gt;</span><br><span class="line">      +<span class="number">0x000</span> ImageInformation : <span class="number">0x7346744e</span> _MI_SECTION_IMAGE_INFORMATION</span><br><span class="line">      +<span class="number">0x000</span> FirstMappedVa    : <span class="number">0x7346744e</span> Void</span><br><span class="line">   +<span class="number">0x028</span> PrototypePte     : <span class="number">0xeabc46a0</span> _MMPTE</span><br><span class="line">      +<span class="number">0x000</span> u                : &lt;anonymous-tag&gt;</span><br></pre></td></tr></table></figure>


</li>
<li><p>使用控制区专用指令 <code>!ca</code> 来解析控制区对象。可以看到在控制区后面有很多个 <code>subsection</code>。对于共享内存（与映射文件相反），通常只有一个<strong>subsection</strong>的实例，所以 <code>subsection</code>对<strong>segment</strong>已经提供的信息没有增加多少，然而它的重要性在映射文件中会变得更明显。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !ca <span class="number">0x80e38928</span> </span><br><span class="line"></span><br><span class="line">ControlArea  @ <span class="number">80e38928</span></span><br><span class="line">  Segment      <span class="number">948308</span>d0  Flink      a36e76b8  Blink        ae401270</span><br><span class="line">  Section Ref         <span class="number">2</span>  Pfn Ref         cc0  Mapped Views      <span class="number">134</span></span><br><span class="line">  User Ref          <span class="number">135</span>  WaitForDel        <span class="number">0</span>  Flush Count         <span class="number">0</span></span><br><span class="line">  File Object  <span class="number">8153</span>ad40  ModWriteCount     <span class="number">0</span>  System Views        <span class="number">0</span></span><br><span class="line">  WritableRefs        <span class="number">1</span>  PartitionId        <span class="number">0</span>  </span><br><span class="line">  Flags (<span class="number">8080</span>) File WasPurged </span><br><span class="line"></span><br><span class="line">      \Windows\SoftwareDistribution\DataStore\DataStore.edb</span><br><span class="line">Control area <span class="number">80e38928</span> file object-&gt;sectionobjectpointers linkage invalid.</span><br><span class="line"></span><br><span class="line">Segment @ <span class="number">948308</span>d0</span><br><span class="line">  ControlArea       <span class="number">80e38928</span>  ExtendInfo    <span class="number">00000000</span></span><br><span class="line">  Total Ptes            <span class="number">1600</span></span><br><span class="line">  Segment Size       <span class="number">1600000</span>  Committed            <span class="number">0</span></span><br><span class="line">  Flags (c0000) ProtectionMask </span><br><span class="line"></span><br><span class="line">Subsection <span class="number">1</span> @ <span class="number">80e38978</span></span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector        <span class="number">0</span>  Number Of Sectors  <span class="number">800</span></span><br><span class="line">  Base Pte     <span class="number">9b</span>23e000  Ptes In Subsect      <span class="number">800</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags               d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed </span><br><span class="line">  Flink        <span class="number">80e389</span>ac  Blink           <span class="number">80e389</span>ac  MappedViews         <span class="number">49</span></span><br><span class="line"></span><br><span class="line">Subsection <span class="number">2</span> @ <span class="number">85360e18</span></span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector      <span class="number">800</span>  Number Of Sectors  <span class="number">800</span></span><br><span class="line">  Base Pte     <span class="number">9b</span>37b000  Ptes In Subsect      <span class="number">800</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags               d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed </span><br><span class="line">  Flink        <span class="number">85360e4</span>c  Blink           <span class="number">85360e4</span>c  MappedViews         c8</span><br><span class="line"></span><br><span class="line">Subsection <span class="number">3</span> @ <span class="number">85387b</span>18</span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector     <span class="number">1000</span>  Number Of Sectors  <span class="number">400</span></span><br><span class="line">  Base Pte     <span class="number">9b</span>3c0000  Ptes In Subsect      <span class="number">400</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags               d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed </span><br><span class="line">  Flink        <span class="number">85387b</span>4c  Blink           <span class="number">85387b</span>4c  MappedViews         <span class="number">20</span></span><br><span class="line"></span><br><span class="line">Subsection <span class="number">4</span> @ <span class="number">8</span>a2e81b0</span><br><span class="line">  ControlArea  <span class="number">80e38928</span>  Starting Sector     <span class="number">1400</span>  Number Of Sectors  <span class="number">200</span></span><br><span class="line">  Base Pte     b5dde000  Ptes In Subsect      <span class="number">200</span>  Unused Ptes          <span class="number">0</span></span><br><span class="line">  Flags           <span class="number">1000</span>d  Sector Offset          <span class="number">0</span>  Protection           <span class="number">6</span></span><br><span class="line">  Accessed Static </span><br><span class="line">  Flink        <span class="number">8</span>a2e81e4  Blink           <span class="number">8</span>a2e81e4  MappedViews          <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>在上一篇文章 VAD 中，可以看到控制区 <code>_CONTROL_AREA</code>  只是 <code>_SUBSECTION</code> 的第一个成员。所以这里看起来有一些奇怪，为什么这里的控制区后面跟着这么多子内存区呢？所以<strong>我来论证这里实际上就是一个 <code>_SUBSECTION</code> 结构</strong>：</p>
<ul>
<li><p>首先来查看 <code>_SUBSECTION</code> 结构，我猜测 <code>_CONTROL_AREA</code> 本身就是一个 <code>_SUBSECTION</code> 的成员，并不是一个独立使用的结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _SUBSECTION</span><br><span class="line">nt!_SUBSECTION</span><br><span class="line">   +<span class="number">0x000</span> ControlArea      : Ptr32 _CONTROL_AREA</span><br><span class="line">   +<span class="number">0x004</span> SubsectionBase   : Ptr32 _MMPTE</span><br><span class="line">   +<span class="number">0x008</span> NextSubsection   : Ptr32 _SUBSECTION</span><br><span class="line">   +<span class="number">0x00c</span> GlobalPerSessionHead : _RTL_AVL_TREE</span><br><span class="line">   +<span class="number">0x00c</span> CreationWaitList : Ptr32 _MI_CONTROL_AREA_WAIT_BLOCK</span><br><span class="line">   +<span class="number">0x00c</span> SessionDriverProtos : Ptr32 _MI_PER_SESSION_PROTOS</span><br><span class="line">   +<span class="number">0x010</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x014</span> StartingSector   : Uint4B</span><br><span class="line">   +<span class="number">0x018</span> NumberOfFullSectors : Uint4B</span><br><span class="line">   +<span class="number">0x01c</span> PtesInSubsection : Uint4B</span><br><span class="line">   +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x024</span> UnusedPtes       : Pos <span class="number">0</span>, <span class="number">30</span> Bits</span><br><span class="line">   +<span class="number">0x024</span> ExtentQueryNeeded : Pos <span class="number">30</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x024</span> DirtyPages       : Pos <span class="number">31</span>, <span class="number">1</span> Bit</span><br></pre></td></tr></table></figure>


</li>
<li><p>这里的 <code>ControlArea</code> 地址为 <code>0x80e38928</code>，第一个 <code>_SUBSECTION</code> 地址为 <code>80e38978</code>：</p>
<p><strong>注意看</strong>：第一个成员控制区的地址 <code>0x80e38928</code>，以及下一个 <code>_SUBSECTION</code> 和上面 <code>!ca</code> 指令输出的情况是一模一样的。</p>
<p>所以得到验证。</p>
<p><strong>注意</strong>：这些<mark class="label success">所有子内存区指向的控制区对象都是同一个</mark>，都是 <code>0x80e38928</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _SUBSECTION <span class="number">0x80e38978</span></span><br><span class="line">nt!_SUBSECTION</span><br><span class="line">   +<span class="number">0x000</span> ControlArea      : <span class="number">0x80e38928</span> _CONTROL_AREA</span><br><span class="line">   +<span class="number">0x004</span> SubsectionBase   : <span class="number">0x9b23e000</span> _MMPTE</span><br><span class="line">   +<span class="number">0x008</span> NextSubsection   : <span class="number">0x85360e18</span> _SUBSECTION</span><br><span class="line">   +<span class="number">0x00c</span> GlobalPerSessionHead : _RTL_AVL_TREE</span><br><span class="line">   +<span class="number">0x00c</span> CreationWaitList : (null) </span><br><span class="line">   +<span class="number">0x00c</span> SessionDriverProtos : (null) </span><br><span class="line">   +<span class="number">0x010</span> u                : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x014</span> StartingSector   : <span class="number">0</span></span><br><span class="line">   +<span class="number">0x018</span> NumberOfFullSectors : <span class="number">0x800</span></span><br><span class="line">   +<span class="number">0x01c</span> PtesInSubsection : <span class="number">0x800</span></span><br><span class="line">   +<span class="number">0x020</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x024</span> UnusedPtes       : <span class="number">0</span>y000000000000000000000000000000 (<span class="number">0</span>)</span><br><span class="line">   +<span class="number">0x024</span> ExtentQueryNeeded : <span class="number">0</span>y0</span><br><span class="line">   +<span class="number">0x024</span> DirtyPages       : <span class="number">0</span>y0</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>下面列出几个对象之间的关系。</p>
<p><img data-src="https://s2.loli.net/2022/09/17/KPqWhvGFib6asro.png" alt="40.png"></p>
</li>
</ol>
<p>关于本节后续工作：</p>
<ol>
<li>参考文章<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1651211-1-1.html">《Windows 7 x64内存管理》之用户范围内存管理  Final</a>，结合 Windbg，单步解析共享内存、映射镜像文件、数据文件的差异。</li>
<li>逆向分析 <code>NtCreateSection</code> 全过程。</li>
</ol>
<h2 id="3-物理内存"><a href="#3-物理内存" class="headerlink" title="3 物理内存"></a>3 物理内存</h2><p>学习本章前，先了解两个概念：</p>
<ol>
<li>虚拟内存地址：将32位拆成两部分，高20位叫做虚拟页号（VPN），低12位为页内偏移。高20位又可以拆成[PDPTE]、PDE、PTE。</li>
<li>物理内存地址：高20位叫做物理页面编号（也叫做页面帧编号，PFN），由20位的VPN转译而来。低12位页内偏移使用的就是虚拟地址的页内偏移。<strong>页内偏移的12位并不参与地址的转译过程</strong>。</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/19/oZlgijpwkI3EQqh.png" alt="41.png"></p>
<p><strong>工作集</strong>描述了一个进程或者系统所拥有的驻留在内存中的页面。页面帧编号（PFN, page frame number）<strong>数据库则描述了物理内存中每个页面的状态</strong>。</p>
<p>查看物理内存使用情况：</p>
<ol>
<li><p>打开任务管理器-资源监视器可以看到该虚拟机我分配了 2GB 内存，下图显示 2025 MB。</p>
<p><img data-src="https://s2.loli.net/2022/09/21/nIzl2HFJRX5OKam.png" alt="47.png"></p>
</li>
<li><p>在 <code>_KUSER_SHARED_DATA</code> 中有一个成员 <code>NumberOfPhysicalPages</code> 存储着该系统总共的物理页面数量。</p>
<p><strong>注意</strong>：<code>_KUSER_SHARED_DATA</code> 的地址没有被随机化，固定地址如下。关于<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/ddi/ntddk/ns-ntddk-kuser_shared_data">KUSER_SHARED_DATA结构</a>结构成员可以查看该链接官方文档。</p>
<table>
<thead>
<tr>
<th></th>
<th>内核起始地址</th>
<th>内核结束地址</th>
<th>用户起始地址</th>
<th>用户结束地址</th>
</tr>
</thead>
<tbody><tr>
<td>32 系统</td>
<td><strong>0xFFDF0000</strong></td>
<td>0xFFDF0FFF</td>
<td><strong>0x7FFE0000</strong></td>
<td>0x7FFE0FFF</td>
</tr>
<tr>
<td>64 系统</td>
<td>0xFFFFF780&#96;00000000</td>
<td>0xFFFFF780&#96;00000FFF</td>
<td>0x7FFE0000</td>
<td>0x7FFE0FFF</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KUSER_SHARED_DATA <span class="number">0xFFDF0000</span></span><br><span class="line">ntdll!_KUSER_SHARED_DATA</span><br><span class="line">...</span><br><span class="line">+<span class="number">0x2e8</span> NumberOfPhysicalPages : <span class="number">0x7e955</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可以看到一共有 0x7e955 页，则共 $0x7E955*4KB &#x3D; 0x1FA554KB &#x3D; 2073940KB &#x3D; 2025MB$。</p>
</li>
</ol>
<h3 id="3-1-PFN-数据库"><a href="#3-1-PFN-数据库" class="headerlink" title="3.1 PFN 数据库"></a>3.1 PFN 数据库</h3><p>操作系统使用一个<strong>结构体数组</strong>来表示 PFN 数据库。</p>
<p>PFN 数据库是一个数组，页面帧编号 PFN 为该数组的索引，该数组的每一个元素为 <code>_MMPFN</code> 结构。该数组的大小为 <code>MmPfnDatabase[_KUSER_SHARED_DATA.NumberOfPhysicalPages]</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x1c bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">MMPFN</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ListEntry</span>;</span>                                       <span class="comment">//0x0</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_BALANCED_NODE</span> <span class="title">TreeNode</span>;</span>                                 <span class="comment">//0x0</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">NextSlistPfn</span>;</span>                     <span class="comment">//0x0</span></span><br><span class="line">                VOID* Next;                                                 <span class="comment">//0x0</span></span><br><span class="line">                ULONG Flink;                                                <span class="comment">//0x0</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> _<span class="title">MI_ACTIVE_PFN</span> <span class="title">Active</span>;</span>                               <span class="comment">//0x0</span></span><br><span class="line">            &#125; u1;                                                           <span class="comment">//0x0</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> _<span class="title">MMPTE</span>* <span class="title">PteAddress</span>;</span>                                  <span class="comment">//0x4</span></span><br><span class="line">                ULONG PteLong;                                              <span class="comment">//0x4</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">MMPTE</span> <span class="title">OriginalPte</span>;</span>                                      <span class="comment">//0x8</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">MIPFNBLINK</span> <span class="title">u2</span>;</span>                                                  <span class="comment">//0x10</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT ReferenceCount;                                          <span class="comment">//0x14</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">MMPFNENTRY1</span> <span class="title">e1</span>;</span>                                         <span class="comment">//0x16</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> _<span class="title">MMPFNENTRY3</span> <span class="title">e3</span>;</span>                                         <span class="comment">//0x17</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT ReferenceCount;                                          <span class="comment">//0x14</span></span><br><span class="line">        &#125; e2;                                                               <span class="comment">//0x14</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG EntireField;                                              <span class="comment">//0x14</span></span><br><span class="line">        &#125; e4;                                                               <span class="comment">//0x14</span></span><br><span class="line">    &#125; u3;                                                                   <span class="comment">//0x14</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG PteFrame:<span class="number">23</span>;                                                  <span class="comment">//0x18</span></span><br><span class="line">        ULONG ResidentPage:<span class="number">1</span>;                                               <span class="comment">//0x18</span></span><br><span class="line">        ULONG AnchorLargePageSize:<span class="number">2</span>;                                        <span class="comment">//0x18</span></span><br><span class="line">        ULONG ModifiedListBucketIndex:<span class="number">2</span>;                                    <span class="comment">//0x18</span></span><br><span class="line">        ULONG PageIdentity:<span class="number">3</span>;                                               <span class="comment">//0x18</span></span><br><span class="line">        ULONG PrototypePte:<span class="number">1</span>;                                               <span class="comment">//0x18</span></span><br><span class="line">        ULONG EntireField;                                                  <span class="comment">//0x18</span></span><br><span class="line">    &#125; u4;                                                                   <span class="comment">//0x18</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> PMMPFN MmPfnDatabase;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MI_PFN_ELEMENT(index) (&amp;MmPfnDatabase[index])</span></span><br></pre></td></tr></table></figure>

<div class="note success"><p><code>MmPfnDatabase</code> 为 PFN 数组的起始地址，PFN 为数组的索引。宏 <code>MI_PFN_ELEMENT</code> 可以根据 PFN 索引获取指定的 PFN 项。</p>
</div>

<p><code>MmPfnDatabase</code> 数组结构如下：</p>
<p><img data-src="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png" alt="51.png"></p>
<p>可以参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part1/#memusage">Inside Windows Page Frame Number (PFN) - Part 1</a></p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part2/">Inside Windows Page Frame Number (PFN) – Part 2</a></p>
<p>针对以上 <code>_MMPFN</code> 结构，不同状态下使用不同的成员：</p>
<p><img data-src="https://s2.loli.net/2022/09/20/8LAd1QcKhUpxHSY.png" alt="46.png"></p>
<p>下面初步罗列一些成员，具体成员信息及使用请看《Windows Internals 7 物理内存-PFN数据结构》。</p>
<ul>
<li><p>u1.Active：描述活动页面相关属性。</p>
</li>
<li><p>PteAddress：指向当前物理页面对应的 PTE 的虚拟地址。</p>
</li>
<li><p>OriginalPte：指向此页面 PTE 的原始内容。原始内容可能是一个原型 PTE。记录当前物理页上一次对应的 PTE，以后当改物理页面不再使用时，可以恢复为原来的 PTE。</p>
</li>
<li><p>u2.ShareCount：表明指向该物理页面的 PTE 的数量。</p>
</li>
<li><p>u3：是所有状态的 PFN 项共享的，很重要，描述物理页面的状态。</p>
</li>
<li><p>u3.e2.ReferenceCount：表示这个页面必须要保留在内存中的引用计数，包括该页面被加入工作集或者由于 I&#x2F;O 的需要而被锁定的次数。</p>
</li>
<li><p>u3.e1.PageLocation：表示当前物理页处在哪一个状态中。 <code>_MMLIST</code> 列出所有的状态和对应的枚举值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x4 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> _<span class="title">MMLISTS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ZeroedPageList = <span class="number">0</span>,</span><br><span class="line">    FreePageList = <span class="number">1</span>,</span><br><span class="line">    StandbyPageList = <span class="number">2</span>,</span><br><span class="line">    ModifiedPageList = <span class="number">3</span>,</span><br><span class="line">    ModifiedNoWritePageList = <span class="number">4</span>,</span><br><span class="line">    BadPageList = <span class="number">5</span>,</span><br><span class="line">    ActiveAndValid = <span class="number">6</span>,</span><br><span class="line">    TransitionPage = <span class="number">7</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
</li>
<li><p>u3.e1.ReadInProgress&#x2F;WriteInProgress：表示读操作和写操作正在进行。</p>
</li>
<li><p>u3.e1.Modified：表示物理页面已被修改。</p>
</li>
<li><p>u4.PteFrame：当前 PFN 编号。</p>
</li>
<li><p>u4.PrototypePte：表示该 PFN 项引用的 PTE 是一个原型 PTE。</p>
</li>
</ul>
<p>页面的状态类型存放在 <code>_MMPFN.u3.e1.PageLocation</code> 成员里，状态值由 <strong>_MMLISTS</strong> 来枚举：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x4 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> _<span class="title">MMLISTS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ZeroedPageList = <span class="number">0</span>,</span><br><span class="line">    FreePageList = <span class="number">1</span>,</span><br><span class="line">    StandbyPageList = <span class="number">2</span>,</span><br><span class="line">    ModifiedPageList = <span class="number">3</span>,</span><br><span class="line">    ModifiedNoWritePageList = <span class="number">4</span>,</span><br><span class="line">    BadPageList = <span class="number">5</span>,</span><br><span class="line">    ActiveAndValid = <span class="number">6</span>,</span><br><span class="line">    TransitionPage = <span class="number">7</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<div class="note default"><p>在这 9 种状态中，有 6 种状态是通过链表进行维护的（除活动、转移、坏的除外）。<strong>备用状态共有 8 个链表表，对应于 8 中不同优先级的页面</strong>。零化页面、空闲页面为单链表，其余链表为双链表。</p>
</div>

<p><code>u3.e1.PageLocation</code> 域保存的枚举值不仅说明当前物理页处于什么状态，还表明该页面处于哪一个链表中。</p>
<p>在 Windows XP 下全局数组 <code>MmPageLocationList</code> 列出了上述 6 种状态页面的<mark class="label danger">链表头</mark>，该数组的索引为 <code>_MMLISTS</code> 枚举值，每一个元素为 <code>_MMPFNLIST</code> 结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x14 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">MMPFNLIST</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Total;                                                            <span class="comment">//0x0</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> _<span class="title">MMLISTS</span> <span class="title">ListName</span>;</span>                                                 <span class="comment">//0x4</span></span><br><span class="line">    ULONG Flink;                                                            <span class="comment">//0x8</span></span><br><span class="line">    ULONG Blink;                                                            <span class="comment">//0xc</span></span><br><span class="line">    ULONG Lock;                                                             <span class="comment">//0x10</span></span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下全局变量仅在 XP 下使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUMBER_OF_PAGE_LISTS 8</span></span><br><span class="line">PMMPFNLIST MmPageLocationList[NUMBER_OF_PAGE_LISTS] = &#123;</span><br><span class="line">                                      &amp;MmZeroedPageListHead,</span><br><span class="line">                                      &amp;MmFreePageListHead,</span><br><span class="line">                                      &amp;MmStandbyPageListHead,</span><br><span class="line">                                      &amp;MmModifiedPageListHead,</span><br><span class="line">                                      &amp;MmModifiedNoWritePageListHead,</span><br><span class="line">                                      &amp;MmBadPageListHead,</span><br><span class="line">                                      <span class="literal">NULL</span>,</span><br><span class="line">                                      <span class="literal">NULL</span> &#125;;</span><br></pre></td></tr></table></figure>

<div class="note primary"><p>所以我们可以使用 <code>MmPfnDatabase[PFN]</code> 定位到该页面对应的 <code>_MMPFN</code> 结构，然后根据 <code>MmPageLocationList[MMPFN.u3.e1.PageLocation]</code> 找到对应状态页面的链表头。</p>
<p>注意：<strong>零化页面和空闲页面仅构成单链表</strong>，其余的是双链表。</p>
</div>

<p>以下为 XP 的图：</p>
<p><img data-src="https://s2.loli.net/2022/09/20/b1qF2h9TYySRGmD.png" alt="44.png"></p>
<h3 id="3-2-物理页面状态转移"><a href="#3-2-物理页面状态转移" class="headerlink" title="3.2 物理页面状态转移"></a>3.2 物理页面状态转移</h3><p>内存管理器根据系统内存的数量以及各个进程对于内存的需求，动态地调度这些物理页面的使用。例如，当一个进程需要内存时，内存管理器可以从零化链表或空闲链表中找到一个或多个页面来满足进程的需求；当进程退出时，内存管理器回收该进程的页面；当物理内存紧缺时，内存管理器按照特定的策略将有些进程中的页面换出到外存中，从而腾出物理内存以作他用。在内存管理器的动态调度过程中，每个页面都有可能经历各种状态变化。这一节我们来讨论物理页面的状态变化。</p>
<p><img data-src="https://s2.loli.net/2022/09/20/vaLGTWrONI9l8Ku.png" alt="43.png"></p>
<p>在以下转移描述中，不考虑已修改但不写出（不用于用户模式）、坏页面、ROM。</p>
<p>我们从页面错误处理的角度出发，来看物理页面的状态转移。在页面错误处理过程中，当进程需要一个页面时，它有可能从以下几个链表中获得物理内存页面，从而解决页面错误。所以，这几个链表中的页面都有可能进入到一个工作集中。</p>
<ol>
<li><p>如果<strong>页面错误需要一个零页面来满足</strong>（要求零的页面错误：引用一个被定义为全零的页面，或者一个从未被访问过的用户模式私有提交页面），此时内存管理器会首先试图从零页面列表中获取一个页面，如果该列表是空的，则它从空闲页面列表中获取一个，并且零化该页面（即用零填充)。如果空闲列表也是空的，则它转到备用列表，并零化此页面。</p>
<p>页面查找顺序：零化页面 --&gt; 空闲页面 --&gt; 备用链表。 </p>
<blockquote>
<p>从空闲链表到零化链表的转移是由一个称为零页面线程（zero page thread, System 进程中的第一个线程）的系统线程来完成的。系统在阶段 1 初始化完成以后，调用 <code>MmZeroPageThread</code> 函数，因此，阶段1初始化线程蜕变成零页面线程，该函数是一个无限循环。</p>
<p>当空闲列表有 8 个或者更多页面时，零页面线程就会得到事件信号，执行零化任务。该线程的优先级为0，而用户线程最低优先级为1，所以只有在 CPU 空闲的时候才会有机会切换到零化线程上。</p>
</blockquote>
</li>
<li><p>当内存管理器<strong>不要求一个零初始化的页面</strong>时，它首先到空闲列表上寻找页面。如果该列表是空的，则转到零化的列表上。如果零化的列表也是空的，则转到备用列表上。内存管理器在使用一个来自备用列表的页面帧以前，它必须首先向后回退一下， 从仍然指向该页面帧的无效PTE（或者原型PTE）中删除此引用。因为PFN数据库中的表项包含了指回到原先用户的页表（或者对于共享页面而言，指向原型PTE）的指针，所以，内存管理器可以很快地找到该PTE，并且做出正确的修改。</p>
<p>页面查找顺序：空闲页面 --&gt; 零化页面 --&gt; 备用链表。 </p>
</li>
<li><p>当一个进程必须<strong>从它的工作集中放弃一个页面</strong>（因为它引用了一个新的页面而它的工作集是满的，或者因为内存管理器修剪了它的工作集）时，如果该页面是**干净的 （未被修改过)**，则它被转到备用列表中；如果该页面驻留于工作集的时候已被修改过，则转到修改列表中。</p>
</li>
<li><p>当一个<strong>进程退出</strong>的时候，所有的私有页面都被转到空闲列表中。而且，当一个由页 面文件支撑的内存区的最后一个引用被关闭时，如果该内存区已经没有剩余的映射视图，那么这些页面也被转到空闲列表中。</p>
</li>
</ol>
<p><img data-src="https://s2.loli.net/2022/09/20/LB7bekR18TanqCF.png" alt="45.png"></p>
<p>随着工作集中的页面被加入到修改链表中，修改链表可能会变得很大，而零化链表或备用链表则越来越小，到一定时候，内存管理器会<strong>把修改链表中的页面数据写到磁盘上</strong>， 从而把页面转移到备用链表中，这一任务是由一个称为修改页面写出器（modified page writer）的组件（MiModifiedPageWriter 函数）和一个称为映射页面写出器（mapped page writer）的组件（ MiMappedPageWriter 函数）来完成的，关于这两个写出器的工作过程，请参考 4.5.4 节。</p>
<p>特别说明：申请内存时，并不会将虚拟内存挂上物理页面。当一个新分配的地址第一次被引用时，会发生一个页面错误，因为VMM在第一次实际访问这个地址前都不会为其分配物理页面。此时的错误称为<strong>demand-zero</strong>错误，因为他必须完成<strong>VA</strong>到物理页的映射，并且这个页面要初始化为0。</p>
<h3 id="3-3-物理内存限制"><a href="#3-3-物理内存限制" class="headerlink" title="3.3 物理内存限制"></a>3.3 物理内存限制</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/win32/memory/memory-limits-for-windows-releases?redirectedfrom=MSDN">Windows 和 Windows Server 版本的内存限制</a></p>
<h3 id="3-4-练习：查看PFN数据库"><a href="#3-4-练习：查看PFN数据库" class="headerlink" title="3.4 练习：查看PFN数据库"></a>3.4 练习：查看PFN数据库</h3><p>在上面的学习过程中，了解了不同状态下使用 <code>_MMPFN</code> 结构不同成员。在 XP 中，有 <code>MmPageLocationList</code> 全局变量将描述不同状态的 6 个链表进行表达。但是 Windows 10 上并没有发现这些类似的全局变量。但是《Windows Internals 7 P442》给出了相关结构的成员，如下图：</p>
<p><img data-src="https://s2.loli.net/2022/09/21/mPz7AuWVfl2YCOJ.png" alt="49.png"></p>
<p>关于结构 <code>MI_PARTITION</code>，看雪这篇文章 <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-270131.htm">分享一下win10的内存压缩</a>有部分提及。</p>
<h4 id="MmPfnDatabase"><a href="#MmPfnDatabase" class="headerlink" title="MmPfnDatabase"></a>MmPfnDatabase</h4><p>数组 <code>MmPfnDatabase</code> 结构如下：</p>
<p><img data-src="https://s2.loli.net/2022/09/21/5yRoVvmn6Ic7rOQ.png" alt="51.png"></p>
<ol>
<li><p>查看 <code>MmPfnDatabase</code> 数组地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd MmPfnDatabase</span><br><span class="line"><span class="number">821187</span>c4  <span class="number">84400000</span> <span class="number">83b</span>7f000 <span class="number">19801268</span> <span class="number">00000e07</span></span><br><span class="line"><span class="number">821187</span>d4  <span class="number">85935b</span>28 <span class="number">0007f</span>0ec <span class="number">00000000</span> <span class="number">81e0</span>f000</span><br><span class="line"><span class="number">821187e4</span>  <span class="number">82585000</span> <span class="number">825f</span>1000 <span class="number">82585000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">821187f</span>4  <span class="number">00000000</span> <span class="number">859f</span>5e40 <span class="number">23</span>c62a67 <span class="number">00000000</span></span><br></pre></td></tr></table></figure>

<p>可以看到 <code>MmPfnDatabase</code> 数组的地址为 <code>0x84400000</code>。</p>
</li>
<li><p>查看 <code>MmPfnDatabase[0]</code>，即 PFN &#x3D; 0 时，物理页面 <code>0~0xfff</code> 对应的 <code>_MMPFN</code> 结构全部为 <code>0</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dd <span class="number">0x84400000</span> </span><br><span class="line"><span class="number">84400000</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">84400010</span>  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br><span class="line"><span class="number">84400020</span>  c07fe800 <span class="number">00000080</span> <span class="number">00002000</span> <span class="number">00000001</span></span><br><span class="line"><span class="number">84400030</span>  <span class="number">00560001</span> <span class="number">0000191</span>a <span class="number">00000000</span> c07fe808</span><br></pre></td></tr></table></figure>


</li>
<li><p>查看 <code>MmPfnDatabase[8]</code> ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _MMPFN <span class="number">0x84400000</span>+<span class="number">0x1c</span>*<span class="number">8</span></span><br><span class="line">nt!_MMPFN</span><br><span class="line">   +<span class="number">0x000</span> ListEntry        : _LIST_ENTRY [ <span class="number">0x0</span> - <span class="number">0xc07fe838</span> ]</span><br><span class="line">   +<span class="number">0x000</span> TreeNode         : _RTL_BALANCED_NODE</span><br><span class="line">   +<span class="number">0x000</span> u1               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x004</span> PteAddress       : <span class="number">0xc07fe838</span> _MMPTE</span><br><span class="line">   +<span class="number">0x004</span> PteLong          : <span class="number">0xc07fe838</span></span><br><span class="line">   +<span class="number">0x008</span> OriginalPte      : _MMPTE</span><br><span class="line">   +<span class="number">0x010</span> u2               : _MIPFNBLINK</span><br><span class="line">   +<span class="number">0x014</span> u3               : &lt;anonymous-tag&gt;</span><br><span class="line">   +<span class="number">0x018</span> u4               : &lt;anonymous-tag&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="pfn-pageframe"><a href="#pfn-pageframe" class="headerlink" title="!pfn pageframe"></a>!pfn pageframe</h4><p>使用 <code>!pfn PageFrame</code> 查看对应 <code>PFN</code> 的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pfn <span class="number">8</span></span><br><span class="line">    PFN <span class="number">00000008</span> at address <span class="number">844000E0</span></span><br><span class="line">    flink       <span class="number">00000000</span>  blink / share count <span class="number">00000001</span>  pteaddress C07FE838</span><br><span class="line">    reference count <span class="number">0001</span>   Cached     color <span class="number">0</span>   Priority <span class="number">0</span></span><br><span class="line">    restore pte <span class="number">200000000080</span>  containing page <span class="number">00191</span>A  Active     M       </span><br><span class="line">    Modified   </span><br></pre></td></tr></table></figure>

<p>可以看到该指令解析的信息和 <code>dt _MMPFN 0x84400000+0x1c*8</code> 是一样的。</p>
<h4 id="vtop-CR3-VirtualAddress"><a href="#vtop-CR3-VirtualAddress" class="headerlink" title="!vtop CR3 VirtualAddress"></a>!vtop CR3 VirtualAddress</h4><p><code>!vtop</code> 指令可以将虚拟地址转换成对应的物理地址。格式为：<code>!vtop CR3 VirtualAddress</code>。使用该指令之前需要使用到 <code>!process</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">!process <span class="number">0</span> <span class="number">0</span>		<span class="comment">// 列出所有进程信息</span></span><br><span class="line">!process @$proc <span class="number">0</span>	<span class="comment">// 列出当前所附加的进程信息</span></span><br><span class="line">!process 进程名/PID <span class="number">0</span> == !process 进程名/PID	<span class="comment">//列出进程详细信息（包括所有线程）</span></span><br><span class="line">  </span><br><span class="line">.process EPROCESS	<span class="comment">//附加到目标进程</span></span><br></pre></td></tr></table></figure>

<p>步骤如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span></span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">PROCESS <span class="number">859586</span>c0  SessionId: none  Cid: <span class="number">0004</span>    Peb: <span class="number">00000000</span>  ParentCid: <span class="number">0000</span></span><br><span class="line">    DirBase: <span class="number">001</span>a8000  ObjectTable: <span class="number">86603040</span>  HandleCount: <span class="number">2434.</span></span><br><span class="line">    Image: System</span><br><span class="line">...</span><br><span class="line">PROCESS bf4d1040  SessionId: <span class="number">1</span>  Cid: <span class="number">07</span>a4    Peb: <span class="number">002</span>db000  ParentCid: <span class="number">0</span>ad8</span><br><span class="line">    DirBase: <span class="number">7f</span>0a91c0  ObjectTable: b15f2c00  HandleCount:  <span class="number">39.</span></span><br><span class="line">    Image: <span class="number">20220812</span>_VC_SEHOP.exe</span><br><span class="line"></span><br><span class="line"><span class="comment">// 附加到进程20220812_VC_SEHOP.exe</span></span><br><span class="line">kd&gt; .process bf4d1040 </span><br><span class="line">ReadVirtual: bf4d1058 <span class="keyword">not</span> properly sign extended</span><br><span class="line">Implicit process is now bf4d1040</span><br><span class="line">WARNING: .cache forcedecodeuser is <span class="keyword">not</span> enabled</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 将虚拟地址0x844000E0转换为物理地址</span></span><br><span class="line">kd&gt; !vtop <span class="number">7f</span>0a91c0 <span class="number">844000E0</span></span><br><span class="line">X86VtoP: Virt <span class="number">00000000844000e0</span>, pagedir <span class="number">000000007f</span>0a91c0</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a91d0 - <span class="number">0000000006846801</span>	<span class="comment">//注意这些都是物理地址，包括CR3都不是虚拟地址</span></span><br><span class="line">X86VtoP: PAE PDE <span class="number">0000000006846110</span> - <span class="number">800000007</span>ae008e3</span><br><span class="line">X86VtoP: PAE Large page mapped phys <span class="number">000000007</span>ae000e0</span><br><span class="line">Virtual address <span class="number">844000e0</span> translates to physical address <span class="number">7</span>ae000e0.</span><br></pre></td></tr></table></figure>

<p>可以看到物理地址为<code>7ae000e0</code>，则 <code>PFN == 7ae00</code>。</p>
<h4 id="pte-VirtualAddress-x2F-Physical-Address"><a href="#pte-VirtualAddress-x2F-Physical-Address" class="headerlink" title="!pte VirtualAddress&#x2F;Physical Address"></a>!pte VirtualAddress&#x2F;Physical Address</h4><p>该指令用来识别一个地址是虚拟地址还是物理地址，并将地址对应的 PDE、PTE 列出来。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0x844000E0</span></span><br><span class="line">                    VA <span class="number">844000e0</span></span><br><span class="line">PDE at C0602110            PTE at C0422000</span><br><span class="line">contains <span class="number">800000007</span>AE008E3  contains <span class="number">0000000000000000</span></span><br><span class="line">pfn <span class="number">7</span>ae00     --LDA--KW-V    LARGE PAGE pfn <span class="number">7</span>ae00 </span><br></pre></td></tr></table></figure>

<p>可以看到虚拟地址 <code>0x844000E0</code> 被识别出来是一个虚拟地址，其对应的 PTE 为<code>0xC0422000</code>（虚拟地址）。PFN 为<code>7ae00 </code>。</p>
<h4 id="memusage与-vm"><a href="#memusage与-vm" class="headerlink" title="!memusage与!vm"></a>!memusage与!vm</h4><p>指令 <code>!memusage</code> 可以列出所有<strong>物理内存</strong>使用的情况，该指令建议一般不要使用，不要需要加载很久遍历整个物理内存。</p>
<p>指令 <code>!vm</code> 分析<strong>虚拟内存</strong>的使用情况。</p>
<p>可以参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part1/#memusage">Inside Windows Page Frame Number (PFN) - Part 1</a></p>
<p><a target="_blank" rel="noopener" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part2/">Inside Windows Page Frame Number (PFN) – Part 2</a></p>
<h4 id="dml-proc"><a href="#dml-proc" class="headerlink" title="!dml_proc"></a>!dml_proc</h4><p><code>!dml_proc</code> 可以罗列出所有进程的 <code>EPROCESS</code>。</p>
<h3 id="3-5-练习：申请私有内存查看是否分配物理内存"><a href="#3-5-练习：申请私有内存查看是否分配物理内存" class="headerlink" title="3.5 练习：申请私有内存查看是否分配物理内存"></a>3.5 练习：申请私有内存查看是否分配物理内存</h3><p>本实验目的：先在指定内存申请一块内存，仅预留（MEM_RESERVE）不提交（MEM_COMMIT），此时查看该虚拟内存是否挂上 PTE。然后去提交内存，看 PTE 变化。</p>
<p><strong>一、申请预留内存后进行提交，然后访问内存，观察 PTE</strong></p>
<ol>
<li><p>在 <code>0x00520120</code> 申请预留内存。</p>
<p><img data-src="https://s2.loli.net/2022/09/22/6JLlha4kA9nwBuD.png" alt="52.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span></span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">PROCESS b11cd040  SessionId: <span class="number">1</span>  Cid: <span class="number">1e98</span>    Peb: <span class="number">00939000</span>  ParentCid: <span class="number">0</span>ad8</span><br><span class="line">    DirBase: <span class="number">7f</span>0a9800  ObjectTable: b15f34c0  HandleCount:  <span class="number">36.</span></span><br><span class="line">    Image: <span class="number">20220921</span>_VirtualAlloc_Test2.exe</span><br><span class="line"></span><br><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800  <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000000f</span>86a801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000000f</span>86a010 - <span class="number">0000000000000000</span></span><br><span class="line">X86VtoP: PAE zero PDE</span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0xD0000147</span>.</span><br></pre></td></tr></table></figure>

<p>可以看到此时内存还没有提交，该虚拟地址还没有挂上相应的 PTE，也没有对应的物理地址。</p>
<p><strong>注意</strong>：这里的返回地址 <code>Va</code> 是页面起始地址 <code>0x520000</code>。如下图：</p>
<p><img data-src="https://s2.loli.net/2022/09/22/VksKUSpejFOHciA.png" alt="55.png"></p>
</li>
<li><p>现在去提交内存（<code>Va = (int*)VirtualAlloc((LPVOID)0x520120, 4*0x1000, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</code>）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800  <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000000f</span>86a801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000000f</span>86a010 - <span class="number">0000000009</span>c98867</span><br><span class="line">X86VtoP: PAE PTE <span class="number">0000000009</span>c98900 - <span class="number">00002000000000</span>c0</span><br><span class="line">X86VtoP: PAE PTE <span class="keyword">not</span> present, pagefile <span class="number">0</span>:<span class="number">0000000000002000</span></span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0x10000114</span>.</span><br></pre></td></tr></table></figure>

<p>可以看到此时 PTE(<code>00002000000000c0</code>) 的 P 位还是为 <code>0</code>。此时 PAT、PCD 位都被置1。</p>
</li>
<li><p>此时去往地址里面写数据（访问地址）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800  <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000000f</span>86a801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000000f</span>86a010 - <span class="number">0000000009</span>c98867</span><br><span class="line">X86VtoP: PAE PTE <span class="number">0000000009</span>c98900 - <span class="number">000000003</span>d819967</span><br><span class="line">X86VtoP: PAE Mapped phys <span class="number">000000003</span>d819000</span><br><span class="line">Virtual address <span class="number">520000</span> translates to physical address <span class="number">3</span>d819000.</span><br></pre></td></tr></table></figure>



<p><strong>注意</strong>：这里的返回地址 <code>Va</code> 是页面起始地址 <code>0x520000</code>。<img data-src="https://s2.loli.net/2022/09/22/jqom3Dwup4Cysrb.png" alt="53.png"></p>
<p><img data-src="https://s2.loli.net/2022/09/22/ouCj1v2DJwVdl8Y.png" alt="54.png"></p>
</li>
</ol>
<p><strong>二、申请预留内存后，不提交，直接访问内存，观察 PTE</strong></p>
<ol>
<li><p>在 <code>0x00520120</code> 申请预留内存，观察 PTE。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dml_proc</span><br><span class="line">Address  PID  Image file name</span><br><span class="line"><span class="number">8</span>c2b0040 <span class="number">1040</span> <span class="number">20220921</span>_Virtu..</span><br><span class="line">  </span><br><span class="line">kd&gt; !process <span class="number">1040</span> <span class="number">0</span></span><br><span class="line">Searching <span class="keyword">for</span> Process with Cid == <span class="number">1040</span></span><br><span class="line">PROCESS <span class="number">8</span>c2b0040  SessionId: <span class="number">1</span>  Cid: <span class="number">1040</span>    Peb: <span class="number">01022000</span>  ParentCid: <span class="number">0</span>ad8</span><br><span class="line">    DirBase: <span class="number">7f</span>0a9800  ObjectTable: b15f4900  HandleCount:  <span class="number">36.</span></span><br><span class="line">    Image: <span class="number">20220921</span>_VirtualAlloc_Test2.exe</span><br><span class="line"></span><br><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800 <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000005</span>efa7801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000005</span>efa7010 - <span class="number">0000000000000000</span></span><br><span class="line">X86VtoP: PAE zero PDE</span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0xD0000147</span>.</span><br></pre></td></tr></table></figure>

<p>此时 PDE 为 0，没有挂上 PTE。</p>
</li>
<li><p>直接往地址 <code>0x520000</code> 写入数据，观察 PTE。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">7f</span>0a9800 <span class="number">520000</span></span><br><span class="line">X86VtoP: Virt <span class="number">0000000000520000</span>, pagedir <span class="number">000000007f</span>0a9800</span><br><span class="line">X86VtoP: PAE PDPE <span class="number">000000007f</span>0a9800 - <span class="number">000000005</span>efa7801</span><br><span class="line">X86VtoP: PAE PDE <span class="number">000000005</span>efa7010 - <span class="number">0000000000000000</span></span><br><span class="line">X86VtoP: PAE zero PDE</span><br><span class="line">Virtual address <span class="number">520000</span> translation fails, error <span class="number">0xD0000147</span>.</span><br></pre></td></tr></table></figure>

<p>此时 PDE 还为 0，没有挂上 PTE。</p>
<p><img data-src="https://s2.loli.net/2022/09/22/nvXEz8kPMuxiqJV.png" alt="56.png"></p>
</li>
</ol>
<h3 id="3-6-MDL-物理内存"><a href="#3-6-MDL-物理内存" class="headerlink" title="3.6 MDL 物理内存"></a>3.6 MDL 物理内存</h3><p>《Windows 内核原理与实现 P279》、《Windows 内核情景分析下 9.12 P918》。</p>
<p><img data-src="https://s2.loli.net/2022/09/24/M3651Rt2CLOwPhq.png" alt="71.png"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Catecat 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Catecat 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Catecat
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/x86-Memory2/" title="x86 内存管理（二）私有内存-共享内存-物理内存">https://directoree.github.io/post/x86-Memory2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/WinXP%E5%86%85%E6%A0%B8/" rel="tag"><i class="fa fa-tag"></i> WinXP内核</a>
              <a href="/tags/x86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> x86内存管理</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/Parallels-Windbg-Win10x64-Win10x86/" rel="prev" title="Parallels-Windbg-Win10x64-Win10x86">
                  <i class="fa fa-chevron-left"></i> Parallels-Windbg-Win10x64-Win10x86
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/x86-Memory3/" rel="next" title="x86 内存管理（三）无效/原型 PTE 与页面错误">
                  x86 内存管理（三）无效/原型 PTE 与页面错误 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Catecat</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.9m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">29:01</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/x86-Memory2/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
