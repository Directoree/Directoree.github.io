<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon1.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"directoree.github.io","root":"/","scheme":"Mist","version":"8.0.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ʕ •ᴥ•ʔ  ɔ:">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows内核基础">
<meta property="og:url" content="https://directoree.github.io/post/Windows-Kernel-Base/index.html">
<meta property="og:site_name" content="Directoree">
<meta property="og:description" content="ʕ •ᴥ•ʔ  ɔ:">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.shields.io/badge/%E6%9C%AC%E6%96%87%E5%8F%82%E8%80%83-%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-1fd0f6.svg?colorA=ff69b4">
<meta property="og:image" content="https://img.shields.io/badge/%E6%9C%AC%E6%96%87%E5%8F%82%E8%80%83-%E3%80%8A%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90Windows%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC6%E7%89%88%E3%80%8B-1fd0f6.svg?colorA=ff69b4">
<meta property="og:image" content="https://i.loli.net/2021/05/14/Amb6SjJzFyM2oT9.png">
<meta property="og:image" content="https://i.loli.net/2021/05/14/faGeXuCDJ9zrKsx.png">
<meta property="og:image" content="https://i.loli.net/2021/05/18/gm2UhziLQqPZCFy.png">
<meta property="og:image" content="https://i.loli.net/2021/05/17/sauiwhGfdyonWFP.png">
<meta property="og:image" content="https://i.loli.net/2021/05/21/XvRPjltkhAZzxor.png">
<meta property="og:image" content="https://i.loli.net/2021/05/18/CDISNmHRtX8zwpq.png">
<meta property="og:image" content="https://i.loli.net/2021/05/18/vUcp4MDyhN8ElL9.png">
<meta property="og:image" content="https://i.loli.net/2021/05/23/BwbCPfAle1T4IVM.png">
<meta property="og:image" content="https://i.loli.net/2021/05/25/j3uBplzOT5sbxR9.png">
<meta property="og:image" content="https://i.loli.net/2021/05/18/nNp3YAsozRtj8dV.png">
<meta property="article:published_time" content="2021-05-14T02:19:27.000Z">
<meta property="article:modified_time" content="2021-05-25T08:46:50.691Z">
<meta property="article:author" content="Directoree">
<meta property="article:tag" content="Windows内核">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.shields.io/badge/%E6%9C%AC%E6%96%87%E5%8F%82%E8%80%83-%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-1fd0f6.svg?colorA=ff69b4">


<link rel="canonical" href="https://directoree.github.io/post/Windows-Kernel-Base/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Windows内核基础 | Directoree</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b832a9ae9a43377003fd975ca4e525ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Directoree</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱你所爱，行你所行，听从你心，无问西东。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-更新日志">

    <a href="/changelog" rel="section"><i class="fa fa-heartbeat fa-fw"></i>更新日志</a>

  </li>
        <li class="menu-item menu-item-tips">

    <a href="/tips" rel="section"><i class="fa fa-wifi fa-fw"></i>Tips</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Windows-%E5%86%85%E6%A0%B8%E5%9F%BA%E7%A1%80"><span class="nav-text">1 Windows 内核基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Widows-%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC"><span class="nav-text">1.1 Widows 内核版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E9%87%8D%E8%A6%81%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-text">1.2 重要的概念</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Windows%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84"><span class="nav-text">2 Windows系统结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E7%94%A8%E6%88%B7%E6%A8%A1%E5%BC%8F"><span class="nav-text">2.1 用户模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-Windows%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="nav-text">2.1.1 Windows子系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-%E5%AD%90%E7%B3%BB%E7%BB%9FDLL"><span class="nav-text">2.1.2 子系统DLL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-Ntdll-dll"><span class="nav-text">2.1.3 Ntdll.dll</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%BC%8F"><span class="nav-text">2.2 内核模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E5%86%85%E6%A0%B8%E7%BB%93%E6%9E%84"><span class="nav-text">2.2.1 内核结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97Ntoskrnl-exe"><span class="nav-text">2.2.2 内核模块Ntoskrnl.exe</span></a></li></ol></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Directoree"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Directoree</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">83</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Directoree" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Directoree" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhao_yilong@aliyun.com" title="E-Mail → mailto:zhao_yilong@aliyun.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://sighttp.qq.com/msgrd?v=1&uin=1003432683" title="QQ → http:&#x2F;&#x2F;sighttp.qq.com&#x2F;msgrd?v&#x3D;1&amp;uin&#x3D;1003432683" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://treecatee.github.io/" title="https:&#x2F;&#x2F;treecatee.github.io" rel="noopener" target="_blank">Treecatee</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://directoree.github.io/post/Windows-Kernel-Base/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Directoree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Directoree">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Windows内核基础
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-14 10:19:27" itemprop="dateCreated datePublished" datetime="2021-05-14T10:19:27+08:00">2021-05-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-25 16:46:50" itemprop="dateModified" datetime="2021-05-25T16:46:50+08:00">2021-05-25</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/%E9%80%86%E5%90%91/Windows%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">Windows内核</span></a>
        </span>
    </span>

  
    <span id="/post/Windows-Kernel-Base/" class="post-meta-item leancloud_visitors" data-flag-title="Windows内核基础" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post/Windows-Kernel-Base/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post/Windows-Kernel-Base/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ʕ •ᴥ•ʔ  ɔ: </p>
<a id="more"></a>

<h2 id="1-Windows-内核基础"><a href="#1-Windows-内核基础" class="headerlink" title="1 Windows 内核基础"></a>1 Windows 内核基础</h2><p><img data-src="https://img.shields.io/badge/%E6%9C%AC%E6%96%87%E5%8F%82%E8%80%83-%E3%80%8AWindows%E5%86%85%E6%A0%B8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%8B-1fd0f6.svg?colorA=ff69b4"></p>
<p><img data-src="https://img.shields.io/badge/%E6%9C%AC%E6%96%87%E5%8F%82%E8%80%83-%E3%80%8A%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90Windows%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC6%E7%89%88%E3%80%8B-1fd0f6.svg?colorA=ff69b4"></p>
<p>系统内核层，又叫零环（Ring0，简称<code>R0</code>，与此对应的应用层叫3环，即Ring3，简称<code>R3</code>），实际上是CPU的4个运行级别中的一个。CPU设计者将CPU的运行级别从内向外分为4个，依次为R0、R1、R2、R3，运行权限从R0到R3依次降低，也就是说，R0拥有最高执行权限，R3拥有最低执行权限。CPU 设计制造商在设计之初是让<mark class="label warning">R0运行内核，R1、R2 运行设备驱动，R3运行应用程序</mark>。</p>
<p>操作系统设计者与开发商在设计操作系统（例如微软Windows 和开源社区的Linus 编写的Linux）的时候，为了让工作变得简单，并没有使用R1和R2两个级别，而是将设备驱动运行在与内核同一个级别的R0级。<mark class="label default">在AMD64 CPU诞生之后，CPU的设计者干脆也和操作系统保持一致， 只保留了R0和R3两个级别</mark>。特权级环如图7.1 所示。</p>
<p><img data-src="https://i.loli.net/2021/05/14/Amb6SjJzFyM2oT9.png" alt="1.png"></p>
<h3 id="1-1-Widows-内核版本"><a href="#1-1-Widows-内核版本" class="headerlink" title="1.1 Widows 内核版本"></a>1.1 Widows 内核版本</h3><p>Microsoft在操作系统领域中的发展最早开始于MS-DOS，并于20世纪80年代后期开始按两个分支发展：</p>
<ol>
<li>一是基于MS-DOS的Windows 开发平台，并发展成Windows 95/98/Me这一系列操作系统；</li>
<li>另一个分支则是以Windows NT为代表的操作系统系列，经历了Windows NT 3.1/3.5/3.51/4.0、Windows 2000、Windows XP/Server 2003，一直到 Windows Vista/Server 2008、Windows 7和Windows10。</li>
</ol>
<p>Windows NT由微软和IBM联合研制，分为微软的Microsoft OS/2 NT与IBM的IBM OS/2。协作后来不欢而散，IBM继续向市场提供先前的OS/2版本，微软则把自己的OS/2 NT的名称改为Windows NT，即第一代的Windows NT 3.1。</p>
<p>Windows内核（由于是从Windows NT发展而来的。也称为NT内核）从一开始就有良好的设计，其结构具备很好的可扩展性和安全性。所以，Windows 内核在20年的发展历程中一直能够很好地适应硬件的发展 ，在Windows操作系统的各个版本中并没有根本性的变化。本文介绍Windows 操作系统的基本框架，这些内容<strong>完全适用于Windows XP/Server 2003及以后的版本</strong>。</p>
<p><img data-src="https://i.loli.net/2021/05/14/faGeXuCDJ9zrKsx.png" alt="2.png"></p>
<div class="note primary"><p><mark class="label success">WRK</mark></p>
<p>WRK的全称是“Windows Research Kernel”，它是微软为高校操作系统课程提供的可修改和跟踪的操作系统教学平台。它给出了Windows这个成功的商业操作系统的<strong>内核大部分代码</strong>，可以对其进行修改、编译，并且可以用这个内核启动Windows操作系统。可让学生将操作系统基本原理和商业操作系统内核联系起来，进一步加深对操作系统整体的理解</p>
<p>NT 5.2版本是一个特殊的版本，其核心代码经过简单的改编之后 已经向教育科研领域公开。这份公开源代码的内核称为Windows Research Kernel（Windows 研究内核），简称WRK。它包括了Windows内核中最重要的组件，例如内存管理器、进程和线程管理、对象管理器、缓存管理器、配置管理器、安全引用监视器和V/O管理器等。 此内核源代码可以被编译成一个EXE可执行文件，然后安装到一个Windows Server 2003 SP1（x86系统）或Windows XP64位（AMD）系统中，替换其中的内核模块。因此，如果用户改变了源代码中的实现逻辑，则替换了内核模块之后的Windows Server 2003 SP1或 Windows XP 64位系统可以运行用户的代码逻辑。如果配置了调试环境，则还可以调试WRK内核和用户的代码。WRK是2006年7月份正式对外发布的，就当时而言，它代表了最新的Windows内核技术。</p>
</div>

<h3 id="1-2-重要的概念"><a href="#1-2-重要的概念" class="headerlink" title="1.2 重要的概念"></a>1.2 重要的概念</h3><ol>
<li><strong>Windows API函数</strong>：指Windows API中<strong>已被文档化</strong>的、可被调用的子例程（函数）， 例如 CreateProcess、CreateFile 和GetMessage。</li>
<li><strong>原生的系统服务</strong>（或者系统调用）：指操作系统中<strong>未文档化的</strong>、可在用户模式下调用的底层服务。例如，NtCreateUserProcess是一个内部系统服务，Windows 的CreateProcess函数调用该服务来创建新的进程。</li>
<li><strong>例程</strong>：即函数。</li>
<li><strong>子系统DLL</strong>：简单理解为Windows API，已文档化的API，native API。</li>
<li><strong>Native API</strong>：NT中有很多为公布的API（已文档化），习惯上大家喜欢把他们称为Native API。</li>
</ol>
<p>搞懂子系统 执行体 ntdll.dll、ntoskrnl.exe</p>
<h2 id="2-Windows系统结构"><a href="#2-Windows系统结构" class="headerlink" title="2 Windows系统结构"></a>2 Windows系统结构</h2><p>图2.2显示了Windows基本结构。Windows 采用了双模式（dual mode）结构来保护操作系统本身，以避免被应用程序的错误所波及。操作系统核心运行在<mark class="label danger">内核模式</mark>（kemel mode）下，应用程序的代码运行在<mark class="label info">用户模式</mark>（user mode）下。每当应用程序需要用到系统内核或内核的扩展模块（内核驱动程序）所提供的服务时，应用程序通过硬件指令从用户模式切换到内核模式中，当系统内核完成了所请求的服务以后，CPU控制权又回到用户模式代码。</p>
<div class="note warning"><p>用户模式与内核模式指的是CPU处理器的访问模式。</p>
<p><strong>内核模式</strong>：它允许访问所有的系统内存和所有的CPU指令。</p>
<ul>
<li><p>虽然每个Windows进程都有自己私有的内存空间，<mark class="label warning">但是内核模式的操作系统和设备驱动程序代码共享同一个虛拟地址空间</mark>。虚拟内存中的每一个页面都被标记了处理器必须在什么访问模式下才可以读和/或写该页面。系统空间中的页面只有在内核模式下才可以访问，而用户地址空间中的所有页面都可以在用户模式下访问。只读页面（比如那些包含静态数据的页面）在任何模式下都是不可写的。此外，在支持不可执行（no-execute）内存保护的处理器上，Windows将包含数据的页面标记为不可执行，从而防止数据区域被无意地或恶意地当作代码来执行。</p>
</li>
<li><p>对于在内核模式下运行的组件，32位Windows对它们所使用的私有系统内存并不提供读写保护。换句话说，一旦进入了内核模式，操作系统和设备驱动程序的代码可以完全访问系统空间的内存，也可以绕过Windows的安全机制直接访问对象。因为有大量的Windows操作系统代码运行在内核模式下。</p>
</li>
</ul>
</div>

<p><img data-src="https://i.loli.net/2021/05/18/gm2UhziLQqPZCFy.png" alt="4.png"></p>
<p><img data-src="https://i.loli.net/2021/05/17/sauiwhGfdyonWFP.png" alt="3.png"></p>
<p><img data-src="https://i.loli.net/2021/05/21/XvRPjltkhAZzxor.png" alt="8.png"></p>
<div class="note success"><p><strong>有4种用户模式进程：</strong></p>
<ol>
<li>固定的系统支持进程，如登陆进程，会话管理器进程。</li>
<li>服务进程，宿纳了windows服务，如进程管理器和假脱机服务。</li>
<li>用户应用程序，有6个类型：windows32位，windows64位，windows3.1 16位，ms-dos 16位，posix32位或者OS/2 32位。</li>
<li>环境子系统服务进程，实现了操作系统环境的部分支持。这里的环境是指操作系统展示给用户或者程序员的个性化部分。</li>
</ol>
<p>在windows下，用户程序不能直接访问原始的windows服务，要通过一个或者多个子系统动态链接库。</p>
</div>

<div class="note danger"><p><strong>Windows内核组件（组成部分）包含：</strong></p>
<ol>
<li><strong>windows执行体</strong>，包含基本的操作系统服务，如内存管理，进程和线程管理，安全性，I/O，网络，跨进程通信。</li>
<li><strong>windows内核</strong>，是由一组底层的操作系统功能构成，如线程调度，终端和异常处理分发。以及处理器同步。提供了一组例程和基础对象。执行体的其他部分利用这些例程和对象实现更高层次的功能。</li>
<li><strong>设备驱动程序</strong>，硬件设备驱动程序，也包含文件系统和网络驱动程序。其中硬件设备驱动程序将用户的I/O函数调用转化为特定的硬件设备请求。</li>
<li><strong>硬件抽象层</strong>，指一层特殊代码，它把内核，设备驱动程序和windows执行体其他部分跟与平台相关的硬件差异隔离开来。</li>
<li><strong>窗口和图形系统</strong>：实现了图形用户界面函数。</li>
</ol>
</div>

<div class="note info"><p><strong>Windows子系统是Windows系统中一个不可缺少的组成部分</strong>，<mark class="label info">它与系统内核一起构成了用户应用程序的执行环境</mark>。Windows的原始设计是一个支持多环境子系统的操作系统，除了Windows子系统作为它的原生环境子系统，它还支持POSIX和OS/2环境子系统，为UNIX类应用程序和OS/2应用程序提供一个仿真执行环境。 随着Windows操作系统的发展，<mark class="label danger">自Windows XP以后，只有Windows子系统随系统一起发行</mark>。 Windows 子系统既有内核模式部分（图形和窗口管理），也有用户模式部分。用户模式部分包括一个单独的子系统进程和一组链接到各个应用进程中的系统DLL。</p>
</div>

<p><img data-src="https://i.loli.net/2021/05/18/CDISNmHRtX8zwpq.png" alt="5.png"></p>
<h3 id="2-1-用户模式"><a href="#2-1-用户模式" class="headerlink" title="2.1 用户模式"></a>2.1 用户模式</h3><p><strong>（User mode）</strong></p>
<h4 id="2-1-1-Windows子系统"><a href="#2-1-1-Windows子系统" class="headerlink" title="2.1.1 Windows子系统"></a>2.1.1 Windows子系统</h4><div class="note default"><p>早期的Windows版本支持三个环境子系统：</p>
<ul>
<li><mark class="label primary">OS/2</mark></li>
<li><mark class="label warning">POSIX</mark></li>
<li><mark class="label info">Windows</mark></li>
</ul>
<p><strong>到了Windows XP以后，只有Windows子系统（或Win32）随Windows操作系统起发行</strong>，而且，在Windows系统中，即使是没有交互用户登录的服务器系统，Windows 子系统也是必须运行的。相反，另外两个子系统被配置成按需启动。</p>
<p> Windows子系统的两个关键功能部件：窗口管理和GDI（Graphics Device Interface，图形设备接口）。</p>
</div>

<p>Windows对应用程序的支持是通过Windows的环境子系统来做到的，<mark class="label danger">任何一个用户应用程序都运行在特定的子系统环境中</mark>。</p>
<p>我们可以这样简单地理解：</p>
<ul>
<li>Windows 子系统是Windows操作系统不可分割的一部分，它在Windows内核的基础上，为应用程序提供了一个图形用户界面（GUI）环境；</li>
<li>OS/2和POSIX则是为了兼容OS/2和UNIX应用程序而提供的模拟环境。</li>
</ul>
<div class="note primary"><p>Windows子系统中既有用户模式部分，也有内核模式部分。</p>
<ul>
<li><p><strong>内核模式部分</strong>：核心是<mark class="label warning">win32k.sys</mark>，虽然它的形式是一个驱动程序，但实际上它并不处理I/O请求，相反，它向用户代码提供了大量的系统服务。从功能上讲，它包含两部分：窗口管理（Window manager）和图形设备接口（GDI）。</p>
<ul>
<li>其中窗口管理部分负责收集和分发消息，以及控制窗口显示和管理屏幕输出；</li>
<li>图形设备接口部分包含各种形状绘制以及文本输出功能。</li>
</ul>
</li>
<li><p><strong>用户模式部分</strong>：包括Windows子系统进程<mark class="label warning">csrss.cxe</mark>以及一组动态链接库<mark class="label warning">DLL</mark>。</p>
<ul>
<li>Csrss.exe进程主要负责控制台窗口的功能，以及创建或删除进程和线程等。</li>
<li>子系统DLL则被直接链接到应用程序进程中，包括kernel32.dIl、user32.dIl、gdi32.dIl和advapi.dll等，负责实现<strong>已文档化</strong>的Windows API函数。除了有些可以直接在用户模式中完成以外，很多API函数需要调用执行体API或win32k.sys模块提供的系统服务。</li>
</ul>
</li>
</ul>
<p>应用程序通常并不直接使用操作系统提供的系统服务，而是通过调用系统DLL所提供的API函数，来间接地使用各种系统服务。Windows 子系统也使用了类似的模块结构，供应用程序直接调用的API函数位于一组子系统DLL中，这些子系统DLL再根据需要调用内核模式组件（win32k.sys）的功能。</p>
</div>

<p>子系统Windows结构如下图（图来自《Windows内核原理与实现》）：</p>
<p><img data-src="https://i.loli.net/2021/05/18/vUcp4MDyhN8ElL9.png" alt="7.png"></p>
<div class="note danger"><p>Windows子系统的组件为：</p>
<ol>
<li><p>用户模式部分：</p>
<ul>
<li><mark class="label warning">Windows子系统进程 Csrss.cxe</mark></li>
<li><mark class="label default">子系统DLL</mark></li>
</ul>
</li>
<li><p>内核模式部分：</p>
<ul>
<li><mark class="label primary">内核模块 Win32k.sys</mark></li>
<li><mark class="label info">图形设备驱动程序</mark></li>
</ul>
</li>
</ol>
</div>

<ol>
<li><mark class="label warning">Windows子系统进程 Csrss.cxe</mark>（运行在用户模式）：Windows子系统进程维护了所有属于该子系统的进程和线程的列表，并且设置进程的异常端口和调试端口，以便接收该进程中发生的异常和调试事件。类似地，当线程或进程退出或终止时，Windows子系统进程也会被通知到，从而维护子系统内部信息的一致性。

<p>它包含以下支持：</p>
<ul>
<li>控制台窗口。</li>
<li>创建和删除进程和线程。</li>
<li>支持16位虚拟DOS机（VDM，Virtual DOS Machine）进程。</li>
<li>其他一些函数，比如GetTempFile、DefinedDosDevice、ExitWindowsEx，以及少量自然语言支持函数。</li>
</ul>
</li>
<li><p>.<mark class="label default">子系统DLL</mark>：子系统DLL，例如user32.dIl、advapi32.dIl、gdi32.dll和kermel32.dlI，<strong>它们实现了已经文档化的Windows API函数</strong>，它们将已经文档化的Windows API函数，转译成Ntoskrnl.exe和Win32k.sys（<strong>两个内核模块</strong>）中恰当的且绝大多数未文档化的内核模式系统服务调用，甚至与环境子系统进程通信。</p>
</li>
<li><mark class="label primary">内核模块 Win32k.sys</mark>：虽然它的名称像是一个驱动程序，但实际上，win32k.sys并不遵从I/O管理器定义的程序模型，而仅仅是Windows内核的扩展而已。Win32k.sys包含两大功能组成部分：

<ul>
<li>窗口管理器（Window Manager）：负责控制窗口显示、管理屏幕输出、收集来自键盘、鼠标和其他设备的输人，以及将用户消息传递给应用程序。</li>
<li>GDI（Graphics Device Interface）：这是一个针对图形输出设备的函数库，包含了有关线、文本和图形绘制，以及操纵各种图形的函数。</li>
</ul>
</li>
<li><mark class="label info">图形设备驱动程序</mark>：这是一些与硬件相关的显示驱动程序、打印驱动程序，以及视频小端口驱动程序。

</li>
</ol>
<p>用户应用程序并不直接调用Windows的系统服务，而是通过一个或者多个子系统DLL来进行。这些库导出的接口都有很好的文档说明，凡是链接（LoadLibrary函数）到该子系统的程序都可以调用这些接口。例如，<strong>Windows子系统DLL （比如Kernel32.dIl、Advapi32.dlI、 User32.dlI 和Gdi32.dI1）实现了Windows API函数</strong>。SUA子系统DLL (Psxll.dIl) 实现了SUA API函数。</p>
<h4 id="2-1-2-子系统DLL"><a href="#2-1-2-子系统DLL" class="headerlink" title="2.1.2 子系统DLL"></a>2.1.2 子系统DLL</h4><p>简单理解成<strong>子系统DLL为已经文档化的Windows API函数</strong>。</p>
<div class="note info"><p>应用程序调用子系统DLL中的某个函数时，可能有下述三种情况之一 :</p>
<ol>
<li>该函数完全是在该子系统DLL中实现的，在用户模式下运行。换句话说，该函数并没有给环境子系统进程（Csrss.exe）发送消息，也没有调用Windows执行体系统服务。该函数是在用户模式下完成的，运行的结果被返回给调用者。此类函数的例子有<code>GetCurrentProcess</code>（它总是返回-1，在所有与进程相关的函数中，-1被定义为代表当前进程）和<code>GetCurrentProcessld</code>（对于一个正在运行的进程，进程ID不会改变，所以此进程ID可以从某个缓存的地方获取到，从而避免要调用至内核中）。</li>
<li>该函数要求调用Windows执行体一次或者多次。例如，Windows的<code>ReadFile</code>、<code>WriteFile</code>函数分别要调用底层内部的（且无文档的） Windows I/O系统服务<code>NtReadFile</code>和<code>NtWriteFile</code>。</li>
<li>该函数要求在环境子系统进程（Csrss.exe）中完成某些工作（环境子系统进程运行在用户模式下，负责维护那些在其控制下运行的客户应用程序的状态)。在这种情况下，该函数通过消息的形式向环境子系统发送客户机/服务器请求，从而让子系统执行某个操作。然后子系统DLL等待应答，收到应答之后再返回调用者。</li>
</ol>
<p>有些函数可以是以上列出的第2和第3项的组合，比如Windows的<code>CreateProcess</code>和<code>CreateThread</code>函数。</p>
</div>

<div class="note warning"><p>从应用程序的角度来看，它通过给子系统DLL发出的服务请求（<mark class="label danger">即API调用</mark>）是如何被满足的。首先，由于这些子系统DLL被加载（LoadLibrary）到应用程序进程中，所以，这些服务请求是直接的函数调用（同一进程地址空间中跨模块的函数调用）。当子系统DLL接收到一个函数调用以后，根据该函数功能的复杂程度，可能有以下的处理方式：</p>
<ol>
<li>直接由子系统DLL包揽所有工作。这一类函数总是在用户模式下完成，不涉及处理器模式切换。这类函数的典型例子有：<ul>
<li><code>RtInRect</code>、<code> IsRectEmpty</code>这样的简单函数，无须内核模块或Windows子系统进程的介人即可完成；</li>
<li><code>GetCurrentProcess</code>函数，简单地返回一个伪句柄值（-1）代表当前进程；</li>
<li><code>GetCurrentProcessld</code>函数，可以从一个缓存的数据结构中获得当前进程的ID，无须每次调用都进入到内核中，因为进程ID在进程的生命周期中保持不变。</li>
</ul>
</li>
<li>需要调用Windows内核一次或多次。 在这种情形下，可能存在一次或多次模式切换，子系统DLL或者通过ndll.dll调用到Windows执行体，或者通过win32k.sys注册的系统服务表（<code>KeServiceDescriptorTableShadow</code>）调用到win32k.sys 中。这类API函数的例子有：<ul>
<li><code>ReadFile</code>和<code>WriteFile</code>函数，调用底层的<code>NtReadFile</code>或<code>NtWriteFile</code>系统服务；</li>
<li><code>PostMessage</code>和<code>BitBIt</code>这样的窗口管理和GDI函数，调用win32k.sys 中的<code>NtUserPostMessage</code>或<code>NtGdiBitBIt</code>来完成其功能（它们也可能会调用Windows执行体函数，比如为了获取用以保护共享资源的锁）。</li>
</ul>
</li>
<li>需要Windows子系统进程（ Csrss.cxe）的协助来完成其功能。在这种情况下，子系统DLL向csrss.exe进程发送一个请求（以LPC消息的形式)，然后等待应答消息，直至收到应答并完成所有功能之后再返回调用者。这类API函数最典型的例子是<code>CreateProccess</code>和<code>CreateThread</code>，它们需要通知子系统进程，以维护子系统环境中进程和线程的状态。</li>
</ol>
<p>以上三种可能的执行方式仅仅代表了子系统DLL在执行一个服务请求时可能的执行路径，并非简单地将API函数分成三类。</p>
</div>

<p>其他有关Windows子系统的窗口管理器和GDI详细细节，可参考《Windows内核原理与实现》9.2章节。</p>
<h4 id="2-1-3-Ntdll-dll"><a href="#2-1-3-Ntdll-dll" class="headerlink" title="2.1.3 Ntdll.dll"></a>2.1.3 Ntdll.dll</h4><p>2.2.2中所提到的应用程序调用子系统DLL时的第2种情况，即应用程序会调用到内核一次或多次，因为Windows API无法直接调用到内核服务，这个时候就会使用到ntdll.dll，ntdll.dll充当应用程序和内核服务的桥梁，即从R3到R0的桥梁。</p>
<div class="note success"><p>Windows内核为用户模式代码提供了一组系统服务，供应用程序使用内核中的功能。 应用程序通常并不直接调用这些系统服务，而是通过一组系统DLL，最终通过ntdll.dll切换到内核模式下的执行体API函数中，以调用内核中的系统服务。Ntdll.dlI是连接用户模式代码和内核模式系统服务的桥梁。<strong>对于内核提供的每一个系统服务， 该DLL都提供个相应的存根函数，这些存根函数的名称以“Nt” 作为前缀</strong>。</p>
</div>

<div class="note danger"><p>Ntdll.dlI是一个特殊的系统支持库， 主要用于子系统DLL。它包含两种类型的函数：</p>
<ol>
<li>（执行体）系统服务分发<mark class="label danger">存根</mark>（stub），这些存根函数（例程）会调用Windows执行体的系统服务。（此部分函数供应用程序从R3转入R0使用，这部分函数以 <code>Nt</code>为前缀）。</li>
<li>系统内部支持函数， 供子系统、子系统DLL以及其他的原生映像文件使用。（此部分函数不支持模式R3到R0的切换）。</li>
</ol>
</div>

<ol>
<li><p>第一组函数为Windows执行体系统服务提供了接口，在用户模式下可以通过这些接口函数调用Windows执行体的系统服务。这样的函数超过了400个，比如<code>NtCreateFile</code>、<code>NtSetEvent</code>等。 如前所述，这些函数的大多数功能可以通过Windows API来访问得到(然而，有些函数则不然，它们仅被用于操作系统内部)。对于每一个这样的函数，Ntdll包含 了一个同名的入口点。函数内部的代码包含了与处理器体系架构相关的模式切换指令，通过该指令可转换到内核模式下，从而调用系统服务分发 器（system service dispatcher）。系统服务分发器在检验某些参数以后，再调用真正的内核模式系统服务，其中包括Ntoskrml.exe内部的实际代码。</p>
</li>
<li><p>对于NtdlI中的内部支持函数，比如：</p>
<ul>
<li>映像加载（以<code>Ldr</code>开头的函数）；</li>
<li>堆管理器；</li>
<li>Windows子系统进程通信函数（以<code>Csr</code>开头的函数）；</li>
<li>一般性的运行库例程（以<code>Rtl</code>开头的函数）；</li>
<li>对用户模式调试调试函数（以<code>DbgUi</code>开头的函数）；</li>
<li>Windows事件跟踪的支持函数（以<code>Erw</code>开头的函数）；</li>
<li>用户模式异步过程调用（APC，Asynchronous Procedure Call）分发器和异常分发器；</li>
<li>C运行库（CRT）例程的子集，仅限于字符串和标准库中的一些例程，比如memcpy、 strepy，ioa，等等。</li>
</ul>
</li>
</ol>
<p><strong>本文主要讲第一种</strong>（具体参考《Windows内核原理与实现》8.1.2）</p>
<div class="note primary"><p>在Windows的系统结构中，内核提供的服务都通过ntdll.dll模块被应用程序使用。 Windows应用程序调用一组系统 DLL中的API函数，间接地通过ntdll.dll中的存根函数来调用内核提供的系统服务。</p>
<p>Windows内核中的执行体层暴露了大量的功能供应用程序使用，那么，应用程序如何调用这些功能呢？譬如，<code>NtCreateFile</code>是Windows内核中的“创建文件”服务例程（函数），它运行在处理器的内核模式下，而应用程序的代码运行在用户模式下，所以，应用程序为了调用此“创建文件”服务，必须将处理器从用户模式切换到内核模式下。当然，模式切换工作并不需要由应用程序自已来完成，Windows 提供了一个系统模块ntdll.dll，<strong>已经实现了所有系统服务的模式切换工作</strong>。这一模式切换依赖于硬件体系结构。</p>
</div>

<p>ntdll.dll是Windows系统从ring3到ring0的入口。位于<code>Kernel32.dll</code>和<code>user32.dll</code>中的所有win32 API 最终都是调用ntdll.dll中的函数实现的。ntdll.dll中的函数使用<code>SYSENTRY</code>进入ring0，函数的实现实体在ring0中。</p>
<p>ntdll.dll中的大部分函数都是在MSDN中找不到描述的，因为这些函数介于Windows API与内核API之间，微软并<br>未公开全部的内核函数。</p>
<p>Windows中应用程序与与Windows内核打交道的过程如下图：</p>
<p><img data-src="https://i.loli.net/2021/05/23/BwbCPfAle1T4IVM.png" alt="9.png"></p>
<p>Windows应用程序调用系统DLL中的函数，这是大量已经文档化的API函数；这些系统DLL函数可能又进一步调用ntdll.dll中的系统函数，这些系统函数要么是操作系统提供的支持函数，要么是一些系统服务存根( stub)。系统服务存根函数利用模式切换指令进入到内核模式，调用内核提供的系统服务来完成应用程序的请求。举例：</p>
<div class="note success"><ol>
<li>Windows应用程序调用Windows API函数<code>CreateFile</code>来创建文件，此API函数实际上是<code>CreateFileW</code>，位于kernel32.dll模块中。</li>
<li><code>CreateFileW</code>函数又进步调用ntdll.dll中的 <code>NtCreateFile</code>函数。Ntdll.dll中的<code>NtCreateFile</code>函数是一个存根函数，它只是简单地将创建文件的请求转<mark class="label default">交给内核</mark>中的<code>NtCreateFile</code>函数。为了做到这一点，它通过ntdll.dll中的 <code>KiIntSystemCall</code>或<code>KiFastSystemCall</code>函数执行<mark class="label warning">int 2e</mark>或<mark class="label warning">sysenter</mark>指令，以便切换到内核模式下，然后由内核模式的系统服务分发函数<code>KiSystemService</code>来调用<code>NtCreateFile</code>系统服务。</li>
<li>待<code>NtCreateFile</code>系统服务执行完成以后，<code>KiSystemService</code>调用<code>KiServiceExit</code>函数，最终通过<mark class="label warning">iretd</mark>或<mark class="label warning">sysexit</mark>指令返回到用户模式ntdll.dl模块中。</li>
</ol>
</div>

<p><img data-src="https://i.loli.net/2021/05/25/j3uBplzOT5sbxR9.png" alt="10.png"></p>
<h3 id="2-2-内核模式"><a href="#2-2-内核模式" class="headerlink" title="2.2 内核模式"></a>2.2 内核模式</h3><p><strong>（Kernel mode）</strong></p>
<h4 id="2-2-1-内核结构"><a href="#2-2-1-内核结构" class="headerlink" title="2.2.1 内核结构"></a>2.2.1 内核结构</h4><div class="note default"><p>Windows内核分为三层：</p>
<ul>
<li><mark class="label primary">执行体层</mark></li>
<li><mark class="label warning">内核层</mark></li>
<li><mark class="label success">硬件抽象层</mark></li>
</ul>
<p><mark class="label danger">执行体层和内核层位于同一个二进制模块中，即内核基本模块，其名称为ntoskrnl.exe</mark></p>
</div>



<ol>
<li><mark class="label success">硬件抽象层</mark>（Hardware Abstraction Layer，简称HAL）：与硬件直接打交道的这一层称为，这一层的用意是把所有与硬件相关联的代码逻辑隔离到一个专门的模块中，从而使上面的层次尽可能做到独立于硬件平台。</li>
<li><mark class="label warning">内核层</mark>：HAL之上是内核层，有时候也称为微内核（micro-kernel），这层包含了基本的操作系统原语和功能，如线程和进程、线程调度、中断和异常的处理、同步对象和各种同步机制。</li>
<li><mark class="label primary">执行体层</mark>：在内核层之上则是执行体（executive）层，这一层的目的是提供些可供上层应用程序或内核驱动程序直接调用的功能和语义。Windows内核的执行体包含一个对象管理器，用于一致地管理执行体中的对象。

</li>
</ol>
<p>执行体层和内核层位于同一个二进制模块中，即内核基本模块，其名称为ntoskrnl.exe。内核层和执行体层的分工是：</p>
<ul>
<li>内核层实现操作系统的基本机制，而所有的策略决定则留给执行体。</li>
<li>执行体中的对象绝大多数封装了一个或者多个内核对象，并且通过某种方式（比如对象句柄）暴露给应用程序。</li>
</ul>
<p>Windows内核的详细组成结构如下图：</p>
<p><img data-src="https://i.loli.net/2021/05/18/nNp3YAsozRtj8dV.png" alt="6.png"></p>
<div class="note danger"><p><mark class="label default">Ntdll.dll</mark></p>
<p>Windows内核为用户模式代码提供了一组系统服务，供应用程序使用内核中的功能。应用程序通常并不直接调用这些系统服务，而是通过一组系统DLL，最终通过<mark class="label default">ntdll.dll</mark>切换到内核模式下的执行体API函数中，以调用内核中的系统服务。<mark class="label primary">Ntdll.dlI是连接用户模式代码和内核模式系统服务的桥梁。</mark><mark class="label warning">对于内核提供的每一个系统服务， 该DLL都提供个相应的存根函数</mark>，这些存根函数的名称以“Nt” 作为前缀，例如NCreateProcess NtOpenFile 和NtSetTimer。</p>
<p>另外，ntdll. dll还提供了许多系统级的支持函数：</p>
<ul>
<li>以 <code>Nt</code>为前缀：ntdll. dll存根函数的名称</li>
<li>以 <code>Ldr</code>为前缀：映像加载器函数</li>
<li>以 <code>Csr</code>为前缀：Windows子系统进程通信函数</li>
<li>以 <code>Dbg</code>为前缀：调试函数</li>
<li>以 <code>Etw</code>为前缀：系统事件函数</li>
<li>以 <code>Rt</code>为前缀：一般的运行支持函数</li>
<li>字符串支持函数等。</li>
</ul>
</div>

<div class="note success"><p><mark class="label info">执行体API函数</mark></p>
<p>执行体API函数接收的参数来自于各种应用程序，因此，为了确保系统的健壮性， 以及抵抗来自用户模式的恶意攻击，<mark class="label info">所有的执行体API函数必须保证参数的有效性</mark>。这意味着它们必须在恰当的时刻检查参数的值，若是指针的话，还必须保证调用者可以访问指针所指的内存。通常，执行体系统服务函数会在其开始处，对所接收的参数逐一探查它们的可访问性。</p>
</div>

<h4 id="2-2-2-内核模块Ntoskrnl-exe"><a href="#2-2-2-内核模块Ntoskrnl-exe" class="headerlink" title="2.2.2 内核模块Ntoskrnl.exe"></a>2.2.2 内核模块Ntoskrnl.exe</h4><p>执行体层和内核层位于同一个二进制模块中，即内核基本模块，其名称为ntoskrnl.exe。</p>
<p>ntoskrnl.exe 执行体  系统服务分发</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat.jpg" alt="Directoree 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Directoree 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Directoree
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://directoree.github.io/post/Windows-Kernel-Base/" title="Windows内核基础">https://directoree.github.io/post/Windows-Kernel-Base/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Windows%E5%86%85%E6%A0%B8/" rel="tag"># Windows内核</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/2020year-endsummary/" rel="prev" title="2020年终总结">
                  <i class="fa fa-chevron-left"></i> 2020年终总结
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Directoree</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">462k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">7:01</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  const url = element.dataset.target;
  const pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  const pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  const fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  
      <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.0/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"7zujCcS8pYH88CJXfdBlLyS8-gzGzoHsz","appKey":"lWGr7OPoNHo4v1YmVV5yr3E9","serverURLs":"https://7zujccs8.lc-cn-n1-shared.com","placeholder":"快来勾搭我呀🐶","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":true,"comment_count":true,"bg":"/images/comment_bg.png","recordIP":false,"enableQQ":false,"requiredFields":["nick"]}, {
      el: '#valine-comments',
      path: "/post/Windows-Kernel-Base/",
      serverURLs: "https://7zujccs8.lc-cn-n1-shared.com"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
